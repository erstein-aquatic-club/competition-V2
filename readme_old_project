# Ce readme concerne le dÃ©tail de contexte de l'ancienne app "Suivi Natation"

Application web statique (HTML/CSS/JS) pour le suivi des sÃ©ances de natation, le calcul de KPIs, les graphiques et les vues Coach (suivi nageurs + musculation). Le front repose sur un endpoint Cloudflare Worker connectÃ© Ã  D1.

## Vue dâ€™ensemble (comment Ã§a marche aujourdâ€™hui)
**Flux principal**
1. Lâ€™utilisateur saisit une sÃ©ance dans le front (page principale).
2. La sÃ©ance est sauvegardÃ©e localement (`localStorage`) puis envoyÃ©e au Worker Cloudflare.
3. Le Worker valide le token, enregistre la sÃ©ance dans D1, puis renvoie un `OK`.
4. Lâ€™onglet **Progression > Mes sÃ©ances enregistrÃ©es** reconstruit lâ€™historique depuis le cache local et/ou un GET du Worker.

**Points clÃ©s qui doivent Ãªtre alignÃ©s pour que Ã§a fonctionne**
- **Endpoint unique** configurÃ© dans `js/config.js` (ou override via `window.SWIM_SYNC_ENDPOINT`).
- **Token partagÃ©** identique entre le front et le Worker (`SWIM_SYNC_TOKEN` cÃ´tÃ© front, `SHARED_TOKEN` cÃ´tÃ© Worker).
- **SchÃ©ma D1** conforme aux tables attendues (ex: `DIM_sessions`, `DIM_exercices`).
- **Code Worker Ã  jour** (mÃªme version que `cloudflare-worker/src/index.js` du repo).

## Contexte rapide
- **Front-end**: fichiers statiques (`index.html`, `style.css`, `script.js` â†’ charge `js/main.js`).
- **Modules JS**: logique principale dans `js/main.js`, helpers dans `js/core/`, Hall of Fame dans `js/modules/hallOfFame.js`.
- **Fonctions clÃ©s**:
  - Saisie de sÃ©ances cÃ´tÃ© nageur
  - KPIs + graphiques
  - Hall of Fame
  - Outils Coach (suivi, musculation)
- **Stockage**: cache local via `localStorage` + sync via Cloudflare Worker/D1.

## Objectifs fonctionnels (cible produit)
> Les Ã©lÃ©ments marquÃ©s **(Ã  venir)** ne sont pas encore implÃ©mentÃ©s dans le projet.

### ğŸŠâ€â™‚ï¸ Nageur (utilisateur final)
**FonctionnalitÃ©s gÃ©nÃ©rales**
- Se connecter avec son nom pour accÃ©der Ã  ses donnÃ©es.
- AccÃ©der Ã  une Â« fiche nageur Â» (UI en place, contenu dÃ©taillÃ© **Ã  venir**).
- Onglet Â« Notifications Â» pour les sÃ©ances/messagerie coach **(Ã  venir)**.

**Suivi des sÃ©ances de natation en bassin**
- Saisir une sÃ©ance de natation (date, crÃ©neau, effort, ressenti).
- Consulter son historique de sÃ©ances.
- Suivre sa progression via des indicateurs de performance sur diffÃ©rentes pÃ©riodes (7 / 30 / 365 jours).
- Visualiser des graphiques sur ses ressentis (effort, performance, engagement, fatigue).
- Exporter ses donnÃ©es (CSV / JSON) et rÃ©initialiser son historique local.
- AccÃ©der au Hall of Fame pour se comparer Ã  dâ€™autres nageurs (distance, performance, engagement).

**Suivi des sÃ©ances de musculation**
- Choisir un cycle de travail (Endurance, hypertrophie, force) **(Ã  venir)**.
- Choisir une sÃ©ance de musculation **(Ã  venir)**.
- ÃŠtre guidÃ© au cours de sa sÃ©ance de musculation **(Ã  venir)** :
  - Inscription sur une sÃ©ance (suivi de la progression intra sÃ©ance : avancement = 100 %) **(Ã  venir)**.
  - Suivi des temps de rÃ©cupÃ©ration entre sÃ©ries et exercices avec timers pilotables (durÃ©es dÃ©finies dans les bases) **(Ã  venir)**.
  - Calcul automatique de la charge de travail Ã  partir dâ€™un pourcentage de la 1RM **(Ã  venir)**.
  - Recalcul automatique dâ€™une nouvelle 1RM si lâ€™athlÃ¨te augmente la charge **(Ã  venir)**.
- Garder en mÃ©moire la progression par exercice **(Ã  venir)**.
- Reprendre une sÃ©ance interrompue au mÃªme stade dâ€™avancement **(Ã  venir)**.
- Consulter son historique de sÃ©ances de musculation **(Ã  venir)**.
- Suivre sa progression via des indicateurs (7 / 30 / 365 jours) **(Ã  venir)**.
- Visualiser des graphiques sur ses ressentis (effort, performance, engagement, fatigue) **(Ã  venir)**.
- AccÃ©der au Hall of Fame musculation **(Ã  venir)**.

**Fiche nageur**
- Modifier ses informations personnelles (groupe, anniversaire, objectifs) **(Ã  venir)**.
- Visualisation des records de natation par Ã©preuves et par bassin (25 m / 50 m) **(Ã  venir)**.
- Visualisation/modification des 1RM par exercice **(Ã  venir)**.

### ğŸ§‘â€ğŸ« Coach
**FonctionnalitÃ©s gÃ©nÃ©rales**
- Se connecter en mode coach (mot de passe aujourdâ€™hui ; nom + mot de passe **Ã  venir**).
- AccÃ©der aux fiches des nageurs de son groupe **(Ã  venir)**.
- Notifications en avance pour les anniversaires **(Ã  venir)**.
- Envoyer des messages Ã  un groupe ou Ã  des athlÃ¨tes (affichÃ©s dans Â« Notifications Â») **(Ã  venir)**.

**Suivi des sÃ©ances de natation en bassin**
- CrÃ©er des sÃ©ances de natation **(Ã  venir)**.
- Assigner des sÃ©ances de natation Ã  un groupe ou un nageur **(Ã  venir)**.
- SÃ©lectionner un nageur pour consulter ses donnÃ©es.
- Suivre la progression dâ€™un nageur (KPIs + graphiques, pÃ©riodes 7/30/365 jours).
- Consulter lâ€™historique dÃ©taillÃ© des sÃ©ances du nageur.

**Suivi des sÃ©ances de musculation**
- CrÃ©er / modifier des exercices de musculation.
- CrÃ©er / modifier des exercices type Ã©chauffement (sans notion de cycle/charge) **(Ã  venir)**.
- CrÃ©er / modifier des sÃ©ances de musculation (choisir les exercices et organiser lâ€™ordre).
- Assigner des sÃ©ances de musculation Ã  un groupe ou Ã  un nageur **(Ã  venir)**.
- Suivre la progression dâ€™un nageur en musculation (KPIs + graphiques, pÃ©riodes 7/30/365 jours) **(Ã  venir)**.
- Consulter lâ€™historique dÃ©taillÃ© des sÃ©ances de musculation du nageur **(Ã  venir)**.

## Structure
```
/
â”œâ”€â”€ index.html
â”œâ”€â”€ style.css
â”œâ”€â”€ script.js              # shim module
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ main.js            # logique principale
â”‚   â”œâ”€â”€ core/              # helpers, api, charts
â”‚   â””â”€â”€ modules/           # features spÃ©cifiques (ex: hall of fame)
â”œâ”€â”€ cloudflare-worker/     # Worker Cloudflare + D1 (API)
â”‚   â”œâ”€â”€ src/index.js        # endpoints D1
â”‚   â”œâ”€â”€ schema.sql          # schÃ©ma de rÃ©fÃ©rence
â”‚   â””â”€â”€ migrations/         # migrations D1
â””â”€â”€ logo-eac.png
```

## Contrat de donnÃ©es (features Â« Ã  venir Â»)
Le mapping dÃ©taillÃ© **front â†” Worker â†” D1**, les tables nÃ©cessaires par feature et les endpoints Ã  prÃ©voir sont documentÃ©s ici :
- `docs/roadmap-data-contract.md`

## Configuration & dÃ©ploiement (Cloudflare)

### 1) Endpoint cÃ´tÃ© front
Par dÃ©faut, le front utilise lâ€™URL dÃ©finie dans `js/config.js` (sans token dans lâ€™URL) :
```
https://suivi-natation-api.francois-wagner.workers.dev/
```
Vous pouvez surcharger cette URL en injectant `window.SWIM_SYNC_ENDPOINT` avant le chargement de `script.js`.

### 2) Token partagÃ© (header Authorization)
Le Worker utilise la variable dâ€™environnement `SHARED_TOKEN`. Le front envoie ce token dans
un header `Authorization: Bearer <token>` via `window.SWIM_SYNC_TOKEN`.

**Exemple (dans `index.html` avant `script.js`)**
```html
<script>
  window.SWIM_SYNC_ENDPOINT = "https://suivi-natation-api.francois-wagner.workers.dev/";
  window.SWIM_SYNC_TOKEN = "votre-token-ici";
</script>
<script type="module" src="./script.js"></script>
```

### 3) Base D1
Le Worker sâ€™attend Ã  un schÃ©ma D1 conforme aux tables listÃ©es plus bas (notamment `DIM_sessions`, `DIM_exercices`).  
Si la base est vide ou incohÃ©rente, les insertions Ã©chouent.

### 4) DÃ©ployer ou mettre Ã  jour le Worker
Le code **source de rÃ©fÃ©rence** est `cloudflare-worker/src/index.js`.

**Mise Ã  jour manuelle (si nÃ©cessaire via le Dashboard)**
1. Ouvrir Cloudflare Dashboard â†’ **Workers & Pages** â†’ `suivi-natation-api`.
2. Cliquer sur **Edit code**.
3. Remplacer le contenu par **le code de `cloudflare-worker/src/index.js`** (depuis ce repo).
4. Sauvegarder / dÃ©ployer.

Cette manipulation est nÃ©cessaire si un dÃ©ploiement automatisÃ© nâ€™est pas en place ou si le Worker actif ne correspond pas Ã  la version du repo.

## DÃ©pannage rapide (symptÃ´mes courants)
- **â€œLoad failedâ€ / erreurs CORS en POST**
  - VÃ©rifier que le Worker renvoie bien `OK` en POST.
  - VÃ©rifier que le code du Worker dÃ©ployÃ© est Ã  jour (sinon risque dâ€™erreurs D1).
- **Erreur â€œno such table: sessionsâ€**
  - Le Worker dÃ©ployÃ© nâ€™est pas Ã  jour ou la base D1 nâ€™est pas migrÃ©e.
  - Solution : mettre Ã  jour le Worker + migrer D1 si besoin.
- **Progression > Mes sÃ©ances enregistrÃ©es vide**
  - VÃ©rifier lâ€™endpoint utilisÃ© par le front.
  - VÃ©rifier que le GET `action=get` renvoie bien `sessions`.

## SchÃ©ma D1 (Ã©tat rÃ©el) â€” Tables & champs
La section ci-dessous est basÃ©e sur la sortie SQL fournie (`sqlite_master.sql`) et reflÃ¨te **exactement** les tables et champs existants dans la base D1 Ã  ce jour.

### DIM_exercices
**IntÃ©rÃªt** : rÃ©fÃ©rentiel des exercices de musculation (nom, description, paramÃ¨tres par cycle).
Champs :
`id`, `numero_exercice`, `nom_exercice`, `description`, `illustration_gif`, `exercise_type`,
`Nb_series_endurance`, `Nb_reps_endurance`, `Pourcentage_charge_1RM_endurance`, `recup_series_endurance`,
`recup_exercices_endurance`, `Nb_series_hypertrophie`, `Nb_reps_hypertrophie`,
`Pourcentage_charge_1RM_hypertrophie`, `recup_series_hypertrophie`, `recup_exercices_hypertrophie`,
`Nb_series_force`, `Nb_reps_force`, `Pourcentage_charge_1RM_force`, `recup_series_force`,
`recup_exercices_force`.

### DIM_sessions
**IntÃ©rÃªt** : historique des sÃ©ances de natation saisies par les nageurs (charge, ressenti, commentaires).
Champs :
`id`, `athlete_id`, `athleteName`, `timestamp_reception`, `sessionDate`, `timeSlot`, `distance`, `duration`,
`rpe`, `performance`, `engagement`, `fatigue`, `training_load`, `comments`, `userAgent`, `raw_payload`,
`created_at`, `updated_at`.

### _cf_KV
**IntÃ©rÃªt** : table interne Cloudflare KV (systÃ¨me).
Champs :
`key`, `value`.

### dim_seance
**IntÃ©rÃªt** : catalogue des sÃ©ances coach (nom + description).
Champs :
`id`, `numero_seance`, `nom_seance`, `description`.

### dim_seance_deroule
**IntÃ©rÃªt** : sÃ©quenÃ§age des sÃ©ances coach (ordre des exercices).
Champs :
`id`, `numero_seance`, `ordre`, `numero_exercice`.

### group_members
**IntÃ©rÃªt** : association entre utilisateurs et groupes.
Champs :
`id`, `group_id`, `user_id`, `role_in_group`, `joined_at`.

### groups
**IntÃ©rÃªt** : groupes dâ€™entraÃ®nement.
Champs :
`id`, `name`, `description`.

### notification_targets
**IntÃ©rÃªt** : cible des notifications (utilisateur ou groupe).
Champs :
`id`, `notification_id`, `target_user_id`, `target_group_id`, `read_at`.

### notifications
**IntÃ©rÃªt** : notifications envoyÃ©es par un coach (messages, assignments).
Champs :
`id`, `title`, `body`, `type`, `created_by`, `created_at`, `expires_at`, `metadata`.

### one_rm_records
**IntÃ©rÃªt** : records de 1RM par exercice.
Champs :
`id`, `athlete_id`, `exercise_id`, `one_rm`, `source_run_id`, `recorded_at`.

### session_assignments
**IntÃ©rÃªt** : assignation de sÃ©ances (natation ou musculation) Ã  un nageur ou un groupe.
Champs :
`id`, `assignment_type`, `swim_catalog_id`, `strength_session_id`, `target_user_id`, `target_group_id`,
`assigned_by`, `scheduled_date`, `due_at`, `status`, `created_at`, `updated_at`.

### strength_session_items
**IntÃ©rÃªt** : items/exercices dâ€™une sÃ©ance de musculation (ordre, paramÃ¨tres, bloc).
Champs :
`id`, `session_id`, `ordre`, `exercise_id`, `block`, `cycle_type`, `sets`, `reps`, `pct_1rm`,
`rest_series_s`, `rest_exercise_s`, `notes`, `raw_payload`.

### strength_session_runs
**IntÃ©rÃªt** : exÃ©cutions rÃ©elles des sÃ©ances de musculation.
Champs :
`id`, `assignment_id`, `athlete_id`, `status`, `progress_pct`, `started_at`, `completed_at`, `raw_payload`.

### strength_sessions
**IntÃ©rÃªt** : sÃ©ances de musculation dÃ©finies par un coach.
Champs :
`id`, `name`, `description`, `created_by`, `created_at`, `updated_at`.

### strength_set_logs
**IntÃ©rÃªt** : logs de sÃ©ries effectuÃ©es lors dâ€™une sÃ©ance de musculation.
Champs :
`id`, `run_id`, `exercise_id`, `set_index`, `reps`, `weight`, `pct_1rm_suggested`, `rest_seconds`,
`rpe`, `notes`, `completed_at`, `raw_payload`.

### swim_records
**IntÃ©rÃªt** : records de natation par nageur.
Champs :
`id`, `athlete_id`, `event_name`, `pool_length`, `time_seconds`, `record_date`, `notes`.

### swim_session_items
**IntÃ©rÃªt** : items/exercices composant une sÃ©ance de natation.
Champs :
`id`, `catalog_id`, `ordre`, `label`, `distance`, `duration`, `intensity`, `notes`, `raw_payload`.

### swim_sessions_catalog
**IntÃ©rÃªt** : catalogue des sÃ©ances de natation.
Champs :
`id`, `name`, `description`, `created_by`, `created_at`, `updated_at`.

### user_profiles
**IntÃ©rÃªt** : profil dÃ©taillÃ© dâ€™un utilisateur (objectifs, bio, avatar).
Champs :
`user_id`, `group_label`, `objectives`, `bio`, `avatar_url`, `updated_at`.

### users
**IntÃ©rÃªt** : comptes utilisateurs (nageurs et coachs).
Champs :
`id`, `first_name`, `last_name`, `display_name`, `role`, `email`, `password_hash`, `birthdate`,
`created_at`, `updated_at`, `is_active`.

## DÃ©marrage local (optionnel)
```bash
python -m http.server 8000
```
Ouvrir ensuite http://localhost:8000
