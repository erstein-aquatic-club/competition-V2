import{c as Pe,a as Ue,u as q,d as y,r as se,j as e}from"./vendor-query-DyA9aSKS.js";import{c as Ne,u as re,d as Le,m as Te,B as d,C as R,g as z,i as M,j as K,e as V,L as l,I as f,f as fe}from"./index-DPCrbPMY.js";import{u as je,t as ge,o as be,s as h}from"./types-g3FhkFPf.js";import{a as m}from"./api-LV3LAkiz.js";import{T as qe}from"./textarea-IJIlrhoe.js";import{S as ie,a as ae,b as te,c as ne,d as u}from"./select-j8N8DPaA.js";import{S as Re}from"./switch-Dbvx89dG.js";import{B as Q}from"./badge-DwsWgr9I.js";import{T as ze,a as Me,b as ve,c as _,d as Ke,e as S}from"./table-WhaR12R9.js";import{S as Ve,a as Qe,b as De,c as Be,d as $e}from"./sheet-BFaslWy2.js";import{A as Oe,a as He,b as Ge}from"./avatar-Du86kS_x.js";import{C as Xe}from"./circle-alert-Qh7OSHbE.js";import{C as Ze}from"./clock-DOjtLAXT.js";import{C as Je}from"./circle-x-YpKkerHO.js";import{S as ye}from"./search-DFH8A_uF.js";import{U as We,a as Ye}from"./user-plus-DJ4-kRz5.js";import{P as es}from"./pen-RqvSm4-Z.js";import{S as ss}from"./save-LsffLmhK.js";import{s as rs}from"./swim-CfmlSP2N.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./index-CzA-o0RM.js";import"./index-B5JwiIL0.js";import"./chevron-down-DVgaJS6j.js";import"./chevron-up-DGoYthQn.js";import"./index-cVvIb1Vx.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],as=Ne("circle-check-big",is);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ns=Ne("shield-check",ts),ls=["athlete","coach","comite","admin"],cs=r=>!(r===!1||r===0),os=be({display_name:h().min(2,"Le nom doit contenir au moins 2 caractères"),email:h().optional().refine(r=>!r||h().email().safeParse(r).success,"L'email doit être valide"),password:h().optional().refine(r=>!r||r.length>=8&&/[A-Z]/.test(r)&&/\d/.test(r),"Le mot de passe doit contenir au moins 8 caractères, une majuscule et un chiffre")}),ds=be({display_name:h().min(2,"Le nom doit contenir au moins 2 caractères"),group_id:h().optional(),bio:h().optional(),birthdate:h().optional().refine(r=>{if(!r)return!0;const a=new Date(r);if(isNaN(a.getTime()))return!1;const g=(new Date().getTime()-a.getTime())/(1e3*60*60*24*365.25);return g>=3&&g<=100},{message:"L'âge doit être entre 3 et 100 ans"}),ffn_iuf:h().optional().refine(r=>r?/^\d+$/.test(r):!0,{message:"L'IUF FFN doit être un nombre"}),phone:h().optional()}),ms=(r,a,g)=>r.map(b=>b.id===a?{...b,role:g}:b),N=(r,a)=>rs(r,a).message;function Vs(){const{useMemo:r,useState:a}=Ue,g=typeof window>"u"?re.getState().role:re(s=>s.role),b=re(s=>s.userId),{toast:n}=Le(),c=Pe(),[E,we]=a(""),[w,Ce]=a("all"),[C,_e]=a(!1),[p,D]=a(null),[B,le]=a(50),[$,ce]=a(50),[oe,de]=a(null),[O,A]=a(!1),[I,Se]=a(""),{register:H,handleSubmit:Ee,reset:Ae,formState:{errors:v}}=je({resolver:ge(os),defaultValues:{display_name:"",email:"",password:""}}),F=g==="admin",{data:x=[],isLoading:me,error:G,refetch:Ie}=q({queryKey:["admin-users",C],queryFn:()=>m.listUsers({includeInactive:C}),enabled:F}),X=y({mutationFn:s=>m.createCoach(s),onMutate:()=>{de(null)},onSuccess:s=>{c.invalidateQueries({queryKey:["admin-users"]}),Ae(),de(s.initialPassword??null),n({title:"Coach créé"})},onError:s=>{n({title:"Erreur création coach",description:N(s,"Impossible de créer le coach.")})}}),ue=y({mutationFn:s=>m.updateUserRole(s),onSuccess:(s,i)=>{c.setQueryData(["admin-users",C],j=>j&&ms(j,i.userId,i.role)),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Rôle mis à jour"})},onError:s=>{n({title:"Erreur mise à jour rôle",description:N(s,"Impossible de mettre à jour le rôle.")})}}),he=y({mutationFn:s=>m.disableUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Compte désactivé"})},onError:s=>{n({title:"Erreur désactivation",description:N(s,"Impossible de désactiver le compte.")})}}),{data:Z=[],error:J,refetch:Fe}=q({queryKey:["pending-approvals"],queryFn:()=>m.getPendingApprovals(),enabled:F}),W=y({mutationFn:s=>m.approveUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription validée"})},onError:s=>{n({title:"Erreur validation",description:N(s,"Impossible de valider l'inscription.")})}}),Y=y({mutationFn:s=>m.rejectUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription rejetée"})},onError:s=>{n({title:"Erreur rejet",description:N(s,"Impossible de rejeter l'inscription.")})}}),t=je({resolver:ge(ds),defaultValues:{display_name:"",group_id:"",bio:"",birthdate:"",ffn_iuf:"",phone:""}}),{data:o,isLoading:us}=q({queryKey:["admin-user-profile",p],queryFn:()=>m.getProfile({userId:p}),enabled:!!p}),{data:pe=[]}=q({queryKey:["admin-groups"],queryFn:()=>m.getGroups(),enabled:F}),k=y({mutationFn:s=>m.updateProfile({userId:p,profile:{display_name:s.display_name.trim(),group_id:s.group_id?Number(s.group_id):null,group_label:s.group_id?pe.find(i=>i.id===Number(s.group_id))?.name??null:null,birthdate:s.birthdate||null,bio:s.bio||null,ffn_iuf:(s.ffn_iuf||"").trim()||null,phone:s.phone||null}}),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-user-profile",p]}),c.invalidateQueries({queryKey:["admin-users"]}),A(!1),n({title:"Fiche mise à jour"})},onError:s=>{n({title:"Erreur mise à jour",description:N(s,"Impossible de mettre à jour la fiche.")})}}),ke=s=>{D(s),A(!0)},xe=r(()=>x.find(i=>i.role==="admin")?.id??null,[x]),P=r(()=>{const s=E.trim().toLowerCase();return x.filter(i=>{if(w!=="all"&&i.role!==w)return!1;const j=i.display_name?.toLowerCase()??"",ee=i.email?.toLowerCase()??"";return!(s&&!j.includes(s)&&!ee.includes(s))})},[x,w,E]),U=r(()=>p?x.find(s=>s.id===p)??null:null,[p,x]),L=r(()=>{const s=I.trim().toLowerCase();return s?x.filter(i=>(i.display_name?.toLowerCase()??"").includes(s)||(i.email?.toLowerCase()??"").includes(s)):x},[x,I]);return se.useEffect(()=>{le(50)},[E,w,C]),se.useEffect(()=>{ce(50)},[I]),se.useEffect(()=>{!O||!o||!U||t.reset({display_name:U.display_name||"",group_id:o.group_id?String(o.group_id):"",bio:o.bio||"",birthdate:o.birthdate?String(o.birthdate).split("T")[0]:"",ffn_iuf:o.ffn_iuf?String(o.ffn_iuf):"",phone:o.phone||""})},[O,o,U]),F?G||J?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Xe,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:G instanceof Error?G.message:J instanceof Error?J.message:"Une erreur s'est produite"}),e.jsx(d,{variant:"default",onClick:()=>{Ie(),Fe()},className:"mt-4 h-12 md:h-10",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ns,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:"Accès admin"})]})]}),Z.length>0?e.jsxs(R,{className:"border-status-warning/30 bg-status-warning-bg dark:border-status-warning/30 dark:bg-status-warning-bg",children:[e.jsxs(z,{children:[e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-5 w-5 text-status-warning"}),"Inscriptions en attente",e.jsx(Q,{variant:"secondary",className:"ml-2",children:Z.length})]}),e.jsx(K,{children:"Ces utilisateurs ont créé un compte et attendent votre validation."})]}),e.jsx(V,{children:e.jsx("div",{className:"space-y-3",children:Z.map(s=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-lg border bg-background p-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email||"Pas d'email"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Inscrit le ",new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(d,{size:"sm",className:"bg-status-success hover:opacity-90 text-white h-10",onClick:()=>W.mutate(s.user_id),disabled:W.isPending||Y.isPending,children:[e.jsx(as,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(d,{size:"sm",variant:"destructive",onClick:()=>{window.confirm(`Rejeter l'inscription de "${s.display_name}" ? Le compte sera désactivé.`)&&Y.mutate(s.user_id)},disabled:W.isPending||Y.isPending,className:"h-10",children:[e.jsx(Je,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]},s.user_id))})})]}):null,e.jsxs(R,{children:[e.jsxs(z,{children:[e.jsx(M,{children:"Créer un coach"}),e.jsx(K,{children:"Laissez le mot de passe vide pour en générer un automatiquement (affiché une seule fois)."})]}),e.jsx(V,{children:e.jsxs("form",{className:"space-y-4",onSubmit:Ee(s=>{X.mutate({display_name:s.display_name.trim(),email:s.email?.trim()||void 0,password:s.password||void 0})}),children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"coach-create-name",children:"Nom affiché"}),e.jsx(f,{id:"coach-create-name",...H("display_name"),placeholder:"Ex: Coach Martin"}),v.display_name&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:v.display_name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"coach-create-email",children:"Email"}),e.jsx(f,{id:"coach-create-email",type:"email",...H("email"),placeholder:"coach@email.com"}),v.email&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:v.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"coach-create-password",children:"Mot de passe (optionnel)"}),e.jsx(f,{id:"coach-create-password",type:"text",...H("password"),placeholder:"Laisser vide pour auto"}),v.password&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:v.password.message})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(d,{variant:"default",type:"submit",disabled:X.isPending,className:"h-10",children:X.isPending?"Création...":"Créer le coach"}),oe?e.jsxs("div",{className:"rounded-md border border-primary/30 bg-primary/5 px-4 py-2 text-sm",children:[e.jsx("p",{className:"font-medium text-primary",children:"Mot de passe initial (à copier)"}),e.jsx("p",{className:"font-mono",children:oe})]}):null]})]})})]}),e.jsxs(R,{children:[e.jsxs(z,{children:[e.jsx(M,{children:"Gestion des comptes"}),e.jsx(K,{children:"Mettre à jour les rôles, filtrer et désactiver les comptes."})]}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(l,{htmlFor:"admin-search",children:"Recherche"}),e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(f,{id:"admin-search",value:E,onChange:s=>we(s.target.value),placeholder:"Nom ou email",className:"pl-9"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Rôle"}),e.jsxs(ie,{value:w,onValueChange:s=>Ce(s),children:[e.jsx(ae,{children:e.jsx(te,{placeholder:"Tous"})}),e.jsxs(ne,{children:[e.jsx(u,{value:"all",children:"Tous"}),e.jsx(u,{value:"athlete",children:"Athlète"}),e.jsx(u,{value:"coach",children:"Entraineur EAC"}),e.jsx(u,{value:"comite",children:"Comité"}),e.jsx(u,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Re,{checked:C,onCheckedChange:_e,id:"inactive-toggle"}),e.jsx(l,{htmlFor:"inactive-toggle",className:"text-sm",children:"Inclure désactivés"})]})]}),me?e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((s,i)=>e.jsx("div",{className:"flex items-center gap-4 p-3 rounded-lg border",children:e.jsx(fe,{className:"h-10 w-full"})},`skeleton-${i}`))}):P.length?e.jsxs("div",{className:"w-full overflow-x-auto",children:[e.jsxs(ze,{children:[e.jsx(Me,{children:e.jsxs(ve,{children:[e.jsx(_,{children:"Utilisateur"}),e.jsx(_,{children:"Email"}),e.jsx(_,{children:"Rôle"}),e.jsx(_,{children:"Statut"}),e.jsx(_,{className:"text-right",children:"Actions"})]})}),e.jsx(Ke,{children:P.slice(0,B).map(s=>{const i=cs(s.is_active),j=b===s.id,ee=xe!==null&&xe!==s.id;return e.jsxs(ve,{"data-selected":p===s.id,children:[e.jsx(S,{className:"font-medium",children:e.jsx(d,{variant:"ghost",size:"sm",className:"px-2",onClick:()=>D(s.id),children:s.display_name})}),e.jsx(S,{className:"text-sm text-muted-foreground",children:s.email||"-"}),e.jsx(S,{children:e.jsxs(ie,{value:s.role,onValueChange:T=>{ls.includes(T)&&s.id&&T!==s.role&&ue.mutate({userId:s.id,role:T})},disabled:!i||ue.isPending,children:[e.jsx(ae,{className:"w-[140px]",children:e.jsx(te,{})}),e.jsxs(ne,{children:[e.jsx(u,{value:"athlete",children:"Athlète"}),e.jsx(u,{value:"coach",children:"Entraineur EAC"}),e.jsx(u,{value:"comite",children:"Comité"}),e.jsx(u,{value:"admin",disabled:ee,children:"Admin"})]})]})}),e.jsx(S,{children:i?e.jsx(Q,{variant:"secondary",children:"Actif"}):e.jsx(Q,{variant:"outline",children:"Désactivé"})}),e.jsx(S,{className:"text-right",children:e.jsxs(d,{variant:"destructive",size:"sm",onClick:()=>{if(!s.id)return;if(j){n({title:"Action impossible",description:"Vous ne pouvez pas désactiver votre propre compte."});return}window.confirm(`Confirmer la désactivation du compte "${s.display_name}" ?`)&&he.mutate({userId:s.id})},disabled:!i||he.isPending||j,className:"h-10",children:[e.jsx(We,{className:"mr-2 h-4 w-4"}),"Désactiver"]})})]},s.id)})})]}),P.length>B&&e.jsxs("div",{className:"flex flex-col items-center gap-2 py-4",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:[B," sur ",P.length," utilisateurs"]}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>le(s=>s+50),children:"Voir plus"})]})]}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ye,{className:"h-4 w-4"}),"Aucun utilisateur ne correspond à votre recherche."]})]})]}),e.jsxs(R,{children:[e.jsxs(z,{children:[e.jsx(M,{children:"Fiches utilisateurs"}),e.jsx(K,{children:"Tapez sur un compte pour voir et modifier sa fiche."})]}),e.jsxs(V,{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ye,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(f,{value:I,onChange:s=>Se(s.target.value),placeholder:"Rechercher un nom...",className:"pl-9"})]}),me?e.jsx("div",{className:"space-y-2",children:Array.from({length:5}).map((s,i)=>e.jsx(fe,{className:"h-14 w-full rounded-lg"},`fiche-sk-${i}`))}):L.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun résultat."}):e.jsx("div",{className:"space-y-1.5",children:L.slice(0,$).map(s=>e.jsxs("button",{type:"button",className:"w-full flex items-center gap-3 rounded-lg border bg-card p-3 text-left hover:bg-muted/50 transition-colors",onClick:()=>{D(s.id),ke(s.id)},children:[e.jsxs(Oe,{className:"h-9 w-9 shrink-0",children:[e.jsx(He,{src:`https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(s.display_name)}`,alt:s.display_name}),e.jsx(Ge,{className:"text-xs",children:(s.display_name||"?").slice(0,2).toUpperCase()})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.email||"-"})]}),e.jsx(Q,{variant:"outline",className:"shrink-0 text-[10px] capitalize",children:s.role}),e.jsx(es,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"})]},s.id))}),L.length>$&&e.jsxs("div",{className:"flex flex-col items-center gap-2 py-4",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:[$," sur ",L.length," fiches"]}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>ce(s=>s+50),children:"Voir plus"})]})]})]}),e.jsx(Ve,{open:O,onOpenChange:A,children:e.jsxs(Qe,{side:"bottom",className:"max-h-[85vh] overflow-y-auto",children:[e.jsxs(De,{children:[e.jsxs(Be,{children:["Modifier la fiche — ",U?.display_name]}),e.jsx($e,{children:"Modifiez les informations du profil utilisateur."})]}),e.jsxs("form",{onSubmit:t.handleSubmit(s=>k.mutate(s)),className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Nom affiché"}),e.jsx(f,{...t.register("display_name")}),t.formState.errors.display_name&&e.jsx("p",{className:"text-xs text-destructive",children:t.formState.errors.display_name.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Groupe"}),e.jsxs(ie,{value:t.watch("group_id"),onValueChange:s=>t.setValue("group_id",s),children:[e.jsx(ae,{children:e.jsx(te,{placeholder:"Choisir un groupe"})}),e.jsx(ne,{children:pe.map(s=>e.jsx(u,{value:String(s.id),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Date de naissance"}),e.jsx(f,{type:"date",...t.register("birthdate")}),t.formState.errors.birthdate&&e.jsx("p",{className:"text-xs text-destructive",children:t.formState.errors.birthdate.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Téléphone"}),e.jsx(f,{type:"tel",placeholder:"06 12 34 56 78",...t.register("phone")})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"IUF FFN"}),e.jsx(f,{placeholder:"879576",inputMode:"numeric",...t.register("ffn_iuf")}),t.formState.errors.ffn_iuf&&e.jsx("p",{className:"text-xs text-destructive",children:t.formState.errors.ffn_iuf.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Bio"}),e.jsx(qe,{...t.register("bio"),rows:3})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{type:"submit",disabled:k.isPending,className:"w-full",children:[e.jsx(ss,{className:"mr-2 h-4 w-4"}),k.isPending?"Enregistrement...":"Enregistrer"]}),e.jsx(d,{type:"button",variant:"outline",onClick:()=>A(!1),disabled:k.isPending,children:"Annuler"})]})]})]})})]}):typeof window>"u"?null:e.jsx(Te,{to:"/"})}export{Vs as default,ms as updateUserRoleInList};
