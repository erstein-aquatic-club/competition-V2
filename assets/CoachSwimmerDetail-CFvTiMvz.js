import{r as o,u as E,j as e,c as pe,d as W}from"./vendor-query-BiSH4r2z.js";import{c as bt,b as Ve,u as Ge,B as P,d as he,L as z,I as _e,s as He,X as yt,a5 as Nt,T as ke,a9 as vt}from"./index-DJhjrNgz.js";import{a as x}from"./api-CsrPZC4L.js";import{T as _t,a as Ct,b as fe,c as je}from"./tabs-YRm4Ju6k.js";import{B as I}from"./badge-n2XNX5DT.js";import{C as wt}from"./chart-column-DT2KCrU1.js";import{C as Je}from"./chevron-down-P1t9_73a.js";import{T as Fe}from"./textarea-CWlz6SOG.js";import{S as Y,a as Z,b as ee,c as te,d as V}from"./select-ggBsrlB6.js";import{T as kt,a as Se}from"./toggle-group-DDneOSkf.js";import{S as Xe,a as Ye,b as Ze,c as et}from"./sheet-BDiKQ7fv.js";import{A as re,a as ie,b as le,c as ce,d as oe,e as de,f as me,g as ue}from"./alert-dialog-DjCqs5UX.js";import{T as Ce,s as tt,a as st,c as at,d as St,S as nt,e as Ae,f as xe,b as Tt,F as Dt,p as We,M as rt,A as Et}from"./objectiveHelpers-0U212e6O.js";import{P as se}from"./plus-Cbq_8-zY.js";import{T as Pe}from"./trash-2-BpcmbyFx.js";import{w as it,a as lt,S as Re,G as ct}from"./weekTypeColor-BaUAMiad.js";import{t as De}from"./date-NdbyDBh_.js";import{C as qt}from"./copy-DIo85Lwc.js";import{C as Ft}from"./index-DTYFhdUe.js";import{P as At}from"./pencil-o4Qm-qZy.js";import{C as Pt,a as Mt,b as Ot}from"./collapsible-3n7uCGLe.js";import{C as Lt}from"./chevron-up-B1JL2N9U.js";import{C as ot}from"./clock-B9F_6Kgj.js";import{C as Kt}from"./chevron-right-qXOkHVZh.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./swim-jj-6_99T.js";import"./index-y3Oq2I-l.js";import"./index-DvTrs0do.js";import"./index-DhdRuVry.js";import"./format-B9mPVj_w.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M17 14h-6",key:"bkmgh3"}],["path",{d:"M13 18H7",key:"bb0bb7"}],["path",{d:"M7 14h.01",key:"1qa3f1"}],["path",{d:"M17 18h.01",key:"1bdyru"}]],dt=bt("calendar-range",$t);function Te(...t){return t.filter(Boolean).join(" ")}const Wt=[{key:"effort",label:"Diff.",mode:"hard"},{key:"feeling",label:"Fat.",mode:"hard"},{key:"performance",label:"Perf",mode:"good"},{key:"engagement",label:"Eng.",mode:"good"}];function Rt(t,s){const a=Number(s);if(!Number.isFinite(a)||a<1||a>5)return"bg-muted text-muted-foreground";const i=t==="hard"?6-a:a;return i>=4?"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400":i>=3?"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400":"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"}function zt({athleteId:t,athleteName:s}){const[,a]=Ve(),{setSelectedAthlete:i}=Ge(),[c,l]=o.useState(20),[n,m]=o.useState(null),[p,h]=o.useState(null),{data:y=[],isLoading:b}=E({queryKey:["sessions",t],queryFn:()=>x.getSessions(s,t)}),g=y.slice(0,c),N=y.length>c;if(b)return e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(f=>e.jsxs("div",{className:"rounded-2xl border bg-card p-3 animate-pulse motion-reduce:animate-none",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted mb-2"}),e.jsx("div",{className:"h-3 w-full rounded bg-muted"})]},f))});if(y.length===0)return e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun ressenti enregistre."});const C=()=>{i({id:t,name:s}),a("/progress")};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(P,{variant:"outline",size:"sm",className:"w-full text-xs gap-1.5",onClick:C,children:[e.jsx(wt,{className:"h-3.5 w-3.5"}),"Voir la progression"]}),g.map(f=>{const k=n===f.id;return e.jsxs("button",{type:"button",onClick:()=>{h(null),m(k?null:f.id)},className:"w-full rounded-2xl border bg-card p-3 text-left hover:border-primary/20 transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:new Date(f.date).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}),e.jsx("span",{className:"text-xs text-muted-foreground ml-1.5",children:f.slot})]}),e.jsx("div",{className:"flex items-center gap-1",children:Wt.map(v=>{const q=f[v.key],j=`${f.id}-${v.key}`,u=p===j;return e.jsxs("span",{className:"relative group",onClick:_=>{_.stopPropagation(),h(u?null:j)},children:[e.jsx("span",{className:Te("inline-flex items-center justify-center h-6 w-6 rounded-lg text-[10px] font-bold cursor-pointer",Rt(v.mode,q)),children:q??"â€”"}),e.jsx("span",{className:Te("absolute -top-7 left-1/2 -translate-x-1/2 rounded-md bg-foreground text-background px-1.5 py-0.5 text-[9px] font-semibold whitespace-nowrap pointer-events-none transition-opacity","opacity-0 group-hover:opacity-100",u&&"opacity-100"),children:v.label})]},v.key)})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:f.distance>0?`${f.distance}m`:"â€”"}),f.comments&&e.jsx(Je,{className:Te("h-3.5 w-3.5 text-muted-foreground transition-transform",k&&"rotate-180")})]}),k&&f.comments&&e.jsx("div",{className:"mt-2 pt-2 border-t border-border",children:e.jsx("p",{className:"text-xs text-foreground whitespace-pre-wrap",children:f.comments})})]},f.id)}),N&&e.jsxs("button",{type:"button",onClick:f=>{f.stopPropagation(),l(k=>k+20)},className:"w-full rounded-2xl border border-dashed border-border py-2 text-xs font-medium text-muted-foreground hover:bg-muted transition",children:["Charger plus (",y.length-c," restants)"]})]})}async function It(t){const{data:s,error:a}=await He.rpc("get_auth_uid_for_user",{p_user_id:t});return a?(console.error("[objectives-tab] Failed to resolve auth UUID:",a.message),null):s}const Bt=({open:t,onOpenChange:s,objective:a,athleteName:i,athleteAuthId:c,competitions:l})=>{const{toast:n}=he(),m=pe(),p=!!a,[h,y]=o.useState("chrono"),[b,g]=o.useState(""),[N,C]=o.useState("25"),[f,k]=o.useState(""),[v,q]=o.useState(""),[j,u]=o.useState(""),[_,w]=o.useState(!1);o.useEffect(()=>{if(t)if(a){const d=!!a.event_code,L=!!a.text;y(d&&L?"both":L?"texte":"chrono"),g(a.event_code??""),C(String(a.pool_length??25)),k(a.target_time_seconds!=null?xe(a.target_time_seconds):""),q(a.text??""),u(a.competition_id??"")}else y("chrono"),g(""),C("25"),k(""),q(""),u("")},[t,a]);const A=W({mutationFn:d=>x.createObjective(d),onSuccess:()=>{n({title:"Objectif crÃ©Ã©"}),m.invalidateQueries({queryKey:["objectives",c]}),s(!1)},onError:d=>{n({title:"Erreur",description:d.message,variant:"destructive"})}}),F=W({mutationFn:d=>x.updateObjective(a.id,d),onSuccess:()=>{n({title:"Objectif mis Ã  jour"}),m.invalidateQueries({queryKey:["objectives",c]}),s(!1)},onError:d=>{n({title:"Erreur",description:d.message,variant:"destructive"})}}),K=W({mutationFn:()=>x.deleteObjective(a.id),onSuccess:()=>{n({title:"Objectif supprimÃ©"}),m.invalidateQueries({queryKey:["objectives",c]}),s(!1)},onError:d=>{n({title:"Erreur",description:d.message,variant:"destructive"})}}),M=h==="chrono"||h==="both",O=h==="texte"||h==="both",J=()=>{if(M&&!b){n({title:"Ã‰preuve requise",description:"Veuillez sÃ©lectionner une Ã©preuve.",variant:"destructive"});return}if(M&&f&&We(f)===null){n({title:"Format invalide",description:"Le temps doit Ãªtre au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(O&&!v.trim()){n({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const d={athlete_id:c,competition_id:j&&j!=="none"?j:null,event_code:M?b:null,pool_length:M?Number(N):null,target_time_seconds:M&&f?We(f):null,text:O?v.trim():null};p?F.mutate(d):A.mutate(d)},$=A.isPending||F.isPending||K.isPending,T=o.useMemo(()=>{const d=new Date;return d.setHours(0,0,0,0),l.filter(L=>new Date(L.date+"T00:00:00").getTime()>=d.getTime())},[l]);return e.jsxs(e.Fragment,{children:[e.jsx(Xe,{open:t,onOpenChange:s,children:e.jsxs(Ye,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(Ze,{children:e.jsx(et,{children:p?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Type d'objectif"}),e.jsxs(kt,{type:"single",variant:"outline",value:h,onValueChange:d=>{d&&y(d)},className:"justify-start",children:[e.jsx(Se,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(Se,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(Se,{value:"both",className:"text-xs",children:"Les deux"})]})]}),M&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Ã‰preuve *"}),e.jsxs(Y,{value:b,onValueChange:g,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Choisir une Ã©preuve"})}),e.jsx(te,{children:Dt.map(d=>e.jsx(V,{value:d,children:Ae(d)},d))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Bassin"}),e.jsxs(Y,{value:N,onValueChange:C,children:[e.jsx(Z,{children:e.jsx(ee,{})}),e.jsxs(te,{children:[e.jsx(V,{value:"25",children:"25m"}),e.jsx(V,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Temps cible (min:sec:centiÃ¨mes)"}),e.jsx(_e,{placeholder:"Ex : 1:05:30",value:f,onChange:d=>k(d.target.value)})]})]}),O&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Objectif texte *"}),e.jsx(Fe,{placeholder:"Ex : AmÃ©liorer la coulÃ©e de dos",value:v,onChange:d=>q(d.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Lier Ã  une compÃ©tition"}),e.jsxs(Y,{value:j,onValueChange:u,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Aucune"})}),e.jsxs(te,{children:[e.jsx(V,{value:"none",children:"Aucune"}),T.map(d=>e.jsxs(V,{value:d.id,children:[d.name," (",d.date,")"]},d.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(P,{className:"w-full",onClick:J,disabled:$,children:$?"Enregistrement...":p?"Enregistrer":"CrÃ©er"}),p&&e.jsx(P,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>w(!0),disabled:$,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(re,{open:_,onOpenChange:w,children:e.jsxs(ie,{children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Supprimer l'objectif"}),e.jsx(oe,{children:"Cette action est irrÃ©versible. L'objectif sera supprimÃ© dÃ©finitivement."})]}),e.jsxs(de,{children:[e.jsx(me,{children:"Annuler"}),e.jsx(ue,{onClick:()=>{K.mutate(),w(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function Qt(t){const s=t.split("-");return s.length===3?`${s[2]}/${s[1]}/${s[0]}`:t}const Ut=({objective:t,performances:s,onEdit:a})=>{const i=t.event_code?tt(t.event_code):null,c=i?nt[i]??"":"",l=t.event_code?st(s,t.event_code,t.pool_length):null;let n=null,m=null;l&&t.target_time_seconds!=null&&t.event_code&&(n=l.time-t.target_time_seconds,m=at(l.time,t.target_time_seconds,t.event_code));const p=!!t.competition_name,h=t.competition_date?St(t.competition_date):null;return e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card p-3 text-sm space-y-1.5 transition-colors hover:bg-muted/50 ${c?`border-l-4 ${c}`:""}`,onClick:()=>a(t),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(Ce,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-center gap-1.5 flex-wrap",children:[t.event_code&&e.jsx("span",{className:"font-medium",children:Ae(t.event_code)}),t.event_code&&t.pool_length&&e.jsxs("span",{className:"text-muted-foreground",children:["(",t.pool_length,"m)"]}),t.target_time_seconds!=null&&e.jsx("span",{className:"font-mono text-xs text-primary",children:xe(t.target_time_seconds)})]}),e.jsx(Pe,{className:"h-3.5 w-3.5 text-muted-foreground/40 shrink-0"})]}),t.text&&e.jsx("p",{className:"text-muted-foreground text-xs pl-5 line-clamp-2",children:t.text}),t.event_code&&l&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:xe(l.time)})]}),l.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",Qt(l.date),")"]}),n!=null&&e.jsx("span",{className:n<=0?"text-emerald-600 font-medium":"text-amber-600",children:n<=0?"Objectif atteint !":`+${n.toFixed(2)}s`})]}),t.event_code&&!l&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"}),m!=null&&e.jsx("div",{className:"pl-5 pr-1",children:e.jsx("div",{className:"h-1.5 w-full rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${Tt(m)}`,style:{width:`${Math.min(m,100)}%`}})})}),p&&e.jsx("div",{className:"pl-5",children:e.jsxs(I,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:[t.competition_name,h!=null&&h>0&&e.jsxs("span",{className:"ml-1 font-bold",children:["J-",h]})]})})]})},Vt=({athleteId:t,athleteName:s})=>{const[a,i]=o.useState(!1),[c,l]=o.useState(null),{data:n,isLoading:m}=E({queryKey:["auth-uid",t],queryFn:()=>It(t),enabled:!!t}),{data:p=[]}=E({queryKey:["competitions"],queryFn:()=>x.getCompetitions()}),{data:h=[],isLoading:y}=E({queryKey:["objectives",n],queryFn:()=>x.getObjectives(n),enabled:!!n}),{data:b}=E({queryKey:["profile",t],queryFn:()=>x.getProfile({userId:t}),enabled:!!t}),g=b?.ffn_iuf??null,N=o.useMemo(()=>{const j=new Date;return j.setDate(j.getDate()-360),j.toISOString().slice(0,10)},[]),{data:C=[]}=E({queryKey:["swimmer-performances-recent",g],queryFn:()=>x.getSwimmerPerformances({iuf:g,fromDate:N}),enabled:!!g}),f=()=>{l(null),i(!0)},k=j=>{l(j),i(!0)},v=m,q=!!n&&!m;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(P,{variant:"outline",size:"sm",onClick:f,disabled:!n,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter un objectif"]})}),v&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(j=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},j))}),q&&y&&e.jsx("div",{className:"space-y-2",children:[1,2].map(j=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},j))}),q&&!y&&h.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ce,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif dÃ©fini pour ",s,"."]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:f,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),"CrÃ©er le premier objectif"]})]}),q&&!y&&h.length>0&&e.jsxs("div",{className:"space-y-2",children:[h.map(j=>e.jsx(Ut,{objective:j,performances:C,onEdit:k},j.id)),e.jsx("p",{className:"text-[10px] text-muted-foreground/60 italic text-center pt-1",children:"Les temps Â« Actuel Â» correspondent Ã  la meilleure performance des 360 derniers jours sur l'Ã©preuve."})]}),n&&e.jsx(Bt,{open:a,onOpenChange:i,objective:c,athleteName:s,athleteAuthId:n,competitions:p})]})},Ee="__today__";function qe(t,s){const a=[],i=new Date(t+"T00:00:00"),c=new Date(s+"T00:00:00"),l=new Date(i),n=l.getDay(),m=n===0?1:n===1?0:8-n;for(l.setDate(l.getDate()+m);l<=c;)a.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return a}function ne(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function be(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Gt(t){const s=new Date(t+"T00:00:00");return s.setDate(s.getDate()+6),s.toISOString().split("T")[0]}function Ht(t){const s=new Date;s.setHours(0,0,0,0);const a=new Date(t+"T00:00:00"),i=new Date(t+"T00:00:00");return i.setDate(i.getDate()+6),s>=a&&s<=i}const Jt=({athleteId:t})=>{const{toast:s}=he(),a=pe(),[i,c]=o.useState(null),[l,n]=o.useState(null),[m,p]=o.useState(""),[h,y]=o.useState(""),[b,g]=o.useState(!1),[N,C]=o.useState(!1),[f,k]=o.useState(!1),[v,q]=o.useState(""),[j,u]=o.useState(""),[_,w]=o.useState(""),{data:A=[]}=E({queryKey:["athletes"],queryFn:()=>x.getAthletes()}),F=o.useMemo(()=>A.find(D=>D.id===t)?.group_id??null,[A,t]),{data:K=[],isLoading:M}=E({queryKey:["training-cycles","athlete",t],queryFn:()=>x.getTrainingCycles({athleteId:t})}),{data:O=[],isLoading:J}=E({queryKey:["training-cycles","group",F],queryFn:()=>x.getTrainingCycles({groupId:F}),enabled:F!=null}),$=K.length===0&&O.length>0,T=K.length>0?K:O;o.useEffect(()=>{T.length>0&&(!i||!T.find(r=>r.id===i))&&c(T[0].id)},[T,i]);const d=T.find(r=>r.id===i)??null,{data:L=[],isLoading:S}=E({queryKey:["training-weeks",i],queryFn:()=>x.getTrainingWeeks(i),enabled:!!i}),{data:X=[]}=E({queryKey:["competitions"],queryFn:()=>x.getCompetitions()}),Me=o.useMemo(()=>[...X].sort((r,D)=>r.date.localeCompare(D.date)),[X]),mt=o.useMemo(()=>{const r=new Set;return L.forEach(D=>{D.week_type&&r.add(D.week_type)}),Array.from(r).sort()},[L]),ge=d?.start_competition_date??d?.start_date??null,ut=o.useMemo(()=>{if(!d)return[];const r=ge,D=d.end_competition_date;return!r||!D?[]:qe(r,D)},[d,ge]),xt=o.useMemo(()=>{const r=new Map;return L.forEach(D=>r.set(D.week_start,D)),r},[L]),Oe=M||J,we=W({mutationFn:async r=>{const D=await x.createTrainingCycle(r),R=r.start_date??X.find(Q=>Q.id===r.start_competition_id)?.date,B=X.find(Q=>Q.id===r.end_competition_id);if(R&&B){const Q=qe(R,B.date);Q.length>0&&await x.bulkUpsertTrainingWeeks(Q.map(ae=>({cycle_id:D.id,week_start:ae})))}return D},onSuccess:r=>{s({title:"Cycle cree"}),c(r.id),g(!1),q(""),u(""),w(""),a.invalidateQueries({queryKey:["training-cycles"]}),a.invalidateQueries({queryKey:["training-weeks",r.id]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),pt=W({mutationFn:r=>x.deleteTrainingCycle(r),onSuccess:()=>{s({title:"Cycle supprime"}),c(null),C(!1),a.invalidateQueries({queryKey:["training-cycles"]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),Le=W({mutationFn:r=>x.upsertTrainingWeek(r),onSuccess:()=>{n(null),a.invalidateQueries({queryKey:["training-weeks",i]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),Ke=W({mutationFn:async()=>{for(const r of O){const D=await x.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:r.start_competition_id,end_competition_id:r.end_competition_id,name:r.name,notes:r.notes}),R=await x.getTrainingWeeks(r.id);R.length>0&&await x.bulkUpsertTrainingWeeks(R.map(B=>({cycle_id:D.id,week_start:B.week_start,week_type:B.week_type,notes:B.notes})))}},onSuccess:()=>{s({title:"Planification personnalisee"}),k(!1),c(null),a.invalidateQueries({queryKey:["training-cycles"]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),$e=()=>{if(!v.trim()){s({title:"Nom requis",variant:"destructive"});return}if(!j||!_){s({title:"Dates requises",description:"Selectionnez le debut et la fin du cycle.",variant:"destructive"});return}const r=j===Ee,D=r?De(new Date):null,R=r?null:X.find(ae=>ae.id===j),B=X.find(ae=>ae.id===_),Q=r?D:R?.date;if(Q&&B&&B.date<=Q){s({title:"Dates invalides",description:"La competition de fin doit etre apres la date de debut.",variant:"destructive"});return}we.mutate({athlete_id:t,group_id:null,start_competition_id:r?null:j,end_competition_id:_,start_date:D,name:v.trim()})},ht=r=>{n(r.id),p(r.week_type??""),y(r.notes??"")},gt=r=>{n(`new:${r}`),p(""),y("")},ft=(r,D)=>{i&&Le.mutate({cycle_id:i,week_start:r,week_type:m.trim()||null,notes:h.trim()||null})},jt=()=>{n(null)};return!Oe&&T.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(dt,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun cycle de planification."}),e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>g(!0),children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau cycle"]}),e.jsx(ze,{open:b,onOpenChange:g,competitions:Me,name:v,setName:q,startId:j,setStartId:u,endId:_,setEndId:w,onSubmit:$e,isPending:we.isPending})]}):Oe?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(r=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-48 rounded bg-muted"})},r))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[T.length>1?e.jsxs(Y,{value:i??"",onValueChange:c,children:[e.jsx(Z,{className:"w-auto min-w-[180px] h-8 text-sm",children:e.jsx(ee,{placeholder:"Choisir un cycle"})}),e.jsx(te,{children:T.map(r=>e.jsx(V,{value:r.id,children:r.name},r.id))})]}):d?e.jsx("span",{className:"text-sm font-semibold",children:d.name}):null,$&&e.jsx(I,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Planif. groupe"}),e.jsx("div",{className:"flex-1"}),$&&e.jsxs(P,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>k(!0),children:[e.jsx(qt,{className:"mr-1 h-3 w-3"}),"Personnaliser"]}),e.jsxs(P,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>g(!0),children:[e.jsx(se,{className:"mr-1 h-3 w-3"}),"Nouveau"]}),d&&!$&&e.jsx(P,{variant:"ghost",size:"sm",className:"text-xs h-7 text-destructive hover:text-destructive",onClick:()=>C(!0),children:e.jsx(Pe,{className:"h-3 w-3"})})]}),d&&e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:d.start_competition_id?"ðŸŠ":"ðŸ“…"}),e.jsx("span",{className:"text-sm font-medium",children:d.start_competition_id?d.start_competition_name??"Competition":"Debut du cycle"}),ge&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",ne(ge),")"]})]}),e.jsx("div",{className:"relative ml-3 border-l-2 border-border pl-4 space-y-1",children:S?e.jsx("div",{className:"py-4",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"})}):ut.map((r,D)=>{const R=xt.get(r),B=Ht(r),Q=l===(R?.id??`new:${r}`);return e.jsx(Xt,{monday:r,weekNumber:D+1,week:R,isCurrent:B,isEditing:Q,isGroupPlan:$,editWeekType:m,setEditWeekType:p,editWeekNotes:h,setEditWeekNotes:y,existingWeekTypes:mt,onStartEdit:()=>R?ht(R):gt(r),onSave:()=>ft(r),onCancel:jt,isSaving:Le.isPending},r)})}),e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:"ðŸŽ¯"}),e.jsx("span",{className:"text-sm font-medium",children:d.end_competition_name??"Competition"}),d.end_competition_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",ne(d.end_competition_date),")"]})]})]}),e.jsx(ze,{open:b,onOpenChange:g,competitions:Me,name:v,setName:q,startId:j,setStartId:u,endId:_,setEndId:w,onSubmit:$e,isPending:we.isPending}),e.jsx(re,{open:N,onOpenChange:C,children:e.jsxs(ie,{children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Supprimer le cycle"}),e.jsx(oe,{children:"Cette action est irreversible. Le cycle et toutes ses semaines seront supprimes."})]}),e.jsxs(de,{children:[e.jsx(me,{children:"Annuler"}),e.jsx(ue,{onClick:()=>i&&pt.mutate(i),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(re,{open:f,onOpenChange:k,children:e.jsxs(ie,{children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Personnaliser la planification"}),e.jsx(oe,{children:"Les cycles du groupe seront copies en tant que planification individuelle pour ce nageur. Vous pourrez ensuite les modifier independamment."})]}),e.jsxs(de,{children:[e.jsx(me,{children:"Annuler"}),e.jsx(ue,{onClick:()=>Ke.mutate(),children:Ke.isPending?"Copie...":"Personnaliser"})]})]})})]})},Xt=({monday:t,weekNumber:s,week:a,isCurrent:i,isEditing:c,isGroupPlan:l,editWeekType:n,setEditWeekType:m,editWeekNotes:p,setEditWeekNotes:h,existingWeekTypes:y,onStartEdit:b,onSave:g,onCancel:N,isSaving:C})=>{const f=Gt(t),k=`week-types-${t}`;return c?e.jsxs("div",{className:`rounded-lg border bg-card p-3 space-y-2 ${i?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground",children:["Sem. ",s," (",be(t)," - ",be(f),")"]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(z,{className:"text-xs",children:"Type de semaine"}),e.jsx(_e,{className:"h-7 text-sm",placeholder:"Ex : Foncier, Affutage, Recup...",list:k,value:n,onChange:v=>m(v.target.value)}),e.jsx("datalist",{id:k,children:y.map(v=>e.jsx("option",{value:v},v))})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(z,{className:"text-xs",children:"Notes"}),e.jsx(Fe,{className:"text-sm min-h-[48px]",placeholder:"Notes optionnelles...",rows:2,value:p,onChange:v=>h(v.target.value)})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(P,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:N,children:[e.jsx(yt,{className:"mr-1 h-3 w-3"}),"Annuler"]}),e.jsxs(P,{size:"sm",className:"h-7 text-xs",onClick:g,disabled:C,children:[e.jsx(Ft,{className:"mr-1 h-3 w-3"}),C?"...":"Enregistrer"]})]})]}):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-3 py-2 flex items-center gap-2 transition-colors ${l?"cursor-default":"hover:bg-muted/50"} ${i?"ring-2 ring-primary":""}`,onClick:l?void 0:b,disabled:l,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-xs font-medium text-muted-foreground whitespace-nowrap",children:["Sem. ",s]}),e.jsxs("span",{className:"text-[10px] text-muted-foreground/70 whitespace-nowrap",children:["(",be(t)," - ",be(f),")"]}),a?.week_type&&e.jsx(I,{className:"text-[10px] px-1.5 py-0 border-0",style:{backgroundColor:lt(a.week_type),color:it(a.week_type)},children:a.week_type})]}),a?.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:a.notes})]}),!l&&e.jsx(At,{className:"h-3 w-3 text-muted-foreground/40 shrink-0"})]})},ze=({open:t,onOpenChange:s,competitions:a,name:i,setName:c,startId:l,setStartId:n,endId:m,setEndId:p,onSubmit:h,isPending:y})=>(o.useEffect(()=>{t&&(c(""),n(""),p(""))},[t]),e.jsx(Xe,{open:t,onOpenChange:s,children:e.jsxs(Ye,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(Ze,{children:e.jsx(et,{children:"Nouveau cycle"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Nom du cycle *"}),e.jsx(_e,{placeholder:"Ex : Preparation hiver",value:i,onChange:b=>c(b.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Date de debut *"}),e.jsxs(Y,{value:l,onValueChange:n,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Choisir..."})}),e.jsxs(te,{children:[e.jsxs(V,{value:Ee,children:["Aujourd'hui (",ne(De(new Date)),")"]}),a.map(b=>e.jsxs(V,{value:b.id,children:[b.name," (",ne(b.date),")"]},b.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{children:"Competition de fin *"}),e.jsxs(Y,{value:m,onValueChange:p,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Choisir..."})}),e.jsx(te,{children:a.map(b=>e.jsxs(V,{value:b.id,children:[b.name," (",ne(b.date),")"]},b.id))})]})]}),l&&m&&(()=>{const g=l===Ee?De(new Date):a.find(C=>C.id===l)?.date,N=a.find(C=>C.id===m);if(g&&N&&N.date>g){const C=qe(g,N.date).length;return e.jsxs("p",{className:"text-xs text-muted-foreground",children:[C," semaine",C>1?"s":""," seront generees."]})}return null})(),e.jsx(P,{className:"w-full",onClick:h,disabled:y,children:y?"Creation...":"Creer le cycle"})]})]})}));function H(t){return new Date(t+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function ye(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Yt(t){const s=new Date(t+"T00:00:00");return s.setDate(s.getDate()+6),s.toISOString().split("T")[0]}function Zt(t){const s=new Date;s.setHours(0,0,0,0);const a=new Date(t+"T00:00:00"),i=new Date(t+"T00:00:00");return i.setDate(i.getDate()+6),s>=a&&s<=i}function Ie(t,s){const a=[],i=new Date(t+"T00:00:00"),c=new Date(s+"T00:00:00"),l=new Date(i),n=l.getDay(),m=n===0?1:n===1?0:8-n;for(l.setDate(l.getDate()+m);l<=c;)a.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return a}function es(t,s){const a=new Date(t+"T00:00:00"),i=new Date(s+"T00:00:00");return Math.round((i.getTime()-a.getTime())/(1e3*60*60*24))}const ts={draft_athlete:{label:"En attente nageur",variant:"secondary",className:"bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300 border-amber-200 dark:border-amber-800"},draft_coach:{label:"PrÃ©paration coach",variant:"secondary",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800"},sent:{label:"EnvoyÃ©",variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300 border-green-200 dark:border-green-800"},signed:{label:"SignÃ©",variant:"secondary",className:"bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-300 border-slate-200 dark:border-slate-700"}};function ss(t){const s=ts[t];return e.jsx(I,{variant:s.variant,className:`text-[10px] px-1.5 py-0 ${s.className}`,children:s.label})}async function as(t){const{data:s,error:a}=await He.rpc("get_auth_uid_for_user",{p_user_id:t});return a?(console.error("[interviews-tab] Failed to resolve auth UUID:",a.message),null):s}const G=({label:t,text:s})=>e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Nt,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),Ne=({label:t,text:s})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ct,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),ve=({label:t,value:s,onChange:a,onBlur:i,placeholder:c,rows:l=3})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ct,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx(Fe,{className:"bg-white dark:bg-background",placeholder:c,value:s,onChange:n=>a(n.target.value),onBlur:i,rows:l})]}),U=({label:t})=>e.jsxs("div",{className:"flex items-center gap-2 pt-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),Be=({objective:t,performances:s=[]})=>{const a=!!t.event_code,i=!!t.text,c=a?tt(t.event_code):null,l=c?nt[c]??"":"",n=a?st(s,t.event_code,t.pool_length):null;let m=null;return n&&t.target_time_seconds!=null&&t.event_code&&(m=n.time-t.target_time_seconds,at(n.time,t.target_time_seconds,t.event_code)),e.jsxs("div",{className:`rounded-lg border bg-card p-2.5 text-sm space-y-1 ${a?`border-l-4 ${l}`:""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(Ce,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:a?Ae(t.event_code):""}),t.pool_length&&e.jsxs(I,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[t.pool_length,"m"]}),t.target_time_seconds!=null&&e.jsx(I,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:xe(t.target_time_seconds)})]}),i&&e.jsx("p",{className:"text-muted-foreground line-clamp-2 pl-5",children:t.text}),n&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:xe(n.time)})]}),n.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",H(n.date),")"]}),m!=null&&e.jsx("span",{className:m<=0?"text-emerald-600 font-medium":"text-amber-600",children:m<=0?"Objectif atteint !":`+${m.toFixed(2)}s`})]}),!n&&a&&t.target_time_seconds!=null&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"})]})},Qe=({prevInterview:t,commitmentReview:s})=>{const[a,i]=o.useState(!1);return e.jsxs(Pt,{open:a,onOpenChange:i,children:[e.jsx(Mt,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Kt,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${a?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements prÃ©cÃ©dents"}),e.jsx(I,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:H(t.date)})]})}),e.jsx(Ot,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[t.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Engagements nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t.athlete_commitments})]}),t.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t.coach_actions})]}),s&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Bilan du nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s})]})]})})]})},Ue=({athleteId:t,interviewDate:s})=>{const{toast:a}=he(),i=pe(),{data:c=[]}=E({queryKey:["competitions"],queryFn:()=>x.getCompetitions()}),{data:l=[]}=E({queryKey:["my-competition-ids",t],queryFn:()=>x.getMyCompetitionIds(t)}),n=o.useMemo(()=>{const u=new Set(l);return c.filter(w=>u.has(w.id)&&w.date>=s).sort((w,A)=>w.date.localeCompare(A.date))[0]??null},[c,l,s]),{data:m=[]}=E({queryKey:["training-cycles","athlete",t],queryFn:()=>x.getTrainingCycles({athleteId:t})}),p=o.useMemo(()=>n?m.find(u=>u.end_competition_id===n.id||u.end_competition_date&&u.end_competition_date>=s)??null:null,[m,n,s]),{data:h=[]}=E({queryKey:["training-weeks",p?.id],queryFn:()=>x.getTrainingWeeks(p.id),enabled:!!p}),[y,b]=o.useState(null),[g,N]=o.useState(""),C=o.useMemo(()=>{const u=new Set;return h.forEach(_=>{_.week_type&&u.add(_.week_type)}),Array.from(u).sort()},[h]),f=o.useMemo(()=>{const u=new Map;return h.forEach(_=>u.set(_.week_start,_)),u},[h]),k=o.useMemo(()=>{if(!n)return[];const u=s,_=n.date;return Ie(u,_)},[n,s]),v=n?es(new Date().toISOString().split("T")[0],n.date):null,q=W({mutationFn:async()=>{if(!n)throw new Error("Pas de compÃ©tition");const _=c.filter(F=>F.date<=s).sort((F,K)=>K.date.localeCompare(F.date))[0]??n,w=await x.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:_.id,end_competition_id:n.id,name:`PrÃ©paration ${n.name}`}),A=Ie(s,n.date);return A.length>0&&await x.bulkUpsertTrainingWeeks(A.map(F=>({cycle_id:w.id,week_start:F}))),w},onSuccess:()=>{a({title:"Planification crÃ©Ã©e"}),i.invalidateQueries({queryKey:["training-cycles"]}),i.invalidateQueries({queryKey:["training-weeks"]})},onError:u=>{a({title:"Erreur",description:u.message,variant:"destructive"})}}),j=W({mutationFn:u=>x.upsertTrainingWeek(u),onSuccess:()=>{b(null),i.invalidateQueries({queryKey:["training-weeks",p?.id]})},onError:u=>{a({title:"Erreur",description:u.message,variant:"destructive"})}});return n?p?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(ke,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsx("span",{className:"font-medium",children:n.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",H(n.date),")"]}),v!=null&&e.jsxs(I,{variant:"secondary",className:"text-[10px]",children:["J-",v]})]}),e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1",children:k.map((u,_)=>{const w=f.get(u),A=Zt(u),F=y===u,K=Yt(u),M=`inline-week-${u}`;return F?e.jsxs("div",{className:`rounded-lg border bg-card p-2 space-y-1.5 ${A?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Sem. ",_+1," (",ye(u)," - ",ye(K),")"]}),e.jsx(_e,{className:"h-7 text-sm",placeholder:"Foncier, Techni., AffÃ»tage...",list:M,value:g,onChange:O=>N(O.target.value)}),e.jsx("datalist",{id:M,children:C.map(O=>e.jsx("option",{value:O},O))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(P,{variant:"ghost",size:"sm",className:"h-6 text-xs px-2",onClick:()=>b(null),children:"Annuler"}),e.jsx(P,{size:"sm",className:"h-6 text-xs px-2",onClick:()=>{p&&j.mutate({cycle_id:p.id,week_start:u,week_type:g.trim()||null})},disabled:j.isPending,children:"OK"})]})]},u):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg px-2 py-1.5 flex items-center gap-2 text-xs transition-colors hover:bg-muted/50 ${A?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>{b(u),N(w?.week_type??"")},children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${A?"bg-primary":w?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",_+1]}),e.jsxs("span",{className:"text-muted-foreground/60 whitespace-nowrap",children:[ye(u)," - ",ye(K)]}),w?.week_type&&e.jsx(I,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:lt(w.week_type),color:it(w.week_type)},children:w.week_type})]},u)})}),e.jsxs("div",{className:"flex items-center gap-2 ml-2 pl-3 text-xs",children:[e.jsx(ke,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("span",{className:"font-semibold",children:n.name})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ke,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"font-medium",children:n.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",H(n.date),")"]}),v!=null&&e.jsxs(I,{variant:"secondary",className:"text-[10px]",children:["J-",v]})]}),e.jsx(P,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:()=>q.mutate(),disabled:q.isPending,children:q.isPending?"CrÃ©ation...":"CrÃ©er la planification"})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"Aucune compÃ©tition assignÃ©e Ã  venir â€” planification non disponible."})})},ns=({interview:t,athleteId:s,objectives:a,performances:i})=>{const{toast:c}=he(),l=pe(),[n,m]=o.useState(t.status!=="signed"),[p,h]=o.useState(t.coach_comment_successes??""),[y,b]=o.useState(t.coach_comment_difficulties??""),[g,N]=o.useState(t.coach_comment_goals??""),C=t.coach_review??"",f=t.coach_objectives??"",[k,v]=o.useState(t.coach_actions??""),[q,j]=o.useState(!1),[u,_]=o.useState(!1),w=o.useRef(!1),{data:A}=E({queryKey:["previous-interview",s,t.date,t.id],queryFn:()=>x.getPreviousInterview(s,t.date,t.id),enabled:!!t.date}),F=o.useCallback(()=>({coach_comment_successes:p.trim()||null,coach_comment_difficulties:y.trim()||null,coach_comment_goals:g.trim()||null,coach_review:C.trim()||null,coach_objectives:f.trim()||null,coach_actions:k.trim()||null}),[k,y,g,p,f,C]),K=o.useCallback(()=>{const S=F();return(t.coach_comment_successes??null)!==S.coach_comment_successes||(t.coach_comment_difficulties??null)!==S.coach_comment_difficulties||(t.coach_comment_goals??null)!==S.coach_comment_goals||(t.coach_review??null)!==S.coach_review||(t.coach_objectives??null)!==S.coach_objectives||(t.coach_actions??null)!==S.coach_actions},[F,t]),M=W({mutationFn:S=>x.updateInterviewCoachSections(t.id,S),onSuccess:()=>{l.invalidateQueries({queryKey:["interviews",s]})},onError:S=>{c({title:"Erreur",description:S.message,variant:"destructive"})}}),O=W({mutationFn:async()=>(await x.updateInterviewCoachSections(t.id,F()),x.sendInterviewToAthlete(t.id)),onSuccess:()=>{c({title:"Entretien envoyÃ© au nageur"}),l.invalidateQueries({queryKey:["interviews",s]})},onError:S=>{c({title:"Erreur",description:S.message,variant:"destructive"})}}),J=W({mutationFn:()=>x.deleteInterview(t.id),onSuccess:()=>{c({title:"Entretien supprimÃ©"}),l.invalidateQueries({queryKey:["interviews",s]})},onError:S=>{c({title:"Erreur",description:S.message,variant:"destructive"})}}),$=M.isPending||O.isPending||J.isPending,T=t.status,d=T==="draft_athlete"?"border-amber-300 dark:border-amber-700 border-l-4":T==="draft_coach"?"border-blue-300 dark:border-blue-700 border-l-4":T==="sent"?"border-emerald-300 dark:border-emerald-700 border-l-4":"",L=o.useCallback(()=>{T!=="draft_coach"||w.current||$||!K()||(w.current=!0,M.mutate(F()),window.setTimeout(()=>{w.current=!1},500))},[F,K,$,M,T]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${d}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>m(S=>!S),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:H(t.date)}),ss(T),T==="signed"&&t.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",H(t.signed_at.slice(0,10))]})]}),n?e.jsx(Lt,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(Je,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),n&&e.jsxs("div",{className:"px-4 pb-4 space-y-5",children:[T==="draft_athlete"&&e.jsxs("div",{className:"rounded-xl border border-dashed border-amber-300 bg-amber-50/50 dark:bg-amber-950/20 p-6 text-center space-y-2",children:[e.jsx(ot,{className:"h-8 w-8 mx-auto text-amber-500"}),e.jsx("p",{className:"text-sm font-medium",children:"En attente de la prÃ©paration du nageur"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Le contenu n'est pas encore visible. Le nageur doit d'abord remplir ses sections."})]}),T==="draft_coach"&&e.jsxs(e.Fragment,{children:[A&&e.jsx(Qe,{prevInterview:A,commitmentReview:t.athlete_commitment_review}),e.jsx(U,{label:"RÃ©ussites"}),e.jsx(G,{label:"Nageur",text:t.athlete_successes}),e.jsx(ve,{label:"Coach",value:p,onChange:h,onBlur:L,placeholder:"Votre commentaire sur les rÃ©ussites..."}),e.jsx(U,{label:"DifficultÃ©s"}),e.jsx(G,{label:"Nageur",text:t.athlete_difficulties}),e.jsx(ve,{label:"Coach",value:y,onChange:b,onBlur:L,placeholder:"Votre commentaire sur les difficultÃ©s..."}),e.jsx(U,{label:"Objectifs"}),a.length>0&&e.jsx("div",{className:"space-y-1.5",children:a.map(S=>e.jsx(Be,{objective:S,performances:i},S.id))}),e.jsx(G,{label:"Nageur",text:t.athlete_goals}),e.jsx(ve,{label:"Coach",value:g,onChange:N,onBlur:L,placeholder:"Objectifs complÃ©mentaires, commentaires..."}),e.jsx(U,{label:"Planification"}),e.jsx(Ue,{athleteId:s,interviewDate:t.date}),e.jsx(U,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(G,{label:"Engagements du nageur",text:t.athlete_commitments}),e.jsx(ve,{label:"Actions du coach",value:k,onChange:v,onBlur:L,placeholder:"Actions concrÃ¨tes, points de suivi..."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:M.isPending?"Sauvegarde...":"Sauvegarde automatique a la sortie d'un champ."})]}),(T==="sent"||T==="signed")&&e.jsxs(e.Fragment,{children:[A&&e.jsx(Qe,{prevInterview:A,commitmentReview:t.athlete_commitment_review}),e.jsx(U,{label:"RÃ©ussites"}),e.jsx(G,{label:"Nageur",text:t.athlete_successes}),e.jsx(Ne,{label:"Coach",text:t.coach_comment_successes||t.coach_review}),e.jsx(U,{label:"DifficultÃ©s"}),e.jsx(G,{label:"Nageur",text:t.athlete_difficulties}),e.jsx(Ne,{label:"Coach",text:t.coach_comment_difficulties}),e.jsx(U,{label:"Objectifs"}),a.length>0&&e.jsx("div",{className:"space-y-1.5",children:a.map(S=>e.jsx(Be,{objective:S,performances:i},S.id))}),e.jsx(G,{label:"Nageur",text:t.athlete_goals}),e.jsx(Ne,{label:"Coach",text:t.coach_comment_goals||t.coach_objectives}),e.jsx(U,{label:"Planification"}),e.jsx(Ue,{athleteId:s,interviewDate:t.date}),e.jsx(U,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(G,{label:"Engagements du nageur",text:t.athlete_commitments}),e.jsx(Ne,{label:"Actions du coach",text:t.coach_actions})]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[T==="draft_coach"&&e.jsxs(P,{className:"w-full",onClick:()=>_(!0),disabled:$,children:[e.jsx(Re,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer au nageur"]}),e.jsxs(P,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>j(!0),disabled:$,children:[e.jsx(Pe,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})]})]}),e.jsx(re,{open:q,onOpenChange:j,children:e.jsxs(ie,{children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Supprimer l'entretien"}),e.jsxs(oe,{children:["Cette action est irrÃ©versible. L'entretien du ",t.date?H(t.date):""," sera supprimÃ© dÃ©finitivement."]})]}),e.jsxs(de,{children:[e.jsx(me,{children:"Annuler"}),e.jsx(ue,{onClick:()=>{J.mutate(),j(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(re,{open:u,onOpenChange:_,children:e.jsxs(ie,{children:[e.jsxs(le,{children:[e.jsx(ce,{children:"Envoyer au nageur"}),e.jsx(oe,{children:"L'entretien sera envoyÃ© au nageur pour consultation. Les sections coach seront enregistrÃ©es automatiquement."})]}),e.jsxs(de,{children:[e.jsx(me,{children:"Annuler"}),e.jsxs(ue,{onClick:()=>{O.mutate(),_(!1)},children:[e.jsx(Re,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer"]})]})]})})]})},rs=({athleteId:t,athleteName:s})=>{const{toast:a}=he(),i=pe(),{data:c}=E({queryKey:["auth-uid",t],queryFn:()=>as(t),enabled:!!t}),{data:l=[]}=E({queryKey:["objectives",c],queryFn:()=>x.getObjectives(c),enabled:!!c}),{data:n}=E({queryKey:["athlete-profile",t],queryFn:()=>x.getProfile({userId:t}),enabled:!!t}),m=n?.ffn_iuf??null,p=o.useMemo(()=>{const N=new Date;return N.setDate(N.getDate()-360),N.toISOString().slice(0,10)},[]),{data:h=[]}=E({queryKey:["swimmer-performances-recent",m],queryFn:()=>x.getSwimmerPerformances({iuf:m,fromDate:p}),enabled:!!m}),{data:y=[],isLoading:b}=E({queryKey:["interviews",t],queryFn:()=>x.getInterviews(t),enabled:!!t}),g=W({mutationFn:()=>x.createInterview({athlete_id:t}),onSuccess:()=>{a({title:"Entretien crÃ©Ã©"}),i.invalidateQueries({queryKey:["interviews",t]})},onError:N=>{a({title:"Erreur",description:N.message,variant:"destructive"})}});return b?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(N=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-24 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-20 rounded bg-muted"})]})},N))}):y.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(rt,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun entretien pour ",s,"."]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>g.mutate(),disabled:g.isPending,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),g.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Entretiens"}),e.jsx(I,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:y.length})]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>g.mutate(),disabled:g.isPending,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),g.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}),e.jsx("div",{className:"space-y-2",children:y.map(N=>e.jsx(ns,{interview:N,athleteId:t,objectives:l,performances:h},N.id))})]})};function Ls(){const[,t]=vt("/coach/swimmer/:id"),[,s]=Ve(),{selectedAthleteId:a,selectedAthleteName:i}=Ge(),c=t?.id?Number(t.id):a,l=i,{data:n}=E({queryKey:["profile",c],queryFn:()=>x.getProfile({userId:c}),enabled:c!=null}),m=n?.display_name??l??"Nageur",p=n?.avatar_url??null,h=n?.group_label??null;return c?e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>s("/coach?section=swimmers"),className:"h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition","aria-label":"Retour",children:e.jsx(Et,{className:"h-4 w-4"})}),p?e.jsx("img",{src:p,alt:"",className:"h-10 w-10 rounded-full object-cover border border-border"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary",children:m.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-lg font-bold truncate",children:m}),h&&e.jsx(I,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:h})]})]}),e.jsxs(_t,{defaultValue:"ressentis",children:[e.jsxs(Ct,{className:"w-full grid grid-cols-4",children:[e.jsxs(fe,{value:"ressentis",className:"text-xs gap-1",children:[e.jsx(ot,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(fe,{value:"objectifs",className:"text-xs gap-1",children:[e.jsx(Ce,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Objectifs"})]}),e.jsxs(fe,{value:"planification",className:"text-xs gap-1",children:[e.jsx(dt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Planif."})]}),e.jsxs(fe,{value:"entretiens",className:"text-xs gap-1",children:[e.jsx(rt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]})]}),e.jsx(je,{value:"ressentis",className:"mt-4",children:e.jsx(zt,{athleteId:c,athleteName:m})}),e.jsx(je,{value:"objectifs",className:"mt-4",children:e.jsx(Vt,{athleteId:c,athleteName:m})}),e.jsx(je,{value:"planification",className:"mt-4",children:e.jsx(Jt,{athleteId:c})}),e.jsx(je,{value:"entretiens",className:"mt-4",children:e.jsx(rs,{athleteId:c,athleteName:m})})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx("p",{children:"Aucun nageur sÃ©lectionnÃ©."}),e.jsx("button",{type:"button",onClick:()=>s("/coach?section=swimmers"),className:"mt-2 text-primary underline",children:"Retour au dashboard"})]})}export{Ls as default};
