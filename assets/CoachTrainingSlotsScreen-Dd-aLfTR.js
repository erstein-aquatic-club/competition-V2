import{c as he,r as l,d as X,j as e,u as W}from"./vendor-query-DyA9aSKS.js";import{u as $t,d as Et,a as L,c as At}from"./api-DwyuCtAl.js";import{b as pe,L as A,l as st,P as se,B as q,I as oe,f as qt,W as Pt,d as Ae,u as It,a4 as at}from"./index-Cc5GnU4d.js";import{C as Lt}from"./Coach-CVuz29nl.js";import{S as ge,a as fe,b as be,c as je,d as ve}from"./sheet-CJwl_pdI.js";import{B as qe}from"./badge-BwyOhVor.js";import{C as zt}from"./checkbox-BO7-Osae.js";import{A as rt,a as nt,b as it,c as lt,d as ot,e as dt,f as ct,g as mt}from"./alert-dialog-Cq899WaO.js";import{C as ut}from"./clock-CQXvjJEp.js";import{M as Pe}from"./map-pin-DEXgxUm-.js";import{L as xt}from"./loader-circle-f_xmTSOT.js";import{P as ht}from"./pencil-DZ05niTQ.js";import{E as Vt}from"./eye-off-C1VXiYuE.js";import{E as Rt}from"./eye-DUSnBV-K.js";import{C as Ht}from"./copy-DJFLBtRO.js";import{T as pt}from"./trash-2-tDfdySvr.js";import{w as Ot}from"./swim-BJev65MH.js";import{c as Bt}from"./swimSessionUtils-DN7EW4yB.js";import{S as Kt}from"./search-C8QG0LdG.js";import{S as Wt}from"./separator-CczRTV-v.js";import{S as ae,a as re,b as ne,c as ie,d as H,f as te}from"./select-CK3OyCfL.js";import{R as Gt,a as Ge}from"./radio-group-BS0kxnF2.js";import{C as De}from"./chevron-left-e5VS8sk8.js";import{C as gt}from"./chevron-right-Bg27ksfI.js";import{C as Qt}from"./index-4FTywvqr.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-C_zJasP4.js";import"./trophy-Dy7J8P4K.js";import"./bell-ring-DxFpM57E.js";import"./zap-C8Bsr3R-.js";import"./index-BEy7WBTi.js";import"./index-DCX2sNhR.js";import"./index-DtfAejTg.js";import"./chevron-down-C_46x42c.js";import"./chevron-up-DeON4MDY.js";import"./index-Cg3Wixhj.js";import"./circle-C267Op5q.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=[["path",{d:"M4.929 4.929 19.07 19.071",key:"196cmz"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],ft=pe("ban",Ut);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]],Fe=pe("book-open",Yt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=[["path",{d:"M10.1 2.182a10 10 0 0 1 3.8 0",key:"5ilxe3"}],["path",{d:"M13.9 21.818a10 10 0 0 1-3.8 0",key:"11zvb9"}],["path",{d:"M17.609 3.721a10 10 0 0 1 2.69 2.7",key:"1iw5b2"}],["path",{d:"M2.182 13.9a10 10 0 0 1 0-3.8",key:"c0bmvh"}],["path",{d:"M20.279 17.609a10 10 0 0 1-2.7 2.69",key:"1ruxm7"}],["path",{d:"M21.818 10.1a10 10 0 0 1 0 3.8",key:"qkgqxc"}],["path",{d:"M3.721 6.391a10 10 0 0 1 2.7-2.69",key:"1mcia2"}],["path",{d:"M6.391 20.279a10 10 0 0 1-2.69-2.7",key:"1fvljs"}]],Qe=pe("circle-dashed",Jt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xt=[["path",{d:"M11 17a4 4 0 0 1-8 0V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2Z",key:"1ldrpk"}],["path",{d:"M16.7 13H19a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H7",key:"11i5po"}],["path",{d:"M 7 17h.01",key:"1euzgo"}],["path",{d:"m11 8 2.3-2.3a2.4 2.4 0 0 1 3.404.004L18.6 7.6a2.4 2.4 0 0 1 .026 3.434L9.9 19.8",key:"o2gii7"}]],Zt=pe("swatch-book",Xt);function es(t,a){return t?t.visible_from===null||t.visible_from===void 0||t.visible_from<=a?"published":"draft":"empty"}const ts=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function Ue(t){return t.slice(0,5)}function Ye(t){const[a,r,o]=t.split("-").map(Number),f=new Date(a,r-1,o),m=(f.getDay()+6)%7,j=ts[m],u=f.toLocaleDateString("fr-FR",{month:"long"});return`${j} ${o} ${u}`}const Te={empty:{label:"",badgeClass:""},draft:{label:"Brouillon",badgeClass:"bg-amber-500/15 text-amber-600 dark:text-amber-400 border-amber-500/25"},published:{label:"Publié",badgeClass:"bg-emerald-500/15 text-emerald-600 dark:text-emerald-400 border-emerald-500/25"},cancelled:{label:"Annulé",badgeClass:"bg-muted text-muted-foreground border-border/50"}};function ss({instance:t,open:a,onOpenChange:r,onCreateNew:o,onEditSession:f,onPickTemplate:m,onEditSlot:j,onManageOverride:u}){const w=he(),[p,g]=l.useState([]),[b,k]=l.useState(""),[M,_]=l.useState(!1),[c,N]=l.useState(!1),[v,F]=l.useState("session");l.useEffect(()=>{t&&(g(t.groups.map(E=>E.group_id)),k(t.assignment?.visible_from??t.date),_(!1),N(!1),F(t.state==="cancelled"?"slot":"session"))},[t]);const x=l.useCallback(()=>{w.invalidateQueries({queryKey:["slot-assignments"]})},[w]),D=X({mutationFn:E=>$t(E),onSuccess:()=>{x(),_(!1)}}),S=X({mutationFn:E=>Et(E),onSuccess:()=>{x(),N(!1),r(!1)}}),T=E=>{g(V=>V.includes(E)?V.filter(K=>K!==E):[...V,E])},P=()=>{t&&D.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date,visibleFrom:b||null})},y=()=>{t&&S.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date})},B=()=>{!t||!j||(r(!1),j(t))},z=()=>{!t||!u||(r(!1),u(t))};if(!t)return null;const{state:$,slot:I,assignment:U,override:C,groups:i}=t,d=Te[$],R=$==="cancelled";return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:a,onOpenChange:r,children:e.jsxs(fe,{side:"bottom",className:"rounded-t-3xl max-h-[85vh] overflow-y-auto px-5 pb-8 pt-4",children:[e.jsx("div",{className:"mx-auto mb-4 h-1 w-10 rounded-full bg-border/60"}),e.jsxs(be,{className:"mb-5 space-y-1.5 text-left",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"text-base font-bold leading-tight",children:Ye(t.date)}),$!=="empty"&&e.jsx(qe,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${d.badgeClass}`,children:d.label})]}),e.jsxs(ve,{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ut,{className:"h-3 w-3 opacity-60"}),Ue(I.start_time)," – ",Ue(I.end_time)]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Pe,{className:"h-3 w-3 opacity-60"}),I.location]})]})]}),e.jsx(as,{mode:v,onModeChange:F,sessionDisabled:R}),v==="session"?e.jsxs(e.Fragment,{children:[$==="cancelled"&&e.jsx(rs,{override:C}),$==="empty"&&e.jsx(ns,{instance:t,groups:i,selectedGroups:p,visibleFrom:b,onToggleGroup:T,onVisibleFromChange:k,onCreateNew:o,onPickTemplate:m,onClose:()=>r(!1)}),($==="draft"||$==="published")&&e.jsx(is,{instance:t,assignment:U,showVisibilityPicker:M,visibleFrom:b,visibilityLoading:D.isPending,deleteLoading:S.isPending,onToggleVisibilityPicker:()=>_(E=>!E),onVisibleFromChange:k,onSaveVisibility:P,onEditSession:f,onRequestDelete:()=>N(!0)})]}):e.jsx(ls,{state:$,override:C,canEditSlot:!!j,canManageOverride:!!u,onEditSlot:B,onManageOverride:z})]})}),e.jsx(rt,{open:c,onOpenChange:N,children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(lt,{children:"Supprimer la séance ?"}),e.jsxs(ot,{children:["Cette action supprimera définitivement la séance assignée pour ce créneau le ",Ye(t.date),". Les nageurs ne verront plus cette séance."]})]}),e.jsxs(dt,{children:[e.jsx(ct,{disabled:S.isPending,children:"Annuler"}),e.jsx(mt,{onClick:y,disabled:S.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:S.isPending?e.jsxs(e.Fragment,{children:[e.jsx(xt,{className:"mr-2 h-4 w-4 animate-spin"}),"Suppression..."]}):"Supprimer"})]})]})})]})}function as({mode:t,onModeChange:a,sessionDisabled:r}){return e.jsxs("div",{className:"mb-5 space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-[0.18em] text-muted-foreground",children:"Étape 1"}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Choisissez ce que vous voulez gérer"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(Je,{title:"Séance",description:r?"Indisponible tant que le créneau est annulé":"Créer, modifier ou publier",active:t==="session",disabled:r,onClick:()=>a("session")}),e.jsx(Je,{title:"Créneau",description:"Horaires, lieu et exception",active:t==="slot",onClick:()=>a("slot")})]})]})}function Je({title:t,description:a,active:r,disabled:o=!1,onClick:f}){return e.jsxs("button",{type:"button",onClick:f,disabled:o,className:`
        rounded-2xl border px-4 py-3 text-left transition-all
        ${o?"cursor-not-allowed opacity-50":"active:scale-[0.98]"}
        ${r?"border-primary/40 bg-primary/8 shadow-sm":"border-border/50 bg-muted/20 hover:bg-muted/35"}
      `,children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t}),e.jsx("p",{className:"mt-1 text-[11px] leading-snug text-muted-foreground",children:a})]})}function Ne({title:t,description:a}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-[0.18em] text-muted-foreground",children:"Étape 2"}),e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-muted/20 px-4 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:a})]})]})}function rs({override:t}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ne,{title:"Définir une séance",description:"Ce sous-menu redevient disponible quand le créneau n'est plus annulé."}),e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-muted/30 p-4 text-center",children:[e.jsx("div",{className:"mx-auto flex h-10 w-10 items-center justify-center rounded-2xl bg-muted",children:e.jsx(ft,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx("p",{className:"mt-3 text-sm font-medium text-foreground",children:"Ce créneau est annulé"}),t?.reason&&e.jsxs("p",{className:"mt-1.5 text-xs text-muted-foreground",children:["Motif : ",t.reason]})]})]})}function ns({instance:t,groups:a,selectedGroups:r,visibleFrom:o,onToggleGroup:f,onVisibleFromChange:m,onCreateNew:j,onPickTemplate:u,onClose:w}){const p=()=>{w(),j(t)},g=()=>{w(),u(t)};return e.jsxs("div",{className:"space-y-5",children:[e.jsx(Ne,{title:"Définir une séance",description:"Choisissez comment renseigner la séance liée à ce créneau."}),a.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Groupes concernés"}),e.jsx("div",{className:"space-y-2.5",children:a.map(b=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx(zt,{checked:r.includes(b.group_id),onCheckedChange:()=>f(b.group_id),className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:b.group_name})]},b.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(A,{htmlFor:"visible-from-empty",className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:[e.jsx(st,{className:"mr-1 inline h-3 w-3 opacity-60"}),"Visible à partir du"]}),e.jsx("input",{id:"visible-from-empty",type:"date",value:o,onChange:b=>m(b.target.value),className:"w-full rounded-xl border border-border bg-muted/30 px-3 py-2.5 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]}),e.jsxs("div",{className:"space-y-2.5",children:[e.jsx(G,{icon:e.jsx(se,{className:"h-4 w-4"}),label:"Nouvelle séance",description:"Créer une séance de zéro",onClick:p,highlight:!0}),e.jsx(G,{icon:e.jsx(Fe,{className:"h-4 w-4"}),label:"Depuis la bibliothèque",description:"Réutiliser une séance existante",onClick:g})]})]})}function is({instance:t,assignment:a,showVisibilityPicker:r,visibleFrom:o,visibilityLoading:f,deleteLoading:m,onToggleVisibilityPicker:j,onVisibleFromChange:u,onSaveVisibility:w,onEditSession:p,onRequestDelete:g}){return e.jsxs("div",{className:"space-y-5",children:[e.jsx(Ne,{title:"Définir une séance",description:"Travaillez sur la séance déjà liée à ce créneau."}),e.jsxs("div",{className:"rounded-xl border border-border/50 bg-muted/30 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground leading-snug",children:a.session_name??"Séance sans nom"}),a.session_distance!=null&&a.session_distance>0&&e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:[a.session_distance," m"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(qe,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${Te[t.state].badgeClass}`,children:Te[t.state].label}),a.visible_from&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Visible le"," ",new Date(a.visible_from).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})]})]})]}),t.groups.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.groups.map(b=>e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full border border-border/50 bg-muted/60 px-2.5 py-1 text-xs font-medium text-muted-foreground",children:b.group_name},b.id))}),e.jsxs("div",{className:"space-y-2.5",children:[a.swim_catalog_id!=null&&e.jsx(G,{icon:e.jsx(ht,{className:"h-4 w-4"}),label:"Modifier la séance",description:"Ouvrir dans l'éditeur",onClick:()=>p(a.swim_catalog_id),highlight:!0}),e.jsx(G,{icon:r?e.jsx(Vt,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"}),label:"Visibilité",description:"Définir la date de publication",onClick:j}),r&&e.jsxs("div",{className:"ml-12 space-y-2.5 rounded-xl border border-border/50 bg-muted/20 p-3",children:[e.jsx(A,{htmlFor:"visible-from-edit",className:"text-xs text-muted-foreground",children:"Visible à partir du"}),e.jsx("input",{id:"visible-from-edit",type:"date",value:o,onChange:b=>u(b.target.value),className:"w-full rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(q,{size:"sm",className:"flex-1 rounded-lg",disabled:f,onClick:w,children:[f?e.jsx(xt,{className:"mr-1.5 h-3.5 w-3.5 animate-spin"}):null,"Enregistrer"]}),e.jsx(q,{size:"sm",variant:"ghost",className:"rounded-lg",disabled:f,onClick:j,children:"Annuler"})]})]}),e.jsx(G,{icon:e.jsx(Ht,{className:"h-4 w-4"}),label:"Dupliquer vers...",description:"Bientôt disponible",disabled:!0,onClick:()=>{}}),e.jsx(G,{icon:e.jsx(pt,{className:"h-4 w-4"}),label:"Supprimer",description:"Retirer cette séance du créneau",variant:"destructive",disabled:m,onClick:g})]})]})}function ls({state:t,override:a,canEditSlot:r,canManageOverride:o,onEditSlot:f,onManageOverride:m}){return!r&&!o?null:e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ne,{title:"Gérer le créneau",description:"Modifiez la structure du créneau ou ajustez uniquement cette date."}),t==="cancelled"&&e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-muted/30 px-4 py-3",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Créneau annulé"}),a?.reason&&e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:["Motif : ",a.reason]})]}),e.jsxs("div",{className:"space-y-2.5",children:[r&&e.jsx(G,{icon:e.jsx(ht,{className:"h-4 w-4"}),label:"Modifier le créneau",description:"Horaires, lieu et groupes",onClick:f,highlight:!0}),o&&e.jsx(G,{icon:e.jsx(st,{className:"h-4 w-4"}),label:"Gérer l'exception",description:"Annuler ou ajuster ce jour précis",onClick:m})]})]})}function G({icon:t,label:a,description:r,variant:o="default",disabled:f=!1,highlight:m=!1,onClick:j}){const u=o==="destructive";return e.jsxs("button",{type:"button",onClick:j,disabled:f,className:`
        flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-left transition-colors
        ${f?"opacity-40 cursor-not-allowed":"active:scale-[0.98]"}
        ${u?"bg-destructive/5 hover:bg-destructive/10 active:bg-destructive/15":m?"bg-primary/10 hover:bg-primary/15 active:bg-primary/20":"bg-muted/40 hover:bg-muted/60 active:bg-muted/80"}
      `,children:[e.jsx("div",{className:`flex h-9 w-9 shrink-0 items-center justify-center rounded-lg ${u?"bg-destructive/10 text-destructive":m?"bg-primary/15 text-primary":"bg-muted text-muted-foreground"}`,children:t}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm font-semibold ${u?"text-destructive":"text-foreground"}`,children:a}),r&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:r})]})]})}function os({open:t,onOpenChange:a,onSelect:r}){const[o,f]=l.useState(""),{data:m,isLoading:j}=W({queryKey:["swim_catalog"],queryFn:()=>Ot(),enabled:t}),u=l.useMemo(()=>{if(!m)return[];const p=o.trim().toLowerCase();return m.filter(g=>!g.is_archived).filter(g=>!p||g.name.toLowerCase().includes(p)||(g.folder??"").toLowerCase().includes(p)).sort((g,b)=>g.name.localeCompare(b.name,"fr"))},[m,o]),w=p=>{r(p.id,p.name),a(!1)};return e.jsx(ge,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"bottom",className:"flex h-[80vh] flex-col rounded-t-2xl px-4 pb-4 pt-5",children:[e.jsxs(be,{className:"shrink-0 space-y-1",children:[e.jsx(je,{className:"text-base font-semibold",children:"Choisir une séance"}),e.jsx(ve,{className:"sr-only",children:"Parcourez et recherchez dans la bibliothèque de séances natation"})]}),e.jsxs("div",{className:"relative mt-3 shrink-0",children:[e.jsx(Kt,{className:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(oe,{placeholder:"Rechercher une séance...",value:o,onChange:p=>f(p.target.value),className:"pl-9"})]}),e.jsx("div",{className:"mt-3 flex-1 overflow-y-auto overscroll-contain",children:j?e.jsx("div",{className:"space-y-3",children:Array.from({length:6}).map((p,g)=>e.jsx(qt,{className:"h-[72px] w-full rounded-xl"},g))}):u.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-16 text-muted-foreground",children:[e.jsx(Pt,{className:"h-10 w-10 opacity-40"}),e.jsx("p",{className:"text-sm",children:"Aucune séance dans la bibliothèque"})]}):e.jsx("div",{className:"space-y-2",children:u.map(p=>{const g=Bt(p.items??[]);return e.jsxs("button",{type:"button",onClick:()=>w(p),className:"flex w-full items-center gap-3 rounded-xl border border-border bg-card p-3 text-left shadow-sm transition-transform active:scale-[0.98]",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-blue-500/10 text-blue-400",children:e.jsx(Zt,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:p.name}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-2 text-xs text-muted-foreground",children:[g>0&&e.jsxs("span",{children:[g.toLocaleString("fr-FR")," m"]}),g>0&&p.folder&&e.jsx("span",{"aria-hidden":"true",children:"·"}),p.folder&&e.jsx("span",{className:"truncate",children:p.folder})]})]})]},p.id)})})})]})})}const Ie=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],ds=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],de=6,cs=22,bt=cs-de,xe=40,Xe=bt*xe,Ze=Array.from({length:bt+1},(t,a)=>de+a);function Q(t){return t.slice(0,5)}function Me(){return new Date().toISOString().slice(0,10)}function Y(t){const[a,r]=t.split(":").map(Number);return a*60+r}function $e(t){return(Y(t)-de*60)/60*xe}function ms(t,a){return $e(a)-$e(t)}function et(t){const a=new Date(t),r=a.getDay(),o=r===0?-6:1-r;return a.setDate(a.getDate()+o),a.setHours(0,0,0,0),a}function us(t){const a=new Date(t);a.setHours(0,0,0,0),a.setDate(a.getDate()+3-(a.getDay()+6)%7);const r=new Date(a.getFullYear(),0,4);return 1+Math.round(((a.getTime()-r.getTime())/864e5-3+(r.getDay()+6)%7)/7)}function le(t){return t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function J(t){const a=r=>String(r).padStart(2,"0");return`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}`}function Ee(t){const a=t.toLowerCase();return a.includes("piscine")||a.includes("bassin")||!a.includes("salle")&&!a.includes("muscu")&&!a.includes("ppg")&&!a.includes("gym")}function tt(t,a,r){const o={slot:{trainingSlotId:t.slot.id,scheduledDate:t.date,startTime:t.slot.start_time,endTime:t.slot.end_time,location:t.slot.location}};return a==="edit"&&r!=null?{mode:a,swimCatalogId:r,...o}:{mode:"create",...o}}const xs=({open:t,onOpenChange:a,slot:r,groups:o,coaches:f})=>{const{toast:m}=Ae(),j=he(),u=!!r,[w,p]=l.useState("1"),[g,b]=l.useState(""),[k,M]=l.useState(""),[_,c]=l.useState(""),[N,v]=l.useState([]),[F,x]=l.useState(1),[D,S]=l.useState(!1);l.useEffect(()=>{if(t)if(r){p(String(r.day_of_week)),b(Q(r.start_time)),M(Q(r.end_time)),c(r.location);const i=r.assignments.map((d,R)=>({key:R,group_id:String(d.group_id),coach_id:String(d.coach_id),lane_count:d.lane_count!=null?String(d.lane_count):""}));v(i),x(i.length)}else p("1"),b(""),M(""),c(""),v([]),x(1)},[t,r]);const T=()=>{v(i=>[...i,{key:F,group_id:"",coach_id:"",lane_count:""}]),x(i=>i+1)},P=i=>{v(d=>d.filter(R=>R.key!==i))},y=(i,d,R)=>{v(E=>E.map(V=>V.key===i?{...V,[d]:R}:V))},B=()=>!g||!k?(m({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):_.trim()?{day_of_week:Number(w),start_time:g,end_time:k,location:_.trim(),assignments:N.filter(i=>i.group_id&&i.coach_id).map(i=>({group_id:Number(i.group_id),coach_id:Number(i.coach_id),lane_count:i.lane_count?Number(i.lane_count):null}))}:(m({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),z=X({mutationFn:i=>L.createTrainingSlot(i),onSuccess:()=>{m({title:"Creneau cree"}),j.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:i=>{m({title:"Erreur",description:i.message,variant:"destructive"})}}),$=X({mutationFn:i=>L.updateTrainingSlot(r.id,i),onSuccess:()=>{m({title:"Creneau mis a jour"}),j.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:i=>{m({title:"Erreur",description:i.message,variant:"destructive"})}}),I=X({mutationFn:()=>L.deleteTrainingSlot(r.id),onSuccess:()=>{m({title:"Creneau supprime"}),j.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:i=>{m({title:"Erreur",description:i.message,variant:"destructive"})}}),U=()=>{const i=B();i&&(u?$.mutate(i):z.mutate(i))},C=z.isPending||$.isPending||I.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(je,{children:u?"Modifier le creneau":"Nouveau creneau"}),e.jsx(ve,{children:u?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Jour de la semaine *"}),e.jsxs(ae,{value:w,onValueChange:p,children:[e.jsx(re,{children:e.jsx(ne,{})}),e.jsx(ie,{children:Ie.map((i,d)=>e.jsx(H,{value:String(d+1),children:i},d+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:g,onChange:i=>b(i.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:k,onChange:i=>M(i.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(oe,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:_,onChange:i=>c(i.target.value)})]}),e.jsx(Wt,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(A,{children:"Groupes & Coachs"}),e.jsxs(q,{type:"button",variant:"outline",size:"sm",onClick:T,children:[e.jsx(se,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),N.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),N.map(i=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(ae,{value:i.group_id,onValueChange:d=>y(i.key,"group_id",d),children:[e.jsx(re,{className:"h-8 text-xs",children:e.jsx(ne,{placeholder:"Groupe..."})}),e.jsx(ie,{children:o.map(d=>e.jsx(H,{value:String(d.id),children:d.name},d.id))})]}),e.jsxs(ae,{value:i.coach_id,onValueChange:d=>y(i.key,"coach_id",d),children:[e.jsx(re,{className:"h-8 text-xs",children:e.jsx(ne,{placeholder:"Coach..."})}),e.jsx(ie,{children:f.map(d=>e.jsx(H,{value:String(d.id),children:d.display_name},d.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{type:"number",min:0,placeholder:"Lignes d'eau",value:i.lane_count,onChange:d=>y(i.key,"lane_count",d.target.value),className:"h-8 text-xs flex-1"}),e.jsx(q,{type:"button",variant:"ghost",size:"icon",className:"h-10 w-10 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>P(i.key),children:e.jsx(pt,{className:"h-3.5 w-3.5"})})]})]})},i.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(q,{className:"w-full",onClick:U,disabled:C||!g||!k||!_.trim(),children:C?"Enregistrement...":u?"Enregistrer":"Creer"}),u&&e.jsx(q,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>S(!0),disabled:C,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(rt,{open:D,onOpenChange:S,children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(lt,{children:"Supprimer le creneau"}),e.jsx(ot,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(dt,{children:[e.jsx(ct,{children:"Annuler"}),e.jsx(mt,{onClick:()=>{I.mutate(),S(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},hs=({open:t,onOpenChange:a,slot:r})=>{const{toast:o}=Ae(),f=he(),[m,j]=l.useState(""),[u,w]=l.useState("cancelled"),[p,g]=l.useState(""),[b,k]=l.useState(""),[M,_]=l.useState(""),[c,N]=l.useState("");l.useEffect(()=>{t&&(j(""),w("cancelled"),g(r?Q(r.start_time):""),k(r?Q(r.end_time):""),_(r?.location??""),N(""))},[t,r]);const v=X({mutationFn:x=>L.createSlotOverride(x),onSuccess:()=>{o({title:"Exception enregistree"}),f.invalidateQueries({queryKey:["training-slot-overrides"]}),f.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:x=>{o({title:"Erreur",description:x.message,variant:"destructive"})}}),F=()=>{if(!r)return;if(!m){o({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const x={slot_id:r.id,override_date:m,status:u,new_start_time:u==="modified"&&p||null,new_end_time:u==="modified"&&b||null,new_location:u==="modified"&&M.trim()?M.trim():null,reason:c.trim()||null};v.mutate(x)};return e.jsx(ge,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(je,{children:"Exception"}),e.jsx(ve,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:m,onChange:x=>j(x.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Type"}),e.jsxs(Gt,{value:u,onValueChange:x=>w(x),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ge,{value:"cancelled",id:"ovr-cancelled"}),e.jsx(A,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ge,{value:"modified",id:"ovr-modified"}),e.jsx(A,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),u==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:p,onChange:x=>g(x.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:b,onChange:x=>k(x.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(oe,{id:"ovr-location",value:M,onChange:x=>_(x.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(oe,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:c,onChange:x=>N(x.target.value)})]}),e.jsx(q,{className:"w-full",onClick:F,disabled:v.isPending||!m,children:v.isPending?"Enregistrement...":"Enregistrer"})]})]})})};function jt(t){return t?t.state:"empty"}function vt({state:t,compact:a=!1}){const r={empty:{label:"À renseigner",shortLabel:"À faire",icon:Qe,className:"border-border/60 bg-background/80 text-muted-foreground"},draft:{label:"Brouillon",shortLabel:"Brouillon",icon:Qe,className:"border-amber-500/30 bg-amber-500/10 text-amber-700 dark:text-amber-300"},published:{label:"Renseignée",shortLabel:"OK",icon:Qt,className:"border-emerald-500/30 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300"},cancelled:{label:"Annulé",shortLabel:"Annulé",icon:ft,className:"border-border/60 bg-muted/60 text-muted-foreground"}},{icon:o,className:f,label:m,shortLabel:j}=r[t];return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-semibold leading-none ${f}`,title:m,"aria-label":m,children:[e.jsx(o,{className:"h-3 w-3 shrink-0"}),!a&&e.jsx("span",{children:j})]})}const ps=({slot:t,instance:a,hasOverrides:r,cancelled:o=!1,onSelect:f})=>{const m=$e(t.start_time),j=ms(t.start_time,t.end_time),u=j<50,w=Ee(t.location),p=jt(a),g=!!a?.assignment,b=a?.state==="draft",k=a?.state==="published",M=o?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":k?"bg-emerald-500/12 border-emerald-500/30 hover:bg-emerald-500/18":b?"bg-amber-500/12 border-amber-500/30 hover:bg-amber-500/18":w?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",_=k?"text-emerald-600 dark:text-emerald-400":b?"text-amber-600 dark:text-amber-400":w?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${M}`,style:{top:m,height:j,minHeight:24},onClick:()=>f(t),title:`${Q(t.start_time)}–${Q(t.end_time)} · ${t.location}${a?.assignment?.session_name?` · ${a.assignment.session_name}`:""}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${u?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx(Pe,{className:`h-2.5 w-2.5 shrink-0 ${_}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:t.location}),r&&!o&&e.jsx(at,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),e.jsx("span",{className:"shrink-0",children:e.jsx(vt,{state:p,compact:!0})})]}),!u&&t.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:t.assignments.map(c=>e.jsx(qe,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:c.group_name},c.id))}),!u&&j>=70&&t.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(t.assignments.map(c=>c.coach_name))].join(", ")}),!u&&g&&e.jsx("span",{className:`text-[9px] truncate ${b?"text-amber-700 dark:text-amber-300":"text-emerald-700 dark:text-emerald-300"}`,children:a?.assignment?.session_name??"Séance"})]})})};function gs(t,a){const r=Y(a)-Y(t),o=Math.floor(r/60),f=r%60;return o===0?`${f}min`:f===0?`${o}h`:`${o}h${String(f).padStart(2,"0")}`}const fs=({slotsByDay:t,slotInstancesById:a,weekDates:r,todayStr:o,overridesBySlot:f,cancelledSlotIds:m,onSelect:j,onPrevWeek:u,onNextWeek:w,weekNumber:p})=>{const[g,b]=l.useState(()=>{const c=r.findIndex(N=>J(N)===o);return c>=0?c+1:1});l.useEffect(()=>{const c=r.findIndex(N=>J(N)===o);c>=0?b(c+1):b(1)},[r,o]);const k=t.get(g)??[],M=l.useMemo(()=>{let c=22,N=6;return t.forEach(v=>{for(const F of v){const x=Math.floor(Y(F.start_time)/60),D=Math.ceil(Y(F.end_time)/60);x<c&&(c=x),D>N&&(N=D)}}),c>=N?{start:6,end:22}:{start:Math.max(0,c),end:Math.min(24,N)}},[t]),_=(M.end-M.start)*60;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:u,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",p]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[le(r[0])," – ",le(r[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:w,children:e.jsx(gt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border bg-card overflow-hidden",children:r.map((c,N)=>{const v=N+1,F=J(c)===o,x=v===g,D=t.get(v)??[];return e.jsxs("button",{type:"button",className:`flex flex-col items-center py-2 transition-colors relative ${x?"bg-primary/8":"hover:bg-muted/50 active:bg-muted"}`,onClick:()=>b(v),children:[e.jsx("span",{className:`text-[10px] font-semibold uppercase tracking-wider ${F?"text-primary":"text-muted-foreground"}`,children:ds[N]}),e.jsx("span",{className:`text-sm font-bold tabular-nums mt-0.5 h-10 w-10 flex items-center justify-center rounded-full ${F?"bg-primary text-primary-foreground":x?"text-foreground":"text-foreground/80"}`,children:c.getDate()}),e.jsx("div",{className:"w-full px-1 mt-1.5 h-8 relative",children:D.map(S=>{const T=Y(S.start_time)-M.start*60,P=Y(S.end_time)-M.start*60,y=Math.max(0,T/_*100),B=Math.max(8,(P-T)/_*100),z=Ee(S.location),$=m.has(S.id),I=a.get(S.id),U=I?.state==="published",C=I?.state==="draft";return e.jsx("div",{className:`absolute left-1 right-1 rounded-sm ${$?"bg-muted-foreground/20":U?"bg-emerald-500/50":C?"bg-amber-500/50":z?"bg-blue-500/40":"bg-amber-400/50"}`,style:{top:`${y}%`,height:`${B}%`,minHeight:"3px"}},S.id)})}),x&&e.jsx("div",{className:"absolute bottom-0 left-2 right-2 h-0.5 rounded-full bg-primary"})]},v)})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground px-0.5",children:[Ie[g-1]," ",r[g-1]?.getDate()," ",e.jsx("span",{className:"font-normal text-muted-foreground",children:r[g-1]?.toLocaleDateString("fr-FR",{month:"long"})})]}),k.length===0?e.jsx("div",{className:"rounded-xl border border-dashed border-border/60 bg-muted/20 py-8 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun créneau"})}):e.jsx("div",{className:"space-y-2",children:k.map(c=>{const N=Ee(c.location),v=m.has(c.id),F=f.get(c.id)??[],x=F.length>0,D=a.get(c.id),S=jt(D),T=D?.state==="published",P=D?.state==="draft";return e.jsx("button",{type:"button",className:`w-full text-left rounded-xl border bg-card transition-all active:scale-[0.98] ${v?"opacity-50 border-border":"border-border hover:border-border/80"}`,onClick:()=>j(c),children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`w-1 rounded-l-xl flex-shrink-0 ${v?"bg-muted-foreground/30":N?"bg-blue-500":"bg-amber-400"}`}),e.jsxs("div",{className:"flex-1 px-3 py-2.5 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsxs("span",{className:`text-sm font-bold tabular-nums ${v?"line-through text-muted-foreground":"text-foreground"}`,children:[Q(c.start_time)," – ",Q(c.end_time)]}),e.jsx("span",{className:`text-xs tabular-nums px-1.5 py-0.5 rounded-md font-medium ${N?"bg-blue-500/10 text-blue-600 dark:text-blue-400":"bg-amber-400/10 text-amber-600 dark:text-amber-400"}`,children:gs(c.start_time,c.end_time)})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(vt,{state:S}),x&&!v&&e.jsx(at,{className:"h-3.5 w-3.5 text-orange-500 flex-shrink-0"})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[e.jsx(Pe,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:c.location})]}),D?.assignment?.session_name&&e.jsxs("div",{className:"mt-1.5 flex items-center gap-1.5",children:[e.jsx("span",{className:`inline-flex rounded-md px-1.5 py-0.5 text-[10px] font-semibold ${P?"bg-amber-500/10 text-amber-700 dark:text-amber-300":T?"bg-emerald-500/10 text-emerald-700 dark:text-emerald-300":"bg-muted text-muted-foreground"}`,children:P?"Brouillon":"Publié"}),e.jsx("span",{className:"truncate text-xs font-medium text-foreground",children:D.assignment.session_name})]}),c.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1.5",children:c.assignments.map(y=>e.jsxs("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded-md bg-muted text-muted-foreground",children:[y.group_name,y.coach_name?` · ${y.coach_name.split(" ")[0]}`:"",y.lane_count?` · ${y.lane_count}L`:""]},y.id))}),x&&!v&&e.jsx("div",{className:"mt-1.5 space-y-0.5",children:F.slice(0,2).map(y=>e.jsxs("div",{className:"flex items-center gap-1 text-[10px]",children:[e.jsxs("span",{className:`font-medium ${y.status==="cancelled"?"text-red-500":"text-orange-500"}`,children:[y.status==="cancelled"?"Annulé":"Modifié"," le"," ",new Date(y.override_date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})]}),y.reason&&e.jsxs("span",{className:"text-muted-foreground truncate",children:["— ",y.reason]})]},y.id))})]})]})},c.id)})})]})]})},ra=({onBack:t,groups:a,onOpenLibrary:r})=>{const{toast:o}=Ae(),f=he(),{userId:m}=It(),[j,u]=l.useState(!1),[w,p]=l.useState(null),[g,b]=l.useState(null),[k,M]=l.useState(!1),[_,c]=l.useState(null),[N,v]=l.useState(!1),[F,x]=l.useState(!1),[D,S]=l.useState(null),[T,P]=l.useState(()=>et(new Date)),y=l.useMemo(()=>us(T),[T]),B=l.useMemo(()=>{const s=new Date(T);return s.setDate(s.getDate()+6),s},[T]),z=l.useMemo(()=>Array.from({length:7},(s,n)=>{const h=new Date(T);return h.setDate(h.getDate()+n),h}),[T]),$=()=>P(s=>{const n=new Date(s);return n.setDate(n.getDate()-7),n}),I=()=>P(s=>{const n=new Date(s);return n.setDate(n.getDate()+7),n}),U=()=>P(et(new Date)),[C,i]=l.useState("all"),{data:d=[],isLoading:R}=W({queryKey:["training-slots"],queryFn:()=>L.getTrainingSlots()}),{data:E=[]}=W({queryKey:["training-slot-overrides"],queryFn:()=>L.getSlotOverrides()}),{data:V=[]}=W({queryKey:["users","coaches"],queryFn:()=>L.listUsers({role:"coach"})}),{data:K=[]}=W({queryKey:["athletes"],queryFn:()=>L.getAthletes()}),O=C.startsWith("swimmer:")?Number(C.split(":")[1]):null,{data:ye}=W({queryKey:["swimmer-slots",O],queryFn:()=>L.getSwimmerSlots(O),enabled:O!=null}),{data:we}=W({queryKey:["swimmer-slots-exists",O],queryFn:()=>L.hasCustomSlots(O),enabled:O!=null}),Se=l.useMemo(()=>ye?ye.map(s=>({id:s.id,day_of_week:s.day_of_week,start_time:s.start_time,end_time:s.end_time,location:s.location,is_active:s.is_active,created_by:s.created_by,created_at:s.created_at,assignments:[]})):[],[ye]),ce=l.useMemo(()=>{if(C==="all")return d;if(C.startsWith("group:")){const s=Number(C.split(":")[1]);return d.filter(n=>n.assignments.some(h=>h.group_id===s))}if(C.startsWith("coach:")){const s=Number(C.split(":")[1]);return d.filter(n=>n.assignments.some(h=>h.coach_id===s))}if(C.startsWith("swimmer:")){if(we&&Se.length>0)return Se;const s=K.find(n=>n.id===O);return s?.group_id?d.filter(n=>n.assignments.some(h=>h.group_id===s.group_id)):d}return d},[d,C,we,Se,K,O]),Le=l.useMemo(()=>{const s=new Map;for(let n=1;n<=7;n++)s.set(n,[]);for(const n of ce)s.get(n.day_of_week).push(n);for(const n of s.values())n.sort((h,ee)=>h.start_time.localeCompare(ee.start_time));return s},[ce]),me=J(T),ue=J(B),{data:ze=[]}=W({queryKey:["slot-assignments",me,ue],queryFn:()=>L.getSlotAssignments({from:me,to:ue})}),Z=l.useMemo(()=>E.filter(s=>s.override_date>=me&&s.override_date<=ue),[E,me,ue]),Ve=l.useMemo(()=>{const s=new Map;for(const n of Z){const h=s.get(n.slot_id)??[];h.push(n),s.set(n.slot_id,h)}return s},[Z]),Re=l.useMemo(()=>{const s=new Set;for(const n of Z)n.status==="cancelled"&&s.add(n.slot_id);return s},[Z]),He=l.useMemo(()=>{const s=new Map;for(const n of ze){if(!n.training_slot_id)continue;const h=`${n.training_slot_id}:${n.scheduled_date}`;s.has(h)||s.set(h,n)}return s},[ze]),_e=l.useMemo(()=>{const s=new Map,n=Me();for(const h of ce){const ee=z[h.day_of_week-1];if(!ee)continue;const ke=J(ee),Be=Z.find(We=>We.slot_id===h.id&&We.override_date===ke),Ke=He.get(`${h.id}:${ke}`),Tt=Be?.status==="cancelled"?"cancelled":es(Ke,n);s.set(h.id,{date:ke,slot:h,groups:h.assignments,state:Tt,assignment:Ke,override:Be})}return s},[He,ce,z,Z]),Ce=()=>{p(null),u(!0)},Nt=s=>{c(s),v(!0)},Oe=s=>{const n=_e.get(s.id);n&&Nt(n)},yt=s=>{p(s.slot),u(!0)},wt=s=>{b(s.slot),M(!0)},St=s=>{r&&(v(!1),r(tt(s,"create")))},_t=s=>{if(r){if(v(!1),!_){r();return}r(tt(_,"edit",s))}},Ct=s=>{S(s),v(!1),x(!0)},kt=X({mutationFn:async({catalogId:s,instance:n})=>{const h=n.groups.map(ee=>ee.group_id);!m||h.length===0||await L.bulkCreateSlotAssignments({swimCatalogId:s,trainingSlotId:n.slot.id,scheduledDate:n.date,groupIds:h,scheduledSlot:At(n.slot.start_time),visibleFrom:n.date,assignedBy:m})},onSuccess:()=>{f.invalidateQueries({queryKey:["slot-assignments"]}),x(!1),S(null)},onError:s=>{o({title:"Erreur",description:s.message,variant:"destructive"})}}),Mt=s=>{D&&kt.mutate({catalogId:s,instance:D})},Dt=V.map(s=>({id:s.id,display_name:s.display_name})),Ft=d.length===0?"Planning hebdomadaire des entrainements.":`${d.length} creneau${d.length>1?"x":""}`;return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{variant:"ghost",size:"icon",className:"h-10 w-10 -ml-2",onClick:t,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),d.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[d.length," créneau",d.length>1?"x":""," actif",d.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full border border-border bg-card text-primary active:scale-90 transition-all",onClick:()=>r(),"aria-label":"Ouvrir la bibliothèque",children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:Ce,children:e.jsx(se,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(Lt,{title:"Creneaux",description:Ft,onBack:t,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsxs(q,{variant:"ghost",size:"sm",onClick:()=>r(),children:[e.jsx(Fe,{className:"mr-1.5 h-3.5 w-3.5"}),"Bibliothèque"]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:Ce,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})]})})}),!R&&d.length>0&&e.jsx("div",{className:"sm:hidden",children:e.jsxs(ae,{value:C,onValueChange:i,children:[e.jsx(re,{className:"w-full",children:e.jsx(ne,{placeholder:"Filtrer..."})}),e.jsxs(ie,{children:[e.jsx(H,{value:"all",children:"Tous les créneaux"}),e.jsx(te,{}),a.map(s=>e.jsx(H,{value:`group:${s.id}`,children:s.name},s.id)),K.length>0&&e.jsx(te,{}),K.map(s=>e.jsx(H,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(q,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:$,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:U,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",y]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[le(T)," – ",le(B)]})]}),e.jsx(q,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:I,children:e.jsx(gt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-row items-center gap-3",children:e.jsxs(ae,{value:C,onValueChange:i,children:[e.jsx(re,{className:"w-56",children:e.jsx(ne,{placeholder:"Filtrer..."})}),e.jsxs(ie,{children:[e.jsx(H,{value:"all",children:"Tous les créneaux"}),e.jsx(te,{}),a.map(s=>e.jsx(H,{value:`group:${s.id}`,children:s.name},s.id)),V.length>0&&e.jsx(te,{}),V.map(s=>e.jsx(H,{value:`coach:${s.id}`,children:s.display_name},s.id)),K.length>0&&e.jsx(te,{}),K.map(s=>e.jsx(H,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})})]}),R?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-28 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border overflow-hidden",children:Array.from({length:7},(s,n)=>e.jsxs("div",{className:"flex flex-col items-center py-2 gap-1",children:[e.jsx("div",{className:"h-3 w-6 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-5 rounded bg-muted/50 animate-pulse motion-reduce:animate-none mt-1"})]},n))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),Array.from({length:3},(s,n)=>e.jsx("div",{className:"h-20 rounded-xl bg-muted animate-pulse motion-reduce:animate-none"},n))]})]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(s,n)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},n))})]}):d.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(ut,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:Ce,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[O!=null&&we===!1&&e.jsx("div",{className:"rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/30 px-3 py-2 text-sm text-blue-700 dark:text-blue-300",children:"Ce nageur hérite des créneaux du groupe. Personnalisez depuis sa fiche."}),e.jsx("div",{className:"sm:hidden",children:e.jsx(fs,{slotsByDay:Le,slotInstancesById:_e,weekDates:z,todayStr:Me(),overridesBySlot:Ve,cancelledSlotIds:Re,onSelect:Oe,onPrevWeek:$,onNextWeek:I,weekNumber:y})}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",z.map((s,n)=>{const h=J(s)===Me();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:Ie[n]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${h?"text-primary font-bold":"text-muted-foreground/60"}`,children:le(s)})]},n)}),e.jsx("div",{className:"relative",style:{height:Xe},children:Ze.map(s=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(s-de)*xe},children:[s,"h"]},s))}),Array.from({length:7},(s,n)=>n+1).map(s=>{const n=Le.get(s)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:Xe},children:[Ze.map(h=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(h-de)*xe}},h)),n.map(h=>e.jsx(ps,{slot:h,instance:_e.get(h.id),hasOverrides:(Ve.get(h.id)??[]).length>0,cancelled:Re.has(h.id),onSelect:Oe},h.id))]},s)})]})})]}),e.jsx(ss,{instance:_,open:N,onOpenChange:v,onCreateNew:St,onEditSession:_t,onPickTemplate:Ct,onEditSlot:yt,onManageOverride:wt}),e.jsx(xs,{open:j,onOpenChange:u,slot:w,groups:a,coaches:Dt}),e.jsx(hs,{open:k,onOpenChange:M,slot:g}),e.jsx(os,{open:F,onOpenChange:x,onSelect:(s,n)=>Mt(s)})]})};export{ra as default};
