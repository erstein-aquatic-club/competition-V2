import{r as a,j as e}from"./vendor-query-DyA9aSKS.js";import{a as E}from"./api-DtJKJYEh.js";import{b as L,d as F,C as d,g as C,i as S,j as _,e as p,L as m,I as k,B as w}from"./index-BWLEYywn.js";import{T as I}from"./textarea-CCcFfB-j.js";import{S as $,a as A,b as B,c as V,d as c}from"./select-B3WbyVOX.js";import{C as D}from"./Coach-CrvKkkXe.js";import{B as H}from"./bell-ring-CXcPlAR2.js";import"./vendor-react-BzrpNAyj.js";import"./swim-D7dS4aWH.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./index-3CP1u4J-.js";import"./index-DYAPSAZw.js";import"./index-DCX2sNhR.js";import"./chevron-down-Df3Vhf7a.js";import"./chevron-up-DM-A--Kn.js";import"./arrow-left-CK1TSxXl.js";import"./search-0Mr_kV83.js";import"./trophy-B-F4wOVB.js";import"./chevron-right-YrjIFFUh.js";import"./zap-CZGH-TbR.js";import"./clock-CqdX3G8e.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["path",{d:"M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z",key:"117uat"}],["path",{d:"M6 12h16",key:"s4cdu5"}]],R=L("send-horizontal",O),pe=({onBack:M,athletes:r,groups:g,athletesLoading:T})=>{const{toast:n}=F(),[l,h]=a.useState(""),[x,j]=a.useState(""),[i,v]=a.useState(""),[f,b]=a.useState(!1),y=a.useMemo(()=>r.filter(t=>t.id!=null).map(t=>({value:`user:${t.id}`,label:t.group_label?`${t.display_name} · ${t.group_label}`:t.display_name})),[r]),N=a.useMemo(()=>g.map(t=>({value:`group:${t.id}`,label:t.name,id:t.id})),[g]),s=a.useMemo(()=>{if(!i)return{recipients:0,target:null};if(i.startsWith("user:")){const t=Number(i.split(":")[1]),u=r.find(o=>o.id===t);return u?.id?{recipients:1,target:{target_user_id:u.id,target_group_id:null}}:{recipients:0,target:null}}if(i.startsWith("group:")){const t=Number(i.split(":")[1]);return{recipients:r.filter(o=>o.group_id===t&&o.id!=null).length,target:{target_group_id:t,target_user_id:null}}}return{recipients:0,target:null}},[r,i]),z=async()=>{if(!s.target||s.recipients===0){n({title:"Aucun destinataire",description:"Choisissez un groupe ou un nageur avec au moins un compte actif.",variant:"destructive"});return}if(!l.trim()){n({title:"Titre requis",description:"Ajoutez un titre avant d'envoyer la notification.",variant:"destructive"});return}b(!0);try{const t=await E.notifications_send({title:l.trim(),body:x.trim()||null,type:"message",targets:[s.target]});n({title:"Notification envoyée",description:s.recipients===1?"Le nageur recevra la notification sur ses appareils abonnés.":`${s.recipients} nageurs ciblés recevront la notification sur leurs appareils abonnés.`}),h(""),j(""),v("")}catch(t){n({title:"Envoi impossible",description:t instanceof Error?t.message:"La notification n'a pas pu être envoyée.",variant:"destructive"})}finally{b(!1)}};return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(D,{title:"Envoyer un message",description:"Crée une notification push (FCM) pour un groupe ou un nageur.",onBack:M}),e.jsxs(d,{className:"border-l-4 border-l-primary",children:[e.jsxs(C,{children:[e.jsx(S,{children:"Destinataire"}),e.jsx(_,{children:"Sélectionnez un groupe complet ou un nageur individuel."})]}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Destinataire"}),e.jsxs($,{value:i,onValueChange:v,children:[e.jsx(A,{children:e.jsx(B,{placeholder:T?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(V,{children:[N.length?e.jsxs(e.Fragment,{children:[e.jsx(c,{value:"section-group",disabled:!0,children:"Groupes"}),N.map(t=>e.jsx(c,{value:t.value,children:t.label},t.value))]}):null,y.length?e.jsxs(e.Fragment,{children:[e.jsx(c,{value:"section-athlete",disabled:!0,children:"Nageurs"}),y.map(t=>e.jsx(c,{value:t.value,children:t.label},t.value))]}):null]})]})]}),i&&s.recipients>0?e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.recipients," nageur",s.recipients>1?"s":""," ciblé",s.recipients>1?"s":""]}):null,i&&s.recipients===0?e.jsx("p",{className:"text-xs text-destructive",children:"Aucun nageur actif n'est rattaché à cette sélection."}):null]})]}),e.jsxs(d,{children:[e.jsxs(C,{children:[e.jsx(S,{children:"Notification"}),e.jsx(_,{children:"Le titre apparaît dans la push, le message reste optionnel."})]}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"coach-message-title",children:"Titre"}),e.jsx(k,{id:"coach-message-title",value:l,onChange:t=>h(t.target.value),placeholder:"Ex. Changement d'horaire demain"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"coach-message-body",children:"Message"}),e.jsx(I,{id:"coach-message-body",value:x,onChange:t=>j(t.target.value),placeholder:"Ajoutez les détails à afficher dans la notification…",rows:4})]})]})]}),e.jsx(d,{className:"bg-muted/20",children:e.jsx(p,{className:"pt-6",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"L'envoi crée aussi une notification dans l'application. Les appareils avec les push activées la recevront immédiatement."})})}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsx(w,{className:"w-full sm:w-auto",onClick:z,disabled:!s.target||s.recipients===0||!l.trim()||f,children:f?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"mr-2 h-4 w-4"}),"Envoi..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Envoyer la notification"]})})})]})};export{pe as default};
