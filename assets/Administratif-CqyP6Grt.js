import{j as e,a as f,c as Mt,R as Tt,u as J,r as Te,d as H}from"./vendor-query-Dcze6zAc.js";import{c as at,a as kt,B as U,L as X,I as ee,d as St,u as ue,O as Dt,m as E,Q as Ct,V as Lt,Y as _t,Z as Et,h as At,$ as Ft}from"./index-HVj7Sga3.js";import{a as A}from"./api-BSxRcekn.js";import{T as It,a as Rt}from"./toggle-group-CUDRIbn3.js";import{C as ke}from"./checkbox-bWHS10Qe.js";import{S as $t,a as Pt,b as Ot,c as qt,d as Gt}from"./select-DusLvjgc.js";import{f as N,g as Q,c as Vt}from"./timesheetHelpers-D9RwANHz.js";import{t as Le,c as Qe,f as w}from"./format-B9mPVj_w.js";import{s as I}from"./swim-DntigO34.js";import{C as zt}from"./clock-DJUPw4Fo.js";import{M as Ye}from"./map-pin-7AdBQmLK.js";import{P as Kt}from"./plus-KRO_fjWF.js";import{T as Bt,P as Ht,a as Qt,B as Yt}from"./PieChart-4rhAhgC2.js";import{q as Wt,R as Ut,X as Xt,Y as Zt,T as Jt,B as We}from"./generateCategoricalChart-DACV3-ok.js";import{C as es}from"./CartesianGrid-BCxUvjms.js";import{s as ts}from"./subDays-BHZeCtPl.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-B1G9ca0o.js";import"./index-MOM2i9PG.js";import"./index-Cokk-ZbJ.js";import"./chevron-down-CVoiiV_C.js";import"./chevron-up-CEKBePU7.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=[["path",{d:"M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16",key:"jecpp"}],["rect",{width:"20",height:"14",x:"2",y:"6",rx:"2",key:"i6l2r4"}]],rs=at("briefcase",ss);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]],ns=at("car",as);function os(r,s){const n=Le(r);if(isNaN(s))return Qe(r,NaN);const o=n.getDate(),a=Qe(r,n.getTime());a.setMonth(n.getMonth()+s+1,0);const u=a.getDate();return o>=u?a:(n.setFullYear(a.getFullYear(),a.getMonth(),o),n)}function is(r){const s=Le(r),n=s.getMonth();return s.setFullYear(s.getFullYear(),n+1,0),s.setHours(23,59,59,999),s}function xe(r){const s=Le(r);return s.setDate(1),s.setHours(0,0,0,0),s}function ls(r,s){return os(r,-1)}function ds({children:r,className:s,top:n=!1,bottom:o=!1,left:a=!1,right:u=!1}){return e.jsx("div",{className:kt(s),style:{paddingTop:n?"env(safe-area-inset-top)":void 0,paddingBottom:o?"env(safe-area-inset-bottom)":void 0,paddingLeft:a?"env(safe-area-inset-left)":void 0,paddingRight:u?"env(safe-area-inset-right)":void 0},children:r})}const Z=r=>String(r).padStart(2,"0"),Ce=(r,s,n)=>Math.max(s,Math.min(n,r)),cs=(r,s)=>{const n=Math.round(r/s)*s;return Ce(n,0,60-s)},nt=(r,s=5)=>{const[n,o]=r.split(":"),a=Number(n),u=Number(o),g=Ce(Number.isFinite(a)?a:0,0,23),j=Ce(Number.isFinite(u)?u:0,0,59),x=cs(j,s);return`${Z(g)}:${Z(x)}`},us=(r,s)=>{const n=nt(r,s),[o,a]=n.split(":").map(u=>Number(u));return{hours:o,minutes:a}};function Ue({value:r,values:s,onChange:n,width:o=68,itemHeight:a=28,visibleCount:u=3,format:g,snapKey:j}){const x=f.useRef(null),v=Math.floor(u/2)*a,[T,L]=f.useState(r),M=f.useRef(r),k=f.useRef(r),h=f.useRef(null),m=f.useRef(null),b=f.useRef(!1);return f.useEffect(()=>{k.current=r,M.current=r,L(r);const p=x.current;if(!p||b.current)return;const D=Math.max(0,s.indexOf(r));p.scrollTo({top:D*a,behavior:"instant"})},[a,r,s]),f.useEffect(()=>{const p=x.current;if(!p)return;const D=Math.max(0,s.indexOf(r));p.scrollTo({top:D*a,behavior:"instant"})},[a,j,r,s]),f.useEffect(()=>{const p=x.current;if(!p)return;const D=()=>{const C=Math.round(p.scrollTop/a),F=s[Math.max(0,Math.min(s.length-1,C))];M.current=F,L(F)},z=()=>{const C=M.current;C!==k.current&&n(C),b.current=!1},O=()=>{b.current=!0,h.current&&cancelAnimationFrame(h.current),h.current=requestAnimationFrame(D),m.current&&window.clearTimeout(m.current),m.current=window.setTimeout(z,140)};return p.addEventListener("scroll",O,{passive:!0}),()=>{p.removeEventListener("scroll",O),h.current&&cancelAnimationFrame(h.current),m.current&&window.clearTimeout(m.current)}},[a,n,s]),e.jsx("div",{style:{width:o,minWidth:0,flex:`0 0 ${o}px`},children:e.jsxs("div",{className:"relative overflow-hidden rounded-xl border border-border bg-card",children:[e.jsx("div",{className:"pointer-events-none absolute left-0 right-0 top-0 z-[2]",style:{height:v,background:"linear-gradient(hsl(var(--background)), transparent)"}}),e.jsx("div",{className:"pointer-events-none absolute left-0 right-0 bottom-0 z-[2]",style:{height:v,background:"linear-gradient(transparent, hsl(var(--background)))"}}),e.jsx("div",{className:"pointer-events-none absolute left-1.5 right-1.5 z-[1] rounded-lg",style:{top:v,height:a,background:"rgba(17,17,17,0.14)",boxShadow:"inset 0 0 0 1px rgba(17,17,17,0.25)"}}),e.jsx("div",{ref:x,style:{height:a*u,overflowY:"auto",overflowX:"hidden",scrollSnapType:"y mandatory",scrollSnapStop:"always",WebkitOverflowScrolling:"touch",paddingTop:v,paddingBottom:v,touchAction:"pan-y",overscrollBehavior:"contain"},children:s.map(p=>{const D=p===T;return e.jsx("div",{className:`flex items-center justify-center text-[15px] font-bold ${D?"text-foreground":"text-muted-foreground"}`,style:{height:a,scrollSnapAlign:"center",fontWeight:D?900:700,userSelect:"none"},children:g?g(p):String(p)},p)})})]})})}function Xe({label:r,value:s,onChange:n,allowEmpty:o=!1,showEmptyButton:a=!0,snapKey:u}){const g=f.useMemo(()=>Array.from({length:24},(m,b)=>b),[]),j=f.useMemo(()=>Array.from({length:12},(m,b)=>b*5),[]),x=s||"00:00",v=f.useMemo(()=>us(x,5),[x]),[T,L]=f.useState(v.hours),[M,k]=f.useState(v.minutes);f.useEffect(()=>{L(v.hours),k(v.minutes)},[v.hours,v.minutes]),f.useEffect(()=>{if(!s)return;const m=nt(s,5),[b,p]=m.split(":");L(Number(b)),k(Number(p))},[s]);const h=f.useCallback((m,b)=>{n(`${Z(m)}:${Z(b)}`)},[n]);return e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-black text-foreground",children:r}),e.jsxs("div",{className:"flex flex-wrap items-end justify-center gap-2",children:[e.jsx(Ue,{value:T,values:g,onChange:m=>{L(m),h(m,M)},format:m=>Z(m),snapKey:u}),e.jsx(Ue,{value:M,values:j,onChange:m=>{k(m),h(T,m)},format:m=>Z(m),snapKey:u})]}),o&&a?e.jsx("button",{type:"button",onClick:()=>n(""),className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-foreground",children:"En cours"}):null]})}const pe=r=>String(r).padStart(2,"0"),Se=()=>{const r=new Date,s=Math.round(r.getMinutes()/5)*5,n=s===60?1:0,o=(r.getHours()+n)%24,a=s===60?0:s;return`${pe(o)}:${pe(a)}`},ms=(r,s)=>{const[n,o]=r.split(":").map(v=>Number(v)),a=Number.isFinite(n)?n:0,u=Number.isFinite(o)?o:0,g=(a*60+u+s+1440)%1440,j=Math.floor(g/60),x=g%60;return`${pe(j)}:${pe(x)}`};function xs({isOpen:r,isEditing:s,isSaving:n,date:o,startTime:a,endTime:u,location:g,isTravel:j,durationLabel:x,locations:v,onClose:T,onSubmit:L,onDateChange:M,onStartTimeChange:k,onEndTimeChange:h,onLocationChange:m,onTravelChange:b,onCreateLocation:p,onDeleteLocation:D,permanentGroups:z,customGroupLabels:O,selectedGroupNames:C,onGroupToggle:F,onCreateGroupLabel:K,onDeleteGroupLabel:he}){const te=f.useMemo(()=>r?Date.now():0,[r]),[se,fe]=f.useState(!1),[re,ae]=f.useState("");f.useEffect(()=>{if(!r||s||a)return;const i=Se();k(i),u||h(ms(i,60))},[u,s,r,h,k,a]);const[Y,ne]=f.useState(""),$=()=>{const i=Y.trim();i&&(K(i),ne(""))};return r?e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":s?"Modifier shift":"Nouveau shift",className:"fixed inset-0 z-modal flex items-end justify-center bg-black/35 px-3 pb-3",onClick:T,children:e.jsxs("div",{className:"w-full max-w-3xl overflow-hidden rounded-2xl bg-card shadow-[0_12px_40px_rgba(0,0,0,0.2)]",onClick:i=>i.stopPropagation(),children:[e.jsx("div",{className:"mx-auto mt-2 h-1.5 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"grid grid-cols-[1fr_auto] items-center gap-2 px-4 pb-2 pt-3 text-sm font-black",children:[e.jsx("div",{children:s?"Modifier shift":"Nouveau shift"}),e.jsx(U,{type:"button",variant:"outline",size:"sm",onClick:T,children:"Fermer"}),e.jsxs("div",{className:"col-span-2 text-center text-sm font-black text-card-foreground",children:[a||"—"," → ",u||"En cours",x?` • Durée ${x}`:null]})]}),e.jsxs("form",{onSubmit:L,className:"max-h-[72vh] space-y-4 overflow-y-auto px-4 pb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"shift-date",children:"Date"}),e.jsx(ee,{id:"shift-date",type:"date",value:o,onChange:i=>M(i.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(Xe,{label:"Heure d’arrivée",value:a,onChange:k,snapKey:te}),e.jsx("button",{type:"button","aria-label":"Heure d'arrivée maintenant",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>{const i=Se();k(i)},children:"Maintenant"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Xe,{label:"Heure de sortie",value:u,onChange:h,allowEmpty:!0,showEmptyButton:!1,snapKey:te}),e.jsx("button",{type:"button","aria-label":"Heure de sortie maintenant",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>{const i=Se();h(i)},children:"Maintenant"}),e.jsx("button",{type:"button","aria-label":"Marquer comme en cours",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>h(""),children:"En cours"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"shift-location",children:"Lieu"}),e.jsxs($t,{value:g||void 0,onValueChange:m,children:[e.jsx(Pt,{id:"shift-location",children:e.jsx(Ot,{placeholder:"Sélectionner un lieu"})}),e.jsx(qt,{children:v.map(i=>e.jsx(Gt,{value:i.name,children:i.name},i.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{children:"Groupes encadrés"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[z.map(i=>e.jsxs("label",{className:"flex items-center gap-1.5 rounded-full border border-border bg-muted/30 px-3 py-1.5 text-xs font-semibold cursor-pointer select-none",children:[e.jsx(ke,{checked:C.includes(i.name),onCheckedChange:()=>F(i.name)}),e.jsx("span",{children:i.name})]},`perm-${i.id}`)),O.map(i=>e.jsxs("label",{className:"flex items-center gap-1.5 rounded-full border border-border bg-muted/30 px-3 py-1.5 text-xs font-semibold cursor-pointer select-none",children:[e.jsx(ke,{checked:C.includes(i.name),onCheckedChange:()=>F(i.name)}),e.jsx("span",{children:i.name}),e.jsx("button",{type:"button",className:"ml-1 text-muted-foreground hover:text-foreground",onClick:q=>{q.preventDefault(),he(i.id)},"aria-label":`Supprimer ${i.name}`,children:"✕"})]},`custom-${i.id}`))]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{value:Y,onChange:i=>ne(i.target.value),placeholder:"Ajouter un groupe...",className:"h-8 flex-1 text-xs",onKeyDown:i=>{i.key==="Enter"&&(i.preventDefault(),$())}}),e.jsx(U,{type:"button",variant:"outline",size:"sm",className:"h-8 text-xs",onClick:$,disabled:!Y.trim(),children:"+"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{id:"shift-travel",checked:j,onCheckedChange:i=>b(i===!0)}),e.jsx(X,{htmlFor:"shift-travel",children:"Temps de trajet"})]}),e.jsxs("div",{className:"flex gap-3 border-t border-border pt-3",children:[e.jsx(U,{type:"button",variant:"outline",className:"flex-1",onClick:T,children:"Annuler"}),e.jsx(U,{type:"submit",className:"flex-1",disabled:n,children:s?"Enregistrer":"Ajouter"})]})]})]})}):null}const me=r=>{if(!r)return"—";const s=new Date(r);return Number.isNaN(s.getTime())?"—":w(s,"HH:mm")},ps=r=>{const s=new Date(r);return Number.isNaN(s.getTime())?r:new Intl.DateTimeFormat("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(s)};function hs({groups:r,onEdit:s,onDelete:n}){return e.jsx("div",{className:"rounded-2xl border border-border bg-card shadow-[0_1px_6px_rgba(0,0,0,0.04)]",children:r.length===0?e.jsx("div",{className:"px-4 py-4 text-sm text-muted-foreground",children:"Aucun shift pour l’instant."}):r.map(o=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 border-b border-border bg-muted px-3 py-2 text-xs font-black capitalize text-foreground",children:[e.jsx("span",{children:ps(o.date)}),e.jsx("span",{children:N(o.totalMinutes)})]}),e.jsx("div",{children:o.shifts.map(a=>{const u=Q(a),g=u===null;return e.jsxs("div",{className:"flex flex-wrap items-start gap-3 border-b border-border/50 px-3 py-3",children:[e.jsx("span",{className:a.is_travel?"rounded-full border border-border bg-status-warning-bg px-2 py-1 text-[11px] font-semibold text-foreground":"rounded-full border border-border bg-tag-swim-bg/10 px-2 py-1 text-[11px] font-semibold text-foreground",children:a.is_travel?"Trajet":"Travail"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-baseline justify-between gap-2",children:[e.jsxs("div",{className:"text-sm font-black text-foreground",children:[me(a.start_time)," → ",a.end_time?me(a.end_time):"En cours",u!==null?e.jsxs("span",{className:"ml-1 text-xs font-semibold text-muted-foreground",children:["(",N(u),")"]}):null]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[e.jsx("button",{type:"button",className:"rounded-lg border border-border bg-card px-3 py-2.5 text-xs font-bold text-foreground cursor-pointer min-h-[44px] min-w-[44px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",onClick:()=>s(a),"aria-label":`Modifier le shift ${me(a.start_time)}`,children:"Modifier"}),e.jsx("button",{type:"button",className:"rounded-lg border border-border bg-card px-3 py-2.5 text-xs font-bold text-foreground cursor-pointer min-h-[44px] min-w-[44px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",onClick:()=>n(a.id),"aria-label":`Supprimer le shift ${me(a.start_time)}`,children:"Suppr."})]})]}),e.jsx("div",{className:"mt-1 text-sm text-foreground",children:a.location||"Lieu non précisé"}),a.group_names&&a.group_names.length>0?e.jsx("div",{className:"mt-1 flex flex-wrap gap-1",children:a.group_names.map(j=>e.jsx("span",{className:"rounded-full bg-primary/10 px-2 py-0.5 text-[10px] font-semibold text-primary",children:j},j))}):null,g?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:"En cours"}):null]})]},a.id)})})]},o.date))})}const Ze="hsl(var(--primary))",Je="hsl(var(--chart-2))",De={"7d":"7 jours",month:"Ce mois",prevMonth:"Mois préc.",custom:"Dates"},et=r=>{if(!r)return"";if(/^\d{2}:\d{2}(:\d{2})?$/.test(r))return r.slice(0,5);const s=new Date(r);return Number.isNaN(s.getTime())?"":w(s,"HH:mm")},V=r=>r.shift_date,tt=(r,s,n)=>{const o=new Date(r).getTime(),a=new Date(s).getTime(),u=new Date(n).getTime();return o>=Math.min(a,u)&&o<=Math.max(a,u)},st=r=>r.find(s=>s.name==="Piscine")?.name??r[0]?.name??"Piscine",fs=(r,s=new Date)=>{switch(r){case"7d":return[w(ts(s,6),"yyyy-MM-dd"),w(s,"yyyy-MM-dd")];case"month":return[w(xe(s),"yyyy-MM-dd"),w(s,"yyyy-MM-dd")];case"prevMonth":{const n=ls(s);return[w(xe(n),"yyyy-MM-dd"),w(is(n),"yyyy-MM-dd")]}default:return[w(xe(s),"yyyy-MM-dd"),w(s,"yyyy-MM-dd")]}},rt={visible:{transition:{staggerChildren:.06}}},R={hidden:{opacity:0,y:14},visible:{opacity:1,y:0,transition:{duration:.28,ease:"easeOut"}}};function qs({initialTab:r="POINTAGE"}){const{useMemo:s,useState:n}=Tt,{toast:o}=St(),a=Mt(),u=typeof window>"u"?ue.getState().role:ue(t=>t.role),g=typeof window>"u"?ue.getState().userId:ue(t=>t.userId),j=u==="coach"||u==="admin",[x,v]=n(r),[T,L]=n(()=>w(new Date,"yyyy-MM-dd")),[M,k]=n(""),[h,m]=n(""),[b,p]=n("Piscine"),[D,z]=n(!1),[O,C]=n(!0),[F,K]=n(null),[he,te]=n(!1),[se,fe]=n(""),[re,ae]=n([]),[Y,ne]=n("month"),[$,i]=n(()=>w(xe(new Date),"yyyy-MM-dd")),[q,_e]=n(()=>w(new Date,"yyyy-MM-dd")),{data:_=[],error:Ee}=J({queryKey:["timesheet-shifts",g],queryFn:()=>A.listTimesheetShifts({coachId:g??void 0}),enabled:j}),{data:G=[],error:Ae}=J({queryKey:["timesheet-locations"],queryFn:()=>A.listTimesheetLocations(),enabled:j}),{data:ot=[]}=J({queryKey:["timesheet-permanent-groups"],queryFn:()=>A.listPermanentGroupsForTimesheet(),enabled:j}),{data:it=[]}=J({queryKey:["timesheet-group-labels"],queryFn:()=>A.listTimesheetGroupLabels(),enabled:j}),{data:Fe,error:Ie}=J({queryKey:["capabilities","timesheet"],queryFn:()=>A.getCapabilities(),enabled:Ft.hasSupabase}),oe=s(()=>st(G),[G]),be=Te.useCallback(()=>{L(w(new Date,"yyyy-MM-dd")),k(""),m(""),p(oe),z(!1),ae([])},[oe]),Re=H({mutationFn:t=>A.createTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]}),be(),o({title:"Shift enregistré"})},onError:t=>{o({title:"Erreur",description:I(t,"Impossible d'enregistrer le shift.").message})}}),$e=H({mutationFn:t=>A.updateTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]}),C(!1),K(null),be(),o({title:"Shift mis à jour"})},onError:t=>{o({title:"Erreur",description:I(t,"Impossible de modifier le shift.").message})}}),lt=H({mutationFn:t=>A.deleteTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]})},onError:t=>{o({title:"Erreur",description:I(t,"Impossible de supprimer le shift.").message})}}),ge=H({mutationFn:t=>A.createTimesheetLocation(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-locations"]})},onError:t=>{o({title:"Erreur",description:I(t,"Impossible d'ajouter le lieu.").message})}}),ve=H({mutationFn:t=>A.deleteTimesheetLocation(t),onSuccess:(t,d)=>{a.invalidateQueries({queryKey:["timesheet-locations"]});const l=G.filter(c=>c.id!==d.id);b&&l.every(c=>c.name!==b)&&p(st(l))},onError:t=>{o({title:"Erreur",description:I(t,"Impossible de supprimer le lieu.").message})}}),dt=H({mutationFn:t=>A.createTimesheetGroupLabel(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-group-labels"]})},onError:t=>{o({title:"Erreur",description:I(t,"Impossible d'ajouter le groupe.").message})}}),ct=H({mutationFn:t=>A.deleteTimesheetGroupLabel(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-group-labels"]})},onError:t=>{o({title:"Erreur",description:I(t,"Impossible de supprimer le groupe.").message})}}),ie=w(new Date,"yyyy-MM-dd"),ut=s(()=>_.reduce((t,d)=>{if(V(d)!==ie)return t;const l=Q(d);return l?t+l:t},0),[_,ie]),je=s(()=>_.filter(t=>V(t)===ie&&!t.end_time).length,[_,ie]),W=s(()=>Vt(_),[_]),mt=s(()=>{const t=[..._].sort((l,c)=>l.start_time<c.start_time?1:-1),d=new Map;return t.forEach(l=>{const c=V(l);d.has(c)||d.set(c,[]),d.get(c)?.push(l)}),Array.from(d.entries()).map(([l,c])=>{const S=c.reduce((de,Ne)=>{const we=Q(Ne);return we?de+we:de},0);return{date:l,shifts:c,totalMinutes:S}}).sort((l,c)=>l.date<c.date?1:-1)},[_]),P=s(()=>_.filter(t=>tt(V(t),$,q)),[_,$,q]),y=s(()=>P.reduce((t,d)=>{const l=Q(d)??0;return d.is_travel?t.travel+=l:t.work+=l,t.total+=l,t},{count:P.length,work:0,travel:0,total:0}),[P]),ye=s(()=>new Set(P.map(t=>V(t))).size,[P]),xt=ye>0?y.total/ye:0,B=s(()=>{const t=new Date($),l=new Date(q).getTime()-t.getTime(),c=new Date(t.getTime()-864e5),S=new Date(c.getTime()-l),de=w(S,"yyyy-MM-dd"),Ne=w(c,"yyyy-MM-dd"),ce=_.filter(Me=>tt(V(Me),de,Ne)).reduce((Me,wt)=>Me+(Q(wt)??0),0),He=y.total-ce,Nt=ce>0?Math.round(He/ce*100):0;return{prevTotal:ce,delta:He,percent:Nt}},[$,q,y.total,_]),Pe=B.prevTotal>0&&B.delta!==0,le=s(()=>[{name:"Travail",value:y.work,fill:Ze},{name:"Trajet",value:y.travel,fill:Je}].filter(t=>t.value>0),[y]),Oe=s(()=>{const t=new Map;return P.forEach(d=>{const l=V(d),c=Q(d)??0,S=t.get(l)??{work:0,travel:0};d.is_travel?S.travel+=c:S.work+=c,t.set(l,S)}),Array.from(t.entries()).map(([d,{work:l,travel:c}])=>({date:d,label:w(new Date(d),"dd/MM"),work:Number((l/60).toFixed(2)),travel:Number((c/60).toFixed(2))})).sort((d,l)=>d.date<l.date?-1:1)},[P]),qe=s(()=>{const t=new Map;P.forEach(c=>{const S=c.location||"Non précisé";t.set(S,(t.get(S)??0)+(Q(c)??0))});const d=Array.from(t.entries()).map(([c,S])=>({name:c,minutes:S})).sort((c,S)=>S.minutes-c.minutes),l=d[0]?.minutes??0;return d.map(c=>({...c,percent:l>0?c.minutes/l*100:0}))},[P]),Ge=new Intl.DateTimeFormat("fr-FR",{weekday:"short",day:"numeric",month:"short"}),pt=s(()=>{if(!M||!h)return null;const t=new Date(`${T}T${M}`),d=new Date(`${T}T${h}`);if(Number.isNaN(t.getTime())||Number.isNaN(d.getTime()))return null;const l=(d.getTime()-t.getTime())/6e4;return l>0?N(l):null},[T,M,h]),ht=Re.isPending||$e.isPending,Ve=ge.isPending||ve.isPending,ft=t=>{if(ne(t),t!=="custom"){const[d,l]=fs(t);i(d),_e(l)}},bt=t=>{if(t.preventDefault(),!T||!M){o({title:"Champs requis",description:"Date et heure de début obligatoires."});return}if(h&&h<=M){o({title:"Heures invalides",description:"La fin doit être après le début."});return}if(!g){o({title:"Utilisateur manquant"});return}F?$e.mutate({id:F,coach_id:g,shift_date:T,start_time:M,end_time:h||null,location:b.trim()||null,is_travel:D,group_names:re}):Re.mutate({coach_id:g,shift_date:T,start_time:M,end_time:h||null,location:b.trim()||null,is_travel:D,group_names:re})},gt=()=>{be(),K(null),C(!0)},vt=t=>{K(t.id),L(V(t)),k(et(t.start_time)),m(t.end_time?et(t.end_time):""),p(t.location??""),z(t.is_travel),ae(t.group_names??[]),C(!0)},jt=()=>{C(!1),K(null)},yt=()=>{const t=se.trim();t&&(ge.mutate({name:t}),fe(""))};if(Te.useEffect(()=>{x==="DASHBOARD"&&(C(!1),K(null))},[x]),Te.useEffect(()=>{!O||F||(!b||G.every(t=>t.name!==b))&&p(oe)},[oe,F,O,b,G]),!j)return typeof window>"u"?null:e.jsx(Dt,{to:"/"});const ze=Ie?I(Ie,"Impossible de vérifier le module de pointage.").message:Fe?.mode==="supabase"&&!Fe.timesheet.available?"Pointage heures indisponible (tables manquantes côté D1).":null,Ke=Ee?I(Ee,"Impossible de charger les shifts.").message:null,Be=Ae?I(Ae,"Impossible de charger les lieux.").message:null;return e.jsxs(ds,{top:!0,bottom:!0,className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"mx-auto flex w-full max-w-3xl flex-col gap-4 px-4 pt-4 text-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic",children:"Administratif"}),e.jsxs("div",{role:"tablist","aria-label":"Sections administratives",className:"flex items-center gap-1 rounded-full border border-border bg-card p-1 text-xs font-extrabold",children:[e.jsx("button",{role:"tab",type:"button","aria-selected":x==="POINTAGE","aria-controls":"tab-panel-pointage",id:"tab-pointage",className:`rounded-full px-3 py-2 transition-colors ${x==="POINTAGE"?"bg-primary text-primary-foreground":"text-foreground"}`,onClick:()=>v("POINTAGE"),children:"Pointage"}),e.jsx("button",{role:"tab",type:"button","aria-selected":x==="DASHBOARD","aria-controls":"tab-panel-dashboard",id:"tab-dashboard",className:`rounded-full px-3 py-2 transition-colors ${x==="DASHBOARD"?"bg-primary text-primary-foreground":"text-foreground"}`,onClick:()=>v("DASHBOARD"),children:"Dashboard"})]})]}),ze?e.jsx("div",{className:"rounded-xl border border-dashed border-border bg-card px-4 py-3 text-sm text-muted-foreground",children:ze}):null,Ke?e.jsx("div",{className:"rounded-xl border border-destructive/20 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:Ke}):null,Be?e.jsx("div",{className:"rounded-xl border border-destructive/20 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:Be}):null,x==="POINTAGE"?e.jsxs(E.div,{role:"tabpanel",id:"tab-panel-pointage","aria-labelledby":"tab-pointage",initial:"hidden",animate:"visible",variants:rt,className:"flex flex-col gap-4",children:[e.jsxs(E.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-[11px] text-muted-foreground",children:[e.jsx(zt,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Heures aujourd'hui"})]}),e.jsx("div",{className:"mt-1 text-3xl font-bold tabular-nums text-foreground",children:N(ut)}),je>0?e.jsxs("div",{className:"mt-1.5 flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-primary animate-pulse motion-reduce:animate-none"}),je," shift",je>1?"s":""," en cours"]}):null]}),e.jsxs(E.div,{variants:R,className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Semaine"}),e.jsx("div",{className:"text-lg font-bold tabular-nums",children:N(W.week.totalMinutes)}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[N(W.week.workMinutes)," trav. · ",N(W.week.travelMinutes)," trajet"]})]}),e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Mois"}),e.jsx("div",{className:"text-lg font-bold tabular-nums",children:N(W.month.totalMinutes)}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[N(W.month.workMinutes)," trav. · ",N(W.month.travelMinutes)," trajet"]})]})]}),e.jsxs(E.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-bold text-foreground",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Lieux"]}),e.jsx(U,{type:"button",variant:"outline",size:"sm",className:"h-8 text-xs",onClick:()=>te(t=>!t),children:"Gérer"})]}),he?e.jsxs("div",{className:"mt-3 space-y-3 text-sm text-muted-foreground",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:G.length?G.map(t=>e.jsxs("div",{className:"flex items-center gap-2 rounded-full border border-border bg-muted/30 px-3 py-1 text-xs font-semibold text-foreground",children:[e.jsx("span",{children:t.name}),e.jsx("button",{type:"button",className:"text-muted-foreground transition hover:text-foreground",onClick:()=>ve.mutate({id:t.id}),"aria-label":`Supprimer ${t.name}`,disabled:Ve,children:"✕"})]},t.id)):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Aucun lieu enregistré."})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(ee,{value:se,onChange:t=>fe(t.target.value),placeholder:"Nouveau lieu",className:"min-w-[160px] flex-1 h-9"}),e.jsx(U,{type:"button",size:"sm",className:"h-9",onClick:yt,disabled:!se.trim()||Ve,children:"Ajouter"})]})]}):null]}),e.jsx(E.div,{variants:R,children:e.jsx(hs,{groups:mt,onEdit:vt,onDelete:t=>lt.mutate({id:t})})}),e.jsx(Ct,{children:e.jsxs(Lt,{children:[e.jsx(_t,{asChild:!0,children:e.jsx("button",{type:"button",className:"fixed bottom-4 right-4 z-fab flex h-14 w-14 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-[0_8px_20px_-2px_hsl(var(--primary)/0.25)] hover:bg-primary/90 transition-colors",onClick:gt,"aria-label":"Nouveau shift",children:e.jsx(Kt,{className:"h-6 w-6"})})}),e.jsx(Et,{side:"left",children:"Nouveau shift"})]})})]},"pointage"):null,x==="DASHBOARD"?e.jsxs(E.div,{role:"tabpanel",id:"tab-panel-dashboard","aria-labelledby":"tab-dashboard",initial:"hidden",animate:"visible",variants:rt,className:"flex flex-col gap-4",children:[e.jsxs(E.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Période"}),e.jsx(It,{type:"single",size:"sm",variant:"outline",value:Y,onValueChange:t=>{t&&ft(t)},className:"flex flex-wrap gap-1",children:Object.keys(De).map(t=>e.jsx(Rt,{value:t,className:"h-8 px-3 text-xs","aria-label":De[t],children:De[t]},t))}),Y==="custom"?e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsxs("div",{className:"min-w-[140px] flex-1 space-y-1",children:[e.jsx(X,{htmlFor:"db-from",className:"text-[11px]",children:"Du"}),e.jsx(ee,{id:"db-from",type:"date",value:$,onChange:t=>i(t.target.value),className:"h-9 text-sm"})]}),e.jsxs("div",{className:"min-w-[140px] flex-1 space-y-1",children:[e.jsx(X,{htmlFor:"db-to",className:"text-[11px]",children:"Au"}),e.jsx(ee,{id:"db-to",type:"date",value:q,onChange:t=>_e(t.target.value),className:"h-9 text-sm"})]})]}):e.jsxs("div",{className:"mt-2 text-[11px] text-muted-foreground",children:[Ge.format(new Date($))," → ",Ge.format(new Date(q))]})]}),e.jsxs(E.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Total période"}),e.jsx("div",{className:"text-4xl font-bold tabular-nums",children:N(y.total)})]}),Pe?e.jsxs("div",{className:`flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-bold ${B.delta>0?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"}`,children:[B.delta>0?e.jsx(At,{className:"h-3 w-3"}):e.jsx(Bt,{className:"h-3 w-3"}),B.delta>0?"+":"",B.percent,"%"]}):null]}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[y.count," shift",y.count!==1?"s":"",ye>0?` · Moy. ${N(xt)}/jour`:"",Pe?` · vs ${N(B.prevTotal)} période préc.`:""]})]}),e.jsxs(E.div,{variants:R,className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[e.jsx(rs,{className:"h-3.5 w-3.5 text-primary"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Travail"})]}),e.jsx("div",{className:"text-xl font-bold tabular-nums",children:N(y.work)}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:y.total>0?`${Math.round(y.work/y.total*100)}%`:"–"})]}),e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[e.jsx(ns,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Trajet"})]}),e.jsx("div",{className:"text-xl font-bold tabular-nums",children:N(y.travel)}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:y.total>0?`${Math.round(y.travel/y.total*100)}%`:"–"})]})]}),le.length>0?e.jsxs(E.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Répartition"}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx(Ht,{width:140,height:140,children:e.jsx(Qt,{data:le,cx:70,cy:70,innerRadius:42,outerRadius:65,paddingAngle:3,dataKey:"value",strokeWidth:0,children:le.map(t=>e.jsx(Wt,{fill:t.fill},t.name))})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("span",{className:"text-sm font-bold tabular-nums",children:N(y.total)})})]}),e.jsx("div",{className:"flex-1 space-y-3",children:le.map(t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"h-3 w-3 rounded-sm shrink-0",style:{backgroundColor:t.fill}}),e.jsx("span",{className:"text-sm text-foreground",children:t.name}),e.jsx("span",{className:"ml-auto text-sm font-semibold tabular-nums",children:N(t.value)})]},t.name))})]})]}):null,e.jsxs(E.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Heures par jour"}),Oe.length>0?e.jsx("div",{className:"h-52 w-full",children:e.jsx(Ut,{width:"100%",height:"100%",children:e.jsxs(Yt,{data:Oe,margin:{top:4,right:8,left:-16,bottom:4},children:[e.jsx(es,{strokeDasharray:"3 3",vertical:!1,stroke:"hsl(var(--border))"}),e.jsx(Xt,{dataKey:"label",tickLine:!1,axisLine:!1,tick:{fontSize:11}}),e.jsx(Zt,{tickLine:!1,axisLine:!1,tick:{fontSize:11},tickFormatter:t=>`${t}h`}),e.jsx(Jt,{formatter:(t,d)=>[`${t.toFixed(1)}h`,d==="work"?"Travail":"Trajet"],labelFormatter:t=>`${t}`,contentStyle:{borderRadius:8,border:"1px solid hsl(var(--border))",fontSize:12}}),e.jsx(We,{dataKey:"work",name:"Travail",stackId:"hours",fill:Ze}),e.jsx(We,{dataKey:"travel",name:"Trajet",stackId:"hours",fill:Je,radius:[4,4,0,0]})]})})}):e.jsx("p",{className:"py-6 text-center text-sm text-muted-foreground",children:"Aucune donnée sur la période."})]}),qe.length>0?e.jsxs(E.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Top lieux"}),e.jsx("div",{className:"space-y-3",children:qe.map(t=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(Ye,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{children:t.name})]}),e.jsx("span",{className:"text-sm font-semibold tabular-nums",children:N(t.minutes)})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-2 rounded-full bg-primary transition-all duration-500",style:{width:`${t.percent}%`}})})]},t.name))})]}):null]},"dashboard"):null]}),x==="POINTAGE"?e.jsx(xs,{isOpen:O,isEditing:!!F,isSaving:ht,date:T,startTime:M,endTime:h,location:b,isTravel:D,durationLabel:pt,locations:G,onClose:jt,onSubmit:bt,onDateChange:L,onStartTimeChange:k,onEndTimeChange:m,onLocationChange:p,onTravelChange:z,onCreateLocation:t=>ge.mutate({name:t}),onDeleteLocation:t=>ve.mutate({id:t}),permanentGroups:ot,customGroupLabels:it,selectedGroupNames:re,onGroupToggle:t=>{ae(d=>d.includes(t)?d.filter(l=>l!==t):[...d,t])},onCreateGroupLabel:t=>dt.mutate({name:t}),onDeleteGroupLabel:t=>ct.mutate({id:t})}):null]})}export{qs as default};
