import{r as i,j as e,c as $t,R as Qe,u as De,d as Ae}from"./vendor-query-DyA9aSKS.js";import{b as Fe,a as yt,W as Nt,X as Tt,F as vt,P as jt,u as tt,d as Rt,s as ze,B as Ge}from"./index-CFo3nxON.js";import{c as Bt}from"./date-DrpgLmFD.js";import{a as Y}from"./api-jZZLSHUl.js";import{D as qt,a as Qt,b as zt,c as Jt}from"./dialog-Cknoa1sA.js";import{M as Ut,C as Yt,a as Ht}from"./CalendarGrid-BfdvoO4B.js";import{B as Vt}from"./BottomActionBar-C6UBQYbw.js";import{A as Wt,a as Xt,b as Gt,c as Zt,d as es,e as ts,f as ss,g as ns}from"./alert-dialog-Kv6iX2FG.js";import{a as rs,s as os,l as st}from"./animations-CrcLFysI.js";import{d as Je}from"./design-tokens-CKgCpdH6.js";import{C as wt}from"./chevron-right-hHPZpq7r.js";import{u as is,A as Ce,m as Z,a as as,b as nt}from"./vendor-motion-lao-Njgm.js";import{P as ls}from"./power-Caal60kl.js";import{C as rt}from"./chevron-down-pV_ENLwZ.js";import{C as ot}from"./check-D_reWJhC.js";import{C as Ue}from"./circle-D3Chobyv.js";import{T as cs}from"./trash-2-D74lE5rQ.js";import{I as ds}from"./InlineBanner-KE5G7HVN.js";import{C as us}from"./circle-alert-CFKJr0Bh.js";import{T as kt}from"./trophy-Cs-y5SE7.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-date-B8Mnp-Vt.js";import"./swim-DECbnTia.js";import"./index-DhFI-kXI.js";import"./index-DZkPJlDB.js";import"./chevron-left-C9DzI1Sm.js";import"./loader-circle-C7dOLexJ.js";import"./circle-check-CaPCuLsv.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=[["path",{d:"M5 12h14",key:"1ays0h"}]],St=Fe("minus",ms);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],fs=Fe("settings-2",xs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],bs=Fe("sun",ps);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],it=Fe("user-check",gs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Ie=Fe("user-x",hs),Ye={NL:"",DOS:"",BR:"",PAP:"",QN:""};function at(t){return String(t).padStart(2,"0")}function lt(t){return`${t.getFullYear()}-${at(t.getMonth()+1)}-${at(t.getDate())}`}function ct(t){return new Date(t.getFullYear(),t.getMonth(),1)}function dt(t,r){const o=new Date(t);return o.setDate(o.getDate()+r),o}function He(t){return(t.getDay()+6)%7}function Oe(t){const r=Number(t);return Number.isFinite(r)?Math.round(r/1e3*100)/100:0}function ys(t){const r=Number(t);return Number.isFinite(r)?Math.round(r*1e3):0}function Ns(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(o=>o.trim()).filter(Boolean).flatMap(o=>{const n=o.replace(/^[•\\-–—]\\s*/,"").trim();return n?[n]:[]}):[]}function vs(t){if(!t)return null;const o=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!o)return null;const n=Number(String(o[1]).replace(",","."));return Number.isFinite(n)?o[2].toLowerCase()==="m"?Oe(n):n:null}function js(t,r){const o=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,n=String(o||"").toLowerCase();if(n.includes("mat")||n.includes("morning")||n==="am")return"AM";if(n.includes("soir")||n.includes("evening")||n==="pm")return"PM";const p=`${t?.title??""} ${t?.description??""}`.toLowerCase();return p.includes("matin")||p.includes(" am ")||p.includes("(am)")?"AM":p.includes("soir")||p.includes(" pm ")||p.includes("(pm)")?"PM":r===0?"AM":"PM"}function ws(t){const r=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!r)return null;const o=String(r),n=o.length>=10?o.slice(0,10):o;return/\d{4}-\d{2}-\d{2}/.test(n)?n:null}function ks(t){if(Array.isArray(t?.items)){let p=0;for(const b of t.items){const k=Number(b?.distance);if(!Number.isFinite(k)||k<=0)continue;const u=b?.raw_payload,v=Number(u?.exercise_repetitions),F=Number(u?.block_repetitions),S=Number.isFinite(v)&&v>0?v:1,K=Number.isFinite(F)&&F>0?F:1;p+=k*S*K}if(p>0)return Oe(p)}const r=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(r!=null&&Number.isFinite(Number(r))){const p=Number(r);return p>0&&p<=50?p:Oe(p)}const o=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(o!=null&&Number.isFinite(Number(o)))return Number(o);const n=vs(`${t?.title??""} ${t?.description??""}`);return n??null}function Ss(t){if(!Array.isArray(t)||t.length===0)return null;const r={crawl:"NL",dos:"DOS",brasse:"BR",pap:"PAP","4n":"QN"},o={NL:0,DOS:0,BR:0,PAP:0,QN:0};for(const p of t){const b=Number(p?.distance);if(!Number.isFinite(b)||b<=0)continue;const k=p?.raw_payload,u=Number(k?.exercise_repetitions),v=Number(k?.block_repetitions),F=Number.isFinite(u)&&u>0?u:1,S=Number.isFinite(v)&&v>0?v:1,K=b*F*S,z=k?.exercise_stroke??k?.stroke??"crawl",E=r[String(z).toLowerCase()];E?o[E]+=K:o.NL+=K}return Object.values(o).some(p=>p>0)?o:null}function ut(t){const r=Number(t);if(!Number.isFinite(r))return"—";const o=Math.round(r*100)/100,n=String(o);return n.endsWith(".0")?n.slice(0,-2):n}function Ms(){const t={};for(let r=0;r<7;r++)t[r]={AM:!0,PM:!0};return t}function Ve(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function Ds({sessions:t,assignments:r,userId:o,user:n}){const p=`swim-dashboard-v2:${o??n??"anon"}`,b=`${p}:presenceDefaults`,k=`${p}:attendanceOverrides`,u=`${p}:stableFields`,[v,F]=i.useState(()=>Ms()),[S,K]=i.useState({}),[z,E]=i.useState(90);i.useEffect(()=>{if(typeof window>"u")return;const l=Ve(window.localStorage.getItem(b));l&&F(l);const d=Ve(window.localStorage.getItem(k));d&&K(d);const m=Ve(window.localStorage.getItem(u));m?.duration&&Number.isFinite(m.duration)&&m.duration>=30&&m.duration<=240&&E(m.duration)},[b,k,u]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(b,JSON.stringify(v))},[v,b]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(k,JSON.stringify(S))},[S,k]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(u,JSON.stringify({duration:z}))},[z,u]);const ue=i.useMemo(()=>new Date,[]),[me,ye]=i.useState(()=>ct(new Date)),[H,xe]=i.useState(()=>lt(new Date)),[ee,T]=i.useState(!1),[te,oe]=i.useState(!1),[Ne,ie]=i.useState(!1),[V,J]=i.useState(null),[fe,ce]=i.useState(!1),[ve,je]=i.useState(null),[pe,be]=i.useState(!1),[ge,W]=i.useTransition(),j=i.useMemo(()=>(Array.isArray(r)?r:[]).filter(d=>d?.session_type==="swim"),[r]),A=i.useMemo(()=>{const l=new Map;for(const d of j){const m=ws(d);m&&(l.has(m)||l.set(m,[]),l.get(m).push(d))}for(const[d,m]of l.entries())m.sort((x,f)=>Number(x?.id??0)-Number(f?.id??0)),l.set(d,m);return l},[j]),h=i.useMemo(()=>{const l=Array.isArray(t)?t:[],d={};for(const m of l){const x=String(m?.date??"").slice(0,10),f=m?.slot==="Soir"?"PM":"AM";d[`${x}__${f}`]=m}return d},[t]),P=i.useRef(new Map);i.useEffect(()=>{P.current.clear()},[A]);const w=i.useCallback(l=>{const d=P.current;if(d.has(l))return d.get(l);const m=[{id:`${l}__AM`,iso:l,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${l}__PM`,iso:l,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],x=(A.get(l)??[]).slice().sort((y,q)=>(Number(q.id)||0)-(Number(y.id)||0)),f=new Set;return x.forEach((y,q)=>{const D=y,X=js(D,q);if(f.has(X))return;const we=X==="AM"?0:1,de=ks(D),Q=Array.isArray(D?.details)?D.details.map(String):Ns(y?.description);m[we]={id:`${l}__${X}`,iso:l,slotKey:X,title:String(y?.title??"Séance coach"),km:de,details:Q,assignmentId:typeof y?.id=="number"?y.id:Number(y?.id)||void 0,isEmpty:!1},f.add(X)}),d.set(l,m),m},[A]),M=i.useCallback((l,d)=>{const m=He(d),x=!!v?.[m]?.[l.slotKey],f=S[l.id];return f==="present"?{status:"present",expected:!0,expectedByDefault:x}:f==="absent"?{status:"absent",expected:!0,expectedByDefault:x}:x?{status:"present",expected:!0,expectedByDefault:x}:{status:"not_expected",expected:!1,expectedByDefault:x}},[S,v]),L=i.useMemo(()=>ct(me),[me]),B=i.useMemo(()=>{const l=He(L),d=dt(L,-l),m=[];for(let x=0;x<42;x++)m.push(dt(d,x));return m},[L]),C=i.useMemo(()=>{const l={};for(const d of B){const m=lt(d),x=w(m);let f=0,y=0;const q=[];for(const D of x){const X=M(D,d);if(!X.expected){!!h[D.id]?(f+=1,y+=1,q.push({slotKey:D.slotKey,expected:!0,completed:!0,absent:!1})):q.push({slotKey:D.slotKey,expected:!1,completed:!1,absent:!1});continue}f+=1;const we=!!h[D.id],de=X.status==="absent";we&&(y+=1),q.push({slotKey:D.slotKey,expected:!0,completed:we,absent:de})}l[m]={completed:y,total:f,slots:q}}return l},[B,w,M,h]),N=i.useMemo(()=>{const[l,d,m]=H.split("-").map(Number);return new Date(l,d-1,m)},[H]),$=i.useMemo(()=>w(H),[w,H]),I=C[H]||{completed:0,total:2,slots:[{slotKey:"AM",expected:!0,completed:!1,absent:!1},{slotKey:"PM",expected:!0,completed:!1,absent:!1}]},U=i.useMemo(()=>{const l=Array.isArray(t)?t:[];let d=0;for(const m of l){const x=String(m?.date??"").slice(0,10),f=m?.slot==="Soir"?"PM":"AM",y=`${x}__${f}`;if(S[y]==="absent")continue;const q=He(new Date(x));(v?.[q]?.[f]||S[y]==="present")&&Number.isFinite(Number(m?.distance))&&(d+=Number(m.distance))}return ut(Oe(d))},[t,S,v]),se=i.useMemo(()=>{const l=$;let d=0;for(const m of l){const x=M(m,N);if(!x.expected||x.status==="absent")continue;const f=h[m.id];f&&Number.isFinite(Number(f?.distance))&&(d+=Number(f.distance))}return ut(Oe(d))},[$,M,N,h]),ke=i.useMemo(()=>V&&h[V]||null,[V,h]),ae=i.useMemo(()=>{const l=ke||{},d=l?.stroke_distances,m=d?{NL:d.NL?String(d.NL):"",DOS:d.DOS?String(d.DOS):"",BR:d.BR?String(d.BR):"",PAP:d.PAP?String(d.PAP):"",QN:d.QN?String(d.QN):""}:Ye;return{difficulty:l?.effort??null,fatigue_end:l?.fatigue??l?.feeling??null,performance:l?.performance??l?.feeling??null,engagement:l?.engagement??l?.feeling??null,comment:String(l?.comments??""),distanceMeters:Number.isFinite(Number(l?.distance))?Number(l.distance):null,showStrokeDetail:!!(d&&Object.values(d).some(x=>x&&x>0)),strokes:m,exerciseLogs:[]}},[ke]),[ne,re]=i.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:Ye,exerciseLogs:[]}));return i.useEffect(()=>{const l=$.find(d=>d.id===V);if(l){const d=l.km!=null?ys(l.km):5e3;let m=Ye;if(l.assignmentId){const f=(r??[]).find(y=>y.id===l.assignmentId);if(f?.items){const y=Ss(f.items);y&&(m={NL:String(y.NL||""),DOS:String(y.DOS||""),BR:String(y.BR||""),PAP:String(y.PAP||""),QN:String(y.QN||"")})}}const x=Object.values(ae.strokes).some(f=>f&&Number(f)>0);re(f=>({...f,...ae,distanceMeters:ae.distanceMeters==null?d:ae.distanceMeters,strokes:x?ae.strokes:m,showStrokeDetail:x||Object.values(m).some(y=>y&&Number(y)>0)}));return}re(d=>({...d,...ae}))},[ae,V,$,r]),i.useEffect(()=>{const l=()=>{T(!1),oe(!1),ie(!1),J(null),ce(!1),je(null)};return window.addEventListener("nav:reset",l),()=>window.removeEventListener("nav:reset",l)},[]),i.useEffect(()=>{ee&&pe&&I.total>0&&I.completed>=I.total&&(T(!1),J(null),ce(!1),be(!1))},[ee,pe,I.completed,I.total]),{today:ue,monthCursor:me,selectedISO:H,drawerOpen:ee,settingsOpen:te,infoOpen:Ne,activeSessionId:V,detailsOpen:fe,selectedDayIndex:ve,isPending:ge,presenceDefaults:v,attendanceOverrideBySessionId:S,stableDurationMin:z,draftState:ne,gridDates:B,completionByISO:C,selectedDate:N,sessionsForSelectedDay:$,selectedDayStatus:I,globalKm:U,dayKm:se,logsBySessionId:h,setMonthCursor:ye,setSelectedISO:xe,setDrawerOpen:T,setSettingsOpen:oe,setInfoOpen:ie,setActiveSessionId:J,setDetailsOpen:ce,setSelectedDayIndex:je,setPresenceDefaults:F,setAttendanceOverrideBySessionId:K,setStableDurationMin:E,setDraftState:re,setAutoCloseArmed:be,startTransition:W,getSessionStatus:M,getSessionsForISO:w}}function We(...t){return t.filter(Boolean).join(" ")}const mt={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function As({strokes:t,showStrokeDetail:r,disabled:o=!1,onToggle:n,onChange:p}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:o,onClick:n,className:We("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",o?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(wt,{className:We("h-4 w-4 transition-transform",r&&"rotate-90")})]}),r&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(mt).map(b=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:mt[b]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:o,value:t[b],onChange:k=>p({...t,[b]:k.target.value}),placeholder:"0",className:We("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",o?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},b))})]})}function O(...t){return t.filter(Boolean).join(" ")}function Cs(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function $e(t){const r=Number(t);if(!Number.isFinite(r))return"—";const o=Math.round(r*100)/100,n=String(o);return n.endsWith(".0")?n.slice(0,-2):n}function xt(t){const r=Number(t);return Number.isFinite(r)?Math.round(r/1e3*100)/100:0}function Os(t){const r=Number(t);return Number.isFinite(r)?Math.round(r*1e3):0}const Xe=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],Fs=[{key:"AM",label:"Matin",Icon:bs},{key:"PM",label:"Soir",Icon:Ut}];function Ke({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function Pe({onClick:t,label:r,children:o,tone:n="neutral",disabled:p}){const b={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:p,className:O("inline-flex items-center justify-center rounded-2xl border p-2 transition",b[n],p&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":r,title:r,children:[o,e.jsx("span",{className:"sr-only",children:r})]})}function _s(t,r){const o=Number(r);return!Number.isFinite(o)||o<1||o>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[o]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[o]}function Es({plannedMeters:t,valueMeters:r,onChange:o,disabled:n}){const u=Number.isFinite(Number(r))?Number(r):t,v=u-t,[F,S]=i.useState(!1),[K,z]=i.useState("");return e.jsxs("div",{className:O("mt-4 rounded-3xl border px-4 py-3",n?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:O("text-xs font-semibold",n?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),v!==0&&e.jsx("div",{className:O("text-xs font-semibold px-2 py-0.5 rounded-full",v>0?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"),children:v>0?`+${v}m`:`${v}m`})]}),e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:O("text-xs","text-muted-foreground"),children:["Planifié : ",t,"m (",$e(xt(t))," km)"]})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:n||u-100<0,onClick:()=>o(u-100),className:O("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",n?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"-100m",children:e.jsx(St,{className:"h-5 w-5"})}),e.jsx("div",{className:"min-w-[140px] text-center",children:F?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"number",step:100,min:0,max:3e4,autoFocus:!0,value:K,onChange:E=>z(E.target.value),onBlur:()=>{const E=Number(K);Number.isFinite(E)&&E>=0&&E<=3e4&&o(Math.round(E/100)*100),S(!1)},onKeyDown:E=>{E.key==="Enter"?E.target.blur():E.key==="Escape"&&S(!1)},className:"w-20 text-center text-lg font-bold bg-transparent border-b border-primary outline-none"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-0.5",children:"mètres"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",disabled:n,onClick:()=>{z(String(u)),S(!0)},className:O("text-2xl font-bold border-b border-dashed border-muted-foreground/40",n?"text-muted-foreground cursor-not-allowed":"text-foreground hover:border-primary cursor-text"),children:[u,"m"]}),e.jsxs("div",{className:O("text-sm font-medium mt-0.5",n?"text-muted-foreground":"text-primary"),children:[$e(xt(u))," km"]})]})}),e.jsx("button",{type:"button",disabled:n||u+100>3e4,onClick:()=>o(u+100),className:O("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",n?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"+100m",children:e.jsx(jt,{className:"h-5 w-5"})})]})]})}function Is({onMark:t}){const[r,o]=i.useState(!1),[n,p]=i.useState("");return r?e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",placeholder:"Motif (optionnel)",value:n,onChange:b=>p(b.target.value),className:"flex-1 rounded-md border border-input bg-transparent px-3 py-1.5 text-sm",autoFocus:!0}),e.jsx("button",{type:"button",onClick:()=>{t(n||void 0),o(!1),p("")},className:"rounded-md bg-primary px-3 py-1.5 text-sm font-medium text-primary-foreground",children:"OK"})]}):e.jsx("button",{type:"button",className:"w-full rounded-xl border border-dashed border-muted-foreground/30 p-2.5 mb-3 text-sm text-muted-foreground hover:bg-muted/50 transition-colors",onClick:()=>o(!0),children:"Marquer indisponible"})}function Ks({open:t,selectedDate:r,sessionsForSelectedDay:o,selectedDayStatus:n,dayKm:p,activeSessionId:b,detailsOpen:k,draftState:u,saveState:v,isPending:F,logsBySessionId:S,onClose:K,onDayOffAll:z,onOpenSession:E,onCloseSession:ue,onToggleDetails:me,onMarkAbsent:ye,onMarkPresent:H,onClearOverride:xe,onSaveFeedback:ee,onDraftStateChange:T,getSessionStatus:te,isAbsent:oe,absenceReason:Ne,onDeleteFeedback:ie,onMarkDayAbsent:V,onRemoveDayAbsence:J}){const fe=is(),[,ce]=yt(),[ve,je]=i.useState(!1),[pe,be]=i.useState(!1),[ge,W]=i.useState(null),j=i.useMemo(()=>b&&o.find(A=>A.id===b)||null,[b,o]);return i.useEffect(()=>{be(!1)},[b]),e.jsxs(Ce,{children:[t&&e.jsxs(e.Fragment,{children:[e.jsx(Z.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:K}),e.jsx(Z.div,{className:O("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:rs,initial:"hidden",animate:"visible",exit:"exit",drag:"y",dragControls:fe,dragListener:!1,dragConstraints:{top:0,bottom:0},dragElastic:{top:.05,bottom:.3},dragSnapToOrigin:!0,onDragEnd:(A,h)=>{(h.offset.y>100||h.velocity.y>500)&&K()},role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden touch-none",onPointerDown:A=>fe.start(A),children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-primary/15 bg-background px-4 sm:px-5 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground shrink-0",children:e.jsx(Nt,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-sm font-display font-bold uppercase italic tracking-tight text-primary",children:Cs(r)})})]}),e.jsx(Pe,{onClick:K,label:"Fermer",children:e.jsx(Tt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-lg font-bold text-foreground",children:[p," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:O("h-1.5 w-1.5 rounded-full",n.total>0&&n.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:O("h-1.5 w-1.5 rounded-full",n.total>0&&n.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})}),e.jsx(Pe,{onClick:z,label:"OFF (absent journée)",tone:"dark",disabled:F,children:e.jsx(ls,{className:"h-5 w-5"})})]}),j?null:e.jsx("div",{className:"mt-3 rounded-2xl border border-border bg-muted/20 px-3 py-2 text-xs text-muted-foreground",children:"Choisis un créneau pour saisir ton ressenti. Une fois ouvert, la saisie prend toute la place."}),!j&&V&&J&&(oe?e.jsxs("div",{className:"rounded-xl border border-muted bg-muted/30 p-3 mt-3 mb-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Marqué indisponible"}),e.jsx("button",{type:"button",onClick:J,className:"text-xs text-primary hover:underline",children:"Annuler"})]}),Ne&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:Ne})]}):e.jsx("div",{className:"mt-3",children:e.jsx(Is,{onMark:V})})),!j&&(()=>{const A=[],h=[];for(const w of o)te(w,r).status==="not_expected"?h.push(w):A.push(w);const P=w=>{const M=te(w,r),L=!!S[w.id],B=M.status==="absent",C=M.status==="not_expected",N=B||C,$=M.expected&&!L&&!B,I=L?"bg-status-success-bg border-status-success/30":N?"bg-sky-50 border-sky-200":$?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",U=Fs.find(se=>se.key===w.slotKey)?.Icon||Ue;return e.jsx("button",{type:"button",onClick:()=>E(w.id),className:O("w-full rounded-3xl border px-3 py-3 text-left transition",I,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:O("h-10 w-10 rounded-2xl border flex items-center justify-center",L?"border-status-success/30 bg-status-success-bg":N?"border-sky-200 bg-sky-100":$?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(U,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:w.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[w.isEmpty?e.jsx(Ke,{children:"Vide"}):e.jsxs(Ke,{children:[$e(w.km)," km"]}),L&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(ot,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),N&&!L&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),$&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[C&&e.jsx(Pe,{onClick:se=>{se.stopPropagation(),H(w.id)},label:"Je suis venu",disabled:F,children:e.jsx(it,{className:"h-5 w-5"})}),M.expected&&!L&&!B&&e.jsx(Pe,{onClick:se=>{se.stopPropagation(),ye(w.id)},label:"Absent",tone:"sky",disabled:F,children:e.jsx(Ie,{className:"h-5 w-5"})})]})]})},w.id)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4 grid gap-2",children:A.map(P)}),h.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",onClick:()=>je(w=>!w),className:"flex w-full items-center gap-2 rounded-2xl px-3 py-2 text-xs font-semibold text-muted-foreground hover:bg-muted transition",children:[e.jsx(rt,{className:O("h-4 w-4 transition-transform",ve&&"rotate-180")}),"Autres séances (",h.length,")"]}),e.jsx(Ce,{children:ve&&e.jsx(Z.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"mt-1 grid gap-2",children:h.map(P)})})})]})]})})(),e.jsx(Ce,{children:j&&e.jsx(Z.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:Je.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const A=te(j,r),h=A.status==="absent",P=A.status==="not_expected",w=!!S[j.id],M=A.expected&&!h,L=h?"Annuler":P?"Je suis venu":"Absent",B=h?()=>xe(j.id):P?()=>H(j.id):()=>ye(j.id),C=Os(j.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[10px] font-semibold uppercase tracking-[0.14em] text-muted-foreground",children:"Créneau sélectionné"}),e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:j.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[j.isEmpty?e.jsx(Ke,{children:"Vide"}):e.jsxs(Ke,{children:[$e(j.km)," km"]}),w?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(ot,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):h||P?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx("button",{type:"button",onClick:ue,className:"rounded-2xl border border-border bg-card px-3 py-2 text-xs font-semibold text-foreground hover:bg-muted",children:"Retour aux créneaux"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:B,className:O("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",P?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[P?e.jsx(it,{className:"h-4 w-4"}):e.jsx(Ie,{className:"h-4 w-4"}),L]}),e.jsxs("button",{type:"button",onClick:me,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(vt,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(Ce,{children:k&&e.jsx(Z.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:Je.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:e.jsx("button",{type:"button",onClick:()=>ce(j.assignmentId?`/swim-session?assignmentId=${j.assignmentId}`:"/swim-session"),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:j.assignmentId?"Ouvrir la fiche complète":"Saisir mes détails techniques"})})}),e.jsxs("div",{className:"px-4 pb-4",children:[!M&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:h?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(Z.div,{className:"space-y-4",variants:os,initial:"hidden",animate:"visible",children:[Xe.map(N=>{const $=u[N.key];return e.jsxs(Z.div,{className:"space-y-2",variants:st,children:[e.jsx("div",{className:O("text-sm font-semibold",M?"text-foreground":"text-muted-foreground"),children:N.label}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-14 text-right shrink-0 leading-tight",children:N.mode==="hard"?"Facile":"Mauvaise"}),e.jsx("div",{className:"flex gap-1.5 flex-1 justify-center",children:[1,2,3,4,5].map(I=>{const U=$===I;return e.jsx("button",{type:"button",disabled:!M,onClick:()=>T({...u,[N.key]:I}),className:O("h-11 w-11 rounded-2xl border text-sm font-semibold transition",M?U?_s(N.mode,I):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:I},I)})}),e.jsx("span",{className:"text-[10px] text-muted-foreground w-14 shrink-0 leading-tight",children:N.mode==="hard"?"Très dur":"Excellente"})]})]},N.key)}),e.jsxs(Z.div,{className:"space-y-2",variants:st,children:[e.jsx("div",{className:O("text-sm font-semibold",M?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:u.comment,onChange:N=>T({...u,comment:N.target.value}),disabled:!M,rows:3,placeholder:"Sensations, points techniques…",className:O("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",M?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-muted/20 overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>be(N=>!N),className:"flex w-full items-center justify-between gap-3 px-4 py-3 text-left",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Ajustements avancés"}),e.jsx("div",{className:"mt-0.5 text-xs text-muted-foreground",children:"Kilométrage, détail par nage et suppression du ressenti"})]}),e.jsx(rt,{className:O("h-4 w-4 shrink-0 text-muted-foreground transition-transform",pe&&"rotate-180")})]}),e.jsx(Ce,{initial:!1,children:pe?e.jsx(Z.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:Je.normal},className:"overflow-hidden border-t border-border",children:e.jsxs("div",{className:"px-3 pb-3",children:[e.jsx(Es,{plannedMeters:C,valueMeters:u.distanceMeters,onChange:N=>T({...u,distanceMeters:N}),disabled:!M}),e.jsx(As,{strokes:u.strokes,showStrokeDetail:u.showStrokeDetail,disabled:!M,onToggle:()=>T({...u,showStrokeDetail:!u.showStrokeDetail}),onChange:N=>T({...u,strokes:N})}),w&&ie?e.jsxs("button",{type:"button",onClick:()=>W(j.id),disabled:F,className:"mt-4 w-full rounded-2xl border border-destructive/30 bg-destructive/5 px-3 py-2.5 text-sm font-medium text-destructive hover:bg-destructive/10 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-2",children:[e.jsx(cs,{className:"h-4 w-4"}),"Supprimer le ressenti"]}):null]})}):null})]})]})]})})()},j.id)})]}),j&&(()=>{const A=te(j,r),h=A.expected&&A.status!=="absent";return e.jsxs(Vt,{saveState:v,position:"static",children:[e.jsx("button",{type:"button",onClick:ee,disabled:F||!h||!Xe.every(P=>Number.isInteger(u[P.key])),className:O("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",F||!h?"bg-muted text-muted-foreground cursor-not-allowed":Xe.every(P=>Number.isInteger(u[P.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["→"," km"]})]})})()]})})]}),ie&&e.jsx(Wt,{open:!!ge,onOpenChange:A=>{A||W(null)},children:e.jsxs(Xt,{children:[e.jsxs(Gt,{children:[e.jsx(Zt,{children:"Supprimer ce ressenti ?"}),e.jsx(es,{children:"Cette action est irréversible."})]}),e.jsxs(ts,{children:[e.jsx(ss,{children:"Annuler"}),e.jsx(ns,{onClick:()=>{ie(ge),W(null)},children:"Supprimer"})]})]})})]})}function Ps({onRefresh:t,children:r,pullThreshold:o=80}){const[n,p]=i.useState(!1),b=i.useRef(null),k=as(0),u=nt(k,[0,o],[0,1]),v=nt(k,[0,o],[.5,1]),F=async()=>{const S=k.get();if(!((b.current?.scrollTop??0)>5||S<o)){p(!0);try{await t()}finally{p(!1)}}};return e.jsxs("div",{ref:b,className:"relative",style:{overscrollBehaviorY:"contain"},children:[e.jsx(Z.div,{className:"pointer-events-none absolute left-1/2 top-0 z-10 flex -translate-x-1/2 items-center justify-center",style:{opacity:n?1:u,scale:n?1:v},children:e.jsx("div",{className:`mt-2 h-8 w-8 rounded-full border-2 border-primary border-t-transparent ${n?"animate-spin":""}`})}),e.jsx(Z.div,{drag:"y",dragConstraints:{top:0,bottom:0},dragElastic:{top:0,bottom:.4},dragSnapToOrigin:!0,style:{y:k},onDragEnd:F,dragListener:!n,children:r})]})}const Ls=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],ft=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],$s=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function pt(...t){return t.filter(Boolean).join(" ")}function bt(t){return String(t).padStart(2,"0")}function Le(t){return`${t.getFullYear()}-${bt(t.getMonth()+1)}-${bt(t.getDate())}`}function Ts(t){return new Date(t.getFullYear(),t.getMonth(),1)}function Rs(t){const r=String(t).split("__");return{iso:r[0],slotKey:r[1]||""}}function gt(t,r){return Number.isFinite(t)?Math.round(t/r)*r:0}function ht({globalKm:t,onSettings:r,onRecords:o}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(Nt,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Accueil"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"hidden sm:inline text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[t," km"]}),e.jsxs(Ge,{type:"button",variant:"outline",size:"sm",onClick:o,className:"h-8 rounded-xl border-primary/20 bg-primary/5 px-2.5 text-xs font-semibold text-primary hover:bg-primary/10","aria-label":"Mes records",children:[e.jsx(kt,{className:"mr-1 h-3.5 w-3.5"}),"Records"]}),e.jsxs(Ge,{type:"button",variant:"outline",size:"sm",onClick:r,className:"h-8 rounded-xl border-primary/20 bg-primary/5 px-2.5 text-xs font-semibold text-primary hover:bg-primary/10","aria-label":"Présence hebdo",children:[e.jsx(fs,{className:"mr-1 h-3.5 w-3.5"}),"Hebdo"]})]})]})}function hn(){const t=tt(s=>s.user),r=tt(s=>s.userId),{toast:o}=Rt(),n=$t(),p=i.useCallback(async()=>{await n.invalidateQueries({queryKey:["sessions"]}),await n.invalidateQueries({queryKey:["assignments"]}),await n.invalidateQueries({queryKey:["competitions"]}),await n.invalidateQueries({queryKey:["absences"]})},[n]),[,b]=yt(),[k,u]=Qe.useState("idle"),[v,F]=Qe.useState(null);Qe.useEffect(()=>{ze.auth.getSession().then(({data:s})=>{F(s.session?.user?.id??null)})},[t]);const{data:S,isLoading:K,error:z,refetch:E}=De({queryKey:["sessions",r??t],queryFn:()=>Y.getSessions(t,r),enabled:!!t}),{data:ue,isLoading:me,error:ye,refetch:H}=De({queryKey:["assignments",t],queryFn:()=>Y.getAssignments(t,r),enabled:!!t}),{data:xe=[]}=De({queryKey:["competitions"],queryFn:()=>Y.getCompetitions()}),{data:ee}=De({queryKey:["my-competition-ids"],queryFn:()=>Y.getMyCompetitionIds()}),T=i.useMemo(()=>!ee||ee.length===0?xe:xe.filter(s=>ee.includes(s.id)),[xe,ee]),{data:te=[]}=De({queryKey:["my-planned-absences"],queryFn:()=>Y.getMyPlannedAbsences()}),oe=i.useMemo(()=>new Set(te.map(s=>s.date)),[te]),Ne=K||me,ie=z||ye,V=()=>{E(),H()},J=Ae({mutationFn:s=>Y.deleteSession(s),onMutate:()=>{u("saving")},onSuccess:()=>{n.invalidateQueries({queryKey:["sessions"]}),n.invalidateQueries({queryKey:["hall-of-fame"]}),o({title:"Séance supprimée",description:"La saisie a été supprimée."}),u("saved"),setTimeout(()=>u("idle"),2e3)},onError:()=>{o({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),u("error"),setTimeout(()=>u("idle"),3e3)}}),fe=Ae({mutationFn:async s=>{const{_exerciseLogs:a,...c}=s,g=await Y.syncSession({...c,athlete_name:t,athlete_id:r??void 0});if(a&&a.length>0&&g.sessionId)try{const{data:_}=await ze.auth.getSession(),R=_.session?.user?.id;R&&await Y.saveSwimExerciseLogs(g.sessionId,R,a)}catch(_){console.warn("[EAC] Failed to save exercise logs:",_)}return g},onMutate:()=>{u("saving")},onSuccess:()=>{n.invalidateQueries({queryKey:["sessions"]}),n.invalidateQueries({queryKey:["assignments"]}),n.invalidateQueries({queryKey:["hall-of-fame"]}),o({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),u("saved"),setTimeout(()=>u("idle"),2e3)},onError:()=>{o({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),u("error"),setTimeout(()=>u("idle"),3e3)}}),ce=Ae({mutationFn:async s=>{const{_exerciseLogs:a,...c}=s,g=await Y.updateSession(c);if(a&&c.id)try{const{data:_}=await ze.auth.getSession(),R=_.session?.user?.id;R&&await Y.saveSwimExerciseLogs(c.id,R,a)}catch(_){throw console.error("[EAC] Failed to save exercise logs:",_),_}return g},onMutate:()=>{u("saving")},onSuccess:()=>{n.invalidateQueries({queryKey:["sessions"]}),n.invalidateQueries({queryKey:["hall-of-fame"]}),o({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),u("saved"),setTimeout(()=>u("idle"),2e3)},onError:()=>{o({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),u("error"),setTimeout(()=>u("idle"),3e3)}}),ve=Ae({mutationFn:({date:s,reason:a})=>Y.setPlannedAbsence(s,a),onMutate:async({date:s,reason:a})=>{await n.cancelQueries({queryKey:["my-planned-absences"]});const c=n.getQueryData(["my-planned-absences"]);return n.setQueryData(["my-planned-absences"],g=>[...g??[],{date:s,reason:a??null}]),{previous:c}},onSuccess:()=>{n.invalidateQueries({queryKey:["my-planned-absences"]}),o({title:"Jour marqué indisponible"})},onError:(s,a,c)=>{c?.previous&&n.setQueryData(["my-planned-absences"],c.previous),o({title:"Erreur",description:"Impossible de marquer ce jour indisponible.",variant:"destructive"})}}),je=Ae({mutationFn:s=>Y.removePlannedAbsence(s),onMutate:async s=>{await n.cancelQueries({queryKey:["my-planned-absences"]});const a=n.getQueryData(["my-planned-absences"]);return n.setQueryData(["my-planned-absences"],c=>(c??[]).filter(g=>g.date!==s)),{previous:a}},onSuccess:()=>{n.invalidateQueries({queryKey:["my-planned-absences"]}),o({title:"Disponibilité restaurée"})},onError:(s,a,c)=>{c?.previous&&n.setQueryData(["my-planned-absences"],c.previous),o({title:"Erreur",description:"Impossible de restaurer la disponibilité.",variant:"destructive"})}}),pe=Ds({sessions:S,assignments:ue,userId:r,user:t}),{today:be,monthCursor:ge,selectedISO:W,drawerOpen:j,settingsOpen:A,activeSessionId:h,detailsOpen:P,selectedDayIndex:w,isPending:M,presenceDefaults:L,stableDurationMin:B,draftState:C,gridDates:N,completionByISO:$,selectedDate:I,sessionsForSelectedDay:U,selectedDayStatus:se,globalKm:ke,dayKm:ae,logsBySessionId:ne,setMonthCursor:re,setSelectedISO:l,setDrawerOpen:d,setSettingsOpen:m,setActiveSessionId:x,setDetailsOpen:f,setSelectedDayIndex:y,setPresenceDefaults:q,setAttendanceOverrideBySessionId:D,setStableDurationMin:X,setDraftState:we,setAutoCloseArmed:de,startTransition:Q,getSessionStatus:Te}=pe,{competitionDates:Mt,competitionByDate:Ze}=i.useMemo(()=>{const s=new Set,a=new Map;for(const c of T){if(!c.date)continue;const g=c.date.slice(0,10),_=c.end_date?c.end_date.slice(0,10):g;let R=g;for(;R<=_;){s.add(R),a.has(R)||a.set(R,c.id);const le=new Date(R+"T00:00:00");le.setDate(le.getDate()+1);const Ee=le.getFullYear(),Me=String(le.getMonth()+1).padStart(2,"0"),he=String(le.getDate()).padStart(2,"0");R=`${Ee}-${Me}-${he}`}}return{competitionDates:s,competitionByDate:a}},[T]),G=i.useMemo(()=>{const s=Le(new Date);return T.filter(c=>c.date&&c.date.slice(0,10)>=s).sort((c,g)=>c.date.localeCompare(g.date))[0]??null},[T]),Re=i.useMemo(()=>{if(!G)return null;const s=new Date;s.setHours(0,0,0,0);const a=new Date(G.date.slice(0,10)+"T00:00:00");return Math.round((a.getTime()-s.getTime())/(1e3*60*60*24))},[G]),_e=i.useMemo(()=>G?Bt({compDate:G.date.slice(0,10),assignments:ue,absenceDates:oe,presenceDefaults:L}):null,[G,ue,oe,L]),Se=i.useCallback(s=>{const a=Ze.get(s);if(a){b(`/competition/${a}`);return}l(s),d(!0),x(null),f(!1);const c=$[s]||{completed:0,total:2};de(c.total>0&&c.completed<c.total)},[Ze,b,$,l,d,x,f,de]),Be=i.useCallback(()=>{d(!1),x(null),f(!1),de(!1),y(null)},[d,x,f,de,y]),Dt=i.useCallback(()=>{re(s=>new Date(s.getFullYear(),s.getMonth()-1,1))},[re]),At=i.useCallback(()=>{re(s=>new Date(s.getFullYear(),s.getMonth()+1,1))},[re]),Ct=i.useCallback(()=>{const s=new Date;re(Ts(s)),Se(Le(s))},[Se,re]),qe=i.useCallback(s=>{x(s),f(!1)},[x,f]),Ot=i.useCallback(s=>{Q(()=>{D(c=>({...c,[s]:"absent"}))});const a=ne[s];a?.id&&J.mutate(Number(a.id))},[J,ne,Q,D]),Ft=i.useCallback(s=>{Q(()=>{D(a=>({...a,[s]:"present"}))})},[Q,D]),_t=i.useCallback(s=>{Q(()=>{D(a=>{const c={...a};return delete c[s],c})})},[Q,D]),Et=i.useCallback(()=>{const s=U.map(a=>Te(a,I).expected?a.id:null).filter(Boolean);s.length!==0&&(Q(()=>{D(a=>{const c={...a};for(const g of s)c[g]="absent";return c}),x(null),f(!1)}),s.forEach(a=>{const c=ne[a];c?.id&&J.mutate(Number(c.id))}))},[U,Te,I,Q,ne,J,D,x,f]),It=i.useCallback(()=>{if(!h||!t||!$s.every(he=>Number.isInteger(C[he.key])))return;const{iso:a,slotKey:c}=Rs(h),g=c==="PM"?"Soir":"Matin",_=gt(Number(C.distanceMeters??0),100),R=gt(Number(B),15),le={};for(const[he,Lt]of Object.entries(C.strokes)){const et=Number(Lt);et>0&&(le[he]=et)}const Ee={date:a,slot:g,distance:_,duration:R,effort:Number(C.difficulty),feeling:Number(C.fatigue_end),performance:Number(C.performance),engagement:Number(C.engagement),comments:String(C.comment||"").slice(0,400),athlete_name:t,athlete_id:r??void 0,stroke_distances:Object.keys(le).length>0?le:null},Me=ne[h];Q(()=>{D(he=>({...he,[h]:"present"}))}),Me?.id?ce.mutate({...Ee,id:Me.id,created_at:Me.created_at??new Date().toISOString(),_exerciseLogs:C.exerciseLogs.length>0?C.exerciseLogs:[]}):fe.mutate({...Ee,_exerciseLogs:C.exerciseLogs.length>0?C.exerciseLogs:void 0}),x(null),f(!1)},[h,t,r,C,B,ne,Q,ce,fe,D,x,f]),Kt=i.useCallback((s,a)=>{q(c=>({...c,[s]:{...c[s],[a]:!c[s][a]}}))},[q]);i.useEffect(()=>{if(!j)return;const s=a=>{const c=a.target?.tagName;if(!(c==="INPUT"||c==="TEXTAREA"||a.target?.isContentEditable)){if(a.key==="Escape"){a.preventDefault(),Be();return}(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),U.length>0&&!h&&qe(U[0].id))}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[j,Be,U,h,qe]);const Pt=i.useCallback((s,a)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(s.key))return;if(s.preventDefault(),s.key==="Enter"||s.key===" "){const _=Le(N[a]);Se(_);return}let g=a;s.key==="ArrowLeft"&&(g=Math.max(0,a-1)),s.key==="ArrowRight"&&(g=Math.min(N.length-1,a+1)),s.key==="ArrowUp"&&(g=Math.max(0,a-7)),s.key==="ArrowDown"&&(g=Math.min(N.length-1,a+7)),y(g),l(Le(N[g])),setTimeout(()=>{const _=document.querySelectorAll('[data-calendar-cell="true"]');_[g]&&_[g].focus()},0)},[N,Se,y,l]);return Ne?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"h-7 w-7 rounded-lg bg-primary/20 animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-14 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((s,a)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${a}`)),Array.from({length:35}).map((s,a)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${a}`))]})})]})})]}):ie?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(us,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:ie.message}),e.jsx(Ge,{onClick:()=>V(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsx("div",{className:"px-4 py-2.5 flex items-center justify-between",children:e.jsx(ht,{globalKm:ke,onSettings:()=>m(!0),onRecords:()=>b("/records")})})}),e.jsx(Ps,{onRefresh:p,children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-14 pb-5 sm:py-8",children:[e.jsx("div",{className:"hidden sm:flex items-center justify-between",children:e.jsx(ht,{globalKm:ke,onSettings:()=>m(!0),onRecords:()=>b("/records")})}),e.jsx(ds,{variant:"amber",icon:e.jsx(kt,{}),label:G?.name,badge:Re===0?"Aujourd'hui":`J-${Re}`,sublabel:G?.location,subbadge:_e!=null&&_e>0?`${_e} séance${_e>1?"s":""}`:void 0,visible:!!G&&Re!=null,onClick:G?()=>b(`/competition/${G.id}`):void 0,className:"mt-2"}),e.jsxs("div",{className:"mt-3 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(Yt,{monthCursor:ge,selectedDayStatus:se,onPrevMonth:Dt,onNextMonth:At,onJumpToday:Ct}),e.jsx(Ht,{monthCursor:ge,gridDates:N,completionByISO:$,competitionDates:Mt,absenceDates:oe,selectedISO:W,selectedDayIndex:w,today:be,onDayClick:Se,onKeyDown:Pt})]}),v&&e.jsx("div",{className:"mt-6",children:e.jsxs("button",{type:"button",onClick:()=>b("/swim-notes"),className:"flex w-full items-center justify-between rounded-2xl border border-dashed border-border/80 bg-background px-3 py-2.5 text-left transition hover:bg-muted/40",children:[e.jsxs("span",{className:"flex min-w-0 items-center gap-2",children:[e.jsx("span",{className:"flex h-8 w-8 shrink-0 items-center justify-center rounded-xl bg-muted text-muted-foreground",children:e.jsx(vt,{className:"h-4 w-4"})}),e.jsxs("span",{className:"min-w-0",children:[e.jsx("span",{className:"block truncate text-sm font-semibold text-foreground",children:"Notes techniques"}),e.jsx("span",{className:"block truncate text-[11px] text-muted-foreground",children:"Repères détaillés par exercice"})]})]}),e.jsx(wt,{className:"h-4 w-4 text-muted-foreground"})]})}),e.jsx(qt,{open:A,onOpenChange:m,children:e.jsxs(Qt,{className:"max-w-sm rounded-2xl",children:[e.jsx(zt,{children:e.jsx(Jt,{children:"Présence hebdo"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Définis les créneaux attendus chaque semaine. Tu peux ensuite ajuster un jour précis dans le calendrier."}),e.jsx("div",{className:"space-y-2",children:Ls.map((s,a)=>{const c=ft.filter(g=>!!L?.[a]?.[g.key]).length;return e.jsxs("div",{className:"rounded-2xl border border-border bg-card px-3 py-3",children:[e.jsx("div",{className:"mb-2 flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:s}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:c===0?"Aucun créneau prévu":`${c} créneau${c>1?"x":""} attendu${c>1?"s":""}`})]})}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:ft.map(g=>{const _=!!L?.[a]?.[g.key];return e.jsxs("button",{type:"button",onClick:()=>Kt(a,g.key),className:pt("rounded-2xl border px-3 py-3 text-left transition",_?"border-foreground bg-foreground text-background":"border-border bg-card text-foreground hover:bg-muted"),"aria-label":`${s} ${g.label}`,children:[e.jsx("div",{className:"text-sm font-semibold",children:g.label}),e.jsx("div",{className:pt("mt-1 text-[11px]",_?"text-background/80":"text-muted-foreground"),children:_?"Prévu":"Non prévu"})]},g.key)})})]},s)})}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>X(s=>Math.max(30,s-15)),"aria-label":"Diminuer la durée",children:e.jsx(St,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[B," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>X(s=>Math.min(240,s+15)),"aria-label":"Augmenter la durée",children:e.jsx(jt,{className:"h-4 w-4"})})]})]})]})]})}),e.jsx(Ks,{open:j,selectedDate:I,sessionsForSelectedDay:U,selectedDayStatus:se,dayKm:ae,activeSessionId:h,detailsOpen:P,draftState:C,saveState:k,isPending:M,logsBySessionId:ne,onClose:Be,onDayOffAll:Et,onOpenSession:qe,onCloseSession:()=>{x(null),f(!1)},onToggleDetails:()=>f(s=>!s),onMarkAbsent:Ot,onMarkPresent:Ft,onClearOverride:_t,onSaveFeedback:It,onDeleteFeedback:s=>{const a=ne[s];a?.id&&(J.mutate(Number(a.id)),x(null),f(!1))},onDraftStateChange:we,getSessionStatus:Te,isAbsent:oe.has(W),absenceReason:te.find(s=>s.date===W)?.reason??null,onMarkDayAbsent:s=>ve.mutate({date:W,reason:s}),onRemoveDayAbsence:()=>je.mutate(W)})]})})]})}export{hn as default};
