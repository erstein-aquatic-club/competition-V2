import{c as Ae,R as Ee,u as P,d as y,r as Ie,j as e}from"./vendor-query-Dcze6zAc.js";import{c as fe,u as J,d as Fe,O as ke,B as j,C as U,i as L,k as T,l as q,g as R,L as l,I as x,S as me}from"./index-D_a_jXPR.js";import{u as ue,t as he,o as je,s as u}from"./types-D0mS32uW.js";import{a as o}from"./api-DczX0XwY.js";import{T as Pe}from"./textarea-dwDtSjkY.js";import{S as W,a as Y,b as ee,c as se,d as m}from"./select-D_zEpdjE.js";import{S as Ue}from"./switch-Bw20BNgV.js";import{B as M}from"./badge-ClZglFDa.js";import{T as Le,a as Te,b as pe,c as C,d as qe,e as w}from"./table-BXKf6cPH.js";import{S as Re,a as Me,b as ze,c as Ke,d as Qe}from"./sheet-CuksLCQW.js";import{A as Ve,a as De,b as Be}from"./avatar-B_S4_0Vz.js";import{C as $e}from"./circle-alert-BPW-N5Rc.js";import{C as Oe}from"./clock-C59eMgo7.js";import{C as He}from"./circle-x-CE7IvWdJ.js";import{S as xe}from"./search-AGoECtS4.js";import{a as Ge,U as Xe}from"./user-plus-Basju1Hj.js";import{P as Ze}from"./pen-gsujYKh9.js";import{S as Je}from"./save-BJHmZDI7.js";import{s as We}from"./swim-Dn8ZphhA.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-DMvvL9pC.js";import"./index-CUU1QaTt.js";import"./chevron-down-B5bGbucp.js";import"./chevron-up-DrgvhbCF.js";import"./index-CkyIvOfK.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],es=fe("circle-check-big",Ye);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],rs=fe("shield-check",ss),is=["athlete","coach","comite","admin"],as=r=>!(r===!1||r===0),ts=je({display_name:u().min(2,"Le nom doit contenir au moins 2 caractères"),email:u().optional().refine(r=>!r||u().email().safeParse(r).success,"L'email doit être valide"),password:u().optional().refine(r=>!r||r.length>=8&&/[A-Z]/.test(r)&&/\d/.test(r),"Le mot de passe doit contenir au moins 8 caractères, une majuscule et un chiffre")}),ns=je({display_name:u().min(2,"Le nom doit contenir au moins 2 caractères"),group_id:u().optional(),bio:u().optional(),birthdate:u().optional().refine(r=>{if(!r)return!0;const t=new Date(r);if(isNaN(t.getTime()))return!1;const g=(new Date().getTime()-t.getTime())/(1e3*60*60*24*365.25);return g>=3&&g<=100},{message:"L'âge doit être entre 3 et 100 ans"}),ffn_iuf:u().optional().refine(r=>r?/^\d+$/.test(r):!0,{message:"L'IUF FFN doit être un nombre"}),phone:u().optional()}),ls=(r,t,g)=>r.map(b=>b.id===t?{...b,role:g}:b),N=(r,t)=>We(r,t).message;function Ts(){const{useMemo:r,useState:t}=Ee,g=typeof window>"u"?J.getState().role:J(s=>s.role),b=J(s=>s.userId),{toast:n}=Fe(),c=Ae(),[z,ge]=t(""),[_,ve]=t("all"),[S,ye]=t(!1),[h,K]=t(null),[re,ie]=t(null),[Q,A]=t(!1),[V,Ne]=t(""),{register:D,handleSubmit:be,reset:Ce,formState:{errors:v}}=ue({resolver:he(ts),defaultValues:{display_name:"",email:"",password:""}}),E=g==="admin",{data:p=[],isLoading:ae,error:B,refetch:we}=P({queryKey:["admin-users",S],queryFn:()=>o.listUsers({includeInactive:S}),enabled:E}),$=y({mutationFn:s=>o.createCoach(s),onMutate:()=>{ie(null)},onSuccess:s=>{c.invalidateQueries({queryKey:["admin-users"]}),Ce(),ie(s.initialPassword??null),n({title:"Coach créé"})},onError:s=>{n({title:"Erreur création coach",description:N(s,"Impossible de créer le coach.")})}}),te=y({mutationFn:s=>o.updateUserRole(s),onSuccess:(s,i)=>{c.setQueryData(["admin-users",S],f=>f&&ls(f,i.userId,i.role)),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Rôle mis à jour"})},onError:s=>{n({title:"Erreur mise à jour rôle",description:N(s,"Impossible de mettre à jour le rôle.")})}}),ne=y({mutationFn:s=>o.disableUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Compte désactivé"})},onError:s=>{n({title:"Erreur désactivation",description:N(s,"Impossible de désactiver le compte.")})}}),{data:O=[],error:H,refetch:_e}=P({queryKey:["pending-approvals"],queryFn:()=>o.getPendingApprovals(),enabled:E}),G=y({mutationFn:s=>o.approveUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription validée"})},onError:s=>{n({title:"Erreur validation",description:N(s,"Impossible de valider l'inscription.")})}}),X=y({mutationFn:s=>o.rejectUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription rejetée"})},onError:s=>{n({title:"Erreur rejet",description:N(s,"Impossible de rejeter l'inscription.")})}}),a=ue({resolver:he(ns),defaultValues:{display_name:"",group_id:"",bio:"",birthdate:"",ffn_iuf:"",phone:""}}),{data:d,isLoading:cs}=P({queryKey:["admin-user-profile",h],queryFn:()=>o.getProfile({userId:h}),enabled:!!h}),{data:le=[]}=P({queryKey:["admin-groups"],queryFn:()=>o.getGroups(),enabled:E}),I=y({mutationFn:s=>o.updateProfile({userId:h,profile:{display_name:s.display_name.trim(),group_id:s.group_id?Number(s.group_id):null,group_label:s.group_id?le.find(i=>i.id===Number(s.group_id))?.name??null:null,birthdate:s.birthdate||null,bio:s.bio||null,ffn_iuf:(s.ffn_iuf||"").trim()||null,phone:s.phone||null}}),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-user-profile",h]}),c.invalidateQueries({queryKey:["admin-users"]}),A(!1),n({title:"Fiche mise à jour"})},onError:s=>{n({title:"Erreur mise à jour",description:N(s,"Impossible de mettre à jour la fiche.")})}}),Se=s=>{K(s),A(!0)},ce=r(()=>p.find(i=>i.role==="admin")?.id??null,[p]),de=r(()=>{const s=z.trim().toLowerCase();return p.filter(i=>{if(_!=="all"&&i.role!==_)return!1;const f=i.display_name?.toLowerCase()??"",Z=i.email?.toLowerCase()??"";return!(s&&!f.includes(s)&&!Z.includes(s))})},[p,_,z]),F=r(()=>h?p.find(s=>s.id===h)??null:null,[h,p]),oe=r(()=>{const s=V.trim().toLowerCase();return s?p.filter(i=>(i.display_name?.toLowerCase()??"").includes(s)||(i.email?.toLowerCase()??"").includes(s)):p},[p,V]);return Ie.useEffect(()=>{!Q||!d||!F||a.reset({display_name:F.display_name||"",group_id:d.group_id?String(d.group_id):"",bio:d.bio||"",birthdate:d.birthdate?String(d.birthdate).split("T")[0]:"",ffn_iuf:d.ffn_iuf?String(d.ffn_iuf):"",phone:d.phone||""})},[Q,d,F]),E?B||H?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx($e,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:B instanceof Error?B.message:H instanceof Error?H.message:"Une erreur s'est produite"}),e.jsx(j,{variant:"default",onClick:()=>{we(),_e()},className:"mt-4 h-12 md:h-10",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(rs,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:"Accès admin"})]})]}),O.length>0?e.jsxs(U,{className:"border-status-warning/30 bg-status-warning-bg dark:border-status-warning/30 dark:bg-status-warning-bg",children:[e.jsxs(L,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-5 w-5 text-status-warning"}),"Inscriptions en attente",e.jsx(M,{variant:"secondary",className:"ml-2",children:O.length})]}),e.jsx(q,{children:"Ces utilisateurs ont créé un compte et attendent votre validation."})]}),e.jsx(R,{children:e.jsx("div",{className:"space-y-3",children:O.map(s=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-lg border bg-background p-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email||"Pas d'email"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Inscrit le ",new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(j,{size:"sm",className:"bg-status-success hover:opacity-90 text-white h-10",onClick:()=>G.mutate(s.user_id),disabled:G.isPending||X.isPending,children:[e.jsx(es,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(j,{size:"sm",variant:"destructive",onClick:()=>{window.confirm(`Rejeter l'inscription de "${s.display_name}" ? Le compte sera désactivé.`)&&X.mutate(s.user_id)},disabled:G.isPending||X.isPending,className:"h-10",children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]},s.user_id))})})]}):null,e.jsxs(U,{children:[e.jsxs(L,{children:[e.jsx(T,{children:"Créer un coach"}),e.jsx(q,{children:"Laissez le mot de passe vide pour en générer un automatiquement (affiché une seule fois)."})]}),e.jsx(R,{children:e.jsxs("form",{className:"space-y-4",onSubmit:be(s=>{$.mutate({display_name:s.display_name.trim(),email:s.email?.trim()||void 0,password:s.password||void 0})}),children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"coach-create-name",children:"Nom affiché"}),e.jsx(x,{id:"coach-create-name",...D("display_name"),placeholder:"Ex: Coach Martin"}),v.display_name&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:v.display_name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"coach-create-email",children:"Email"}),e.jsx(x,{id:"coach-create-email",type:"email",...D("email"),placeholder:"coach@email.com"}),v.email&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:v.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"coach-create-password",children:"Mot de passe (optionnel)"}),e.jsx(x,{id:"coach-create-password",type:"text",...D("password"),placeholder:"Laisser vide pour auto"}),v.password&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:v.password.message})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(j,{variant:"default",type:"submit",disabled:$.isPending,className:"h-10",children:$.isPending?"Création...":"Créer le coach"}),re?e.jsxs("div",{className:"rounded-md border border-primary/30 bg-primary/5 px-4 py-2 text-sm",children:[e.jsx("p",{className:"font-medium text-primary",children:"Mot de passe initial (à copier)"}),e.jsx("p",{className:"font-mono",children:re})]}):null]})]})})]}),e.jsxs(U,{children:[e.jsxs(L,{children:[e.jsx(T,{children:"Gestion des comptes"}),e.jsx(q,{children:"Mettre à jour les rôles, filtrer et désactiver les comptes."})]}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(l,{htmlFor:"admin-search",children:"Recherche"}),e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(x,{id:"admin-search",value:z,onChange:s=>ge(s.target.value),placeholder:"Nom ou email",className:"pl-9"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Rôle"}),e.jsxs(W,{value:_,onValueChange:s=>ve(s),children:[e.jsx(Y,{children:e.jsx(ee,{placeholder:"Tous"})}),e.jsxs(se,{children:[e.jsx(m,{value:"all",children:"Tous"}),e.jsx(m,{value:"athlete",children:"Athlète"}),e.jsx(m,{value:"coach",children:"Entraineur EAC"}),e.jsx(m,{value:"comite",children:"Comité"}),e.jsx(m,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ue,{checked:S,onCheckedChange:ye,id:"inactive-toggle"}),e.jsx(l,{htmlFor:"inactive-toggle",className:"text-sm",children:"Inclure désactivés"})]})]}),ae?e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((s,i)=>e.jsx("div",{className:"flex items-center gap-4 p-3 rounded-lg border",children:e.jsx(me,{className:"h-10 w-full"})},`skeleton-${i}`))}):de.length?e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(Le,{children:[e.jsx(Te,{children:e.jsxs(pe,{children:[e.jsx(C,{children:"Utilisateur"}),e.jsx(C,{children:"Email"}),e.jsx(C,{children:"Rôle"}),e.jsx(C,{children:"Statut"}),e.jsx(C,{className:"text-right",children:"Actions"})]})}),e.jsx(qe,{children:de.map(s=>{const i=as(s.is_active),f=b===s.id,Z=ce!==null&&ce!==s.id;return e.jsxs(pe,{"data-selected":h===s.id,children:[e.jsx(w,{className:"font-medium",children:e.jsx(j,{variant:"ghost",size:"sm",className:"px-2",onClick:()=>K(s.id),children:s.display_name})}),e.jsx(w,{className:"text-sm text-muted-foreground",children:s.email||"-"}),e.jsx(w,{children:e.jsxs(W,{value:s.role,onValueChange:k=>{is.includes(k)&&s.id&&k!==s.role&&te.mutate({userId:s.id,role:k})},disabled:!i||te.isPending,children:[e.jsx(Y,{className:"w-[140px]",children:e.jsx(ee,{})}),e.jsxs(se,{children:[e.jsx(m,{value:"athlete",children:"Athlète"}),e.jsx(m,{value:"coach",children:"Entraineur EAC"}),e.jsx(m,{value:"comite",children:"Comité"}),e.jsx(m,{value:"admin",disabled:Z,children:"Admin"})]})]})}),e.jsx(w,{children:i?e.jsx(M,{variant:"secondary",children:"Actif"}):e.jsx(M,{variant:"outline",children:"Désactivé"})}),e.jsx(w,{className:"text-right",children:e.jsxs(j,{variant:"destructive",size:"sm",onClick:()=>{if(!s.id)return;if(f){n({title:"Action impossible",description:"Vous ne pouvez pas désactiver votre propre compte."});return}window.confirm(`Confirmer la désactivation du compte "${s.display_name}" ?`)&&ne.mutate({userId:s.id})},disabled:!i||ne.isPending||f,className:"h-10",children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"}),"Désactiver"]})})]},s.id)})})]})}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Xe,{className:"h-4 w-4"}),"Aucun utilisateur ne correspond à votre recherche."]})]})]}),e.jsxs(U,{children:[e.jsxs(L,{children:[e.jsx(T,{children:"Fiches utilisateurs"}),e.jsx(q,{children:"Tapez sur un compte pour voir et modifier sa fiche."})]}),e.jsxs(R,{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(x,{value:V,onChange:s=>Ne(s.target.value),placeholder:"Rechercher un nom...",className:"pl-9"})]}),ae?e.jsx("div",{className:"space-y-2",children:Array.from({length:5}).map((s,i)=>e.jsx(me,{className:"h-14 w-full rounded-lg"},`fiche-sk-${i}`))}):oe.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun résultat."}):e.jsx("div",{className:"space-y-1.5",children:oe.map(s=>e.jsxs("button",{type:"button",className:"w-full flex items-center gap-3 rounded-lg border bg-card p-3 text-left hover:bg-muted/50 transition-colors",onClick:()=>{K(s.id),Se(s.id)},children:[e.jsxs(Ve,{className:"h-9 w-9 shrink-0",children:[e.jsx(De,{src:`https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(s.display_name)}`,alt:s.display_name}),e.jsx(Be,{className:"text-xs",children:(s.display_name||"?").slice(0,2).toUpperCase()})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.email||"-"})]}),e.jsx(M,{variant:"outline",className:"shrink-0 text-[10px] capitalize",children:s.role}),e.jsx(Ze,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"})]},s.id))})]})]}),e.jsx(Re,{open:Q,onOpenChange:A,children:e.jsxs(Me,{side:"bottom",className:"max-h-[85vh] overflow-y-auto",children:[e.jsxs(ze,{children:[e.jsxs(Ke,{children:["Modifier la fiche — ",F?.display_name]}),e.jsx(Qe,{children:"Modifiez les informations du profil utilisateur."})]}),e.jsxs("form",{onSubmit:a.handleSubmit(s=>I.mutate(s)),className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Nom affiché"}),e.jsx(x,{...a.register("display_name")}),a.formState.errors.display_name&&e.jsx("p",{className:"text-xs text-destructive",children:a.formState.errors.display_name.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Groupe"}),e.jsxs(W,{value:a.watch("group_id"),onValueChange:s=>a.setValue("group_id",s),children:[e.jsx(Y,{children:e.jsx(ee,{placeholder:"Choisir un groupe"})}),e.jsx(se,{children:le.map(s=>e.jsx(m,{value:String(s.id),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Date de naissance"}),e.jsx(x,{type:"date",...a.register("birthdate")}),a.formState.errors.birthdate&&e.jsx("p",{className:"text-xs text-destructive",children:a.formState.errors.birthdate.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Téléphone"}),e.jsx(x,{type:"tel",placeholder:"06 12 34 56 78",...a.register("phone")})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"IUF FFN"}),e.jsx(x,{placeholder:"879576",inputMode:"numeric",...a.register("ffn_iuf")}),a.formState.errors.ffn_iuf&&e.jsx("p",{className:"text-xs text-destructive",children:a.formState.errors.ffn_iuf.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(l,{children:"Bio"}),e.jsx(Pe,{...a.register("bio"),rows:3})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(j,{type:"submit",disabled:I.isPending,className:"w-full",children:[e.jsx(Je,{className:"mr-2 h-4 w-4"}),I.isPending?"Enregistrement...":"Enregistrer"]}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>A(!1),disabled:I.isPending,children:"Annuler"})]})]})]})})]}):typeof window>"u"?null:e.jsx(ke,{to:"/"})}export{Ts as default,ls as updateUserRoleInList};
