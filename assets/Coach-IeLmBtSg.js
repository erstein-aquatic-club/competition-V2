const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StrengthCatalog-C_kh1QDa.js","assets/vendor-query-BiSH4r2z.js","assets/vendor-react-BzrpNAyj.js","assets/api-D5nrcq73.js","assets/index-Dz1G674X.js","assets/vendor-supabase-6k692oZB.js","assets/index-BKGAFatk.css","assets/swim-CusmRTEQ.js","assets/index-DwmTJ01u.js","assets/index-x_G3AtZ6.js","assets/select-CS4PbhrI.js","assets/chevron-down-DeyqN5a9.js","assets/check-CHXwkbMe.js","assets/chevron-up-BThDbMB2.js","assets/CalendarGrid-3_EVRglk.js","assets/chevron-left-C-3qbnzM.js","assets/chevron-right-Bt9jZqeN.js","assets/objectiveHelpers-CDq4g8Vj.js","assets/dialog-CgStOefE.js","assets/index-CPu5HhZp.js","assets/checkbox-Cp4Dq3fF.js","assets/alert-dialog-AGUn_vgy.js","assets/tabs-D5d0d_ur.js","assets/SessionListView-ZIMFQWsr.js","assets/play-BACUHSG-.js","assets/save-oQkFXVhw.js","assets/circle-alert-D-vzv-7J.js","assets/pencil-Dh4jADoQ.js","assets/trash-2-D_phj0pB.js","assets/drawer-FQi5RfKT.js","assets/search-C2A0BNyw.js","assets/plus-D2a48khI.js","assets/loader-circle-BolcQ3MT.js","assets/pen-BMB0YOYt.js","assets/SwimCatalog-DU2o01TQ.js","assets/SwimSessionTimeline-oUU8clmA.js","assets/swimConsultationUtils-BZNYTK44.js","assets/timer-rlVoYDBj.js","assets/eye-9t448cMd.js","assets/clock-C1Wv1y76.js","assets/format-B9mPVj_w.js","assets/share-2-DR-Zo6SQ.js"])))=>i.map(i=>d[i]);
import{c as fe,B as k,d as W,C as Me,i as De,k as Ae,l as Te,g as Fe,L as P,I as ie,W as He,D as Ye,R as is,U as Ce,m as ls,n as os,T as qe,s as cs,u as Ie,b as ds,P as Ke,o as us,_ as We}from"./index-Dz1G674X.js";import{j as e,r as l,u as V,c as le,d as R}from"./vendor-query-BiSH4r2z.js";import{a as M}from"./api-D5nrcq73.js";import{B as H}from"./badge-0qYR7AHK.js";import{T as Le,a as X}from"./toggle-group-DdZNzTCF.js";import{A as we,T as Je,e as Xe,f as Ze,F as ms,p as Ge}from"./objectiveHelpers-CDq4g8Vj.js";import{S as Z,a as ee,b as se,c as te,d as B}from"./select-CS4PbhrI.js";import{a as xs,b as ps,P as hs}from"./CalendarGrid-3_EVRglk.js";import{S as ve,a as ye,b as be,c as Ne,d as Oe,A as de,e as ue,f as me,g as xe,h as pe,i as he,j as ge,k as je}from"./alert-dialog-AGUn_vgy.js";import{T as es}from"./trash-2-D_phj0pB.js";import{C as gs}from"./checkbox-Cp4Dq3fF.js";import{S as js}from"./separator-DkMVT8xb.js";import{C as fs,a as vs,b as ys}from"./collapsible-B8HaSRp7.js";import{P as ae}from"./plus-D2a48khI.js";import{U as bs,a as Ns}from"./user-plus-BJjZV38p.js";import{C as ws}from"./chevron-down-DeyqN5a9.js";import{S as Cs}from"./switch-CQbf43AJ.js";import{M as Ss}from"./map-pin-LhYirFf7.js";import{T as ze}from"./target-BmbtZu6V.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";import"./swim-CusmRTEQ.js";import"./index-DwmTJ01u.js";import"./index-x_G3AtZ6.js";import"./check-CHXwkbMe.js";import"./chevron-up-BThDbMB2.js";import"./chevron-left-C-3qbnzM.js";import"./chevron-right-Bt9jZqeN.js";import"./index-CPu5HhZp.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _s=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],Ee=fe("calendar-days",_s);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ks=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],Ms=fe("external-link",ks);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ds=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}],["path",{d:"M3.22 13H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27",key:"auskq0"}]],As=fe("heart-pulse",Ds);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],Pe=fe("mail",Ts);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=[["path",{d:"M18 21a8 8 0 0 0-16 0",key:"3ypg7q"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3",key:"10s06x"}]],ss=fe("users-round",Fs),ne=({title:s,description:r,onBack:a,actions:n})=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(k,{variant:"ghost",size:"sm",className:"-ml-2",onClick:a,children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Retour"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:s}),r?e.jsx("p",{className:"text-sm text-muted-foreground",children:r}):null]}),n?e.jsx("div",{className:"flex items-center gap-2",children:n}):null]}),qs=({onBack:s,athletes:r,groups:a,athletesLoading:n})=>{const{toast:c}=W(),[g,f]=l.useState(""),[d,x]=l.useState(""),p=l.useMemo(()=>r.filter(t=>t.id&&t.email).map(t=>({value:`user:${t.id}`,label:t.group_label?`${t.display_name} · ${t.group_label}`:t.display_name,email:t.email})),[r]),h=l.useMemo(()=>a.map(t=>({value:`group:${t.id}`,label:t.name,id:t.id})),[a]),o=()=>{if(!d)return[];if(d.startsWith("user:")){const t=p.find(m=>m.value===d);return t?[t.email]:[]}if(d.startsWith("group:")){const t=Number(d.split(":")[1]);return r.filter(m=>m.group_id===t&&m.email).map(m=>m.email)}return[]},j=()=>{const t=o();if(!t.length){c({title:"Aucune adresse email",description:"Aucun nageur avec une adresse email dans cette sélection."});return}const m=new URLSearchParams;m.set("bcc",t.join(",")),g.trim()&&m.set("subject",g.trim()),window.location.href=`mailto:?${m.toString()}`},y=o();return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ne,{title:"Contacter par email",description:"Ouvre votre application mail avec les destinataires en CCI.",onBack:s}),e.jsxs(Me,{className:"border-l-4 border-l-primary",children:[e.jsxs(De,{children:[e.jsx(Ae,{children:"Destinataire"}),e.jsx(Te,{children:"Sélectionnez un nageur ou un groupe."})]}),e.jsxs(Fe,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Destinataire"}),e.jsxs(Z,{value:d,onValueChange:x,children:[e.jsx(ee,{children:e.jsx(se,{placeholder:n?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(te,{children:[h.length?e.jsxs(e.Fragment,{children:[e.jsx(B,{value:"section-group",disabled:!0,children:"Groupes"}),h.map(t=>e.jsx(B,{value:t.value,children:t.label},t.value))]}):null,p.length?e.jsxs(e.Fragment,{children:[e.jsx(B,{value:"section-athlete",disabled:!0,children:"Nageurs"}),p.map(t=>e.jsx(B,{value:t.value,children:t.label},t.value))]}):null]})]})]}),d&&y.length>0?e.jsxs("p",{className:"text-xs text-muted-foreground",children:[y.length," adresse",y.length>1?"s":""," email",y.length>1?" (envoi en CCI)":""]}):null,d&&y.length===0?e.jsx("p",{className:"text-xs text-destructive",children:"Aucune adresse email disponible pour cette sélection."}):null]})]}),e.jsxs(Me,{children:[e.jsxs(De,{children:[e.jsx(Ae,{children:"Objet"}),e.jsx(Te,{children:"Optionnel — pré-rempli dans votre application mail."})]}),e.jsx(Fe,{children:e.jsx(ie,{value:g,onChange:t=>f(t.target.value),placeholder:"Objet du mail…"})})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsxs(k,{className:"w-full sm:w-auto",onClick:j,disabled:!d||y.length===0,children:[e.jsx(Pe,{className:"mr-2 h-4 w-4"}),"Ouvrir dans l'app mail",e.jsx(Ms,{className:"ml-2 h-3 w-3"})]})})]})};function Ve(s){return String(s).padStart(2,"0")}function re(s){return`${s.getFullYear()}-${Ve(s.getMonth()+1)}-${Ve(s.getDate())}`}function Se(s){return new Date(s.getFullYear(),s.getMonth(),1)}function Be(s,r){const a=new Date(s);return a.setDate(a.getDate()+r),a}function zs(s){return(s.getDay()+6)%7}function _e(s){if(!s)return"AM";const r=s.toLowerCase();return r==="evening"||r.includes("soir")||r==="pm"?"PM":"AM"}const Es=[{key:"swim-morning",label:"Nage — Matin",type:"swim",scheduledSlot:"morning"},{key:"swim-evening",label:"Nage — Soir",type:"swim",scheduledSlot:"evening"},{key:"strength",label:"Musculation",type:"strength",scheduledSlot:null}];function Ls({groupId:s,userId:r,enabled:a}){const n=l.useMemo(()=>new Date,[]),[c,g]=l.useState(()=>Se(new Date)),[f,d]=l.useState(()=>re(new Date)),[x,p]=l.useState(null),[h,o]=l.useState(!1),j=l.useMemo(()=>Se(c),[c]),y=l.useMemo(()=>{const S=zs(j),D=Be(j,-S),A=[];for(let u=0;u<42;u++)A.push(Be(D,u));return A},[j]),t=l.useMemo(()=>{const S=re(y[0]),D=re(y[y.length-1]);return{from:S,to:D}},[y]),m=!!(s||r),{data:C=[],isLoading:v}=V({queryKey:["coach-calendar-assignments",s,r,t.from,t.to],queryFn:()=>M.getCoachAssignments({groupId:s??null,userId:r??null,from:t.from,to:t.to}),enabled:m}),w=l.useMemo(()=>{const S=new Map;for(const D of C){const A=D.scheduledDate?.slice(0,10);A&&(S.has(A)||S.set(A,[]),S.get(A).push(D))}return S},[C]),L=l.useMemo(()=>{const S={};for(const D of y){const A=re(D),u=w.get(A)??[],E=u.some($=>_e($.scheduledSlot)==="AM"),O=u.some($=>_e($.scheduledSlot)==="PM"),N=(E?1:0)+(O?1:0),K=[{slotKey:"AM",expected:E,completed:E,absent:!1},{slotKey:"PM",expected:O,completed:O,absent:!1}];S[A]={completed:N,total:N,slots:K}}return S},[y,w]),q=l.useMemo(()=>{const[S,D,A]=f.split("-").map(Number);return new Date(S,D-1,A)},[f]),_=l.useMemo(()=>w.get(f)??[],[w,f]),F=l.useMemo(()=>{const S=_;return Es.map(D=>{const A=S.filter(O=>D.type!==O.type?!1:D.type==="swim"?_e(O.scheduledSlot)===(D.scheduledSlot==="morning"?"AM":"PM"):!0),u=A.find(O=>O.targetType==="user"),E=A.find(O=>O.targetType==="group");return{...D,assignment:u??E??null}})},[_]),T=l.useMemo(()=>{const S={};for(const D of y){const A=re(D),u=w.get(A)??[];S[A]=u.some(E=>E.type==="strength")}return S},[y,w]),b=L[f]??{completed:0,total:0,slots:[{slotKey:"AM",expected:!1,completed:!1,absent:!1},{slotKey:"PM",expected:!1,completed:!1,absent:!1}]},i=l.useCallback(()=>{g(S=>new Date(S.getFullYear(),S.getMonth()-1,1))},[]),I=l.useCallback(()=>{g(S=>new Date(S.getFullYear(),S.getMonth()+1,1))},[]),Q=l.useCallback(()=>{g(Se(new Date)),d(re(new Date))},[]),Y=l.useCallback(S=>{d(S),o(!0)},[]);return{today:n,monthCursor:c,selectedISO:f,selectedDayIndex:x,drawerOpen:h,gridDates:y,completionByISO:L,selectedDate:q,selectedDayStatus:b,assignmentsForSelectedDay:_,slotsForSelectedDay:F,hasStrengthByISO:T,isLoading:v,hasFilter:m,setSelectedISO:d,setSelectedDayIndex:p,setDrawerOpen:o,prevMonth:i,nextMonth:I,jumpToday:Q,openDay:Y}}function Os(s){const[r,a,n]=s.split("-").map(Number);return new Date(r,a-1,n).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})}function Ps({onBack:s,athletes:r,groups:a,swimSessions:n,strengthSessions:c}){const[g,f]=l.useState("group"),[d,x]=l.useState(""),[p,h]=l.useState(""),o=g==="group"&&d?Number(d):null,j=g==="user"&&p?Number(p):null,{today:y,monthCursor:t,selectedISO:m,selectedDayIndex:C,drawerOpen:v,gridDates:w,completionByISO:L,selectedDayStatus:q,slotsForSelectedDay:_,hasStrengthByISO:F,hasFilter:T,setSelectedISO:b,setSelectedDayIndex:i,setDrawerOpen:I,prevMonth:Q,nextMonth:Y,jumpToday:S,openDay:D}=Ls({groupId:o,userId:j,enabled:!0}),A=le(),u=R({mutationFn:N=>M.assignments_create(N),onSuccess:()=>{A.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),E=R({mutationFn:N=>M.assignments_delete(N),onSuccess:()=>{A.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),O=(N,K)=>{let $=K;if(N.key==="ArrowLeft"&&($=Math.max(0,K-1)),N.key==="ArrowRight"&&($=Math.min(w.length-1,K+1)),N.key==="ArrowUp"&&($=Math.max(0,K-7)),N.key==="ArrowDown"&&($=Math.min(w.length-1,K+7)),$!==K){N.preventDefault(),i($);const U=ce=>String(ce).padStart(2,"0"),G=w[$],oe=`${G.getFullYear()}-${U(G.getMonth()+1)}-${U(G.getDate())}`;b(oe)}if(N.key==="Enter"||N.key===" "){N.preventDefault();const U=ce=>String(ce).padStart(2,"0"),G=w[K],oe=`${G.getFullYear()}-${U(G.getMonth()+1)}-${U(G.getDate())}`;D(oe)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ne,{title:"Calendrier",description:"Vue mensuelle des assignations",onBack:s}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsxs(Le,{type:"single",value:g,onValueChange:N=>{(N==="group"||N==="user")&&f(N)},className:"shrink-0",children:[e.jsx(X,{value:"group",className:"text-xs px-3",children:"Groupe"}),e.jsx(X,{value:"user",className:"text-xs px-3",children:"Nageur"})]}),g==="group"?e.jsxs(Z,{value:d,onValueChange:x,children:[e.jsx(ee,{className:"w-full sm:w-56",children:e.jsx(se,{placeholder:"Choisir un groupe"})}),e.jsx(te,{children:a.map(N=>e.jsx(B,{value:String(N.id),children:N.name},String(N.id)))})]}):e.jsxs(Z,{value:p,onValueChange:h,children:[e.jsx(ee,{className:"w-full sm:w-56",children:e.jsx(se,{placeholder:"Choisir un nageur"})}),e.jsx(te,{children:r.filter(N=>N.id!=null).map(N=>e.jsxs(B,{value:String(N.id),children:[N.display_name,N.group_label?` · ${N.group_label}`:""]},String(N.id)))})]})]}),T?e.jsxs("div",{className:"rounded-2xl border bg-card shadow-sm",children:[e.jsx(xs,{monthCursor:t,selectedDayStatus:q,onPrevMonth:Q,onNextMonth:Y,onJumpToday:S}),e.jsx(ps,{monthCursor:t,gridDates:w,completionByISO:L,strengthByISO:F,selectedISO:m,selectedDayIndex:C,today:y,onDayClick:D,onKeyDown:O})]}):e.jsx("div",{className:"py-12 text-center text-sm text-muted-foreground",children:"Sélectionnez un groupe ou un nageur pour afficher le calendrier."}),e.jsx(ve,{open:v,onOpenChange:I,children:e.jsxs(ye,{side:"bottom",className:"max-h-[70vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(be,{className:"pb-3",children:[e.jsx(Ne,{className:"capitalize text-left",children:Os(m)}),e.jsx(Oe,{className:"sr-only",children:"Gérer les assignations pour cette journée"})]}),e.jsx("div",{className:"space-y-3",children:_.map(N=>{const K=N.assignment?.targetType==="group",$=g==="user";return e.jsx($s,{slot:N,swimSessions:n,strengthSessions:c,isGroupAssignment:K&&$,onAssign:U=>{u.mutate({assignment_type:N.type,session_id:U,scheduled_date:m,scheduled_slot:N.scheduledSlot??void 0,target_group_id:o,target_user_id:j})},onDelete:U=>{E.mutate(U)},onReplace:(U,G)=>{K&&$?u.mutate({assignment_type:N.type,session_id:G,scheduled_date:m,scheduled_slot:N.scheduledSlot??void 0,target_user_id:j}):E.mutate(U,{onSuccess:()=>{u.mutate({assignment_type:N.type,session_id:G,scheduled_date:m,scheduled_slot:N.scheduledSlot??void 0,target_group_id:o,target_user_id:j})}})},isPending:u.isPending||E.isPending},N.key)})})]})})]})}function $s({slot:s,swimSessions:r,strengthSessions:a,isGroupAssignment:n,onAssign:c,onDelete:g,onReplace:f,isPending:d}){const[x,p]=l.useState(!1),h=s.type==="swim",o=h?(r??[]).map(t=>({id:t.id,label:t.name})):(a??[]).map(t=>({id:t.id,label:t.title})),j=s.assignment!==null,y=t=>{const m=Number(t);m&&(j&&x?(f(s.assignment.id,m),p(!1)):c(m))};return e.jsxs("div",{className:"rounded-xl border p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[h?e.jsx(He,{className:"h-4 w-4 text-blue-500 shrink-0"}):e.jsx(Ye,{className:"h-4 w-4 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:s.label})]}),j&&!x?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-sm font-semibold truncate flex-1",children:[s.assignment.title,n&&e.jsx("span",{className:"ml-1.5 text-[10px] font-medium text-muted-foreground bg-muted px-1.5 py-0.5 rounded-full align-middle",children:"Groupe"})]}),e.jsx(k,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0",disabled:d,onClick:()=>p(!0),title:n?"Personnaliser":"Changer",children:e.jsx(is,{className:"h-3.5 w-3.5"})}),!n&&e.jsx(k,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0 text-destructive hover:text-destructive",disabled:d,onClick:()=>g(s.assignment.id),title:"Supprimer",children:e.jsx(es,{className:"h-3.5 w-3.5"})})]}):e.jsxs(Z,{value:"",onValueChange:y,disabled:d||o.length===0,children:[e.jsx(ee,{className:"h-9 text-xs",children:e.jsx(se,{placeholder:x?n?"Personnaliser pour ce nageur":"Choisir le remplacement":"Choisir une séance"})}),e.jsx(te,{children:o.map(t=>e.jsx(B,{value:String(t.id),children:t.label},t.id))})]}),x?e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground",onClick:()=>p(!1),children:"Annuler"}):null]})}const ts=({athletes:s,selected:r,onToggle:a,filterToUserIds:n})=>{const[c,g]=l.useState(""),f=l.useMemo(()=>{let x=s.filter(p=>p.id!=null);if(n&&(x=x.filter(p=>n.has(p.id))),c.trim()){const p=c.toLowerCase();x=x.filter(h=>h.display_name.toLowerCase().includes(p))}return x},[s,n,c]),d=l.useMemo(()=>{const x=new Map;for(const p of f){const h=p.group_label||"Sans groupe";x.has(h)||x.set(h,[]),x.get(h).push(p)}return[...x.entries()].sort(([p],[h])=>p.localeCompare(h,"fr"))},[f]);return e.jsxs("div",{className:"space-y-3",children:[e.jsx(ie,{placeholder:"Rechercher un nageur...",value:c,onChange:x=>g(x.target.value)}),e.jsxs("div",{className:"max-h-[50vh] overflow-y-auto space-y-3",children:[d.map(([x,p])=>e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-1.5",children:x}),e.jsx("div",{className:"space-y-1",children:p.map(h=>e.jsxs("label",{className:"flex items-center gap-2.5 rounded-lg border px-3 py-2 cursor-pointer hover:bg-muted/50 transition-colors",children:[e.jsx(gs,{checked:r.has(h.id),onCheckedChange:()=>a(h.id)}),e.jsx("span",{className:"text-sm",children:h.display_name})]},h.id))})]},x)),d.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun nageur trouvé."})]}),r.size>0&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.size," nageur",r.size>1?"s":""," ","sélectionné",r.size>1?"s":""]})]})},ns=({open:s,onOpenChange:r,athletes:a,parentGroupId:n,parentMembers:c,onCreated:g})=>{const{toast:f}=W(),[d,x]=l.useState(""),[p,h]=l.useState(new Set),o=t=>{h(m=>{const C=new Set(m);return C.has(t)?C.delete(t):C.add(t),C})},j=R({mutationFn:()=>M.createTemporaryGroup({name:d.trim(),member_user_ids:[...p],parent_group_id:n??void 0}),onSuccess:()=>{f({title:"Groupe créé",description:`Le groupe "${d.trim()}" a été créé avec ${p.size} nageur${p.size>1?"s":""}.`}),x(""),h(new Set),r(!1),g()},onError:t=>{f({title:"Erreur",description:t.message,variant:"destructive"})}}),y=()=>{if(!d.trim()){f({title:"Nom requis",description:"Veuillez saisir un nom pour le groupe.",variant:"destructive"});return}j.mutate()};return e.jsx(ve,{open:s,onOpenChange:r,children:e.jsxs(ye,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(Ne,{children:n?"Créer un sous-groupe":"Créer un groupe"}),e.jsx(Oe,{children:n?"Sélectionnez des nageurs du groupe parent pour ce sous-groupe.":"Créez un groupe temporaire (stage, compétition) avec des nageurs de différents groupes."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"group-name",children:"Nom du groupe"}),e.jsx(ie,{id:"group-name",placeholder:"Ex : Stage Pâques 2026",value:d,onChange:t=>x(t.target.value)})]}),e.jsx(js,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Nageurs"}),e.jsx(ts,{athletes:a,selected:p,onToggle:o,filterToUserIds:c??null})]}),e.jsx(k,{className:"w-full",onClick:y,disabled:j.isPending||!d.trim(),children:j.isPending?"Création...":"Créer le groupe"})]})]})})},Rs=({open:s,onOpenChange:r,groupId:a,athletes:n,existingMemberIds:c,onAdded:g})=>{const{toast:f}=W(),[d,x]=l.useState(new Set),p=l.useMemo(()=>n.filter(j=>j.id!=null&&!c.has(j.id)),[n,c]),h=j=>{x(y=>{const t=new Set(y);return t.has(j)?t.delete(j):t.add(j),t})},o=R({mutationFn:()=>M.addTemporaryGroupMembers(a,[...d]),onSuccess:()=>{f({title:"Nageurs ajoutés",description:`${d.size} nageur${d.size>1?"s":""} ajouté${d.size>1?"s":""}.`}),x(new Set),r(!1),g()},onError:j=>{f({title:"Erreur",description:j.message,variant:"destructive"})}});return e.jsx(ve,{open:s,onOpenChange:r,children:e.jsxs(ye,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(Ne,{children:"Ajouter des nageurs"}),e.jsx(Oe,{children:"Sélectionnez les nageurs à ajouter au groupe."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx(ts,{athletes:p,selected:d,onToggle:h}),e.jsx(k,{className:"w-full",onClick:()=>o.mutate(),disabled:o.isPending||d.size===0,children:o.isPending?"Ajout...":`Ajouter ${d.size} nageur${d.size>1?"s":""}`})]})]})})},Is=({groupId:s,athletes:r,onBack:a})=>{const{toast:n}=W(),c=le(),[g,f]=l.useState(!1),[d,x]=l.useState(!1),[p,h]=l.useState(null),{data:o,isLoading:j}=V({queryKey:["temp-group-detail",s],queryFn:()=>M.getTemporaryGroupDetail(s)}),y=R({mutationFn:v=>M.removeTemporaryGroupMember(s,v),onSuccess:()=>{n({title:"Nageur retiré"}),c.invalidateQueries({queryKey:["temp-group-detail",s]}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:v=>{n({title:"Erreur",description:v.message,variant:"destructive"})}}),t=()=>{c.invalidateQueries({queryKey:["temp-group-detail",s]}),c.invalidateQueries({queryKey:["temp-groups"]})},m=l.useMemo(()=>new Set((o?.members??[]).map(v=>v.user_id)),[o]),C=l.useMemo(()=>new Set((o?.members??[]).map(v=>v.user_id)),[o]);return j?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{variant:"ghost",size:"sm",className:"-ml-2",onClick:a,children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(v=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted"})},v))})]}):o?e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(k,{variant:"ghost",size:"sm",className:"-ml-2",onClick:a,children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:o.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(H,{variant:o.is_active?"default":"secondary",children:o.is_active?"Actif":"Terminé"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[o.members.length," membre",o.members.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Membres"}),o.is_active&&e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>f(!0),children:[e.jsx(bs,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]}),o.members.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun membre dans ce groupe."}):e.jsx("div",{className:"space-y-1.5",children:o.members.map(v=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:v.display_name}),v.permanent_group_label&&e.jsx(H,{variant:"secondary",className:"text-[10px] px-1.5 py-0 mt-0.5",children:v.permanent_group_label})]}),o.is_active&&e.jsx(k,{size:"icon",variant:"ghost",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>h({userId:v.user_id,name:v.display_name}),title:"Retirer du groupe",children:e.jsx(Ns,{className:"h-4 w-4"})})]},v.user_id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Sous-groupes"}),o.is_active&&e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>x(!0),children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Sous-groupe"]})]}),o.subgroups.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun sous-groupe."}):e.jsx("div",{className:"space-y-2",children:o.subgroups.map(v=>e.jsxs(fs,{children:[e.jsxs(vs,{className:"flex w-full items-center justify-between rounded-xl border bg-card p-3 text-left hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ss,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-semibold",children:v.name}),e.jsx(H,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:v.members.length})]}),e.jsx(ws,{className:"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]_&]:rotate-180"})]}),e.jsx(ys,{children:e.jsxs("div",{className:"ml-4 mt-1 space-y-1",children:[v.members.map(w=>e.jsx("div",{className:"flex items-center gap-2 rounded-lg border px-3 py-2",children:e.jsx("span",{className:"text-sm",children:w.display_name})},w.user_id)),v.members.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground py-2",children:"Aucun membre."})]})})]},v.id))})]}),e.jsx(Rs,{open:g,onOpenChange:f,groupId:s,athletes:r,existingMemberIds:m,onAdded:t}),e.jsx(ns,{open:d,onOpenChange:x,athletes:r,parentGroupId:s,parentMembers:C,onCreated:t}),e.jsx(de,{open:!!p,onOpenChange:v=>{v||h(null)},children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Retirer du groupe"}),e.jsxs(pe,{children:["Voulez-vous retirer ",p?.name," de ce groupe ?",o.subgroups.length>0?" Le nageur sera aussi retiré des sous-groupes.":""]})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(je,{onClick:()=>{p&&(y.mutate(p.userId),h(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Retirer"})]})]})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(k,{variant:"ghost",size:"sm",className:"-ml-2",onClick:a,children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Groupe introuvable."})]})},Qe=({group:s,onManage:r,onDeactivate:a,onReactivate:n,onDelete:c})=>{const g=new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"});return e.jsxs("div",{className:"rounded-xl border bg-card p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-bold truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1 flex-wrap",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.member_count," membre",s.member_count!==1?"s":""]}),s.subgroup_count>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.subgroup_count," sous-groupe",s.subgroup_count!==1?"s":""]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g})]})]}),e.jsx(H,{variant:s.is_active?"default":"secondary",children:s.is_active?"Actif":"Terminé"})]}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:s.is_active?e.jsxs(e.Fragment,{children:[e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>r(s.id),children:[e.jsx(ls,{className:"mr-1.5 h-3.5 w-3.5"}),"Gérer"]}),e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>a(s.id),children:[e.jsx(hs,{className:"mr-1.5 h-3.5 w-3.5"}),"Terminer"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>n(s.id),children:[e.jsx(os,{className:"mr-1.5 h-3.5 w-3.5"}),"Réactiver"]}),e.jsxs(k,{size:"sm",variant:"outline",className:"text-destructive hover:text-destructive",onClick:()=>c(s.id),children:[e.jsx(es,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})})]})},Ks=({onBack:s,athletes:r,athletesLoading:a})=>{const{toast:n}=W(),c=le(),[g,f]=l.useState("list"),[d,x]=l.useState(null),[p,h]=l.useState(!1),[o,j]=l.useState(null),[y,t]=l.useState(null),{data:m=[],isLoading:C}=V({queryKey:["temp-groups"],queryFn:()=>M.getTemporaryGroups()}),v=l.useMemo(()=>m.filter(b=>b.is_active),[m]),w=l.useMemo(()=>m.filter(b=>!b.is_active),[m]),L=R({mutationFn:b=>M.deactivateTemporaryGroup(b),onSuccess:()=>{n({title:"Groupe terminé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:b=>{n({title:"Erreur",description:b.message,variant:"destructive"})}}),q=R({mutationFn:b=>M.reactivateTemporaryGroup(b),onSuccess:()=>{n({title:"Groupe réactivé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:b=>{n({title:"Erreur",description:b.message,variant:"destructive"})}}),_=R({mutationFn:b=>M.deleteTemporaryGroup(b),onSuccess:()=>{n({title:"Groupe supprimé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:b=>{n({title:"Erreur",description:b.message,variant:"destructive"})}}),F=b=>{x(b),f("detail")},T=()=>{x(null),f("list"),c.invalidateQueries({queryKey:["temp-groups"]})};return g==="detail"&&d!=null?e.jsx(Is,{groupId:d,athletes:r,onBack:T}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ne,{title:"Groupes temporaires",description:"Créez et gérez des groupes pour les stages, compétitions ou événements.",onBack:s,actions:e.jsxs(k,{size:"sm",onClick:()=>h(!0),children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un groupe"]})}),C||a?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(b=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-6 w-16 rounded bg-muted"})]})},b))}):m.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ce,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun groupe temporaire pour le moment."}),e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>h(!0),children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer le premier groupe"]})]}):e.jsxs(e.Fragment,{children:[v.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Actifs (",v.length,")"]}),v.map(b=>e.jsx(Qe,{group:b,onManage:F,onDeactivate:i=>j(i),onReactivate:i=>q.mutate(i),onDelete:i=>t(i)},b.id))]}),w.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Terminés (",w.length,")"]}),w.map(b=>e.jsx(Qe,{group:b,onManage:F,onDeactivate:i=>j(i),onReactivate:i=>q.mutate(i),onDelete:i=>t(i)},b.id))]})]}),e.jsx(ns,{open:p,onOpenChange:h,athletes:r,onCreated:()=>{c.invalidateQueries({queryKey:["temp-groups"]})}}),e.jsx(de,{open:o!=null,onOpenChange:b=>{b||j(null)},children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Terminer le groupe"}),e.jsx(pe,{children:"Voulez-vous marquer ce groupe comme terminé ? Les sous-groupes seront aussi désactivés. Vous pourrez le réactiver plus tard si nécessaire."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(je,{onClick:()=>{o!=null&&(L.mutate(o),j(null))},children:"Terminer"})]})]})}),e.jsx(de,{open:y!=null,onOpenChange:b=>{b||t(null)},children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Supprimer le groupe"}),e.jsx(pe,{children:"Cette action est irréversible. Le groupe et tous ses sous-groupes seront supprimés définitivement."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(je,{onClick:()=>{y!=null&&(_.mutate(y),t(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function ke(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Gs(s){const r=new Date;r.setHours(0,0,0,0);const a=new Date(s+"T00:00:00");return Math.ceil((a.getTime()-r.getTime())/(1e3*60*60*24))}const Vs=({open:s,onOpenChange:r,competition:a})=>{const{toast:n}=W(),c=le(),g=!!a,[f,d]=l.useState(""),[x,p]=l.useState(""),[h,o]=l.useState(""),[j,y]=l.useState(!0),[t,m]=l.useState(""),[C,v]=l.useState(""),[w,L]=l.useState(!1);l.useEffect(()=>{s&&(a?(d(a.name),p(a.date),o(a.end_date??""),y(!!a.end_date),m(a.location??""),v(a.description??"")):(d(""),p(""),o(""),y(!0),m(""),v("")))},[s,a]);const q=R({mutationFn:i=>M.createCompetition(i),onSuccess:()=>{n({title:"Competition creee"}),c.invalidateQueries({queryKey:["competitions"]}),r(!1)},onError:i=>{n({title:"Erreur",description:i.message,variant:"destructive"})}}),_=R({mutationFn:i=>M.updateCompetition(a.id,i),onSuccess:()=>{n({title:"Competition mise a jour"}),c.invalidateQueries({queryKey:["competitions"]}),r(!1)},onError:i=>{n({title:"Erreur",description:i.message,variant:"destructive"})}}),F=R({mutationFn:()=>M.deleteCompetition(a.id),onSuccess:()=>{n({title:"Competition supprimee"}),c.invalidateQueries({queryKey:["competitions"]}),r(!1)},onError:i=>{n({title:"Erreur",description:i.message,variant:"destructive"})}}),T=()=>{if(!f.trim()){n({title:"Nom requis",description:"Veuillez saisir un nom pour la competition.",variant:"destructive"});return}if(!x){n({title:"Date requise",description:"Veuillez saisir une date.",variant:"destructive"});return}const i={name:f.trim(),date:x,end_date:j&&h?h:null,location:t.trim()||null,description:C.trim()||null};g?_.mutate(i):q.mutate(i)},b=q.isPending||_.isPending||F.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(ve,{open:s,onOpenChange:r,children:e.jsxs(ye,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(be,{children:e.jsx(Ne,{children:g?"Modifier la competition":"Nouvelle competition"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"comp-name",children:"Nom *"}),e.jsx(ie,{id:"comp-name",placeholder:"Ex : Championnats Regionaux",value:f,onChange:i=>d(i.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"comp-date",children:"Date *"}),e.jsx("input",{id:"comp-date",type:"date",value:x,onChange:i=>p(i.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(P,{htmlFor:"comp-multiday",children:"Multi-jours"}),e.jsx(Cs,{id:"comp-multiday",checked:j,onCheckedChange:y})]}),j&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"comp-end-date",children:"Date de fin"}),e.jsx("input",{id:"comp-end-date",type:"date",value:h,onChange:i=>o(i.target.value),min:x||void 0,className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"comp-location",children:"Lieu"}),e.jsx(ie,{id:"comp-location",placeholder:"Ex : Piscine de Strasbourg",value:t,onChange:i=>m(i.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"comp-description",children:"Description"}),e.jsx(Je,{id:"comp-description",placeholder:"Notes, informations complementaires...",value:C,onChange:i=>v(i.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(k,{className:"w-full",onClick:T,disabled:b||!f.trim()||!x,children:b?"Enregistrement...":g?"Enregistrer":"Creer"}),g&&e.jsx(k,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>L(!0),disabled:b,children:"Supprimer cette competition"})]})]})]})}),e.jsx(de,{open:w,onOpenChange:L,children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Supprimer la competition"}),e.jsxs(pe,{children:["Cette action est irreversible. La competition «"," ",a?.name," » sera supprimee definitivement."]})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(je,{onClick:()=>{F.mutate(),L(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Bs=({competition:s,onEdit:r})=>{const a=Gs(s.date),n=a<0,c=a>=0,g=s.end_date?`du ${ke(s.date)} au ${ke(s.end_date)}`:ke(s.date);return e.jsxs("button",{type:"button",className:`w-full text-left rounded-xl border bg-card p-3 space-y-1 transition-colors hover:bg-muted/50 ${n?"opacity-60":""}`,onClick:()=>r(s),children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:g})]}),e.jsxs("div",{className:"flex items-center gap-1.5 shrink-0",children:[c&&e.jsxs(H,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:["J-",a]}),n&&e.jsx(H,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Passee"})]})]}),s.location&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Ss,{className:"h-3 w-3 shrink-0"}),e.jsx("span",{className:"truncate",children:s.location})]})]})},Qs=({onBack:s})=>{const[r,a]=l.useState(!1),[n,c]=l.useState(null),{data:g=[],isLoading:f}=V({queryKey:["competitions"],queryFn:()=>M.getCompetitions()}),d=l.useMemo(()=>{const o=new Date;o.setHours(0,0,0,0);const j=o.getTime(),y=[],t=[];for(const m of g)new Date(m.date+"T00:00:00").getTime()>=j?y.push(m):t.push(m);return y.sort((m,C)=>new Date(m.date+"T00:00:00").getTime()-new Date(C.date+"T00:00:00").getTime()),t.sort((m,C)=>new Date(C.date+"T00:00:00").getTime()-new Date(m.date+"T00:00:00").getTime()),[...y,...t]},[g]),x=()=>{c(null),a(!0)},p=o=>{c(o),a(!0)},h=g.length===0?"Gerez les competitions du club.":`${g.length} competition${g.length>1?"s":""}`;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ne,{title:"Competitions",description:h,onBack:s,actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:x,children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),f?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(o=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},o))}):d.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(qe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucune competition creee."}),e.jsxs(k,{variant:"outline",size:"sm",onClick:x,children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer la premiere competition"]})]}):e.jsx("div",{className:"space-y-2",children:d.map(o=>e.jsx(Bs,{competition:o,onEdit:p},o.id))}),e.jsx(Vs,{open:r,onOpenChange:a,competition:n})]})};async function Us(s){const{data:r,error:a}=await cs.rpc("get_auth_uid_for_user",{p_user_id:s});return a?(console.error("[objectives] Failed to resolve auth UUID:",a.message),null):r}const Hs=({open:s,onOpenChange:r,objective:a,athleteName:n,athleteAuthId:c,competitions:g})=>{const{toast:f}=W(),d=le(),x=!!a,[p,h]=l.useState("chrono"),[o,j]=l.useState(""),[y,t]=l.useState("25"),[m,C]=l.useState(""),[v,w]=l.useState(""),[L,q]=l.useState(""),[_,F]=l.useState(!1),T=u=>{if(u)if(a){const E=!!a.event_code,O=!!a.text;h(E&&O?"both":O?"texte":"chrono"),j(a.event_code??""),t(String(a.pool_length??25)),C(a.target_time_seconds!=null?Ze(a.target_time_seconds):""),w(a.text??""),q(a.competition_id??"")}else h("chrono"),j(""),t("25"),C(""),w(""),q("");r(u)},b=R({mutationFn:u=>M.createObjective(u),onSuccess:()=>{f({title:"Objectif cree"}),d.invalidateQueries({queryKey:["objectives"]}),r(!1)},onError:u=>{f({title:"Erreur",description:u.message,variant:"destructive"})}}),i=R({mutationFn:u=>M.updateObjective(a.id,u),onSuccess:()=>{f({title:"Objectif mis a jour"}),d.invalidateQueries({queryKey:["objectives"]}),r(!1)},onError:u=>{f({title:"Erreur",description:u.message,variant:"destructive"})}}),I=R({mutationFn:()=>M.deleteObjective(a.id),onSuccess:()=>{f({title:"Objectif supprime"}),d.invalidateQueries({queryKey:["objectives"]}),r(!1)},onError:u=>{f({title:"Erreur",description:u.message,variant:"destructive"})}}),Q=p==="chrono"||p==="both",Y=p==="texte"||p==="both",S=()=>{if(Q&&!o){f({title:"Epreuve requise",description:"Veuillez selectionner une epreuve.",variant:"destructive"});return}if(Q&&m&&Ge(m)===null){f({title:"Format invalide",description:"Le temps doit être au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(Y&&!v.trim()){f({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const u={athlete_id:c,competition_id:L&&L!=="none"?L:null,event_code:Q?o:null,pool_length:Q?Number(y):null,target_time_seconds:Q&&m?Ge(m):null,text:Y?v.trim():null};x?i.mutate(u):b.mutate(u)},D=b.isPending||i.isPending||I.isPending,A=l.useMemo(()=>{const u=new Date;return u.setHours(0,0,0,0),g.filter(E=>new Date(E.date+"T00:00:00").getTime()>=u.getTime())},[g]);return e.jsxs(e.Fragment,{children:[e.jsx(ve,{open:s,onOpenChange:T,children:e.jsxs(ye,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(be,{children:e.jsx(Ne,{children:x?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:n})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Type d'objectif"}),e.jsxs(Le,{type:"single",variant:"outline",value:p,onValueChange:u=>{u&&h(u)},className:"justify-start",children:[e.jsx(X,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(X,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(X,{value:"both",className:"text-xs",children:"Les deux"})]})]}),Q&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Epreuve *"}),e.jsxs(Z,{value:o,onValueChange:j,children:[e.jsx(ee,{children:e.jsx(se,{placeholder:"Choisir une epreuve"})}),e.jsx(te,{children:ms.map(u=>e.jsx(B,{value:u,children:Xe(u)},u))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Bassin"}),e.jsxs(Z,{value:y,onValueChange:t,children:[e.jsx(ee,{children:e.jsx(se,{})}),e.jsxs(te,{children:[e.jsx(B,{value:"25",children:"25m"}),e.jsx(B,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(ie,{placeholder:"Ex : 1:05:30",value:m,onChange:u=>C(u.target.value)})]})]}),Y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Objectif texte *"}),e.jsx(Je,{placeholder:"Ex : Ameliorer la coulée de dos",value:v,onChange:u=>w(u.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Lier a une competition"}),e.jsxs(Z,{value:L,onValueChange:q,children:[e.jsx(ee,{children:e.jsx(se,{placeholder:"Aucune"})}),e.jsxs(te,{children:[e.jsx(B,{value:"none",children:"Aucune"}),A.map(u=>e.jsxs(B,{value:u.id,children:[u.name," (",u.date,")"]},u.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(k,{className:"w-full",onClick:S,disabled:D,children:D?"Enregistrement...":x?"Enregistrer":"Creer"}),x&&e.jsx(k,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>F(!0),disabled:D,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(de,{open:_,onOpenChange:F,children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Supprimer l'objectif"}),e.jsx(pe,{children:"Cette action est irreversible. L'objectif sera supprime definitivement."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(je,{onClick:()=>{I.mutate(),F(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Ys=({objective:s,onEdit:r})=>{const a=!!s.event_code,n=!!s.text;return e.jsxs("button",{type:"button",className:"w-full text-left rounded-xl border bg-card p-3 space-y-1.5 transition-colors hover:bg-muted/50",onClick:()=>r(s),children:[a&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:Xe(s.event_code)}),s.pool_length&&e.jsxs(H,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[s.pool_length,"m"]}),s.target_time_seconds!=null&&e.jsx(H,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:Ze(s.target_time_seconds)})]}),n&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.text}),s.competition_name&&e.jsx(H,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:s.competition_name})]})},Ws=({onBack:s,athletes:r,athletesLoading:a})=>{const{toast:n}=W(),[c,g]=l.useState(""),[f,d]=l.useState(!1),[x,p]=l.useState(null),h=l.useMemo(()=>c?r.find(_=>_.id!=null&&String(_.id)===c)??null:null,[r,c]),{data:o,isLoading:j}=V({queryKey:["auth-uid",c],queryFn:()=>Us(Number(c)),enabled:!!c}),{data:y=[]}=V({queryKey:["competitions"],queryFn:()=>M.getCompetitions()}),{data:t=[],isLoading:m}=V({queryKey:["objectives",o],queryFn:()=>M.getObjectives(o),enabled:!!o}),C=l.useMemo(()=>{const _=r.filter(T=>T.id!=null),F=new Map;for(const T of _){const b=T.group_label||"Sans groupe";F.has(b)||F.set(b,[]),F.get(b).push(T)}return[...F.entries()].sort(([T],[b])=>T.localeCompare(b,"fr"))},[r]),v=()=>{if(!o){n({title:"Nageur requis",description:"Veuillez selectionner un nageur.",variant:"destructive"});return}p(null),d(!0)},w=_=>{p(_),d(!0)},L=a||!!c&&j,q=!!o&&!j;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ne,{title:"Objectifs",description:"Definissez des objectifs chrono ou texte pour chaque nageur.",onBack:s,actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:v,disabled:!o,children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Nageur"}),e.jsxs(Z,{value:c,onValueChange:g,children:[e.jsx(ee,{children:e.jsx(se,{placeholder:"Selectionner un nageur"})}),e.jsx(te,{children:C.map(([_,F])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:_}),F.map(T=>e.jsx(B,{value:String(T.id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:T.display_name}),T.group_label&&e.jsx(H,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:T.group_label})]})},T.id))]},_))})]})]}),!c&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ze,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selectionnez un nageur pour voir et gerer ses objectifs."})]}),L&&c&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(_=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},_))}),q&&m&&e.jsx("div",{className:"space-y-2",children:[1,2].map(_=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},_))}),q&&!m&&t.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ze,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif defini pour ",h?.display_name,"."]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:v,children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer le premier objectif"]})]}),q&&!m&&t.length>0&&e.jsx("div",{className:"space-y-2",children:t.map(_=>e.jsx(Ys,{objective:_,onEdit:w},_.id))}),o&&h&&e.jsx(Hs,{open:f,onOpenChange:d,objective:x,athleteName:h.display_name,athleteAuthId:o,competitions:y})]})},Js=l.lazy(()=>We(()=>import("./StrengthCatalog-C_kh1QDa.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33]))),Xs=l.lazy(()=>We(()=>import("./SwimCatalog-DU2o01TQ.js"),__vite__mapDeps([34,1,2,3,4,5,6,7,18,19,9,10,11,12,13,21,16,35,36,37,38,39,23,15,24,25,26,27,28,17,31,40,30,41]))),Zs=({onNavigate:s,onOpenRecordsAdmin:r,onOpenRecordsClub:a,athletes:n,athletesLoading:c,upcomingBirthdays:g,birthdaysLoading:f,kpiLoading:d,kpiPeriod:x,onKpiPeriodChange:p,fatigueAlerts:h,mostLoadedAthlete:o,swimSessionCount:j,strengthSessionCount:y})=>{const t=new Date().getHours(),m=t<12?"Bonjour":t<18?"Bon après-midi":"Bonsoir",C=new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),v=h.length>0;return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-display font-bold uppercase italic",children:[m,", ",e.jsx("span",{className:"text-primary",children:"Coach"})]}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:C})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Signaux · ",x,"j"]}),e.jsxs(Le,{type:"single",size:"sm",variant:"outline",value:String(x),onValueChange:w=>{w&&p(Number(w))},children:[e.jsx(X,{value:"7",className:"h-7 px-2 text-xs","aria-label":"7 jours",children:"7j"}),e.jsx(X,{value:"30",className:"h-7 px-2 text-xs","aria-label":"30 jours",children:"30j"}),e.jsx(X,{value:"365",className:"h-7 px-2 text-xs","aria-label":"1 an",children:"1an"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:`rounded-xl border p-3 ${v?"border-destructive/30 bg-destructive/5":"bg-muted/30"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Fatigue 5/5"}),e.jsx(As,{className:`h-3.5 w-3.5 ${v?"text-destructive":"text-muted-foreground"}`})]}),e.jsx("p",{className:"text-xl font-bold tabular-nums",children:d?"–":h.length}),e.jsx("p",{className:"text-[11px] text-muted-foreground truncate",children:d?"Chargement…":v?h.slice(0,2).map(w=>w.athleteName.split(" ")[0]).join(", "):"Aucune alerte"})]}),e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Plus chargé"}),e.jsx(Ce,{className:"h-3.5 w-3.5 text-muted-foreground"})]}),e.jsx("p",{className:"text-xl font-bold truncate",children:d?"–":o?.athleteName?.split(" ")[0]??"–"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:d?"Calcul…":o?`Charge ${Math.round(o.loadScore)}`:"Pas de données"})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>s("calendar"),className:"flex items-center gap-1.5 rounded-full bg-primary text-primary-foreground px-3.5 py-2 text-sm font-semibold active:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(Ee,{className:"h-3.5 w-3.5"}),"Assigner"]}),e.jsxs("button",{type:"button",onClick:()=>s("messaging"),className:"flex items-center gap-1.5 rounded-full border px-3.5 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(Pe,{className:"h-3.5 w-3.5"}),"Email"]}),e.jsxs("button",{type:"button",onClick:()=>s("groups"),className:"flex items-center gap-1.5 rounded-full border px-3.5 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(ss,{className:"h-3.5 w-3.5"}),"Groupes"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>s("swim"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(He,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Natation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:j!=null?`${j} séance${j!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("strength"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Ye,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Musculation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y!=null?`${y} séance${y!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("swimmers"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Nageurs"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:c?"Chargement…":`${n.length} nageur${n.length!==1?"s":""}`})]}),e.jsxs("button",{type:"button",onClick:r,className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(qe,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Records club"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Import & administration"})]}),e.jsxs("button",{type:"button",onClick:()=>s("competitions"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(qe,{className:"h-5 w-5 text-amber-500 mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Compétitions"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Échéances & calendrier"})]}),e.jsxs("button",{type:"button",onClick:()=>s("objectives"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ze,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Objectifs"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Temps cibles & objectifs"})]})]}),e.jsx("button",{type:"button",onClick:a,className:"w-full text-center text-sm text-primary font-semibold py-1 active:opacity-70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded",children:"Voir les records du club"}),!f&&g&&g.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Anniversaires"}),e.jsx("div",{className:"space-y-1.5",children:g.slice(0,3).map(w=>e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-lg border px-3 py-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:"text-sm font-medium truncate block",children:w.display_name}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:et(w.next_birthday)})]}),e.jsxs("span",{className:"text-xs font-bold text-primary shrink-0",children:["J-",w.days_until]})]},w.id))})]}):null]})},et=s=>{if(!s)return"-";const r=new Date(s);return Number.isNaN(r.getTime())?s:r.toLocaleDateString("fr-FR")},Ue=s=>s.toISOString().split("T")[0],st=s=>new Date(s.completed_at||s.started_at||s.date||s.created_at||0).getTime(),tt=s=>{if(!s.length)return null;const r=s.reduce((n,c)=>n+c,0)/s.length,a=Math.min(5,Math.max(1,Math.round(r/10*5)));return{average:r,rating:a}};function Ft(){const s=Ie(i=>i.role),r=Ie(i=>i.setSelectedAthlete),[,a]=ds(),[n,c]=l.useState("home"),[g,f]=l.useState(7);l.useEffect(()=>{const i=()=>c("home");return window.addEventListener("nav:reset",i),()=>window.removeEventListener("nav:reset",i)},[]);const d=s==="coach"||s==="admin",x=n==="home"||n==="calendar",p=n==="home"||n==="messaging"||n==="swimmers"||n==="calendar"||n==="groups"||n==="objectives",h=n==="messaging"||n==="calendar"||n==="groups",o=n==="home"||n==="swimmers",{data:j}=V({queryKey:["swim_catalog"],queryFn:()=>M.getSwimCatalog(),enabled:d&&x}),{data:y}=V({queryKey:["strength_catalog"],queryFn:()=>M.getStrengthSessions(),enabled:d&&x}),{data:t=[],isLoading:m}=V({queryKey:["athletes"],queryFn:()=>M.getAthletes(),enabled:d&&p}),C=l.useMemo(()=>t.slice(0,5),[t]),{data:v=[]}=V({queryKey:["groups"],queryFn:()=>M.getGroups(),enabled:d&&h}),w=V({queryKey:["upcoming-birthdays"],queryFn:()=>M.getUpcomingBirthdays({days:30}),enabled:d&&o}),L=w.data,q=V({queryKey:["coach-kpis",g,C.map(i=>i.id??i.display_name)],enabled:d&&n==="home"&&C.length>0,queryFn:async()=>{const i=g,I=new Date;I.setDate(I.getDate()-i);const Q=Ue(I),Y=Ue(new Date),S=await Promise.all(C.map(async u=>{const[E,O]=await Promise.all([M.getSessions(u.display_name,u.id),M.getStrengthHistory(u.display_name,{athleteId:u.id,limit:50,from:Q,to:Y})]),N=E.filter(z=>new Date(z.date).getTime()>=I.getTime()),K=N.map(z=>z.fatigue??z.feeling).filter(z=>Number.isFinite(z)),$=N.reduce((z,J)=>z+(Number(J.duration)||0)*(Number(J.effort)||0),0),G=(O?.runs??[]).filter(z=>st(z)>=I.getTime()),oe=G.map(z=>z.fatigue??z.feeling??z.rpe).filter(z=>Number.isFinite(Number(z))).map(z=>Number(z)),ce=G.reduce((z,J)=>{const $e=Number(J.feeling??J.rpe??0),Re=Number(J.duration??0);if(Re>0&&$e>0)return z+Re*$e;const rs=Array.isArray(J.logs)?J.logs.length:0;return z+rs*5},0),as=tt([...K,...oe]);return{athleteName:u.display_name,loadScore:$+ce,fatigueRating:as}})),D=S.filter(u=>u.fatigueRating?.rating===5).map(u=>({athleteName:u.athleteName,rating:u.fatigueRating?.rating??0})),A=S.filter(u=>u.loadScore>0).sort((u,E)=>E.loadScore-u.loadScore)[0];return{fatigueAlerts:D,mostLoadedAthlete:A??null}}}),_=i=>{r({id:i.id??null,name:i.display_name}),a("/progress")},{toast:F}=W(),T=le(),b=R({mutationFn:async i=>{const I=await M.importSingleSwimmer(i.iuf,i.name);return await M.recalculateClubRecords(),I},onSuccess:i=>{F({title:"Import terminé",description:`${i.total_found} trouvées, ${i.new_imported} nouvelles.`}),T.invalidateQueries({queryKey:["club-records"]})},onError:i=>{F({title:"Erreur import",description:i.message,variant:"destructive"})}});return d?e.jsxs("div",{className:"space-y-6",children:[n==="home"?e.jsx(Zs,{onNavigate:c,onOpenRecordsAdmin:()=>a("/records-admin"),onOpenRecordsClub:()=>a("/records-club"),athletes:t,athletesLoading:m,upcomingBirthdays:L,birthdaysLoading:w.isLoading,kpiLoading:q.isLoading,kpiPeriod:g,onKpiPeriodChange:f,fatigueAlerts:q.data?.fatigueAlerts??[],mostLoadedAthlete:q.data?.mostLoadedAthlete??null,swimSessionCount:j?.length,strengthSessionCount:y?.length}):null,n==="swim"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ne,{title:"Bibliothèque natation",description:"Accédez aux séances et aux templates natation.",onBack:()=>c("home"),actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>c("calendar"),children:[e.jsx(Ee,{className:"mr-1.5 h-3.5 w-3.5"}),"Assigner"]})}),e.jsx(l.Suspense,{fallback:e.jsx(Ke,{}),children:e.jsx(Xs,{})})]}):null,n==="strength"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ne,{title:"Bibliothèque musculation",description:"Consultez et créez des séances musculation.",onBack:()=>c("home"),actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>c("calendar"),children:[e.jsx(Ee,{className:"mr-1.5 h-3.5 w-3.5"}),"Assigner"]})}),e.jsx(l.Suspense,{fallback:e.jsx(Ke,{}),children:e.jsx(Js,{})})]}):null,n==="swimmers"?e.jsxs("div",{className:"space-y-4",children:[e.jsx(ne,{title:"Nageurs",description:m?"Chargement…":`${t.length} nageur${t.length!==1?"s":""} inscrit${t.length!==1?"s":""}`,onBack:()=>c("home"),actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:()=>c("messaging"),children:[e.jsx(Pe,{className:"mr-1.5 h-3.5 w-3.5"}),"Email"]})}),m?e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(i=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-8 w-16 rounded bg-muted"})]})},i))}):t.length?e.jsx("div",{className:"space-y-2",children:t.map(i=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:i.display_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[i.group_label?e.jsx(H,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:i.group_label}):null,i.ffn_iuf?e.jsx("span",{className:"text-[10px] font-mono text-muted-foreground",children:i.ffn_iuf}):null]})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[i.ffn_iuf?e.jsx(k,{size:"icon",variant:"ghost",className:"h-8 w-8",disabled:b.isPending,onClick:()=>b.mutate({iuf:i.ffn_iuf,name:i.display_name}),title:"Importer performances FFN",children:e.jsx(us,{className:"h-4 w-4"})}):null,e.jsx(k,{size:"sm",variant:"outline",onClick:()=>_(i),children:"Fiche"})]})]},i.id??i.display_name))}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun nageur disponible."})]}):null,n==="messaging"?e.jsx(qs,{onBack:()=>c("home"),athletes:t,groups:v,athletesLoading:m}):null,n==="calendar"?e.jsx(Ps,{onBack:()=>c("home"),athletes:t,groups:v,swimSessions:j,strengthSessions:y}):null,n==="groups"?e.jsx(Ks,{onBack:()=>c("home"),athletes:t,groups:v,athletesLoading:m}):null,n==="competitions"?e.jsx(Qs,{onBack:()=>c("home")}):null,n==="objectives"?e.jsx(Ws,{onBack:()=>c("home"),athletes:t,athletesLoading:m}):null]}):e.jsx("div",{className:"flex items-center justify-center min-h-[60vh] animate-in fade-in motion-reduce:animate-none",children:e.jsxs(Me,{className:"w-full max-w-sm shadow-xl border-t-4 border-t-primary",children:[e.jsxs(De,{children:[e.jsxs(Ae,{className:"flex items-center gap-2 uppercase italic",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),"Accès Coach"]}),e.jsx(Te,{children:"Cette section est réservée aux coachs et administrateurs."})]}),e.jsx(Fe,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connectez-vous avec un compte autorisé pour accéder aux outils de gestion."})})]})})}export{Ft as default};
