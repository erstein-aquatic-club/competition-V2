import{r as o,u as D,j as e,c as Ne,d as U,f as hs}from"./vendor-query-DyA9aSKS.js";import{B as M,d as _e,L as G,I as Ee,s as Je,X as gs,A as fs,T as js,M as ys,b as bs,u as vs}from"./index-DRUe19Fh.js";import{a as h}from"./api-DX18pG5A.js";import{T as Ns,a as _s,b as Ce,c as we}from"./tabs-DjDkKlQm.js";import{B as R}from"./badge-cLHVyF4A.js";import{C as Xe,w as Ye,a as Ze,S as Ie,G as es,b as Cs}from"./SwimmerFeedbackTab-DgJ20CuP.js";import{T as Le}from"./textarea-DqM0jZCo.js";import{S as re,a as ie,b as le,c as ce,d as Y}from"./select-ClQDu0AH.js";import{T as ws,a as Fe}from"./toggle-group-BGiXJTCR.js";import{S as ss,a as ts,b as ns,c as as}from"./sheet-Dv2VsjOk.js";import{A as oe,a as de,b as ue,c as me,d as xe,e as pe,f as he,g as ge}from"./alert-dialog-Cn2NUika.js";import{s as rs,a as is,c as ls,d as Ss,S as cs,e as Ke,f as ve,b as ks,F as Ts,p as Ue}from"./objectiveHelpers-BZkbUkU3.js";import{P as je}from"./plus-BOcAN5Ut.js";import{T as qe,M as os,A as Ds}from"./target-BZlY_5ka.js";import{T as $e}from"./trash-2-BVw-E_gU.js";import{t as Pe}from"./date-DrpgLmFD.js";import{C as Es}from"./copy-CpdcNBlp.js";import{C as qs}from"./index-deG5ocwF.js";import{P as Fs}from"./pencil-BejqmKDI.js";import{C as As,a as Ps,b as Ms}from"./collapsible-Cq20navw.js";import{S as Os,b as Ls,c as Ks}from"./smsUtils-Cywn-5bm.js";import{C as $s}from"./chevron-up-CK181H0Z.js";import{C as Ws}from"./chevron-down-DKpemGEu.js";import{C as ds}from"./clock-CKulKsbQ.js";import{C as Rs}from"./chevron-right-6N-eCPmJ.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./swim-CiRwn91C.js";import"./index-DUC-c-GA.js";import"./index-DMRSoOOq.js";import"./chart-column-BdUnkRAu.js";import"./index-DCX2sNhR.js";import"./index-CoGuN-7-.js";import"./vendor-date-B8Mnp-Vt.js";async function zs(s){const{data:t,error:n}=await Je.rpc("get_auth_uid_for_user",{p_user_id:s});return n?(console.error("[objectives-tab] Failed to resolve auth UUID:",n.message),null):t}const Is=({open:s,onOpenChange:t,objective:n,athleteName:i,athleteAuthId:u,competitions:l})=>{const{toast:a}=_e(),d=Ne(),b=!!n,[j,_]=o.useState("chrono"),[f,N]=o.useState(""),[C,x]=o.useState("25"),[F,E]=o.useState(""),[T,q]=o.useState(""),[y,B]=o.useState(""),[W,Q]=o.useState(!1);o.useEffect(()=>{if(s)if(n){const c=!!n.event_code,O=!!n.text;_(c&&O?"both":O?"texte":"chrono"),N(n.event_code??""),x(String(n.pool_length??25)),E(n.target_time_seconds!=null?ve(n.target_time_seconds):""),q(n.text??""),B(n.competition_id??"")}else _("chrono"),N(""),x("25"),E(""),q(""),B("")},[s,n]);const m=U({mutationFn:c=>h.createObjective(c),onSuccess:()=>{a({title:"Objectif crÃ©Ã©"}),d.invalidateQueries({queryKey:["objectives",u]}),t(!1)},onError:c=>{a({title:"Erreur",description:c.message,variant:"destructive"})}}),g=U({mutationFn:c=>h.updateObjective(n.id,c),onSuccess:()=>{a({title:"Objectif mis Ã  jour"}),d.invalidateQueries({queryKey:["objectives",u]}),t(!1)},onError:c=>{a({title:"Erreur",description:c.message,variant:"destructive"})}}),p=U({mutationFn:()=>h.deleteObjective(n.id),onSuccess:()=>{a({title:"Objectif supprimÃ©"}),d.invalidateQueries({queryKey:["objectives",u]}),t(!1)},onError:c=>{a({title:"Erreur",description:c.message,variant:"destructive"})}}),A=j==="chrono"||j==="both",L=j==="texte"||j==="both",K=()=>{if(A&&!f){a({title:"Ã‰preuve requise",description:"Veuillez sÃ©lectionner une Ã©preuve.",variant:"destructive"});return}if(A&&F&&Ue(F)===null){a({title:"Format invalide",description:"Le temps doit Ãªtre au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(L&&!T.trim()){a({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const c={athlete_id:u,competition_id:y&&y!=="none"?y:null,event_code:A?f:null,pool_length:A?Number(C):null,target_time_seconds:A&&F?Ue(F):null,text:L?T.trim():null};b?g.mutate(c):m.mutate(c)},$=m.isPending||g.isPending||p.isPending,w=o.useMemo(()=>{const c=new Date;return c.setHours(0,0,0,0),l.filter(O=>new Date(O.date+"T00:00:00").getTime()>=c.getTime())},[l]);return e.jsxs(e.Fragment,{children:[e.jsx(ss,{open:s,onOpenChange:t,children:e.jsxs(ts,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(ns,{children:e.jsx(as,{children:b?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Type d'objectif"}),e.jsxs(ws,{type:"single",variant:"outline",value:j,onValueChange:c=>{c&&_(c)},className:"justify-start",children:[e.jsx(Fe,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(Fe,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(Fe,{value:"both",className:"text-xs",children:"Les deux"})]})]}),A&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Ã‰preuve *"}),e.jsxs(re,{value:f,onValueChange:N,children:[e.jsx(ie,{children:e.jsx(le,{placeholder:"Choisir une Ã©preuve"})}),e.jsx(ce,{children:Ts.map(c=>e.jsx(Y,{value:c,children:Ke(c)},c))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Bassin"}),e.jsxs(re,{value:C,onValueChange:x,children:[e.jsx(ie,{children:e.jsx(le,{})}),e.jsxs(ce,{children:[e.jsx(Y,{value:"25",children:"25m"}),e.jsx(Y,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Temps cible (min:sec:centiÃ¨mes)"}),e.jsx(Ee,{placeholder:"Ex : 1:05:30",value:F,onChange:c=>E(c.target.value)})]})]}),L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Objectif texte *"}),e.jsx(Le,{placeholder:"Ex : AmÃ©liorer la coulÃ©e de dos",value:T,onChange:c=>q(c.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Lier Ã  une compÃ©tition"}),e.jsxs(re,{value:y,onValueChange:B,children:[e.jsx(ie,{children:e.jsx(le,{placeholder:"Aucune"})}),e.jsxs(ce,{children:[e.jsx(Y,{value:"none",children:"Aucune"}),w.map(c=>e.jsxs(Y,{value:c.id,children:[c.name," (",c.date,")"]},c.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(M,{className:"w-full",onClick:K,disabled:$,children:$?"Enregistrement...":b?"Enregistrer":"CrÃ©er"}),b&&e.jsx(M,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>Q(!0),disabled:$,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(oe,{open:W,onOpenChange:Q,children:e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Supprimer l'objectif"}),e.jsx(xe,{children:"Cette action est irrÃ©versible. L'objectif sera supprimÃ© dÃ©finitivement."})]}),e.jsxs(pe,{children:[e.jsx(he,{children:"Annuler"}),e.jsx(ge,{onClick:()=>{p.mutate(),Q(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function Us(s){const t=s.split("-");return t.length===3?`${t[2]}/${t[1]}/${t[0]}`:s}const Bs=({objective:s,performances:t,onEdit:n})=>{const i=s.event_code?rs(s.event_code):null,u=i?cs[i]??"":"",l=s.event_code?is(t,s.event_code,s.pool_length):null;let a=null,d=null;l&&s.target_time_seconds!=null&&s.event_code&&(a=l.time-s.target_time_seconds,d=ls(l.time,s.target_time_seconds,s.event_code));const b=!!s.competition_name,j=s.competition_date?Ss(s.competition_date):null;return e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card p-3 text-sm space-y-1.5 transition-colors hover:bg-muted/50 ${u?`border-l-4 ${u}`:""}`,onClick:()=>n(s),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(qe,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-center gap-1.5 flex-wrap",children:[s.event_code&&e.jsx("span",{className:"font-medium",children:Ke(s.event_code)}),s.event_code&&s.pool_length&&e.jsxs("span",{className:"text-muted-foreground",children:["(",s.pool_length,"m)"]}),s.target_time_seconds!=null&&e.jsx("span",{className:"font-mono text-xs text-primary",children:ve(s.target_time_seconds)})]}),e.jsx($e,{className:"h-3.5 w-3.5 text-muted-foreground/40 shrink-0"})]}),s.text&&e.jsx("p",{className:"text-muted-foreground text-xs pl-5 line-clamp-2",children:s.text}),s.event_code&&l&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:ve(l.time)})]}),l.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",Us(l.date),")"]}),a!=null&&e.jsx("span",{className:a<=0?"text-emerald-600 font-medium":"text-amber-600",children:a<=0?"Objectif atteint !":`+${a.toFixed(2)}s`})]}),s.event_code&&!l&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"}),d!=null&&e.jsx("div",{className:"pl-5 pr-1",children:e.jsx("div",{className:"h-1.5 w-full rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${ks(d)}`,style:{width:`${Math.min(d,100)}%`}})})}),b&&e.jsx("div",{className:"pl-5",children:e.jsxs(R,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:[s.competition_name,j!=null&&j>0&&e.jsxs("span",{className:"ml-1 font-bold",children:["J-",j]})]})})]})},Qs=({athleteId:s,athleteName:t})=>{const[n,i]=o.useState(!1),[u,l]=o.useState(null),{data:a,isLoading:d}=D({queryKey:["auth-uid",s],queryFn:()=>zs(s),enabled:!!s}),{data:b=[]}=D({queryKey:["competitions"],queryFn:()=>h.getCompetitions()}),{data:j=[],isLoading:_}=D({queryKey:["objectives",a],queryFn:()=>h.getObjectives(a),enabled:!!a}),{data:f}=D({queryKey:["profile",s],queryFn:()=>h.getProfile({userId:s}),enabled:!!s}),N=f?.ffn_iuf??null,C=o.useMemo(()=>{const y=new Date;return y.setDate(y.getDate()-360),y.toISOString().slice(0,10)},[]),{data:x=[]}=D({queryKey:["swimmer-performances-recent",N],queryFn:()=>h.getSwimmerPerformances({iuf:N,fromDate:C}),enabled:!!N}),F=()=>{l(null),i(!0)},E=y=>{l(y),i(!0)},T=d,q=!!a&&!d;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(M,{variant:"outline",size:"sm",onClick:F,disabled:!a,children:[e.jsx(je,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter un objectif"]})}),T&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},y))}),q&&_&&e.jsx("div",{className:"space-y-2",children:[1,2].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},y))}),q&&!_&&j.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(qe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif dÃ©fini pour ",t,"."]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:F,children:[e.jsx(je,{className:"mr-1.5 h-3.5 w-3.5"}),"CrÃ©er le premier objectif"]})]}),q&&!_&&j.length>0&&e.jsxs("div",{className:"space-y-2",children:[j.map(y=>e.jsx(Bs,{objective:y,performances:x,onEdit:E},y.id)),e.jsx("p",{className:"text-[10px] text-muted-foreground/60 italic text-center pt-1",children:"Les temps Â« Actuel Â» correspondent Ã  la meilleure performance des 360 derniers jours sur l'Ã©preuve."})]}),a&&e.jsx(Is,{open:n,onOpenChange:i,objective:u,athleteName:t,athleteAuthId:a,competitions:b})]})},Me="__today__";function Oe(s,t){const n=[],i=new Date(s+"T00:00:00"),u=new Date(t+"T00:00:00"),l=new Date(i),a=l.getDay(),d=a===0?1:a===1?0:8-a;for(l.setDate(l.getDate()+d);l<=u;)n.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return n}function be(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Se(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Vs(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Gs(s){const t=new Date;t.setHours(0,0,0,0);const n=new Date(s+"T00:00:00"),i=new Date(s+"T00:00:00");return i.setDate(i.getDate()+6),t>=n&&t<=i}const Hs=({athleteId:s})=>{const{toast:t}=_e(),n=Ne(),[i,u]=o.useState(null),[l,a]=o.useState(null),[d,b]=o.useState(""),[j,_]=o.useState(""),[f,N]=o.useState(!1),[C,x]=o.useState(!1),[F,E]=o.useState(!1),[T,q]=o.useState(""),[y,B]=o.useState(""),[W,Q]=o.useState(""),{data:m=[]}=D({queryKey:["athletes"],queryFn:()=>h.getAthletes()}),g=o.useMemo(()=>m.find(k=>k.id===s)?.group_id??null,[m,s]),{data:p=[],isLoading:A}=D({queryKey:["training-cycles","athlete",s],queryFn:()=>h.getTrainingCycles({athleteId:s})}),{data:L=[],isLoading:K}=D({queryKey:["training-cycles","group",g],queryFn:()=>h.getTrainingCycles({groupId:g}),enabled:g!=null}),$=p.length===0&&L.length>0,w=p.length>0?p:L;o.useEffect(()=>{w.length>0&&(!i||!w.find(r=>r.id===i))&&u(w[0].id)},[w,i]);const c=w.find(r=>r.id===i)??null,{data:O=[],isLoading:se}=D({queryKey:["training-weeks",i],queryFn:()=>h.getTrainingWeeks(i),enabled:!!i}),{data:S=[]}=D({queryKey:["competitions"],queryFn:()=>h.getCompetitions()}),P=o.useMemo(()=>[...S].sort((r,k)=>r.date.localeCompare(k.date)),[S]),z=o.useMemo(()=>{const r=new Set;return O.forEach(k=>{k.week_type&&r.add(k.week_type)}),Array.from(r).sort()},[O]),I=c?.start_competition_date??c?.start_date??null,v=o.useMemo(()=>{if(!c)return[];const r=I,k=c.end_competition_date;return!r||!k?[]:Oe(r,k)},[c,I]),ee=o.useMemo(()=>{const r=new Map;return O.forEach(k=>r.set(k.week_start,k)),r},[O]),te=A||K,ne=U({mutationFn:async r=>{const k=await h.createTrainingCycle(r),V=r.start_date??S.find(J=>J.id===r.start_competition_id)?.date,H=S.find(J=>J.id===r.end_competition_id);if(V&&H){const J=Oe(V,H.date);J.length>0&&await h.bulkUpsertTrainingWeeks(J.map(ye=>({cycle_id:k.id,week_start:ye})))}return k},onSuccess:r=>{t({title:"Cycle cree"}),u(r.id),N(!1),q(""),B(""),Q(""),n.invalidateQueries({queryKey:["training-cycles"]}),n.invalidateQueries({queryKey:["training-weeks",r.id]})},onError:r=>{t({title:"Erreur",description:r.message,variant:"destructive"})}}),ae=U({mutationFn:r=>h.deleteTrainingCycle(r),onSuccess:()=>{t({title:"Cycle supprime"}),u(null),x(!1),n.invalidateQueries({queryKey:["training-cycles"]})},onError:r=>{t({title:"Erreur",description:r.message,variant:"destructive"})}}),We=U({mutationFn:r=>h.upsertTrainingWeek(r),onSuccess:()=>{a(null),n.invalidateQueries({queryKey:["training-weeks",i]})},onError:r=>{t({title:"Erreur",description:r.message,variant:"destructive"})}}),Re=U({mutationFn:async()=>{for(const r of L){const k=await h.createTrainingCycle({athlete_id:s,group_id:null,start_competition_id:r.start_competition_id,end_competition_id:r.end_competition_id,name:r.name,notes:r.notes}),V=await h.getTrainingWeeks(r.id);V.length>0&&await h.bulkUpsertTrainingWeeks(V.map(H=>({cycle_id:k.id,week_start:H.week_start,week_type:H.week_type,notes:H.notes})))}},onSuccess:()=>{t({title:"Planification personnalisee"}),E(!1),u(null),n.invalidateQueries({queryKey:["training-cycles"]})},onError:r=>{t({title:"Erreur",description:r.message,variant:"destructive"})}}),ze=()=>{if(!T.trim()){t({title:"Nom requis",variant:"destructive"});return}if(!y||!W){t({title:"Dates requises",description:"Choisis un debut et une fin.",variant:"destructive"});return}const r=y===Me,k=r?Pe(new Date):null,V=r?null:S.find(ye=>ye.id===y),H=S.find(ye=>ye.id===W),J=r?k:V?.date;if(J&&H&&H.date<=J){t({title:"Dates invalides",description:"La fin doit etre apres le debut.",variant:"destructive"});return}ne.mutate({athlete_id:s,group_id:null,start_competition_id:r?null:y,end_competition_id:W,start_date:k,name:T.trim()})},us=r=>{a(r.id),b(r.week_type??""),_(r.notes??"")},ms=r=>{a(`new:${r}`),b(""),_("")},xs=(r,k)=>{i&&We.mutate({cycle_id:i,week_start:r,week_type:d.trim()||null,notes:j.trim()||null})},ps=()=>{a(null)};return!te&&w.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Xe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun cycle pour ce nageur."}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>N(!0),children:[e.jsx(je,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau cycle"]}),e.jsx(Be,{open:f,onOpenChange:N,competitions:P,name:T,setName:q,startId:y,setStartId:B,endId:W,setEndId:Q,onSubmit:ze,isPending:ne.isPending})]}):te?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(r=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-48 rounded bg-muted"})},r))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[w.length>1?e.jsxs(re,{value:i??"",onValueChange:u,children:[e.jsx(ie,{className:"w-auto min-w-[180px] h-8 text-sm",children:e.jsx(le,{placeholder:"Choisir un cycle"})}),e.jsx(ce,{children:w.map(r=>e.jsx(Y,{value:r.id,children:r.name},r.id))})]}):c?e.jsx("span",{className:"text-sm font-semibold",children:c.name}):null,$&&e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Planif. groupe"}),e.jsx("div",{className:"flex-1"}),$&&e.jsxs(M,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>E(!0),children:[e.jsx(Es,{className:"mr-1 h-3 w-3"}),"Personnaliser"]}),e.jsxs(M,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>N(!0),children:[e.jsx(je,{className:"mr-1 h-3 w-3"}),"Nouveau"]}),c&&!$&&e.jsx(M,{variant:"ghost",size:"sm",className:"text-xs h-7 text-destructive hover:text-destructive",onClick:()=>x(!0),children:e.jsx($e,{className:"h-3 w-3"})})]}),c&&e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:c.start_competition_id?"ðŸŠ":"ðŸ“…"}),e.jsx("span",{className:"text-sm font-medium",children:c.start_competition_id?c.start_competition_name??"Competition":"Debut du cycle"}),I&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",be(I),")"]})]}),e.jsx("div",{className:"relative ml-3 border-l-2 border-border pl-4 space-y-1",children:se?e.jsx("div",{className:"py-4",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"})}):v.map((r,k)=>{const V=ee.get(r),H=Gs(r),J=l===(V?.id??`new:${r}`);return e.jsx(Js,{monday:r,weekNumber:k+1,week:V,isCurrent:H,isEditing:J,isGroupPlan:$,editWeekType:d,setEditWeekType:b,editWeekNotes:j,setEditWeekNotes:_,existingWeekTypes:z,onStartEdit:()=>V?us(V):ms(r),onSave:()=>xs(r),onCancel:ps,isSaving:We.isPending},r)})}),e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:"ðŸŽ¯"}),e.jsx("span",{className:"text-sm font-medium",children:c.end_competition_name??"Competition"}),c.end_competition_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",be(c.end_competition_date),")"]})]})]}),e.jsx(Be,{open:f,onOpenChange:N,competitions:P,name:T,setName:q,startId:y,setStartId:B,endId:W,setEndId:Q,onSubmit:ze,isPending:ne.isPending}),e.jsx(oe,{open:C,onOpenChange:x,children:e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Supprimer le cycle"}),e.jsx(xe,{children:"Le cycle et ses semaines seront supprimes."})]}),e.jsxs(pe,{children:[e.jsx(he,{children:"Annuler"}),e.jsx(ge,{onClick:()=>i&&ae.mutate(i),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(oe,{open:F,onOpenChange:E,children:e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Personnaliser la planification"}),e.jsx(xe,{children:"Copie le plan du groupe pour ce nageur. Tu pourras ensuite l'ajuster."})]}),e.jsxs(pe,{children:[e.jsx(he,{children:"Annuler"}),e.jsx(ge,{onClick:()=>Re.mutate(),children:Re.isPending?"Copie...":"Personnaliser"})]})]})})]})},Js=({monday:s,weekNumber:t,week:n,isCurrent:i,isEditing:u,isGroupPlan:l,editWeekType:a,setEditWeekType:d,editWeekNotes:b,setEditWeekNotes:j,existingWeekTypes:_,onStartEdit:f,onSave:N,onCancel:C,isSaving:x})=>{const F=Vs(s),E=`week-types-${s}`;return u?e.jsxs("div",{className:`rounded-lg border bg-card p-3 space-y-2 ${i?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground",children:["Sem. ",t," (",Se(s)," - ",Se(F),")"]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(G,{className:"text-xs",children:"Type de semaine"}),e.jsx(Ee,{className:"h-7 text-sm",placeholder:"Ex : Foncier, Affutage",list:E,value:a,onChange:T=>d(T.target.value)}),e.jsx("datalist",{id:E,children:_.map(T=>e.jsx("option",{value:T},T))})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(G,{className:"text-xs",children:"Notes"}),e.jsx(Le,{className:"text-sm min-h-[48px]",placeholder:"Note optionnelle",rows:2,value:b,onChange:T=>j(T.target.value)})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(M,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:C,children:[e.jsx(gs,{className:"mr-1 h-3 w-3"}),"Annuler"]}),e.jsxs(M,{size:"sm",className:"h-7 text-xs",onClick:N,disabled:x,children:[e.jsx(qs,{className:"mr-1 h-3 w-3"}),x?"...":"Enregistrer"]})]})]}):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-3 py-2 flex items-center gap-2 transition-colors ${l?"cursor-default":"hover:bg-muted/50"} ${i?"ring-2 ring-primary":""}`,onClick:l?void 0:f,disabled:l,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-xs font-medium text-muted-foreground whitespace-nowrap",children:["Sem. ",t]}),e.jsxs("span",{className:"text-[10px] text-muted-foreground/70 whitespace-nowrap",children:["(",Se(s)," - ",Se(F),")"]}),n?.week_type&&e.jsx(R,{className:"text-[10px] px-1.5 py-0 border-0",style:{backgroundColor:Ze(n.week_type),color:Ye(n.week_type)},children:n.week_type})]}),n?.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:n.notes})]}),!l&&e.jsx(Fs,{className:"h-3 w-3 text-muted-foreground/40 shrink-0"})]})},Be=({open:s,onOpenChange:t,competitions:n,name:i,setName:u,startId:l,setStartId:a,endId:d,setEndId:b,onSubmit:j,isPending:_})=>(o.useEffect(()=>{s&&(u(""),a(""),b(""))},[s]),e.jsx(ss,{open:s,onOpenChange:t,children:e.jsxs(ts,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(ns,{children:e.jsx(as,{children:"Nouveau cycle"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Nom du cycle *"}),e.jsx(Ee,{placeholder:"Ex : Preparation hiver",value:i,onChange:f=>u(f.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Date de debut *"}),e.jsxs(re,{value:l,onValueChange:a,children:[e.jsx(ie,{children:e.jsx(le,{placeholder:"Choisir..."})}),e.jsxs(ce,{children:[e.jsxs(Y,{value:Me,children:["Aujourd'hui (",be(Pe(new Date)),")"]}),n.map(f=>e.jsxs(Y,{value:f.id,children:[f.name," (",be(f.date),")"]},f.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(G,{children:"Competition de fin *"}),e.jsxs(re,{value:d,onValueChange:b,children:[e.jsx(ie,{children:e.jsx(le,{placeholder:"Choisir..."})}),e.jsx(ce,{children:n.map(f=>e.jsxs(Y,{value:f.id,children:[f.name," (",be(f.date),")"]},f.id))})]})]}),l&&d&&(()=>{const N=l===Me?Pe(new Date):n.find(x=>x.id===l)?.date,C=n.find(x=>x.id===d);if(N&&C&&C.date>N){const x=Oe(N,C.date).length;return e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x," semaine",x>1?"s":""," seront generees."]})}return null})(),e.jsx(M,{className:"w-full",onClick:j,disabled:_,children:_?"Creation...":"Creer le cycle"})]})]})}));function fe(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function ke(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Xs(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Ys(s){const t=new Date;t.setHours(0,0,0,0);const n=new Date(s+"T00:00:00"),i=new Date(s+"T00:00:00");return i.setDate(i.getDate()+6),t>=n&&t<=i}function Ae(s,t){const n=[],i=new Date(s+"T00:00:00"),u=new Date(t+"T00:00:00"),l=new Date(i),a=l.getDay(),d=a===0?1:a===1?0:8-a;for(l.setDate(l.getDate()+d);l<=u;)n.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return n}function Qe(s,t){const n=new Date(s+"T00:00:00"),i=new Date(t+"T00:00:00");return Math.round((i.getTime()-n.getTime())/(1e3*60*60*24))}const Zs={draft_athlete:{label:"En attente nageur",variant:"secondary",className:"bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300 border-amber-200 dark:border-amber-800"},draft_coach:{label:"PrÃ©paration coach",variant:"secondary",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800"},sent:{label:"EnvoyÃ©",variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300 border-green-200 dark:border-green-800"},signed:{label:"SignÃ©",variant:"secondary",className:"bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-300 border-slate-200 dark:border-slate-700"}};function et(s){const t=Zs[s];return e.jsx(R,{variant:t.variant,className:`text-[10px] px-1.5 py-0 ${t.className}`,children:t.label})}async function st(s){const{data:t,error:n}=await Je.rpc("get_auth_uid_for_user",{p_user_id:s});return n?(console.error("[interviews-tab] Failed to resolve auth UUID:",n.message),null):t}const Z=({label:s,text:t})=>e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(fs,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),Te=({label:s,text:t})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(es,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),De=({label:s,value:t,onChange:n,onBlur:i,placeholder:u,rows:l=3})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(es,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s})]}),e.jsx(Le,{className:"bg-white dark:bg-background",placeholder:u,value:t,onChange:a=>n(a.target.value),onBlur:i,rows:l})]}),X=({label:s})=>e.jsxs("div",{className:"flex items-center gap-2 pt-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),Ve=({objective:s,performances:t=[]})=>{const n=!!s.event_code,i=!!s.text,u=n?rs(s.event_code):null,l=u?cs[u]??"":"",a=n?is(t,s.event_code,s.pool_length):null;let d=null;return a&&s.target_time_seconds!=null&&s.event_code&&(d=a.time-s.target_time_seconds,ls(a.time,s.target_time_seconds,s.event_code)),e.jsxs("div",{className:`rounded-lg border bg-card p-2.5 text-sm space-y-1 ${n?`border-l-4 ${l}`:""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(qe,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:n?Ke(s.event_code):""}),s.pool_length&&e.jsxs(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[s.pool_length,"m"]}),s.target_time_seconds!=null&&e.jsx(R,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:ve(s.target_time_seconds)})]}),i&&e.jsx("p",{className:"text-muted-foreground line-clamp-2 pl-5",children:s.text}),a&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:ve(a.time)})]}),a.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",fe(a.date),")"]}),d!=null&&e.jsx("span",{className:d<=0?"text-emerald-600 font-medium":"text-amber-600",children:d<=0?"Objectif atteint !":`+${d.toFixed(2)}s`})]}),!a&&n&&s.target_time_seconds!=null&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"})]})},Ge=({prevInterview:s,commitmentReview:t})=>{const[n,i]=o.useState(!1);return e.jsxs(As,{open:n,onOpenChange:i,children:[e.jsx(Ps,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Rs,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${n?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements prÃ©cÃ©dents"}),e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:fe(s.date)})]})}),e.jsx(Ms,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[s.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Engagements nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.athlete_commitments})]}),s.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.coach_actions})]}),t&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Bilan du nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t})]})]})})]})},He=({athleteId:s,interviewDate:t})=>{const{toast:n}=_e(),i=Ne(),{data:u=[]}=D({queryKey:["competitions"],queryFn:()=>h.getCompetitions()}),{data:l=[]}=D({queryKey:["my-competition-ids",s],queryFn:()=>h.getMyCompetitionIds(s)}),a=o.useMemo(()=>{const m=new Set(l);return u.filter(g=>m.has(g.id)).sort((g,p)=>g.date.localeCompare(p.date))},[u,l]),d=o.useMemo(()=>a.filter(m=>m.date>=t),[a,t]),{data:b=[]}=D({queryKey:["training-cycles","athlete",s],queryFn:()=>h.getTrainingCycles({athleteId:s})}),j=o.useMemo(()=>{const m=new Map;return b.slice().sort((g,p)=>(g.end_competition_date??"").localeCompare(p.end_competition_date??"")).forEach(g=>{g.end_competition_id&&!m.has(g.end_competition_id)&&m.set(g.end_competition_id,g)}),m},[b]),_=o.useMemo(()=>{const m=new Set;return d.map(g=>j.get(g.id)??null).filter(g=>!g||m.has(g.id)?!1:(m.add(g.id),!0))},[d,j]),f=hs({queries:_.map(m=>({queryKey:["training-weeks",m.id],queryFn:()=>h.getTrainingWeeks(m.id),enabled:!!m.id}))}),[N,C]=o.useState(null),[x,F]=o.useState(""),E=o.useMemo(()=>{const m=new Map;return _.forEach((g,p)=>{m.set(g.id,f[p]?.data??[])}),m},[_,f]),T=o.useMemo(()=>{const m=new Set;return E.forEach(g=>{g.forEach(p=>{p.week_type&&m.add(p.week_type)})}),Array.from(m).sort()},[E]),q=d[0]??null,y=o.useMemo(()=>new Date().toISOString().split("T")[0],[]),B=q?Qe(y,q.date):null,W=U({mutationFn:async m=>{const g=a.find(w=>w.id===m);if(!g)throw new Error("Pas de compÃ©tition");const p=a.findIndex(w=>w.id===m),A=p>0?a[p-1]:null,L=A?.date??t,K=await h.createTrainingCycle({athlete_id:s,group_id:null,start_competition_id:A?.id??null,start_date:A?null:t,end_competition_id:g.id,name:`PrÃ©paration ${g.name}`}),$=Ae(L,g.date);return $.length>0&&await h.bulkUpsertTrainingWeeks($.map(w=>({cycle_id:K.id,week_start:w}))),K},onSuccess:()=>{n({title:"Planification crÃ©Ã©e"}),i.invalidateQueries({queryKey:["training-cycles"]}),i.invalidateQueries({queryKey:["training-weeks"]})},onError:m=>{n({title:"Erreur",description:m.message,variant:"destructive"})}}),Q=U({mutationFn:m=>h.upsertTrainingWeek(m),onSuccess:()=>{C(null),i.invalidateQueries({queryKey:["training-weeks"]})},onError:m=>{n({title:"Erreur",description:m.message,variant:"destructive"})}});return q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(js,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsxs("span",{className:"font-medium",children:[d.length," Ã©chÃ©ance",d.length>1?"s":""," Ã  planifier"]}),B!=null&&e.jsxs(R,{variant:"secondary",className:"text-[10px]",children:["prochaine J-",B]})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Une carte par compÃ©tition cible pour construire et piloter plusieurs macrocycles Ã  l'avance."})]}),e.jsx("div",{className:"space-y-3",children:d.map((m,g)=>{const p=j.get(m.id)??null,A=p?E.get(p.id)??[]:[],L=new Map(A.map(S=>[S.week_start,S])),K=p?.start_date??p?.start_competition_date??t,$=K>t?K:t,w=p?Ae($,m.date):[],c=p?Ae(K,m.date):[],O=Math.max(c.length-w.length,0),se=Qe(y,m.date);return e.jsxs("div",{className:"rounded-xl border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border bg-muted/20 px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:m.name}),g===0&&e.jsx(R,{className:"text-[10px] bg-primary/10 text-primary border-primary/20",children:"PrioritÃ©"}),e.jsx(R,{variant:"secondary",className:"text-[10px]",children:fe(m.date)}),e.jsxs(R,{variant:"outline",className:"text-[10px]",children:["J-",se]})]}),p?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:p.name}),p.start_competition_name&&e.jsxs("span",{children:["depuis ",p.start_competition_name]}),e.jsxs("span",{children:[c.length," sem."]}),O>0&&e.jsxs("span",{children:[O," dÃ©jÃ  passÃ©es"]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Aucun macrocycle crÃ©Ã© pour cette Ã©chÃ©ance."})]}),p?w.length===0?e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"Aucune semaine future Ã  afficher sur ce macrocycle."}):e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1.5",children:w.map((S,P)=>{const z=L.get(S),I=Ys(S),v=Xs(S),ee=`${p.id}:${S}`,te=N===ee,ne=`inline-week-${p.id}-${S}`;return te?e.jsxs("div",{className:`rounded-lg border bg-card p-2 space-y-1.5 ${I?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Sem. ",O+P+1," (",ke(S)," - ",ke(v),")"]}),e.jsx(Ee,{className:"h-7 text-sm",placeholder:"Foncier, Techni., AffÃ»tage...",list:ne,value:x,onChange:ae=>F(ae.target.value)}),e.jsx("datalist",{id:ne,children:T.map(ae=>e.jsx("option",{value:ae},ae))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(M,{variant:"ghost",size:"sm",className:"h-6 text-xs px-2",onClick:()=>C(null),children:"Annuler"}),e.jsx(M,{size:"sm",className:"h-6 text-xs px-2",onClick:()=>{Q.mutate({cycle_id:p.id,week_start:S,week_type:x.trim()||null,notes:z?.notes??null})},disabled:Q.isPending,children:"OK"})]})]},S):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-2.5 py-2 text-xs transition-colors hover:bg-muted/50 ${I?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>{C(ee),F(z?.week_type??"")},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${I?"bg-primary":z?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",O+P+1]}),e.jsxs("span",{className:"text-muted-foreground/70 whitespace-nowrap",children:[ke(S)," - ",ke(v)]}),z?.week_type&&e.jsx(R,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:Ze(z.week_type),color:Ye(z.week_type)},children:z.week_type})]}),z?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:z.notes})]},S)})})}):e.jsxs("div",{className:"px-3 py-3 space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"CrÃ©ez un macrocycle dÃ©diÃ© pour donner de la visibilitÃ© long terme sur cette cible."}),e.jsx(M,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:()=>W.mutate(m.id),disabled:W.isPending,children:W.isPending?"CrÃ©ation...":"CrÃ©er ce macrocycle"})]})]},m.id)})})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"Aucune compÃ©tition assignÃ©e Ã  venir â€” planification non disponible."})})},tt=({interview:s,athleteId:t,athleteName:n,athletePhone:i,objectives:u,performances:l})=>{const{toast:a}=_e(),d=Ne(),[b,j]=o.useState(!1),[_,f]=o.useState(s.coach_comment_successes??""),[N,C]=o.useState(s.coach_comment_difficulties??""),[x,F]=o.useState(s.coach_comment_goals??""),E=s.coach_review??"",T=s.coach_objectives??"",[q,y]=o.useState(s.coach_actions??""),[B,W]=o.useState(!1),[Q,m]=o.useState(!1),[g,p]=o.useState(!1),A=o.useRef(!1),{data:L}=D({queryKey:["previous-interview",t,s.date,s.id],queryFn:()=>h.getPreviousInterview(t,s.date,s.id),enabled:!!s.date}),K=o.useCallback(()=>({coach_comment_successes:_.trim()||null,coach_comment_difficulties:N.trim()||null,coach_comment_goals:x.trim()||null,coach_review:E.trim()||null,coach_objectives:T.trim()||null,coach_actions:q.trim()||null}),[q,N,x,_,T,E]),$=o.useCallback(()=>{const v=K();return(s.coach_comment_successes??null)!==v.coach_comment_successes||(s.coach_comment_difficulties??null)!==v.coach_comment_difficulties||(s.coach_comment_goals??null)!==v.coach_comment_goals||(s.coach_review??null)!==v.coach_review||(s.coach_objectives??null)!==v.coach_objectives||(s.coach_actions??null)!==v.coach_actions},[K,s]),w=U({mutationFn:v=>h.updateInterviewCoachSections(s.id,v),onSuccess:()=>{d.invalidateQueries({queryKey:["interviews",t]})},onError:v=>{a({title:"Erreur",description:v.message,variant:"destructive"})}}),c=U({mutationFn:async()=>(await h.updateInterviewCoachSections(s.id,K()),h.sendInterviewToAthlete(s.id)),onSuccess:()=>{a({title:"Entretien envoyÃ© au nageur"}),d.invalidateQueries({queryKey:["interviews",t]}),p(!0)},onError:v=>{a({title:"Erreur",description:v.message,variant:"destructive"})}}),O=()=>{if(!i)return;const ee=`Bonjour ${n.split(" ")[0]}, ton entretien est disponible. Consulte-le ici : https://erstein-aquatic-club.github.io/competition/#/profile`,te=Ls([i],ee);Ks()?window.location.href=te:navigator.clipboard.writeText(`${i}
${ee}`).then(()=>{a({title:"CopiÃ©",description:"NumÃ©ro et message copiÃ©s dans le presse-papiers."})}).catch(()=>{a({title:"Erreur",description:"Impossible de copier.",variant:"destructive"})}),p(!1)},se=U({mutationFn:()=>h.deleteInterview(s.id),onSuccess:()=>{a({title:"Entretien supprimÃ©"}),d.invalidateQueries({queryKey:["interviews",t]})},onError:v=>{a({title:"Erreur",description:v.message,variant:"destructive"})}}),S=w.isPending||c.isPending||se.isPending,P=s.status,z=P==="draft_athlete"?"border-amber-300 dark:border-amber-700 border-l-4":P==="draft_coach"?"border-blue-300 dark:border-blue-700 border-l-4":P==="sent"?"border-emerald-300 dark:border-emerald-700 border-l-4":"",I=o.useCallback(()=>{P!=="draft_coach"||A.current||S||!$()||(A.current=!0,w.mutate(K()),window.setTimeout(()=>{A.current=!1},500))},[K,$,S,w,P]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${z}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>j(v=>!v),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:fe(s.date)}),et(P),P==="signed"&&s.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",fe(s.signed_at.slice(0,10))]})]}),b?e.jsx($s,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(Ws,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),b&&e.jsxs("div",{className:"px-4 pb-4 space-y-5",children:[P==="draft_athlete"&&e.jsxs("div",{className:"rounded-xl border border-dashed border-amber-300 bg-amber-50/50 dark:bg-amber-950/20 p-6 text-center space-y-2",children:[e.jsx(ds,{className:"h-8 w-8 mx-auto text-amber-500"}),e.jsx("p",{className:"text-sm font-medium",children:"En attente de la prÃ©paration du nageur"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Le contenu n'est pas encore visible. Le nageur doit d'abord remplir ses sections."})]}),P==="draft_coach"&&e.jsxs(e.Fragment,{children:[L&&e.jsx(Ge,{prevInterview:L,commitmentReview:s.athlete_commitment_review}),e.jsx(X,{label:"RÃ©ussites"}),e.jsx(Z,{label:"Nageur",text:s.athlete_successes}),e.jsx(De,{label:"Coach",value:_,onChange:f,onBlur:I,placeholder:"Votre commentaire sur les rÃ©ussites..."}),e.jsx(X,{label:"DifficultÃ©s"}),e.jsx(Z,{label:"Nageur",text:s.athlete_difficulties}),e.jsx(De,{label:"Coach",value:N,onChange:C,onBlur:I,placeholder:"Votre commentaire sur les difficultÃ©s..."}),e.jsx(X,{label:"Objectifs"}),u.length>0&&e.jsx("div",{className:"space-y-1.5",children:u.map(v=>e.jsx(Ve,{objective:v,performances:l},v.id))}),e.jsx(Z,{label:"Nageur",text:s.athlete_goals}),e.jsx(De,{label:"Coach",value:x,onChange:F,onBlur:I,placeholder:"Objectifs complÃ©mentaires, commentaires..."}),e.jsx(X,{label:"Planification"}),e.jsx(He,{athleteId:t,interviewDate:s.date}),e.jsx(X,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(Z,{label:"Engagements du nageur",text:s.athlete_commitments}),e.jsx(De,{label:"Actions du coach",value:q,onChange:y,onBlur:I,placeholder:"Actions concrÃ¨tes, points de suivi..."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:w.isPending?"Sauvegarde...":"Sauvegarde automatique a la sortie d'un champ."})]}),(P==="sent"||P==="signed")&&e.jsxs(e.Fragment,{children:[L&&e.jsx(Ge,{prevInterview:L,commitmentReview:s.athlete_commitment_review}),e.jsx(X,{label:"RÃ©ussites"}),e.jsx(Z,{label:"Nageur",text:s.athlete_successes}),e.jsx(Te,{label:"Coach",text:s.coach_comment_successes||s.coach_review}),e.jsx(X,{label:"DifficultÃ©s"}),e.jsx(Z,{label:"Nageur",text:s.athlete_difficulties}),e.jsx(Te,{label:"Coach",text:s.coach_comment_difficulties}),e.jsx(X,{label:"Objectifs"}),u.length>0&&e.jsx("div",{className:"space-y-1.5",children:u.map(v=>e.jsx(Ve,{objective:v,performances:l},v.id))}),e.jsx(Z,{label:"Nageur",text:s.athlete_goals}),e.jsx(Te,{label:"Coach",text:s.coach_comment_goals||s.coach_objectives}),e.jsx(X,{label:"Planification"}),e.jsx(He,{athleteId:t,interviewDate:s.date}),e.jsx(X,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(Z,{label:"Engagements du nageur",text:s.athlete_commitments}),e.jsx(Te,{label:"Actions du coach",text:s.coach_actions})]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[P==="draft_coach"&&e.jsxs(M,{className:"w-full",onClick:()=>m(!0),disabled:S,children:[e.jsx(Ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer au nageur"]}),e.jsxs(M,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>W(!0),disabled:S,children:[e.jsx($e,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})]})]}),e.jsx(oe,{open:B,onOpenChange:W,children:e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Supprimer l'entretien"}),e.jsxs(xe,{children:["Cette action est irrÃ©versible. L'entretien du ",s.date?fe(s.date):""," sera supprimÃ© dÃ©finitivement."]})]}),e.jsxs(pe,{children:[e.jsx(he,{children:"Annuler"}),e.jsx(ge,{onClick:()=>{se.mutate(),W(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(oe,{open:Q,onOpenChange:m,children:e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Envoyer au nageur"}),e.jsx(xe,{children:"L'entretien sera envoyÃ© au nageur pour consultation. Les sections coach seront enregistrÃ©es automatiquement."})]}),e.jsxs(pe,{children:[e.jsx(he,{children:"Annuler"}),e.jsxs(ge,{onClick:()=>{c.mutate(),m(!1)},children:[e.jsx(Ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer"]})]})]})}),e.jsx(oe,{open:g,onOpenChange:p,children:e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Entretien envoyÃ©"}),e.jsx(xe,{children:i?e.jsxs(e.Fragment,{children:["L'entretien a bien Ã©tÃ© envoyÃ© Ã  ",e.jsx("strong",{children:n}),". Voulez-vous le notifier par SMS ?"]}):e.jsxs(e.Fragment,{children:["L'entretien a bien Ã©tÃ© envoyÃ© Ã  ",e.jsx("strong",{children:n}),". Aucun numÃ©ro de tÃ©lÃ©phone enregistrÃ© pour ce nageur."]})})]}),e.jsxs(pe,{children:[e.jsx(he,{children:"Plus tard"}),e.jsxs(ge,{onClick:O,disabled:!i,children:[e.jsx(Os,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer le SMS"]})]})]})})]})},nt=({athleteId:s,athleteName:t})=>{const{toast:n}=_e(),i=Ne(),{data:u}=D({queryKey:["auth-uid",s],queryFn:()=>st(s),enabled:!!s}),{data:l=[]}=D({queryKey:["objectives",u],queryFn:()=>h.getObjectives(u),enabled:!!u}),{data:a}=D({queryKey:["athlete-profile",s],queryFn:()=>h.getProfile({userId:s}),enabled:!!s}),d=a?.ffn_iuf??null,b=a?.phone??null,j=o.useMemo(()=>{const x=new Date;return x.setDate(x.getDate()-360),x.toISOString().slice(0,10)},[]),{data:_=[]}=D({queryKey:["swimmer-performances-recent",d],queryFn:()=>h.getSwimmerPerformances({iuf:d,fromDate:j}),enabled:!!d}),{data:f=[],isLoading:N}=D({queryKey:["interviews",s],queryFn:()=>h.getInterviews(s),enabled:!!s}),C=U({mutationFn:()=>h.createInterview({athlete_id:s}),onSuccess:()=>{n({title:"Entretien crÃ©Ã©"}),i.invalidateQueries({queryKey:["interviews",s]})},onError:x=>{n({title:"Erreur",description:x.message,variant:"destructive"})}});return N?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(x=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-24 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-20 rounded bg-muted"})]})},x))}):f.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(os,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun entretien pour ",t,"."]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>C.mutate(),disabled:C.isPending,children:[e.jsx(je,{className:"mr-1.5 h-3.5 w-3.5"}),C.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Entretiens"}),e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:f.length})]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>C.mutate(),disabled:C.isPending,children:[e.jsx(je,{className:"mr-1.5 h-3.5 w-3.5"}),C.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}),e.jsx("div",{className:"space-y-2",children:f.map(x=>e.jsx(tt,{interview:x,athleteId:s,athleteName:t,athletePhone:b,objectives:l,performances:_},x.id))})]})};function Wt(){const[,s]=ys("/coach/swimmer/:id"),[,t]=bs(),{selectedAthleteId:n,selectedAthleteName:i}=vs(),u=s?.id?Number(s.id):n,l=i,{data:a}=D({queryKey:["profile",u],queryFn:()=>h.getProfile({userId:u}),enabled:u!=null}),d=a?.display_name??l??"Nageur",b=a?.avatar_url??null,j=a?.group_label??null;return u?e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>t("/coach?section=swimmers"),className:"h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition","aria-label":"Retour",children:e.jsx(Ds,{className:"h-4 w-4"})}),b?e.jsx("img",{src:b,alt:"",className:"h-10 w-10 rounded-full object-cover border border-border"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary",children:d.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-lg font-bold truncate",children:d}),j&&e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:j})]})]}),e.jsxs(Ns,{defaultValue:"ressentis",children:[e.jsxs(_s,{className:"w-full grid grid-cols-4",children:[e.jsxs(Ce,{value:"ressentis",className:"text-xs gap-1",children:[e.jsx(ds,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(Ce,{value:"objectifs",className:"text-xs gap-1",children:[e.jsx(qe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Objectifs"})]}),e.jsxs(Ce,{value:"planification",className:"text-xs gap-1",children:[e.jsx(Xe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Planif."})]}),e.jsxs(Ce,{value:"entretiens",className:"text-xs gap-1",children:[e.jsx(os,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]})]}),e.jsx(we,{value:"ressentis",className:"mt-4",children:e.jsx(Cs,{athleteId:u,athleteName:d})}),e.jsx(we,{value:"objectifs",className:"mt-4",children:e.jsx(Qs,{athleteId:u,athleteName:d})}),e.jsx(we,{value:"planification",className:"mt-4",children:e.jsx(Hs,{athleteId:u})}),e.jsx(we,{value:"entretiens",className:"mt-4",children:e.jsx(nt,{athleteId:u,athleteName:d})})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx("p",{children:"Aucun nageur sÃ©lectionnÃ©."}),e.jsx("button",{type:"button",onClick:()=>t("/coach?section=swimmers"),className:"mt-2 text-primary underline",children:"Retour au dashboard"})]})}export{Wt as default};
