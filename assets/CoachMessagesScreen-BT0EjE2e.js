import{r,j as e}from"./vendor-query-DyA9aSKS.js";import{a as z}from"./api-DocwMqSA.js";import{c as E,d as k,C as d,h as C,j as S,k as _,e as p,L as m,I as F,B as w}from"./index-DpN3PROz.js";import{T as I}from"./textarea-CkA5bFaB.js";import{S as $,a as A,b as B,c as V,d as u}from"./select-DvrW9utf.js";import{C as D,B as H}from"./Coach-0uT3IjkK.js";import"./vendor-react-BzrpNAyj.js";import"./swim-OFBphZkH.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./index-uf1KqmRh.js";import"./index-DL0srYtj.js";import"./index-DCX2sNhR.js";import"./chevron-down-Bx3tZ2Ta.js";import"./chevron-up-DiAJlbYy.js";import"./toggle-group-txrxPpEX.js";import"./index-CP4Rm5FI.js";import"./target-DLHMf6Xz.js";import"./clock-BEDC43Vm.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=[["path",{d:"M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z",key:"117uat"}],["path",{d:"M6 12h16",key:"s4cdu5"}]],R=E("send-horizontal",O),ce=({onBack:T,athletes:n,groups:g,athletesLoading:M})=>{const{toast:l}=k(),[o,h]=r.useState(""),[x,v]=r.useState(""),[a,f]=r.useState(""),[j,b]=r.useState(!1),y=r.useMemo(()=>n.filter(s=>s.id!=null).map(s=>({value:`user:${s.id}`,label:s.group_label?`${s.display_name} · ${s.group_label}`:s.display_name})),[n]),N=r.useMemo(()=>g.map(s=>({value:`group:${s.id}`,label:s.name,id:s.id})),[g]),t=r.useMemo(()=>{if(!a)return{recipients:0,target:null};if(a.startsWith("user:")){const s=Number(a.split(":")[1]),i=n.find(c=>c.id===s);return i?.id?{recipients:1,target:{target_user_id:i.id,target_group_id:null}}:{recipients:0,target:null}}if(a.startsWith("group:")){const s=Number(a.split(":")[1]);return{recipients:n.filter(c=>c.group_id===s&&c.id!=null).length,target:{target_group_id:s,target_user_id:null}}}return{recipients:0,target:null}},[n,a]),L=async()=>{if(!t.target||t.recipients===0){l({title:"Aucun destinataire",description:"Choisissez un groupe ou un nageur avec au moins un compte actif.",variant:"destructive"});return}if(!o.trim()){l({title:"Titre requis",description:"Ajoutez un titre avant d'envoyer la notification.",variant:"destructive"});return}b(!0);try{const s=await z.notifications_send({title:o.trim(),body:x.trim()||null,type:"message",targets:[t.target]}),i="pushTriggered"in s?s.pushTriggered:!1;l({title:i===!1?"Message créé, push à vérifier":"Notification envoyée",description:i===!1?"La notification in-app est bien créée, mais l'envoi push n'a pas pu être confirmé.":t.recipients===1?"Le nageur recevra la notification sur ses appareils abonnés.":`${t.recipients} nageurs ciblés recevront la notification sur leurs appareils abonnés.`,variant:i===!1?"destructive":"default"}),h(""),v(""),f("")}catch(s){l({title:"Envoi impossible",description:s instanceof Error?s.message:"La notification n'a pas pu être envoyée.",variant:"destructive"})}finally{b(!1)}};return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(D,{title:"Envoyer un message",description:"Crée une notification push (FCM) pour un groupe ou un nageur.",onBack:T}),e.jsxs(d,{className:"border-l-4 border-l-primary",children:[e.jsxs(C,{children:[e.jsx(S,{children:"Destinataire"}),e.jsx(_,{children:"Sélectionnez un groupe complet ou un nageur individuel."})]}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{children:"Destinataire"}),e.jsxs($,{value:a,onValueChange:f,children:[e.jsx(A,{children:e.jsx(B,{placeholder:M?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(V,{children:[N.length?e.jsxs(e.Fragment,{children:[e.jsx(u,{value:"section-group",disabled:!0,children:"Groupes"}),N.map(s=>e.jsx(u,{value:s.value,children:s.label},s.value))]}):null,y.length?e.jsxs(e.Fragment,{children:[e.jsx(u,{value:"section-athlete",disabled:!0,children:"Nageurs"}),y.map(s=>e.jsx(u,{value:s.value,children:s.label},s.value))]}):null]})]})]}),a&&t.recipients>0?e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.recipients," nageur",t.recipients>1?"s":""," ciblé",t.recipients>1?"s":""]}):null,a&&t.recipients===0?e.jsx("p",{className:"text-xs text-destructive",children:"Aucun nageur actif n'est rattaché à cette sélection."}):null]})]}),e.jsxs(d,{children:[e.jsxs(C,{children:[e.jsx(S,{children:"Notification"}),e.jsx(_,{children:"Le titre apparaît dans la push, le message reste optionnel."})]}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"coach-message-title",children:"Titre"}),e.jsx(F,{id:"coach-message-title",value:o,onChange:s=>h(s.target.value),placeholder:"Ex. Changement d'horaire demain"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"coach-message-body",children:"Message"}),e.jsx(I,{id:"coach-message-body",value:x,onChange:s=>v(s.target.value),placeholder:"Ajoutez les détails à afficher dans la notification…",rows:4})]})]})]}),e.jsx(d,{className:"bg-muted/20",children:e.jsx(p,{className:"pt-6",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"L'envoi crée aussi une notification dans l'application. Les appareils avec les push activées la recevront immédiatement."})})}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsx(w,{className:"w-full sm:w-auto",onClick:L,disabled:!t.target||t.recipients===0||!o.trim()||j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"mr-2 h-4 w-4"}),"Envoi..."]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Envoyer la notification"]})})})]})};export{ce as default};
