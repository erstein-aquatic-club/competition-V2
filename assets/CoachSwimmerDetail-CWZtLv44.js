import{r as l,u as F,j as e,c as be,d as B,f as bt}from"./vendor-query-DyA9aSKS.js";import{c as it,B as O,P as oe,v as Ce,d as ve,L as W,I as Z,s as Ue,X as vt,w as Nt,u as lt,f as _t,R as Ct,$ as wt,b as St}from"./index-DUCziVE3.js";import{a as p}from"./api-mnwv0xJW.js";import{T as kt,a as Tt,b as Se,c as ke}from"./tabs-B0LgAOOi.js";import{B as U}from"./badge-BlErgKMF.js";import{C as We,w as ct,a as ot,S as Ye,G as dt,b as Dt}from"./weekTypeColor-ChHeu86h.js";import{T as Ve}from"./textarea-CMxwz816.js";import{S as ue,a as me,b as xe,c as he,d as X}from"./select-8spVPQQd.js";import{T as Et,a as Ke}from"./toggle-group-Badvvn15.js";import{S as Fe,a as Ae,b as Me,c as Pe,d as Xe}from"./sheet-ClNBy1Ml.js";import{A as te,a as se,b as ne,c as ae,d as re,e as ie,f as le,g as ce}from"./alert-dialog-BmZRF3JC.js";import{s as ut,f as mt,c as xt,d as qt,S as ht,e as Ie,a as we,b as Ft,F as At,p as Ze}from"./objectiveHelpers-D7Sv8PWO.js";import{T as Le}from"./trash-2-sUcGQJjW.js";import{t as Re}from"./date-DrpgLmFD.js";import{C as Mt}from"./copy-dlmECBx-.js";import{C as Pt}from"./index-CGZ6XxHz.js";import{P as Ot}from"./pencil-Bvr2aXXn.js";import{C as Lt,a as Kt,b as $t}from"./collapsible-Ck76YnK4.js";import{S as Wt,b as Rt,c as zt}from"./smsUtils-BrKclf9w.js";import{M as ze}from"./message-square-p5EJrJBL.js";import{C as Bt}from"./chevron-up-CdQZYeyJ.js";import{C as Qt}from"./chevron-down-C4ht425P.js";import{C as Oe}from"./clock-BS9g9fxq.js";import{C as Ut}from"./chevron-right-ZkYvY8mQ.js";import{T as Vt}from"./trophy-B1VuLZ3L.js";import{M as It}from"./map-pin-DV5TNv4q.js";import{A as Ht}from"./arrow-left-CUYwQaX5.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./swim-B05_JPPz.js";import"./index-DwWLLJF5.js";import"./index-Bn4ORtR6.js";import"./chart-column-CfmRiaxm.js";import"./index-CXU_1gsb.js";import"./vendor-date-B8Mnp-Vt.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gt=[["path",{d:"M16 14v2.2l1.6 1",key:"fo4ql5"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5",key:"1osxxc"}],["path",{d:"M3 10h5",key:"r794hk"}],["path",{d:"M8 2v4",key:"1cmpym"}],["circle",{cx:"16",cy:"16",r:"6",key:"qoo3c4"}]],Jt=it("calendar-clock",Gt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],Xt=it("link-2",Yt);async function Zt(t){const{data:s,error:n}=await Ue.rpc("get_auth_uid_for_user",{p_user_id:t});return n?(console.error("[objectives-tab] Failed to resolve auth UUID:",n.message),null):s}const es=({open:t,onOpenChange:s,objective:n,athleteName:r,athleteAuthId:o,competitions:c})=>{const{toast:a}=ve(),x=be(),v=!!n,[u,h]=l.useState("chrono"),[b,N]=l.useState(""),[w,f]=l.useState("25"),[T,A]=l.useState(""),[D,E]=l.useState(""),[C,R]=l.useState(""),[K,Q]=l.useState(!1);l.useEffect(()=>{if(t)if(n){const d=!!n.event_code,$=!!n.text;h(d&&$?"both":$?"texte":"chrono"),N(n.event_code??""),f(String(n.pool_length??25)),A(n.target_time_seconds!=null?we(n.target_time_seconds):""),E(n.text??""),R(n.competition_id??"")}else h("chrono"),N(""),f("25"),A(""),E(""),R("")},[t,n]);const m=B({mutationFn:d=>p.createObjective(d),onSuccess:()=>{a({title:"Objectif crÃ©Ã©"}),x.invalidateQueries({queryKey:["objectives",o]}),s(!1)},onError:d=>{a({title:"Erreur",description:d.message,variant:"destructive"})}}),g=B({mutationFn:d=>p.updateObjective(n.id,d),onSuccess:()=>{a({title:"Objectif mis Ã  jour"}),x.invalidateQueries({queryKey:["objectives",o]}),s(!1)},onError:d=>{a({title:"Erreur",description:d.message,variant:"destructive"})}}),y=B({mutationFn:()=>p.deleteObjective(n.id),onSuccess:()=>{a({title:"Objectif supprimÃ©"}),x.invalidateQueries({queryKey:["objectives",o]}),s(!1)},onError:d=>{a({title:"Erreur",description:d.message,variant:"destructive"})}}),P=u==="chrono"||u==="both",j=u==="texte"||u==="both",S=()=>{if(P&&!b){a({title:"Ã‰preuve requise",description:"Veuillez sÃ©lectionner une Ã©preuve.",variant:"destructive"});return}if(P&&T&&Ze(T)===null){a({title:"Format invalide",description:"Le temps doit Ãªtre au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(j&&!D.trim()){a({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const d={athlete_id:o,competition_id:C&&C!=="none"?C:null,event_code:P?b:null,pool_length:P?Number(w):null,target_time_seconds:P&&T?Ze(T):null,text:j?D.trim():null};v?g.mutate(d):m.mutate(d)},k=m.isPending||g.isPending||y.isPending,_=l.useMemo(()=>{const d=new Date;return d.setHours(0,0,0,0),c.filter($=>new Date($.date+"T00:00:00").getTime()>=d.getTime())},[c]);return e.jsxs(e.Fragment,{children:[e.jsx(Fe,{open:t,onOpenChange:s,children:e.jsxs(Ae,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(Me,{children:e.jsx(Pe,{children:v?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Type d'objectif"}),e.jsxs(Et,{type:"single",variant:"outline",value:u,onValueChange:d=>{d&&h(d)},className:"justify-start",children:[e.jsx(Ke,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(Ke,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(Ke,{value:"both",className:"text-xs",children:"Les deux"})]})]}),P&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Ã‰preuve *"}),e.jsxs(ue,{value:b,onValueChange:N,children:[e.jsx(me,{children:e.jsx(xe,{placeholder:"Choisir une Ã©preuve"})}),e.jsx(he,{children:At.map(d=>e.jsx(X,{value:d,children:Ie(d)},d))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Bassin"}),e.jsxs(ue,{value:w,onValueChange:f,children:[e.jsx(me,{children:e.jsx(xe,{})}),e.jsxs(he,{children:[e.jsx(X,{value:"25",children:"25m"}),e.jsx(X,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Temps cible (min:sec:centiÃ¨mes)"}),e.jsx(Z,{placeholder:"Ex : 1:05:30",value:T,onChange:d=>A(d.target.value)})]})]}),j&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Objectif texte *"}),e.jsx(Ve,{placeholder:"Ex : AmÃ©liorer la coulÃ©e de dos",value:D,onChange:d=>E(d.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Lier Ã  une compÃ©tition"}),e.jsxs(ue,{value:C,onValueChange:R,children:[e.jsx(me,{children:e.jsx(xe,{placeholder:"Aucune"})}),e.jsxs(he,{children:[e.jsx(X,{value:"none",children:"Aucune"}),_.map(d=>e.jsxs(X,{value:d.id,children:[d.name," (",d.date,")"]},d.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(O,{className:"w-full",onClick:S,disabled:k,children:k?"Enregistrement...":v?"Enregistrer":"CrÃ©er"}),v&&e.jsx(O,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>Q(!0),disabled:k,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(te,{open:K,onOpenChange:Q,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Supprimer l'objectif"}),e.jsx(re,{children:"Cette action est irrÃ©versible. L'objectif sera supprimÃ© dÃ©finitivement."})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Annuler"}),e.jsx(ce,{onClick:()=>{y.mutate(),Q(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function ts(t){const s=t.split("-");return s.length===3?`${s[2]}/${s[1]}/${s[0]}`:t}const ss=({objective:t,performances:s,onEdit:n})=>{const r=t.event_code?ut(t.event_code):null,o=r?ht[r]??"":"",c=t.event_code?mt(s,t.event_code,t.pool_length):null;let a=null,x=null;c&&t.target_time_seconds!=null&&t.event_code&&(a=c.time-t.target_time_seconds,x=xt(c.time,t.target_time_seconds,t.event_code));const v=!!t.competition_name,u=t.competition_date?qt(t.competition_date):null;return e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card p-3 text-sm space-y-1.5 transition-colors hover:bg-muted/50 ${o?`border-l-4 ${o}`:""}`,onClick:()=>n(t),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(Ce,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-center gap-1.5 flex-wrap",children:[t.event_code&&e.jsx("span",{className:"font-medium",children:Ie(t.event_code)}),t.event_code&&t.pool_length&&e.jsxs("span",{className:"text-muted-foreground",children:["(",t.pool_length,"m)"]}),t.target_time_seconds!=null&&e.jsx("span",{className:"font-mono text-xs text-primary",children:we(t.target_time_seconds)})]}),e.jsx(Le,{className:"h-3.5 w-3.5 text-muted-foreground/40 shrink-0"})]}),t.text&&e.jsx("p",{className:"text-muted-foreground text-xs pl-5 line-clamp-2",children:t.text}),t.event_code&&c&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:we(c.time)})]}),c.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",ts(c.date),")"]}),a!=null&&e.jsx("span",{className:a<=0?"text-emerald-600 font-medium":"text-amber-600",children:a<=0?"Objectif atteint !":`+${a.toFixed(2)}s`})]}),t.event_code&&!c&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"}),x!=null&&e.jsx("div",{className:"pl-5 pr-1",children:e.jsx("div",{className:"h-1.5 w-full rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${Ft(x)}`,style:{width:`${Math.min(x,100)}%`}})})}),v&&e.jsx("div",{className:"pl-5",children:e.jsxs(U,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:[t.competition_name,u!=null&&u>0&&e.jsxs("span",{className:"ml-1 font-bold",children:["J-",u]})]})})]})},ns=({athleteId:t,athleteName:s})=>{const[n,r]=l.useState(!1),[o,c]=l.useState(null),{data:a,isLoading:x}=F({queryKey:["auth-uid",t],queryFn:()=>Zt(t),enabled:!!t}),{data:v=[]}=F({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),{data:u=[],isLoading:h}=F({queryKey:["objectives",a],queryFn:()=>p.getObjectives(a),enabled:!!a}),{data:b}=F({queryKey:["profile",t],queryFn:()=>p.getProfile({userId:t}),enabled:!!t}),N=b?.ffn_iuf??null,w=l.useMemo(()=>{const C=new Date;return C.setDate(C.getDate()-360),C.toISOString().slice(0,10)},[]),{data:f=[]}=F({queryKey:["swimmer-performances-recent",N],queryFn:()=>p.getSwimmerPerformances({iuf:N,fromDate:w}),enabled:!!N}),T=()=>{c(null),r(!0)},A=C=>{c(C),r(!0)},D=x,E=!!a&&!x;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(O,{variant:"outline",size:"sm",onClick:T,disabled:!a,children:[e.jsx(oe,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter un objectif"]})}),D&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(C=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},C))}),E&&h&&e.jsx("div",{className:"space-y-2",children:[1,2].map(C=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},C))}),E&&!h&&u.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ce,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif dÃ©fini pour ",s,"."]}),e.jsxs(O,{variant:"outline",size:"sm",onClick:T,children:[e.jsx(oe,{className:"mr-1.5 h-3.5 w-3.5"}),"CrÃ©er le premier objectif"]})]}),E&&!h&&u.length>0&&e.jsxs("div",{className:"space-y-2",children:[u.map(C=>e.jsx(ss,{objective:C,performances:f,onEdit:A},C.id)),e.jsx("p",{className:"text-[10px] text-muted-foreground/60 italic text-center pt-1",children:"Les temps Â« Actuel Â» correspondent Ã  la meilleure performance des 360 derniers jours sur l'Ã©preuve."})]}),a&&e.jsx(es,{open:n,onOpenChange:r,objective:o,athleteName:s,athleteAuthId:a,competitions:v})]})},Be="__today__";function Qe(t,s){const n=[],r=new Date(t+"T00:00:00"),o=new Date(s+"T00:00:00"),c=new Date(r),a=c.getDay(),x=a===0?1:a===1?0:8-a;for(c.setDate(c.getDate()+x);c<=o;)n.push(c.toISOString().split("T")[0]),c.setDate(c.getDate()+7);return n}function _e(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Te(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function as(t){const s=new Date(t+"T00:00:00");return s.setDate(s.getDate()+6),s.toISOString().split("T")[0]}function rs(t){const s=new Date;s.setHours(0,0,0,0);const n=new Date(t+"T00:00:00"),r=new Date(t+"T00:00:00");return r.setDate(r.getDate()+6),s>=n&&s<=r}const is=({athleteId:t})=>{const{toast:s}=ve(),n=be(),[r,o]=l.useState(null),[c,a]=l.useState(null),[x,v]=l.useState(""),[u,h]=l.useState(""),[b,N]=l.useState(!1),[w,f]=l.useState(!1),[T,A]=l.useState(!1),[D,E]=l.useState(""),[C,R]=l.useState(""),[K,Q]=l.useState(""),{data:m=[]}=F({queryKey:["athletes"],queryFn:()=>p.getAthletes()}),g=l.useMemo(()=>m.find(L=>L.id===t)?.group_id??null,[m,t]),{data:y=[],isLoading:P}=F({queryKey:["training-cycles","athlete",t],queryFn:()=>p.getTrainingCycles({athleteId:t})}),{data:j=[],isLoading:S}=F({queryKey:["training-cycles","group",g],queryFn:()=>p.getTrainingCycles({groupId:g}),enabled:g!=null}),k=y.length===0&&j.length>0,_=y.length>0?y:j;l.useEffect(()=>{_.length>0&&(!r||!_.find(i=>i.id===r))&&o(_[0].id)},[_,r]);const d=_.find(i=>i.id===r)??null,{data:$=[],isLoading:pe}=F({queryKey:["training-weeks",r],queryFn:()=>p.getTrainingWeeks(r),enabled:!!r}),{data:M=[]}=F({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),z=l.useMemo(()=>[...M].sort((i,L)=>i.date.localeCompare(L.date)),[M]),V=l.useMemo(()=>{const i=new Set;return $.forEach(L=>{L.week_type&&i.add(L.week_type)}),Array.from(i).sort()},[$]),I=d?.start_competition_date??d?.start_date??null,q=l.useMemo(()=>{if(!d)return[];const i=I,L=d.end_competition_date;return!i||!L?[]:Qe(i,L)},[d,I]),de=l.useMemo(()=>{const i=new Map;return $.forEach(L=>i.set(L.week_start,L)),i},[$]),ge=P||S,je=B({mutationFn:async i=>{const L=await p.createTrainingCycle(i),H=i.start_date??M.find(J=>J.id===i.start_competition_id)?.date,G=M.find(J=>J.id===i.end_competition_id);if(H&&G){const J=Qe(H,G.date);J.length>0&&await p.bulkUpsertTrainingWeeks(J.map(Ne=>({cycle_id:L.id,week_start:Ne})))}return L},onSuccess:i=>{s({title:"Cycle cree"}),o(i.id),N(!1),E(""),R(""),Q(""),n.invalidateQueries({queryKey:["training-cycles"]}),n.invalidateQueries({queryKey:["training-weeks",i.id]})},onError:i=>{s({title:"Erreur",description:i.message,variant:"destructive"})}}),fe=B({mutationFn:i=>p.deleteTrainingCycle(i),onSuccess:()=>{s({title:"Cycle supprime"}),o(null),f(!1),n.invalidateQueries({queryKey:["training-cycles"]})},onError:i=>{s({title:"Erreur",description:i.message,variant:"destructive"})}}),He=B({mutationFn:i=>p.upsertTrainingWeek(i),onSuccess:()=>{a(null),n.invalidateQueries({queryKey:["training-weeks",r]})},onError:i=>{s({title:"Erreur",description:i.message,variant:"destructive"})}}),Ge=B({mutationFn:async()=>{for(const i of j){const L=await p.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:i.start_competition_id,end_competition_id:i.end_competition_id,name:i.name,notes:i.notes}),H=await p.getTrainingWeeks(i.id);H.length>0&&await p.bulkUpsertTrainingWeeks(H.map(G=>({cycle_id:L.id,week_start:G.week_start,week_type:G.week_type,notes:G.notes})))}},onSuccess:()=>{s({title:"Planification personnalisee"}),A(!1),o(null),n.invalidateQueries({queryKey:["training-cycles"]})},onError:i=>{s({title:"Erreur",description:i.message,variant:"destructive"})}}),Je=()=>{if(!D.trim()){s({title:"Nom requis",variant:"destructive"});return}if(!C||!K){s({title:"Dates requises",description:"Choisis un debut et une fin.",variant:"destructive"});return}const i=C===Be,L=i?Re(new Date):null,H=i?null:M.find(Ne=>Ne.id===C),G=M.find(Ne=>Ne.id===K),J=i?L:H?.date;if(J&&G&&G.date<=J){s({title:"Dates invalides",description:"La fin doit etre apres le debut.",variant:"destructive"});return}je.mutate({athlete_id:t,group_id:null,start_competition_id:i?null:C,end_competition_id:K,start_date:L,name:D.trim()})},gt=i=>{a(i.id),v(i.week_type??""),h(i.notes??"")},jt=i=>{a(`new:${i}`),v(""),h("")},ft=(i,L)=>{r&&He.mutate({cycle_id:r,week_start:i,week_type:x.trim()||null,notes:u.trim()||null})},yt=()=>{a(null)};return!ge&&_.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(We,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun cycle pour ce nageur."}),e.jsxs(O,{variant:"outline",size:"sm",onClick:()=>N(!0),children:[e.jsx(oe,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau cycle"]}),e.jsx(et,{open:b,onOpenChange:N,competitions:z,name:D,setName:E,startId:C,setStartId:R,endId:K,setEndId:Q,onSubmit:Je,isPending:je.isPending})]}):ge?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(i=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-48 rounded bg-muted"})},i))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[_.length>1?e.jsxs(ue,{value:r??"",onValueChange:o,children:[e.jsx(me,{className:"w-auto min-w-[180px] h-8 text-sm",children:e.jsx(xe,{placeholder:"Choisir un cycle"})}),e.jsx(he,{children:_.map(i=>e.jsx(X,{value:i.id,children:i.name},i.id))})]}):d?e.jsx("span",{className:"text-sm font-semibold",children:d.name}):null,k&&e.jsx(U,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Planif. groupe"}),e.jsx("div",{className:"flex-1"}),k&&e.jsxs(O,{variant:"outline",size:"sm",className:"text-xs h-10",onClick:()=>A(!0),children:[e.jsx(Mt,{className:"mr-1 h-3 w-3"}),"Personnaliser"]}),e.jsxs(O,{variant:"outline",size:"sm",className:"text-xs h-10",onClick:()=>N(!0),children:[e.jsx(oe,{className:"mr-1 h-3 w-3"}),"Nouveau"]}),d&&!k&&e.jsx(O,{variant:"ghost",size:"sm",className:"text-xs h-10 w-10 text-destructive hover:text-destructive",onClick:()=>f(!0),children:e.jsx(Le,{className:"h-3 w-3"})})]}),d&&e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:d.start_competition_id?"ðŸŠ":"ðŸ“…"}),e.jsx("span",{className:"text-sm font-medium",children:d.start_competition_id?d.start_competition_name??"Competition":"Debut du cycle"}),I&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",_e(I),")"]})]}),e.jsx("div",{className:"relative ml-3 border-l-2 border-border pl-4 space-y-1",children:pe?e.jsx("div",{className:"py-4",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"})}):q.map((i,L)=>{const H=de.get(i),G=rs(i),J=c===(H?.id??`new:${i}`);return e.jsx(ls,{monday:i,weekNumber:L+1,week:H,isCurrent:G,isEditing:J,isGroupPlan:k,editWeekType:x,setEditWeekType:v,editWeekNotes:u,setEditWeekNotes:h,existingWeekTypes:V,onStartEdit:()=>H?gt(H):jt(i),onSave:()=>ft(i),onCancel:yt,isSaving:He.isPending},i)})}),e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:"ðŸŽ¯"}),e.jsx("span",{className:"text-sm font-medium",children:d.end_competition_name??"Competition"}),d.end_competition_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",_e(d.end_competition_date),")"]})]})]}),e.jsx(et,{open:b,onOpenChange:N,competitions:z,name:D,setName:E,startId:C,setStartId:R,endId:K,setEndId:Q,onSubmit:Je,isPending:je.isPending}),e.jsx(te,{open:w,onOpenChange:f,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Supprimer le cycle"}),e.jsx(re,{children:"Le cycle et ses semaines seront supprimes."})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Annuler"}),e.jsx(ce,{onClick:()=>r&&fe.mutate(r),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(te,{open:T,onOpenChange:A,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Personnaliser la planification"}),e.jsx(re,{children:"Copie le plan du groupe pour ce nageur. Tu pourras ensuite l'ajuster."})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Annuler"}),e.jsx(ce,{onClick:()=>Ge.mutate(),children:Ge.isPending?"Copie...":"Personnaliser"})]})]})})]})},ls=({monday:t,weekNumber:s,week:n,isCurrent:r,isEditing:o,isGroupPlan:c,editWeekType:a,setEditWeekType:x,editWeekNotes:v,setEditWeekNotes:u,existingWeekTypes:h,onStartEdit:b,onSave:N,onCancel:w,isSaving:f})=>{const T=as(t),A=`week-types-${t}`;return o?e.jsxs("div",{className:`rounded-lg border bg-card p-3 space-y-2 ${r?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground",children:["Sem. ",s," (",Te(t)," - ",Te(T),")"]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(W,{className:"text-xs",children:"Type de semaine"}),e.jsx(Z,{className:"h-7 text-sm",placeholder:"Ex : Foncier, Affutage",list:A,value:a,onChange:D=>x(D.target.value)}),e.jsx("datalist",{id:A,children:h.map(D=>e.jsx("option",{value:D},D))})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(W,{className:"text-xs",children:"Notes"}),e.jsx(Ve,{className:"text-sm min-h-[48px]",placeholder:"Note optionnelle",rows:2,value:v,onChange:D=>u(D.target.value)})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(O,{variant:"ghost",size:"sm",className:"h-10 text-xs",onClick:w,children:[e.jsx(vt,{className:"mr-1 h-3 w-3"}),"Annuler"]}),e.jsxs(O,{size:"sm",className:"h-10 text-xs",onClick:N,disabled:f,children:[e.jsx(Pt,{className:"mr-1 h-3 w-3"}),f?"...":"Enregistrer"]})]})]}):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-3 py-2 flex items-center gap-2 transition-colors ${c?"cursor-default":"hover:bg-muted/50"} ${r?"ring-2 ring-primary":""}`,onClick:c?void 0:b,disabled:c,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-xs font-medium text-muted-foreground whitespace-nowrap",children:["Sem. ",s]}),e.jsxs("span",{className:"text-[10px] text-muted-foreground/70 whitespace-nowrap",children:["(",Te(t)," - ",Te(T),")"]}),n?.week_type&&e.jsx(U,{className:"text-[10px] px-1.5 py-0 border-0",style:{backgroundColor:ot(n.week_type),color:ct(n.week_type)},children:n.week_type})]}),n?.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:n.notes})]}),!c&&e.jsx(Ot,{className:"h-3 w-3 text-muted-foreground/40 shrink-0"})]})},et=({open:t,onOpenChange:s,competitions:n,name:r,setName:o,startId:c,setStartId:a,endId:x,setEndId:v,onSubmit:u,isPending:h})=>(l.useEffect(()=>{t&&(o(""),a(""),v(""))},[t]),e.jsx(Fe,{open:t,onOpenChange:s,children:e.jsxs(Ae,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(Me,{children:e.jsx(Pe,{children:"Nouveau cycle"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Nom du cycle *"}),e.jsx(Z,{placeholder:"Ex : Preparation hiver",value:r,onChange:b=>o(b.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Date de debut *"}),e.jsxs(ue,{value:c,onValueChange:a,children:[e.jsx(me,{children:e.jsx(xe,{placeholder:"Choisir..."})}),e.jsxs(he,{children:[e.jsxs(X,{value:Be,children:["Aujourd'hui (",_e(Re(new Date)),")"]}),n.map(b=>e.jsxs(X,{value:b.id,children:[b.name," (",_e(b.date),")"]},b.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Competition de fin *"}),e.jsxs(ue,{value:x,onValueChange:v,children:[e.jsx(me,{children:e.jsx(xe,{placeholder:"Choisir..."})}),e.jsx(he,{children:n.map(b=>e.jsxs(X,{value:b.id,children:[b.name," (",_e(b.date),")"]},b.id))})]})]}),c&&x&&(()=>{const N=c===Be?Re(new Date):n.find(f=>f.id===c)?.date,w=n.find(f=>f.id===x);if(N&&w&&w.date>N){const f=Qe(N,w.date).length;return e.jsxs("p",{className:"text-xs text-muted-foreground",children:[f," semaine",f>1?"s":""," seront generees."]})}return null})(),e.jsx(O,{className:"w-full",onClick:u,disabled:h,children:h?"Creation...":"Creer le cycle"})]})]})}));function ye(t){return new Date(t+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function De(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function cs(t){const s=new Date(t+"T00:00:00");return s.setDate(s.getDate()+6),s.toISOString().split("T")[0]}function os(t){const s=new Date;s.setHours(0,0,0,0);const n=new Date(t+"T00:00:00"),r=new Date(t+"T00:00:00");return r.setDate(r.getDate()+6),s>=n&&s<=r}function $e(t,s){const n=[],r=new Date(t+"T00:00:00"),o=new Date(s+"T00:00:00"),c=new Date(r),a=c.getDay(),x=a===0?1:a===1?0:8-a;for(c.setDate(c.getDate()+x);c<=o;)n.push(c.toISOString().split("T")[0]),c.setDate(c.getDate()+7);return n}function tt(t,s){const n=new Date(t+"T00:00:00"),r=new Date(s+"T00:00:00");return Math.round((r.getTime()-n.getTime())/(1e3*60*60*24))}const ds={draft_athlete:{label:"En attente nageur",variant:"secondary",className:"bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300 border-amber-200 dark:border-amber-800"},draft_coach:{label:"PrÃ©paration coach",variant:"secondary",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800"},sent:{label:"EnvoyÃ©",variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300 border-green-200 dark:border-green-800"},signed:{label:"SignÃ©",variant:"secondary",className:"bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-300 border-slate-200 dark:border-slate-700"}};function us(t){const s=ds[t];return e.jsx(U,{variant:s.variant,className:`text-[10px] px-1.5 py-0 ${s.className}`,children:s.label})}async function ms(t){const{data:s,error:n}=await Ue.rpc("get_auth_uid_for_user",{p_user_id:t});return n?(console.error("[interviews-tab] Failed to resolve auth UUID:",n.message),null):s}const ee=({label:t,text:s})=>e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Nt,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),Ee=({label:t,text:s})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(dt,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),qe=({label:t,value:s,onChange:n,onBlur:r,placeholder:o,rows:c=3})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(dt,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx(Ve,{className:"bg-white dark:bg-background",placeholder:o,value:s,onChange:a=>n(a.target.value),onBlur:r,rows:c})]}),Y=({label:t})=>e.jsxs("div",{className:"flex items-center gap-2 pt-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),st=({objective:t,performances:s=[]})=>{const n=!!t.event_code,r=!!t.text,o=n?ut(t.event_code):null,c=o?ht[o]??"":"",a=n?mt(s,t.event_code,t.pool_length):null;let x=null;return a&&t.target_time_seconds!=null&&t.event_code&&(x=a.time-t.target_time_seconds,xt(a.time,t.target_time_seconds,t.event_code)),e.jsxs("div",{className:`rounded-lg border bg-card p-2.5 text-sm space-y-1 ${n?`border-l-4 ${c}`:""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(Ce,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:n?Ie(t.event_code):""}),t.pool_length&&e.jsxs(U,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[t.pool_length,"m"]}),t.target_time_seconds!=null&&e.jsx(U,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:we(t.target_time_seconds)})]}),r&&e.jsx("p",{className:"text-muted-foreground line-clamp-2 pl-5",children:t.text}),a&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:we(a.time)})]}),a.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",ye(a.date),")"]}),x!=null&&e.jsx("span",{className:x<=0?"text-emerald-600 font-medium":"text-amber-600",children:x<=0?"Objectif atteint !":`+${x.toFixed(2)}s`})]}),!a&&n&&t.target_time_seconds!=null&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"})]})},nt=({prevInterview:t,commitmentReview:s})=>{const[n,r]=l.useState(!1);return e.jsxs(Lt,{open:n,onOpenChange:r,children:[e.jsx(Kt,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Ut,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${n?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements prÃ©cÃ©dents"}),e.jsx(U,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:ye(t.date)})]})}),e.jsx($t,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[t.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Engagements nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t.athlete_commitments})]}),t.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t.coach_actions})]}),s&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Bilan du nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s})]})]})})]})},at=({athleteId:t,interviewDate:s})=>{const{toast:n}=ve(),r=be(),{data:o=[]}=F({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),{data:c=[]}=F({queryKey:["my-competition-ids",t],queryFn:()=>p.getMyCompetitionIds(t)}),a=l.useMemo(()=>{const m=new Set(c);return o.filter(g=>m.has(g.id)).sort((g,y)=>g.date.localeCompare(y.date))},[o,c]),x=l.useMemo(()=>a.filter(m=>m.date>=s),[a,s]),{data:v=[]}=F({queryKey:["training-cycles","athlete",t],queryFn:()=>p.getTrainingCycles({athleteId:t})}),u=l.useMemo(()=>{const m=new Map;return v.slice().sort((g,y)=>(g.end_competition_date??"").localeCompare(y.end_competition_date??"")).forEach(g=>{g.end_competition_id&&!m.has(g.end_competition_id)&&m.set(g.end_competition_id,g)}),m},[v]),h=l.useMemo(()=>{const m=new Set;return x.map(g=>u.get(g.id)??null).filter(g=>!g||m.has(g.id)?!1:(m.add(g.id),!0))},[x,u]),b=bt({queries:h.map(m=>({queryKey:["training-weeks",m.id],queryFn:()=>p.getTrainingWeeks(m.id),enabled:!!m.id}))}),[N,w]=l.useState(null),[f,T]=l.useState(""),A=l.useMemo(()=>{const m=new Map;return h.forEach((g,y)=>{m.set(g.id,b[y]?.data??[])}),m},[h,b]),D=l.useMemo(()=>{const m=new Set;return A.forEach(g=>{g.forEach(y=>{y.week_type&&m.add(y.week_type)})}),Array.from(m).sort()},[A]),E=x[0]??null,C=l.useMemo(()=>new Date().toISOString().split("T")[0],[]),R=E?tt(C,E.date):null,K=B({mutationFn:async m=>{const g=a.find(_=>_.id===m);if(!g)throw new Error("Pas de compÃ©tition");const y=a.findIndex(_=>_.id===m),P=y>0?a[y-1]:null,j=P?.date??s,S=await p.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:P?.id??null,start_date:P?null:s,end_competition_id:g.id,name:`PrÃ©paration ${g.name}`}),k=$e(j,g.date);return k.length>0&&await p.bulkUpsertTrainingWeeks(k.map(_=>({cycle_id:S.id,week_start:_}))),S},onSuccess:()=>{n({title:"Planification crÃ©Ã©e"}),r.invalidateQueries({queryKey:["training-cycles"]}),r.invalidateQueries({queryKey:["training-weeks"]})},onError:m=>{n({title:"Erreur",description:m.message,variant:"destructive"})}}),Q=B({mutationFn:m=>p.upsertTrainingWeek(m),onSuccess:()=>{w(null),r.invalidateQueries({queryKey:["training-weeks"]})},onError:m=>{n({title:"Erreur",description:m.message,variant:"destructive"})}});return E?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(Vt,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsxs("span",{className:"font-medium",children:[x.length," Ã©chÃ©ance",x.length>1?"s":""," Ã  planifier"]}),R!=null&&e.jsxs(U,{variant:"secondary",className:"text-[10px]",children:["prochaine J-",R]})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Une carte par compÃ©tition cible pour construire et piloter plusieurs macrocycles Ã  l'avance."})]}),e.jsx("div",{className:"space-y-3",children:x.map((m,g)=>{const y=u.get(m.id)??null,P=y?A.get(y.id)??[]:[],j=new Map(P.map(M=>[M.week_start,M])),S=y?.start_date??y?.start_competition_date??s,k=S>s?S:s,_=y?$e(k,m.date):[],d=y?$e(S,m.date):[],$=Math.max(d.length-_.length,0),pe=tt(C,m.date);return e.jsxs("div",{className:"rounded-xl border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border bg-muted/20 px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:m.name}),g===0&&e.jsx(U,{className:"text-[10px] bg-primary/10 text-primary border-primary/20",children:"PrioritÃ©"}),e.jsx(U,{variant:"secondary",className:"text-[10px]",children:ye(m.date)}),e.jsxs(U,{variant:"outline",className:"text-[10px]",children:["J-",pe]})]}),y?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:y.name}),y.start_competition_name&&e.jsxs("span",{children:["depuis ",y.start_competition_name]}),e.jsxs("span",{children:[d.length," sem."]}),$>0&&e.jsxs("span",{children:[$," dÃ©jÃ  passÃ©es"]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Aucun macrocycle crÃ©Ã© pour cette Ã©chÃ©ance."})]}),y?_.length===0?e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"Aucune semaine future Ã  afficher sur ce macrocycle."}):e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1.5",children:_.map((M,z)=>{const V=j.get(M),I=os(M),q=cs(M),de=`${y.id}:${M}`,ge=N===de,je=`inline-week-${y.id}-${M}`;return ge?e.jsxs("div",{className:`rounded-lg border bg-card p-2 space-y-1.5 ${I?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Sem. ",$+z+1," (",De(M)," - ",De(q),")"]}),e.jsx(Z,{className:"h-7 text-sm",placeholder:"Foncier, Techni., AffÃ»tage...",list:je,value:f,onChange:fe=>T(fe.target.value)}),e.jsx("datalist",{id:je,children:D.map(fe=>e.jsx("option",{value:fe},fe))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(O,{variant:"ghost",size:"sm",className:"h-6 text-xs px-2",onClick:()=>w(null),children:"Annuler"}),e.jsx(O,{size:"sm",className:"h-6 text-xs px-2",onClick:()=>{Q.mutate({cycle_id:y.id,week_start:M,week_type:f.trim()||null,notes:V?.notes??null})},disabled:Q.isPending,children:"OK"})]})]},M):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-2.5 py-2 text-xs transition-colors hover:bg-muted/50 ${I?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>{w(de),T(V?.week_type??"")},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${I?"bg-primary":V?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",$+z+1]}),e.jsxs("span",{className:"text-muted-foreground/70 whitespace-nowrap",children:[De(M)," - ",De(q)]}),V?.week_type&&e.jsx(U,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:ot(V.week_type),color:ct(V.week_type)},children:V.week_type})]}),V?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:V.notes})]},M)})})}):e.jsxs("div",{className:"px-3 py-3 space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"CrÃ©ez un macrocycle dÃ©diÃ© pour donner de la visibilitÃ© long terme sur cette cible."}),e.jsx(O,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:()=>K.mutate(m.id),disabled:K.isPending,children:K.isPending?"CrÃ©ation...":"CrÃ©er ce macrocycle"})]})]},m.id)})})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"Aucune compÃ©tition assignÃ©e Ã  venir â€” planification non disponible."})})},xs=({interview:t,athleteId:s,athleteName:n,athletePhone:r,objectives:o,performances:c})=>{const{toast:a}=ve(),x=be(),[v,u]=l.useState(!1),[h,b]=l.useState(t.coach_comment_successes??""),[N,w]=l.useState(t.coach_comment_difficulties??""),[f,T]=l.useState(t.coach_comment_goals??""),A=t.coach_review??"",D=t.coach_objectives??"",[E,C]=l.useState(t.coach_actions??""),[R,K]=l.useState(!1),[Q,m]=l.useState(!1),[g,y]=l.useState(!1),P=l.useRef(!1),{data:j}=F({queryKey:["previous-interview",s,t.date,t.id],queryFn:()=>p.getPreviousInterview(s,t.date,t.id),enabled:!!t.date}),S=l.useCallback(()=>({coach_comment_successes:h.trim()||null,coach_comment_difficulties:N.trim()||null,coach_comment_goals:f.trim()||null,coach_review:A.trim()||null,coach_objectives:D.trim()||null,coach_actions:E.trim()||null}),[E,N,f,h,D,A]),k=l.useCallback(()=>{const q=S();return(t.coach_comment_successes??null)!==q.coach_comment_successes||(t.coach_comment_difficulties??null)!==q.coach_comment_difficulties||(t.coach_comment_goals??null)!==q.coach_comment_goals||(t.coach_review??null)!==q.coach_review||(t.coach_objectives??null)!==q.coach_objectives||(t.coach_actions??null)!==q.coach_actions},[S,t]),_=B({mutationFn:q=>p.updateInterviewCoachSections(t.id,q),onSuccess:()=>{x.invalidateQueries({queryKey:["interviews",s]})},onError:q=>{a({title:"Erreur",description:q.message,variant:"destructive"})}}),d=B({mutationFn:async()=>(await p.updateInterviewCoachSections(t.id,S()),p.sendInterviewToAthlete(t.id)),onSuccess:()=>{a({title:"Entretien envoyÃ© au nageur"}),x.invalidateQueries({queryKey:["interviews",s]}),y(!0)},onError:q=>{a({title:"Erreur",description:q.message,variant:"destructive"})}}),$=()=>{if(!r)return;const de=`Bonjour ${n.split(" ")[0]}, ton entretien est disponible. Consulte-le ici : https://erstein-aquatic-club.github.io/competition/#/profile`,ge=Rt([r],de);zt()?window.location.href=ge:navigator.clipboard.writeText(`${r}
${de}`).then(()=>{a({title:"CopiÃ©",description:"NumÃ©ro et message copiÃ©s dans le presse-papiers."})}).catch(()=>{a({title:"Erreur",description:"Impossible de copier.",variant:"destructive"})}),y(!1)},pe=B({mutationFn:()=>p.deleteInterview(t.id),onSuccess:()=>{a({title:"Entretien supprimÃ©"}),x.invalidateQueries({queryKey:["interviews",s]})},onError:q=>{a({title:"Erreur",description:q.message,variant:"destructive"})}}),M=_.isPending||d.isPending||pe.isPending,z=t.status,V=z==="draft_athlete"?"border-amber-300 dark:border-amber-700 border-l-4":z==="draft_coach"?"border-blue-300 dark:border-blue-700 border-l-4":z==="sent"?"border-emerald-300 dark:border-emerald-700 border-l-4":"",I=l.useCallback(()=>{z!=="draft_coach"||P.current||M||!k()||(P.current=!0,_.mutate(S()),window.setTimeout(()=>{P.current=!1},500))},[S,k,M,_,z]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${V}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>u(q=>!q),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:ye(t.date)}),us(z),z==="signed"&&t.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",ye(t.signed_at.slice(0,10))]})]}),v?e.jsx(Bt,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(Qt,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),v&&e.jsxs("div",{className:"px-4 pb-4 space-y-5",children:[z==="draft_athlete"&&e.jsxs("div",{className:"rounded-xl border border-dashed border-amber-300 bg-amber-50/50 dark:bg-amber-950/20 p-6 text-center space-y-2",children:[e.jsx(Oe,{className:"h-8 w-8 mx-auto text-amber-500"}),e.jsx("p",{className:"text-sm font-medium",children:"En attente de la prÃ©paration du nageur"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Le contenu n'est pas encore visible. Le nageur doit d'abord remplir ses sections."})]}),z==="draft_coach"&&e.jsxs(e.Fragment,{children:[j&&e.jsx(nt,{prevInterview:j,commitmentReview:t.athlete_commitment_review}),e.jsx(Y,{label:"RÃ©ussites"}),e.jsx(ee,{label:"Nageur",text:t.athlete_successes}),e.jsx(qe,{label:"Coach",value:h,onChange:b,onBlur:I,placeholder:"Votre commentaire sur les rÃ©ussites..."}),e.jsx(Y,{label:"DifficultÃ©s"}),e.jsx(ee,{label:"Nageur",text:t.athlete_difficulties}),e.jsx(qe,{label:"Coach",value:N,onChange:w,onBlur:I,placeholder:"Votre commentaire sur les difficultÃ©s..."}),e.jsx(Y,{label:"Objectifs"}),o.length>0&&e.jsx("div",{className:"space-y-1.5",children:o.map(q=>e.jsx(st,{objective:q,performances:c},q.id))}),e.jsx(ee,{label:"Nageur",text:t.athlete_goals}),e.jsx(qe,{label:"Coach",value:f,onChange:T,onBlur:I,placeholder:"Objectifs complÃ©mentaires, commentaires..."}),e.jsx(Y,{label:"Planification"}),e.jsx(at,{athleteId:s,interviewDate:t.date}),e.jsx(Y,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(ee,{label:"Engagements du nageur",text:t.athlete_commitments}),e.jsx(qe,{label:"Actions du coach",value:E,onChange:C,onBlur:I,placeholder:"Actions concrÃ¨tes, points de suivi..."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:_.isPending?"Sauvegarde...":"Sauvegarde automatique a la sortie d'un champ."})]}),(z==="sent"||z==="signed")&&e.jsxs(e.Fragment,{children:[j&&e.jsx(nt,{prevInterview:j,commitmentReview:t.athlete_commitment_review}),e.jsx(Y,{label:"RÃ©ussites"}),e.jsx(ee,{label:"Nageur",text:t.athlete_successes}),e.jsx(Ee,{label:"Coach",text:t.coach_comment_successes||t.coach_review}),e.jsx(Y,{label:"DifficultÃ©s"}),e.jsx(ee,{label:"Nageur",text:t.athlete_difficulties}),e.jsx(Ee,{label:"Coach",text:t.coach_comment_difficulties}),e.jsx(Y,{label:"Objectifs"}),o.length>0&&e.jsx("div",{className:"space-y-1.5",children:o.map(q=>e.jsx(st,{objective:q,performances:c},q.id))}),e.jsx(ee,{label:"Nageur",text:t.athlete_goals}),e.jsx(Ee,{label:"Coach",text:t.coach_comment_goals||t.coach_objectives}),e.jsx(Y,{label:"Planification"}),e.jsx(at,{athleteId:s,interviewDate:t.date}),e.jsx(Y,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(ee,{label:"Engagements du nageur",text:t.athlete_commitments}),e.jsx(Ee,{label:"Actions du coach",text:t.coach_actions})]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[z==="draft_coach"&&e.jsxs(O,{className:"w-full",onClick:()=>m(!0),disabled:M,children:[e.jsx(Ye,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer au nageur"]}),e.jsxs(O,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>K(!0),disabled:M,children:[e.jsx(Le,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})]})]}),e.jsx(te,{open:R,onOpenChange:K,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Supprimer l'entretien"}),e.jsxs(re,{children:["Cette action est irrÃ©versible. L'entretien du ",t.date?ye(t.date):""," sera supprimÃ© dÃ©finitivement."]})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Annuler"}),e.jsx(ce,{onClick:()=>{pe.mutate(),K(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(te,{open:Q,onOpenChange:m,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Envoyer au nageur"}),e.jsx(re,{children:"L'entretien sera envoyÃ© au nageur pour consultation. Les sections coach seront enregistrÃ©es automatiquement."})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Annuler"}),e.jsxs(ce,{onClick:()=>{d.mutate(),m(!1)},children:[e.jsx(Ye,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer"]})]})]})}),e.jsx(te,{open:g,onOpenChange:y,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Entretien envoyÃ©"}),e.jsx(re,{children:r?e.jsxs(e.Fragment,{children:["L'entretien a bien Ã©tÃ© envoyÃ© Ã  ",e.jsx("strong",{children:n}),". Voulez-vous le notifier par SMS ?"]}):e.jsxs(e.Fragment,{children:["L'entretien a bien Ã©tÃ© envoyÃ© Ã  ",e.jsx("strong",{children:n}),". Aucun numÃ©ro de tÃ©lÃ©phone enregistrÃ© pour ce nageur."]})})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Plus tard"}),e.jsxs(ce,{onClick:$,disabled:!r,children:[e.jsx(Wt,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer le SMS"]})]})]})})]})},hs=({athleteId:t,athleteName:s})=>{const{toast:n}=ve(),r=be(),{data:o}=F({queryKey:["auth-uid",t],queryFn:()=>ms(t),enabled:!!t}),{data:c=[]}=F({queryKey:["objectives",o],queryFn:()=>p.getObjectives(o),enabled:!!o}),{data:a}=F({queryKey:["athlete-profile",t],queryFn:()=>p.getProfile({userId:t}),enabled:!!t}),x=a?.ffn_iuf??null,v=a?.phone??null,u=l.useMemo(()=>{const f=new Date;return f.setDate(f.getDate()-360),f.toISOString().slice(0,10)},[]),{data:h=[]}=F({queryKey:["swimmer-performances-recent",x],queryFn:()=>p.getSwimmerPerformances({iuf:x,fromDate:u}),enabled:!!x}),{data:b=[],isLoading:N}=F({queryKey:["interviews",t],queryFn:()=>p.getInterviews(t),enabled:!!t}),w=B({mutationFn:()=>p.createInterview({athlete_id:t}),onSuccess:()=>{n({title:"Entretien crÃ©Ã©"}),r.invalidateQueries({queryKey:["interviews",t]})},onError:f=>{n({title:"Erreur",description:f.message,variant:"destructive"})}});return N?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(f=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-24 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-20 rounded bg-muted"})]})},f))}):b.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ze,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun entretien pour ",s,"."]}),e.jsxs(O,{variant:"outline",size:"sm",onClick:()=>w.mutate(),disabled:w.isPending,children:[e.jsx(oe,{className:"mr-1.5 h-3.5 w-3.5"}),w.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Entretiens"}),e.jsx(U,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:b.length})]}),e.jsxs(O,{variant:"outline",size:"sm",onClick:()=>w.mutate(),disabled:w.isPending,children:[e.jsx(oe,{className:"mr-1.5 h-3.5 w-3.5"}),w.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}),e.jsx("div",{className:"space-y-2",children:b.map(f=>e.jsx(xs,{interview:f,athleteId:t,athleteName:s,athletePhone:v,objectives:c,performances:h},f.id))})]})},pt=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function ps({athleteId:t,athleteName:s,groupId:n}){const{userId:r}=lt(),{toast:o}=ve(),c=be(),{data:a,isLoading:x}=F({queryKey:["swimmer-slots",t],queryFn:()=>p.getSwimmerSlots(t)}),{data:v}=F({queryKey:["swimmer-slots-exists",t],queryFn:()=>p.hasCustomSlots(t)}),{data:u=[]}=F({queryKey:["training-slots","group",n],queryFn:()=>p.getTrainingSlotsForGroup(n)}),h=v===!0,b=h?a??[]:[],N=()=>{c.invalidateQueries({queryKey:["swimmer-slots",t]}),c.invalidateQueries({queryKey:["swimmer-slots-exists",t]})},w=B({mutationFn:()=>p.initSwimmerSlots(t,n,r),onSuccess:()=>{N(),o({title:"Planning personnalisÃ© crÃ©Ã©"})},onError:j=>o({title:"Erreur",description:j.message,variant:"destructive"})}),f=B({mutationFn:()=>p.resetSwimmerSlots(t,n,r),onSuccess:()=>{N(),o({title:"Planning rÃ©initialisÃ©"})},onError:j=>o({title:"Erreur",description:j.message,variant:"destructive"})}),T=B({mutationFn:j=>p.deleteSwimmerSlot(j),onSuccess:()=>{N(),o({title:"CrÃ©neau supprimÃ©"})}}),A=B({mutationFn:j=>p.createSwimmerSlot(j,r),onSuccess:()=>{N(),o({title:"CrÃ©neau ajoutÃ©"})},onError:j=>o({title:"Erreur",description:j.message,variant:"destructive"})}),D=B({mutationFn:({slotId:j,input:S})=>p.updateSwimmerSlot(j,S),onSuccess:()=>{N(),o({title:"CrÃ©neau modifiÃ©"})},onError:j=>o({title:"Erreur",description:j.message,variant:"destructive"})}),[E,C]=l.useState(null),[R,K]=l.useState(!1),[Q,m]=l.useState(!1),[g,y]=l.useState(null),P=l.useMemo(()=>{const j=h?b:u,S=new Map;for(const k of j){const _=S.get(k.day_of_week)??[];_.push(k),S.set(k.day_of_week,_)}return S},[h,b,u]);return x?e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((j,S)=>e.jsx(_t,{className:"h-14 rounded-lg"},S))}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between gap-2",children:h?e.jsxs(e.Fragment,{children:[e.jsxs(O,{size:"sm",variant:"outline",onClick:()=>K(!0),children:[e.jsx(oe,{className:"h-3.5 w-3.5 mr-1"}),"Ajouter"]}),e.jsxs(O,{size:"sm",variant:"ghost",onClick:()=>m(!0),children:[e.jsx(Ct,{className:"h-3.5 w-3.5 mr-1"}),"RÃ©initialiser"]})]}):e.jsxs(O,{size:"sm",onClick:()=>w.mutate(),disabled:w.isPending,children:[e.jsx(oe,{className:"h-3.5 w-3.5 mr-1"}),"Personnaliser le planning"]})}),!h&&u.length>0&&e.jsx("div",{className:"rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/30 px-3 py-2 text-sm text-blue-700 dark:text-blue-300",children:"HÃ©rite du planning du groupe. Cliquez sur Â« Personnaliser Â» pour ajuster."}),[1,2,3,4,5,6,7].map(j=>{const S=P.get(j);return!S||S.length===0?null:e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("h3",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:pt[j-1]}),S.map(k=>e.jsxs("button",{type:"button",className:"w-full flex items-center gap-3 rounded-lg border border-border bg-card px-3 py-2 text-left hover:bg-muted/50 transition",onClick:()=>h?C(k):void 0,children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-mono tabular-nums",children:[e.jsx(Oe,{className:"h-3.5 w-3.5 text-muted-foreground"}),k.start_time.slice(0,5)," â€“ ",k.end_time.slice(0,5)]}),e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground truncate",children:[e.jsx(It,{className:"h-3.5 w-3.5"}),k.location]}),h&&k.source_assignment_id&&e.jsx(Xt,{className:"h-3.5 w-3.5 text-blue-500 ml-auto flex-shrink-0"})]},k.id))]},j)}),P.size===0&&e.jsx("p",{className:"text-center text-sm text-muted-foreground py-8",children:"Aucun crÃ©neau configurÃ©."}),e.jsx(te,{open:Q,onOpenChange:m,children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"RÃ©initialiser le planning ?"}),e.jsx(re,{children:"Tous les crÃ©neaux personnalisÃ©s seront supprimÃ©s et remplacÃ©s par ceux du groupe."})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Annuler"}),e.jsx(ce,{onClick:()=>{f.mutate(),m(!1)},children:"RÃ©initialiser"})]})]})}),e.jsx(te,{open:!!g,onOpenChange:()=>y(null),children:e.jsxs(se,{children:[e.jsxs(ne,{children:[e.jsx(ae,{children:"Supprimer ce crÃ©neau ?"}),e.jsx(re,{children:"Le crÃ©neau sera retirÃ© du planning personnel."})]}),e.jsxs(ie,{children:[e.jsx(le,{children:"Annuler"}),e.jsx(ce,{onClick:()=>{g&&T.mutate(g),y(null)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(Fe,{open:!!E,onOpenChange:j=>!j&&C(null),children:e.jsxs(Ae,{side:"bottom",className:"max-h-[80vh]",children:[e.jsxs(Me,{children:[e.jsx(Pe,{children:"Modifier le crÃ©neau"}),e.jsx(Xe,{children:"Ajustez les horaires ou le lieu"})]}),E&&e.jsx(gs,{slot:E,onSave:j=>{D.mutate({slotId:E.id,input:j}),C(null)},onDelete:()=>{y(E.id),C(null)},isPending:D.isPending})]})}),e.jsx(Fe,{open:R,onOpenChange:K,children:e.jsxs(Ae,{side:"bottom",className:"max-h-[80vh]",children:[e.jsxs(Me,{children:[e.jsx(Pe,{children:"Ajouter un crÃ©neau"}),e.jsx(Xe,{children:"Nouveau crÃ©neau personnalisÃ©"})]}),e.jsx(js,{onSave:j=>{A.mutate({...j,user_id:t}),K(!1)},isPending:A.isPending})]})})]})}function gs({slot:t,onSave:s,onDelete:n,isPending:r}){const[o,c]=l.useState(t.start_time.slice(0,5)),[a,x]=l.useState(t.end_time.slice(0,5)),[v,u]=l.useState(t.location);return e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(W,{children:"DÃ©but"}),e.jsx(Z,{type:"time",value:o,onChange:h=>c(h.target.value)})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Fin"}),e.jsx(Z,{type:"time",value:a,onChange:h=>x(h.target.value)})]})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Lieu"}),e.jsx(Z,{value:v,onChange:h=>u(h.target.value)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(O,{className:"flex-1",onClick:()=>s({start_time:o,end_time:a,location:v}),disabled:r,children:"Enregistrer"}),e.jsx(O,{variant:"destructive",size:"icon",onClick:n,children:e.jsx(Le,{className:"h-4 w-4"})})]})]})}function js({onSave:t,isPending:s}){const[n,r]=l.useState("1"),[o,c]=l.useState("08:00"),[a,x]=l.useState("10:00"),[v,u]=l.useState("");return e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Jour"}),e.jsxs(ue,{value:n,onValueChange:r,children:[e.jsx(me,{children:e.jsx(xe,{})}),e.jsx(he,{children:pt.map((h,b)=>e.jsx(X,{value:String(b+1),children:h},b+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(W,{children:"DÃ©but"}),e.jsx(Z,{type:"time",value:o,onChange:h=>c(h.target.value)})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Fin"}),e.jsx(Z,{type:"time",value:a,onChange:h=>x(h.target.value)})]})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Lieu"}),e.jsx(Z,{value:v,onChange:h=>u(h.target.value),placeholder:"Piscine, Salle..."})]}),e.jsx(O,{className:"w-full",onClick:()=>t({day_of_week:Number(n),start_time:o,end_time:a,location:v}),disabled:s||!v,children:"Ajouter"})]})}function rt(t){const s=Math.floor((Date.now()-new Date(t).getTime())/864e5);return s===0?"aujourd'hui":s===1?"hier":s<0?`dans ${-s}j`:`il y a ${s}j`}async function fs(t){const{data:s,error:n}=await Ue.rpc("get_auth_uid_for_user",{p_user_id:t});return n?null:s}function sn({athleteId:t,athleteName:s,onBack:n}={}){const[,r]=wt("/coach/swimmer/:id"),[,o]=St(),{selectedAthleteId:c,selectedAthleteName:a}=lt(),[x,v]=l.useState("resume"),u=t??(r?.id?Number(r.id):c),h=s??a,{data:b}=F({queryKey:["profile",u],queryFn:()=>p.getProfile({userId:u}),enabled:u!=null}),N=300*1e3,{data:w}=F({queryKey:["sessions",u],queryFn:()=>p.getSessions(h??"",u),enabled:!!u,staleTime:N}),{data:f}=F({queryKey:["interviews",u],queryFn:()=>p.getInterviews(u),enabled:!!u,staleTime:N}),{data:T}=F({queryKey:["training-cycles",u],queryFn:()=>p.getTrainingCycles({athleteId:u}),enabled:!!u,staleTime:N}),{data:A}=F({queryKey:["auth-uid",u],queryFn:()=>fs(u),enabled:!!u,staleTime:N}),{data:D}=F({queryKey:["objectives",A],queryFn:()=>p.getObjectives(A),enabled:!!A,staleTime:N}),E=w?.[0]?.date??null,C=l.useMemo(()=>{if(!w||w.length===0)return null;const k=w.slice(0,7).map(_=>_.engagement).filter(_=>_!=null&&Number.isFinite(_));return k.length===0?null:k.reduce((_,d)=>_+d,0)/k.length},[w]),R=f?.length??0,K=f?.[0]?.date??null,Q=l.useMemo(()=>{if(!T||T.length===0)return null;const S=new Date().toISOString().slice(0,10);return T.find(_=>{const d=_.start_date??_.start_competition_date??"",$=_.end_competition_date??"";return d<=S&&$>=S})?.name??T[0]?.name??null},[T]),m=D?.length??0,g=b?.display_name??h??"Nageur",y=b?.avatar_url??null,P=b?.group_label??null,j=n??(()=>o("/coach?section=swimmers"));return u?e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:j,className:"h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition","aria-label":"Retour",children:e.jsx(Ht,{className:"h-4 w-4"})}),y?e.jsx("img",{src:y,alt:"",className:"h-10 w-10 rounded-full object-cover border border-border"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary",children:g.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-lg font-bold truncate",children:g}),P&&e.jsx(U,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:P})]})]}),e.jsxs(kt,{value:x,onValueChange:S=>v(S),children:[e.jsxs(Tt,{className:"grid h-auto w-full grid-cols-2 gap-2 bg-transparent p-0",children:[e.jsx(Se,{value:"resume",className:"rounded-xl border bg-card px-3 py-2 text-xs data-[state=active]:border-primary data-[state=active]:bg-primary/5",children:"RÃ©sumÃ©"}),e.jsx(Se,{value:"suivi",className:"rounded-xl border bg-card px-3 py-2 text-xs data-[state=active]:border-primary data-[state=active]:bg-primary/5",children:"Suivi"}),e.jsx(Se,{value:"echanges",className:"rounded-xl border bg-card px-3 py-2 text-xs data-[state=active]:border-primary data-[state=active]:bg-primary/5",children:"Ã‰changes"}),e.jsx(Se,{value:"planif",className:"rounded-xl border bg-card px-3 py-2 text-xs data-[state=active]:border-primary data-[state=active]:bg-primary/5",children:"Planif"})]}),e.jsx(ke,{value:"resume",className:"mt-4 space-y-3",children:e.jsxs("div",{className:"rounded-2xl border bg-card p-4",children:[e.jsx("p",{className:"text-sm font-semibold",children:"Vue rapide"}),e.jsxs("p",{className:"mt-1 text-sm text-muted-foreground",children:["AccÃ¨s direct au suivi, aux entretiens et Ã  la planification de ",g,"."]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>v("suivi"),className:"rounded-xl border px-3 py-3 text-left active:bg-muted",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Suivi"})]}),e.jsx("p",{className:"mt-1.5 text-xs text-muted-foreground truncate",children:w===void 0?"...":E?`Dernier : ${rt(E)}`:"Aucun ressenti"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:w===void 0?"":C!=null?`Engagement moy. : ${C.toFixed(1)}/5`:"â€”"})]}),e.jsxs("button",{type:"button",onClick:()=>v("echanges"),className:"rounded-xl border px-3 py-3 text-left active:bg-muted",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"h-4 w-4 text-violet-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Ã‰changes"})]}),e.jsx("p",{className:"mt-1.5 text-xs text-muted-foreground truncate",children:f===void 0?"...":R>0?`${R} entretien${R>1?"s":""}`:"Aucun entretien"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:f===void 0?"":K?`Dernier : ${rt(K)}`:"â€”"})]}),e.jsxs("button",{type:"button",onClick:()=>v("planif"),className:"rounded-xl border px-3 py-3 text-left active:bg-muted",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-4 w-4 text-emerald-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Planif"})]}),e.jsx("p",{className:"mt-1.5 text-xs text-muted-foreground truncate",children:T===void 0?"...":Q||"Aucun cycle"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:T===void 0?"":T.length>0?`${T.length} cycle${T.length>1?"s":""}`:"â€”"})]}),e.jsxs("button",{type:"button",onClick:()=>v("suivi"),className:"rounded-xl border px-3 py-3 text-left active:bg-muted",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Objectifs"})]}),e.jsx("p",{className:"mt-1.5 text-xs text-muted-foreground truncate",children:D===void 0?"...":m>0?`${m} objectif${m>1?"s":""}`:"Aucun objectif"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:D===void 0?"":"â€”"})]})]})]})}),e.jsxs(ke,{value:"suivi",className:"mt-4 space-y-4",children:[e.jsxs("section",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h2",{className:"text-sm font-semibold",children:"Ressentis"})]}),e.jsx(Dt,{athleteId:u,athleteName:g,showProgressAction:!1})]}),e.jsxs("section",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h2",{className:"text-sm font-semibold",children:"Objectifs"})]}),e.jsx(ns,{athleteId:u,athleteName:g})]})]}),e.jsxs(ke,{value:"echanges",className:"mt-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ze,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h2",{className:"text-sm font-semibold",children:"Entretiens"})]}),e.jsx(hs,{athleteId:u,athleteName:g})]}),e.jsxs(ke,{value:"planif",className:"mt-4 space-y-4",children:[e.jsxs("section",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h2",{className:"text-sm font-semibold",children:"Cycle"})]}),e.jsx(is,{athleteId:u})]}),e.jsxs("section",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h2",{className:"text-sm font-semibold",children:"CrÃ©neaux"})]}),e.jsx(ps,{athleteId:u,athleteName:g,groupId:b?.group_id??0})]})]})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx("p",{children:"Aucun nageur sÃ©lectionnÃ©."}),e.jsx("button",{type:"button",onClick:j,className:"mt-2 text-primary underline",children:"Retour au dashboard"})]})}export{sn as default};
