import{r as a,j as e,c as vt,u as je,d as he,R as Ce}from"./vendor-query-DyA9aSKS.js";import{c as qt}from"./date-DrpgLmFD.js";import{a as R}from"./api-BCcY6pA7.js";import{c as Fe,b as Rt,W as wt,X as kt,F as St,P as Be,u as nt,d as Qt,s as Je,B as Mt,T as zt}from"./index-DA5GZgf4.js";import{D as Ht,a as Jt,b as Ut,c as Yt}from"./dialog-BGjpIavx.js";import{M as Vt,C as Wt,a as Xt}from"./CalendarGrid-ByHBUS8O.js";import{B as Gt}from"./BottomActionBar-BGVunH_C.js";import{a as Zt,s as es,l as rt}from"./animations-CrcLFysI.js";import{d as Ue}from"./design-tokens-CKgCpdH6.js";import{C as Dt}from"./chevron-right-bZb46x4_.js";import{A as _e,m as me}from"./vendor-motion-CMsaQ8FX.js";import{P as ts}from"./power-DqJeprWF.js";import{C as it}from"./chevron-down-CTrnTHGN.js";import{C as tt}from"./index-BLRVfVG-.js";import{C as Ye}from"./circle-DH1cqOmn.js";import{T as $e}from"./trash-2-BjH2BhKw.js";import{A as ot,S as ss,H as at,f as Ve,p as ns}from"./SwimTimeInput-Dpm_N5PN.js";import{T as lt}from"./timer-BN89JCnx.js";import{P as rs}from"./pencil-CUYfEQG1.js";import{I as is}from"./InlineBanner-2ckDYPuq.js";import{C as os}from"./circle-alert-DK9s8FNB.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-date-B8Mnp-Vt.js";import"./swim-_c6SQ4vB.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-BPfI1gVE.js";import"./chevron-left-Bzq5FQC-.js";import"./loader-circle-BQajqgQY.js";import"./circle-check-BExdE6ip.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=[["path",{d:"M5 12h14",key:"1ays0h"}]],_t=Fe("minus",as);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],cs=Fe("settings-2",ls);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],us=Fe("sun",ds);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],ct=Fe("user-check",ms);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Le=Fe("user-x",xs),We={NL:"",DOS:"",BR:"",PAP:"",QN:""};function dt(t){return String(t).padStart(2,"0")}function ut(t){return`${t.getFullYear()}-${dt(t.getMonth()+1)}-${dt(t.getDate())}`}function mt(t){return new Date(t.getFullYear(),t.getMonth(),1)}function xt(t,n){const o=new Date(t);return o.setDate(o.getDate()+n),o}function Xe(t){return(t.getDay()+6)%7}function Ae(t){const n=Number(t);return Number.isFinite(n)?Math.round(n/1e3*100)/100:0}function ps(t){const n=Number(t);return Number.isFinite(n)?Math.round(n*1e3):0}function fs(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(o=>o.trim()).filter(Boolean).flatMap(o=>{const r=o.replace(/^[•\\-–—]\\s*/,"").trim();return r?[r]:[]}):[]}function bs(t){if(!t)return null;const o=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!o)return null;const r=Number(String(o[1]).replace(",","."));return Number.isFinite(r)?o[2].toLowerCase()==="m"?Ae(r):r:null}function gs(t,n){const o=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,r=String(o||"").toLowerCase();if(r.includes("mat")||r.includes("morning")||r==="am")return"AM";if(r.includes("soir")||r.includes("evening")||r==="pm")return"PM";const f=`${t?.title??""} ${t?.description??""}`.toLowerCase();return f.includes("matin")||f.includes(" am ")||f.includes("(am)")?"AM":f.includes("soir")||f.includes(" pm ")||f.includes("(pm)")?"PM":n===0?"AM":"PM"}function hs(t){const n=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!n)return null;const o=String(n),r=o.length>=10?o.slice(0,10):o;return/\d{4}-\d{2}-\d{2}/.test(r)?r:null}function ys(t){if(Array.isArray(t?.items)){let f=0;for(const m of t.items){const N=Number(m?.distance);if(!Number.isFinite(N)||N<=0)continue;const p=m?.raw_payload,v=Number(p?.exercise_repetitions),y=Number(p?.block_repetitions),S=Number.isFinite(v)&&v>0?v:1,C=Number.isFinite(y)&&y>0?y:1;f+=N*S*C}if(f>0)return Ae(f)}const n=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(n!=null&&Number.isFinite(Number(n))){const f=Number(n);return f>0&&f<=50?f:Ae(f)}const o=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(o!=null&&Number.isFinite(Number(o)))return Number(o);const r=bs(`${t?.title??""} ${t?.description??""}`);return r??null}function Ns(t){if(!Array.isArray(t)||t.length===0)return null;const n={crawl:"NL",dos:"DOS",brasse:"BR",pap:"PAP","4n":"QN"},o={NL:0,DOS:0,BR:0,PAP:0,QN:0};for(const f of t){const m=Number(f?.distance);if(!Number.isFinite(m)||m<=0)continue;const N=f?.raw_payload,p=Number(N?.exercise_repetitions),v=Number(N?.block_repetitions),y=Number.isFinite(p)&&p>0?p:1,S=Number.isFinite(v)&&v>0?v:1,C=m*y*S,z=N?.exercise_stroke??N?.stroke??"crawl",te=n[String(z).toLowerCase()];te?o[te]+=C:o.NL+=C}return Object.values(o).some(f=>f>0)?o:null}function pt(t){const n=Number(t);if(!Number.isFinite(n))return"—";const o=Math.round(n*100)/100,r=String(o);return r.endsWith(".0")?r.slice(0,-2):r}function js(){const t={};for(let n=0;n<7;n++)t[n]={AM:!0,PM:!0};return t}function Ge(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function vs({sessions:t,assignments:n,userId:o,user:r}){const f=`swim-dashboard-v2:${o??r??"anon"}`,m=`${f}:presenceDefaults`,N=`${f}:attendanceOverrides`,p=`${f}:stableFields`,[v,y]=a.useState(()=>js()),[S,C]=a.useState({}),[z,te]=a.useState(90);a.useEffect(()=>{if(typeof window>"u")return;const l=Ge(window.localStorage.getItem(m));l&&y(l);const c=Ge(window.localStorage.getItem(N));c&&C(c);const x=Ge(window.localStorage.getItem(p));x?.duration&&Number.isFinite(x.duration)&&x.duration>=30&&x.duration<=240&&te(x.duration)},[m,N,p]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(m,JSON.stringify(v))},[v,m]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(N,JSON.stringify(S))},[S,N]),a.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(p,JSON.stringify({duration:z}))},[z,p]);const oe=a.useMemo(()=>new Date,[]),[ae,xe]=a.useState(()=>mt(new Date)),[H,le]=a.useState(()=>ut(new Date)),[W,d]=a.useState(!1),[h,M]=a.useState(!1),[D,T]=a.useState(!1),[B,X]=a.useState(null),[ye,ce]=a.useState(!1),[ve,be]=a.useState(null),[ge,A]=a.useState(!1),[$,L]=a.useTransition(),K=a.useMemo(()=>(Array.isArray(n)?n:[]).filter(c=>c?.session_type==="swim"),[n]),F=a.useMemo(()=>{const l=new Map;for(const c of K){const x=hs(c);x&&(l.has(x)||l.set(x,[]),l.get(x).push(c))}for(const[c,x]of l.entries())x.sort((b,g)=>Number(b?.id??0)-Number(g?.id??0)),l.set(c,x);return l},[K]),w=a.useMemo(()=>{const l=Array.isArray(t)?t:[],c={};for(const x of l){const b=String(x?.date??"").slice(0,10),g=x?.slot==="Soir"?"PM":"AM";c[`${b}__${g}`]=x}return c},[t]),J=a.useRef(new Map);a.useEffect(()=>{J.current.clear()},[F]);const U=a.useCallback(l=>{const c=J.current;if(c.has(l))return c.get(l);const x=[{id:`${l}__AM`,iso:l,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${l}__PM`,iso:l,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],b=(F.get(l)??[]).slice().sort((k,Z)=>(Number(Z.id)||0)-(Number(k.id)||0)),g=new Set;return b.forEach((k,Z)=>{const P=k,se=gs(P,Z);if(g.has(se))return;const Ne=se==="AM"?0:1,fe=ys(P),ee=Array.isArray(P?.details)?P.details.map(String):fs(k?.description);x[Ne]={id:`${l}__${se}`,iso:l,slotKey:se,title:String(k?.title??"Séance coach"),km:fe,details:ee,assignmentId:typeof k?.id=="number"?k.id:Number(k?.id)||void 0,isEmpty:!1},g.add(se)}),c.set(l,x),x},[F]),G=a.useCallback((l,c)=>{const x=Xe(c),b=!!v?.[x]?.[l.slotKey],g=S[l.id];return g==="present"?{status:"present",expected:!0,expectedByDefault:b}:g==="absent"?{status:"absent",expected:!0,expectedByDefault:b}:b?{status:"present",expected:!0,expectedByDefault:b}:{status:"not_expected",expected:!1,expectedByDefault:b}},[S,v]),_=a.useMemo(()=>mt(ae),[ae]),Y=a.useMemo(()=>{const l=Xe(_),c=xt(_,-l),x=[];for(let b=0;b<42;b++)x.push(xt(c,b));return x},[_]),O=a.useMemo(()=>{const l={};for(const c of Y){const x=ut(c),b=U(x);let g=0,k=0;const Z=[];for(const P of b){const se=G(P,c);if(!se.expected){Z.push({slotKey:P.slotKey,expected:!1,completed:!1,absent:!1});continue}g+=1;const Ne=!!w[P.id],fe=se.status==="absent";Ne&&(k+=1),Z.push({slotKey:P.slotKey,expected:!0,completed:Ne,absent:fe})}l[x]={completed:k,total:g,slots:Z}}return l},[Y,U,G,w]),Q=a.useMemo(()=>{const[l,c,x]=H.split("-").map(Number);return new Date(l,c-1,x)},[H]),q=a.useMemo(()=>U(H),[U,H]),ne=O[H]||{completed:0,total:2,slots:[{slotKey:"AM",expected:!0,completed:!1,absent:!1},{slotKey:"PM",expected:!0,completed:!1,absent:!1}]},pe=a.useMemo(()=>{const l=Array.isArray(t)?t:[];let c=0;for(const x of l){const b=String(x?.date??"").slice(0,10),g=x?.slot==="Soir"?"PM":"AM",k=`${b}__${g}`;if(S[k]==="absent")continue;const Z=Xe(new Date(b));(v?.[Z]?.[g]||S[k]==="present")&&Number.isFinite(Number(x?.distance))&&(c+=Number(x.distance))}return pt(Ae(c))},[t,S,v]),Oe=a.useMemo(()=>{const l=q;let c=0;for(const x of l){const b=G(x,Q);if(!b.expected||b.status==="absent")continue;const g=w[x.id];g&&Number.isFinite(Number(g?.distance))&&(c+=Number(g.distance))}return pt(Ae(c))},[q,G,Q,w]),we=a.useMemo(()=>B&&w[B]||null,[B,w]),de=a.useMemo(()=>{const l=we||{},c=l?.stroke_distances,x=c?{NL:c.NL?String(c.NL):"",DOS:c.DOS?String(c.DOS):"",BR:c.BR?String(c.BR):"",PAP:c.PAP?String(c.PAP):"",QN:c.QN?String(c.QN):""}:We;return{difficulty:l?.effort??null,fatigue_end:l?.fatigue??l?.feeling??null,performance:l?.performance??l?.feeling??null,engagement:l?.engagement??l?.feeling??null,comment:String(l?.comments??""),distanceMeters:Number.isFinite(Number(l?.distance))?Number(l.distance):null,showStrokeDetail:!!(c&&Object.values(c).some(b=>b&&b>0)),strokes:x,exerciseLogs:[]}},[we]),[re,ie]=a.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:We,exerciseLogs:[]}));return a.useEffect(()=>{const l=q.find(c=>c.id===B);if(l){const c=l.km!=null?ps(l.km):5e3;let x=We;if(l.assignmentId){const g=(n??[]).find(k=>k.id===l.assignmentId);if(g?.items){const k=Ns(g.items);k&&(x={NL:String(k.NL||""),DOS:String(k.DOS||""),BR:String(k.BR||""),PAP:String(k.PAP||""),QN:String(k.QN||"")})}}const b=Object.values(de.strokes).some(g=>g&&Number(g)>0);ie(g=>({...g,...de,distanceMeters:de.distanceMeters==null?c:de.distanceMeters,strokes:b?de.strokes:x,showStrokeDetail:b||Object.values(x).some(k=>k&&Number(k)>0)}));return}ie(c=>({...c,...de}))},[de,B,q,n]),a.useEffect(()=>{const l=()=>{d(!1),M(!1),T(!1),X(null),ce(!1),be(null)};return window.addEventListener("nav:reset",l),()=>window.removeEventListener("nav:reset",l)},[]),a.useEffect(()=>{W&&ge&&ne.total>0&&ne.completed>=ne.total&&(d(!1),X(null),ce(!1),A(!1))},[W,ge,ne.completed,ne.total]),{today:oe,monthCursor:ae,selectedISO:H,drawerOpen:W,settingsOpen:h,infoOpen:D,activeSessionId:B,detailsOpen:ye,selectedDayIndex:ve,isPending:$,presenceDefaults:v,attendanceOverrideBySessionId:S,stableDurationMin:z,draftState:re,gridDates:Y,completionByISO:O,selectedDate:Q,sessionsForSelectedDay:q,selectedDayStatus:ne,globalKm:pe,dayKm:Oe,logsBySessionId:w,setMonthCursor:xe,setSelectedISO:le,setDrawerOpen:d,setSettingsOpen:M,setInfoOpen:T,setActiveSessionId:X,setDetailsOpen:ce,setSelectedDayIndex:be,setPresenceDefaults:y,setAttendanceOverrideBySessionId:C,setStableDurationMin:te,setDraftState:ie,setAutoCloseArmed:A,startTransition:L,getSessionStatus:G,getSessionsForISO:U}}function Ze(...t){return t.filter(Boolean).join(" ")}const ft={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function ws({strokes:t,showStrokeDetail:n,disabled:o=!1,onToggle:r,onChange:f}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:o,onClick:r,className:Ze("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",o?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(Dt,{className:Ze("h-4 w-4 transition-transform",n&&"rotate-90")})]}),n&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(ft).map(m=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:ft[m]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:o,value:t[m],onChange:N=>f({...t,[m]:N.target.value}),placeholder:"0",className:Ze("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",o?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},m))})]})}function I(...t){return t.filter(Boolean).join(" ")}function ks(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function qe(t){const n=Number(t);if(!Number.isFinite(n))return"—";const o=Math.round(n*100)/100,r=String(o);return r.endsWith(".0")?r.slice(0,-2):r}function bt(t){const n=Number(t);return Number.isFinite(n)?Math.round(n/1e3*100)/100:0}function Ss(t){const n=Number(t);return Number.isFinite(n)?Math.round(n*1e3):0}const et=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],Ms=[{key:"AM",label:"Matin",Icon:us},{key:"PM",label:"Soir",Icon:Vt}];function Pe({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function Ke({onClick:t,label:n,children:o,tone:r="neutral",disabled:f}){const m={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:f,className:I("inline-flex items-center justify-center rounded-2xl border p-2 transition",m[r],f&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":n,title:n,children:[o,e.jsx("span",{className:"sr-only",children:n})]})}function Ds(t,n){const o=Number(n);return!Number.isFinite(o)||o<1||o>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[o]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[o]}function _s({plannedMeters:t,valueMeters:n,onChange:o,disabled:r}){const p=Number.isFinite(Number(n))?Number(n):t,v=p-t;return e.jsxs("div",{className:I("mt-4 rounded-3xl border px-4 py-3",r?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:I("text-xs font-semibold",r?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),v!==0&&e.jsx("div",{className:I("text-xs font-semibold px-2 py-0.5 rounded-full",v>0?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"),children:v>0?`+${v}m`:`${v}m`})]}),e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:I("text-xs","text-muted-foreground"),children:["Planifié : ",t,"m (",qe(bt(t))," km)"]})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:r||p-100<0,onClick:()=>o(p-100),className:I("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",r?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"-100m",children:e.jsx(_t,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-[140px] text-center",children:[e.jsxs("div",{className:I("text-2xl font-bold",r?"text-muted-foreground":"text-foreground"),children:[p,"m"]}),e.jsxs("div",{className:I("text-sm font-medium mt-0.5",r?"text-muted-foreground":"text-primary"),children:[qe(bt(p))," km"]})]}),e.jsx("button",{type:"button",disabled:r||p+100>3e4,onClick:()=>o(p+100),className:I("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",r?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"+100m",children:e.jsx(Be,{className:"h-5 w-5"})})]})]})}function Cs({onMark:t}){const[n,o]=a.useState(!1),[r,f]=a.useState("");return n?e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",placeholder:"Motif (optionnel)",value:r,onChange:m=>f(m.target.value),className:"flex-1 rounded-md border border-input bg-transparent px-3 py-1.5 text-sm",autoFocus:!0}),e.jsx("button",{type:"button",onClick:()=>{t(r||void 0),o(!1),f("")},className:"rounded-md bg-primary px-3 py-1.5 text-sm font-medium text-primary-foreground",children:"OK"})]}):e.jsx("button",{type:"button",className:"w-full rounded-xl border border-dashed border-muted-foreground/30 p-2.5 mb-3 text-sm text-muted-foreground hover:bg-muted/50 transition-colors",onClick:()=>o(!0),children:"Marquer indisponible"})}function As({open:t,selectedDate:n,sessionsForSelectedDay:o,selectedDayStatus:r,dayKm:f,activeSessionId:m,detailsOpen:N,draftState:p,saveState:v,isPending:y,logsBySessionId:S,onClose:C,onDayOffAll:z,onOpenSession:te,onCloseSession:oe,onToggleDetails:ae,onMarkAbsent:xe,onMarkPresent:H,onClearOverride:le,onSaveFeedback:W,onDraftStateChange:d,getSessionStatus:h,isAbsent:M,absenceReason:D,onDeleteFeedback:T,onMarkDayAbsent:B,onRemoveDayAbsence:X}){const[,ye]=Rt(),[ce,ve]=a.useState(!1),[be,ge]=a.useState(!1),A=a.useMemo(()=>m&&o.find($=>$.id===m)||null,[m,o]);return a.useEffect(()=>{ge(!1)},[m]),e.jsx(_e,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(me.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:C}),e.jsx(me.div,{className:I("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:Zt,initial:"hidden",animate:"visible",exit:"exit",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden",children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-primary/15 bg-background px-4 sm:px-5 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground shrink-0",children:e.jsx(wt,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-sm font-display font-bold uppercase italic tracking-tight text-primary",children:ks(n)})})]}),e.jsx(Ke,{onClick:C,label:"Fermer",children:e.jsx(kt,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-lg font-bold text-foreground",children:[f," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:I("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:I("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})}),e.jsx(Ke,{onClick:z,label:"OFF (absent journée)",tone:"dark",disabled:y,children:e.jsx(ts,{className:"h-5 w-5"})})]}),A?null:e.jsx("div",{className:"mt-3 rounded-2xl border border-border bg-muted/20 px-3 py-2 text-xs text-muted-foreground",children:"Choisis un créneau pour saisir ton ressenti. Une fois ouvert, la saisie prend toute la place."}),!A&&B&&X&&(M?e.jsxs("div",{className:"rounded-xl border border-muted bg-muted/30 p-3 mt-3 mb-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Marqué indisponible"}),e.jsx("button",{type:"button",onClick:X,className:"text-xs text-primary hover:underline",children:"Annuler"})]}),D&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:D})]}):e.jsx("div",{className:"mt-3",children:e.jsx(Cs,{onMark:B})})),!A&&(()=>{const $=[],L=[];for(const F of o)h(F,n).status==="not_expected"?L.push(F):$.push(F);const K=F=>{const w=h(F,n),J=!!S[F.id],U=w.status==="absent",G=w.status==="not_expected",_=U||G,Y=w.expected&&!J&&!U,O=J?"bg-status-success-bg border-status-success/30":_?"bg-sky-50 border-sky-200":Y?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",Q=Ms.find(q=>q.key===F.slotKey)?.Icon||Ye;return e.jsx("button",{type:"button",onClick:()=>te(F.id),className:I("w-full rounded-3xl border px-3 py-3 text-left transition",O,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:I("h-10 w-10 rounded-2xl border flex items-center justify-center",J?"border-status-success/30 bg-status-success-bg":_?"border-sky-200 bg-sky-100":Y?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(Q,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:F.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[F.isEmpty?e.jsx(Pe,{children:"Vide"}):e.jsxs(Pe,{children:[qe(F.km)," km"]}),J&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(tt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),_&&!J&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Le,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),Y&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[G&&e.jsx(Ke,{onClick:q=>{q.stopPropagation(),H(F.id)},label:"Je suis venu",disabled:y,children:e.jsx(ct,{className:"h-5 w-5"})}),w.expected&&!J&&!U&&e.jsx(Ke,{onClick:q=>{q.stopPropagation(),xe(F.id)},label:"Absent",tone:"sky",disabled:y,children:e.jsx(Le,{className:"h-5 w-5"})})]})]})},F.id)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4 grid gap-2",children:$.map(K)}),L.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",onClick:()=>ve(F=>!F),className:"flex w-full items-center gap-2 rounded-2xl px-3 py-2 text-xs font-semibold text-muted-foreground hover:bg-muted transition",children:[e.jsx(it,{className:I("h-4 w-4 transition-transform",ce&&"rotate-180")}),"Autres séances (",L.length,")"]}),e.jsx(_e,{children:ce&&e.jsx(me.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"mt-1 grid gap-2",children:L.map(K)})})})]})]})})(),e.jsx(_e,{children:A&&e.jsx(me.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:Ue.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const $=h(A,n),L=$.status==="absent",K=$.status==="not_expected",F=!!S[A.id],w=$.expected&&!L,J=L?"Annuler":K?"Je suis venu":"Absent",U=L?()=>le(A.id):K?()=>H(A.id):()=>xe(A.id),G=Ss(A.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-[10px] font-semibold uppercase tracking-[0.14em] text-muted-foreground",children:"Créneau sélectionné"}),e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:A.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[A.isEmpty?e.jsx(Pe,{children:"Vide"}):e.jsxs(Pe,{children:[qe(A.km)," km"]}),F?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(tt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):L||K?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Le,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx("button",{type:"button",onClick:oe,className:"rounded-2xl border border-border bg-card px-3 py-2 text-xs font-semibold text-foreground hover:bg-muted",children:"Retour aux créneaux"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:U,className:I("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",K?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[K?e.jsx(ct,{className:"h-4 w-4"}):e.jsx(Le,{className:"h-4 w-4"}),J]}),e.jsxs("button",{type:"button",onClick:ae,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(St,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(_e,{children:N&&e.jsx(me.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:Ue.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:e.jsx("button",{type:"button",onClick:()=>ye(A.assignmentId?`/swim-session?assignmentId=${A.assignmentId}`:"/swim-session"),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:A.assignmentId?"Ouvrir la fiche complète":"Saisir mes détails techniques"})})}),e.jsxs("div",{className:"px-4 pb-4",children:[!w&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:L?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(me.div,{className:"space-y-4",variants:es,initial:"hidden",animate:"visible",children:[et.map(_=>{const Y=p[_.key];return e.jsxs(me.div,{className:"space-y-2",variants:rt,children:[e.jsx("div",{className:I("text-sm font-semibold",w?"text-foreground":"text-muted-foreground"),children:_.label}),e.jsx("div",{className:"flex items-center gap-2",children:[1,2,3,4,5].map(O=>{const Q=Y===O;return e.jsx("button",{type:"button",disabled:!w,onClick:()=>d({...p,[_.key]:O}),className:I("h-11 w-11 rounded-2xl border text-sm font-semibold transition",w?Q?Ds(_.mode,O):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:O},O)})})]},_.key)}),e.jsxs(me.div,{className:"space-y-2",variants:rt,children:[e.jsx("div",{className:I("text-sm font-semibold",w?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:p.comment,onChange:_=>d({...p,comment:_.target.value}),disabled:!w,rows:3,placeholder:"Sensations, points techniques…",className:I("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",w?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-muted/20 overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>ge(_=>!_),className:"flex w-full items-center justify-between gap-3 px-4 py-3 text-left",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Ajustements avancés"}),e.jsx("div",{className:"mt-0.5 text-xs text-muted-foreground",children:"Kilométrage, détail par nage et suppression du ressenti"})]}),e.jsx(it,{className:I("h-4 w-4 shrink-0 text-muted-foreground transition-transform",be&&"rotate-180")})]}),e.jsx(_e,{initial:!1,children:be?e.jsx(me.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:Ue.normal},className:"overflow-hidden border-t border-border",children:e.jsxs("div",{className:"px-3 pb-3",children:[e.jsx(_s,{plannedMeters:G,valueMeters:p.distanceMeters,onChange:_=>d({...p,distanceMeters:_}),disabled:!w}),e.jsx(ws,{strokes:p.strokes,showStrokeDetail:p.showStrokeDetail,disabled:!w,onToggle:()=>d({...p,showStrokeDetail:!p.showStrokeDetail}),onChange:_=>d({...p,strokes:_})}),F&&T?e.jsxs("button",{type:"button",onClick:()=>{window.confirm("Supprimer ce ressenti ?")&&T(A.id)},disabled:y,className:"mt-4 w-full rounded-2xl border border-destructive/30 bg-destructive/5 px-3 py-2.5 text-sm font-medium text-destructive hover:bg-destructive/10 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-2",children:[e.jsx($e,{className:"h-4 w-4"}),"Supprimer le ressenti"]}):null]})}):null})]})]})]})})()},A.id)})]}),A&&(()=>{const $=h(A,n),L=$.expected&&$.status!=="absent";return e.jsxs(Gt,{saveState:v,position:"static",children:[e.jsx("button",{type:"button",onClick:W,disabled:y||!L||!et.every(K=>Number.isInteger(p[K.key])),className:I("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",y||!L?"bg-muted text-muted-foreground cursor-not-allowed":et.every(K=>Number.isInteger(p[K.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["→"," km"]})]})})()]})})]})})}function Fs(...t){return t.filter(Boolean).join(" ")}function Os(t){try{return new Date(t).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return t}}function Es({userId:t,expanded:n,onToggle:o}){const r=vt(),{data:f,isLoading:m}=je({queryKey:["swim-exercise-logs-history",t],queryFn:()=>R.getSwimExerciseLogsHistory(t,100),enabled:!!t&&n}),N=he({mutationFn:({logId:y,patch:S})=>R.updateSwimExerciseLog(y,S),onSuccess:()=>{r.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),p=he({mutationFn:y=>R.deleteSwimExerciseLog(y),onSuccess:()=>{r.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),v=Ce.useMemo(()=>{if(!f?.length)return[];const y=new Map;for(const S of f){const C=(S.created_at??"").slice(0,10);y.has(C)||y.set(C,[]),y.get(C).push(S)}return Array.from(y.entries()).map(([S,C])=>({date:S,entries:C}))},[f]);return e.jsxs("div",{className:"mt-6",children:[e.jsxs("button",{type:"button",onClick:o,className:"flex w-full items-center justify-between rounded-2xl border border-dashed border-border/80 bg-background px-3 py-2.5 text-left transition hover:bg-muted/40",children:[e.jsxs("span",{className:"flex min-w-0 items-center gap-2",children:[e.jsx("span",{className:"flex h-8 w-8 shrink-0 items-center justify-center rounded-xl bg-muted text-muted-foreground",children:e.jsx(St,{className:"h-4 w-4"})}),e.jsxs("span",{className:"min-w-0",children:[e.jsx("span",{className:"block truncate text-sm font-semibold text-foreground",children:"Notes techniques"}),e.jsx("span",{className:"block truncate text-[11px] text-muted-foreground",children:"Repères détaillés, consultation optionnelle"})]})]}),e.jsx(Dt,{className:Fs("h-4 w-4 transition-transform",n&&"rotate-90")})]}),n&&e.jsxs("div",{className:"mt-2 space-y-3 rounded-2xl border border-border/60 bg-card/60 p-2",children:[m&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Chargement..."}),!m&&v.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucune note technique enregistree."}),v.map(({date:y,entries:S})=>e.jsxs("div",{className:"rounded-2xl border border-border overflow-hidden",children:[e.jsx("div",{className:"bg-muted/50 px-3 py-2 text-xs font-semibold text-muted-foreground",children:Os(y)}),e.jsx("div",{className:"divide-y divide-border",children:S.map(C=>e.jsx(Is,{log:C,onSave:z=>N.mutate({logId:C.id,patch:z}),onDelete:()=>p.mutate(C.id),saving:N.isPending},C.id))})]},y))]})]})}function Is({log:t,onSave:n,onDelete:o,saving:r}){const[f,m]=a.useState(!1),[N,p]=a.useState({notes:t.notes??"",tempo:t.tempo,split_times:t.split_times,stroke_count:t.stroke_count}),[v,y]=a.useState([]),S=()=>{p({notes:t.notes??"",tempo:t.tempo,split_times:[...t.split_times],stroke_count:[...t.stroke_count]}),y(t.split_times.map(d=>Ve(d.time_seconds))),m(!0)},C=()=>m(!1),z=()=>{n({notes:N.notes.trim()||null,tempo:N.tempo,split_times:N.split_times,stroke_count:N.stroke_count}),m(!1)},te=()=>{p(d=>({...d,split_times:[...d.split_times,{rep:d.split_times.length+1,time_seconds:0}]})),y(d=>[...d,""])},oe=(d,h)=>{y(M=>M.map((D,T)=>T===d?h:D))},ae=d=>{const h=ns(v[d]),M=Ve(h);y(D=>D.map((T,B)=>B===d?M:T)),p(D=>({...D,split_times:D.split_times.map((T,B)=>B===d?{...T,time_seconds:h}:T)}))},xe=d=>{p(h=>({...h,split_times:h.split_times.filter((M,D)=>D!==d).map((M,D)=>({...M,rep:D+1}))})),y(h=>h.filter((M,D)=>D!==d))},H=()=>{p(d=>({...d,stroke_count:[...d.stroke_count,{rep:d.stroke_count.length+1,count:0}]}))},le=(d,h)=>{p(M=>({...M,stroke_count:M.stroke_count.map((D,T)=>T===d?{...D,count:h}:D)}))},W=d=>{p(h=>({...h,stroke_count:h.stroke_count.filter((M,D)=>D!==d).map((M,D)=>({...M,rep:D+1}))}))};return f?e.jsxs("div",{className:"px-3 py-2.5 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:z,disabled:r,className:"p-1.5 rounded-lg text-primary hover:bg-primary/10 transition","aria-label":"Enregistrer",children:e.jsx(tt,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:C,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Annuler",children:e.jsx(kt,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:o,className:"p-1.5 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition","aria-label":"Supprimer",children:e.jsx($e,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground min-w-[80px]",children:[e.jsx(ot,{className:"h-3.5 w-3.5"}),"Tempo"]}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:N.tempo??"",onChange:d=>p(h=>({...h,tempo:d.target.value?Number(d.target.value):null})),placeholder:"coups/min",className:"w-24 rounded-xl border border-border bg-background px-2 py-1.5 text-sm text-center outline-none focus:ring-2 focus:ring-foreground/10"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(lt,{className:"h-3.5 w-3.5"}),"Temps"]}),e.jsxs("button",{type:"button",onClick:te,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Be,{className:"h-3 w-3"}),"Rep"]})]}),N.split_times.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:N.split_times.map((d,h)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx(ss,{value:v[h]??"",onChange:M=>oe(h,M),onBlur:()=>ae(h),size:"compact"}),e.jsx("button",{type:"button",onClick:()=>xe(h),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx($e,{className:"h-3 w-3"})})]},h))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(at,{className:"h-3.5 w-3.5"}),"Coups de bras"]}),e.jsxs("button",{type:"button",onClick:H,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Be,{className:"h-3 w-3"}),"Rep"]})]}),N.stroke_count.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:N.stroke_count.map((d,h)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,value:d.count||"",onChange:M=>le(h,Number(M.target.value)||0),placeholder:"nb",className:"w-14 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>W(h),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx($e,{className:"h-3 w-3"})})]},h))})]}),e.jsx("textarea",{value:N.notes,onChange:d=>p(h=>({...h,notes:d.target.value})),placeholder:"Notes libres...",rows:2,className:"w-full resize-none rounded-xl border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"})]}):e.jsxs("div",{className:"px-3 py-2.5 space-y-1.5 group",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsx("button",{type:"button",onClick:S,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Modifier",children:e.jsx(rs,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground",children:[t.tempo!=null&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ot,{className:"h-3 w-3"}),t.tempo," c/min"]}),t.split_times.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(lt,{className:"h-3 w-3"}),t.split_times.map(d=>Ve(d.time_seconds)||"—").join(" / ")]}),t.stroke_count.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(at,{className:"h-3 w-3"}),t.stroke_count.map(d=>d.count).join(" / ")," cps"]})]}),t.notes&&e.jsx("div",{className:"text-xs text-foreground/70 italic",children:t.notes})]})}const Ls=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],gt=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],Ps=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function ht(...t){return t.filter(Boolean).join(" ")}function yt(t){return String(t).padStart(2,"0")}function Te(t){return`${t.getFullYear()}-${yt(t.getMonth()+1)}-${yt(t.getDate())}`}function Ks(t){return new Date(t.getFullYear(),t.getMonth(),1)}function Ts(t){const n=String(t).split("__");return{iso:n[0],slotKey:n[1]||""}}function Nt(t,n){return Number.isFinite(t)?Math.round(t/n)*n:0}function jt({globalKm:t,onSettings:n}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(wt,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Accueil"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"hidden sm:inline text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[t," km"]}),e.jsxs(Mt,{type:"button",variant:"outline",size:"sm",onClick:n,className:"h-8 rounded-xl border-primary/20 bg-primary/5 px-2.5 text-xs font-semibold text-primary hover:bg-primary/10","aria-label":"Présence hebdo",children:[e.jsx(cs,{className:"mr-1 h-3.5 w-3.5"}),"Hebdo"]})]})]})}function bn(){const t=nt(s=>s.user),n=nt(s=>s.userId),{toast:o}=Qt(),r=vt(),[f,m]=Ce.useState("idle"),[N,p]=Ce.useState(!1),[v,y]=Ce.useState(null);Ce.useEffect(()=>{Je.auth.getSession().then(({data:s})=>{y(s.session?.user?.id??null)})},[t]);const{data:S,isLoading:C,error:z,refetch:te}=je({queryKey:["sessions",n??t],queryFn:()=>R.getSessions(t,n),enabled:!!t}),{data:oe,isLoading:ae,error:xe,refetch:H}=je({queryKey:["assignments",t],queryFn:()=>R.getAssignments(t,n),enabled:!!t}),{data:le=[]}=je({queryKey:["competitions"],queryFn:()=>R.getCompetitions()}),{data:W}=je({queryKey:["my-competition-ids"],queryFn:()=>R.getMyCompetitionIds()}),d=a.useMemo(()=>!W||W.length===0?le:le.filter(s=>W.includes(s.id)),[le,W]),{data:h=[]}=je({queryKey:["my-planned-absences"],queryFn:()=>R.getMyPlannedAbsences()}),M=a.useMemo(()=>new Set(h.map(s=>s.date)),[h]),D=C||ae,T=z||xe,B=()=>{te(),H()},X=he({mutationFn:s=>R.deleteSession(s),onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),o({title:"Séance supprimée",description:"La saisie a été supprimée."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{o({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),ye=he({mutationFn:async s=>{const{_exerciseLogs:i,...u}=s,j=await R.syncSession({...u,athlete_name:t,athlete_id:n??void 0});if(i&&i.length>0&&j.sessionId)try{const{data:E}=await Je.auth.getSession(),V=E.session?.user?.id;V&&await R.saveSwimExerciseLogs(j.sessionId,V,i)}catch(E){console.warn("[EAC] Failed to save exercise logs:",E)}return j},onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["assignments"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),o({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{o({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),ce=he({mutationFn:async s=>{const{_exerciseLogs:i,...u}=s,j=await R.updateSession(u);if(i&&u.id)try{const{data:E}=await Je.auth.getSession(),V=E.session?.user?.id;V&&await R.saveSwimExerciseLogs(u.id,V,i)}catch(E){throw console.error("[EAC] Failed to save exercise logs:",E),E}return j},onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),o({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{o({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),ve=he({mutationFn:({date:s,reason:i})=>R.setPlannedAbsence(s,i),onMutate:async({date:s,reason:i})=>{await r.cancelQueries({queryKey:["my-planned-absences"]});const u=r.getQueryData(["my-planned-absences"]);return r.setQueryData(["my-planned-absences"],j=>[...j??[],{date:s,reason:i??null}]),{previous:u}},onSuccess:()=>{r.invalidateQueries({queryKey:["my-planned-absences"]}),o({title:"Jour marqué indisponible"})},onError:(s,i,u)=>{u?.previous&&r.setQueryData(["my-planned-absences"],u.previous),o({title:"Erreur",description:"Impossible de marquer ce jour indisponible.",variant:"destructive"})}}),be=he({mutationFn:s=>R.removePlannedAbsence(s),onMutate:async s=>{await r.cancelQueries({queryKey:["my-planned-absences"]});const i=r.getQueryData(["my-planned-absences"]);return r.setQueryData(["my-planned-absences"],u=>(u??[]).filter(j=>j.date!==s)),{previous:i}},onSuccess:()=>{r.invalidateQueries({queryKey:["my-planned-absences"]}),o({title:"Disponibilité restaurée"})},onError:(s,i,u)=>{u?.previous&&r.setQueryData(["my-planned-absences"],u.previous),o({title:"Erreur",description:"Impossible de restaurer la disponibilité.",variant:"destructive"})}}),ge=vs({sessions:S,assignments:oe,userId:n,user:t}),{today:A,monthCursor:$,selectedISO:L,drawerOpen:K,settingsOpen:F,activeSessionId:w,detailsOpen:J,selectedDayIndex:U,isPending:G,presenceDefaults:_,stableDurationMin:Y,draftState:O,gridDates:Q,completionByISO:q,selectedDate:ne,sessionsForSelectedDay:pe,selectedDayStatus:Oe,globalKm:we,dayKm:de,logsBySessionId:re,setMonthCursor:ie,setSelectedISO:l,setDrawerOpen:c,setSettingsOpen:x,setActiveSessionId:b,setDetailsOpen:g,setSelectedDayIndex:k,setPresenceDefaults:Z,setAttendanceOverrideBySessionId:P,setStableDurationMin:se,setDraftState:Ne,setAutoCloseArmed:fe,startTransition:ee,getSessionStatus:Re}=ge,Ct=a.useMemo(()=>{const s=new Set;for(const i of d){if(!i.date)continue;const u=i.date.slice(0,10),j=i.end_date?i.end_date.slice(0,10):u;let E=u;for(;E<=j;){s.add(E);const V=new Date(E+"T00:00:00");V.setDate(V.getDate()+1);const Se=V.getFullYear(),Ie=String(V.getMonth()+1).padStart(2,"0"),Me=String(V.getDate()).padStart(2,"0");E=`${Se}-${Ie}-${Me}`}}return s},[d]),ue=a.useMemo(()=>{const s=Te(new Date);return d.filter(u=>u.date&&u.date.slice(0,10)>=s).sort((u,j)=>u.date.localeCompare(j.date))[0]??null},[d]),Qe=a.useMemo(()=>{if(!ue)return null;const s=new Date;s.setHours(0,0,0,0);const i=new Date(ue.date.slice(0,10)+"T00:00:00");return Math.round((i.getTime()-s.getTime())/(1e3*60*60*24))},[ue]),Ee=a.useMemo(()=>ue?qt({compDate:ue.date.slice(0,10),assignments:oe,absenceDates:M,presenceDefaults:_}):null,[ue,oe,M,_]),ke=a.useCallback(s=>{l(s),c(!0),b(null),g(!1);const i=q[s]||{completed:0,total:2};fe(i.total>0&&i.completed<i.total)},[q,l,c,b,g,fe]),ze=a.useCallback(()=>{c(!1),b(null),g(!1),fe(!1),k(null)},[c,b,g,fe,k]),At=a.useCallback(()=>{ie(s=>new Date(s.getFullYear(),s.getMonth()-1,1))},[ie]),Ft=a.useCallback(()=>{ie(s=>new Date(s.getFullYear(),s.getMonth()+1,1))},[ie]),Ot=a.useCallback(()=>{const s=new Date;ie(Ks(s)),ke(Te(s))},[ke,ie]),He=a.useCallback(s=>{b(s),g(!1)},[b,g]),Et=a.useCallback(s=>{ee(()=>{P(u=>({...u,[s]:"absent"}))});const i=re[s];i?.id&&X.mutate(Number(i.id))},[X,re,ee,P]),It=a.useCallback(s=>{ee(()=>{P(i=>({...i,[s]:"present"}))})},[ee,P]),Lt=a.useCallback(s=>{ee(()=>{P(i=>{const u={...i};return delete u[s],u})})},[ee,P]),Pt=a.useCallback(()=>{const s=pe.map(i=>Re(i,ne).expected?i.id:null).filter(Boolean);s.length!==0&&(ee(()=>{P(i=>{const u={...i};for(const j of s)u[j]="absent";return u}),b(null),g(!1)}),s.forEach(i=>{const u=re[i];u?.id&&X.mutate(Number(u.id))}))},[pe,Re,ne,ee,re,X,P,b,g]),Kt=a.useCallback(()=>{if(!w||!t||!Ps.every(De=>Number.isInteger(O[De.key])))return;const{iso:i,slotKey:u}=Ts(w),j=u==="PM"?"Soir":"Matin",E=Nt(Number(O.distanceMeters??0),100),V=Nt(Number(Y),15),Se={};for(const[De,Bt]of Object.entries(O.strokes)){const st=Number(Bt);st>0&&(Se[De]=st)}const Ie={date:i,slot:j,distance:E,duration:V,effort:Number(O.difficulty),feeling:Number(O.fatigue_end),performance:Number(O.performance),engagement:Number(O.engagement),comments:String(O.comment||"").slice(0,400),athlete_name:t,athlete_id:n??void 0,stroke_distances:Object.keys(Se).length>0?Se:null},Me=re[w];ee(()=>{P(De=>({...De,[w]:"present"}))}),Me?.id?ce.mutate({...Ie,id:Me.id,created_at:Me.created_at??new Date().toISOString(),_exerciseLogs:O.exerciseLogs.length>0?O.exerciseLogs:[]}):ye.mutate({...Ie,_exerciseLogs:O.exerciseLogs.length>0?O.exerciseLogs:void 0}),b(null),g(!1)},[w,t,n,O,Y,re,ee,ce,ye,P,b,g]),Tt=a.useCallback((s,i)=>{Z(u=>({...u,[s]:{...u[s],[i]:!u[s][i]}}))},[Z]);a.useEffect(()=>{if(!K)return;const s=i=>{const u=i.target?.tagName;if(!(u==="INPUT"||u==="TEXTAREA"||i.target?.isContentEditable)){if(i.key==="Escape"){i.preventDefault(),ze();return}(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),pe.length>0&&!w&&He(pe[0].id))}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[K,ze,pe,w,He]);const $t=a.useCallback((s,i)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(s.key))return;if(s.preventDefault(),s.key==="Enter"||s.key===" "){const E=Te(Q[i]);ke(E);return}let j=i;s.key==="ArrowLeft"&&(j=Math.max(0,i-1)),s.key==="ArrowRight"&&(j=Math.min(Q.length-1,i+1)),s.key==="ArrowUp"&&(j=Math.max(0,i-7)),s.key==="ArrowDown"&&(j=Math.min(Q.length-1,i+7)),k(j),l(Te(Q[j])),setTimeout(()=>{const E=document.querySelectorAll('[data-calendar-cell="true"]');E[j]&&E[j].focus()},0)},[Q,ke,k,l]);return D?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"h-7 w-7 rounded-lg bg-primary/20 animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((s,i)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${i}`)),Array.from({length:35}).map((s,i)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${i}`))]})})]})})]}):T?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(os,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:T.message}),e.jsx(Mt,{onClick:()=>B(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsx("div",{className:"px-4 py-2.5 flex items-center justify-between",children:e.jsx(jt,{globalKm:we,onSettings:()=>x(!0)})})}),e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:[e.jsx("div",{className:"hidden sm:flex items-center justify-between",children:e.jsx(jt,{globalKm:we,onSettings:()=>x(!0)})}),e.jsx(is,{variant:"amber",icon:e.jsx(zt,{}),label:ue?.name,badge:Qe===0?"Aujourd'hui":`J-${Qe}`,sublabel:ue?.location,subbadge:Ee!=null&&Ee>0?`${Ee} séance${Ee>1?"s":""}`:void 0,visible:!!ue&&Qe!=null,className:"mt-4"}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(Wt,{monthCursor:$,selectedDayStatus:Oe,onPrevMonth:At,onNextMonth:Ft,onJumpToday:Ot}),e.jsx(Xt,{monthCursor:$,gridDates:Q,completionByISO:q,competitionDates:Ct,absenceDates:M,selectedISO:L,selectedDayIndex:U,today:A,onDayClick:ke,onKeyDown:$t})]}),v&&e.jsx(Es,{userId:v,expanded:N,onToggle:()=>p(s=>!s)}),e.jsx(Ht,{open:F,onOpenChange:x,children:e.jsxs(Jt,{className:"max-w-sm rounded-2xl",children:[e.jsx(Ut,{children:e.jsx(Yt,{children:"Présence hebdo"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Définis les créneaux attendus chaque semaine. Tu peux ensuite ajuster un jour précis dans le calendrier."}),e.jsx("div",{className:"space-y-2",children:Ls.map((s,i)=>{const u=gt.filter(j=>!!_?.[i]?.[j.key]).length;return e.jsxs("div",{className:"rounded-2xl border border-border bg-card px-3 py-3",children:[e.jsx("div",{className:"mb-2 flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:s}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:u===0?"Aucun créneau prévu":`${u} créneau${u>1?"x":""} attendu${u>1?"s":""}`})]})}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:gt.map(j=>{const E=!!_?.[i]?.[j.key];return e.jsxs("button",{type:"button",onClick:()=>Tt(i,j.key),className:ht("rounded-2xl border px-3 py-3 text-left transition",E?"border-foreground bg-foreground text-background":"border-border bg-card text-foreground hover:bg-muted"),"aria-label":`${s} ${j.label}`,children:[e.jsx("div",{className:"text-sm font-semibold",children:j.label}),e.jsx("div",{className:ht("mt-1 text-[11px]",E?"text-background/80":"text-muted-foreground"),children:E?"Prévu":"Non prévu"})]},j.key)})})]},s)})}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>se(s=>Math.max(30,s-15)),"aria-label":"Diminuer la durée",children:e.jsx(_t,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[Y," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>se(s=>Math.min(240,s+15)),"aria-label":"Augmenter la durée",children:e.jsx(Be,{className:"h-4 w-4"})})]})]})]})]})}),e.jsx(As,{open:K,selectedDate:ne,sessionsForSelectedDay:pe,selectedDayStatus:Oe,dayKm:de,activeSessionId:w,detailsOpen:J,draftState:O,saveState:f,isPending:G,logsBySessionId:re,onClose:ze,onDayOffAll:Pt,onOpenSession:He,onCloseSession:()=>{b(null),g(!1)},onToggleDetails:()=>g(s=>!s),onMarkAbsent:Et,onMarkPresent:It,onClearOverride:Lt,onSaveFeedback:Kt,onDeleteFeedback:s=>{const i=re[s];i?.id&&(X.mutate(Number(i.id)),b(null),g(!1))},onDraftStateChange:Ne,getSessionStatus:Re,isAbsent:M.has(L),absenceReason:h.find(s=>s.date===L)?.reason??null,onMarkDayAbsent:s=>ve.mutate({date:L,reason:s}),onRemoveDayAbsence:()=>be.mutate(L)})]})]})}export{bn as default};
