const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StrengthCatalog-DkTKz7U4.js","assets/vendor-query-BiSH4r2z.js","assets/vendor-react-BzrpNAyj.js","assets/api-B8aJ-ovx.js","assets/index-DmTR6Fu2.js","assets/vendor-supabase-6k692oZB.js","assets/index-C_gzl0Oy.css","assets/index-C7JDAUAQ.js","assets/index-DiFuf380.js","assets/index--5zlAsEE.js","assets/select-BSZXpvSJ.js","assets/index-XHev807R.js","assets/chevron-down-C_AGiQHB.js","assets/check-NUniFh0I.js","assets/CalendarGrid-CB1296f5.js","assets/chevron-left-DIvqqxlX.js","assets/chevron-right-CXTJ28mW.js","assets/textarea-MTPnEMyw.js","assets/dialog-DjrQuJLJ.js","assets/index-jl19SgI2.js","assets/checkbox-DinMoMpx.js","assets/alert-dialog-tLVnFDYF.js","assets/tabs-CIPL-JIX.js","assets/SessionListView-CamF94FY.js","assets/play-GadIdkDI.js","assets/circle-alert-Dm8NpaD_.js","assets/pencil-BxKlVPh8.js","assets/drawer-CAd18oWp.js","assets/search-5K4eYEsi.js","assets/plus-DrohpXU0.js","assets/loader-circle-DjgZZMZ8.js","assets/pen-hQzuACN3.js","assets/badge-Bv11la_e.js","assets/toggle-group-h_NY4TzR.js","assets/sheet-D0HtVDJb.js","assets/separator-BdE1Di4S.js","assets/collapsible-CHLdl1sW.js","assets/user-plus-VQh1vBbH.js","assets/SwimCatalog-CDEtc-sI.js","assets/SwimSessionTimeline-DMCYuPka.js","assets/eye-DVEDargf.js","assets/clock-CagF16Ps.js","assets/format-B9mPVj_w.js","assets/timer-DSmrDVmz.js"])))=>i.map(i=>d[i]);
import{c as se,B as A,l as ws,m as Ss,n as Ye,R as _s,o as ks,p as Je,P as Ze,A as Xe,q as es,r as Ms,t as As,v as Ds,w as Ps,a as Rs,d as te,C as ue,h as me,j as pe,x as he,g as xe,L as K,I as ge,W as ss,D as ts,y as Os,U as ye,z as Fs,E as Ts,u as Ke,b as Es,G as Be,H as zs,k as Is,_ as ns}from"./index-DmTR6Fu2.js";import{j as e,r as o,R as $s,d as B,u as Q,c as Ne}from"./vendor-query-BiSH4r2z.js";import{a as D}from"./api-B8aJ-ovx.js";import{B as ae}from"./badge-Bv11la_e.js";import{T as rs,a as ce}from"./toggle-group-h_NY4TzR.js";import{C as je}from"./checkbox-DinMoMpx.js";import{h as qs,R as Ls,u as Gs,F as Vs}from"./index-XHev807R.js";import{u as Ks}from"./index--5zlAsEE.js";import{S as U,a as W,b as Y,c as J,d as I}from"./select-BSZXpvSJ.js";import{C as as}from"./chevron-down-C_AGiQHB.js";import{a as Bs,b as Hs,T as os,P as Qs}from"./CalendarGrid-CB1296f5.js";import{S as Te,a as Ee,b as ze,c as Ie,d as $e}from"./sheet-D0HtVDJb.js";import{S as Us}from"./separator-BdE1Di4S.js";import{A as _e,a as ke,b as Me,c as Ae,d as De,e as Pe,f as Re,g as Oe}from"./alert-dialog-tLVnFDYF.js";import{C as Ws,a as Ys,b as Js}from"./collapsible-CHLdl1sW.js";import{P as Fe}from"./plus-DrohpXU0.js";import{U as Zs,a as Xs}from"./user-plus-VQh1vBbH.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],ve=se("arrow-left",et);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}]],be=se("bell",st);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],nt=se("calendar-days",tt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],at=se("external-link",rt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ot=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}],["path",{d:"M3.22 13H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27",key:"auskq0"}]],it=se("heart-pulse",ot);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],qe=se("mail",lt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ct=[["path",{d:"M18 21a8 8 0 0 0-16 0",key:"3ypg7q"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3",key:"10s06x"}]],is=se("users-round",ct),ee=({title:s,description:a,onBack:c,actions:n})=>e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:c,children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Retour à l'accueil"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:s}),a?e.jsx("p",{className:"text-sm text-muted-foreground",children:a}):null]}),n?e.jsx("div",{className:"flex items-center gap-2",children:n}):null]});function de(s,a,{checkForDefaultPrevented:c=!0}={}){return function(r){if(s?.(r),c===!1||!r.defaultPrevented)return a?.(r)}}function dt(s){const a=ut(s),c=o.forwardRef((n,r)=>{const{children:d,...u}=n,i=o.Children.toArray(d),h=i.find(pt);if(h){const x=h.props.children,p=i.map(m=>m===h?o.Children.count(x)>1?o.Children.only(null):o.isValidElement(x)?x.props.children:null:m);return e.jsx(a,{...u,ref:r,children:o.isValidElement(x)?o.cloneElement(x,void 0,p):null})}return e.jsx(a,{...u,ref:r,children:d})});return c.displayName=`${s}.Slot`,c}function ut(s){const a=o.forwardRef((c,n)=>{const{children:r,...d}=c;if(o.isValidElement(r)){const u=xt(r),i=ht(d,r.props);return r.type!==o.Fragment&&(i.ref=n?ws(n,u):u),o.cloneElement(r,i)}return o.Children.count(r)>1?o.Children.only(null):null});return a.displayName=`${s}.SlotClone`,a}var mt=Symbol("radix.slottable");function pt(s){return o.isValidElement(s)&&typeof s.type=="function"&&"__radixId"in s.type&&s.type.__radixId===mt}function ht(s,a){const c={...a};for(const n in a){const r=s[n],d=a[n];/^on[A-Z]/.test(n)?r&&d?c[n]=(...i)=>{const h=d(...i);return r(...i),h}:r&&(c[n]=r):n==="style"?c[n]={...r,...d}:n==="className"&&(c[n]=[r,d].filter(Boolean).join(" "))}return{...s,...c}}function xt(s){let a=Object.getOwnPropertyDescriptor(s.props,"ref")?.get,c=a&&"isReactWarning"in a&&a.isReactWarning;return c?s.ref:(a=Object.getOwnPropertyDescriptor(s,"ref")?.get,c=a&&"isReactWarning"in a&&a.isReactWarning,c?s.props.ref:s.props.ref||s.ref)}var gt=$s[" useInsertionEffect ".trim().toString()]||Ss;function ft({prop:s,defaultProp:a,onChange:c=()=>{},caller:n}){const[r,d,u]=jt({defaultProp:a,onChange:c}),i=s!==void 0,h=i?s:r;{const p=o.useRef(s!==void 0);o.useEffect(()=>{const m=p.current;m!==i&&console.warn(`${n} is changing from ${m?"controlled":"uncontrolled"} to ${i?"controlled":"uncontrolled"}. Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.`),p.current=i},[i,n])}const x=o.useCallback(p=>{if(i){const m=vt(p)?p(s):p;m!==s&&u.current?.(m)}else d(p)},[i,s,d,u]);return[h,x]}function jt({defaultProp:s,onChange:a}){const[c,n]=o.useState(s),r=o.useRef(c),d=o.useRef(a);return gt(()=>{d.current=a},[a]),o.useEffect(()=>{r.current!==c&&(d.current?.(c),r.current=c)},[c,r]),[c,n,d]}function vt(s){return typeof s=="function"}var Ce="Popover",[ls]=ks(Ce,[Ye]),fe=Ye(),[yt,X]=ls(Ce),cs=s=>{const{__scopePopover:a,children:c,open:n,defaultOpen:r,onOpenChange:d,modal:u=!1}=s,i=fe(a),h=o.useRef(null),[x,p]=o.useState(!1),[m,f]=ft({prop:n,defaultProp:r??!1,onChange:d,caller:Ce});return e.jsx(_s,{...i,children:e.jsx(yt,{scope:a,contentId:Ks(),triggerRef:h,open:m,onOpenChange:f,onOpenToggle:o.useCallback(()=>f(g=>!g),[f]),hasCustomAnchor:x,onCustomAnchorAdd:o.useCallback(()=>p(!0),[]),onCustomAnchorRemove:o.useCallback(()=>p(!1),[]),modal:u,children:c})})};cs.displayName=Ce;var ds="PopoverAnchor",bt=o.forwardRef((s,a)=>{const{__scopePopover:c,...n}=s,r=X(ds,c),d=fe(c),{onCustomAnchorAdd:u,onCustomAnchorRemove:i}=r;return o.useEffect(()=>(u(),()=>i()),[u,i]),e.jsx(Xe,{...d,...n,ref:a})});bt.displayName=ds;var us="PopoverTrigger",ms=o.forwardRef((s,a)=>{const{__scopePopover:c,...n}=s,r=X(us,c),d=fe(c),u=Je(a,r.triggerRef),i=e.jsx(Ze.button,{type:"button","aria-haspopup":"dialog","aria-expanded":r.open,"aria-controls":r.contentId,"data-state":fs(r.open),...n,ref:u,onClick:de(s.onClick,r.onOpenToggle)});return r.hasCustomAnchor?i:e.jsx(Xe,{asChild:!0,...d,children:i})});ms.displayName=us;var Le="PopoverPortal",[Nt,Ct]=ls(Le,{forceMount:void 0}),ps=s=>{const{__scopePopover:a,forceMount:c,children:n,container:r}=s,d=X(Le,a);return e.jsx(Nt,{scope:a,forceMount:c,children:e.jsx(es,{present:c||d.open,children:e.jsx(Ms,{asChild:!0,container:r,children:n})})})};ps.displayName=Le;var oe="PopoverContent",hs=o.forwardRef((s,a)=>{const c=Ct(oe,s.__scopePopover),{forceMount:n=c.forceMount,...r}=s,d=X(oe,s.__scopePopover);return e.jsx(es,{present:n||d.open,children:d.modal?e.jsx(St,{...r,ref:a}):e.jsx(_t,{...r,ref:a})})});hs.displayName=oe;var wt=dt("PopoverContent.RemoveScroll"),St=o.forwardRef((s,a)=>{const c=X(oe,s.__scopePopover),n=o.useRef(null),r=Je(a,n),d=o.useRef(!1);return o.useEffect(()=>{const u=n.current;if(u)return qs(u)},[]),e.jsx(Ls,{as:wt,allowPinchZoom:!0,children:e.jsx(xs,{...s,ref:r,trapFocus:c.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:de(s.onCloseAutoFocus,u=>{u.preventDefault(),d.current||c.triggerRef.current?.focus()}),onPointerDownOutside:de(s.onPointerDownOutside,u=>{const i=u.detail.originalEvent,h=i.button===0&&i.ctrlKey===!0,x=i.button===2||h;d.current=x},{checkForDefaultPrevented:!1}),onFocusOutside:de(s.onFocusOutside,u=>u.preventDefault(),{checkForDefaultPrevented:!1})})})}),_t=o.forwardRef((s,a)=>{const c=X(oe,s.__scopePopover),n=o.useRef(!1),r=o.useRef(!1);return e.jsx(xs,{...s,ref:a,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:d=>{s.onCloseAutoFocus?.(d),d.defaultPrevented||(n.current||c.triggerRef.current?.focus(),d.preventDefault()),n.current=!1,r.current=!1},onInteractOutside:d=>{s.onInteractOutside?.(d),d.defaultPrevented||(n.current=!0,d.detail.originalEvent.type==="pointerdown"&&(r.current=!0));const u=d.target;c.triggerRef.current?.contains(u)&&d.preventDefault(),d.detail.originalEvent.type==="focusin"&&r.current&&d.preventDefault()}})}),xs=o.forwardRef((s,a)=>{const{__scopePopover:c,trapFocus:n,onOpenAutoFocus:r,onCloseAutoFocus:d,disableOutsidePointerEvents:u,onEscapeKeyDown:i,onPointerDownOutside:h,onFocusOutside:x,onInteractOutside:p,...m}=s,f=X(oe,c),g=fe(c);return Gs(),e.jsx(Vs,{asChild:!0,loop:!0,trapped:n,onMountAutoFocus:r,onUnmountAutoFocus:d,children:e.jsx(As,{asChild:!0,disableOutsidePointerEvents:u,onInteractOutside:p,onEscapeKeyDown:i,onPointerDownOutside:h,onFocusOutside:x,onDismiss:()=>f.onOpenChange(!1),children:e.jsx(Ds,{"data-state":fs(f.open),role:"dialog",id:f.contentId,...g,...m,ref:a,style:{...m.style,"--radix-popover-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-popover-content-available-width":"var(--radix-popper-available-width)","--radix-popover-content-available-height":"var(--radix-popper-available-height)","--radix-popover-trigger-width":"var(--radix-popper-anchor-width)","--radix-popover-trigger-height":"var(--radix-popper-anchor-height)"}})})})}),gs="PopoverClose",kt=o.forwardRef((s,a)=>{const{__scopePopover:c,...n}=s,r=X(gs,c);return e.jsx(Ze.button,{type:"button",...n,ref:a,onClick:de(s.onClick,()=>r.onOpenChange(!1))})});kt.displayName=gs;var Mt="PopoverArrow",At=o.forwardRef((s,a)=>{const{__scopePopover:c,...n}=s,r=fe(c);return e.jsx(Ps,{...r,...n,ref:a})});At.displayName=Mt;function fs(s){return s?"open":"closed"}var Dt=cs,Pt=ms,Rt=ps,js=hs;const Ot=Dt,Ft=Pt,vs=o.forwardRef(({className:s,align:a="center",sideOffset:c=4,...n},r)=>e.jsx(Rt,{children:e.jsx(js,{ref:r,align:a,sideOffset:c,className:Rs("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",s),...n})}));vs.displayName=js.displayName;const Tt=({onBack:s,swimSessions:a,strengthSessions:c,athletes:n,groups:r})=>{const{toast:d}=te(),[u,i]=o.useState({session_type:"swim",session_id:"",assigned_date:new Date().toISOString().split("T")[0],assigned_slot:"morning"}),[h,x]=o.useState(!1),[p,m]=o.useState("user"),[f,g]=o.useState(""),[l,y]=o.useState([]),P=t=>{const S=typeof t=="number"?t:Number(t);return Number.isFinite(S)&&S>0?S:null},j=o.useMemo(()=>n.map(t=>({value:t.id?`id:${t.id}`:`name:${t.display_name}`,label:t.group_label?`${t.display_name} · ${t.group_label}`:t.display_name,id:t.id,name:t.display_name})),[n]),_=o.useMemo(()=>new Map(j.map(t=>[t.value,t])),[j]),E=o.useMemo(()=>r.map(t=>{const S=P(t.id);return S?{...t,gid:S}:null}).filter(t=>!!t),[r]),z=o.useMemo(()=>E.filter(t=>l.includes(t.gid)),[E,l]),L=o.useMemo(()=>{if(z.length===0)return"Choisir des groupes";const t=z.slice(0,2).map(F=>F.name).join(", "),S=z.length>2?` +${z.length-2}`:"";return`${t}${S}`},[z]),q=B({mutationFn:async t=>D.assignments_create(t),onSuccess:()=>{d({title:"Séance assignée & notifiée"})},onError:t=>{const S="Impossible d'assigner la séance. Vérifiez les champs et réessayez.",F=t instanceof Error?t.message:typeof t=="string"?t:S;let M=F;const v=F.match(/HTTP \d+:\s*(\{.*\})/);if(v)try{M=JSON.parse(v[1])?.error||S}catch{M=S}d({title:"Erreur d'assignation",description:M})}}),H=async()=>{const t=Number(u.session_id);if(!Number.isInteger(t)||t<=0){d({title:"Séance invalide",description:"Sélectionnez une séance valide."});return}if(p==="group"){if(l.length===0){d({title:"Groupe manquant",description:"Sélectionnez au moins un groupe."});return}x(!0);try{const C={assignment_type:u.session_type,session_id:t,scheduled_date:u.assigned_date,scheduled_slot:u.assigned_slot},k=Array.from(new Set(l));await Promise.all(k.map(N=>D.assignments_create({...C,target_group_id:N}))),d({title:"Séance assignée & notifiée"})}catch(C){const k="Impossible d'assigner la séance. Vérifiez les champs et réessayez.",N=C instanceof Error?C.message:typeof C=="string"?C:k;let O=N;const G=N.match(/HTTP \d+:\s*(\{.*\})/);if(G)try{O=JSON.parse(G[1])?.error||k}catch{O=k}d({title:"Erreur d'assignation",description:O})}finally{x(!1)}return}const S=f.trim();if(!S){d({title:"Nageur manquant",description:"Sélectionnez un nageur."});return}const F=_.get(S),M=F?.id??(Number.isFinite(Number(S))&&Number(S)>0?Number(S):void 0);if(!Number.isFinite(M)||Number(M)<=0){d({title:"Nageur invalide",description:"Sélectionnez un nageur avec un identifiant valide."});return}const v=F?.name??S.replace(/^name:/,"");q.mutate({assignment_type:u.session_type,session_id:t,target_athlete:v,target_user_id:M,scheduled_date:u.assigned_date,scheduled_slot:u.assigned_slot})},w=!u.session_id||(p==="group"?l.length===0:!f.trim())||q.isPending||h;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ee,{title:"Assigner une séance",description:"Planifiez une séance pour un nageur ou un ou plusieurs groupes.",onBack:s}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs(ue,{className:"border-l-4 border-l-primary",children:[e.jsxs(me,{children:[e.jsx(pe,{children:"Séance"}),e.jsx(he,{children:"Choisissez le type et la séance à envoyer."})]}),e.jsxs(xe,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Type"}),e.jsxs(U,{value:u.session_type,onValueChange:t=>i({...u,session_type:t,session_id:""}),children:[e.jsx(W,{children:e.jsx(Y,{})}),e.jsxs(J,{children:[e.jsx(I,{value:"swim",children:"Natation"}),e.jsx(I,{value:"strength",children:"Musculation"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Séance"}),e.jsxs(U,{value:u.session_id,onValueChange:t=>i({...u,session_id:t}),children:[e.jsx(W,{children:e.jsx(Y,{placeholder:"Choisir..."})}),e.jsx(J,{children:u.session_type==="swim"?a?.map(t=>e.jsx(I,{value:t.id.toString(),children:t.name},t.id)):c?.map(t=>e.jsx(I,{value:t.id.toString(),children:t.title},t.id))})]})]})]})]}),e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(pe,{children:"Cible & planification"}),e.jsx(he,{children:"Définissez le destinataire, la date et le créneau."})]}),e.jsxs(xe,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Cible"}),e.jsxs(U,{value:p,onValueChange:t=>{m(t),g(""),y([])},children:[e.jsx(W,{children:e.jsx(Y,{})}),e.jsxs(J,{children:[e.jsx(I,{value:"user",children:"Nageur"}),e.jsx(I,{value:"group",children:"Groupe(s)"})]})]})]}),p==="user"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Nageur"}),j.length>0?e.jsxs(U,{value:f,onValueChange:g,children:[e.jsx(W,{children:e.jsx(Y,{placeholder:"Choisir un nageur"})}),e.jsx(J,{children:j.map(t=>e.jsx(I,{value:t.value,children:t.label},t.value))})]}):e.jsx(ge,{value:f,onChange:t=>g(t.target.value),placeholder:"ex: Camille"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Groupes"}),r.length>0?e.jsxs(Ot,{children:[e.jsx(Ft,{asChild:!0,children:e.jsxs(A,{type:"button",variant:"outline",className:"w-full justify-between","aria-label":"Sélection des groupes",children:[e.jsx("span",{className:"truncate",children:L}),e.jsx(as,{className:"ml-2 h-4 w-4 opacity-50"})]})}),e.jsxs(vs,{className:"w-[--radix-popover-trigger-width] p-2",align:"start",children:[e.jsx("div",{className:"max-h-64 overflow-auto",children:e.jsxs("div",{className:"space-y-1",children:[E.filter(t=>t.is_temporary&&!t.parent_group_id).map(t=>{const S=l.includes(t.gid),F=E.filter(M=>M.parent_group_id===t.gid);return e.jsxs("div",{children:[e.jsxs("label",{className:"flex cursor-pointer items-center gap-2 rounded-md px-2 py-1.5 hover:bg-muted",children:[e.jsx(je,{checked:S,onCheckedChange:M=>{const v=M===!0;y(C=>v?C.includes(t.gid)?C:[...C,t.gid]:C.filter(k=>k!==t.gid))}}),e.jsx("span",{className:"text-sm font-medium",children:t.name}),e.jsx(ae,{variant:"secondary",className:"text-[9px] ml-auto px-1.5 py-0",children:"Stage"})]}),F.map(M=>{const v=l.includes(M.gid);return e.jsxs("label",{className:"flex cursor-pointer items-center gap-2 rounded-md pl-7 pr-2 py-1.5 hover:bg-muted",children:[e.jsx(je,{checked:v,onCheckedChange:C=>{const k=C===!0;y(N=>k?N.includes(M.gid)?N:[...N,M.gid]:N.filter(O=>O!==M.gid))}}),e.jsx("span",{className:"text-sm text-muted-foreground",children:M.name})]},M.gid)})]},t.gid)}),E.some(t=>t.is_temporary)&&E.some(t=>!t.is_temporary)?e.jsx("div",{className:"border-t my-1"}):null,E.filter(t=>!t.is_temporary).map(t=>{const S=l.includes(t.gid);return e.jsxs("label",{className:"flex cursor-pointer items-center gap-2 rounded-md px-2 py-1.5 hover:bg-muted",children:[e.jsx(je,{checked:S,onCheckedChange:F=>{const M=F===!0;y(v=>M?v.includes(t.gid)?v:[...v,t.gid]:v.filter(C=>C!==t.gid))}}),e.jsx("span",{className:"text-sm",children:t.name})]},t.gid)})]})}),l.length>0?e.jsx(A,{type:"button",variant:"ghost",size:"sm",className:"mt-2 w-full",onClick:()=>y([]),children:"Tout désélectionner"}):null]})]}):e.jsx("div",{className:"text-xs text-muted-foreground",children:"Aucun groupe disponible."}),l.length>0?e.jsxs("div",{className:"text-xs text-muted-foreground",children:[l.length," groupe",l.length>1?"s":""," sélectionné",l.length>1?"s":"","."]}):null]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Date"}),e.jsx(ge,{type:"date",value:u.assigned_date,onChange:t=>i({...u,assigned_date:t.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Créneau"}),e.jsxs(U,{value:u.assigned_slot,onValueChange:t=>i({...u,assigned_slot:t}),children:[e.jsx(W,{children:e.jsx(Y,{placeholder:"Choisir..."})}),e.jsxs(J,{children:[e.jsx(I,{value:"morning",children:"Matin"}),e.jsx(I,{value:"evening",children:"Soir"})]})]})]})]})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsxs(A,{className:"w-full sm:w-auto",onClick:H,disabled:w,children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),q.isPending||h?"Assignation...":"Assigner & notifier"]})})]})},Et=({onBack:s,athletes:a,groups:c,athletesLoading:n})=>{const{toast:r}=te(),[d,u]=o.useState(""),[i,h]=o.useState(""),x=o.useMemo(()=>a.filter(l=>l.id&&l.email).map(l=>({value:`user:${l.id}`,label:l.group_label?`${l.display_name} · ${l.group_label}`:l.display_name,email:l.email})),[a]),p=o.useMemo(()=>c.map(l=>({value:`group:${l.id}`,label:l.name,id:l.id})),[c]),m=()=>{if(!i)return[];if(i.startsWith("user:")){const l=x.find(y=>y.value===i);return l?[l.email]:[]}if(i.startsWith("group:")){const l=Number(i.split(":")[1]);return a.filter(y=>y.group_id===l&&y.email).map(y=>y.email)}return[]},f=()=>{const l=m();if(!l.length){r({title:"Aucune adresse email",description:"Aucun nageur avec une adresse email dans cette sélection."});return}const y=new URLSearchParams;y.set("bcc",l.join(",")),d.trim()&&y.set("subject",d.trim()),window.location.href=`mailto:?${y.toString()}`},g=m();return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ee,{title:"Contacter par email",description:"Ouvre votre application mail avec les destinataires en CCI.",onBack:s}),e.jsxs(ue,{className:"border-l-4 border-l-primary",children:[e.jsxs(me,{children:[e.jsx(pe,{children:"Destinataire"}),e.jsx(he,{children:"Sélectionnez un nageur ou un groupe."})]}),e.jsxs(xe,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Destinataire"}),e.jsxs(U,{value:i,onValueChange:h,children:[e.jsx(W,{children:e.jsx(Y,{placeholder:n?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(J,{children:[p.length?e.jsxs(e.Fragment,{children:[e.jsx(I,{value:"section-group",disabled:!0,children:"Groupes"}),p.map(l=>e.jsx(I,{value:l.value,children:l.label},l.value))]}):null,x.length?e.jsxs(e.Fragment,{children:[e.jsx(I,{value:"section-athlete",disabled:!0,children:"Nageurs"}),x.map(l=>e.jsx(I,{value:l.value,children:l.label},l.value))]}):null]})]})]}),i&&g.length>0?e.jsxs("p",{className:"text-xs text-muted-foreground",children:[g.length," adresse",g.length>1?"s":""," email",g.length>1?" (envoi en CCI)":""]}):null,i&&g.length===0?e.jsx("p",{className:"text-xs text-destructive",children:"Aucune adresse email disponible pour cette sélection."}):null]})]}),e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(pe,{children:"Objet"}),e.jsx(he,{children:"Optionnel — pré-rempli dans votre application mail."})]}),e.jsx(xe,{children:e.jsx(ge,{value:d,onChange:l=>u(l.target.value),placeholder:"Objet du mail…"})})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsxs(A,{className:"w-full sm:w-auto",onClick:f,disabled:!i||g.length===0,children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Ouvrir dans l'app mail",e.jsx(at,{className:"ml-2 h-3 w-3"})]})})]})};function He(s){return String(s).padStart(2,"0")}function re(s){return`${s.getFullYear()}-${He(s.getMonth()+1)}-${He(s.getDate())}`}function we(s){return new Date(s.getFullYear(),s.getMonth(),1)}function Qe(s,a){const c=new Date(s);return c.setDate(c.getDate()+a),c}function zt(s){return(s.getDay()+6)%7}function Se(s){if(!s)return"AM";const a=s.toLowerCase();return a==="evening"||a.includes("soir")||a==="pm"?"PM":"AM"}const It=[{key:"swim-morning",label:"Nage — Matin",type:"swim",scheduledSlot:"morning"},{key:"swim-evening",label:"Nage — Soir",type:"swim",scheduledSlot:"evening"},{key:"strength",label:"Musculation",type:"strength",scheduledSlot:null}];function $t({groupId:s,userId:a,enabled:c}){const n=o.useMemo(()=>new Date,[]),[r,d]=o.useState(()=>we(new Date)),[u,i]=o.useState(()=>re(new Date)),[h,x]=o.useState(null),[p,m]=o.useState(!1),f=o.useMemo(()=>we(r),[r]),g=o.useMemo(()=>{const v=zt(f),C=Qe(f,-v),k=[];for(let N=0;N<42;N++)k.push(Qe(C,N));return k},[f]),l=o.useMemo(()=>{const v=re(g[0]),C=re(g[g.length-1]);return{from:v,to:C}},[g]),y=!!(s||a),{data:P=[],isLoading:j}=Q({queryKey:["coach-calendar-assignments",s,a,l.from,l.to],queryFn:()=>D.getCoachAssignments({groupId:s??null,userId:a??null,from:l.from,to:l.to}),enabled:y}),_=o.useMemo(()=>{const v=new Map;for(const C of P){const k=C.scheduledDate?.slice(0,10);k&&(v.has(k)||v.set(k,[]),v.get(k).push(C))}return v},[P]),E=o.useMemo(()=>{const v={};for(const C of g){const k=re(C),N=_.get(k)??[],O=N.some($=>Se($.scheduledSlot)==="AM"),G=N.some($=>Se($.scheduledSlot)==="PM"),b=(O?1:0)+(G?1:0),T=[{slotKey:"AM",expected:O,completed:O,absent:!1},{slotKey:"PM",expected:G,completed:G,absent:!1}];v[k]={completed:b,total:b,slots:T}}return v},[g,_]),z=o.useMemo(()=>{const[v,C,k]=u.split("-").map(Number);return new Date(v,C-1,k)},[u]),L=o.useMemo(()=>_.get(u)??[],[_,u]),q=o.useMemo(()=>{const v=L;return It.map(C=>{const k=v.find(N=>C.type!==N.type?!1:C.type==="swim"?Se(N.scheduledSlot)===(C.scheduledSlot==="morning"?"AM":"PM"):!0);return{...C,assignment:k??null}})},[L]),H=o.useMemo(()=>{const v={};for(const C of g){const k=re(C),N=_.get(k)??[];v[k]=N.some(O=>O.type==="strength")}return v},[g,_]),w=E[u]??{completed:0,total:0,slots:[{slotKey:"AM",expected:!1,completed:!1,absent:!1},{slotKey:"PM",expected:!1,completed:!1,absent:!1}]},t=o.useCallback(()=>{d(v=>new Date(v.getFullYear(),v.getMonth()-1,1))},[]),S=o.useCallback(()=>{d(v=>new Date(v.getFullYear(),v.getMonth()+1,1))},[]),F=o.useCallback(()=>{d(we(new Date)),i(re(new Date))},[]),M=o.useCallback(v=>{i(v),m(!0)},[]);return{today:n,monthCursor:r,selectedISO:u,selectedDayIndex:h,drawerOpen:p,gridDates:g,completionByISO:E,selectedDate:z,selectedDayStatus:w,assignmentsForSelectedDay:L,slotsForSelectedDay:q,hasStrengthByISO:H,isLoading:j,hasFilter:y,setSelectedISO:i,setSelectedDayIndex:x,setDrawerOpen:m,prevMonth:t,nextMonth:S,jumpToday:F,openDay:M}}function qt(s){const[a,c,n]=s.split("-").map(Number);return new Date(a,c-1,n).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})}function Lt({onBack:s,athletes:a,groups:c,swimSessions:n,strengthSessions:r}){const[d,u]=o.useState("group"),[i,h]=o.useState(""),[x,p]=o.useState(""),m=d==="group"&&i?Number(i):null,f=d==="user"&&x?Number(x):null,{today:g,monthCursor:l,selectedISO:y,selectedDayIndex:P,drawerOpen:j,gridDates:_,completionByISO:E,selectedDayStatus:z,slotsForSelectedDay:L,hasStrengthByISO:q,hasFilter:H,setSelectedISO:w,setSelectedDayIndex:t,setDrawerOpen:S,prevMonth:F,nextMonth:M,jumpToday:v,openDay:C}=$t({groupId:m,userId:f,enabled:!0}),k=Ne(),N=B({mutationFn:b=>D.assignments_create(b),onSuccess:()=>{k.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),O=B({mutationFn:b=>D.assignments_delete(b),onSuccess:()=>{k.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),G=(b,T)=>{let $=T;if(b.key==="ArrowLeft"&&($=Math.max(0,T-1)),b.key==="ArrowRight"&&($=Math.min(_.length-1,T+1)),b.key==="ArrowUp"&&($=Math.max(0,T-7)),b.key==="ArrowDown"&&($=Math.min(_.length-1,T+7)),$!==T){b.preventDefault(),t($);const ne=le=>String(le).padStart(2,"0"),V=_[$],ie=`${V.getFullYear()}-${ne(V.getMonth()+1)}-${ne(V.getDate())}`;w(ie)}if(b.key==="Enter"||b.key===" "){b.preventDefault();const ne=le=>String(le).padStart(2,"0"),V=_[T],ie=`${V.getFullYear()}-${ne(V.getMonth()+1)}-${ne(V.getDate())}`;C(ie)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ee,{title:"Calendrier",description:"Vue mensuelle des assignations",onBack:s}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsxs(rs,{type:"single",value:d,onValueChange:b=>{(b==="group"||b==="user")&&u(b)},className:"shrink-0",children:[e.jsx(ce,{value:"group",className:"text-xs px-3",children:"Groupe"}),e.jsx(ce,{value:"user",className:"text-xs px-3",children:"Nageur"})]}),d==="group"?e.jsxs(U,{value:i,onValueChange:h,children:[e.jsx(W,{className:"w-full sm:w-56",children:e.jsx(Y,{placeholder:"Choisir un groupe"})}),e.jsx(J,{children:c.map(b=>e.jsx(I,{value:String(b.id),children:b.name},String(b.id)))})]}):e.jsxs(U,{value:x,onValueChange:p,children:[e.jsx(W,{className:"w-full sm:w-56",children:e.jsx(Y,{placeholder:"Choisir un nageur"})}),e.jsx(J,{children:a.filter(b=>b.id!=null).map(b=>e.jsxs(I,{value:String(b.id),children:[b.display_name,b.group_label?` · ${b.group_label}`:""]},String(b.id)))})]})]}),H?e.jsxs("div",{className:"rounded-2xl border bg-card shadow-sm",children:[e.jsx(Bs,{monthCursor:l,selectedDayStatus:z,onPrevMonth:F,onNextMonth:M,onJumpToday:v}),e.jsx(Hs,{monthCursor:l,gridDates:_,completionByISO:E,strengthByISO:q,selectedISO:y,selectedDayIndex:P,today:g,onDayClick:C,onKeyDown:G})]}):e.jsx("div",{className:"py-12 text-center text-sm text-muted-foreground",children:"Sélectionnez un groupe ou un nageur pour afficher le calendrier."}),e.jsx(Te,{open:j,onOpenChange:S,children:e.jsxs(Ee,{side:"bottom",className:"max-h-[70vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(ze,{className:"pb-3",children:[e.jsx(Ie,{className:"capitalize text-left",children:qt(y)}),e.jsx($e,{className:"sr-only",children:"Gérer les assignations pour cette journée"})]}),e.jsx("div",{className:"space-y-3",children:L.map(b=>e.jsx(Gt,{slot:b,swimSessions:n,strengthSessions:r,onAssign:T=>{N.mutate({assignment_type:b.type,session_id:T,scheduled_date:y,scheduled_slot:b.scheduledSlot??void 0,target_group_id:m,target_user_id:f})},onDelete:T=>{O.mutate(T)},onReplace:(T,$)=>{O.mutate(T,{onSuccess:()=>{N.mutate({assignment_type:b.type,session_id:$,scheduled_date:y,scheduled_slot:b.scheduledSlot??void 0,target_group_id:m,target_user_id:f})}})},isPending:N.isPending||O.isPending},b.key))})]})})]})}function Gt({slot:s,swimSessions:a,strengthSessions:c,onAssign:n,onDelete:r,onReplace:d,isPending:u}){const[i,h]=o.useState(!1),x=s.type==="swim",p=x?(a??[]).map(g=>({id:g.id,label:g.name})):(c??[]).map(g=>({id:g.id,label:g.title})),m=s.assignment!==null,f=g=>{const l=Number(g);l&&(m&&i?(d(s.assignment.id,l),h(!1)):n(l))};return e.jsxs("div",{className:"rounded-xl border p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[x?e.jsx(ss,{className:"h-4 w-4 text-blue-500 shrink-0"}):e.jsx(ts,{className:"h-4 w-4 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:s.label})]}),m&&!i?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold truncate flex-1",children:s.assignment.title}),e.jsx(A,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0",disabled:u,onClick:()=>h(!0),title:"Changer",children:e.jsx(Os,{className:"h-3.5 w-3.5"})}),e.jsx(A,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0 text-destructive hover:text-destructive",disabled:u,onClick:()=>r(s.assignment.id),title:"Supprimer",children:e.jsx(os,{className:"h-3.5 w-3.5"})})]}):e.jsxs(U,{value:"",onValueChange:f,disabled:u||p.length===0,children:[e.jsx(W,{className:"h-9 text-xs",children:e.jsx(Y,{placeholder:i?"Choisir le remplacement":"Choisir une séance"})}),e.jsx(J,{children:p.map(g=>e.jsx(I,{value:String(g.id),children:g.label},g.id))})]}),i?e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground",onClick:()=>h(!1),children:"Annuler"}):null]})}const ys=({athletes:s,selected:a,onToggle:c,filterToUserIds:n})=>{const[r,d]=o.useState(""),u=o.useMemo(()=>{let h=s.filter(x=>x.id!=null);if(n&&(h=h.filter(x=>n.has(x.id))),r.trim()){const x=r.toLowerCase();h=h.filter(p=>p.display_name.toLowerCase().includes(x))}return h},[s,n,r]),i=o.useMemo(()=>{const h=new Map;for(const x of u){const p=x.group_label||"Sans groupe";h.has(p)||h.set(p,[]),h.get(p).push(x)}return[...h.entries()].sort(([x],[p])=>x.localeCompare(p,"fr"))},[u]);return e.jsxs("div",{className:"space-y-3",children:[e.jsx(ge,{placeholder:"Rechercher un nageur...",value:r,onChange:h=>d(h.target.value)}),e.jsxs("div",{className:"max-h-[50vh] overflow-y-auto space-y-3",children:[i.map(([h,x])=>e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-1.5",children:h}),e.jsx("div",{className:"space-y-1",children:x.map(p=>e.jsxs("label",{className:"flex items-center gap-2.5 rounded-lg border px-3 py-2 cursor-pointer hover:bg-muted/50 transition-colors",children:[e.jsx(je,{checked:a.has(p.id),onCheckedChange:()=>c(p.id)}),e.jsx("span",{className:"text-sm",children:p.display_name})]},p.id))})]},h)),i.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun nageur trouvé."})]}),a.size>0&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.size," nageur",a.size>1?"s":""," ","sélectionné",a.size>1?"s":""]})]})},bs=({open:s,onOpenChange:a,athletes:c,parentGroupId:n,parentMembers:r,onCreated:d})=>{const{toast:u}=te(),[i,h]=o.useState(""),[x,p]=o.useState(new Set),m=l=>{p(y=>{const P=new Set(y);return P.has(l)?P.delete(l):P.add(l),P})},f=B({mutationFn:()=>D.createTemporaryGroup({name:i.trim(),member_user_ids:[...x],parent_group_id:n??void 0}),onSuccess:()=>{u({title:"Groupe créé",description:`Le groupe "${i.trim()}" a été créé avec ${x.size} nageur${x.size>1?"s":""}.`}),h(""),p(new Set),a(!1),d()},onError:l=>{u({title:"Erreur",description:l.message,variant:"destructive"})}}),g=()=>{if(!i.trim()){u({title:"Nom requis",description:"Veuillez saisir un nom pour le groupe.",variant:"destructive"});return}f.mutate()};return e.jsx(Te,{open:s,onOpenChange:a,children:e.jsxs(Ee,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ze,{children:[e.jsx(Ie,{children:n?"Créer un sous-groupe":"Créer un groupe"}),e.jsx($e,{children:n?"Sélectionnez des nageurs du groupe parent pour ce sous-groupe.":"Créez un groupe temporaire (stage, compétition) avec des nageurs de différents groupes."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:"group-name",children:"Nom du groupe"}),e.jsx(ge,{id:"group-name",placeholder:"Ex : Stage Pâques 2026",value:i,onChange:l=>h(l.target.value)})]}),e.jsx(Us,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Nageurs"}),e.jsx(ys,{athletes:c,selected:x,onToggle:m,filterToUserIds:r??null})]}),e.jsx(A,{className:"w-full",onClick:g,disabled:f.isPending||!i.trim(),children:f.isPending?"Création...":"Créer le groupe"})]})]})})},Vt=({open:s,onOpenChange:a,groupId:c,athletes:n,existingMemberIds:r,onAdded:d})=>{const{toast:u}=te(),[i,h]=o.useState(new Set),x=o.useMemo(()=>n.filter(f=>f.id!=null&&!r.has(f.id)),[n,r]),p=f=>{h(g=>{const l=new Set(g);return l.has(f)?l.delete(f):l.add(f),l})},m=B({mutationFn:()=>D.addTemporaryGroupMembers(c,[...i]),onSuccess:()=>{u({title:"Nageurs ajoutés",description:`${i.size} nageur${i.size>1?"s":""} ajouté${i.size>1?"s":""}.`}),h(new Set),a(!1),d()},onError:f=>{u({title:"Erreur",description:f.message,variant:"destructive"})}});return e.jsx(Te,{open:s,onOpenChange:a,children:e.jsxs(Ee,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ze,{children:[e.jsx(Ie,{children:"Ajouter des nageurs"}),e.jsx($e,{children:"Sélectionnez les nageurs à ajouter au groupe."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx(ys,{athletes:x,selected:i,onToggle:p}),e.jsx(A,{className:"w-full",onClick:()=>m.mutate(),disabled:m.isPending||i.size===0,children:m.isPending?"Ajout...":`Ajouter ${i.size} nageur${i.size>1?"s":""}`})]})]})})},Kt=({groupId:s,athletes:a,onBack:c})=>{const{toast:n}=te(),r=Ne(),[d,u]=o.useState(!1),[i,h]=o.useState(!1),[x,p]=o.useState(null),{data:m,isLoading:f}=Q({queryKey:["temp-group-detail",s],queryFn:()=>D.getTemporaryGroupDetail(s)}),g=B({mutationFn:j=>D.removeTemporaryGroupMember(s,j),onSuccess:()=>{n({title:"Nageur retiré"}),r.invalidateQueries({queryKey:["temp-group-detail",s]}),r.invalidateQueries({queryKey:["temp-groups"]})},onError:j=>{n({title:"Erreur",description:j.message,variant:"destructive"})}}),l=()=>{r.invalidateQueries({queryKey:["temp-group-detail",s]}),r.invalidateQueries({queryKey:["temp-groups"]})},y=o.useMemo(()=>new Set((m?.members??[]).map(j=>j.user_id)),[m]),P=o.useMemo(()=>new Set((m?.members??[]).map(j=>j.user_id)),[m]);return f?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:c,children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(j=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted"})},j))})]}):m?e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:c,children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:m.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{variant:m.is_active?"default":"secondary",children:m.is_active?"Actif":"Terminé"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[m.members.length," membre",m.members.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Membres"}),m.is_active&&e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>u(!0),children:[e.jsx(Zs,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]}),m.members.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun membre dans ce groupe."}):e.jsx("div",{className:"space-y-1.5",children:m.members.map(j=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:j.display_name}),j.permanent_group_label&&e.jsx(ae,{variant:"secondary",className:"text-[10px] px-1.5 py-0 mt-0.5",children:j.permanent_group_label})]}),m.is_active&&e.jsx(A,{size:"icon",variant:"ghost",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>p({userId:j.user_id,name:j.display_name}),title:"Retirer du groupe",children:e.jsx(Xs,{className:"h-4 w-4"})})]},j.user_id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Sous-groupes"}),m.is_active&&e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>h(!0),children:[e.jsx(Fe,{className:"mr-1.5 h-3.5 w-3.5"}),"Sous-groupe"]})]}),m.subgroups.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun sous-groupe."}):e.jsx("div",{className:"space-y-2",children:m.subgroups.map(j=>e.jsxs(Ws,{children:[e.jsxs(Ys,{className:"flex w-full items-center justify-between rounded-xl border bg-card p-3 text-left hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-semibold",children:j.name}),e.jsx(ae,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:j.members.length})]}),e.jsx(as,{className:"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]_&]:rotate-180"})]}),e.jsx(Js,{children:e.jsxs("div",{className:"ml-4 mt-1 space-y-1",children:[j.members.map(_=>e.jsx("div",{className:"flex items-center gap-2 rounded-lg border px-3 py-2",children:e.jsx("span",{className:"text-sm",children:_.display_name})},_.user_id)),j.members.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground py-2",children:"Aucun membre."})]})})]},j.id))})]}),e.jsx(Vt,{open:d,onOpenChange:u,groupId:s,athletes:a,existingMemberIds:y,onAdded:l}),e.jsx(bs,{open:i,onOpenChange:h,athletes:a,parentGroupId:s,parentMembers:P,onCreated:l}),e.jsx(_e,{open:!!x,onOpenChange:j=>{j||p(null)},children:e.jsxs(ke,{children:[e.jsxs(Me,{children:[e.jsx(Ae,{children:"Retirer du groupe"}),e.jsxs(De,{children:["Voulez-vous retirer ",x?.name," de ce groupe ?",m.subgroups.length>0?" Le nageur sera aussi retiré des sous-groupes.":""]})]}),e.jsxs(Pe,{children:[e.jsx(Re,{children:"Annuler"}),e.jsx(Oe,{onClick:()=>{x&&(g.mutate(x.userId),p(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Retirer"})]})]})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:c,children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Groupe introuvable."})]})},Ue=({group:s,onManage:a,onDeactivate:c,onReactivate:n,onDelete:r})=>{const d=new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"});return e.jsxs("div",{className:"rounded-xl border bg-card p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-bold truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1 flex-wrap",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.member_count," membre",s.member_count!==1?"s":""]}),s.subgroup_count>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.subgroup_count," sous-groupe",s.subgroup_count!==1?"s":""]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:d})]})]}),e.jsx(ae,{variant:s.is_active?"default":"secondary",children:s.is_active?"Actif":"Terminé"})]}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:s.is_active?e.jsxs(e.Fragment,{children:[e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>a(s.id),children:[e.jsx(Fs,{className:"mr-1.5 h-3.5 w-3.5"}),"Gérer"]}),e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>c(s.id),children:[e.jsx(Qs,{className:"mr-1.5 h-3.5 w-3.5"}),"Terminer"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>n(s.id),children:[e.jsx(Ts,{className:"mr-1.5 h-3.5 w-3.5"}),"Réactiver"]}),e.jsxs(A,{size:"sm",variant:"outline",className:"text-destructive hover:text-destructive",onClick:()=>r(s.id),children:[e.jsx(os,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})})]})},Bt=({onBack:s,athletes:a,athletesLoading:c})=>{const{toast:n}=te(),r=Ne(),[d,u]=o.useState("list"),[i,h]=o.useState(null),[x,p]=o.useState(!1),[m,f]=o.useState(null),[g,l]=o.useState(null),{data:y=[],isLoading:P}=Q({queryKey:["temp-groups"],queryFn:()=>D.getTemporaryGroups()}),j=o.useMemo(()=>y.filter(w=>w.is_active),[y]),_=o.useMemo(()=>y.filter(w=>!w.is_active),[y]),E=B({mutationFn:w=>D.deactivateTemporaryGroup(w),onSuccess:()=>{n({title:"Groupe terminé"}),r.invalidateQueries({queryKey:["temp-groups"]})},onError:w=>{n({title:"Erreur",description:w.message,variant:"destructive"})}}),z=B({mutationFn:w=>D.reactivateTemporaryGroup(w),onSuccess:()=>{n({title:"Groupe réactivé"}),r.invalidateQueries({queryKey:["temp-groups"]})},onError:w=>{n({title:"Erreur",description:w.message,variant:"destructive"})}}),L=B({mutationFn:w=>D.deleteTemporaryGroup(w),onSuccess:()=>{n({title:"Groupe supprimé"}),r.invalidateQueries({queryKey:["temp-groups"]})},onError:w=>{n({title:"Erreur",description:w.message,variant:"destructive"})}}),q=w=>{h(w),u("detail")},H=()=>{h(null),u("list"),r.invalidateQueries({queryKey:["temp-groups"]})};return d==="detail"&&i!=null?e.jsx(Kt,{groupId:i,athletes:a,onBack:H}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ee,{title:"Groupes temporaires",description:"Créez et gérez des groupes pour les stages, compétitions ou événements.",onBack:s,actions:e.jsxs(A,{onClick:()=>p(!0),children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Créer un groupe"]})}),P||c?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(w=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-6 w-16 rounded bg-muted"})]})},w))}):y.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ye,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun groupe temporaire pour le moment."}),e.jsxs(A,{variant:"outline",size:"sm",onClick:()=>p(!0),children:[e.jsx(Fe,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer le premier groupe"]})]}):e.jsxs(e.Fragment,{children:[j.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Actifs (",j.length,")"]}),j.map(w=>e.jsx(Ue,{group:w,onManage:q,onDeactivate:t=>f(t),onReactivate:t=>z.mutate(t),onDelete:t=>l(t)},w.id))]}),_.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Terminés (",_.length,")"]}),_.map(w=>e.jsx(Ue,{group:w,onManage:q,onDeactivate:t=>f(t),onReactivate:t=>z.mutate(t),onDelete:t=>l(t)},w.id))]})]}),e.jsx(bs,{open:x,onOpenChange:p,athletes:a,onCreated:()=>{r.invalidateQueries({queryKey:["temp-groups"]})}}),e.jsx(_e,{open:m!=null,onOpenChange:w=>{w||f(null)},children:e.jsxs(ke,{children:[e.jsxs(Me,{children:[e.jsx(Ae,{children:"Terminer le groupe"}),e.jsx(De,{children:"Voulez-vous marquer ce groupe comme terminé ? Les sous-groupes seront aussi désactivés. Vous pourrez le réactiver plus tard si nécessaire."})]}),e.jsxs(Pe,{children:[e.jsx(Re,{children:"Annuler"}),e.jsx(Oe,{onClick:()=>{m!=null&&(E.mutate(m),f(null))},children:"Terminer"})]})]})}),e.jsx(_e,{open:g!=null,onOpenChange:w=>{w||l(null)},children:e.jsxs(ke,{children:[e.jsxs(Me,{children:[e.jsx(Ae,{children:"Supprimer le groupe"}),e.jsx(De,{children:"Cette action est irréversible. Le groupe et tous ses sous-groupes seront supprimés définitivement."})]}),e.jsxs(Pe,{children:[e.jsx(Re,{children:"Annuler"}),e.jsx(Oe,{onClick:()=>{g!=null&&(L.mutate(g),l(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Ht=o.lazy(()=>ns(()=>import("./StrengthCatalog-DkTKz7U4.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37]))),Qt=o.lazy(()=>ns(()=>import("./SwimCatalog-CDEtc-sI.js"),__vite__mapDeps([38,1,2,3,4,5,6,18,19,9,11,21,16,39,40,12,41,23,15,24,17,25,26,14,10,8,13,29,42,28,43]))),Ut=({onNavigate:s,onOpenRecordsAdmin:a,onOpenRecordsClub:c,athletes:n,athletesLoading:r,upcomingBirthdays:d,birthdaysLoading:u,kpiLoading:i,kpiPeriod:h,onKpiPeriodChange:x,fatigueAlerts:p,mostLoadedAthlete:m,swimSessionCount:f,strengthSessionCount:g})=>{const l=new Date().getHours(),y=l<12?"Bonjour":l<18?"Bon après-midi":"Bonsoir",P=new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),j=p.length>0;return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-display font-bold uppercase italic",children:[y,", ",e.jsx("span",{className:"text-primary",children:"Coach"})]}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:P})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Signaux · ",h,"j"]}),e.jsxs(rs,{type:"single",size:"sm",variant:"outline",value:String(h),onValueChange:_=>{_&&x(Number(_))},children:[e.jsx(ce,{value:"7",className:"h-7 px-2 text-xs","aria-label":"7 jours",children:"7j"}),e.jsx(ce,{value:"30",className:"h-7 px-2 text-xs","aria-label":"30 jours",children:"30j"}),e.jsx(ce,{value:"365",className:"h-7 px-2 text-xs","aria-label":"1 an",children:"1an"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:`rounded-xl border p-3 ${j?"border-destructive/30 bg-destructive/5":"bg-muted/30"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Fatigue 5/5"}),e.jsx(it,{className:`h-3.5 w-3.5 ${j?"text-destructive":"text-muted-foreground"}`})]}),e.jsx("p",{className:"text-xl font-bold tabular-nums",children:i?"–":p.length}),e.jsx("p",{className:"text-[11px] text-muted-foreground truncate",children:i?"Chargement…":j?p.slice(0,2).map(_=>_.athleteName.split(" ")[0]).join(", "):"Aucune alerte"})]}),e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Plus chargé"}),e.jsx(ye,{className:"h-3.5 w-3.5 text-muted-foreground"})]}),e.jsx("p",{className:"text-xl font-bold truncate",children:i?"–":m?.athleteName?.split(" ")[0]??"–"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:i?"Calcul…":m?`Charge ${Math.round(m.loadScore)}`:"Pas de données"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>s("assignments"),className:"flex items-center gap-1.5 rounded-full bg-primary text-primary-foreground px-4 py-2 text-sm font-semibold active:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(be,{className:"h-3.5 w-3.5"}),"Assigner"]}),e.jsxs("button",{type:"button",onClick:()=>s("messaging"),className:"flex items-center gap-1.5 rounded-full border px-4 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(qe,{className:"h-3.5 w-3.5"}),"Email"]}),e.jsxs("button",{type:"button",onClick:()=>s("calendar"),className:"flex items-center gap-1.5 rounded-full border px-4 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(nt,{className:"h-3.5 w-3.5"}),"Calendrier"]}),e.jsxs("button",{type:"button",onClick:()=>s("groups"),className:"flex items-center gap-1.5 rounded-full border px-4 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(is,{className:"h-3.5 w-3.5"}),"Groupes"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>s("swim"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ss,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Natation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:f!=null?`${f} séance${f!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("strength"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ts,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Musculation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:g!=null?`${g} séance${g!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("swimmers"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ye,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Nageurs"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r?"Chargement…":`${n.length} nageur${n.length!==1?"s":""}`})]}),e.jsxs("button",{type:"button",onClick:a,className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Is,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Records club"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Import & administration"})]})]}),e.jsx("button",{type:"button",onClick:c,className:"w-full text-center text-sm text-primary font-semibold py-1 active:opacity-70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded",children:"Voir les records du club"}),!u&&d&&d.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Anniversaires"}),e.jsx("div",{className:"space-y-1.5",children:d.slice(0,3).map(_=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium",children:_.display_name}),e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:Wt(_.next_birthday)})]}),e.jsxs("span",{className:"text-xs font-bold text-primary",children:["J-",_.days_until]})]},_.id))})]}):null]})},Wt=s=>{if(!s)return"-";const a=new Date(s);return Number.isNaN(a.getTime())?s:a.toLocaleDateString("fr-FR")},We=s=>s.toISOString().split("T")[0],Yt=s=>new Date(s.completed_at||s.started_at||s.date||s.created_at||0).getTime(),Jt=s=>{if(!s.length)return null;const a=s.reduce((n,r)=>n+r,0)/s.length,c=Math.min(5,Math.max(1,Math.round(a/10*5)));return{average:a,rating:c}};function Zt(){const s=Ke(t=>t.role),a=Ke(t=>t.setSelectedAthlete),[,c]=Es(),[n,r]=o.useState("home"),[d,u]=o.useState(7),i=s==="coach"||s==="admin",h=n==="home"||n==="assignments"||n==="calendar",x=n==="home"||n==="assignments"||n==="messaging"||n==="swimmers"||n==="calendar"||n==="groups",p=n==="assignments"||n==="messaging"||n==="calendar"||n==="groups",m=n==="home"||n==="swimmers",{data:f}=Q({queryKey:["swim_catalog"],queryFn:()=>D.getSwimCatalog(),enabled:i&&h}),{data:g}=Q({queryKey:["strength_catalog"],queryFn:()=>D.getStrengthSessions(),enabled:i&&h}),{data:l=[],isLoading:y}=Q({queryKey:["athletes"],queryFn:()=>D.getAthletes(),enabled:i&&x}),P=o.useMemo(()=>l.slice(0,5),[l]),{data:j=[]}=Q({queryKey:["groups"],queryFn:()=>D.getGroups(),enabled:i&&p}),_=Q({queryKey:["upcoming-birthdays"],queryFn:()=>D.getUpcomingBirthdays({days:30}),enabled:i&&m}),E=_.data,z=Q({queryKey:["coach-kpis",d,P.map(t=>t.id??t.display_name)],enabled:i&&n==="home"&&P.length>0,queryFn:async()=>{const t=d,S=new Date;S.setDate(S.getDate()-t);const F=We(S),M=We(new Date),v=await Promise.all(P.map(async N=>{const[O,G]=await Promise.all([D.getSessions(N.display_name,N.id),D.getStrengthHistory(N.display_name,{athleteId:N.id,limit:50,from:F,to:M})]),b=O.filter(R=>new Date(R.date).getTime()>=S.getTime()),T=b.map(R=>R.fatigue??R.feeling).filter(R=>Number.isFinite(R)),$=b.reduce((R,Z)=>R+(Number(Z.duration)||0)*(Number(Z.effort)||0),0),V=(G?.runs??[]).filter(R=>Yt(R)>=S.getTime()),ie=V.map(R=>R.fatigue??R.feeling??R.rpe).filter(R=>Number.isFinite(Number(R))).map(R=>Number(R)),le=V.reduce((R,Z)=>{const Ge=Number(Z.feeling??Z.rpe??0),Ve=Number(Z.duration??0);if(Ve>0&&Ge>0)return R+Ve*Ge;const Cs=Array.isArray(Z.logs)?Z.logs.length:0;return R+Cs*5},0),Ns=Jt([...T,...ie]);return{athleteName:N.display_name,loadScore:$+le,fatigueRating:Ns}})),C=v.filter(N=>N.fatigueRating?.rating===5).map(N=>({athleteName:N.athleteName,rating:N.fatigueRating?.rating??0})),k=v.filter(N=>N.loadScore>0).sort((N,O)=>O.loadScore-N.loadScore)[0];return{fatigueAlerts:C,mostLoadedAthlete:k??null}}}),L=t=>{a({id:t.id??null,name:t.display_name}),c("/progress")},{toast:q}=te(),H=Ne(),w=B({mutationFn:async t=>{const S=await D.importSingleSwimmer(t.iuf,t.name);return await D.recalculateClubRecords(),S},onSuccess:t=>{q({title:"Import terminé",description:`${t.total_found} trouvées, ${t.new_imported} nouvelles.`}),H.invalidateQueries({queryKey:["club-records"]})},onError:t=>{q({title:"Erreur import",description:t.message,variant:"destructive"})}});return i?e.jsxs("div",{className:"space-y-6",children:[n==="home"?e.jsx(Ut,{onNavigate:r,onOpenRecordsAdmin:()=>c("/records-admin"),onOpenRecordsClub:()=>c("/records-club"),athletes:l,athletesLoading:y,upcomingBirthdays:E,birthdaysLoading:_.isLoading,kpiLoading:z.isLoading,kpiPeriod:d,onKpiPeriodChange:u,fatigueAlerts:z.data?.fatigueAlerts??[],mostLoadedAthlete:z.data?.mostLoadedAthlete??null,swimSessionCount:f?.length,strengthSessionCount:g?.length}):null,n==="assignments"?e.jsx(Tt,{onBack:()=>r("home"),swimSessions:f,strengthSessions:g,athletes:l,groups:j}):null,n==="swim"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{title:"Bibliothèque natation",description:"Accédez aux séances et aux templates natation.",onBack:()=>r("home"),actions:e.jsxs(A,{variant:"outline",onClick:()=>r("assignments"),children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Nouvelle assignation"]})}),e.jsx(o.Suspense,{fallback:e.jsx(Be,{}),children:e.jsx(Qt,{})})]}):null,n==="strength"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ee,{title:"Bibliothèque musculation",description:"Consultez et créez des séances musculation.",onBack:()=>r("home"),actions:e.jsxs(A,{variant:"outline",onClick:()=>r("assignments"),children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Nouvelle assignation"]})}),e.jsx(o.Suspense,{fallback:e.jsx(Be,{}),children:e.jsx(Ht,{})})]}):null,n==="swimmers"?e.jsxs("div",{className:"space-y-4",children:[e.jsx(ee,{title:"Nageurs",description:y?"Chargement…":`${l.length} nageur${l.length!==1?"s":""} inscrit${l.length!==1?"s":""}`,onBack:()=>r("home"),actions:e.jsxs(A,{variant:"outline",size:"sm",onClick:()=>r("messaging"),children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Email"]})}),y?e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(t=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-8 w-16 rounded bg-muted"})]})},t))}):l.length?e.jsx("div",{className:"space-y-2",children:l.map(t=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:t.display_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[t.group_label?e.jsx(ae,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:t.group_label}):null,t.ffn_iuf?e.jsx("span",{className:"text-[10px] font-mono text-muted-foreground",children:t.ffn_iuf}):null]})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[t.ffn_iuf?e.jsx(A,{size:"icon",variant:"ghost",className:"h-8 w-8",disabled:w.isPending,onClick:()=>w.mutate({iuf:t.ffn_iuf,name:t.display_name}),title:"Importer performances FFN",children:e.jsx(zs,{className:"h-4 w-4"})}):null,e.jsx(A,{size:"sm",variant:"outline",onClick:()=>L(t),children:"Fiche"})]})]},t.id??t.display_name))}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun nageur disponible."})]}):null,n==="messaging"?e.jsx(Et,{onBack:()=>r("home"),athletes:l,groups:j,athletesLoading:y}):null,n==="calendar"?e.jsx(Lt,{onBack:()=>r("home"),athletes:l,groups:j,swimSessions:f,strengthSessions:g}):null,n==="groups"?e.jsx(Bt,{onBack:()=>r("home"),athletes:l,groups:j,athletesLoading:y}):null]}):e.jsx("div",{className:"flex items-center justify-center min-h-[60vh] animate-in fade-in motion-reduce:animate-none",children:e.jsxs(ue,{className:"w-full max-w-sm shadow-xl border-t-4 border-t-primary",children:[e.jsxs(me,{children:[e.jsxs(pe,{className:"flex items-center gap-2 uppercase italic",children:[e.jsx(ye,{className:"h-5 w-5 text-primary"}),"Accès Coach"]}),e.jsx(he,{children:"Cette section est réservée aux coachs et administrateurs."})]}),e.jsx(xe,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connectez-vous avec un compte autorisé pour accéder aux outils de gestion."})})]})})}const fn=Object.freeze(Object.defineProperty({__proto__:null,default:Zt},Symbol.toStringTag,{value:"Module"}));export{fn as C,Ot as P,Ft as a,vs as b};
