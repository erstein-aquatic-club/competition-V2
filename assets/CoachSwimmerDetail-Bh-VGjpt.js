import{r as d,u as E,j as e,c as ye,d as z,f as yt}from"./vendor-query-Dcze6zAc.js";import{c as bt,b as Xe,u as Ye,B as M,d as be,L as Q,I as Ee,s as Ze,X as Nt,a5 as vt,T as _t,a9 as Ct}from"./index-CJR1LXwK.js";import{a as p}from"./api-Dev_1Ngn.js";import{T as wt,a as kt,b as Ce,c as we}from"./tabs-BXLpriof.js";import{B as R}from"./badge-BaGyPof6.js";import{C as St}from"./chart-column-Dyw6R_jF.js";import{C as et}from"./chevron-down-CrqyNzx-.js";import{T as Ke}from"./textarea-CG8xI8GW.js";import{S as te,a as se,b as ae,c as ne,d as J}from"./select-CFQPostt.js";import{T as Tt,a as Fe}from"./toggle-group-C5FLHB70.js";import{S as tt,a as st,b as at,c as nt}from"./sheet-_Kbkmq50.js";import{A as de,a as me,b as ue,c as xe,d as pe,e as he,f as ge,g as fe}from"./alert-dialog-6uA13Z7e.js";import{T as qe,s as rt,a as it,c as lt,d as Dt,S as ct,e as $e,f as je,b as Et,F as qt,p as Be,M as ot,A as Ft}from"./objectiveHelpers-CNZfWwZm.js";import{P as ie}from"./plus-DeUz3ExK.js";import{T as We}from"./trash-2-CuYql-Ve.js";import{w as dt,a as mt,S as Qe,G as ut}from"./weekTypeColor-udOdHyTX.js";import{t as Me}from"./date-NdbyDBh_.js";import{C as At}from"./copy-C4Z0x517.js";import{C as Pt}from"./index-B4zcCWEH.js";import{P as Mt}from"./pencil-CvIiiBfj.js";import{C as Ot,a as Lt,b as Kt}from"./collapsible-CAccAJSl.js";import{C as $t}from"./chevron-up-DywrYoOX.js";import{C as xt}from"./clock-Czt_7Lcv.js";import{C as Wt}from"./chevron-right-DYyox7Xb.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./swim-Bhx2umXq.js";import"./index-CZCuv8N1.js";import"./index-CmtkFAXv.js";import"./index-vJWW3vdg.js";import"./format-B9mPVj_w.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M17 14h-6",key:"bkmgh3"}],["path",{d:"M13 18H7",key:"bb0bb7"}],["path",{d:"M7 14h.01",key:"1qa3f1"}],["path",{d:"M17 18h.01",key:"1bdyru"}]],pt=bt("calendar-range",Rt);function Ae(...t){return t.filter(Boolean).join(" ")}const It=[{key:"effort",label:"Diff.",mode:"hard"},{key:"feeling",label:"Fat.",mode:"hard"},{key:"performance",label:"Perf",mode:"good"},{key:"engagement",label:"Eng.",mode:"good"}];function zt(t,s){const a=Number(s);if(!Number.isFinite(a)||a<1||a>5)return"bg-muted text-muted-foreground";const i=t==="hard"?6-a:a;return i>=4?"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400":i>=3?"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400":"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"}function Bt({athleteId:t,athleteName:s}){const[,a]=Xe(),{setSelectedAthlete:i}=Ye(),[c,l]=d.useState(20),[n,m]=d.useState(null),[_,f]=d.useState(null),{data:b=[],isLoading:v}=E({queryKey:["sessions",t],queryFn:()=>p.getSessions(s,t)}),j=b.slice(0,c),C=b.length>c;if(v)return e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(h=>e.jsxs("div",{className:"rounded-2xl border bg-card p-3 animate-pulse motion-reduce:animate-none",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted mb-2"}),e.jsx("div",{className:"h-3 w-full rounded bg-muted"})]},h))});if(b.length===0)return e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun ressenti enregistre."});const w=()=>{i({id:t,name:s}),a("/progress")};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(M,{variant:"outline",size:"sm",className:"w-full text-xs gap-1.5",onClick:w,children:[e.jsx(St,{className:"h-3.5 w-3.5"}),"Voir la progression"]}),j.map(h=>{const S=n===h.id;return e.jsxs("button",{type:"button",onClick:()=>{f(null),m(S?null:h.id)},className:"w-full rounded-2xl border bg-card p-3 text-left hover:border-primary/20 transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:new Date(h.date).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}),e.jsx("span",{className:"text-xs text-muted-foreground ml-1.5",children:h.slot})]}),e.jsx("div",{className:"flex items-center gap-1",children:It.map(k=>{const q=h[k.key],y=`${h.id}-${k.key}`,K=_===y;return e.jsxs("span",{className:"relative group",onClick:L=>{L.stopPropagation(),f(K?null:y)},children:[e.jsx("span",{className:Ae("inline-flex items-center justify-center h-6 w-6 rounded-lg text-[10px] font-bold cursor-pointer",zt(k.mode,q)),children:q??"â€”"}),e.jsx("span",{className:Ae("absolute -top-7 left-1/2 -translate-x-1/2 rounded-md bg-foreground text-background px-1.5 py-0.5 text-[9px] font-semibold whitespace-nowrap pointer-events-none transition-opacity","opacity-0 group-hover:opacity-100",K&&"opacity-100"),children:k.label})]},k.key)})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:h.distance>0?`${h.distance}m`:"â€”"}),h.comments&&e.jsx(et,{className:Ae("h-3.5 w-3.5 text-muted-foreground transition-transform",S&&"rotate-180")})]}),S&&h.comments&&e.jsx("div",{className:"mt-2 pt-2 border-t border-border",children:e.jsx("p",{className:"text-xs text-foreground whitespace-pre-wrap",children:h.comments})})]},h.id)}),C&&e.jsxs("button",{type:"button",onClick:h=>{h.stopPropagation(),l(S=>S+20)},className:"w-full rounded-2xl border border-dashed border-border py-2 text-xs font-medium text-muted-foreground hover:bg-muted transition",children:["Charger plus (",b.length-c," restants)"]})]})}async function Qt(t){const{data:s,error:a}=await Ze.rpc("get_auth_uid_for_user",{p_user_id:t});return a?(console.error("[objectives-tab] Failed to resolve auth UUID:",a.message),null):s}const Ut=({open:t,onOpenChange:s,objective:a,athleteName:i,athleteAuthId:c,competitions:l})=>{const{toast:n}=be(),m=ye(),_=!!a,[f,b]=d.useState("chrono"),[v,j]=d.useState(""),[C,w]=d.useState("25"),[h,S]=d.useState(""),[k,q]=d.useState(""),[y,K]=d.useState(""),[L,$]=d.useState(!1);d.useEffect(()=>{if(t)if(a){const o=!!a.event_code,F=!!a.text;b(o&&F?"both":F?"texte":"chrono"),j(a.event_code??""),w(String(a.pool_length??25)),S(a.target_time_seconds!=null?je(a.target_time_seconds):""),q(a.text??""),K(a.competition_id??"")}else b("chrono"),j(""),w("25"),S(""),q(""),K("")},[t,a]);const u=z({mutationFn:o=>p.createObjective(o),onSuccess:()=>{n({title:"Objectif crÃ©Ã©"}),m.invalidateQueries({queryKey:["objectives",c]}),s(!1)},onError:o=>{n({title:"Erreur",description:o.message,variant:"destructive"})}}),x=z({mutationFn:o=>p.updateObjective(a.id,o),onSuccess:()=>{n({title:"Objectif mis Ã  jour"}),m.invalidateQueries({queryKey:["objectives",c]}),s(!1)},onError:o=>{n({title:"Erreur",description:o.message,variant:"destructive"})}}),g=z({mutationFn:()=>p.deleteObjective(a.id),onSuccess:()=>{n({title:"Objectif supprimÃ©"}),m.invalidateQueries({queryKey:["objectives",c]}),s(!1)},onError:o=>{n({title:"Erreur",description:o.message,variant:"destructive"})}}),P=f==="chrono"||f==="both",W=f==="texte"||f==="both",I=()=>{if(P&&!v){n({title:"Ã‰preuve requise",description:"Veuillez sÃ©lectionner une Ã©preuve.",variant:"destructive"});return}if(P&&h&&Be(h)===null){n({title:"Format invalide",description:"Le temps doit Ãªtre au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(W&&!k.trim()){n({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const o={athlete_id:c,competition_id:y&&y!=="none"?y:null,event_code:P?v:null,pool_length:P?Number(C):null,target_time_seconds:P&&h?Be(h):null,text:W?k.trim():null};_?x.mutate(o):u.mutate(o)},O=u.isPending||x.isPending||g.isPending,N=d.useMemo(()=>{const o=new Date;return o.setHours(0,0,0,0),l.filter(F=>new Date(F.date+"T00:00:00").getTime()>=o.getTime())},[l]);return e.jsxs(e.Fragment,{children:[e.jsx(tt,{open:t,onOpenChange:s,children:e.jsxs(st,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(at,{children:e.jsx(nt,{children:_?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Type d'objectif"}),e.jsxs(Tt,{type:"single",variant:"outline",value:f,onValueChange:o=>{o&&b(o)},className:"justify-start",children:[e.jsx(Fe,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(Fe,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(Fe,{value:"both",className:"text-xs",children:"Les deux"})]})]}),P&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Ã‰preuve *"}),e.jsxs(te,{value:v,onValueChange:j,children:[e.jsx(se,{children:e.jsx(ae,{placeholder:"Choisir une Ã©preuve"})}),e.jsx(ne,{children:qt.map(o=>e.jsx(J,{value:o,children:$e(o)},o))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Bassin"}),e.jsxs(te,{value:C,onValueChange:w,children:[e.jsx(se,{children:e.jsx(ae,{})}),e.jsxs(ne,{children:[e.jsx(J,{value:"25",children:"25m"}),e.jsx(J,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Temps cible (min:sec:centiÃ¨mes)"}),e.jsx(Ee,{placeholder:"Ex : 1:05:30",value:h,onChange:o=>S(o.target.value)})]})]}),W&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Objectif texte *"}),e.jsx(Ke,{placeholder:"Ex : AmÃ©liorer la coulÃ©e de dos",value:k,onChange:o=>q(o.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Lier Ã  une compÃ©tition"}),e.jsxs(te,{value:y,onValueChange:K,children:[e.jsx(se,{children:e.jsx(ae,{placeholder:"Aucune"})}),e.jsxs(ne,{children:[e.jsx(J,{value:"none",children:"Aucune"}),N.map(o=>e.jsxs(J,{value:o.id,children:[o.name," (",o.date,")"]},o.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(M,{className:"w-full",onClick:I,disabled:O,children:O?"Enregistrement...":_?"Enregistrer":"CrÃ©er"}),_&&e.jsx(M,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>$(!0),disabled:O,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(de,{open:L,onOpenChange:$,children:e.jsxs(me,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"Supprimer l'objectif"}),e.jsx(pe,{children:"Cette action est irrÃ©versible. L'objectif sera supprimÃ© dÃ©finitivement."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>{g.mutate(),$(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function Vt(t){const s=t.split("-");return s.length===3?`${s[2]}/${s[1]}/${s[0]}`:t}const Gt=({objective:t,performances:s,onEdit:a})=>{const i=t.event_code?rt(t.event_code):null,c=i?ct[i]??"":"",l=t.event_code?it(s,t.event_code,t.pool_length):null;let n=null,m=null;l&&t.target_time_seconds!=null&&t.event_code&&(n=l.time-t.target_time_seconds,m=lt(l.time,t.target_time_seconds,t.event_code));const _=!!t.competition_name,f=t.competition_date?Dt(t.competition_date):null;return e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card p-3 text-sm space-y-1.5 transition-colors hover:bg-muted/50 ${c?`border-l-4 ${c}`:""}`,onClick:()=>a(t),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(qe,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-center gap-1.5 flex-wrap",children:[t.event_code&&e.jsx("span",{className:"font-medium",children:$e(t.event_code)}),t.event_code&&t.pool_length&&e.jsxs("span",{className:"text-muted-foreground",children:["(",t.pool_length,"m)"]}),t.target_time_seconds!=null&&e.jsx("span",{className:"font-mono text-xs text-primary",children:je(t.target_time_seconds)})]}),e.jsx(We,{className:"h-3.5 w-3.5 text-muted-foreground/40 shrink-0"})]}),t.text&&e.jsx("p",{className:"text-muted-foreground text-xs pl-5 line-clamp-2",children:t.text}),t.event_code&&l&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:je(l.time)})]}),l.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",Vt(l.date),")"]}),n!=null&&e.jsx("span",{className:n<=0?"text-emerald-600 font-medium":"text-amber-600",children:n<=0?"Objectif atteint !":`+${n.toFixed(2)}s`})]}),t.event_code&&!l&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"}),m!=null&&e.jsx("div",{className:"pl-5 pr-1",children:e.jsx("div",{className:"h-1.5 w-full rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${Et(m)}`,style:{width:`${Math.min(m,100)}%`}})})}),_&&e.jsx("div",{className:"pl-5",children:e.jsxs(R,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:[t.competition_name,f!=null&&f>0&&e.jsxs("span",{className:"ml-1 font-bold",children:["J-",f]})]})})]})},Ht=({athleteId:t,athleteName:s})=>{const[a,i]=d.useState(!1),[c,l]=d.useState(null),{data:n,isLoading:m}=E({queryKey:["auth-uid",t],queryFn:()=>Qt(t),enabled:!!t}),{data:_=[]}=E({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),{data:f=[],isLoading:b}=E({queryKey:["objectives",n],queryFn:()=>p.getObjectives(n),enabled:!!n}),{data:v}=E({queryKey:["profile",t],queryFn:()=>p.getProfile({userId:t}),enabled:!!t}),j=v?.ffn_iuf??null,C=d.useMemo(()=>{const y=new Date;return y.setDate(y.getDate()-360),y.toISOString().slice(0,10)},[]),{data:w=[]}=E({queryKey:["swimmer-performances-recent",j],queryFn:()=>p.getSwimmerPerformances({iuf:j,fromDate:C}),enabled:!!j}),h=()=>{l(null),i(!0)},S=y=>{l(y),i(!0)},k=m,q=!!n&&!m;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(M,{variant:"outline",size:"sm",onClick:h,disabled:!n,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter un objectif"]})}),k&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},y))}),q&&b&&e.jsx("div",{className:"space-y-2",children:[1,2].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},y))}),q&&!b&&f.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(qe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif dÃ©fini pour ",s,"."]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:h,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),"CrÃ©er le premier objectif"]})]}),q&&!b&&f.length>0&&e.jsxs("div",{className:"space-y-2",children:[f.map(y=>e.jsx(Gt,{objective:y,performances:w,onEdit:S},y.id)),e.jsx("p",{className:"text-[10px] text-muted-foreground/60 italic text-center pt-1",children:"Les temps Â« Actuel Â» correspondent Ã  la meilleure performance des 360 derniers jours sur l'Ã©preuve."})]}),n&&e.jsx(Ut,{open:a,onOpenChange:i,objective:c,athleteName:s,athleteAuthId:n,competitions:_})]})},Oe="__today__";function Le(t,s){const a=[],i=new Date(t+"T00:00:00"),c=new Date(s+"T00:00:00"),l=new Date(i),n=l.getDay(),m=n===0?1:n===1?0:8-n;for(l.setDate(l.getDate()+m);l<=c;)a.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return a}function oe(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function ke(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Jt(t){const s=new Date(t+"T00:00:00");return s.setDate(s.getDate()+6),s.toISOString().split("T")[0]}function Xt(t){const s=new Date;s.setHours(0,0,0,0);const a=new Date(t+"T00:00:00"),i=new Date(t+"T00:00:00");return i.setDate(i.getDate()+6),s>=a&&s<=i}const Yt=({athleteId:t})=>{const{toast:s}=be(),a=ye(),[i,c]=d.useState(null),[l,n]=d.useState(null),[m,_]=d.useState(""),[f,b]=d.useState(""),[v,j]=d.useState(!1),[C,w]=d.useState(!1),[h,S]=d.useState(!1),[k,q]=d.useState(""),[y,K]=d.useState(""),[L,$]=d.useState(""),{data:u=[]}=E({queryKey:["athletes"],queryFn:()=>p.getAthletes()}),x=d.useMemo(()=>u.find(D=>D.id===t)?.group_id??null,[u,t]),{data:g=[],isLoading:P}=E({queryKey:["training-cycles","athlete",t],queryFn:()=>p.getTrainingCycles({athleteId:t})}),{data:W=[],isLoading:I}=E({queryKey:["training-cycles","group",x],queryFn:()=>p.getTrainingCycles({groupId:x}),enabled:x!=null}),O=g.length===0&&W.length>0,N=g.length>0?g:W;d.useEffect(()=>{N.length>0&&(!i||!N.find(r=>r.id===i))&&c(N[0].id)},[N,i]);const o=N.find(r=>r.id===i)??null,{data:F=[],isLoading:T}=E({queryKey:["training-weeks",i],queryFn:()=>p.getTrainingWeeks(i),enabled:!!i}),{data:A=[]}=E({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),le=d.useMemo(()=>[...A].sort((r,D)=>r.date.localeCompare(D.date)),[A]),U=d.useMemo(()=>{const r=new Set;return F.forEach(D=>{D.week_type&&r.add(D.week_type)}),Array.from(r).sort()},[F]),X=o?.start_competition_date??o?.start_date??null,Ne=d.useMemo(()=>{if(!o)return[];const r=X,D=o.end_competition_date;return!r||!D?[]:Le(r,D)},[o,X]),ve=d.useMemo(()=>{const r=new Map;return F.forEach(D=>r.set(D.week_start,D)),r},[F]),_e=P||I,Z=z({mutationFn:async r=>{const D=await p.createTrainingCycle(r),B=r.start_date??A.find(G=>G.id===r.start_competition_id)?.date,V=A.find(G=>G.id===r.end_competition_id);if(B&&V){const G=Le(B,V.date);G.length>0&&await p.bulkUpsertTrainingWeeks(G.map(ce=>({cycle_id:D.id,week_start:ce})))}return D},onSuccess:r=>{s({title:"Cycle cree"}),c(r.id),j(!1),q(""),K(""),$(""),a.invalidateQueries({queryKey:["training-cycles"]}),a.invalidateQueries({queryKey:["training-weeks",r.id]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),ee=z({mutationFn:r=>p.deleteTrainingCycle(r),onSuccess:()=>{s({title:"Cycle supprime"}),c(null),w(!1),a.invalidateQueries({queryKey:["training-cycles"]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),Re=z({mutationFn:r=>p.upsertTrainingWeek(r),onSuccess:()=>{n(null),a.invalidateQueries({queryKey:["training-weeks",i]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),Ie=z({mutationFn:async()=>{for(const r of W){const D=await p.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:r.start_competition_id,end_competition_id:r.end_competition_id,name:r.name,notes:r.notes}),B=await p.getTrainingWeeks(r.id);B.length>0&&await p.bulkUpsertTrainingWeeks(B.map(V=>({cycle_id:D.id,week_start:V.week_start,week_type:V.week_type,notes:V.notes})))}},onSuccess:()=>{s({title:"Planification personnalisee"}),S(!1),c(null),a.invalidateQueries({queryKey:["training-cycles"]})},onError:r=>{s({title:"Erreur",description:r.message,variant:"destructive"})}}),ze=()=>{if(!k.trim()){s({title:"Nom requis",variant:"destructive"});return}if(!y||!L){s({title:"Dates requises",description:"Selectionnez le debut et la fin du cycle.",variant:"destructive"});return}const r=y===Oe,D=r?Me(new Date):null,B=r?null:A.find(ce=>ce.id===y),V=A.find(ce=>ce.id===L),G=r?D:B?.date;if(G&&V&&V.date<=G){s({title:"Dates invalides",description:"La competition de fin doit etre apres la date de debut.",variant:"destructive"});return}Z.mutate({athlete_id:t,group_id:null,start_competition_id:r?null:y,end_competition_id:L,start_date:D,name:k.trim()})},ht=r=>{n(r.id),_(r.week_type??""),b(r.notes??"")},gt=r=>{n(`new:${r}`),_(""),b("")},ft=(r,D)=>{i&&Re.mutate({cycle_id:i,week_start:r,week_type:m.trim()||null,notes:f.trim()||null})},jt=()=>{n(null)};return!_e&&N.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(pt,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun cycle de planification."}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>j(!0),children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau cycle"]}),e.jsx(Ue,{open:v,onOpenChange:j,competitions:le,name:k,setName:q,startId:y,setStartId:K,endId:L,setEndId:$,onSubmit:ze,isPending:Z.isPending})]}):_e?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(r=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-48 rounded bg-muted"})},r))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[N.length>1?e.jsxs(te,{value:i??"",onValueChange:c,children:[e.jsx(se,{className:"w-auto min-w-[180px] h-8 text-sm",children:e.jsx(ae,{placeholder:"Choisir un cycle"})}),e.jsx(ne,{children:N.map(r=>e.jsx(J,{value:r.id,children:r.name},r.id))})]}):o?e.jsx("span",{className:"text-sm font-semibold",children:o.name}):null,O&&e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Planif. groupe"}),e.jsx("div",{className:"flex-1"}),O&&e.jsxs(M,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>S(!0),children:[e.jsx(At,{className:"mr-1 h-3 w-3"}),"Personnaliser"]}),e.jsxs(M,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>j(!0),children:[e.jsx(ie,{className:"mr-1 h-3 w-3"}),"Nouveau"]}),o&&!O&&e.jsx(M,{variant:"ghost",size:"sm",className:"text-xs h-7 text-destructive hover:text-destructive",onClick:()=>w(!0),children:e.jsx(We,{className:"h-3 w-3"})})]}),o&&e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:o.start_competition_id?"ðŸŠ":"ðŸ“…"}),e.jsx("span",{className:"text-sm font-medium",children:o.start_competition_id?o.start_competition_name??"Competition":"Debut du cycle"}),X&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",oe(X),")"]})]}),e.jsx("div",{className:"relative ml-3 border-l-2 border-border pl-4 space-y-1",children:T?e.jsx("div",{className:"py-4",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"})}):Ne.map((r,D)=>{const B=ve.get(r),V=Xt(r),G=l===(B?.id??`new:${r}`);return e.jsx(Zt,{monday:r,weekNumber:D+1,week:B,isCurrent:V,isEditing:G,isGroupPlan:O,editWeekType:m,setEditWeekType:_,editWeekNotes:f,setEditWeekNotes:b,existingWeekTypes:U,onStartEdit:()=>B?ht(B):gt(r),onSave:()=>ft(r),onCancel:jt,isSaving:Re.isPending},r)})}),e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:"ðŸŽ¯"}),e.jsx("span",{className:"text-sm font-medium",children:o.end_competition_name??"Competition"}),o.end_competition_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",oe(o.end_competition_date),")"]})]})]}),e.jsx(Ue,{open:v,onOpenChange:j,competitions:le,name:k,setName:q,startId:y,setStartId:K,endId:L,setEndId:$,onSubmit:ze,isPending:Z.isPending}),e.jsx(de,{open:C,onOpenChange:w,children:e.jsxs(me,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"Supprimer le cycle"}),e.jsx(pe,{children:"Cette action est irreversible. Le cycle et toutes ses semaines seront supprimes."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>i&&ee.mutate(i),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(de,{open:h,onOpenChange:S,children:e.jsxs(me,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"Personnaliser la planification"}),e.jsx(pe,{children:"Les cycles du groupe seront copies en tant que planification individuelle pour ce nageur. Vous pourrez ensuite les modifier independamment."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>Ie.mutate(),children:Ie.isPending?"Copie...":"Personnaliser"})]})]})})]})},Zt=({monday:t,weekNumber:s,week:a,isCurrent:i,isEditing:c,isGroupPlan:l,editWeekType:n,setEditWeekType:m,editWeekNotes:_,setEditWeekNotes:f,existingWeekTypes:b,onStartEdit:v,onSave:j,onCancel:C,isSaving:w})=>{const h=Jt(t),S=`week-types-${t}`;return c?e.jsxs("div",{className:`rounded-lg border bg-card p-3 space-y-2 ${i?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground",children:["Sem. ",s," (",ke(t)," - ",ke(h),")"]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Q,{className:"text-xs",children:"Type de semaine"}),e.jsx(Ee,{className:"h-7 text-sm",placeholder:"Ex : Foncier, Affutage, Recup...",list:S,value:n,onChange:k=>m(k.target.value)}),e.jsx("datalist",{id:S,children:b.map(k=>e.jsx("option",{value:k},k))})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Q,{className:"text-xs",children:"Notes"}),e.jsx(Ke,{className:"text-sm min-h-[48px]",placeholder:"Notes optionnelles...",rows:2,value:_,onChange:k=>f(k.target.value)})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(M,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:C,children:[e.jsx(Nt,{className:"mr-1 h-3 w-3"}),"Annuler"]}),e.jsxs(M,{size:"sm",className:"h-7 text-xs",onClick:j,disabled:w,children:[e.jsx(Pt,{className:"mr-1 h-3 w-3"}),w?"...":"Enregistrer"]})]})]}):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-3 py-2 flex items-center gap-2 transition-colors ${l?"cursor-default":"hover:bg-muted/50"} ${i?"ring-2 ring-primary":""}`,onClick:l?void 0:v,disabled:l,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-xs font-medium text-muted-foreground whitespace-nowrap",children:["Sem. ",s]}),e.jsxs("span",{className:"text-[10px] text-muted-foreground/70 whitespace-nowrap",children:["(",ke(t)," - ",ke(h),")"]}),a?.week_type&&e.jsx(R,{className:"text-[10px] px-1.5 py-0 border-0",style:{backgroundColor:mt(a.week_type),color:dt(a.week_type)},children:a.week_type})]}),a?.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:a.notes})]}),!l&&e.jsx(Mt,{className:"h-3 w-3 text-muted-foreground/40 shrink-0"})]})},Ue=({open:t,onOpenChange:s,competitions:a,name:i,setName:c,startId:l,setStartId:n,endId:m,setEndId:_,onSubmit:f,isPending:b})=>(d.useEffect(()=>{t&&(c(""),n(""),_(""))},[t]),e.jsx(tt,{open:t,onOpenChange:s,children:e.jsxs(st,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(at,{children:e.jsx(nt,{children:"Nouveau cycle"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Nom du cycle *"}),e.jsx(Ee,{placeholder:"Ex : Preparation hiver",value:i,onChange:v=>c(v.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Date de debut *"}),e.jsxs(te,{value:l,onValueChange:n,children:[e.jsx(se,{children:e.jsx(ae,{placeholder:"Choisir..."})}),e.jsxs(ne,{children:[e.jsxs(J,{value:Oe,children:["Aujourd'hui (",oe(Me(new Date)),")"]}),a.map(v=>e.jsxs(J,{value:v.id,children:[v.name," (",oe(v.date),")"]},v.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Competition de fin *"}),e.jsxs(te,{value:m,onValueChange:_,children:[e.jsx(se,{children:e.jsx(ae,{placeholder:"Choisir..."})}),e.jsx(ne,{children:a.map(v=>e.jsxs(J,{value:v.id,children:[v.name," (",oe(v.date),")"]},v.id))})]})]}),l&&m&&(()=>{const j=l===Oe?Me(new Date):a.find(w=>w.id===l)?.date,C=a.find(w=>w.id===m);if(j&&C&&C.date>j){const w=Le(j,C.date).length;return e.jsxs("p",{className:"text-xs text-muted-foreground",children:[w," semaine",w>1?"s":""," seront generees."]})}return null})(),e.jsx(M,{className:"w-full",onClick:f,disabled:b,children:b?"Creation...":"Creer le cycle"})]})]})}));function re(t){return new Date(t+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Se(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function es(t){const s=new Date(t+"T00:00:00");return s.setDate(s.getDate()+6),s.toISOString().split("T")[0]}function ts(t){const s=new Date;s.setHours(0,0,0,0);const a=new Date(t+"T00:00:00"),i=new Date(t+"T00:00:00");return i.setDate(i.getDate()+6),s>=a&&s<=i}function Pe(t,s){const a=[],i=new Date(t+"T00:00:00"),c=new Date(s+"T00:00:00"),l=new Date(i),n=l.getDay(),m=n===0?1:n===1?0:8-n;for(l.setDate(l.getDate()+m);l<=c;)a.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return a}function Ve(t,s){const a=new Date(t+"T00:00:00"),i=new Date(s+"T00:00:00");return Math.round((i.getTime()-a.getTime())/(1e3*60*60*24))}const ss={draft_athlete:{label:"En attente nageur",variant:"secondary",className:"bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300 border-amber-200 dark:border-amber-800"},draft_coach:{label:"PrÃ©paration coach",variant:"secondary",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800"},sent:{label:"EnvoyÃ©",variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300 border-green-200 dark:border-green-800"},signed:{label:"SignÃ©",variant:"secondary",className:"bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-300 border-slate-200 dark:border-slate-700"}};function as(t){const s=ss[t];return e.jsx(R,{variant:s.variant,className:`text-[10px] px-1.5 py-0 ${s.className}`,children:s.label})}async function ns(t){const{data:s,error:a}=await Ze.rpc("get_auth_uid_for_user",{p_user_id:t});return a?(console.error("[interviews-tab] Failed to resolve auth UUID:",a.message),null):s}const Y=({label:t,text:s})=>e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(vt,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),Te=({label:t,text:s})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ut,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),De=({label:t,value:s,onChange:a,onBlur:i,placeholder:c,rows:l=3})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ut,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx(Ke,{className:"bg-white dark:bg-background",placeholder:c,value:s,onChange:n=>a(n.target.value),onBlur:i,rows:l})]}),H=({label:t})=>e.jsxs("div",{className:"flex items-center gap-2 pt-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),Ge=({objective:t,performances:s=[]})=>{const a=!!t.event_code,i=!!t.text,c=a?rt(t.event_code):null,l=c?ct[c]??"":"",n=a?it(s,t.event_code,t.pool_length):null;let m=null;return n&&t.target_time_seconds!=null&&t.event_code&&(m=n.time-t.target_time_seconds,lt(n.time,t.target_time_seconds,t.event_code)),e.jsxs("div",{className:`rounded-lg border bg-card p-2.5 text-sm space-y-1 ${a?`border-l-4 ${l}`:""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(qe,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:a?$e(t.event_code):""}),t.pool_length&&e.jsxs(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[t.pool_length,"m"]}),t.target_time_seconds!=null&&e.jsx(R,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:je(t.target_time_seconds)})]}),i&&e.jsx("p",{className:"text-muted-foreground line-clamp-2 pl-5",children:t.text}),n&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:je(n.time)})]}),n.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",re(n.date),")"]}),m!=null&&e.jsx("span",{className:m<=0?"text-emerald-600 font-medium":"text-amber-600",children:m<=0?"Objectif atteint !":`+${m.toFixed(2)}s`})]}),!n&&a&&t.target_time_seconds!=null&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"})]})},He=({prevInterview:t,commitmentReview:s})=>{const[a,i]=d.useState(!1);return e.jsxs(Ot,{open:a,onOpenChange:i,children:[e.jsx(Lt,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Wt,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${a?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements prÃ©cÃ©dents"}),e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:re(t.date)})]})}),e.jsx(Kt,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[t.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Engagements nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t.athlete_commitments})]}),t.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t.coach_actions})]}),s&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Bilan du nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s})]})]})})]})},Je=({athleteId:t,interviewDate:s})=>{const{toast:a}=be(),i=ye(),{data:c=[]}=E({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),{data:l=[]}=E({queryKey:["my-competition-ids",t],queryFn:()=>p.getMyCompetitionIds(t)}),n=d.useMemo(()=>{const u=new Set(l);return c.filter(x=>u.has(x.id)).sort((x,g)=>x.date.localeCompare(g.date))},[c,l]),m=d.useMemo(()=>n.filter(u=>u.date>=s),[n,s]),{data:_=[]}=E({queryKey:["training-cycles","athlete",t],queryFn:()=>p.getTrainingCycles({athleteId:t})}),f=d.useMemo(()=>{const u=new Map;return _.slice().sort((x,g)=>(x.end_competition_date??"").localeCompare(g.end_competition_date??"")).forEach(x=>{x.end_competition_id&&!u.has(x.end_competition_id)&&u.set(x.end_competition_id,x)}),u},[_]),b=d.useMemo(()=>{const u=new Set;return m.map(x=>f.get(x.id)??null).filter(x=>!x||u.has(x.id)?!1:(u.add(x.id),!0))},[m,f]),v=yt({queries:b.map(u=>({queryKey:["training-weeks",u.id],queryFn:()=>p.getTrainingWeeks(u.id),enabled:!!u.id}))}),[j,C]=d.useState(null),[w,h]=d.useState(""),S=d.useMemo(()=>{const u=new Map;return b.forEach((x,g)=>{u.set(x.id,v[g]?.data??[])}),u},[b,v]),k=d.useMemo(()=>{const u=new Set;return S.forEach(x=>{x.forEach(g=>{g.week_type&&u.add(g.week_type)})}),Array.from(u).sort()},[S]),q=m[0]??null,y=d.useMemo(()=>new Date().toISOString().split("T")[0],[]),K=q?Ve(y,q.date):null,L=z({mutationFn:async u=>{const x=n.find(N=>N.id===u);if(!x)throw new Error("Pas de compÃ©tition");const g=n.findIndex(N=>N.id===u),P=g>0?n[g-1]:null,W=P?.date??s,I=await p.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:P?.id??null,start_date:P?null:s,end_competition_id:x.id,name:`PrÃ©paration ${x.name}`}),O=Pe(W,x.date);return O.length>0&&await p.bulkUpsertTrainingWeeks(O.map(N=>({cycle_id:I.id,week_start:N}))),I},onSuccess:()=>{a({title:"Planification crÃ©Ã©e"}),i.invalidateQueries({queryKey:["training-cycles"]}),i.invalidateQueries({queryKey:["training-weeks"]})},onError:u=>{a({title:"Erreur",description:u.message,variant:"destructive"})}}),$=z({mutationFn:u=>p.upsertTrainingWeek(u),onSuccess:()=>{C(null),i.invalidateQueries({queryKey:["training-weeks"]})},onError:u=>{a({title:"Erreur",description:u.message,variant:"destructive"})}});return q?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(_t,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsxs("span",{className:"font-medium",children:[m.length," Ã©chÃ©ance",m.length>1?"s":""," Ã  planifier"]}),K!=null&&e.jsxs(R,{variant:"secondary",className:"text-[10px]",children:["prochaine J-",K]})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Une carte par compÃ©tition cible pour construire et piloter plusieurs macrocycles Ã  l'avance."})]}),e.jsx("div",{className:"space-y-3",children:m.map((u,x)=>{const g=f.get(u.id)??null,P=g?S.get(g.id)??[]:[],W=new Map(P.map(A=>[A.week_start,A])),I=g?.start_date??g?.start_competition_date??s,O=I>s?I:s,N=g?Pe(O,u.date):[],o=g?Pe(I,u.date):[],F=Math.max(o.length-N.length,0),T=Ve(y,u.date);return e.jsxs("div",{className:"rounded-xl border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border bg-muted/20 px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:u.name}),x===0&&e.jsx(R,{className:"text-[10px] bg-primary/10 text-primary border-primary/20",children:"PrioritÃ©"}),e.jsx(R,{variant:"secondary",className:"text-[10px]",children:re(u.date)}),e.jsxs(R,{variant:"outline",className:"text-[10px]",children:["J-",T]})]}),g?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:g.name}),g.start_competition_name&&e.jsxs("span",{children:["depuis ",g.start_competition_name]}),e.jsxs("span",{children:[o.length," sem."]}),F>0&&e.jsxs("span",{children:[F," dÃ©jÃ  passÃ©es"]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Aucun macrocycle crÃ©Ã© pour cette Ã©chÃ©ance."})]}),g?N.length===0?e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"Aucune semaine future Ã  afficher sur ce macrocycle."}):e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1.5",children:N.map((A,le)=>{const U=W.get(A),X=ts(A),Ne=es(A),ve=`${g.id}:${A}`,_e=j===ve,Z=`inline-week-${g.id}-${A}`;return _e?e.jsxs("div",{className:`rounded-lg border bg-card p-2 space-y-1.5 ${X?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Sem. ",F+le+1," (",Se(A)," - ",Se(Ne),")"]}),e.jsx(Ee,{className:"h-7 text-sm",placeholder:"Foncier, Techni., AffÃ»tage...",list:Z,value:w,onChange:ee=>h(ee.target.value)}),e.jsx("datalist",{id:Z,children:k.map(ee=>e.jsx("option",{value:ee},ee))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(M,{variant:"ghost",size:"sm",className:"h-6 text-xs px-2",onClick:()=>C(null),children:"Annuler"}),e.jsx(M,{size:"sm",className:"h-6 text-xs px-2",onClick:()=>{$.mutate({cycle_id:g.id,week_start:A,week_type:w.trim()||null,notes:U?.notes??null})},disabled:$.isPending,children:"OK"})]})]},A):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-2.5 py-2 text-xs transition-colors hover:bg-muted/50 ${X?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>{C(ve),h(U?.week_type??"")},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${X?"bg-primary":U?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",F+le+1]}),e.jsxs("span",{className:"text-muted-foreground/70 whitespace-nowrap",children:[Se(A)," - ",Se(Ne)]}),U?.week_type&&e.jsx(R,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:mt(U.week_type),color:dt(U.week_type)},children:U.week_type})]}),U?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:U.notes})]},A)})})}):e.jsxs("div",{className:"px-3 py-3 space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"CrÃ©ez un macrocycle dÃ©diÃ© pour donner de la visibilitÃ© long terme sur cette cible."}),e.jsx(M,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:()=>L.mutate(u.id),disabled:L.isPending,children:L.isPending?"CrÃ©ation...":"CrÃ©er ce macrocycle"})]})]},u.id)})})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"Aucune compÃ©tition assignÃ©e Ã  venir â€” planification non disponible."})})},rs=({interview:t,athleteId:s,objectives:a,performances:i})=>{const{toast:c}=be(),l=ye(),[n,m]=d.useState(t.status!=="signed"),[_,f]=d.useState(t.coach_comment_successes??""),[b,v]=d.useState(t.coach_comment_difficulties??""),[j,C]=d.useState(t.coach_comment_goals??""),w=t.coach_review??"",h=t.coach_objectives??"",[S,k]=d.useState(t.coach_actions??""),[q,y]=d.useState(!1),[K,L]=d.useState(!1),$=d.useRef(!1),{data:u}=E({queryKey:["previous-interview",s,t.date,t.id],queryFn:()=>p.getPreviousInterview(s,t.date,t.id),enabled:!!t.date}),x=d.useCallback(()=>({coach_comment_successes:_.trim()||null,coach_comment_difficulties:b.trim()||null,coach_comment_goals:j.trim()||null,coach_review:w.trim()||null,coach_objectives:h.trim()||null,coach_actions:S.trim()||null}),[S,b,j,_,h,w]),g=d.useCallback(()=>{const T=x();return(t.coach_comment_successes??null)!==T.coach_comment_successes||(t.coach_comment_difficulties??null)!==T.coach_comment_difficulties||(t.coach_comment_goals??null)!==T.coach_comment_goals||(t.coach_review??null)!==T.coach_review||(t.coach_objectives??null)!==T.coach_objectives||(t.coach_actions??null)!==T.coach_actions},[x,t]),P=z({mutationFn:T=>p.updateInterviewCoachSections(t.id,T),onSuccess:()=>{l.invalidateQueries({queryKey:["interviews",s]})},onError:T=>{c({title:"Erreur",description:T.message,variant:"destructive"})}}),W=z({mutationFn:async()=>(await p.updateInterviewCoachSections(t.id,x()),p.sendInterviewToAthlete(t.id)),onSuccess:()=>{c({title:"Entretien envoyÃ© au nageur"}),l.invalidateQueries({queryKey:["interviews",s]})},onError:T=>{c({title:"Erreur",description:T.message,variant:"destructive"})}}),I=z({mutationFn:()=>p.deleteInterview(t.id),onSuccess:()=>{c({title:"Entretien supprimÃ©"}),l.invalidateQueries({queryKey:["interviews",s]})},onError:T=>{c({title:"Erreur",description:T.message,variant:"destructive"})}}),O=P.isPending||W.isPending||I.isPending,N=t.status,o=N==="draft_athlete"?"border-amber-300 dark:border-amber-700 border-l-4":N==="draft_coach"?"border-blue-300 dark:border-blue-700 border-l-4":N==="sent"?"border-emerald-300 dark:border-emerald-700 border-l-4":"",F=d.useCallback(()=>{N!=="draft_coach"||$.current||O||!g()||($.current=!0,P.mutate(x()),window.setTimeout(()=>{$.current=!1},500))},[x,g,O,P,N]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${o}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>m(T=>!T),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:re(t.date)}),as(N),N==="signed"&&t.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",re(t.signed_at.slice(0,10))]})]}),n?e.jsx($t,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(et,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),n&&e.jsxs("div",{className:"px-4 pb-4 space-y-5",children:[N==="draft_athlete"&&e.jsxs("div",{className:"rounded-xl border border-dashed border-amber-300 bg-amber-50/50 dark:bg-amber-950/20 p-6 text-center space-y-2",children:[e.jsx(xt,{className:"h-8 w-8 mx-auto text-amber-500"}),e.jsx("p",{className:"text-sm font-medium",children:"En attente de la prÃ©paration du nageur"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Le contenu n'est pas encore visible. Le nageur doit d'abord remplir ses sections."})]}),N==="draft_coach"&&e.jsxs(e.Fragment,{children:[u&&e.jsx(He,{prevInterview:u,commitmentReview:t.athlete_commitment_review}),e.jsx(H,{label:"RÃ©ussites"}),e.jsx(Y,{label:"Nageur",text:t.athlete_successes}),e.jsx(De,{label:"Coach",value:_,onChange:f,onBlur:F,placeholder:"Votre commentaire sur les rÃ©ussites..."}),e.jsx(H,{label:"DifficultÃ©s"}),e.jsx(Y,{label:"Nageur",text:t.athlete_difficulties}),e.jsx(De,{label:"Coach",value:b,onChange:v,onBlur:F,placeholder:"Votre commentaire sur les difficultÃ©s..."}),e.jsx(H,{label:"Objectifs"}),a.length>0&&e.jsx("div",{className:"space-y-1.5",children:a.map(T=>e.jsx(Ge,{objective:T,performances:i},T.id))}),e.jsx(Y,{label:"Nageur",text:t.athlete_goals}),e.jsx(De,{label:"Coach",value:j,onChange:C,onBlur:F,placeholder:"Objectifs complÃ©mentaires, commentaires..."}),e.jsx(H,{label:"Planification"}),e.jsx(Je,{athleteId:s,interviewDate:t.date}),e.jsx(H,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(Y,{label:"Engagements du nageur",text:t.athlete_commitments}),e.jsx(De,{label:"Actions du coach",value:S,onChange:k,onBlur:F,placeholder:"Actions concrÃ¨tes, points de suivi..."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:P.isPending?"Sauvegarde...":"Sauvegarde automatique a la sortie d'un champ."})]}),(N==="sent"||N==="signed")&&e.jsxs(e.Fragment,{children:[u&&e.jsx(He,{prevInterview:u,commitmentReview:t.athlete_commitment_review}),e.jsx(H,{label:"RÃ©ussites"}),e.jsx(Y,{label:"Nageur",text:t.athlete_successes}),e.jsx(Te,{label:"Coach",text:t.coach_comment_successes||t.coach_review}),e.jsx(H,{label:"DifficultÃ©s"}),e.jsx(Y,{label:"Nageur",text:t.athlete_difficulties}),e.jsx(Te,{label:"Coach",text:t.coach_comment_difficulties}),e.jsx(H,{label:"Objectifs"}),a.length>0&&e.jsx("div",{className:"space-y-1.5",children:a.map(T=>e.jsx(Ge,{objective:T,performances:i},T.id))}),e.jsx(Y,{label:"Nageur",text:t.athlete_goals}),e.jsx(Te,{label:"Coach",text:t.coach_comment_goals||t.coach_objectives}),e.jsx(H,{label:"Planification"}),e.jsx(Je,{athleteId:s,interviewDate:t.date}),e.jsx(H,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(Y,{label:"Engagements du nageur",text:t.athlete_commitments}),e.jsx(Te,{label:"Actions du coach",text:t.coach_actions})]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[N==="draft_coach"&&e.jsxs(M,{className:"w-full",onClick:()=>L(!0),disabled:O,children:[e.jsx(Qe,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer au nageur"]}),e.jsxs(M,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>y(!0),disabled:O,children:[e.jsx(We,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})]})]}),e.jsx(de,{open:q,onOpenChange:y,children:e.jsxs(me,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"Supprimer l'entretien"}),e.jsxs(pe,{children:["Cette action est irrÃ©versible. L'entretien du ",t.date?re(t.date):""," sera supprimÃ© dÃ©finitivement."]})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>{I.mutate(),y(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(de,{open:K,onOpenChange:L,children:e.jsxs(me,{children:[e.jsxs(ue,{children:[e.jsx(xe,{children:"Envoyer au nageur"}),e.jsx(pe,{children:"L'entretien sera envoyÃ© au nageur pour consultation. Les sections coach seront enregistrÃ©es automatiquement."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsxs(fe,{onClick:()=>{W.mutate(),L(!1)},children:[e.jsx(Qe,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer"]})]})]})})]})},is=({athleteId:t,athleteName:s})=>{const{toast:a}=be(),i=ye(),{data:c}=E({queryKey:["auth-uid",t],queryFn:()=>ns(t),enabled:!!t}),{data:l=[]}=E({queryKey:["objectives",c],queryFn:()=>p.getObjectives(c),enabled:!!c}),{data:n}=E({queryKey:["athlete-profile",t],queryFn:()=>p.getProfile({userId:t}),enabled:!!t}),m=n?.ffn_iuf??null,_=d.useMemo(()=>{const C=new Date;return C.setDate(C.getDate()-360),C.toISOString().slice(0,10)},[]),{data:f=[]}=E({queryKey:["swimmer-performances-recent",m],queryFn:()=>p.getSwimmerPerformances({iuf:m,fromDate:_}),enabled:!!m}),{data:b=[],isLoading:v}=E({queryKey:["interviews",t],queryFn:()=>p.getInterviews(t),enabled:!!t}),j=z({mutationFn:()=>p.createInterview({athlete_id:t}),onSuccess:()=>{a({title:"Entretien crÃ©Ã©"}),i.invalidateQueries({queryKey:["interviews",t]})},onError:C=>{a({title:"Erreur",description:C.message,variant:"destructive"})}});return v?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(C=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-24 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-20 rounded bg-muted"})]})},C))}):b.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ot,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun entretien pour ",s,"."]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>j.mutate(),disabled:j.isPending,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),j.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Entretiens"}),e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:b.length})]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>j.mutate(),disabled:j.isPending,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),j.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}),e.jsx("div",{className:"space-y-2",children:b.map(C=>e.jsx(rs,{interview:C,athleteId:t,objectives:l,performances:f},C.id))})]})};function Ks(){const[,t]=Ct("/coach/swimmer/:id"),[,s]=Xe(),{selectedAthleteId:a,selectedAthleteName:i}=Ye(),c=t?.id?Number(t.id):a,l=i,{data:n}=E({queryKey:["profile",c],queryFn:()=>p.getProfile({userId:c}),enabled:c!=null}),m=n?.display_name??l??"Nageur",_=n?.avatar_url??null,f=n?.group_label??null;return c?e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>s("/coach?section=swimmers"),className:"h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition","aria-label":"Retour",children:e.jsx(Ft,{className:"h-4 w-4"})}),_?e.jsx("img",{src:_,alt:"",className:"h-10 w-10 rounded-full object-cover border border-border"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary",children:m.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-lg font-bold truncate",children:m}),f&&e.jsx(R,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:f})]})]}),e.jsxs(wt,{defaultValue:"ressentis",children:[e.jsxs(kt,{className:"w-full grid grid-cols-4",children:[e.jsxs(Ce,{value:"ressentis",className:"text-xs gap-1",children:[e.jsx(xt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(Ce,{value:"objectifs",className:"text-xs gap-1",children:[e.jsx(qe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Objectifs"})]}),e.jsxs(Ce,{value:"planification",className:"text-xs gap-1",children:[e.jsx(pt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Planif."})]}),e.jsxs(Ce,{value:"entretiens",className:"text-xs gap-1",children:[e.jsx(ot,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]})]}),e.jsx(we,{value:"ressentis",className:"mt-4",children:e.jsx(Bt,{athleteId:c,athleteName:m})}),e.jsx(we,{value:"objectifs",className:"mt-4",children:e.jsx(Ht,{athleteId:c,athleteName:m})}),e.jsx(we,{value:"planification",className:"mt-4",children:e.jsx(Yt,{athleteId:c})}),e.jsx(we,{value:"entretiens",className:"mt-4",children:e.jsx(is,{athleteId:c,athleteName:m})})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx("p",{children:"Aucun nageur sÃ©lectionnÃ©."}),e.jsx("button",{type:"button",onClick:()=>s("/coach?section=swimmers"),className:"mt-2 text-primary underline",children:"Retour au dashboard"})]})}export{Ks as default};
