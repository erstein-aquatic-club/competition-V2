import{r as l,j as e,c as Ct,u as Ne,d as ge,R as Ae}from"./vendor-query-DyA9aSKS.js";import{c as Jt}from"./date-DrpgLmFD.js";import{a as H}from"./api-DgHNrwix.js";import{c as je,b as Ut,W as At,X as st,F as Ft,P as Be,u as ot,d as Vt,s as Ve,B as nt,T as Yt}from"./index-DEw8lXrn.js";import{D as at,a as lt,b as ct,c as dt}from"./dialog-C48qdOKD.js";import{M as Wt,C as Xt,a as Gt}from"./CalendarGrid-B_75sQFO.js";import{B as Zt}from"./BottomActionBar-BBWLxL3n.js";import{a as es,s as ts,l as ut}from"./animations-CrcLFysI.js";import{d as mt}from"./design-tokens-CKgCpdH6.js";import{C as Ot}from"./chevron-right-CWRkl4DF.js";import{A as Le,m as be}from"./vendor-motion-CMsaQ8FX.js";import{P as ss}from"./power-BjNqul_f.js";import{C as ns}from"./chevron-down-3Nhh0smy.js";import{C as rt}from"./check-BRJSkYfr.js";import{C as Ye}from"./circle-D3dPuDUX.js";import{T as $e}from"./trash-2-C5Nr309v.js";import{A as xt,S as rs,H as pt,f as We,p as is}from"./SwimTimeInput-Vdc1ANyy.js";import{T as ft}from"./timer-CTzMZnjF.js";import{P as os}from"./pencil-kV063e-3.js";import{I as as}from"./InlineBanner-mxHriW89.js";import{C as ls}from"./circle-alert-Di0VRNg9.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-date-B8Mnp-Vt.js";import"./swim-BadMaWRd.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-Mlw1bK_H.js";import"./index-BE3EncBH.js";import"./chevron-left-CtHJ-HcN.js";import"./loader-circle-CAJbOCrz.js";import"./circle-check-D3Pv0KIL.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],ds=je("info",cs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=[["path",{d:"M5 12h14",key:"1ays0h"}]],It=je("minus",us);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],xs=je("settings-2",ms);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],fs=je("sun",ps);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bs=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],bt=je("user-check",bs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Pe=je("user-x",gs),Xe={NL:"",DOS:"",BR:"",PAP:"",QN:""};function gt(t){return String(t).padStart(2,"0")}function ht(t){return`${t.getFullYear()}-${gt(t.getMonth()+1)}-${gt(t.getDate())}`}function yt(t){return new Date(t.getFullYear(),t.getMonth(),1)}function Nt(t,n){const i=new Date(t);return i.setDate(i.getDate()+n),i}function Ge(t){return(t.getDay()+6)%7}function Fe(t){const n=Number(t);return Number.isFinite(n)?Math.round(n/1e3*100)/100:0}function hs(t){const n=Number(t);return Number.isFinite(n)?Math.round(n*1e3):0}function ys(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(i=>i.trim()).filter(Boolean).flatMap(i=>{const r=i.replace(/^[•\\-–—]\\s*/,"").trim();return r?[r]:[]}):[]}function Ns(t){if(!t)return null;const i=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!i)return null;const r=Number(String(i[1]).replace(",","."));return Number.isFinite(r)?i[2].toLowerCase()==="m"?Fe(r):r:null}function js(t,n){const i=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,r=String(i||"").toLowerCase();if(r.includes("mat")||r.includes("morning")||r==="am")return"AM";if(r.includes("soir")||r.includes("evening")||r==="pm")return"PM";const f=`${t?.title??""} ${t?.description??""}`.toLowerCase();return f.includes("matin")||f.includes(" am ")||f.includes("(am)")?"AM":f.includes("soir")||f.includes(" pm ")||f.includes("(pm)")?"PM":n===0?"AM":"PM"}function vs(t){const n=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!n)return null;const i=String(n),r=i.length>=10?i.slice(0,10):i;return/\d{4}-\d{2}-\d{2}/.test(r)?r:null}function ws(t){if(Array.isArray(t?.items)){let f=0;for(const x of t.items){const y=Number(x?.distance);if(!Number.isFinite(y)||y<=0)continue;const p=x?.raw_payload,v=Number(p?.exercise_repetitions),h=Number(p?.block_repetitions),k=Number.isFinite(v)&&v>0?v:1,_=Number.isFinite(h)&&h>0?h:1;f+=y*k*_}if(f>0)return Fe(f)}const n=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(n!=null&&Number.isFinite(Number(n))){const f=Number(n);return f>0&&f<=50?f:Fe(f)}const i=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(i!=null&&Number.isFinite(Number(i)))return Number(i);const r=Ns(`${t?.title??""} ${t?.description??""}`);return r??null}function ks(t){if(!Array.isArray(t)||t.length===0)return null;const n={crawl:"NL",dos:"DOS",brasse:"BR",pap:"PAP","4n":"QN"},i={NL:0,DOS:0,BR:0,PAP:0,QN:0};for(const f of t){const x=Number(f?.distance);if(!Number.isFinite(x)||x<=0)continue;const y=f?.raw_payload,p=Number(y?.exercise_repetitions),v=Number(y?.block_repetitions),h=Number.isFinite(p)&&p>0?p:1,k=Number.isFinite(v)&&v>0?v:1,_=x*h*k,U=y?.exercise_stroke??y?.stroke??"crawl",re=n[String(U).toLowerCase()];re?i[re]+=_:i.NL+=_}return Object.values(i).some(f=>f>0)?i:null}function jt(t){const n=Number(t);if(!Number.isFinite(n))return"—";const i=Math.round(n*100)/100,r=String(i);return r.endsWith(".0")?r.slice(0,-2):r}function Ss(){const t={};for(let n=0;n<7;n++)t[n]={AM:!0,PM:!0};return t}function Ze(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function Ms({sessions:t,assignments:n,userId:i,user:r}){const f=`swim-dashboard-v2:${i??r??"anon"}`,x=`${f}:presenceDefaults`,y=`${f}:attendanceOverrides`,p=`${f}:stableFields`,[v,h]=l.useState(()=>Ss()),[k,_]=l.useState({}),[U,re]=l.useState(90);l.useEffect(()=>{if(typeof window>"u")return;const a=Ze(window.localStorage.getItem(x));a&&h(a);const c=Ze(window.localStorage.getItem(y));c&&_(c);const u=Ze(window.localStorage.getItem(p));u?.duration&&Number.isFinite(u.duration)&&u.duration>=30&&u.duration<=240&&re(u.duration)},[x,y,p]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(x,JSON.stringify(v))},[v,x]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(y,JSON.stringify(k))},[k,y]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(p,JSON.stringify({duration:U}))},[U,p]);const ce=l.useMemo(()=>new Date,[]),[de,pe]=l.useState(()=>yt(new Date)),[V,ue]=l.useState(()=>ht(new Date)),[G,d]=l.useState(!1),[b,S]=l.useState(!1),[D,K]=l.useState(!1),[q,Z]=l.useState(null),[he,me]=l.useState(!1),[ve,O]=l.useState(null),[$,L]=l.useState(!1),[T,M]=l.useTransition(),I=l.useMemo(()=>(Array.isArray(n)?n:[]).filter(c=>c?.session_type==="swim"),[n]),J=l.useMemo(()=>{const a=new Map;for(const c of I){const u=vs(c);u&&(a.has(u)||a.set(u,[]),a.get(u).push(c))}for(const[c,u]of a.entries())u.sort((j,w)=>Number(j?.id??0)-Number(w?.id??0)),a.set(c,u);return a},[I]),R=l.useMemo(()=>{const a=Array.isArray(t)?t:[],c={};for(const u of a){const j=String(u?.date??"").slice(0,10),w=u?.slot==="Soir"?"PM":"AM";c[`${j}__${w}`]=u}return c},[t]),B=l.useRef(new Map);l.useEffect(()=>{B.current.clear()},[J]);const A=l.useCallback(a=>{const c=B.current;if(c.has(a))return c.get(a);const u=[{id:`${a}__AM`,iso:a,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${a}__PM`,iso:a,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],j=(J.get(a)??[]).slice().sort((g,F)=>(Number(F.id)||0)-(Number(g.id)||0)),w=new Set;return j.forEach((g,F)=>{const Q=g,ie=js(Q,F);if(w.has(ie))return;const z=ie==="AM"?0:1,ye=ws(Q),Qe=Array.isArray(Q?.details)?Q.details.map(String):ys(g?.description);u[z]={id:`${a}__${ie}`,iso:a,slotKey:ie,title:String(g?.title??"Séance coach"),km:ye,details:Qe,assignmentId:typeof g?.id=="number"?g.id:Number(g?.id)||void 0,isEmpty:!1},w.add(ie)}),c.set(a,u),u},[J]),Y=l.useCallback((a,c)=>{const u=Ge(c),j=!!v?.[u]?.[a.slotKey],w=k[a.id];return w==="present"?{status:"present",expected:!0,expectedByDefault:j}:w==="absent"?{status:"absent",expected:!0,expectedByDefault:j}:j?{status:"present",expected:!0,expectedByDefault:j}:{status:"not_expected",expected:!1,expectedByDefault:j}},[k,v]),W=l.useMemo(()=>yt(de),[de]),ee=l.useMemo(()=>{const a=Ge(W),c=Nt(W,-a),u=[];for(let j=0;j<42;j++)u.push(Nt(c,j));return u},[W]),te=l.useMemo(()=>{const a={};for(const c of ee){const u=ht(c),j=A(u);let w=0,g=0;const F=[];for(const Q of j){const ie=Y(Q,c);if(!ie.expected){F.push({slotKey:Q.slotKey,expected:!1,completed:!1,absent:!1});continue}w+=1;const z=!!R[Q.id],ye=ie.status==="absent";z&&(g+=1),F.push({slotKey:Q.slotKey,expected:!0,completed:z,absent:ye})}a[u]={completed:g,total:w,slots:F}}return a},[ee,A,Y,R]),P=l.useMemo(()=>{const[a,c,u]=V.split("-").map(Number);return new Date(a,c-1,u)},[V]),se=l.useMemo(()=>A(V),[A,V]),oe=te[V]||{completed:0,total:2,slots:[{slotKey:"AM",expected:!0,completed:!1,absent:!1},{slotKey:"PM",expected:!0,completed:!1,absent:!1}]},we=l.useMemo(()=>{const a=Array.isArray(t)?t:[];let c=0;for(const u of a){const j=String(u?.date??"").slice(0,10),w=u?.slot==="Soir"?"PM":"AM",g=`${j}__${w}`;if(k[g]==="absent")continue;const F=Ge(new Date(j));(v?.[F]?.[w]||k[g]==="present")&&Number.isFinite(Number(u?.distance))&&(c+=Number(u.distance))}return jt(Fe(c))},[t,k,v]),fe=l.useMemo(()=>{const a=se;let c=0;for(const u of a){const j=Y(u,P);if(!j.expected||j.status==="absent")continue;const w=R[u.id];w&&Number.isFinite(Number(w?.distance))&&(c+=Number(w.distance))}return jt(Fe(c))},[se,Y,P,R]),ke=l.useMemo(()=>q&&R[q]||null,[q,R]),ae=l.useMemo(()=>{const a=ke||{},c=a?.stroke_distances,u=c?{NL:c.NL?String(c.NL):"",DOS:c.DOS?String(c.DOS):"",BR:c.BR?String(c.BR):"",PAP:c.PAP?String(c.PAP):"",QN:c.QN?String(c.QN):""}:Xe;return{difficulty:a?.effort??null,fatigue_end:a?.fatigue??a?.feeling??null,performance:a?.performance??a?.feeling??null,engagement:a?.engagement??a?.feeling??null,comment:String(a?.comments??""),distanceMeters:Number.isFinite(Number(a?.distance))?Number(a.distance):null,showStrokeDetail:!!(c&&Object.values(c).some(j=>j&&j>0)),strokes:u,exerciseLogs:[]}},[ke]),[Re,ne]=l.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:Xe,exerciseLogs:[]}));return l.useEffect(()=>{const a=se.find(c=>c.id===q);if(a){const c=a.km!=null?hs(a.km):5e3;let u=Xe;if(a.assignmentId){const w=(n??[]).find(g=>g.id===a.assignmentId);if(w?.items){const g=ks(w.items);g&&(u={NL:String(g.NL||""),DOS:String(g.DOS||""),BR:String(g.BR||""),PAP:String(g.PAP||""),QN:String(g.QN||"")})}}const j=Object.values(ae.strokes).some(w=>w&&Number(w)>0);ne(w=>({...w,...ae,distanceMeters:ae.distanceMeters==null?c:ae.distanceMeters,strokes:j?ae.strokes:u,showStrokeDetail:j||Object.values(u).some(g=>g&&Number(g)>0)}));return}ne(c=>({...c,...ae}))},[ae,q,se,n]),l.useEffect(()=>{const a=()=>{d(!1),S(!1),K(!1),Z(null),me(!1),O(null)};return window.addEventListener("nav:reset",a),()=>window.removeEventListener("nav:reset",a)},[]),l.useEffect(()=>{G&&$&&oe.total>0&&oe.completed>=oe.total&&(d(!1),Z(null),me(!1),L(!1))},[G,$,oe.completed,oe.total]),{today:ce,monthCursor:de,selectedISO:V,drawerOpen:G,settingsOpen:b,infoOpen:D,activeSessionId:q,detailsOpen:he,selectedDayIndex:ve,isPending:T,presenceDefaults:v,attendanceOverrideBySessionId:k,stableDurationMin:U,draftState:Re,gridDates:ee,completionByISO:te,selectedDate:P,sessionsForSelectedDay:se,selectedDayStatus:oe,globalKm:we,dayKm:fe,logsBySessionId:R,setMonthCursor:pe,setSelectedISO:ue,setDrawerOpen:d,setSettingsOpen:S,setInfoOpen:K,setActiveSessionId:Z,setDetailsOpen:me,setSelectedDayIndex:O,setPresenceDefaults:h,setAttendanceOverrideBySessionId:_,setStableDurationMin:re,setDraftState:ne,setAutoCloseArmed:L,startTransition:M,getSessionStatus:Y,getSessionsForISO:A}}function et(...t){return t.filter(Boolean).join(" ")}const vt={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function Ds({strokes:t,showStrokeDetail:n,disabled:i=!1,onToggle:r,onChange:f}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:i,onClick:r,className:et("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",i?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(Ot,{className:et("h-4 w-4 transition-transform",n&&"rotate-90")})]}),n&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(vt).map(x=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:vt[x]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:i,value:t[x],onChange:y=>f({...t,[x]:y.target.value}),placeholder:"0",className:et("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",i?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},x))})]})}function E(...t){return t.filter(Boolean).join(" ")}function _s(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function qe(t){const n=Number(t);if(!Number.isFinite(n))return"—";const i=Math.round(n*100)/100,r=String(i);return r.endsWith(".0")?r.slice(0,-2):r}function wt(t){const n=Number(t);return Number.isFinite(n)?Math.round(n/1e3*100)/100:0}function Cs(t){const n=Number(t);return Number.isFinite(n)?Math.round(n*1e3):0}const tt=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],As=[{key:"AM",label:"Matin",Icon:fs},{key:"PM",label:"Soir",Icon:Wt}];function Ke({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function Ce({onClick:t,label:n,children:i,tone:r="neutral",disabled:f}){const x={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:f,className:E("inline-flex items-center justify-center rounded-2xl border p-2 transition",x[r],f&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":n,title:n,children:[i,e.jsx("span",{className:"sr-only",children:n})]})}function Fs(t,n){const i=Number(n);return!Number.isFinite(i)||i<1||i>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[i]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[i]}function Os({plannedMeters:t,valueMeters:n,onChange:i,disabled:r}){const p=Number.isFinite(Number(n))?Number(n):t,v=p-t;return e.jsxs("div",{className:E("mt-4 rounded-3xl border px-4 py-3",r?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:E("text-xs font-semibold",r?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),v!==0&&e.jsx("div",{className:E("text-xs font-semibold px-2 py-0.5 rounded-full",v>0?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"),children:v>0?`+${v}m`:`${v}m`})]}),e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:E("text-xs","text-muted-foreground"),children:["Planifié : ",t,"m (",qe(wt(t))," km)"]})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:r||p-100<0,onClick:()=>i(p-100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",r?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"-100m",children:e.jsx(It,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-[140px] text-center",children:[e.jsxs("div",{className:E("text-2xl font-bold",r?"text-muted-foreground":"text-foreground"),children:[p,"m"]}),e.jsxs("div",{className:E("text-sm font-medium mt-0.5",r?"text-muted-foreground":"text-primary"),children:[qe(wt(p))," km"]})]}),e.jsx("button",{type:"button",disabled:r||p+100>3e4,onClick:()=>i(p+100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",r?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"+100m",children:e.jsx(Be,{className:"h-5 w-5"})})]})]})}function Is({onMark:t}){const[n,i]=l.useState(!1),[r,f]=l.useState("");return n?e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",placeholder:"Motif (optionnel)",value:r,onChange:x=>f(x.target.value),className:"flex-1 rounded-md border border-input bg-transparent px-3 py-1.5 text-sm",autoFocus:!0}),e.jsx("button",{type:"button",onClick:()=>{t(r||void 0),i(!1),f("")},className:"rounded-md bg-primary px-3 py-1.5 text-sm font-medium text-primary-foreground",children:"OK"})]}):e.jsx("button",{type:"button",className:"w-full rounded-xl border border-dashed border-muted-foreground/30 p-2.5 mb-3 text-sm text-muted-foreground hover:bg-muted/50 transition-colors",onClick:()=>i(!0),children:"Marquer indisponible"})}function Es({open:t,selectedDate:n,sessionsForSelectedDay:i,selectedDayStatus:r,dayKm:f,activeSessionId:x,detailsOpen:y,draftState:p,saveState:v,isPending:h,logsBySessionId:k,onClose:_,onDayOffAll:U,onOpenSession:re,onCloseSession:ce,onToggleDetails:de,onMarkAbsent:pe,onMarkPresent:V,onClearOverride:ue,onSaveFeedback:G,onDraftStateChange:d,getSessionStatus:b,isAbsent:S,absenceReason:D,onDeleteFeedback:K,onMarkDayAbsent:q,onRemoveDayAbsence:Z}){const[,he]=Ut(),[me,ve]=l.useState(!1),O=l.useMemo(()=>x&&i.find($=>$.id===x)||null,[x,i]);return e.jsx(Le,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(be.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:_}),e.jsx(be.div,{className:E("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:es,initial:"hidden",animate:"visible",exit:"exit",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden",children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-primary/15 bg-background px-4 sm:px-5 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground shrink-0",children:e.jsx(At,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-sm font-display font-bold uppercase italic tracking-tight text-primary",children:_s(n)})})]}),e.jsx(Ce,{onClick:_,label:"Fermer",children:e.jsx(st,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-lg font-bold text-foreground",children:[f," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})}),e.jsx(Ce,{onClick:U,label:"OFF (absent journée)",tone:"dark",disabled:h,children:e.jsx(ss,{className:"h-5 w-5"})})]}),q&&Z&&(S?e.jsxs("div",{className:"rounded-xl border border-muted bg-muted/30 p-3 mt-3 mb-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Marqué indisponible"}),e.jsx("button",{type:"button",onClick:Z,className:"text-xs text-primary hover:underline",children:"Annuler"})]}),D&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:D})]}):e.jsx("div",{className:"mt-3",children:e.jsx(Is,{onMark:q})})),(()=>{const $=[],L=[];for(const M of i)b(M,n).status==="not_expected"?L.push(M):$.push(M);const T=M=>{const I=b(M,n),J=!!k[M.id],R=I.status==="absent",B=I.status==="not_expected",A=R||B,Y=I.expected&&!J&&!R,W=J?"bg-status-success-bg border-status-success/30":A?"bg-sky-50 border-sky-200":Y?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",ee=As.find(te=>te.key===M.slotKey)?.Icon||Ye;return e.jsx("button",{type:"button",onClick:()=>re(M.id),className:E("w-full rounded-3xl border px-3 py-3 text-left transition",W,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:E("h-10 w-10 rounded-2xl border flex items-center justify-center",J?"border-status-success/30 bg-status-success-bg":A?"border-sky-200 bg-sky-100":Y?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(ee,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:M.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[M.isEmpty?e.jsx(Ke,{children:"Vide"}):e.jsxs(Ke,{children:[qe(M.km)," km"]}),J&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(rt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),A&&!J&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Pe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),Y&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[B&&e.jsx(Ce,{onClick:te=>{te.stopPropagation(),V(M.id)},label:"Je suis venu",disabled:h,children:e.jsx(bt,{className:"h-5 w-5"})}),I.expected&&!J&&!R&&e.jsx(Ce,{onClick:te=>{te.stopPropagation(),pe(M.id)},label:"Absent",tone:"sky",disabled:h,children:e.jsx(Pe,{className:"h-5 w-5"})})]})]})},M.id)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4 grid gap-2",children:$.map(T)}),L.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",onClick:()=>ve(M=>!M),className:"flex w-full items-center gap-2 rounded-2xl px-3 py-2 text-xs font-semibold text-muted-foreground hover:bg-muted transition",children:[e.jsx(ns,{className:E("h-4 w-4 transition-transform",me&&"rotate-180")}),"Autres séances (",L.length,")"]}),e.jsx(Le,{children:me&&e.jsx(be.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"mt-1 grid gap-2",children:L.map(T)})})})]})]})})(),e.jsx(Le,{children:O&&e.jsx(be.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:mt.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const $=b(O,n),L=$.status==="absent",T=$.status==="not_expected",M=!!k[O.id],I=$.expected&&!L,J=L?"Annuler":T?"Je suis venu":"Absent",R=L?()=>ue(O.id):T?()=>V(O.id):()=>pe(O.id),B=Cs(O.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:O.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[O.isEmpty?e.jsx(Ke,{children:"Vide"}):e.jsxs(Ke,{children:[qe(O.km)," km"]}),M?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(rt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):L||T?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Pe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx(Ce,{onClick:ce,label:"Retour",children:e.jsx(st,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:R,className:E("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",T?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[T?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(Pe,{className:"h-4 w-4"}),J]}),e.jsxs("button",{type:"button",onClick:de,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(Ft,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(Le,{children:y&&e.jsx(be.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:mt.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:e.jsx("button",{type:"button",onClick:()=>he(O.assignmentId?`/swim-session?assignmentId=${O.assignmentId}`:"/swim-session"),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:O.assignmentId?"Ouvrir la fiche complète":"Saisir mes détails techniques"})})}),e.jsxs("div",{className:"px-4 pb-4",children:[!I&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:L?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(be.div,{className:"space-y-4",variants:ts,initial:"hidden",animate:"visible",children:[tt.map(A=>{const Y=p[A.key];return e.jsxs(be.div,{className:"space-y-2",variants:ut,children:[e.jsx("div",{className:E("text-sm font-semibold",I?"text-foreground":"text-muted-foreground"),children:A.label}),e.jsx("div",{className:"flex items-center gap-2",children:[1,2,3,4,5].map(W=>{const ee=Y===W;return e.jsx("button",{type:"button",disabled:!I,onClick:()=>d({...p,[A.key]:W}),className:E("h-11 w-11 rounded-2xl border text-sm font-semibold transition",I?ee?Fs(A.mode,W):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:W},W)})})]},A.key)}),e.jsxs(be.div,{className:"space-y-2",variants:ut,children:[e.jsx("div",{className:E("text-sm font-semibold",I?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:p.comment,onChange:A=>d({...p,comment:A.target.value}),disabled:!I,rows:3,placeholder:"Sensations, points techniques…",className:E("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",I?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsx(Os,{plannedMeters:B,valueMeters:p.distanceMeters,onChange:A=>d({...p,distanceMeters:A}),disabled:!I}),e.jsx(Ds,{strokes:p.strokes,showStrokeDetail:p.showStrokeDetail,disabled:!I,onToggle:()=>d({...p,showStrokeDetail:!p.showStrokeDetail}),onChange:A=>d({...p,strokes:A})}),M&&K&&e.jsxs("button",{type:"button",onClick:()=>{window.confirm("Supprimer ce ressenti ?")&&K(O.id)},disabled:h,className:"mt-4 w-full rounded-2xl border border-destructive/30 bg-destructive/5 px-3 py-2.5 text-sm font-medium text-destructive hover:bg-destructive/10 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-2",children:[e.jsx($e,{className:"h-4 w-4"}),"Supprimer le ressenti"]})]})]})})()},O.id)})]}),O&&(()=>{const $=b(O,n),L=$.expected&&$.status!=="absent";return e.jsxs(Zt,{saveState:v,position:"static",children:[e.jsx("button",{type:"button",onClick:G,disabled:h||!L||!tt.every(T=>Number.isInteger(p[T.key])),className:E("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",h||!L?"bg-muted text-muted-foreground cursor-not-allowed":tt.every(T=>Number.isInteger(p[T.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["→"," km"]})]})})()]})})]})})}function Ls(...t){return t.filter(Boolean).join(" ")}function Ps(t){try{return new Date(t).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return t}}function Ks({userId:t,expanded:n,onToggle:i}){const r=Ct(),{data:f,isLoading:x}=Ne({queryKey:["swim-exercise-logs-history",t],queryFn:()=>H.getSwimExerciseLogsHistory(t,100),enabled:!!t&&n}),y=ge({mutationFn:({logId:h,patch:k})=>H.updateSwimExerciseLog(h,k),onSuccess:()=>{r.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),p=ge({mutationFn:h=>H.deleteSwimExerciseLog(h),onSuccess:()=>{r.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),v=Ae.useMemo(()=>{if(!f?.length)return[];const h=new Map;for(const k of f){const _=(k.created_at??"").slice(0,10);h.has(_)||h.set(_,[]),h.get(_).push(k)}return Array.from(h.entries()).map(([k,_])=>({date:k,entries:_}))},[f]);return e.jsxs("div",{className:"mt-6",children:[e.jsxs("button",{type:"button",onClick:i,className:"flex w-full items-center justify-between rounded-2xl border border-border px-3 py-2.5 text-sm font-semibold text-foreground hover:bg-muted transition",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ft,{className:"h-4 w-4"}),"Historique notes techniques"]}),e.jsx(Ot,{className:Ls("h-4 w-4 transition-transform",n&&"rotate-90")})]}),n&&e.jsxs("div",{className:"mt-3 space-y-3",children:[x&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Chargement..."}),!x&&v.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucune note technique enregistree."}),v.map(({date:h,entries:k})=>e.jsxs("div",{className:"rounded-2xl border border-border overflow-hidden",children:[e.jsx("div",{className:"bg-muted/50 px-3 py-2 text-xs font-semibold text-muted-foreground",children:Ps(h)}),e.jsx("div",{className:"divide-y divide-border",children:k.map(_=>e.jsx(Ts,{log:_,onSave:U=>y.mutate({logId:_.id,patch:U}),onDelete:()=>p.mutate(_.id),saving:y.isPending},_.id))})]},h))]})]})}function Ts({log:t,onSave:n,onDelete:i,saving:r}){const[f,x]=l.useState(!1),[y,p]=l.useState({notes:t.notes??"",tempo:t.tempo,split_times:t.split_times,stroke_count:t.stroke_count}),[v,h]=l.useState([]),k=()=>{p({notes:t.notes??"",tempo:t.tempo,split_times:[...t.split_times],stroke_count:[...t.stroke_count]}),h(t.split_times.map(d=>We(d.time_seconds))),x(!0)},_=()=>x(!1),U=()=>{n({notes:y.notes.trim()||null,tempo:y.tempo,split_times:y.split_times,stroke_count:y.stroke_count}),x(!1)},re=()=>{p(d=>({...d,split_times:[...d.split_times,{rep:d.split_times.length+1,time_seconds:0}]})),h(d=>[...d,""])},ce=(d,b)=>{h(S=>S.map((D,K)=>K===d?b:D))},de=d=>{const b=is(v[d]),S=We(b);h(D=>D.map((K,q)=>q===d?S:K)),p(D=>({...D,split_times:D.split_times.map((K,q)=>q===d?{...K,time_seconds:b}:K)}))},pe=d=>{p(b=>({...b,split_times:b.split_times.filter((S,D)=>D!==d).map((S,D)=>({...S,rep:D+1}))})),h(b=>b.filter((S,D)=>D!==d))},V=()=>{p(d=>({...d,stroke_count:[...d.stroke_count,{rep:d.stroke_count.length+1,count:0}]}))},ue=(d,b)=>{p(S=>({...S,stroke_count:S.stroke_count.map((D,K)=>K===d?{...D,count:b}:D)}))},G=d=>{p(b=>({...b,stroke_count:b.stroke_count.filter((S,D)=>D!==d).map((S,D)=>({...S,rep:D+1}))}))};return f?e.jsxs("div",{className:"px-3 py-2.5 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:U,disabled:r,className:"p-1.5 rounded-lg text-primary hover:bg-primary/10 transition","aria-label":"Enregistrer",children:e.jsx(rt,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:_,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Annuler",children:e.jsx(st,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:i,className:"p-1.5 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition","aria-label":"Supprimer",children:e.jsx($e,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground min-w-[80px]",children:[e.jsx(xt,{className:"h-3.5 w-3.5"}),"Tempo"]}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:y.tempo??"",onChange:d=>p(b=>({...b,tempo:d.target.value?Number(d.target.value):null})),placeholder:"coups/min",className:"w-24 rounded-xl border border-border bg-background px-2 py-1.5 text-sm text-center outline-none focus:ring-2 focus:ring-foreground/10"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(ft,{className:"h-3.5 w-3.5"}),"Temps"]}),e.jsxs("button",{type:"button",onClick:re,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Be,{className:"h-3 w-3"}),"Rep"]})]}),y.split_times.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:y.split_times.map((d,b)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx(rs,{value:v[b]??"",onChange:S=>ce(b,S),onBlur:()=>de(b),size:"compact"}),e.jsx("button",{type:"button",onClick:()=>pe(b),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx($e,{className:"h-3 w-3"})})]},b))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(pt,{className:"h-3.5 w-3.5"}),"Coups de bras"]}),e.jsxs("button",{type:"button",onClick:V,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Be,{className:"h-3 w-3"}),"Rep"]})]}),y.stroke_count.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:y.stroke_count.map((d,b)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,value:d.count||"",onChange:S=>ue(b,Number(S.target.value)||0),placeholder:"nb",className:"w-14 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>G(b),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx($e,{className:"h-3 w-3"})})]},b))})]}),e.jsx("textarea",{value:y.notes,onChange:d=>p(b=>({...b,notes:d.target.value})),placeholder:"Notes libres...",rows:2,className:"w-full resize-none rounded-xl border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"})]}):e.jsxs("div",{className:"px-3 py-2.5 space-y-1.5 group",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsx("button",{type:"button",onClick:k,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Modifier",children:e.jsx(os,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground",children:[t.tempo!=null&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(xt,{className:"h-3 w-3"}),t.tempo," c/min"]}),t.split_times.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ft,{className:"h-3 w-3"}),t.split_times.map(d=>We(d.time_seconds)||"—").join(" / ")]}),t.stroke_count.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(pt,{className:"h-3 w-3"}),t.stroke_count.map(d=>d.count).join(" / ")," cps"]})]}),t.notes&&e.jsx("div",{className:"text-xs text-foreground/70 italic",children:t.notes})]})}const $s=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],kt=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],Bs=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function St(...t){return t.filter(Boolean).join(" ")}function Mt(t){return String(t).padStart(2,"0")}function Te(t){return`${t.getFullYear()}-${Mt(t.getMonth()+1)}-${Mt(t.getDate())}`}function qs(t){return new Date(t.getFullYear(),t.getMonth(),1)}function Rs(t){const n=String(t).split("__");return{iso:n[0],slotKey:n[1]||""}}function Dt(t,n){return Number.isFinite(t)?Math.round(t/n)*n:0}function _t({globalKm:t,onInfo:n,onSettings:i}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(At,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Accueil"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"hidden sm:inline text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[t," km"]}),e.jsxs(nt,{type:"button",variant:"outline",size:"sm",onClick:n,className:"h-8 rounded-xl border-primary/20 bg-primary/5 px-2.5 text-xs font-semibold text-primary hover:bg-primary/10","aria-label":"Codes",children:[e.jsx(ds,{className:"mr-1 h-3.5 w-3.5"}),"Codes"]}),e.jsxs(nt,{type:"button",variant:"outline",size:"sm",onClick:i,className:"h-8 rounded-xl border-primary/20 bg-primary/5 px-2.5 text-xs font-semibold text-primary hover:bg-primary/10","aria-label":"Présences",children:[e.jsx(xs,{className:"mr-1 h-3.5 w-3.5"}),"Présence"]})]})]})}function jn(){const t=ot(s=>s.user),n=ot(s=>s.userId),{toast:i}=Vt(),r=Ct(),[f,x]=Ae.useState("idle"),[y,p]=Ae.useState(!1),[v,h]=Ae.useState(null);Ae.useEffect(()=>{Ve.auth.getSession().then(({data:s})=>{h(s.session?.user?.id??null)})},[t]);const{data:k,isLoading:_,error:U,refetch:re}=Ne({queryKey:["sessions",n??t],queryFn:()=>H.getSessions(t,n),enabled:!!t}),{data:ce,isLoading:de,error:pe,refetch:V}=Ne({queryKey:["assignments",t],queryFn:()=>H.getAssignments(t,n),enabled:!!t}),{data:ue=[]}=Ne({queryKey:["competitions"],queryFn:()=>H.getCompetitions()}),{data:G}=Ne({queryKey:["my-competition-ids"],queryFn:()=>H.getMyCompetitionIds()}),d=l.useMemo(()=>!G||G.length===0?ue:ue.filter(s=>G.includes(s.id)),[ue,G]),{data:b=[]}=Ne({queryKey:["my-planned-absences"],queryFn:()=>H.getMyPlannedAbsences()}),S=l.useMemo(()=>new Set(b.map(s=>s.date)),[b]),D=_||de,K=U||pe,q=()=>{re(),V()},Z=ge({mutationFn:s=>H.deleteSession(s),onMutate:()=>{x("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),i({title:"Séance supprimée",description:"La saisie a été supprimée."}),x("saved"),setTimeout(()=>x("idle"),2e3)},onError:()=>{i({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),x("error"),setTimeout(()=>x("idle"),3e3)}}),he=ge({mutationFn:async s=>{const{_exerciseLogs:o,...m}=s,N=await H.syncSession({...m,athlete_name:t,athlete_id:n??void 0});if(o&&o.length>0&&N.sessionId)try{const{data:C}=await Ve.auth.getSession(),X=C.session?.user?.id;X&&await H.saveSwimExerciseLogs(N.sessionId,X,o)}catch(C){console.warn("[EAC] Failed to save exercise logs:",C)}return N},onMutate:()=>{x("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["assignments"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),i({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),x("saved"),setTimeout(()=>x("idle"),2e3)},onError:()=>{i({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),x("error"),setTimeout(()=>x("idle"),3e3)}}),me=ge({mutationFn:async s=>{const{_exerciseLogs:o,...m}=s,N=await H.updateSession(m);if(o&&m.id)try{const{data:C}=await Ve.auth.getSession(),X=C.session?.user?.id;X&&await H.saveSwimExerciseLogs(m.id,X,o)}catch(C){throw console.error("[EAC] Failed to save exercise logs:",C),C}return N},onMutate:()=>{x("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),i({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),x("saved"),setTimeout(()=>x("idle"),2e3)},onError:()=>{i({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),x("error"),setTimeout(()=>x("idle"),3e3)}}),ve=ge({mutationFn:({date:s,reason:o})=>H.setPlannedAbsence(s,o),onMutate:async({date:s,reason:o})=>{await r.cancelQueries({queryKey:["my-planned-absences"]});const m=r.getQueryData(["my-planned-absences"]);return r.setQueryData(["my-planned-absences"],N=>[...N??[],{date:s,reason:o??null}]),{previous:m}},onSuccess:()=>{r.invalidateQueries({queryKey:["my-planned-absences"]}),i({title:"Jour marqué indisponible"})},onError:(s,o,m)=>{m?.previous&&r.setQueryData(["my-planned-absences"],m.previous),i({title:"Erreur",description:"Impossible de marquer ce jour indisponible.",variant:"destructive"})}}),O=ge({mutationFn:s=>H.removePlannedAbsence(s),onMutate:async s=>{await r.cancelQueries({queryKey:["my-planned-absences"]});const o=r.getQueryData(["my-planned-absences"]);return r.setQueryData(["my-planned-absences"],m=>(m??[]).filter(N=>N.date!==s)),{previous:o}},onSuccess:()=>{r.invalidateQueries({queryKey:["my-planned-absences"]}),i({title:"Disponibilité restaurée"})},onError:(s,o,m)=>{m?.previous&&r.setQueryData(["my-planned-absences"],m.previous),i({title:"Erreur",description:"Impossible de restaurer la disponibilité.",variant:"destructive"})}}),$=Ms({sessions:k,assignments:ce,userId:n,user:t}),{today:L,monthCursor:T,selectedISO:M,drawerOpen:I,settingsOpen:J,infoOpen:R,activeSessionId:B,detailsOpen:A,selectedDayIndex:Y,isPending:W,presenceDefaults:ee,stableDurationMin:te,draftState:P,gridDates:se,completionByISO:oe,selectedDate:we,sessionsForSelectedDay:fe,selectedDayStatus:ke,globalKm:ae,dayKm:Re,logsBySessionId:ne,setMonthCursor:a,setSelectedISO:c,setDrawerOpen:u,setSettingsOpen:j,setInfoOpen:w,setActiveSessionId:g,setDetailsOpen:F,setSelectedDayIndex:Q,setPresenceDefaults:ie,setAttendanceOverrideBySessionId:z,setStableDurationMin:ye,setDraftState:Qe,setAutoCloseArmed:Oe,startTransition:le,getSessionStatus:ze}=$,Et=l.useMemo(()=>{const s=new Set;for(const o of d){if(!o.date)continue;const m=o.date.slice(0,10),N=o.end_date?o.end_date.slice(0,10):m;let C=m;for(;C<=N;){s.add(C);const X=new Date(C+"T00:00:00");X.setDate(X.getDate()+1);const Me=X.getFullYear(),Ee=String(X.getMonth()+1).padStart(2,"0"),De=String(X.getDate()).padStart(2,"0");C=`${Me}-${Ee}-${De}`}}return s},[d]),xe=l.useMemo(()=>{const s=Te(new Date);return d.filter(m=>m.date&&m.date.slice(0,10)>=s).sort((m,N)=>m.date.localeCompare(N.date))[0]??null},[d]),He=l.useMemo(()=>{if(!xe)return null;const s=new Date;s.setHours(0,0,0,0);const o=new Date(xe.date.slice(0,10)+"T00:00:00");return Math.round((o.getTime()-s.getTime())/(1e3*60*60*24))},[xe]),Ie=l.useMemo(()=>xe?Jt({compDate:xe.date.slice(0,10),assignments:ce,absenceDates:S,presenceDefaults:ee}):null,[xe,ce,S,ee]),Se=l.useCallback(s=>{c(s),u(!0),g(null),F(!1);const o=oe[s]||{completed:0,total:2};Oe(o.total>0&&o.completed<o.total)},[oe,c,u,g,F,Oe]),Je=l.useCallback(()=>{u(!1),g(null),F(!1),Oe(!1),Q(null)},[u,g,F,Oe,Q]),Lt=l.useCallback(()=>{a(s=>new Date(s.getFullYear(),s.getMonth()-1,1))},[a]),Pt=l.useCallback(()=>{a(s=>new Date(s.getFullYear(),s.getMonth()+1,1))},[a]),Kt=l.useCallback(()=>{const s=new Date;a(qs(s)),Se(Te(s))},[Se,a]),Ue=l.useCallback(s=>{g(s),F(!1)},[g,F]),Tt=l.useCallback(s=>{le(()=>{z(m=>({...m,[s]:"absent"}))});const o=ne[s];o?.id&&Z.mutate(Number(o.id))},[Z,ne,le,z]),$t=l.useCallback(s=>{le(()=>{z(o=>({...o,[s]:"present"}))})},[le,z]),Bt=l.useCallback(s=>{le(()=>{z(o=>{const m={...o};return delete m[s],m})})},[le,z]),qt=l.useCallback(()=>{const s=fe.map(o=>ze(o,we).expected?o.id:null).filter(Boolean);s.length!==0&&(le(()=>{z(o=>{const m={...o};for(const N of s)m[N]="absent";return m}),g(null),F(!1)}),s.forEach(o=>{const m=ne[o];m?.id&&Z.mutate(Number(m.id))}))},[fe,ze,we,le,ne,Z,z,g,F]),Rt=l.useCallback(()=>{if(!B||!t||!Bs.every(_e=>Number.isInteger(P[_e.key])))return;const{iso:o,slotKey:m}=Rs(B),N=m==="PM"?"Soir":"Matin",C=Dt(Number(P.distanceMeters??0),100),X=Dt(Number(te),15),Me={};for(const[_e,Ht]of Object.entries(P.strokes)){const it=Number(Ht);it>0&&(Me[_e]=it)}const Ee={date:o,slot:N,distance:C,duration:X,effort:Number(P.difficulty),feeling:Number(P.fatigue_end),performance:Number(P.performance),engagement:Number(P.engagement),comments:String(P.comment||"").slice(0,400),athlete_name:t,athlete_id:n??void 0,stroke_distances:Object.keys(Me).length>0?Me:null},De=ne[B];le(()=>{z(_e=>({..._e,[B]:"present"}))}),De?.id?me.mutate({...Ee,id:De.id,created_at:De.created_at??new Date().toISOString(),_exerciseLogs:P.exerciseLogs.length>0?P.exerciseLogs:[]}):he.mutate({...Ee,_exerciseLogs:P.exerciseLogs.length>0?P.exerciseLogs:void 0}),g(null),F(!1)},[B,t,n,P,te,ne,le,me,he,z,g,F]),Qt=l.useCallback((s,o)=>{ie(m=>({...m,[s]:{...m[s],[o]:!m[s][o]}}))},[ie]);l.useEffect(()=>{if(!I)return;const s=o=>{const m=o.target?.tagName;if(!(m==="INPUT"||m==="TEXTAREA"||o.target?.isContentEditable)){if(o.key==="Escape"){o.preventDefault(),Je();return}(o.key==="Enter"||o.key===" ")&&(o.preventDefault(),fe.length>0&&!B&&Ue(fe[0].id))}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[I,Je,fe,B,Ue]);const zt=l.useCallback((s,o)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(s.key))return;if(s.preventDefault(),s.key==="Enter"||s.key===" "){const C=Te(se[o]);Se(C);return}let N=o;s.key==="ArrowLeft"&&(N=Math.max(0,o-1)),s.key==="ArrowRight"&&(N=Math.min(se.length-1,o+1)),s.key==="ArrowUp"&&(N=Math.max(0,o-7)),s.key==="ArrowDown"&&(N=Math.min(se.length-1,o+7)),Q(N),c(Te(se[N])),setTimeout(()=>{const C=document.querySelectorAll('[data-calendar-cell="true"]');C[N]&&C[N].focus()},0)},[se,Se,Q,c]);return D?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"h-7 w-7 rounded-lg bg-primary/20 animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((s,o)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${o}`)),Array.from({length:35}).map((s,o)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${o}`))]})})]})})]}):K?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(ls,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:K.message}),e.jsx(nt,{onClick:()=>q(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsx("div",{className:"px-4 py-2.5 flex items-center justify-between",children:e.jsx(_t,{globalKm:ae,onInfo:()=>w(!0),onSettings:()=>j(!0)})})}),e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:[e.jsx("div",{className:"hidden sm:flex items-center justify-between",children:e.jsx(_t,{globalKm:ae,onInfo:()=>w(!0),onSettings:()=>j(!0)})}),e.jsx(as,{variant:"amber",icon:e.jsx(Yt,{}),label:xe?.name,badge:He===0?"Aujourd'hui":`J-${He}`,sublabel:xe?.location,subbadge:Ie!=null&&Ie>0?`${Ie} séance${Ie>1?"s":""}`:void 0,visible:!!xe&&He!=null,className:"mt-4"}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(Xt,{monthCursor:T,selectedDayStatus:ke,onPrevMonth:Lt,onNextMonth:Pt,onJumpToday:Kt}),e.jsx(Gt,{monthCursor:T,gridDates:se,completionByISO:oe,competitionDates:Et,absenceDates:S,selectedISO:M,selectedDayIndex:Y,today:L,onDayClick:Se,onKeyDown:zt})]}),v&&e.jsx(Ks,{userId:v,expanded:y,onToggle:()=>p(s=>!s)}),e.jsx(at,{open:R,onOpenChange:w,children:e.jsxs(lt,{className:"max-w-sm rounded-2xl",children:[e.jsx(ct,{children:e.jsx(dt,{children:"Codes"})}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-orange-200 bg-orange-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Orange"}),e.jsx("span",{className:"text-foreground",children:"À compléter"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Vert"}),e.jsx("span",{className:"text-foreground",children:"Validé → km"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-sky-200 bg-sky-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Bleu"}),e.jsx("span",{className:"text-foreground",children:"Absent / Non prévu"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Les km comptent uniquement après validation."})]})]})}),e.jsx(at,{open:J,onOpenChange:j,children:e.jsxs(lt,{className:"max-w-sm rounded-2xl",children:[e.jsx(ct,{children:e.jsx(dt,{children:"Présence"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Définis les créneaux attendus chaque semaine. Tu peux ensuite ajuster un jour précis dans le calendrier."}),e.jsx("div",{className:"space-y-2",children:$s.map((s,o)=>{const m=kt.filter(N=>!!ee?.[o]?.[N.key]).length;return e.jsxs("div",{className:"rounded-2xl border border-border bg-card px-3 py-3",children:[e.jsx("div",{className:"mb-2 flex items-center justify-between gap-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:s}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:m===0?"Aucun créneau prévu":`${m} créneau${m>1?"x":""} attendu${m>1?"s":""}`})]})}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:kt.map(N=>{const C=!!ee?.[o]?.[N.key];return e.jsxs("button",{type:"button",onClick:()=>Qt(o,N.key),className:St("rounded-2xl border px-3 py-3 text-left transition",C?"border-foreground bg-foreground text-background":"border-border bg-card text-foreground hover:bg-muted"),"aria-label":`${s} ${N.label}`,children:[e.jsx("div",{className:"text-sm font-semibold",children:N.label}),e.jsx("div",{className:St("mt-1 text-[11px]",C?"text-background/80":"text-muted-foreground"),children:C?"Prévu":"Non prévu"})]},N.key)})})]},s)})}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>ye(s=>Math.max(30,s-15)),"aria-label":"Diminuer la durée",children:e.jsx(It,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[te," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>ye(s=>Math.min(240,s+15)),"aria-label":"Augmenter la durée",children:e.jsx(Be,{className:"h-4 w-4"})})]})]})]})]})}),e.jsx(Es,{open:I,selectedDate:we,sessionsForSelectedDay:fe,selectedDayStatus:ke,dayKm:Re,activeSessionId:B,detailsOpen:A,draftState:P,saveState:f,isPending:W,logsBySessionId:ne,onClose:Je,onDayOffAll:qt,onOpenSession:Ue,onCloseSession:()=>{g(null),F(!1)},onToggleDetails:()=>F(s=>!s),onMarkAbsent:Tt,onMarkPresent:$t,onClearOverride:Bt,onSaveFeedback:Rt,onDeleteFeedback:s=>{const o=ne[s];o?.id&&(Z.mutate(Number(o.id)),g(null),F(!1))},onDraftStateChange:Qe,getSessionStatus:ze,isAbsent:S.has(M),absenceReason:b.find(s=>s.date===M)?.reason??null,onMarkDayAbsent:s=>ve.mutate({date:M,reason:s}),onRemoveDayAbsence:()=>O.mutate(M)})]})]})}export{jn as default};
