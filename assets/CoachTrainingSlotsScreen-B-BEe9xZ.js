import{c as he,r as o,d as U,j as e,u as H}from"./vendor-query-DyA9aSKS.js";import{u as Dt,d as Mt,a as I,c as Ft}from"./api-D2Tllh8s.js";import{b as et,L as E,l as tt,P as te,B as P,I as le,f as Tt,W as Et,d as $e,u as $t,a4 as st}from"./index-BOaNBvLi.js";import{C as At}from"./Coach-j-Z9HOMM.js";import{S as pe,a as ge,b as fe,c as be,d as je}from"./sheet-BjGxi9D5.js";import{B as Ae}from"./badge-BqVBcLrN.js";import{C as Pt}from"./checkbox-DP8-bY2y.js";import{S as ve}from"./separator-D9YMXn0z.js";import{A as rt,a as at,b as nt,c as it,d as lt,e as ot,f as dt,g as ct}from"./alert-dialog-TZ9Elvkk.js";import{C as mt}from"./clock-C7j0j3Vq.js";import{M as Pe}from"./map-pin-CTuIF1Bq.js";import{L as ut}from"./loader-circle-UaLInN3_.js";import{P as xt}from"./pencil-2idgWwn9.js";import{C as qt}from"./copy-4VZGVijV.js";import{E as It}from"./eye-off-Czm1q5LK.js";import{E as Lt}from"./eye-OdEBM77b.js";import{T as ht}from"./trash-2-BLBNri9G.js";import{w as Vt}from"./swim-C2h4iBds.js";import{c as zt}from"./swimSessionUtils-DN7EW4yB.js";import{S as Rt}from"./search-BuDx8ije.js";import{S as se,a as re,b as ae,c as ne,d as z,f as ee}from"./select-Dr0N4gfo.js";import{R as Ot,a as Ge}from"./radio-group-CHY-CKen.js";import{C as De}from"./chevron-left-XoLlxIEY.js";import{C as pt}from"./chevron-right-jL56ZFJl.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-D7EmMq6P.js";import"./trophy-qMQgMj36.js";import"./bell-ring-CeDwwM6E.js";import"./zap-T3BeBZjp.js";import"./index-BlA81OqL.js";import"./index-7hjYYUsE.js";import"./index-DCX2sNhR.js";import"./index-DZNP_ke5.js";import"./chevron-down-vjdOd1og.js";import"./chevron-up-Ci_LaZAm.js";import"./index-C7kKDxFB.js";import"./circle-d6i1jhWF.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]],Me=et("book-open",Ht);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=[["path",{d:"M11 17a4 4 0 0 1-8 0V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2Z",key:"1ldrpk"}],["path",{d:"M16.7 13H19a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H7",key:"11i5po"}],["path",{d:"M 7 17h.01",key:"1euzgo"}],["path",{d:"m11 8 2.3-2.3a2.4 2.4 0 0 1 3.404.004L18.6 7.6a2.4 2.4 0 0 1 .026 3.434L9.9 19.8",key:"o2gii7"}]],Bt=et("swatch-book",Kt);function Wt(t,r){return t?t.visible_from===null||t.visible_from===void 0||t.visible_from<=r?"published":"draft":"empty"}const Gt=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function Qe(t){return t.slice(0,5)}function Ue(t){const[r,a,c]=t.split("-").map(Number),b=new Date(r,a-1,c),g=(b.getDay()+6)%7,f=Gt[g],x=b.toLocaleDateString("fr-FR",{month:"long"});return`${f} ${c} ${x}`}const Fe={empty:{label:"",badgeClass:""},draft:{label:"Brouillon",badgeClass:"bg-amber-500/15 text-amber-600 dark:text-amber-400 border-amber-500/25"},published:{label:"Publié",badgeClass:"bg-emerald-500/15 text-emerald-600 dark:text-emerald-400 border-emerald-500/25"},cancelled:{label:"Annulé",badgeClass:"bg-muted text-muted-foreground border-border/50"}};function Qt({instance:t,open:r,onOpenChange:a,onCreateNew:c,onEditSession:b,onPickTemplate:g,onEditSlot:f,onManageOverride:x}){const _=he(),[p,u]=o.useState([]),[y,C]=o.useState(""),[S,N]=o.useState(!1),[l,v]=o.useState(!1);o.useEffect(()=>{t&&(u(t.groups.map(n=>n.group_id)),C(t.assignment?.visible_from??t.date),N(!1),v(!1))},[t]);const j=o.useCallback(()=>{_.invalidateQueries({queryKey:["slot-assignments"]})},[_]),M=U({mutationFn:n=>Dt(n),onSuccess:()=>{j(),N(!1)}}),m=U({mutationFn:n=>Mt(n),onSuccess:()=>{j(),v(!1),a(!1)}}),T=n=>{u(d=>d.includes(n)?d.filter(V=>V!==n):[...d,n])},F=()=>{t&&M.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date,visibleFrom:y||null})},D=()=>{t&&m.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date})},w=()=>{!t||!f||(a(!1),f(t))},q=()=>{!t||!x||(a(!1),x(t))};if(!t)return null;const{state:$,slot:A,assignment:R,override:L,groups:B}=t,k=Fe[$];return e.jsxs(e.Fragment,{children:[e.jsx(pe,{open:r,onOpenChange:a,children:e.jsxs(ge,{side:"bottom",className:"rounded-t-3xl max-h-[85vh] overflow-y-auto px-5 pb-8 pt-4",children:[e.jsx("div",{className:"mx-auto mb-4 h-1 w-10 rounded-full bg-border/60"}),e.jsxs(fe,{className:"text-left space-y-1.5 mb-5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"text-base font-bold leading-tight",children:Ue(t.date)}),$!=="empty"&&e.jsx(Ae,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${k.badgeClass}`,children:k.label})]}),e.jsxs(je,{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(mt,{className:"h-3 w-3 opacity-60"}),Qe(A.start_time)," – ",Qe(A.end_time)]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Pe,{className:"h-3 w-3 opacity-60"}),A.location]})]})]}),$==="cancelled"&&e.jsx(Ut,{override:L,onEditSlot:w,onManageOverride:q,canEditSlot:!!f,canManageOverride:!!x}),$==="empty"&&e.jsx(Yt,{instance:t,groups:B,selectedGroups:p,visibleFrom:y,onToggleGroup:T,onVisibleFromChange:C,onCreateNew:c,onPickTemplate:g,onClose:()=>a(!1),onEditSlot:w,onManageOverride:q,canEditSlot:!!f,canManageOverride:!!x}),($==="draft"||$==="published")&&e.jsx(Jt,{instance:t,assignment:R,showVisibilityPicker:S,visibleFrom:y,visibilityLoading:M.isPending,deleteLoading:m.isPending,onToggleVisibilityPicker:()=>N(n=>!n),onVisibleFromChange:C,onSaveVisibility:F,onEditSession:b,onRequestDelete:()=>v(!0),onEditSlot:w,onManageOverride:q,canEditSlot:!!f,canManageOverride:!!x})]})}),e.jsx(rt,{open:l,onOpenChange:v,children:e.jsxs(at,{children:[e.jsxs(nt,{children:[e.jsx(it,{children:"Supprimer la séance ?"}),e.jsxs(lt,{children:["Cette action supprimera définitivement la séance assignée pour ce créneau le ",Ue(t.date),". Les nageurs ne verront plus cette séance."]})]}),e.jsxs(ot,{children:[e.jsx(dt,{disabled:m.isPending,children:"Annuler"}),e.jsx(ct,{onClick:D,disabled:m.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ut,{className:"mr-2 h-4 w-4 animate-spin"}),"Suppression..."]}):"Supprimer"})]})]})})]})}function Ut({override:t,onEditSlot:r,onManageOverride:a,canEditSlot:c,canManageOverride:b}){return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl bg-muted/40 border border-border/50 p-4 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Ce créneau a été annulé"}),t?.reason&&e.jsx("p",{className:"mt-1.5 text-xs text-muted-foreground/70 italic",children:t.reason})]}),e.jsx(qe,{canEditSlot:c,canManageOverride:b,onEditSlot:r,onManageOverride:a})]})}function Yt({instance:t,groups:r,selectedGroups:a,visibleFrom:c,onToggleGroup:b,onVisibleFromChange:g,onCreateNew:f,onPickTemplate:x,onClose:_,onEditSlot:p,onManageOverride:u,canEditSlot:y,canManageOverride:C}){const S=()=>{_(),f(t)},N=()=>{_(),x(t)};return e.jsxs("div",{className:"space-y-5",children:[r.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Groupes"}),e.jsx("div",{className:"space-y-2.5",children:r.map(l=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx(Pt,{checked:a.includes(l.group_id),onCheckedChange:()=>b(l.group_id),className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:l.group_name})]},l.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(E,{htmlFor:"visible-from-empty",className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:[e.jsx(tt,{className:"inline h-3 w-3 mr-1 opacity-60"}),"Visible à partir du"]}),e.jsx("input",{id:"visible-from-empty",type:"date",value:c,onChange:l=>g(l.target.value),className:"w-full rounded-xl border border-border bg-muted/30 px-3 py-2.5 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]}),e.jsx(ve,{className:"my-1"}),e.jsxs("div",{className:"space-y-2.5",children:[e.jsxs("button",{type:"button",onClick:S,className:"flex w-full items-center gap-3 rounded-xl bg-primary/10 px-4 py-3.5 text-left transition-colors active:bg-primary/20 hover:bg-primary/15",children:[e.jsx("div",{className:"flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-primary/15",children:e.jsx(te,{className:"h-4.5 w-4.5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Nouvelle séance"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Créer une séance de zéro"})]})]}),e.jsxs("button",{type:"button",onClick:N,className:"flex w-full items-center gap-3 rounded-xl bg-muted/50 border border-border/50 px-4 py-3.5 text-left transition-colors active:bg-muted/80 hover:bg-muted/70",children:[e.jsx("div",{className:"flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-muted",children:e.jsx(Me,{className:"h-4.5 w-4.5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Depuis la bibliothèque"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Utiliser une séance existante"})]})]})]}),e.jsx(qe,{canEditSlot:y,canManageOverride:C,onEditSlot:p,onManageOverride:u})]})}function Jt({instance:t,assignment:r,showVisibilityPicker:a,visibleFrom:c,visibilityLoading:b,deleteLoading:g,onToggleVisibilityPicker:f,onVisibleFromChange:x,onSaveVisibility:_,onEditSession:p,onRequestDelete:u,onEditSlot:y,onManageOverride:C,canEditSlot:S,canManageOverride:N}){return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"rounded-xl bg-muted/30 border border-border/50 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground leading-snug",children:r.session_name??"Séance sans nom"}),r.session_distance!=null&&r.session_distance>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[r.session_distance," m"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(Ae,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${Fe[t.state].badgeClass}`,children:Fe[t.state].label}),r.visible_from&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Visible le"," ",new Date(r.visible_from).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})]})]})]}),t.groups.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.groups.map(l=>e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-medium border border-border/50 bg-muted/60 text-muted-foreground",children:l.group_name},l.id))}),e.jsx(ve,{className:"my-1"}),e.jsxs("div",{className:"space-y-2.5",children:[r.swim_catalog_id!=null&&e.jsx(Z,{icon:e.jsx(xt,{className:"h-4 w-4"}),label:"Modifier",description:"Ouvrir dans l'éditeur",onClick:()=>p(r.swim_catalog_id)}),e.jsx(Z,{icon:e.jsx(qt,{className:"h-4 w-4"}),label:"Dupliquer vers...",description:"Bientôt disponible",disabled:!0,onClick:()=>{}}),e.jsx(Z,{icon:a?e.jsx(It,{className:"h-4 w-4"}):e.jsx(Lt,{className:"h-4 w-4"}),label:"Visibilité",description:"Date de publication pour les nageurs",onClick:f}),a&&e.jsxs("div",{className:"ml-12 space-y-2.5 rounded-xl border border-border/50 bg-muted/20 p-3",children:[e.jsx(E,{htmlFor:"visible-from-edit",className:"text-xs text-muted-foreground",children:"Visible à partir du"}),e.jsx("input",{id:"visible-from-edit",type:"date",value:c,onChange:l=>x(l.target.value),className:"w-full rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{size:"sm",className:"flex-1 rounded-lg",disabled:b,onClick:_,children:[b?e.jsx(ut,{className:"mr-1.5 h-3.5 w-3.5 animate-spin"}):null,"Enregistrer"]}),e.jsx(P,{size:"sm",variant:"ghost",className:"rounded-lg",disabled:b,onClick:f,children:"Annuler"})]})]}),e.jsx(Z,{icon:e.jsx(ht,{className:"h-4 w-4"}),label:"Supprimer",description:"Retirer cette séance du créneau",variant:"destructive",disabled:g,onClick:u})]}),e.jsx(qe,{canEditSlot:S,canManageOverride:N,onEditSlot:y,onManageOverride:C})]})}function qe({canEditSlot:t,canManageOverride:r,onEditSlot:a,onManageOverride:c}){return!t&&!r?null:e.jsxs("div",{className:"space-y-2.5",children:[e.jsx(ve,{className:"my-1"}),e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Créneau"}),t&&e.jsx(Z,{icon:e.jsx(xt,{className:"h-4 w-4"}),label:"Modifier le créneau",description:"Horaires, lieu et groupes",onClick:a}),r&&e.jsx(Z,{icon:e.jsx(tt,{className:"h-4 w-4"}),label:"Gérer l'exception",description:"Annuler ou ajuster ce jour précis",onClick:c})]})}function Z({icon:t,label:r,description:a,variant:c="default",disabled:b=!1,onClick:g}){const f=c==="destructive";return e.jsxs("button",{type:"button",onClick:g,disabled:b,className:`
        flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-left transition-colors
        ${b?"opacity-40 cursor-not-allowed":"active:scale-[0.98]"}
        ${f?"bg-destructive/5 hover:bg-destructive/10 active:bg-destructive/15":"bg-muted/40 hover:bg-muted/60 active:bg-muted/80"}
      `,children:[e.jsx("div",{className:`flex h-9 w-9 shrink-0 items-center justify-center rounded-lg ${f?"bg-destructive/10 text-destructive":"bg-muted text-muted-foreground"}`,children:t}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm font-semibold ${f?"text-destructive":"text-foreground"}`,children:r}),a&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:a})]})]})}function Xt({open:t,onOpenChange:r,onSelect:a}){const[c,b]=o.useState(""),{data:g,isLoading:f}=H({queryKey:["swim_catalog"],queryFn:()=>Vt(),enabled:t}),x=o.useMemo(()=>{if(!g)return[];const p=c.trim().toLowerCase();return g.filter(u=>!u.is_archived).filter(u=>!p||u.name.toLowerCase().includes(p)||(u.folder??"").toLowerCase().includes(p)).sort((u,y)=>u.name.localeCompare(y.name,"fr"))},[g,c]),_=p=>{a(p.id,p.name),r(!1)};return e.jsx(pe,{open:t,onOpenChange:r,children:e.jsxs(ge,{side:"bottom",className:"flex h-[80vh] flex-col rounded-t-2xl px-4 pb-4 pt-5",children:[e.jsxs(fe,{className:"shrink-0 space-y-1",children:[e.jsx(be,{className:"text-base font-semibold",children:"Choisir une séance"}),e.jsx(je,{className:"sr-only",children:"Parcourez et recherchez dans la bibliothèque de séances natation"})]}),e.jsxs("div",{className:"relative mt-3 shrink-0",children:[e.jsx(Rt,{className:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(le,{placeholder:"Rechercher une séance...",value:c,onChange:p=>b(p.target.value),className:"pl-9"})]}),e.jsx("div",{className:"mt-3 flex-1 overflow-y-auto overscroll-contain",children:f?e.jsx("div",{className:"space-y-3",children:Array.from({length:6}).map((p,u)=>e.jsx(Tt,{className:"h-[72px] w-full rounded-xl"},u))}):x.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-16 text-muted-foreground",children:[e.jsx(Et,{className:"h-10 w-10 opacity-40"}),e.jsx("p",{className:"text-sm",children:"Aucune séance dans la bibliothèque"})]}):e.jsx("div",{className:"space-y-2",children:x.map(p=>{const u=zt(p.items??[]);return e.jsxs("button",{type:"button",onClick:()=>_(p),className:"flex w-full items-center gap-3 rounded-xl border border-border bg-card p-3 text-left shadow-sm transition-transform active:scale-[0.98]",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-blue-500/10 text-blue-400",children:e.jsx(Bt,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:p.name}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-2 text-xs text-muted-foreground",children:[u>0&&e.jsxs("span",{children:[u.toLocaleString("fr-FR")," m"]}),u>0&&p.folder&&e.jsx("span",{"aria-hidden":"true",children:"·"}),p.folder&&e.jsx("span",{className:"truncate",children:p.folder})]})]})]},p.id)})})})]})})}const Ie=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],Zt=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],oe=6,es=22,gt=es-oe,xe=40,Ye=gt*xe,Je=Array.from({length:gt+1},(t,r)=>oe+r);function K(t){return t.slice(0,5)}function ke(){return new Date().toISOString().slice(0,10)}function G(t){const[r,a]=t.split(":").map(Number);return r*60+a}function Te(t){return(G(t)-oe*60)/60*xe}function ts(t,r){return Te(r)-Te(t)}function Xe(t){const r=new Date(t),a=r.getDay(),c=a===0?-6:1-a;return r.setDate(r.getDate()+c),r.setHours(0,0,0,0),r}function ss(t){const r=new Date(t);r.setHours(0,0,0,0),r.setDate(r.getDate()+3-(r.getDay()+6)%7);const a=new Date(r.getFullYear(),0,4);return 1+Math.round(((r.getTime()-a.getTime())/864e5-3+(a.getDay()+6)%7)/7)}function ie(t){return t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Q(t){const r=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${r(t.getMonth()+1)}-${r(t.getDate())}`}function Ee(t){const r=t.toLowerCase();return r.includes("piscine")||r.includes("bassin")||!r.includes("salle")&&!r.includes("muscu")&&!r.includes("ppg")&&!r.includes("gym")}function Ze(t,r,a){const c={slot:{trainingSlotId:t.slot.id,scheduledDate:t.date,startTime:t.slot.start_time,endTime:t.slot.end_time,location:t.slot.location}};return r==="edit"&&a!=null?{mode:r,swimCatalogId:a,...c}:{mode:"create",...c}}const rs=({open:t,onOpenChange:r,slot:a,groups:c,coaches:b})=>{const{toast:g}=$e(),f=he(),x=!!a,[_,p]=o.useState("1"),[u,y]=o.useState(""),[C,S]=o.useState(""),[N,l]=o.useState(""),[v,j]=o.useState([]),[M,m]=o.useState(1),[T,F]=o.useState(!1);o.useEffect(()=>{if(t)if(a){p(String(a.day_of_week)),y(K(a.start_time)),S(K(a.end_time)),l(a.location);const n=a.assignments.map((d,V)=>({key:V,group_id:String(d.group_id),coach_id:String(d.coach_id),lane_count:d.lane_count!=null?String(d.lane_count):""}));j(n),m(n.length)}else p("1"),y(""),S(""),l(""),j([]),m(1)},[t,a]);const D=()=>{j(n=>[...n,{key:M,group_id:"",coach_id:"",lane_count:""}]),m(n=>n+1)},w=n=>{j(d=>d.filter(V=>V.key!==n))},q=(n,d,V)=>{j(de=>de.map(W=>W.key===n?{...W,[d]:V}:W))},$=()=>!u||!C?(g({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):N.trim()?{day_of_week:Number(_),start_time:u,end_time:C,location:N.trim(),assignments:v.filter(n=>n.group_id&&n.coach_id).map(n=>({group_id:Number(n.group_id),coach_id:Number(n.coach_id),lane_count:n.lane_count?Number(n.lane_count):null}))}:(g({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),A=U({mutationFn:n=>I.createTrainingSlot(n),onSuccess:()=>{g({title:"Creneau cree"}),f.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:n=>{g({title:"Erreur",description:n.message,variant:"destructive"})}}),R=U({mutationFn:n=>I.updateTrainingSlot(a.id,n),onSuccess:()=>{g({title:"Creneau mis a jour"}),f.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:n=>{g({title:"Erreur",description:n.message,variant:"destructive"})}}),L=U({mutationFn:()=>I.deleteTrainingSlot(a.id),onSuccess:()=>{g({title:"Creneau supprime"}),f.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:n=>{g({title:"Erreur",description:n.message,variant:"destructive"})}}),B=()=>{const n=$();n&&(x?R.mutate(n):A.mutate(n))},k=A.isPending||R.isPending||L.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(pe,{open:t,onOpenChange:r,children:e.jsxs(ge,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(fe,{children:[e.jsx(be,{children:x?"Modifier le creneau":"Nouveau creneau"}),e.jsx(je,{children:x?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Jour de la semaine *"}),e.jsxs(se,{value:_,onValueChange:p,children:[e.jsx(re,{children:e.jsx(ae,{})}),e.jsx(ne,{children:Ie.map((n,d)=>e.jsx(z,{value:String(d+1),children:n},d+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:u,onChange:n=>y(n.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:C,onChange:n=>S(n.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(le,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:N,onChange:n=>l(n.target.value)})]}),e.jsx(ve,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(E,{children:"Groupes & Coachs"}),e.jsxs(P,{type:"button",variant:"outline",size:"sm",onClick:D,children:[e.jsx(te,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),v.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),v.map(n=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(se,{value:n.group_id,onValueChange:d=>q(n.key,"group_id",d),children:[e.jsx(re,{className:"h-8 text-xs",children:e.jsx(ae,{placeholder:"Groupe..."})}),e.jsx(ne,{children:c.map(d=>e.jsx(z,{value:String(d.id),children:d.name},d.id))})]}),e.jsxs(se,{value:n.coach_id,onValueChange:d=>q(n.key,"coach_id",d),children:[e.jsx(re,{className:"h-8 text-xs",children:e.jsx(ae,{placeholder:"Coach..."})}),e.jsx(ne,{children:b.map(d=>e.jsx(z,{value:String(d.id),children:d.display_name},d.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{type:"number",min:0,placeholder:"Lignes d'eau",value:n.lane_count,onChange:d=>q(n.key,"lane_count",d.target.value),className:"h-8 text-xs flex-1"}),e.jsx(P,{type:"button",variant:"ghost",size:"icon",className:"h-10 w-10 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>w(n.key),children:e.jsx(ht,{className:"h-3.5 w-3.5"})})]})]})},n.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(P,{className:"w-full",onClick:B,disabled:k||!u||!C||!N.trim(),children:k?"Enregistrement...":x?"Enregistrer":"Creer"}),x&&e.jsx(P,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>F(!0),disabled:k,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(rt,{open:T,onOpenChange:F,children:e.jsxs(at,{children:[e.jsxs(nt,{children:[e.jsx(it,{children:"Supprimer le creneau"}),e.jsx(lt,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(ot,{children:[e.jsx(dt,{children:"Annuler"}),e.jsx(ct,{onClick:()=>{L.mutate(),F(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},as=({open:t,onOpenChange:r,slot:a})=>{const{toast:c}=$e(),b=he(),[g,f]=o.useState(""),[x,_]=o.useState("cancelled"),[p,u]=o.useState(""),[y,C]=o.useState(""),[S,N]=o.useState(""),[l,v]=o.useState("");o.useEffect(()=>{t&&(f(""),_("cancelled"),u(a?K(a.start_time):""),C(a?K(a.end_time):""),N(a?.location??""),v(""))},[t,a]);const j=U({mutationFn:m=>I.createSlotOverride(m),onSuccess:()=>{c({title:"Exception enregistree"}),b.invalidateQueries({queryKey:["training-slot-overrides"]}),b.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:m=>{c({title:"Erreur",description:m.message,variant:"destructive"})}}),M=()=>{if(!a)return;if(!g){c({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const m={slot_id:a.id,override_date:g,status:x,new_start_time:x==="modified"&&p||null,new_end_time:x==="modified"&&y||null,new_location:x==="modified"&&S.trim()?S.trim():null,reason:l.trim()||null};j.mutate(m)};return e.jsx(pe,{open:t,onOpenChange:r,children:e.jsxs(ge,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(fe,{children:[e.jsx(be,{children:"Exception"}),e.jsx(je,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:g,onChange:m=>f(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Type"}),e.jsxs(Ot,{value:x,onValueChange:m=>_(m),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ge,{value:"cancelled",id:"ovr-cancelled"}),e.jsx(E,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ge,{value:"modified",id:"ovr-modified"}),e.jsx(E,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),x==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:p,onChange:m=>u(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:y,onChange:m=>C(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(le,{id:"ovr-location",value:S,onChange:m=>N(m.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(le,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:l,onChange:m=>v(m.target.value)})]}),e.jsx(P,{className:"w-full",onClick:M,disabled:j.isPending||!g,children:j.isPending?"Enregistrement...":"Enregistrer"})]})]})})},ns=({slot:t,instance:r,hasOverrides:a,cancelled:c=!1,onSelect:b})=>{const g=Te(t.start_time),f=ts(t.start_time,t.end_time),x=f<50,_=Ee(t.location),p=!!r?.assignment,u=r?.state==="draft",y=r?.state==="published",C=c?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":y?"bg-emerald-500/12 border-emerald-500/30 hover:bg-emerald-500/18":u?"bg-amber-500/12 border-amber-500/30 hover:bg-amber-500/18":_?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",S=y?"text-emerald-600 dark:text-emerald-400":u?"text-amber-600 dark:text-amber-400":_?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${C}`,style:{top:g,height:f,minHeight:24},onClick:()=>b(t),title:`${K(t.start_time)}–${K(t.end_time)} · ${t.location}${r?.assignment?.session_name?` · ${r.assignment.session_name}`:""}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${x?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx(Pe,{className:`h-2.5 w-2.5 shrink-0 ${S}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:t.location}),a&&!c&&e.jsx(st,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),!x&&t.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:t.assignments.map(N=>e.jsx(Ae,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:N.group_name},N.id))}),!x&&f>=70&&t.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(t.assignments.map(N=>N.coach_name))].join(", ")}),!x&&p&&e.jsx("span",{className:`text-[9px] truncate ${u?"text-amber-700 dark:text-amber-300":"text-emerald-700 dark:text-emerald-300"}`,children:r?.assignment?.session_name??"Séance"})]})})};function is(t,r){const a=G(r)-G(t),c=Math.floor(a/60),b=a%60;return c===0?`${b}min`:b===0?`${c}h`:`${c}h${String(b).padStart(2,"0")}`}const ls=({slotsByDay:t,slotInstancesById:r,weekDates:a,todayStr:c,overridesBySlot:b,cancelledSlotIds:g,onSelect:f,onPrevWeek:x,onNextWeek:_,weekNumber:p})=>{const[u,y]=o.useState(()=>{const l=a.findIndex(v=>Q(v)===c);return l>=0?l+1:1});o.useEffect(()=>{const l=a.findIndex(v=>Q(v)===c);l>=0?y(l+1):y(1)},[a,c]);const C=t.get(u)??[],S=o.useMemo(()=>{let l=22,v=6;return t.forEach(j=>{for(const M of j){const m=Math.floor(G(M.start_time)/60),T=Math.ceil(G(M.end_time)/60);m<l&&(l=m),T>v&&(v=T)}}),l>=v?{start:6,end:22}:{start:Math.max(0,l),end:Math.min(24,v)}},[t]),N=(S.end-S.start)*60;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:x,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",p]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[ie(a[0])," – ",ie(a[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:_,children:e.jsx(pt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border bg-card overflow-hidden",children:a.map((l,v)=>{const j=v+1,M=Q(l)===c,m=j===u,T=t.get(j)??[];return e.jsxs("button",{type:"button",className:`flex flex-col items-center py-2 transition-colors relative ${m?"bg-primary/8":"hover:bg-muted/50 active:bg-muted"}`,onClick:()=>y(j),children:[e.jsx("span",{className:`text-[10px] font-semibold uppercase tracking-wider ${M?"text-primary":"text-muted-foreground"}`,children:Zt[v]}),e.jsx("span",{className:`text-sm font-bold tabular-nums mt-0.5 h-10 w-10 flex items-center justify-center rounded-full ${M?"bg-primary text-primary-foreground":m?"text-foreground":"text-foreground/80"}`,children:l.getDate()}),e.jsx("div",{className:"w-full px-1 mt-1.5 h-8 relative",children:T.map(F=>{const D=G(F.start_time)-S.start*60,w=G(F.end_time)-S.start*60,q=Math.max(0,D/N*100),$=Math.max(8,(w-D)/N*100),A=Ee(F.location),R=g.has(F.id),L=r.get(F.id),B=L?.state==="published",k=L?.state==="draft";return e.jsx("div",{className:`absolute left-1 right-1 rounded-sm ${R?"bg-muted-foreground/20":B?"bg-emerald-500/50":k?"bg-amber-500/50":A?"bg-blue-500/40":"bg-amber-400/50"}`,style:{top:`${q}%`,height:`${$}%`,minHeight:"3px"}},F.id)})}),m&&e.jsx("div",{className:"absolute bottom-0 left-2 right-2 h-0.5 rounded-full bg-primary"})]},j)})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground px-0.5",children:[Ie[u-1]," ",a[u-1]?.getDate()," ",e.jsx("span",{className:"font-normal text-muted-foreground",children:a[u-1]?.toLocaleDateString("fr-FR",{month:"long"})})]}),C.length===0?e.jsx("div",{className:"rounded-xl border border-dashed border-border/60 bg-muted/20 py-8 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun créneau"})}):e.jsx("div",{className:"space-y-2",children:C.map(l=>{const v=Ee(l.location),j=g.has(l.id),M=b.get(l.id)??[],m=M.length>0,T=r.get(l.id),F=T?.state==="published",D=T?.state==="draft";return e.jsx("button",{type:"button",className:`w-full text-left rounded-xl border bg-card transition-all active:scale-[0.98] ${j?"opacity-50 border-border":"border-border hover:border-border/80"}`,onClick:()=>f(l),children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`w-1 rounded-l-xl flex-shrink-0 ${j?"bg-muted-foreground/30":v?"bg-blue-500":"bg-amber-400"}`}),e.jsxs("div",{className:"flex-1 px-3 py-2.5 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`text-sm font-bold tabular-nums ${j?"line-through text-muted-foreground":"text-foreground"}`,children:[K(l.start_time)," – ",K(l.end_time)]}),e.jsx("span",{className:`text-xs tabular-nums px-1.5 py-0.5 rounded-md font-medium ${v?"bg-blue-500/10 text-blue-600 dark:text-blue-400":"bg-amber-400/10 text-amber-600 dark:text-amber-400"}`,children:is(l.start_time,l.end_time)})]}),m&&!j&&e.jsx(st,{className:"h-3.5 w-3.5 text-orange-500 flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[e.jsx(Pe,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:l.location})]}),T?.assignment?.session_name&&e.jsxs("div",{className:"mt-1.5 flex items-center gap-1.5",children:[e.jsx("span",{className:`inline-flex rounded-md px-1.5 py-0.5 text-[10px] font-semibold ${D?"bg-amber-500/10 text-amber-700 dark:text-amber-300":F?"bg-emerald-500/10 text-emerald-700 dark:text-emerald-300":"bg-muted text-muted-foreground"}`,children:D?"Brouillon":"Publié"}),e.jsx("span",{className:"truncate text-xs font-medium text-foreground",children:T.assignment.session_name})]}),l.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1.5",children:l.assignments.map(w=>e.jsxs("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded-md bg-muted text-muted-foreground",children:[w.group_name,w.coach_name?` · ${w.coach_name.split(" ")[0]}`:"",w.lane_count?` · ${w.lane_count}L`:""]},w.id))}),m&&!j&&e.jsx("div",{className:"mt-1.5 space-y-0.5",children:M.slice(0,2).map(w=>e.jsxs("div",{className:"flex items-center gap-1 text-[10px]",children:[e.jsxs("span",{className:`font-medium ${w.status==="cancelled"?"text-red-500":"text-orange-500"}`,children:[w.status==="cancelled"?"Annulé":"Modifié"," le"," ",new Date(w.override_date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})]}),w.reason&&e.jsxs("span",{className:"text-muted-foreground truncate",children:["— ",w.reason]})]},w.id))})]})]})},l.id)})})]})]})},Qs=({onBack:t,groups:r,onOpenLibrary:a})=>{const{toast:c}=$e(),b=he(),{userId:g}=$t(),[f,x]=o.useState(!1),[_,p]=o.useState(null),[u,y]=o.useState(null),[C,S]=o.useState(!1),[N,l]=o.useState(null),[v,j]=o.useState(!1),[M,m]=o.useState(!1),[T,F]=o.useState(null),[D,w]=o.useState(()=>Xe(new Date)),q=o.useMemo(()=>ss(D),[D]),$=o.useMemo(()=>{const s=new Date(D);return s.setDate(s.getDate()+6),s},[D]),A=o.useMemo(()=>Array.from({length:7},(s,i)=>{const h=new Date(D);return h.setDate(h.getDate()+i),h}),[D]),R=()=>w(s=>{const i=new Date(s);return i.setDate(i.getDate()-7),i}),L=()=>w(s=>{const i=new Date(s);return i.setDate(i.getDate()+7),i}),B=()=>w(Xe(new Date)),[k,n]=o.useState("all"),{data:d=[],isLoading:V}=H({queryKey:["training-slots"],queryFn:()=>I.getTrainingSlots()}),{data:de=[]}=H({queryKey:["training-slot-overrides"],queryFn:()=>I.getSlotOverrides()}),{data:W=[]}=H({queryKey:["users","coaches"],queryFn:()=>I.listUsers({role:"coach"})}),{data:Y=[]}=H({queryKey:["athletes"],queryFn:()=>I.getAthletes()}),O=k.startsWith("swimmer:")?Number(k.split(":")[1]):null,{data:Ne}=H({queryKey:["swimmer-slots",O],queryFn:()=>I.getSwimmerSlots(O),enabled:O!=null}),{data:ye}=H({queryKey:["swimmer-slots-exists",O],queryFn:()=>I.hasCustomSlots(O),enabled:O!=null}),we=o.useMemo(()=>Ne?Ne.map(s=>({id:s.id,day_of_week:s.day_of_week,start_time:s.start_time,end_time:s.end_time,location:s.location,is_active:s.is_active,created_by:s.created_by,created_at:s.created_at,assignments:[]})):[],[Ne]),ce=o.useMemo(()=>{if(k==="all")return d;if(k.startsWith("group:")){const s=Number(k.split(":")[1]);return d.filter(i=>i.assignments.some(h=>h.group_id===s))}if(k.startsWith("coach:")){const s=Number(k.split(":")[1]);return d.filter(i=>i.assignments.some(h=>h.coach_id===s))}if(k.startsWith("swimmer:")){if(ye&&we.length>0)return we;const s=Y.find(i=>i.id===O);return s?.group_id?d.filter(i=>i.assignments.some(h=>h.group_id===s.group_id)):d}return d},[d,k,ye,we,Y,O]),Le=o.useMemo(()=>{const s=new Map;for(let i=1;i<=7;i++)s.set(i,[]);for(const i of ce)s.get(i.day_of_week).push(i);for(const i of s.values())i.sort((h,X)=>h.start_time.localeCompare(X.start_time));return s},[ce]),me=Q(D),ue=Q($),{data:Ve=[]}=H({queryKey:["slot-assignments",me,ue],queryFn:()=>I.getSlotAssignments({from:me,to:ue})}),J=o.useMemo(()=>de.filter(s=>s.override_date>=me&&s.override_date<=ue),[de,me,ue]),ze=o.useMemo(()=>{const s=new Map;for(const i of J){const h=s.get(i.slot_id)??[];h.push(i),s.set(i.slot_id,h)}return s},[J]),Re=o.useMemo(()=>{const s=new Set;for(const i of J)i.status==="cancelled"&&s.add(i.slot_id);return s},[J]),Oe=o.useMemo(()=>{const s=new Map;for(const i of Ve){if(!i.training_slot_id)continue;const h=`${i.training_slot_id}:${i.scheduled_date}`;s.has(h)||s.set(h,i)}return s},[Ve]),Se=o.useMemo(()=>{const s=new Map,i=ke();for(const h of ce){const X=A[h.day_of_week-1];if(!X)continue;const Ce=Q(X),Ke=J.find(We=>We.slot_id===h.id&&We.override_date===Ce),Be=Oe.get(`${h.id}:${Ce}`),kt=Ke?.status==="cancelled"?"cancelled":Wt(Be,i);s.set(h.id,{date:Ce,slot:h,groups:h.assignments,state:kt,assignment:Be,override:Ke})}return s},[Oe,ce,A,J]),_e=()=>{p(null),x(!0)},ft=s=>{l(s),j(!0)},He=s=>{const i=Se.get(s.id);i&&ft(i)},bt=s=>{p(s.slot),x(!0)},jt=s=>{y(s.slot),S(!0)},vt=s=>{a&&(j(!1),a(Ze(s,"create")))},Nt=s=>{if(a){if(j(!1),!N){a();return}a(Ze(N,"edit",s))}},yt=s=>{F(s),j(!1),m(!0)},wt=U({mutationFn:async({catalogId:s,instance:i})=>{const h=i.groups.map(X=>X.group_id);!g||h.length===0||await I.bulkCreateSlotAssignments({swimCatalogId:s,trainingSlotId:i.slot.id,scheduledDate:i.date,groupIds:h,scheduledSlot:Ft(i.slot.start_time),visibleFrom:i.date,assignedBy:g})},onSuccess:()=>{b.invalidateQueries({queryKey:["slot-assignments"]}),m(!1),F(null)},onError:s=>{c({title:"Erreur",description:s.message,variant:"destructive"})}}),St=s=>{T&&wt.mutate({catalogId:s,instance:T})},_t=W.map(s=>({id:s.id,display_name:s.display_name})),Ct=d.length===0?"Planning hebdomadaire des entrainements.":`${d.length} creneau${d.length>1?"x":""}`;return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{variant:"ghost",size:"icon",className:"h-10 w-10 -ml-2",onClick:t,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),d.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[d.length," créneau",d.length>1?"x":""," actif",d.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a&&e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full border border-border bg-card text-primary active:scale-90 transition-all",onClick:()=>a(),"aria-label":"Ouvrir la bibliothèque",children:e.jsx(Me,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:_e,children:e.jsx(te,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(At,{title:"Creneaux",description:Ct,onBack:t,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[a&&e.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>a(),children:[e.jsx(Me,{className:"mr-1.5 h-3.5 w-3.5"}),"Bibliothèque"]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:_e,children:[e.jsx(te,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})]})})}),!V&&d.length>0&&e.jsx("div",{className:"sm:hidden",children:e.jsxs(se,{value:k,onValueChange:n,children:[e.jsx(re,{className:"w-full",children:e.jsx(ae,{placeholder:"Filtrer..."})}),e.jsxs(ne,{children:[e.jsx(z,{value:"all",children:"Tous les créneaux"}),e.jsx(ee,{}),r.map(s=>e.jsx(z,{value:`group:${s.id}`,children:s.name},s.id)),Y.length>0&&e.jsx(ee,{}),Y.map(s=>e.jsx(z,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(P,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:R,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:B,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",q]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[ie(D)," – ",ie($)]})]}),e.jsx(P,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:L,children:e.jsx(pt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-row items-center gap-3",children:e.jsxs(se,{value:k,onValueChange:n,children:[e.jsx(re,{className:"w-56",children:e.jsx(ae,{placeholder:"Filtrer..."})}),e.jsxs(ne,{children:[e.jsx(z,{value:"all",children:"Tous les créneaux"}),e.jsx(ee,{}),r.map(s=>e.jsx(z,{value:`group:${s.id}`,children:s.name},s.id)),W.length>0&&e.jsx(ee,{}),W.map(s=>e.jsx(z,{value:`coach:${s.id}`,children:s.display_name},s.id)),Y.length>0&&e.jsx(ee,{}),Y.map(s=>e.jsx(z,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})})]}),V?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-28 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border overflow-hidden",children:Array.from({length:7},(s,i)=>e.jsxs("div",{className:"flex flex-col items-center py-2 gap-1",children:[e.jsx("div",{className:"h-3 w-6 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-5 rounded bg-muted/50 animate-pulse motion-reduce:animate-none mt-1"})]},i))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),Array.from({length:3},(s,i)=>e.jsx("div",{className:"h-20 rounded-xl bg-muted animate-pulse motion-reduce:animate-none"},i))]})]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(s,i)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},i))})]}):d.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(mt,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:_e,children:[e.jsx(te,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[O!=null&&ye===!1&&e.jsx("div",{className:"rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/30 px-3 py-2 text-sm text-blue-700 dark:text-blue-300",children:"Ce nageur hérite des créneaux du groupe. Personnalisez depuis sa fiche."}),e.jsx("div",{className:"sm:hidden",children:e.jsx(ls,{slotsByDay:Le,slotInstancesById:Se,weekDates:A,todayStr:ke(),overridesBySlot:ze,cancelledSlotIds:Re,onSelect:He,onPrevWeek:R,onNextWeek:L,weekNumber:q})}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",A.map((s,i)=>{const h=Q(s)===ke();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:Ie[i]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${h?"text-primary font-bold":"text-muted-foreground/60"}`,children:ie(s)})]},i)}),e.jsx("div",{className:"relative",style:{height:Ye},children:Je.map(s=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(s-oe)*xe},children:[s,"h"]},s))}),Array.from({length:7},(s,i)=>i+1).map(s=>{const i=Le.get(s)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:Ye},children:[Je.map(h=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(h-oe)*xe}},h)),i.map(h=>e.jsx(ns,{slot:h,instance:Se.get(h.id),hasOverrides:(ze.get(h.id)??[]).length>0,cancelled:Re.has(h.id),onSelect:He},h.id))]},s)})]})})]}),e.jsx(Qt,{instance:N,open:v,onOpenChange:j,onCreateNew:vt,onEditSession:Nt,onPickTemplate:yt,onEditSlot:bt,onManageOverride:jt}),e.jsx(rs,{open:f,onOpenChange:x,slot:_,groups:r,coaches:_t}),e.jsx(as,{open:C,onOpenChange:S,slot:u}),e.jsx(Xt,{open:M,onOpenChange:m,onSelect:(s,i)=>St(s)})]})};export{Qs as default};
