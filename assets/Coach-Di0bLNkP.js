const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StrengthCatalog-PYz_N7IB.js","assets/vendor-query-BiSH4r2z.js","assets/vendor-react-BzrpNAyj.js","assets/api-BR6TazbR.js","assets/index-Cj4Ssg6c.js","assets/vendor-supabase-DFPLkPj_.js","assets/index-BgHuR7Fp.css","assets/swim-BRZGi7hR.js","assets/index-BLOzPm8x.js","assets/index-CIGIQmJa.js","assets/select-C9aM40lX.js","assets/chevron-down-BzK_i_NW.js","assets/check-BQQC0n9Y.js","assets/chevron-up-CFtM4TB2.js","assets/CalendarGrid-l6y2skX7.js","assets/chevron-left-D119ORtr.js","assets/chevron-right-1Cy1mjxI.js","assets/objectiveHelpers-cQSzFl2O.js","assets/dialog-BVKIxHC0.js","assets/index-Ba1F2bSJ.js","assets/checkbox-CmknXMsT.js","assets/alert-dialog-4FKKroIb.js","assets/tabs-CmUf_qDL.js","assets/SessionListView-B_hbcc1x.js","assets/play-xx2l414G.js","assets/save-CHVoxal5.js","assets/circle-alert-CoK70hgh.js","assets/pencil-CAuBc6VU.js","assets/trash-2-DpQdiJwt.js","assets/drawer-BEsylY0X.js","assets/search-DBwJkX1N.js","assets/plus-CA-2uVIx.js","assets/loader-circle-Bn3uL7ce.js","assets/pen-CiXeaM0b.js","assets/SwimCatalog-CcscVBC2.js","assets/SwimSessionTimeline-Cv01ySFf.js","assets/swimConsultationUtils-DnfuTvlj.js","assets/timer-BOz96-p8.js","assets/eye-BExknJnN.js","assets/clock-Hd18AIvF.js","assets/format-B9mPVj_w.js","assets/share-2-C-vmb3cq.js"])))=>i.map(i=>d[i]);
import{c as ce,B as A,d as J,C as De,i as Ae,k as Fe,l as qe,g as Te,L as $,I as le,W as Ye,D as We,R as os,U as oe,m as cs,n as ds,T as ze,s as Je,u as Ie,b as us,P as Ge,o as ms,_ as Xe}from"./index-Cj4Ssg6c.js";import{j as e,r as i,u as O,c as de,d as G}from"./vendor-query-BiSH4r2z.js";import{a as M}from"./api-BR6TazbR.js";import{B as W}from"./badge-KfTYW2c-.js";import{T as Oe,a as ne}from"./toggle-group-BvoEHKCA.js";import{A as Ce,T as Ze,a as Ee,e as es,f as ss,F as xs,p as Ve}from"./objectiveHelpers-cQSzFl2O.js";import{S as X,a as Z,b as ee,c as se,d as V}from"./select-C9aM40lX.js";import{a as ps,b as hs,P as gs}from"./CalendarGrid-l6y2skX7.js";import{S as be,a as Ne,b as we,c as Se,d as Pe,A as xe,e as pe,f as he,g as ge,h as je,i as fe,j as ve,k as ye}from"./alert-dialog-4FKKroIb.js";import{T as ts}from"./trash-2-DpQdiJwt.js";import{C as ns}from"./checkbox-CmknXMsT.js";import{S as js}from"./separator-trs6Cz6l.js";import{C as fs,a as vs,b as ys}from"./collapsible-45-oniO7.js";import{P as re}from"./plus-CA-2uVIx.js";import{U as bs,a as Ns}from"./user-plus-BOIXahMl.js";import{C as ws}from"./chevron-down-BzK_i_NW.js";import{S as Ss}from"./switch-BPYu5lll.js";import{M as Cs}from"./map-pin-Bz-251OY.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./swim-BRZGi7hR.js";import"./index-BLOzPm8x.js";import"./index-CIGIQmJa.js";import"./check-BQQC0n9Y.js";import"./chevron-up-CFtM4TB2.js";import"./chevron-left-D119ORtr.js";import"./chevron-right-1Cy1mjxI.js";import"./index-Ba1F2bSJ.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _s=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],Le=ce("calendar-days",_s);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ks=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],Ms=ce("external-link",ks);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ds=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}],["path",{d:"M3.22 13H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27",key:"auskq0"}]],As=ce("heart-pulse",Ds);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],$e=ce("mail",Fs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qs=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],Ts=ce("message-square",qs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zs=[["path",{d:"M18 21a8 8 0 0 0-16 0",key:"3ypg7q"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3",key:"10s06x"}]],as=ce("users-round",zs),ae=({title:s,description:a,onBack:r,actions:n})=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:r,children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Retour"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:s}),a?e.jsx("p",{className:"text-sm text-muted-foreground",children:a}):null]}),n?e.jsx("div",{className:"flex items-center gap-2",children:n}):null]}),Es=({onBack:s,athletes:a,groups:r,athletesLoading:n})=>{const{toast:l}=J(),[b,h]=i.useState(""),[c,m]=i.useState(""),x=i.useMemo(()=>a.filter(t=>t.id&&t.email).map(t=>({value:`user:${t.id}`,label:t.group_label?`${t.display_name} · ${t.group_label}`:t.display_name,email:t.email})),[a]),g=i.useMemo(()=>r.map(t=>({value:`group:${t.id}`,label:t.name,id:t.id})),[r]),d=()=>{if(!c)return[];if(c.startsWith("user:")){const t=x.find(u=>u.value===c);return t?[t.email]:[]}if(c.startsWith("group:")){const t=Number(c.split(":")[1]);return a.filter(u=>u.group_id===t&&u.email).map(u=>u.email)}return[]},y=()=>{const t=d();if(!t.length){l({title:"Aucune adresse email",description:"Aucun nageur avec une adresse email dans cette sélection."});return}const u=new URLSearchParams;u.set("bcc",t.join(",")),b.trim()&&u.set("subject",b.trim()),window.location.href=`mailto:?${u.toString()}`},S=d();return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ae,{title:"Contacter par email",description:"Ouvre votre application mail avec les destinataires en CCI.",onBack:s}),e.jsxs(De,{className:"border-l-4 border-l-primary",children:[e.jsxs(Ae,{children:[e.jsx(Fe,{children:"Destinataire"}),e.jsx(qe,{children:"Sélectionnez un nageur ou un groupe."})]}),e.jsxs(Te,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Destinataire"}),e.jsxs(X,{value:c,onValueChange:m,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:n?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(se,{children:[g.length?e.jsxs(e.Fragment,{children:[e.jsx(V,{value:"section-group",disabled:!0,children:"Groupes"}),g.map(t=>e.jsx(V,{value:t.value,children:t.label},t.value))]}):null,x.length?e.jsxs(e.Fragment,{children:[e.jsx(V,{value:"section-athlete",disabled:!0,children:"Nageurs"}),x.map(t=>e.jsx(V,{value:t.value,children:t.label},t.value))]}):null]})]})]}),c&&S.length>0?e.jsxs("p",{className:"text-xs text-muted-foreground",children:[S.length," adresse",S.length>1?"s":""," email",S.length>1?" (envoi en CCI)":""]}):null,c&&S.length===0?e.jsx("p",{className:"text-xs text-destructive",children:"Aucune adresse email disponible pour cette sélection."}):null]})]}),e.jsxs(De,{children:[e.jsxs(Ae,{children:[e.jsx(Fe,{children:"Objet"}),e.jsx(qe,{children:"Optionnel — pré-rempli dans votre application mail."})]}),e.jsx(Te,{children:e.jsx(le,{value:b,onChange:t=>h(t.target.value),placeholder:"Objet du mail…"})})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsxs(A,{className:"w-full sm:w-auto",onClick:y,disabled:!c||S.length===0,children:[e.jsx($e,{className:"mr-2 h-4 w-4"}),"Ouvrir dans l'app mail",e.jsx(Ms,{className:"ml-2 h-3 w-3"})]})})]})};function Be(s){return String(s).padStart(2,"0")}function ie(s){return`${s.getFullYear()}-${Be(s.getMonth()+1)}-${Be(s.getDate())}`}function _e(s){return new Date(s.getFullYear(),s.getMonth(),1)}function Qe(s,a){const r=new Date(s);return r.setDate(r.getDate()+a),r}function Ls(s){return(s.getDay()+6)%7}function ke(s){if(!s)return"AM";const a=s.toLowerCase();return a==="evening"||a.includes("soir")||a==="pm"?"PM":"AM"}const Os=[{key:"swim-morning",label:"Nage — Matin",type:"swim",scheduledSlot:"morning"},{key:"swim-evening",label:"Nage — Soir",type:"swim",scheduledSlot:"evening"},{key:"strength",label:"Musculation",type:"strength",scheduledSlot:null}];function Ps({groupId:s,userId:a,enabled:r}){const n=i.useMemo(()=>new Date,[]),[l,b]=i.useState(()=>_e(new Date)),[h,c]=i.useState(()=>ie(new Date)),[m,x]=i.useState(null),[g,d]=i.useState(!1),y=i.useMemo(()=>_e(l),[l]),S=i.useMemo(()=>{const C=Ls(y),o=Qe(y,-C),k=[];for(let T=0;T<42;T++)k.push(Qe(o,T));return k},[y]),t=i.useMemo(()=>{const C=ie(S[0]),o=ie(S[S.length-1]);return{from:C,to:o}},[S]),u=!!(s||a),{data:_=[],isLoading:j}=O({queryKey:["coach-calendar-assignments",s,a,t.from,t.to],queryFn:()=>M.getCoachAssignments({groupId:s??null,userId:a??null,from:t.from,to:t.to}),enabled:u}),f=i.useMemo(()=>{const C=new Map;for(const o of _){const k=o.scheduledDate?.slice(0,10);k&&(C.has(k)||C.set(k,[]),C.get(k).push(o))}return C},[_]),z=i.useMemo(()=>{const C={};for(const o of S){const k=ie(o),T=f.get(k)??[],U=T.some(P=>ke(P.scheduledSlot)==="AM"),N=T.some(P=>ke(P.scheduledSlot)==="PM"),I=(U?1:0)+(N?1:0),B=[{slotKey:"AM",expected:U,completed:U,absent:!1},{slotKey:"PM",expected:N,completed:N,absent:!1}];C[k]={completed:I,total:I,slots:B}}return C},[S,f]),F=i.useMemo(()=>{const[C,o,k]=h.split("-").map(Number);return new Date(C,o-1,k)},[h]),D=i.useMemo(()=>f.get(h)??[],[f,h]),E=i.useMemo(()=>{const C=D;return Os.map(o=>{const k=C.filter(N=>o.type!==N.type?!1:o.type==="swim"?ke(N.scheduledSlot)===(o.scheduledSlot==="morning"?"AM":"PM"):!0),T=k.find(N=>N.targetType==="user"),U=k.find(N=>N.targetType==="group");return{...o,assignment:T??U??null}})},[D]),{data:q=[]}=O({queryKey:["planned-absences-coach",a,t.from,t.to],queryFn:()=>M.getPlannedAbsences({userId:a,from:t.from,to:t.to}),enabled:!!a}),w=i.useMemo(()=>new Set(q.map(C=>C.date)),[q]),p=i.useMemo(()=>{const C={};for(const o of S){const k=ie(o),T=f.get(k)??[];C[k]=T.some(U=>U.type==="strength")}return C},[S,f]),K=z[h]??{completed:0,total:0,slots:[{slotKey:"AM",expected:!1,completed:!1,absent:!1},{slotKey:"PM",expected:!1,completed:!1,absent:!1}]},R=i.useCallback(()=>{b(C=>new Date(C.getFullYear(),C.getMonth()-1,1))},[]),Y=i.useCallback(()=>{b(C=>new Date(C.getFullYear(),C.getMonth()+1,1))},[]),Q=i.useCallback(()=>{b(_e(new Date)),c(ie(new Date))},[]),v=i.useCallback(C=>{c(C),d(!0)},[]);return{today:n,monthCursor:l,selectedISO:h,selectedDayIndex:m,drawerOpen:g,gridDates:S,completionByISO:z,selectedDate:F,selectedDayStatus:K,assignmentsForSelectedDay:D,slotsForSelectedDay:E,hasStrengthByISO:p,absenceDates:w,isLoading:j,hasFilter:u,setSelectedISO:c,setSelectedDayIndex:x,setDrawerOpen:d,prevMonth:R,nextMonth:Y,jumpToday:Q,openDay:v}}function $s(s){const[a,r,n]=s.split("-").map(Number);return new Date(a,r-1,n).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})}function Ks({onBack:s,athletes:a,groups:r,swimSessions:n,strengthSessions:l}){const[b,h]=i.useState("group"),[c,m]=i.useState(""),[x,g]=i.useState(""),d=b==="group"&&c?Number(c):null,y=b==="user"&&x?Number(x):null,{today:S,monthCursor:t,selectedISO:u,selectedDayIndex:_,drawerOpen:j,gridDates:f,completionByISO:z,selectedDayStatus:F,slotsForSelectedDay:D,hasStrengthByISO:E,absenceDates:q,hasFilter:w,setSelectedISO:p,setSelectedDayIndex:K,setDrawerOpen:R,prevMonth:Y,nextMonth:Q,jumpToday:v,openDay:C}=Ps({groupId:d,userId:y,enabled:!0}),o=de(),k=G({mutationFn:N=>M.assignments_create(N),onSuccess:()=>{o.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),T=G({mutationFn:N=>M.assignments_delete(N),onSuccess:()=>{o.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),U=(N,I)=>{let B=I;if(N.key==="ArrowLeft"&&(B=Math.max(0,I-1)),N.key==="ArrowRight"&&(B=Math.min(f.length-1,I+1)),N.key==="ArrowUp"&&(B=Math.max(0,I-7)),N.key==="ArrowDown"&&(B=Math.min(f.length-1,I+7)),B!==I){N.preventDefault(),K(B);const P=me=>String(me).padStart(2,"0"),H=f[B],ue=`${H.getFullYear()}-${P(H.getMonth()+1)}-${P(H.getDate())}`;p(ue)}if(N.key==="Enter"||N.key===" "){N.preventDefault();const P=me=>String(me).padStart(2,"0"),H=f[I],ue=`${H.getFullYear()}-${P(H.getMonth()+1)}-${P(H.getDate())}`;C(ue)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{title:"Calendrier",description:"Vue mensuelle des assignations",onBack:s}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsxs(Oe,{type:"single",value:b,onValueChange:N=>{(N==="group"||N==="user")&&h(N)},className:"shrink-0",children:[e.jsx(ne,{value:"group",className:"text-xs px-3",children:"Groupe"}),e.jsx(ne,{value:"user",className:"text-xs px-3",children:"Nageur"})]}),b==="group"?e.jsxs(X,{value:c,onValueChange:m,children:[e.jsx(Z,{className:"w-full sm:w-56",children:e.jsx(ee,{placeholder:"Choisir un groupe"})}),e.jsx(se,{children:r.map(N=>e.jsx(V,{value:String(N.id),children:N.name},String(N.id)))})]}):e.jsxs(X,{value:x,onValueChange:g,children:[e.jsx(Z,{className:"w-full sm:w-56",children:e.jsx(ee,{placeholder:"Choisir un nageur"})}),e.jsx(se,{children:a.filter(N=>N.id!=null).map(N=>e.jsxs(V,{value:String(N.id),children:[N.display_name,N.group_label?` · ${N.group_label}`:""]},String(N.id)))})]})]}),w?e.jsxs("div",{className:"rounded-2xl border bg-card shadow-sm",children:[e.jsx(ps,{monthCursor:t,selectedDayStatus:F,onPrevMonth:Y,onNextMonth:Q,onJumpToday:v}),e.jsx(hs,{monthCursor:t,gridDates:f,completionByISO:z,strengthByISO:E,absenceDates:q,selectedISO:u,selectedDayIndex:_,today:S,onDayClick:C,onKeyDown:U})]}):e.jsx("div",{className:"py-12 text-center text-sm text-muted-foreground",children:"Sélectionnez un groupe ou un nageur pour afficher le calendrier."}),e.jsx(be,{open:j,onOpenChange:R,children:e.jsxs(Ne,{side:"bottom",className:"max-h-[70vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(we,{className:"pb-3",children:[e.jsx(Se,{className:"capitalize text-left",children:$s(u)}),e.jsx(Pe,{className:"sr-only",children:"Gérer les assignations pour cette journée"})]}),e.jsxs("div",{className:"space-y-3",children:[q.has(u)&&e.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-900/40 px-3 py-2 flex items-center gap-2",children:e.jsx("span",{className:"text-[10px] font-bold text-red-500 uppercase tracking-wide",children:"Absence prévue"})}),D.map(N=>{const I=N.assignment?.targetType==="group",B=b==="user";return e.jsx(Rs,{slot:N,swimSessions:n,strengthSessions:l,isGroupAssignment:I&&B,onAssign:P=>{k.mutate({assignment_type:N.type,session_id:P,scheduled_date:u,scheduled_slot:N.scheduledSlot??void 0,target_group_id:d,target_user_id:y})},onDelete:P=>{T.mutate(P)},onReplace:(P,H)=>{I&&B?k.mutate({assignment_type:N.type,session_id:H,scheduled_date:u,scheduled_slot:N.scheduledSlot??void 0,target_user_id:y}):T.mutate(P,{onSuccess:()=>{k.mutate({assignment_type:N.type,session_id:H,scheduled_date:u,scheduled_slot:N.scheduledSlot??void 0,target_group_id:d,target_user_id:y})}})},isPending:k.isPending||T.isPending},N.key)})]})]})})]})}function Rs({slot:s,swimSessions:a,strengthSessions:r,isGroupAssignment:n,onAssign:l,onDelete:b,onReplace:h,isPending:c}){const[m,x]=i.useState(!1),g=s.type==="swim",d=g?(a??[]).map(t=>({id:t.id,label:t.name})):(r??[]).map(t=>({id:t.id,label:t.title})),y=s.assignment!==null,S=t=>{const u=Number(t);u&&(y&&m?(h(s.assignment.id,u),x(!1)):l(u))};return e.jsxs("div",{className:"rounded-xl border p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[g?e.jsx(Ye,{className:"h-4 w-4 text-blue-500 shrink-0"}):e.jsx(We,{className:"h-4 w-4 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:s.label})]}),y&&!m?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-sm font-semibold truncate flex-1",children:[s.assignment.title,n&&e.jsx("span",{className:"ml-1.5 text-[10px] font-medium text-muted-foreground bg-muted px-1.5 py-0.5 rounded-full align-middle",children:"Groupe"})]}),e.jsx(A,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0",disabled:c,onClick:()=>x(!0),title:n?"Personnaliser":"Changer",children:e.jsx(os,{className:"h-3.5 w-3.5"})}),!n&&e.jsx(A,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0 text-destructive hover:text-destructive",disabled:c,onClick:()=>b(s.assignment.id),title:"Supprimer",children:e.jsx(ts,{className:"h-3.5 w-3.5"})})]}):e.jsxs(X,{value:"",onValueChange:S,disabled:c||d.length===0,children:[e.jsx(Z,{className:"h-9 text-xs",children:e.jsx(ee,{placeholder:m?n?"Personnaliser pour ce nageur":"Choisir le remplacement":"Choisir une séance"})}),e.jsx(se,{children:d.map(t=>e.jsx(V,{value:String(t.id),children:t.label},t.id))})]}),m?e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground",onClick:()=>x(!1),children:"Annuler"}):null]})}const rs=({athletes:s,selected:a,onToggle:r,filterToUserIds:n})=>{const[l,b]=i.useState(""),h=i.useMemo(()=>{let m=s.filter(x=>x.id!=null);if(n&&(m=m.filter(x=>n.has(x.id))),l.trim()){const x=l.toLowerCase();m=m.filter(g=>g.display_name.toLowerCase().includes(x))}return m},[s,n,l]),c=i.useMemo(()=>{const m=new Map;for(const x of h){const g=x.group_label||"Sans groupe";m.has(g)||m.set(g,[]),m.get(g).push(x)}return[...m.entries()].sort(([x],[g])=>x.localeCompare(g,"fr"))},[h]);return e.jsxs("div",{className:"space-y-3",children:[e.jsx(le,{placeholder:"Rechercher un nageur...",value:l,onChange:m=>b(m.target.value)}),e.jsxs("div",{className:"max-h-[50vh] overflow-y-auto space-y-3",children:[c.map(([m,x])=>e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-1.5",children:m}),e.jsx("div",{className:"space-y-1",children:x.map(g=>e.jsxs("label",{className:"flex items-center gap-2.5 rounded-lg border px-3 py-2 cursor-pointer hover:bg-muted/50 transition-colors",children:[e.jsx(ns,{checked:a.has(g.id),onCheckedChange:()=>r(g.id)}),e.jsx("span",{className:"text-sm",children:g.display_name})]},g.id))})]},m)),c.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun nageur trouvé."})]}),a.size>0&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.size," nageur",a.size>1?"s":""," ","sélectionné",a.size>1?"s":""]})]})},is=({open:s,onOpenChange:a,athletes:r,parentGroupId:n,parentMembers:l,onCreated:b})=>{const{toast:h}=J(),[c,m]=i.useState(""),[x,g]=i.useState(new Set),d=t=>{g(u=>{const _=new Set(u);return _.has(t)?_.delete(t):_.add(t),_})},y=G({mutationFn:()=>M.createTemporaryGroup({name:c.trim(),member_user_ids:[...x],parent_group_id:n??void 0}),onSuccess:()=>{h({title:"Groupe créé",description:`Le groupe "${c.trim()}" a été créé avec ${x.size} nageur${x.size>1?"s":""}.`}),m(""),g(new Set),a(!1),b()},onError:t=>{h({title:"Erreur",description:t.message,variant:"destructive"})}}),S=()=>{if(!c.trim()){h({title:"Nom requis",description:"Veuillez saisir un nom pour le groupe.",variant:"destructive"});return}y.mutate()};return e.jsx(be,{open:s,onOpenChange:a,children:e.jsxs(Ne,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(we,{children:[e.jsx(Se,{children:n?"Créer un sous-groupe":"Créer un groupe"}),e.jsx(Pe,{children:n?"Sélectionnez des nageurs du groupe parent pour ce sous-groupe.":"Créez un groupe temporaire (stage, compétition) avec des nageurs de différents groupes."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"group-name",children:"Nom du groupe"}),e.jsx(le,{id:"group-name",placeholder:"Ex : Stage Pâques 2026",value:c,onChange:t=>m(t.target.value)})]}),e.jsx(js,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Nageurs"}),e.jsx(rs,{athletes:r,selected:x,onToggle:d,filterToUserIds:l??null})]}),e.jsx(A,{className:"w-full",onClick:S,disabled:y.isPending||!c.trim(),children:y.isPending?"Création...":"Créer le groupe"})]})]})})},Is=({open:s,onOpenChange:a,groupId:r,athletes:n,existingMemberIds:l,onAdded:b})=>{const{toast:h}=J(),[c,m]=i.useState(new Set),x=i.useMemo(()=>n.filter(y=>y.id!=null&&!l.has(y.id)),[n,l]),g=y=>{m(S=>{const t=new Set(S);return t.has(y)?t.delete(y):t.add(y),t})},d=G({mutationFn:()=>M.addTemporaryGroupMembers(r,[...c]),onSuccess:()=>{h({title:"Nageurs ajoutés",description:`${c.size} nageur${c.size>1?"s":""} ajouté${c.size>1?"s":""}.`}),m(new Set),a(!1),b()},onError:y=>{h({title:"Erreur",description:y.message,variant:"destructive"})}});return e.jsx(be,{open:s,onOpenChange:a,children:e.jsxs(Ne,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(we,{children:[e.jsx(Se,{children:"Ajouter des nageurs"}),e.jsx(Pe,{children:"Sélectionnez les nageurs à ajouter au groupe."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx(rs,{athletes:x,selected:c,onToggle:g}),e.jsx(A,{className:"w-full",onClick:()=>d.mutate(),disabled:d.isPending||c.size===0,children:d.isPending?"Ajout...":`Ajouter ${c.size} nageur${c.size>1?"s":""}`})]})]})})},Gs=({groupId:s,athletes:a,onBack:r})=>{const{toast:n}=J(),l=de(),[b,h]=i.useState(!1),[c,m]=i.useState(!1),[x,g]=i.useState(null),{data:d,isLoading:y}=O({queryKey:["temp-group-detail",s],queryFn:()=>M.getTemporaryGroupDetail(s)}),S=G({mutationFn:j=>M.removeTemporaryGroupMember(s,j),onSuccess:()=>{n({title:"Nageur retiré"}),l.invalidateQueries({queryKey:["temp-group-detail",s]}),l.invalidateQueries({queryKey:["temp-groups"]})},onError:j=>{n({title:"Erreur",description:j.message,variant:"destructive"})}}),t=()=>{l.invalidateQueries({queryKey:["temp-group-detail",s]}),l.invalidateQueries({queryKey:["temp-groups"]})},u=i.useMemo(()=>new Set((d?.members??[]).map(j=>j.user_id)),[d]),_=i.useMemo(()=>new Set((d?.members??[]).map(j=>j.user_id)),[d]);return y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:r,children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(j=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted"})},j))})]}):d?e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:r,children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:d.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{variant:d.is_active?"default":"secondary",children:d.is_active?"Actif":"Terminé"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[d.members.length," membre",d.members.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Membres"}),d.is_active&&e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>h(!0),children:[e.jsx(bs,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]}),d.members.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun membre dans ce groupe."}):e.jsx("div",{className:"space-y-1.5",children:d.members.map(j=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:j.display_name}),j.permanent_group_label&&e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0 mt-0.5",children:j.permanent_group_label})]}),d.is_active&&e.jsx(A,{size:"icon",variant:"ghost",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>g({userId:j.user_id,name:j.display_name}),title:"Retirer du groupe",children:e.jsx(Ns,{className:"h-4 w-4"})})]},j.user_id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Sous-groupes"}),d.is_active&&e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>m(!0),children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Sous-groupe"]})]}),d.subgroups.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun sous-groupe."}):e.jsx("div",{className:"space-y-2",children:d.subgroups.map(j=>e.jsxs(fs,{children:[e.jsxs(vs,{className:"flex w-full items-center justify-between rounded-xl border bg-card p-3 text-left hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-semibold",children:j.name}),e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:j.members.length})]}),e.jsx(ws,{className:"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]_&]:rotate-180"})]}),e.jsx(ys,{children:e.jsxs("div",{className:"ml-4 mt-1 space-y-1",children:[j.members.map(f=>e.jsx("div",{className:"flex items-center gap-2 rounded-lg border px-3 py-2",children:e.jsx("span",{className:"text-sm",children:f.display_name})},f.user_id)),j.members.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground py-2",children:"Aucun membre."})]})})]},j.id))})]}),e.jsx(Is,{open:b,onOpenChange:h,groupId:s,athletes:a,existingMemberIds:u,onAdded:t}),e.jsx(is,{open:c,onOpenChange:m,athletes:a,parentGroupId:s,parentMembers:_,onCreated:t}),e.jsx(xe,{open:!!x,onOpenChange:j=>{j||g(null)},children:e.jsxs(pe,{children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Retirer du groupe"}),e.jsxs(je,{children:["Voulez-vous retirer ",x?.name," de ce groupe ?",d.subgroups.length>0?" Le nageur sera aussi retiré des sous-groupes.":""]})]}),e.jsxs(fe,{children:[e.jsx(ve,{children:"Annuler"}),e.jsx(ye,{onClick:()=>{x&&(S.mutate(x.userId),g(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Retirer"})]})]})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(A,{variant:"ghost",size:"sm",className:"-ml-2",onClick:r,children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Groupe introuvable."})]})},Ue=({group:s,onManage:a,onDeactivate:r,onReactivate:n,onDelete:l})=>{const b=new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"});return e.jsxs("div",{className:"rounded-xl border bg-card p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-bold truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1 flex-wrap",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.member_count," membre",s.member_count!==1?"s":""]}),s.subgroup_count>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.subgroup_count," sous-groupe",s.subgroup_count!==1?"s":""]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:b})]})]}),e.jsx(W,{variant:s.is_active?"default":"secondary",children:s.is_active?"Actif":"Terminé"})]}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:s.is_active?e.jsxs(e.Fragment,{children:[e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>a(s.id),children:[e.jsx(cs,{className:"mr-1.5 h-3.5 w-3.5"}),"Gérer"]}),e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>r(s.id),children:[e.jsx(gs,{className:"mr-1.5 h-3.5 w-3.5"}),"Terminer"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(A,{size:"sm",variant:"outline",onClick:()=>n(s.id),children:[e.jsx(ds,{className:"mr-1.5 h-3.5 w-3.5"}),"Réactiver"]}),e.jsxs(A,{size:"sm",variant:"outline",className:"text-destructive hover:text-destructive",onClick:()=>l(s.id),children:[e.jsx(ts,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})})]})},Vs=({onBack:s,athletes:a,athletesLoading:r})=>{const{toast:n}=J(),l=de(),[b,h]=i.useState("list"),[c,m]=i.useState(null),[x,g]=i.useState(!1),[d,y]=i.useState(null),[S,t]=i.useState(null),{data:u=[],isLoading:_}=O({queryKey:["temp-groups"],queryFn:()=>M.getTemporaryGroups()}),j=i.useMemo(()=>u.filter(w=>w.is_active),[u]),f=i.useMemo(()=>u.filter(w=>!w.is_active),[u]),z=G({mutationFn:w=>M.deactivateTemporaryGroup(w),onSuccess:()=>{n({title:"Groupe terminé"}),l.invalidateQueries({queryKey:["temp-groups"]})},onError:w=>{n({title:"Erreur",description:w.message,variant:"destructive"})}}),F=G({mutationFn:w=>M.reactivateTemporaryGroup(w),onSuccess:()=>{n({title:"Groupe réactivé"}),l.invalidateQueries({queryKey:["temp-groups"]})},onError:w=>{n({title:"Erreur",description:w.message,variant:"destructive"})}}),D=G({mutationFn:w=>M.deleteTemporaryGroup(w),onSuccess:()=>{n({title:"Groupe supprimé"}),l.invalidateQueries({queryKey:["temp-groups"]})},onError:w=>{n({title:"Erreur",description:w.message,variant:"destructive"})}}),E=w=>{m(w),h("detail")},q=()=>{m(null),h("list"),l.invalidateQueries({queryKey:["temp-groups"]})};return b==="detail"&&c!=null?e.jsx(Gs,{groupId:c,athletes:a,onBack:q}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ae,{title:"Groupes temporaires",description:"Créez et gérez des groupes pour les stages, compétitions ou événements.",onBack:s,actions:e.jsxs(A,{size:"sm",onClick:()=>g(!0),children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un groupe"]})}),_||r?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(w=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-6 w-16 rounded bg-muted"})]})},w))}):u.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(oe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun groupe temporaire pour le moment."}),e.jsxs(A,{variant:"outline",size:"sm",onClick:()=>g(!0),children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer le premier groupe"]})]}):e.jsxs(e.Fragment,{children:[j.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Actifs (",j.length,")"]}),j.map(w=>e.jsx(Ue,{group:w,onManage:E,onDeactivate:p=>y(p),onReactivate:p=>F.mutate(p),onDelete:p=>t(p)},w.id))]}),f.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Terminés (",f.length,")"]}),f.map(w=>e.jsx(Ue,{group:w,onManage:E,onDeactivate:p=>y(p),onReactivate:p=>F.mutate(p),onDelete:p=>t(p)},w.id))]})]}),e.jsx(is,{open:x,onOpenChange:g,athletes:a,onCreated:()=>{l.invalidateQueries({queryKey:["temp-groups"]})}}),e.jsx(xe,{open:d!=null,onOpenChange:w=>{w||y(null)},children:e.jsxs(pe,{children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Terminer le groupe"}),e.jsx(je,{children:"Voulez-vous marquer ce groupe comme terminé ? Les sous-groupes seront aussi désactivés. Vous pourrez le réactiver plus tard si nécessaire."})]}),e.jsxs(fe,{children:[e.jsx(ve,{children:"Annuler"}),e.jsx(ye,{onClick:()=>{d!=null&&(z.mutate(d),y(null))},children:"Terminer"})]})]})}),e.jsx(xe,{open:S!=null,onOpenChange:w=>{w||t(null)},children:e.jsxs(pe,{children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Supprimer le groupe"}),e.jsx(je,{children:"Cette action est irréversible. Le groupe et tous ses sous-groupes seront supprimés définitivement."})]}),e.jsxs(fe,{children:[e.jsx(ve,{children:"Annuler"}),e.jsx(ye,{onClick:()=>{S!=null&&(D.mutate(S),t(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function Me(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Bs(s){const a=new Date;a.setHours(0,0,0,0);const r=new Date(s+"T00:00:00");return Math.ceil((r.getTime()-a.getTime())/(1e3*60*60*24))}const Qs=({open:s,onOpenChange:a,competition:r})=>{const{toast:n}=J(),l=de(),b=!!r,[h,c]=i.useState(""),[m,x]=i.useState(""),[g,d]=i.useState(""),[y,S]=i.useState(!0),[t,u]=i.useState(""),[_,j]=i.useState(""),[f,z]=i.useState(!1),[F,D]=i.useState(new Set),{data:E=[]}=O({queryKey:["athletes"],queryFn:()=>M.getAthletes()}),{data:q=[]}=O({queryKey:["groups"],queryFn:()=>M.getGroups()}),{data:w}=O({queryKey:["competition-assignments",r?.id],queryFn:()=>M.getCompetitionAssignments(r.id),enabled:!!r?.id});i.useEffect(()=>{s&&(r?(c(r.name),x(r.date),d(r.end_date??""),S(!!r.end_date),u(r.location??""),j(r.description??""),w&&D(new Set(w.map(v=>v.athlete_id)))):(c(""),x(""),d(""),S(!0),u(""),j(""),D(new Set)))},[s,r,w]);const p=G({mutationFn:v=>M.createCompetition(v),onSuccess:async v=>{if(F.size>0)try{await M.setCompetitionAssignments(v.id,Array.from(F))}catch(C){console.warn("[EAC] Failed to save competition assignments:",C)}n({title:"Competition creee"}),l.invalidateQueries({queryKey:["competitions"]}),l.invalidateQueries({queryKey:["competition-assignments"]}),a(!1)},onError:v=>{n({title:"Erreur",description:v.message,variant:"destructive"})}}),K=G({mutationFn:v=>M.updateCompetition(r.id,v),onSuccess:async()=>{try{await M.setCompetitionAssignments(r.id,Array.from(F))}catch(v){console.warn("[EAC] Failed to save competition assignments:",v)}n({title:"Competition mise a jour"}),l.invalidateQueries({queryKey:["competitions"]}),l.invalidateQueries({queryKey:["competition-assignments"]}),a(!1)},onError:v=>{n({title:"Erreur",description:v.message,variant:"destructive"})}}),R=G({mutationFn:()=>M.deleteCompetition(r.id),onSuccess:()=>{n({title:"Competition supprimee"}),l.invalidateQueries({queryKey:["competitions"]}),a(!1)},onError:v=>{n({title:"Erreur",description:v.message,variant:"destructive"})}}),Y=()=>{if(!h.trim()){n({title:"Nom requis",description:"Veuillez saisir un nom pour la competition.",variant:"destructive"});return}if(!m){n({title:"Date requise",description:"Veuillez saisir une date.",variant:"destructive"});return}const v={name:h.trim(),date:m,end_date:y&&g?g:null,location:t.trim()||null,description:_.trim()||null};b?K.mutate(v):p.mutate(v)},Q=p.isPending||K.isPending||R.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(be,{open:s,onOpenChange:a,children:e.jsxs(Ne,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(we,{children:e.jsx(Se,{children:b?"Modifier la competition":"Nouvelle competition"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"comp-name",children:"Nom *"}),e.jsx(le,{id:"comp-name",placeholder:"Ex : Championnats Regionaux",value:h,onChange:v=>c(v.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"comp-date",children:"Date *"}),e.jsx("input",{id:"comp-date",type:"date",value:m,onChange:v=>x(v.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx($,{htmlFor:"comp-multiday",children:"Multi-jours"}),e.jsx(Ss,{id:"comp-multiday",checked:y,onCheckedChange:S})]}),y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"comp-end-date",children:"Date de fin"}),e.jsx("input",{id:"comp-end-date",type:"date",value:g,onChange:v=>d(v.target.value),min:m||void 0,className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"comp-location",children:"Lieu"}),e.jsx(le,{id:"comp-location",placeholder:"Ex : Piscine de Strasbourg",value:t,onChange:v=>u(v.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"comp-description",children:"Description"}),e.jsx(Ze,{id:"comp-description",placeholder:"Notes, informations complementaires...",value:_,onChange:v=>j(v.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx($,{children:"Nageurs assignes"})]}),e.jsxs(X,{value:"",onValueChange:v=>{const C=E.filter(o=>o.group_id===Number(v));D(o=>{const k=new Set(o);return C.forEach(T=>{T.id!=null&&k.add(T.id)}),k})},children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Ajouter un groupe..."})}),e.jsx(se,{children:q.filter(v=>!v.is_temporary).map(v=>e.jsx(V,{value:String(v.id),children:v.name},v.id))})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto rounded-md border p-2 space-y-1",children:E.map(v=>{if(v.id==null)return null;const C=F.has(v.id);return e.jsxs("label",{className:"flex items-center gap-2 py-1 px-1 rounded hover:bg-muted/50 cursor-pointer",children:[e.jsx(ns,{checked:C,onCheckedChange:o=>{D(k=>{const T=new Set(k);return o?T.add(v.id):T.delete(v.id),T})}}),e.jsx("span",{className:"text-sm",children:v.display_name}),v.group_label&&e.jsx("span",{className:"text-xs text-muted-foreground ml-auto",children:v.group_label})]},v.id)})}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[F.size," nageur",F.size>1?"s":""," assigne",F.size>1?"s":""]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(A,{className:"w-full",onClick:Y,disabled:Q||!h.trim()||!m,children:Q?"Enregistrement...":b?"Enregistrer":"Creer"}),b&&e.jsx(A,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>z(!0),disabled:Q,children:"Supprimer cette competition"})]})]})]})}),e.jsx(xe,{open:f,onOpenChange:z,children:e.jsxs(pe,{children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Supprimer la competition"}),e.jsxs(je,{children:["Cette action est irreversible. La competition «"," ",r?.name," » sera supprimee definitivement."]})]}),e.jsxs(fe,{children:[e.jsx(ve,{children:"Annuler"}),e.jsx(ye,{onClick:()=>{R.mutate(),z(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Us=({competition:s,onEdit:a,onSendSms:r})=>{const{data:n=[]}=O({queryKey:["competition-assignments",s.id],queryFn:()=>M.getCompetitionAssignments(s.id)}),l=Bs(s.date),b=l<0,h=l>=0,c=s.end_date?`du ${Me(s.date)} au ${Me(s.end_date)}`:Me(s.date);return e.jsxs("button",{type:"button",className:`w-full text-left rounded-xl border bg-card p-3 space-y-1 transition-colors hover:bg-muted/50 ${b?"opacity-60":""}`,onClick:()=>a(s),children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:c})]}),e.jsxs("div",{className:"flex items-center gap-1.5 shrink-0",children:[h&&e.jsxs(W,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:["J-",l]}),b&&e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Passee"})]})]}),s.location&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Cs,{className:"h-3 w-3 shrink-0"}),e.jsx("span",{className:"truncate",children:s.location})]}),n.length>0&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(oe,{className:"h-3 w-3 shrink-0"}),e.jsxs("span",{children:[n.length," nageur",n.length>1?"s":""]})]}),n.length>0&&r&&e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-xs text-primary hover:underline",onClick:m=>{m.stopPropagation(),r(s,n)},children:[e.jsx(Ts,{className:"h-3 w-3"}),"SMS"]})]})},Hs=({onBack:s})=>{const{toast:a}=J(),[r,n]=i.useState(!1),[l,b]=i.useState(null),{data:h=[],isLoading:c}=O({queryKey:["competitions"],queryFn:()=>M.getCompetitions()}),{data:m}=O({queryKey:["athlete-phones"],queryFn:async()=>{const{data:t}=await Je.from("user_profiles").select("user_id, phone").not("phone","is",null);return new Map((t??[]).map(u=>[u.user_id,u.phone]))}}),x=i.useMemo(()=>{const t=new Date;t.setHours(0,0,0,0);const u=t.getTime(),_=[],j=[];for(const f of h)new Date(f.date+"T00:00:00").getTime()>=u?_.push(f):j.push(f);return _.sort((f,z)=>new Date(f.date+"T00:00:00").getTime()-new Date(z.date+"T00:00:00").getTime()),j.sort((f,z)=>new Date(z.date+"T00:00:00").getTime()-new Date(f.date+"T00:00:00").getTime()),[..._,...j]},[h]),g=()=>{b(null),n(!0)},d=t=>{b(t),n(!0)},y=(t,u)=>{if(!m)return;const _=u.map(f=>m.get(f.athlete_id)).filter(f=>!!f&&f.trim().length>0);if(_.length===0){a({title:"Aucun numero",description:"Aucun nageur assigne n'a renseigne de numero de telephone.",variant:"destructive"});return}if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){const f=encodeURIComponent(`[${t.name}] `);window.location.href=`sms:${_.join(",")}?body=${f}`}else navigator.clipboard.writeText(_.join(", ")).then(()=>{a({title:"Numeros copies",description:`${_.length} numero${_.length>1?"s":""} copie${_.length>1?"s":""} dans le presse-papiers. Utilisez votre telephone pour envoyer le SMS.`})}).catch(()=>{a({title:"Erreur",description:"Impossible de copier les numéros.",variant:"destructive"})})},S=h.length===0?"Gerez les competitions du club.":`${h.length} competition${h.length>1?"s":""}`;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ae,{title:"Competitions",description:S,onBack:s,actions:e.jsxs(A,{variant:"outline",size:"sm",onClick:g,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),c?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},t))}):x.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ze,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucune competition creee."}),e.jsxs(A,{variant:"outline",size:"sm",onClick:g,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer la premiere competition"]})]}):e.jsx("div",{className:"space-y-2",children:x.map(t=>e.jsx(Us,{competition:t,onEdit:d,onSendSms:y},t.id))}),e.jsx(Qs,{open:r,onOpenChange:n,competition:l})]})};async function Ys(s){const{data:a,error:r}=await Je.rpc("get_auth_uid_for_user",{p_user_id:s});return r?(console.error("[objectives] Failed to resolve auth UUID:",r.message),null):a}const Ws=({open:s,onOpenChange:a,objective:r,athleteName:n,athleteAuthId:l,competitions:b})=>{const{toast:h}=J(),c=de(),m=!!r,[x,g]=i.useState("chrono"),[d,y]=i.useState(""),[S,t]=i.useState("25"),[u,_]=i.useState(""),[j,f]=i.useState(""),[z,F]=i.useState(""),[D,E]=i.useState(!1),q=o=>{if(o)if(r){const k=!!r.event_code,T=!!r.text;g(k&&T?"both":T?"texte":"chrono"),y(r.event_code??""),t(String(r.pool_length??25)),_(r.target_time_seconds!=null?ss(r.target_time_seconds):""),f(r.text??""),F(r.competition_id??"")}else g("chrono"),y(""),t("25"),_(""),f(""),F("");a(o)},w=G({mutationFn:o=>M.createObjective(o),onSuccess:()=>{h({title:"Objectif cree"}),c.invalidateQueries({queryKey:["objectives"]}),a(!1)},onError:o=>{h({title:"Erreur",description:o.message,variant:"destructive"})}}),p=G({mutationFn:o=>M.updateObjective(r.id,o),onSuccess:()=>{h({title:"Objectif mis a jour"}),c.invalidateQueries({queryKey:["objectives"]}),a(!1)},onError:o=>{h({title:"Erreur",description:o.message,variant:"destructive"})}}),K=G({mutationFn:()=>M.deleteObjective(r.id),onSuccess:()=>{h({title:"Objectif supprime"}),c.invalidateQueries({queryKey:["objectives"]}),a(!1)},onError:o=>{h({title:"Erreur",description:o.message,variant:"destructive"})}}),R=x==="chrono"||x==="both",Y=x==="texte"||x==="both",Q=()=>{if(R&&!d){h({title:"Epreuve requise",description:"Veuillez selectionner une epreuve.",variant:"destructive"});return}if(R&&u&&Ve(u)===null){h({title:"Format invalide",description:"Le temps doit être au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(Y&&!j.trim()){h({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const o={athlete_id:l,competition_id:z&&z!=="none"?z:null,event_code:R?d:null,pool_length:R?Number(S):null,target_time_seconds:R&&u?Ve(u):null,text:Y?j.trim():null};m?p.mutate(o):w.mutate(o)},v=w.isPending||p.isPending||K.isPending,C=i.useMemo(()=>{const o=new Date;return o.setHours(0,0,0,0),b.filter(k=>new Date(k.date+"T00:00:00").getTime()>=o.getTime())},[b]);return e.jsxs(e.Fragment,{children:[e.jsx(be,{open:s,onOpenChange:q,children:e.jsxs(Ne,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(we,{children:e.jsx(Se,{children:m?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:n})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Type d'objectif"}),e.jsxs(Oe,{type:"single",variant:"outline",value:x,onValueChange:o=>{o&&g(o)},className:"justify-start",children:[e.jsx(ne,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(ne,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(ne,{value:"both",className:"text-xs",children:"Les deux"})]})]}),R&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Epreuve *"}),e.jsxs(X,{value:d,onValueChange:y,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Choisir une epreuve"})}),e.jsx(se,{children:xs.map(o=>e.jsx(V,{value:o,children:es(o)},o))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Bassin"}),e.jsxs(X,{value:S,onValueChange:t,children:[e.jsx(Z,{children:e.jsx(ee,{})}),e.jsxs(se,{children:[e.jsx(V,{value:"25",children:"25m"}),e.jsx(V,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(le,{placeholder:"Ex : 1:05:30",value:u,onChange:o=>_(o.target.value)})]})]}),Y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Objectif texte *"}),e.jsx(Ze,{placeholder:"Ex : Ameliorer la coulée de dos",value:j,onChange:o=>f(o.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Lier a une competition"}),e.jsxs(X,{value:z,onValueChange:F,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Aucune"})}),e.jsxs(se,{children:[e.jsx(V,{value:"none",children:"Aucune"}),C.map(o=>e.jsxs(V,{value:o.id,children:[o.name," (",o.date,")"]},o.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(A,{className:"w-full",onClick:Q,disabled:v,children:v?"Enregistrement...":m?"Enregistrer":"Creer"}),m&&e.jsx(A,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>E(!0),disabled:v,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(xe,{open:D,onOpenChange:E,children:e.jsxs(pe,{children:[e.jsxs(he,{children:[e.jsx(ge,{children:"Supprimer l'objectif"}),e.jsx(je,{children:"Cette action est irreversible. L'objectif sera supprime definitivement."})]}),e.jsxs(fe,{children:[e.jsx(ve,{children:"Annuler"}),e.jsx(ye,{onClick:()=>{K.mutate(),E(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Js=({objective:s,onEdit:a})=>{const r=!!s.event_code,n=!!s.text;return e.jsxs("button",{type:"button",className:"w-full text-left rounded-xl border bg-card p-3 space-y-1.5 transition-colors hover:bg-muted/50",onClick:()=>a(s),children:[r&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:es(s.event_code)}),s.pool_length&&e.jsxs(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[s.pool_length,"m"]}),s.target_time_seconds!=null&&e.jsx(W,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:ss(s.target_time_seconds)})]}),n&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.text}),s.competition_name&&e.jsx(W,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:s.competition_name})]})},Xs=({onBack:s,athletes:a,athletesLoading:r})=>{const{toast:n}=J(),[l,b]=i.useState(""),[h,c]=i.useState(!1),[m,x]=i.useState(null),g=i.useMemo(()=>l?a.find(D=>D.id!=null&&String(D.id)===l)??null:null,[a,l]),{data:d,isLoading:y}=O({queryKey:["auth-uid",l],queryFn:()=>Ys(Number(l)),enabled:!!l}),{data:S=[]}=O({queryKey:["competitions"],queryFn:()=>M.getCompetitions()}),{data:t=[],isLoading:u}=O({queryKey:["objectives",d],queryFn:()=>M.getObjectives(d),enabled:!!d}),_=i.useMemo(()=>{const D=a.filter(q=>q.id!=null),E=new Map;for(const q of D){const w=q.group_label||"Sans groupe";E.has(w)||E.set(w,[]),E.get(w).push(q)}return[...E.entries()].sort(([q],[w])=>q.localeCompare(w,"fr"))},[a]),j=()=>{if(!d){n({title:"Nageur requis",description:"Veuillez selectionner un nageur.",variant:"destructive"});return}x(null),c(!0)},f=D=>{x(D),c(!0)},z=r||!!l&&y,F=!!d&&!y;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ae,{title:"Objectifs",description:"Definissez des objectifs chrono ou texte pour chaque nageur.",onBack:s,actions:e.jsxs(A,{variant:"outline",size:"sm",onClick:j,disabled:!d,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Nageur"}),e.jsxs(X,{value:l,onValueChange:b,children:[e.jsx(Z,{children:e.jsx(ee,{placeholder:"Selectionner un nageur"})}),e.jsx(se,{children:_.map(([D,E])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:D}),E.map(q=>e.jsx(V,{value:String(q.id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:q.display_name}),q.group_label&&e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:q.group_label})]})},q.id))]},D))})]})]}),!l&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ee,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selectionnez un nageur pour voir et gerer ses objectifs."})]}),z&&l&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(D=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},D))}),F&&u&&e.jsx("div",{className:"space-y-2",children:[1,2].map(D=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},D))}),F&&!u&&t.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ee,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif defini pour ",g?.display_name,"."]}),e.jsxs(A,{variant:"outline",size:"sm",onClick:j,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer le premier objectif"]})]}),F&&!u&&t.length>0&&e.jsx("div",{className:"space-y-2",children:t.map(D=>e.jsx(Js,{objective:D,onEdit:f},D.id))}),d&&g&&e.jsx(Ws,{open:h,onOpenChange:c,objective:m,athleteName:g.display_name,athleteAuthId:d,competitions:S})]})},Zs=i.lazy(()=>Xe(()=>import("./StrengthCatalog-PYz_N7IB.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33]))),et=i.lazy(()=>Xe(()=>import("./SwimCatalog-CcscVBC2.js"),__vite__mapDeps([34,1,2,3,4,5,6,7,18,19,9,10,11,12,13,21,16,35,36,37,38,39,23,15,24,25,26,27,28,17,31,40,30,41]))),st=({onNavigate:s,onOpenRecordsAdmin:a,onOpenRecordsClub:r,athletes:n,athletesLoading:l,upcomingBirthdays:b,birthdaysLoading:h,kpiLoading:c,kpiPeriod:m,onKpiPeriodChange:x,fatigueAlerts:g,mostLoadedAthlete:d,swimSessionCount:y,strengthSessionCount:S})=>{const t=new Date().getHours(),u=t<12?"Bonjour":t<18?"Bon après-midi":"Bonsoir",_=new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),j=g.length>0;return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-display font-bold uppercase italic",children:[u,", ",e.jsx("span",{className:"text-primary",children:"Coach"})]}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:_})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Signaux · ",m,"j"]}),e.jsxs(Oe,{type:"single",size:"sm",variant:"outline",value:String(m),onValueChange:f=>{f&&x(Number(f))},children:[e.jsx(ne,{value:"7",className:"h-7 px-2 text-xs","aria-label":"7 jours",children:"7j"}),e.jsx(ne,{value:"30",className:"h-7 px-2 text-xs","aria-label":"30 jours",children:"30j"}),e.jsx(ne,{value:"365",className:"h-7 px-2 text-xs","aria-label":"1 an",children:"1an"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:`rounded-xl border p-3 ${j?"border-destructive/30 bg-destructive/5":"bg-muted/30"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Fatigue 5/5"}),e.jsx(As,{className:`h-3.5 w-3.5 ${j?"text-destructive":"text-muted-foreground"}`})]}),e.jsx("p",{className:"text-xl font-bold tabular-nums",children:c?"–":g.length}),e.jsx("p",{className:"text-[11px] text-muted-foreground truncate",children:c?"Chargement…":j?g.slice(0,2).map(f=>f.athleteName.split(" ")[0]).join(", "):"Aucune alerte"})]}),e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Plus chargé"}),e.jsx(oe,{className:"h-3.5 w-3.5 text-muted-foreground"})]}),e.jsx("p",{className:"text-xl font-bold truncate",children:c?"–":d?.athleteName?.split(" ")[0]??"–"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:c?"Calcul…":d?`Charge ${Math.round(d.loadScore)}`:"Pas de données"})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>s("calendar"),className:"flex items-center gap-1.5 rounded-full bg-primary text-primary-foreground px-3.5 py-2 text-sm font-semibold active:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(Le,{className:"h-3.5 w-3.5"}),"Assigner"]}),e.jsxs("button",{type:"button",onClick:()=>s("messaging"),className:"flex items-center gap-1.5 rounded-full border px-3.5 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx($e,{className:"h-3.5 w-3.5"}),"Email"]}),e.jsxs("button",{type:"button",onClick:()=>s("groups"),className:"flex items-center gap-1.5 rounded-full border px-3.5 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(as,{className:"h-3.5 w-3.5"}),"Groupes"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>s("swim"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Ye,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Natation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y!=null?`${y} séance${y!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("strength"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(We,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Musculation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:S!=null?`${S} séance${S!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("swimmers"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(oe,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Nageurs"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l?"Chargement…":`${n.length} nageur${n.length!==1?"s":""}`})]}),e.jsxs("button",{type:"button",onClick:a,className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ze,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Records club"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Import & administration"})]}),e.jsxs("button",{type:"button",onClick:()=>s("competitions"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ze,{className:"h-5 w-5 text-amber-500 mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Compétitions"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Échéances & calendrier"})]}),e.jsxs("button",{type:"button",onClick:()=>s("objectives"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Ee,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Objectifs"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Temps cibles & objectifs"})]})]}),e.jsx("button",{type:"button",onClick:r,className:"w-full text-center text-sm text-primary font-semibold py-1 active:opacity-70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded",children:"Voir les records du club"}),!h&&b&&b.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Anniversaires"}),e.jsx("div",{className:"space-y-1.5",children:b.slice(0,3).map(f=>e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-lg border px-3 py-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:"text-sm font-medium truncate block",children:f.display_name}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:tt(f.next_birthday)})]}),e.jsxs("span",{className:"text-xs font-bold text-primary shrink-0",children:["J-",f.days_until]})]},f.id))})]}):null]})},tt=s=>{if(!s)return"-";const a=new Date(s);return Number.isNaN(a.getTime())?s:a.toLocaleDateString("fr-FR")},He=s=>s.toISOString().split("T")[0],nt=s=>new Date(s.completed_at||s.started_at||s.date||s.created_at||0).getTime(),at=s=>{if(!s.length)return null;const a=s.reduce((n,l)=>n+l,0)/s.length,r=Math.min(5,Math.max(1,Math.round(a/10*5)));return{average:a,rating:r}};function Tt(){const s=Ie(p=>p.role),a=Ie(p=>p.setSelectedAthlete),[,r]=us(),[n,l]=i.useState("home"),[b,h]=i.useState(7);i.useEffect(()=>{const p=()=>l("home");return window.addEventListener("nav:reset",p),()=>window.removeEventListener("nav:reset",p)},[]);const c=s==="coach"||s==="admin",m=n==="home"||n==="calendar",x=n==="home"||n==="messaging"||n==="swimmers"||n==="calendar"||n==="groups"||n==="objectives",g=n==="messaging"||n==="calendar"||n==="groups",d=n==="home"||n==="swimmers",{data:y}=O({queryKey:["swim_catalog"],queryFn:()=>M.getSwimCatalog(),enabled:c&&m}),{data:S}=O({queryKey:["strength_catalog"],queryFn:()=>M.getStrengthSessions(),enabled:c&&m}),{data:t=[],isLoading:u}=O({queryKey:["athletes"],queryFn:()=>M.getAthletes(),enabled:c&&x}),_=i.useMemo(()=>t.slice(0,5),[t]),{data:j=[]}=O({queryKey:["groups"],queryFn:()=>M.getGroups(),enabled:c&&g}),f=O({queryKey:["upcoming-birthdays"],queryFn:()=>M.getUpcomingBirthdays({days:30}),enabled:c&&d}),z=f.data,F=O({queryKey:["coach-kpis",b,_.map(p=>p.id??p.display_name)],enabled:c&&n==="home"&&_.length>0,queryFn:async()=>{const p=b,K=new Date;K.setDate(K.getDate()-p);const R=He(K),Y=He(new Date),Q=await Promise.all(_.map(async o=>{const[k,T]=await Promise.all([M.getSessions(o.display_name,o.id),M.getStrengthHistory(o.display_name,{athleteId:o.id,limit:50,from:R,to:Y})]),U=k.filter(L=>new Date(L.date).getTime()>=K.getTime()),N=U.map(L=>L.fatigue??L.feeling).filter(L=>Number.isFinite(L)),I=U.reduce((L,te)=>L+(Number(te.duration)||0)*(Number(te.effort)||0),0),P=(T?.runs??[]).filter(L=>nt(L)>=K.getTime()),H=P.map(L=>L.fatigue??L.feeling??L.rpe).filter(L=>Number.isFinite(Number(L))).map(L=>Number(L)),ue=P.reduce((L,te)=>{const Ke=Number(te.feeling??te.rpe??0),Re=Number(te.duration??0);if(Re>0&&Ke>0)return L+Re*Ke;const ls=Array.isArray(te.logs)?te.logs.length:0;return L+ls*5},0),me=at([...N,...H]);return{athleteName:o.display_name,loadScore:I+ue,fatigueRating:me}})),v=Q.filter(o=>o.fatigueRating?.rating===5).map(o=>({athleteName:o.athleteName,rating:o.fatigueRating?.rating??0})),C=Q.filter(o=>o.loadScore>0).sort((o,k)=>k.loadScore-o.loadScore)[0];return{fatigueAlerts:v,mostLoadedAthlete:C??null}}}),D=p=>{a({id:p.id??null,name:p.display_name}),r("/progress")},{toast:E}=J(),q=de(),w=G({mutationFn:async p=>{const K=await M.importSingleSwimmer(p.iuf,p.name);return await M.recalculateClubRecords(),K},onSuccess:p=>{E({title:"Import terminé",description:`${p.total_found} trouvées, ${p.new_imported} nouvelles.`}),q.invalidateQueries({queryKey:["club-records"]})},onError:p=>{E({title:"Erreur import",description:p.message,variant:"destructive"})}});return c?e.jsxs("div",{className:"space-y-6",children:[n==="home"?e.jsx(st,{onNavigate:l,onOpenRecordsAdmin:()=>r("/records-admin"),onOpenRecordsClub:()=>r("/records-club"),athletes:t,athletesLoading:u,upcomingBirthdays:z,birthdaysLoading:f.isLoading,kpiLoading:F.isLoading,kpiPeriod:b,onKpiPeriodChange:h,fatigueAlerts:F.data?.fatigueAlerts??[],mostLoadedAthlete:F.data?.mostLoadedAthlete??null,swimSessionCount:y?.length,strengthSessionCount:S?.length}):null,n==="swim"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ae,{title:"Bibliothèque natation",description:"Accédez aux séances et aux templates natation.",onBack:()=>l("home"),actions:e.jsxs(A,{variant:"outline",size:"sm",onClick:()=>l("calendar"),children:[e.jsx(Le,{className:"mr-1.5 h-3.5 w-3.5"}),"Assigner"]})}),e.jsx(i.Suspense,{fallback:e.jsx(Ge,{}),children:e.jsx(et,{})})]}):null,n==="strength"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ae,{title:"Bibliothèque musculation",description:"Consultez et créez des séances musculation.",onBack:()=>l("home"),actions:e.jsxs(A,{variant:"outline",size:"sm",onClick:()=>l("calendar"),children:[e.jsx(Le,{className:"mr-1.5 h-3.5 w-3.5"}),"Assigner"]})}),e.jsx(i.Suspense,{fallback:e.jsx(Ge,{}),children:e.jsx(Zs,{})})]}):null,n==="swimmers"?e.jsxs("div",{className:"space-y-4",children:[e.jsx(ae,{title:"Nageurs",description:u?"Chargement…":`${t.length} nageur${t.length!==1?"s":""} inscrit${t.length!==1?"s":""}`,onBack:()=>l("home"),actions:e.jsxs(A,{variant:"outline",size:"sm",onClick:()=>l("messaging"),children:[e.jsx($e,{className:"mr-1.5 h-3.5 w-3.5"}),"Email"]})}),u?e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(p=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-8 w-16 rounded bg-muted"})]})},p))}):t.length?e.jsx("div",{className:"space-y-2",children:t.map(p=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:p.display_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[p.group_label?e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:p.group_label}):null,p.ffn_iuf?e.jsx("span",{className:"text-[10px] font-mono text-muted-foreground",children:p.ffn_iuf}):null]})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[p.ffn_iuf?e.jsx(A,{size:"icon",variant:"ghost",className:"h-8 w-8",disabled:w.isPending,onClick:()=>w.mutate({iuf:p.ffn_iuf,name:p.display_name}),title:"Importer performances FFN",children:e.jsx(ms,{className:"h-4 w-4"})}):null,e.jsx(A,{size:"sm",variant:"outline",onClick:()=>D(p),children:"Fiche"})]})]},p.id??p.display_name))}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun nageur disponible."})]}):null,n==="messaging"?e.jsx(Es,{onBack:()=>l("home"),athletes:t,groups:j,athletesLoading:u}):null,n==="calendar"?e.jsx(Ks,{onBack:()=>l("home"),athletes:t,groups:j,swimSessions:y,strengthSessions:S}):null,n==="groups"?e.jsx(Vs,{onBack:()=>l("home"),athletes:t,groups:j,athletesLoading:u}):null,n==="competitions"?e.jsx(Hs,{onBack:()=>l("home")}):null,n==="objectives"?e.jsx(Xs,{onBack:()=>l("home"),athletes:t,athletesLoading:u}):null]}):e.jsx("div",{className:"flex items-center justify-center min-h-[60vh] animate-in fade-in motion-reduce:animate-none",children:e.jsxs(De,{className:"w-full max-w-sm shadow-xl border-t-4 border-t-primary",children:[e.jsxs(Ae,{children:[e.jsxs(Fe,{className:"flex items-center gap-2 uppercase italic",children:[e.jsx(oe,{className:"h-5 w-5 text-primary"}),"Accès Coach"]}),e.jsx(qe,{children:"Cette section est réservée aux coachs et administrateurs."})]}),e.jsx(Te,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connectez-vous avec un compte autorisé pour accéder aux outils de gestion."})})]})})}export{Tt as default};
