import{r as p,u as L,j as e,c as O,d as $}from"./vendor-query-DyA9aSKS.js";import{a as C,g as G,b as J}from"./api-bXFJWRB7.js";import{B as R,P as H,l as W,c as _,d as X,L as K,I as U}from"./index-CEHY8p8P.js";import{C as Y}from"./Coach-DW7BcPvW.js";import{T as Z}from"./textarea-CN5sWNKD.js";import{S as ee,a as te,b as se,c as ne}from"./sheet-Bh6IyXKI.js";import{A as ae,a as ie,b as re,c as oe,d as le,e as de,f as ce,g as me}from"./alert-dialog-Bw9I39eS.js";import{C as ue}from"./checkbox-O20kDI1Z.js";import{S as pe,a as xe,b as he,c as ge,d as fe}from"./select-DEab6q-a.js";import{C as ve}from"./chevron-down-C_IunBCE.js";import"./vendor-react-BzrpNAyj.js";import"./swim-xXx_YbJk.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-Cp7OJVYz.js";import"./search-DOfX7aOI.js";import"./trophy-CDuSfRDq.js";import"./bell-ring-DWicaLcn.js";import"./chevron-right-D8BEssX8.js";import"./zap-186aYcj7.js";import"./clock-Tf1tm2Ml.js";import"./index-Ww5yFEdj.js";import"./index-BjZaRMqh.js";import"./index-DCX2sNhR.js";import"./index-B2YUBY2L.js";import"./chevron-up-Ct4WekGc.js";function ye(l){const u=new Date;u.setHours(0,0,0,0);const a=new Date(l+"T00:00:00");return Math.ceil((a.getTime()-u.getTime())/(1e3*60*60*24))}function be(l){return`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`}function q(l,u){return Math.max(0,Math.round((new Date(u+"T00:00:00").getTime()-new Date(l+"T00:00:00").getTime())/6048e5))}const je=7,we=20,Ne=72;function I(l){return Math.min(Ne,Math.max(we,l*je))}const Ce=({open:l,onOpenChange:u,competition:a})=>{const{toast:x}=X(),h=O(),g=!!a,[v,S]=p.useState(""),[f,j]=p.useState(""),[r,d]=p.useState(""),[n,o]=p.useState(""),[c,m]=p.useState(""),[w,i]=p.useState(!1),[s,N]=p.useState(new Set),{data:y=[]}=L({queryKey:["athletes"],queryFn:()=>C.getAthletes()}),{data:D=[]}=L({queryKey:["groups"],queryFn:()=>C.getGroups()}),{data:k}=L({queryKey:["competition-assignments",a?.id],queryFn:()=>C.getCompetitionAssignments(a.id),enabled:!!a?.id});p.useEffect(()=>{l&&(a?(S(a.name),j(a.date),d(a.end_date??a.date??""),o(a.location??""),m(a.description??""),k&&N(new Set(k.map(t=>t.athlete_id)))):(S(""),j(""),d(""),o(""),m(""),N(new Set)))},[l,a,k]);const b=$({mutationFn:t=>C.createCompetition(t),onSuccess:async t=>{if(s.size>0)try{await C.setCompetitionAssignments(t.id,Array.from(s))}catch(A){console.warn("[EAC] Failed to save competition assignments:",A)}x({title:"Competition creee"}),h.invalidateQueries({queryKey:["competitions"]}),h.invalidateQueries({queryKey:["competition-assignments"]}),u(!1)},onError:t=>{x({title:"Erreur",description:t.message,variant:"destructive"})}}),E=$({mutationFn:t=>C.updateCompetition(a.id,t),onSuccess:async()=>{try{await C.setCompetitionAssignments(a.id,Array.from(s))}catch(t){console.warn("[EAC] Failed to save competition assignments:",t)}x({title:"Competition mise a jour"}),h.invalidateQueries({queryKey:["competitions"]}),h.invalidateQueries({queryKey:["competition-assignments"]}),u(!1)},onError:t=>{x({title:"Erreur",description:t.message,variant:"destructive"})}}),z=$({mutationFn:()=>C.deleteCompetition(a.id),onSuccess:()=>{x({title:"Competition supprimee"}),h.invalidateQueries({queryKey:["competitions"]}),u(!1)},onError:t=>{x({title:"Erreur",description:t.message,variant:"destructive"})}}),V=()=>{if(!v.trim()){x({title:"Nom requis",description:"Veuillez saisir un nom pour la competition.",variant:"destructive"});return}if(!f){x({title:"Date requise",description:"Veuillez saisir une date.",variant:"destructive"});return}const t={name:v.trim(),date:f,end_date:r||f||null,location:n.trim()||null,description:c.trim()||null};g?E.mutate(t):b.mutate(t)},P=b.isPending||E.isPending||z.isPending,Q="flex h-9 w-full rounded-lg border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",B=t=>{j(t),(!r||r<t)&&d(t)};return e.jsxs(e.Fragment,{children:[e.jsx(ee,{open:l,onOpenChange:u,children:e.jsxs(te,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(se,{children:e.jsx(ne,{children:g?"Modifier":"Nouvelle compétition"})}),e.jsxs("div",{className:"mt-5 space-y-5",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(K,{htmlFor:"comp-name",className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Nom"}),e.jsx(U,{id:"comp-name",placeholder:"Ex : Championnats Régionaux",value:v,onChange:t=>S(t.target.value),className:"text-[15px] font-medium"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("span",{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Dates"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"comp-date",className:"text-[10px] text-muted-foreground/60 pl-0.5",children:"Début"}),e.jsx("input",{id:"comp-date",type:"date",value:f,onChange:t=>B(t.target.value),className:Q})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"comp-end-date",className:"text-[10px] text-muted-foreground/60 pl-0.5",children:"Fin"}),e.jsx("input",{id:"comp-end-date",type:"date",value:r,onChange:t=>d(t.target.value),min:f||void 0,className:Q})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(K,{htmlFor:"comp-location",className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Lieu"}),e.jsx(U,{id:"comp-location",placeholder:"Ex : Piscine de Strasbourg",value:n,onChange:t=>o(t.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(K,{htmlFor:"comp-description",className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Notes"}),e.jsx(Z,{id:"comp-description",placeholder:"Informations complémentaires...",value:c,onChange:t=>m(t.target.value),rows:2,className:"resize-none"})]}),e.jsx("div",{className:"border-t border-border/40"}),e.jsxs("div",{className:"space-y-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Nageurs"}),e.jsxs("span",{className:"text-[10px] tabular-nums text-muted-foreground/50",children:[s.size," sélectionné",s.size>1?"s":""]})]}),e.jsxs(pe,{value:"",onValueChange:t=>{const A=y.filter(T=>T.group_id===Number(t));N(T=>{const M=new Set(T);return A.forEach(F=>{F.id!=null&&M.add(F.id)}),M})},children:[e.jsx(xe,{className:"h-8 text-xs",children:e.jsx(he,{placeholder:"Ajouter un groupe..."})}),e.jsx(ge,{children:D.filter(t=>!t.is_temporary).map(t=>e.jsx(fe,{value:String(t.id),children:t.name},t.id))})]}),e.jsx("div",{className:"max-h-44 overflow-y-auto rounded-lg border p-1.5 space-y-0.5",children:y.map(t=>{if(t.id==null)return null;const A=s.has(t.id);return e.jsxs("label",{className:_("flex items-center gap-2 py-1 px-1.5 rounded-md cursor-pointer transition-colors",A?"bg-primary/5":"hover:bg-muted/50"),children:[e.jsx(ue,{checked:A,onCheckedChange:T=>{N(M=>{const F=new Set(M);return T?F.add(t.id):F.delete(t.id),F})}}),e.jsx("span",{className:"text-[13px]",children:t.display_name}),t.group_label&&e.jsx("span",{className:"text-[10px] text-muted-foreground/50 ml-auto",children:t.group_label})]},t.id)})})]}),e.jsxs("div",{className:"space-y-3 pt-1",children:[e.jsx(R,{className:"w-full",onClick:V,disabled:P||!v.trim()||!f||!r,children:P?"Enregistrement...":g?"Enregistrer":"Créer la compétition"}),g&&e.jsx("button",{type:"button",className:"w-full text-center text-[11px] text-destructive/50 hover:text-destructive py-1.5 transition-colors",onClick:()=>i(!0),disabled:P,children:"Supprimer cette compétition"})]})]})]})}),e.jsx(ae,{open:w,onOpenChange:i,children:e.jsxs(ie,{children:[e.jsxs(re,{children:[e.jsx(oe,{children:"Supprimer la compétition"}),e.jsxs(le,{children:["Cette action est irréversible. La compétition «"," ",a?.name," » sera supprimée définitivement."]})]}),e.jsxs(de,{children:[e.jsx(ce,{children:"Annuler"}),e.jsx(me,{onClick:()=>{z.mutate(),i(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Se={competition:"bg-amber-500 shadow-[0_0_6px_rgba(245,158,11,0.4)]",interview:"bg-blue-500 shadow-[0_0_6px_rgba(59,130,246,0.4)]",cycle_end:"bg-violet-500 shadow-[0_0_6px_rgba(139,92,246,0.4)]"},ke={competition:"bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",interview:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",cycle_end:"bg-violet-100 text-violet-700 dark:bg-violet-900/30 dark:text-violet-400"},_e={draft_athlete:"En attente nageur",draft_coach:"En attente coach",sent:"Envoyé, à signer"},De=({events:l,onEditCompetition:u})=>{const[a,x]=p.useState(!1),{items:h,todayIdx:g}=p.useMemo(()=>{const r=[...l].sort((i,s)=>i.date.localeCompare(s.date)),d=new Date;d.setHours(0,0,0,0);const n=be(d),o=[];let c="",m="",w=!1;for(const i of r){const s=i.date<n,N=ye(i.date),y=i.date.slice(0,7),D=y!==m,k=new Date(i.date+"T00:00:00").toLocaleDateString("fr-FR",{month:"short"}).replace(".","").toUpperCase();if(!w&&!s){if(c){const E=q(c,n);E>=1&&o.push({kind:"gap",weeks:E,height:I(E)})}o.push({kind:"today"}),w=!0;const b=q(n,i.date);b>=1&&o.push({kind:"gap",weeks:b,height:I(b)})}else if(c){const b=q(c,i.date);b>=1&&o.push({kind:"gap",weeks:b,height:I(b)})}o.push({kind:"event",event:i,isPast:s,days:N,isNewMonth:D,monthLabel:k}),c=i.end_date||i.date,m=y}if(!w){if(c){const i=q(c,n);i>=1&&o.push({kind:"gap",weeks:i,height:I(i)})}o.push({kind:"today"})}return{items:o,todayIdx:o.findIndex(i=>i.kind==="today")}},[l]);if(l.length===0)return null;const v=g>0?h.slice(0,g):[],S=g>=0?h.slice(g):h,f=v.filter(r=>r.kind==="event").length,j=(r,d)=>{if(r.kind==="gap")return e.jsx("div",{className:"relative",style:{height:r.height},children:r.weeks>=2&&e.jsxs("span",{className:"absolute left-[-0.8rem] -translate-x-1/2 top-1/2 -translate-y-1/2 text-[9px] tabular-nums font-medium text-muted-foreground/30 bg-background px-1 select-none",children:[r.weeks,"s"]})},`g${d}`);if(r.kind==="today")return e.jsxs("div",{className:"relative flex items-center h-7 -ml-14",children:[e.jsx("div",{className:"absolute left-0 right-0 h-[2px] bg-emerald-500/60"}),e.jsx("span",{className:"relative text-[10px] font-bold tracking-widest text-emerald-600 dark:text-emerald-400 bg-background pl-2 pr-1.5 select-none",children:"AUJOURD'HUI"})]},"today");const{event:n,isPast:o,days:c,isNewMonth:m,monthLabel:w}=r,i=n.type==="competition"&&n.competition,s=(()=>{const y=new Date(n.date+"T00:00:00");if(!n.end_date||n.end_date===n.date)return y.toLocaleDateString("fr-FR",{day:"numeric",month:"short"}).replace(".","");const D=new Date(n.end_date+"T00:00:00"),k=D.toLocaleDateString("fr-FR",{day:"numeric",month:"short"}).replace(".","");return y.getMonth()===D.getMonth()?`${y.getDate()}–${k}`:`${y.toLocaleDateString("fr-FR",{day:"numeric",month:"short"}).replace(".","")} → ${k}`})(),N=e.jsxs(e.Fragment,{children:[m&&e.jsx("span",{className:"absolute left-[-3.25rem] top-[3px] w-[2rem] text-[10px] font-bold uppercase tracking-widest text-muted-foreground/50 text-right select-none",children:w}),e.jsx("div",{className:_("absolute left-[-0.8rem] top-[5px] h-[10px] w-[10px] rounded-full -translate-x-1/2 z-10 border-2 border-background transition-transform group-hover:scale-150",o?"bg-muted-foreground/30":Se[n.type])}),e.jsxs("div",{className:"min-w-0 flex-1 pl-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 min-w-0",children:[e.jsx("span",{className:_("text-[13px] font-semibold truncate flex-1 min-w-0",o?"text-muted-foreground":"text-foreground"),children:n.name}),!o&&c>=0&&e.jsxs("span",{className:_("text-[10px] font-bold tabular-nums shrink-0 px-1.5 py-0.5 rounded-full",ke[n.type]),children:["J-",c]})]}),e.jsxs("p",{className:_("text-[11px] truncate",o?"text-muted-foreground/60":"text-muted-foreground"),children:[s,n.subtitle&&` · ${n.subtitle}`]})]})]});return i?e.jsx("button",{type:"button",className:_("relative w-full flex items-start text-left py-1.5 group transition-opacity",o?"opacity-40 hover:opacity-70":"hover:opacity-80"),onClick:()=>u(n.competition),children:N},n.id):e.jsx("div",{className:_("relative w-full flex items-start text-left py-1.5 group",o&&"opacity-40"),children:N},n.id)};return e.jsxs("div",{className:"relative pl-14",children:[e.jsx("div",{className:"absolute left-[2.625rem] top-1 bottom-1 w-[2px] rounded-full bg-gradient-to-b from-border/10 via-border/40 to-border/10"}),f>0&&e.jsxs("button",{type:"button",className:"relative flex items-center gap-1.5 py-2 text-[11px] font-medium text-muted-foreground/50 hover:text-muted-foreground transition-colors select-none",onClick:()=>x(r=>!r),children:[e.jsx(ve,{className:_("h-3 w-3 shrink-0 transition-transform",a&&"rotate-180")}),e.jsxs("span",{children:["Passées (",f,")"]})]}),a&&v.map((r,d)=>j(r,d)),S.map((r,d)=>j(r,v.length+d))]})},st=({onBack:l})=>{const[u,a]=p.useState(!1),[x,h]=p.useState(null),{data:g=[],isLoading:v}=L({queryKey:["competitions"],queryFn:()=>C.getCompetitions()}),{data:S=[],isLoading:f}=L({queryKey:["coach-events-interviews"],queryFn:G}),{data:j=[],isLoading:r}=L({queryKey:["coach-events-cycles"],queryFn:()=>J()}),d=v||f||r,n=p.useMemo(()=>{const m=g.map(s=>({id:`comp-${s.id}`,type:"competition",date:s.date,end_date:s.end_date??void 0,name:s.name,subtitle:s.location&&s.location!=="??"?s.location:void 0,competition:s})),w=S.map(s=>({id:`intv-${s.id}`,type:"interview",date:s.date,name:`Entretien : ${s.athlete_name}`,subtitle:_e[s.status]??s.status})),i=j.filter(s=>s.end_competition_date!=null).map(s=>({id:`cycle-${s.id}`,type:"cycle_end",date:s.end_competition_date,name:`Fin cycle : ${s.name}`,subtitle:s.end_competition_name??void 0}));return[...m,...w,...i]},[g,S,j]),o=()=>{h(null),a(!0)},c=m=>{h(m),a(!0)};return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(Y,{title:"Échéances",description:"Compétitions, entretiens et fins de cycles",onBack:l,actions:e.jsxs(R,{variant:"outline",size:"sm",onClick:o,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Compétition"]})}),d?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(m=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},m))}):n.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(W,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucune échéance à venir"}),e.jsxs(R,{variant:"outline",size:"sm",onClick:o,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer une compétition"]})]}):e.jsx(De,{events:n,onEditCompetition:c}),e.jsx(Ce,{open:u,onOpenChange:a,competition:x})]})};export{st as default};
