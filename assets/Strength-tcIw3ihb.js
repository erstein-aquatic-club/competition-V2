import{j as e,r as n,c as Rt,u as fe,d as Fe,e as Yt}from"./vendor-query-BiSH4r2z.js";import{a as G}from"./api-6fs5kp_C.js";import{c as Ge,a as te,d as lt,D as $e,B as C,C as Le,i as At,k as It,l as es,g as ts,L as _e,M as ss,X as qe,E as rs,I as st,u as ns,S as be}from"./index-CqrdGfCo.js";import{T as is,a as as,b as jt,c as Nt}from"./tabs-CDiivCSz.js";import{B as wt}from"./badge-NLvbvrAk.js";import{D as ls,a as cs,b as os,c as ds,d as us}from"./drawer-C1DM0Dog.js";import{S as rt,a as nt,b as it,c as at,A as Dt,e as Tt,f as Ft,g as Lt,h as Pt,i as qt,j as $t,k as Ot,l as ms}from"./alert-dialog-CSgiX_n9.js";import{S as xs}from"./switch-BcnukFOH.js";import{B as Kt}from"./BottomActionBar-PeGAD3Uf.js";import{c as De}from"./design-tokens-CKgCpdH6.js";import{i as St,B as Ke}from"./swim-C0SLHFq0.js";import{L as hs}from"./loader-circle-BcUegpEa.js";import{C as ps}from"./circle-check-Cqd_5Ans.js";import{S as fs}from"./sticky-note-D4tYBnKa.js";import{C as _t}from"./index-CBQcCoB9.js";import{T as gs}from"./timer-B3i8VYTd.js";import{C as Qe}from"./chevron-right-7pGjY_4D.js";import{F as ys}from"./flame-BnM2nouN.js";import{m as Pe}from"./proxy-Dh0N-Z8G.js";import{f as Be}from"./fr-CFyqyHeU.js";import{S as bs}from"./search-DeKFy-rG.js";import{f as He}from"./format-B9mPVj_w.js";import{f as vs}from"./animations-CrcLFysI.js";import{C as js}from"./chevron-left-Z_7QIhHN.js";import{P as Ns}from"./play-B3AErveF.js";import{S as ws,a as Ss,b as _s,c as Cs,d as ze}from"./select-DeyRX-Dh.js";import{C as ks}from"./circle-alert-BcXvao6F.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-BOe59e-O.js";import"./index-CPVBE5mu.js";import"./index-7NVzFrgg.js";import"./index-BNIDFoFy.js";import"./index-nhvT0Lb1.js";import"./chevron-down-DlMpn8Y6.js";import"./chevron-up-D_cdqd6a.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ms=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],Es=Ge("calendar",Ms);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rs=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]],As=Ge("pause",Rs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=[["circle",{cx:"12",cy:"5",r:"3",key:"rqqgnr"}],["path",{d:"M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z",key:"56o5sh"}]],Ds=Ge("weight",Is);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],Fs=Ge("zap",Ts),Ls=[1,2,3,4,5];function Ct({value:t,onChange:i,className:o,disabled:c=!1,size:x="md",ariaLabel:g="Sélecteur d'échelle 1 à 5"}){const y=x==="sm"?"h-10 w-10 text-xs":"h-11 w-11 text-sm";return e.jsx("div",{className:te("flex items-center gap-2",o),role:"group","aria-label":g,children:Ls.map(j=>{const f=t===j;return e.jsx("button",{type:"button",className:te("flex items-center justify-center rounded-full border font-semibold transition",y,f?"border-primary bg-primary text-primary-foreground":"border-muted-foreground/30 bg-background text-foreground",c&&"opacity-60"),"aria-pressed":f,disabled:c,onClick:()=>{c||i?.(j)},children:j},j)})})}const Ps=()=>{try{const t=new(window.AudioContext||window.webkitAudioContext),i=t.createOscillator(),o=t.createGain();i.connect(o),o.connect(t.destination),i.frequency.value=880,o.gain.value=.3,i.start(),i.stop(t.currentTime+.25);const c=t.createOscillator(),x=t.createGain();c.connect(x),x.connect(t.destination),c.frequency.value=1100,x.gain.value=.3,c.start(t.currentTime+.35),c.stop(t.currentTime+.6),c.onended=()=>t.close()}catch{}try{navigator.vibrate?.([200,100,200])}catch{}},Ve=(t,i)=>{const o=Number(t?.set_index??t?.set_number??t?.setIndex??i);return!Number.isFinite(o)||o<=0?i:o},zt=(t=[],i,o)=>{if(!t.length)return 0;const c=Array.isArray(i)?i:[];if(c.length>0){const y=new Map;c.forEach((f,k)=>{if(!f?.exercise_id)return;const N=y.get(f.exercise_id)??[];N.push({...f,set_index:Ve(f,k+1)}),y.set(f.exercise_id,N)});let j=t.length+1;for(let f=0;f<t.length;f+=1){const k=t[f];if((y.get(k.exercise_id)??[]).length<(k.sets??0)){j=f+1;break}}return j}const x=Number(o??0);if(!Number.isFinite(x)||x<=0)return 0;const g=Math.min(t.length,Math.max(0,Math.round(x/100*t.length)));return Math.min(t.length,g+1)},ue=(t,i)=>{const o=Number(t);return!Number.isFinite(o)||o<=0?"—":i?`${o}${i}`:String(o)};function qs({session:t,exercises:i,oneRMs:o,onFinish:c,onStart:x,onLogSets:g,onProgress:y,initialLogs:j,isFinishing:f,initialStep:k,onStepChange:N,initialInputOpen:l,initialSeriesOpen:R,onExitFocus:v,exerciseNotes:M,onUpdateNote:A}){const{toast:L}=lt(),J=n.useRef(!1),[S,K]=n.useState(k??0),[T,$]=n.useState([]),[q,se]=n.useState(0),[Z,me]=n.useState(!0),b=n.useRef(Date.now()),I=n.useRef(0),[w,F]=n.useState(0),[ae,le]=n.useState(!1),[re,O]=n.useState(!1),z=n.useRef(0),[ve,Ce]=n.useState(!0),[xe,ce]=n.useState(3),[je,V]=n.useState(3),[Ne,r]=n.useState(""),[_,P]=n.useState(!1),[h,E]=n.useState(1),[ke,W]=n.useState(R??!1),[Me,we]=n.useState(l??!1),[X,Ee]=n.useState("weight"),[ne,Y]=n.useState(""),[We,ge]=n.useState(!1),[Re,Ae]=n.useState(!1),[a,m]=n.useState(!1),[Q,B]=n.useState(!1),[he,pe]=n.useState(!1),[ct,ot]=n.useState("");n.useEffect(()=>{if(!Z)return;const s=()=>{const u=Math.floor((Date.now()-b.current)/1e3)+I.current;se(u)};s();const d=setInterval(s,1e3),D=()=>{document.visibilityState==="visible"&&s()};return document.addEventListener("visibilitychange",D),()=>{clearInterval(d),document.removeEventListener("visibilitychange",D)}},[Z]),n.useEffect(()=>{if(!Re)return;const s=d=>{d.key==="Escape"&&Ae(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Re]),n.useEffect(()=>{if(!ae||re)return;const s=()=>{if(z.current<=0)return;const u=Math.max(0,Math.ceil((z.current-Date.now())/1e3));F(u),u<=0&&(Ps(),L({title:"Temps de récupération terminé"}),le(!1),O(!1))};s();const d=setInterval(s,1e3),D=()=>{document.visibilityState==="visible"&&s()};return document.addEventListener("visibilitychange",D),()=>{clearInterval(d),document.removeEventListener("visibilitychange",D)}},[ae,re]);const H=t.items||[],Qt=S-1,p=S>0&&S<=H.length?H[Qt]:null,U=p?i.find(s=>s.id===p.exercise_id):null,dt=S<H.length?H[S]:null,Bt=dt?i.find(s=>s.id===dt.exercise_id):null,ut=(()=>{const s=U?.muscle_groups??U?.muscles??U?.muscleGroups??[];return Array.isArray(s)?s:[]})(),ye=p?.rest_seconds??0,mt=H.length?Math.min(100,Math.max(0,Math.round((S-1)/H.length*100))):0,Je=Number(p?.percent_1rm),xt=Number.isFinite(Je)&&Je>0,Ht=xt&&o.find(s=>s.exercise_id===p?.exercise_id)?.weight||0,ee=xt?Math.round(Ht*(Je/100)):0,[ie,Se]=n.useState({}),ht=n.useMemo(()=>{const s=new Map;return T.forEach((d,D)=>{const u=Ve(d,D+1);d.exercise_id&&s.set(`${d.exercise_id}-${u}`,d)}),s},[T]),pt=p?`${p.exercise_id}-${h}`:null,Ze=pt?ht.get(pt):null,ft=Ze?.weight??ie[h-1]?.weight??ee,Gt=Ze?.reps??ie[h-1]?.reps??p?.reps??"",Wt=()=>{if(typeof window>"u")return;const s=[De.status.success,De.chart[2],De.chart[3],De.destructive,De.accent],d=120;for(let D=0;D<d;D+=1){const u=document.createElement("div"),oe=Math.random()*6+6;u.style.position="fixed",u.style.top="-10px",u.style.left=`${Math.random()*100}vw`,u.style.width=`${oe}px`,u.style.height=`${oe*.6}px`,u.style.backgroundColor=s[D%s.length],u.style.opacity="0.9",u.style.pointerEvents="none",u.style.zIndex="80",u.style.borderRadius="2px",document.body.appendChild(u);const de=(Math.random()-.5)*200,Ie=1200+Math.random()*800,Oe=Math.random()*360;u.animate([{transform:"translate3d(0, 0, 0) rotate(0deg)",opacity:1},{transform:`translate3d(${de}px, ${window.innerHeight+200}px, 0) rotate(${Oe}deg)`,opacity:0}],{duration:Ie,easing:"ease-out"}).onfinish=()=>u.remove()}};n.useEffect(()=>{if(J.current){j&&$(j);return}if(!j){$(u=>u.length?[]:u),Se(u=>Object.keys(u).length?{}:u);return}if($(j),!j.length){Se(u=>Object.keys(u).length?{}:u),K(u=>u===0?u:0);return}const s=t.items||[];if(!s.length)return;const d=new Map;j.forEach((u,oe)=>{if(!u.exercise_id)return;const de=d.get(u.exercise_id)??[];de.push({...u,set_index:Ve(u,oe+1)}),d.set(u.exercise_id,de)});const D=zt(s,j);if(D>0&&D<=s.length){const u=s[D-1],oe=d.get(u.exercise_id)??[],de=oe.reduce((Oe,Ye,Ut)=>{const Xt=Ve(Ye,Ut+1);return Oe[Xt-1]={reps:Ye.reps??void 0,weight:Ye.weight??void 0},Oe},{});Se(de);const Ie=Math.min(u.sets??1,oe.length+1);E(Ie)}else Se({}),E(1);K(u=>u===D?u:D)},[j,t.items]),n.useEffect(()=>{S<=H.length||_||(Wt(),P(!0))},[S,H.length,_]);const gt=s=>{K(s),N?.(s)},yt=s=>{s<=0||(z.current=Date.now()+s*1e3,F(s),le(!0),O(!1))},Ue=async()=>{window.scrollTo({top:0,behavior:"smooth"});const s=S+1;E(1),Se({}),gt(s);const d=Math.round(Math.min(s-1,H.length)/H.length*100);try{await y?.(d)}catch{L({title:"Erreur de sauvegarde",description:"Réessayez",variant:"destructive"})}},Jt=async()=>{if(!p)return;if(Ze){h>=p.sets?await Ue():E(d=>Math.min(p.sets,d+1));return}const s={exercise_id:p.exercise_id,set_number:h,reps:ie[h-1]?.reps||p.reps,weight:ie[h-1]?.weight??ee};$(d=>[...d,s]),J.current=!0;try{await g?.([s])}catch{L({title:"Erreur de sauvegarde",description:"Réessayez",variant:"destructive"})}finally{J.current=!1}if(ve&&p.rest_seconds>0&&yt(p.rest_seconds),h>=p.sets){await Ue();return}E(d=>Math.min(p.sets,d+1))},bt=s=>{Ee(s);const d=s==="weight"?ie[h-1]?.weight??ee??"":ie[h-1]?.reps??p?.reps??"";Y(d?String(d):""),ge(!!d),we(!0)},Zt=()=>{if(!p)return;const s=Number(X==="weight"?ne.replace(",","."):ne);Number.isFinite(s)&&(Se(d=>({...d,[h-1]:{...d[h-1],[X]:s}})),we(!1))},Xe=s=>{if(We||ne===String(Ke)){ge(!1),Y(s);return}Y(d=>s==="."&&d.includes(".")?d:d+s)},vt=s=>{if(!p)return;Ee(s);const d=s==="weight"?ie[h-1]?.weight??ee??"":ie[h-1]?.reps??p?.reps??"";Y(d?String(d):""),ge(!!d)};return S===0?e.jsxs("div",{className:"space-y-6 text-center py-8 animate-in zoom-in duration-300",children:[e.jsx("div",{className:"h-24 w-24 bg-primary/10 rounded-full flex items-center justify-center mx-auto animate-pulse",children:e.jsx($e,{className:"h-10 w-10 text-primary ml-1"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold font-display uppercase",children:t.title}),e.jsx("p",{className:"text-muted-foreground text-lg",children:t.description}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(wt,{variant:"outline",className:"text-sm px-3 py-1",children:t.cycle}),e.jsxs(wt,{variant:"secondary",className:"text-sm px-3 py-1",children:[H.length," Exercices"]})]})]}),e.jsx(C,{size:"lg",className:"w-full text-xl h-14 font-bold uppercase tracking-wider shadow-lg hover:scale-[1.02] transition-transform",disabled:a,onClick:async()=>{m(!0);try{await x?.(),gt(1)}finally{m(!1)}},children:a?e.jsxs(e.Fragment,{children:[e.jsx(hs,{className:"mr-2 h-5 w-5 animate-spin"}),"CHARGEMENT..."]}):"COMMENCER SÉANCE"})]}):S>H.length?e.jsx("div",{className:"space-y-6 animate-in fade-in",children:e.jsxs(Le,{className:"border-t-8 border-t-primary shadow-xl",children:[e.jsxs(At,{className:"text-center pb-2",children:[e.jsx("div",{className:"mx-auto bg-primary/10 p-4 rounded-full w-fit mb-4",children:e.jsx(ps,{className:"h-12 w-12 text-primary"})}),e.jsx(It,{className:"text-3xl uppercase font-display italic",children:"Séance Terminée !"}),e.jsxs(es,{className:"text-lg",children:["Durée totale: ",Math.floor(q/60),"m ",q%60,"s"]})]}),e.jsxs(ts,{className:"space-y-6 pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-center",children:[e.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[e.jsx("div",{className:"text-xs uppercase font-bold text-muted-foreground",children:"Volume"}),e.jsxs("div",{className:"text-2xl font-mono font-bold",children:[T.reduce((s,d)=>s+(St(d.weight)?0:(Number(d.weight)||0)*(Number(d.reps)||0)),0).toLocaleString("fr-FR")," kg"]})]}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[e.jsx("div",{className:"text-xs uppercase font-bold text-muted-foreground",children:"Séries"}),e.jsx("div",{className:"text-2xl font-mono font-bold",children:T.length})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_e,{className:"uppercase font-bold text-xs text-muted-foreground",children:"Difficulté de la séance"}),e.jsxs("div",{className:"flex items-center justify-between text-[11px] font-semibold text-muted-foreground",children:[e.jsx("span",{children:"Facile"}),e.jsx("span",{children:"Très dur"})]}),e.jsx(Ct,{value:xe,onChange:ce})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_e,{className:"uppercase font-bold text-xs text-muted-foreground",children:"Fatigue fin de séance"}),e.jsxs("div",{className:"flex items-center justify-between text-[11px] font-semibold text-muted-foreground",children:[e.jsx("span",{children:"Frais"}),e.jsx("span",{children:"Épuisé"})]}),e.jsx(Ct,{value:je,onChange:V})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{className:"uppercase font-bold text-xs text-muted-foreground",children:"Notes"}),e.jsx("textarea",{placeholder:"Sensations, douleurs...",value:Ne,onChange:s=>r(s.target.value),rows:3,className:"flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 resize-none"})]})]}),e.jsx(ss,{children:e.jsx(C,{className:"w-full h-14 text-lg font-bold uppercase",disabled:f,onClick:()=>{f||c({duration:Math.floor(q/60),feeling:xe,fatigue:je,comments:Ne,logs:T})},children:f?"ENREGISTREMENT...":"ENREGISTRER & FERMER"})})]})}):e.jsxs("div",{className:"space-y-6 pb-44",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button","aria-label":"Voir l'animation de l'exercice",onClick:()=>{U?.illustration_gif&&Ae(!0)},className:"flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-full border bg-card shadow-sm",children:U?.illustration_gif?e.jsx("img",{src:U.illustration_gif,alt:"",className:"h-full w-full object-cover",loading:"lazy",decoding:"async"}):e.jsx($e,{className:"h-5 w-5 text-muted-foreground"})}),e.jsx("h2",{className:"flex-1 min-w-0 text-lg font-semibold tracking-tight truncate",children:U?.nom_exercice??"Exercice"}),A&&p&&e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>{ot(M?.[p.exercise_id]??""),pe(!0)},"aria-label":"Notes personnelles",children:e.jsx(fs,{className:te("h-4 w-4",M?.[p?.exercise_id]?"text-primary":"text-muted-foreground")})}),v&&e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0","aria-label":"Quitter le focus",onClick:()=>{T.length>0?B(!0):v()},children:e.jsx(qe,{className:"h-4 w-4"})})]}),p&&M?.[p.exercise_id]&&e.jsx("p",{className:"text-xs italic text-muted-foreground line-clamp-2 -mt-1",children:M[p.exercise_id]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"rounded-full bg-primary/10 text-primary px-2.5 py-0.5 text-xs font-bold shrink-0",children:["Ex ",S,"/",H.length]}),e.jsxs("span",{className:"rounded-full bg-muted px-2.5 py-0.5 text-xs font-semibold shrink-0",children:["S ",h,"/",ue(p?.sets)]}),e.jsx("div",{className:"flex-1 h-1.5 overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary transition-all",style:{width:`${mt}%`}})}),e.jsxs("span",{className:"text-xs font-semibold text-muted-foreground shrink-0",children:[mt,"%"]})]}),ut.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:ut.map(s=>e.jsx("span",{className:"rounded-full bg-muted px-2.5 py-0.5 text-xs font-semibold text-muted-foreground",children:s},s))})]}),e.jsxs(Le,{className:"rounded-3xl border bg-card p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"text-sm font-semibold",children:["Série ",h,"/",ue(p?.sets)," · ",ue(p?.reps)," reps"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(xs,{checked:ve,onCheckedChange:Ce,className:"scale-90"}),e.jsx("span",{children:"Auto repos"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",className:"group relative rounded-2xl border-2 border-primary/20 bg-gradient-to-br from-card to-muted/30 p-4 text-left shadow-sm transition-all active:scale-[0.98] hover:border-primary/40 hover:shadow-md",onClick:()=>bt("weight"),children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wide text-muted-foreground",children:"Charge"}),e.jsx("div",{className:"mt-1 flex items-baseline gap-0.5",children:St(ft)?e.jsx("span",{className:"text-2xl font-bold tracking-tight",children:"PDC"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-3xl font-bold tabular-nums tracking-tight",children:ft||"—"}),e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"kg"})]})})]}),e.jsxs("button",{type:"button",className:"group relative rounded-2xl border-2 border-primary/20 bg-gradient-to-br from-card to-muted/30 p-4 text-left shadow-sm transition-all active:scale-[0.98] hover:border-primary/40 hover:shadow-md",onClick:()=>bt("reps"),children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wide text-muted-foreground",children:"Reps"}),e.jsxs("div",{className:"mt-1 flex items-baseline gap-0.5",children:[e.jsx("span",{className:"text-3xl font-bold tabular-nums tracking-tight",children:Gt||"—"}),e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"reps"})]})]})]})]}),(p?.notes||U?.description)&&e.jsxs("div",{className:"rounded-2xl border bg-muted/10 px-4 py-3",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground/70 uppercase tracking-wide mb-1",children:"Notes"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:p?.notes||U?.description})]}),e.jsx(C,{variant:"outline",className:"w-full rounded-2xl",onClick:()=>W(!0),children:"Voir les séries"}),!Me&&!ae?e.jsxs(Kt,{className:"bottom-0 z-modal",containerClassName:"gap-3 py-4",children:[e.jsxs(C,{className:"flex-1 min-w-0 h-12 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition-transform",onClick:Jt,children:[e.jsx(_t,{className:"mr-2 h-5 w-5"})," Valider série"]}),e.jsxs(C,{type:"button",variant:"outline",className:"h-12 rounded-xl px-3 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform",onClick:()=>{ye>0&&yt(ye)},disabled:ye<=0,"aria-label":"Démarrer le repos",children:[e.jsx(gs,{className:"h-4 w-4"}),e.jsx("span",{className:"text-[10px] font-semibold leading-none",children:"Repos"})]}),e.jsxs(C,{type:"button",variant:"outline",className:"h-12 rounded-xl px-3 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform",onClick:()=>Ue(),"aria-label":"Exercice suivant",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx("span",{className:"text-[10px] font-semibold leading-none",children:"Passer"})]})]}):null,ae&&e.jsxs("div",{className:"fixed inset-0 z-modal flex flex-col bg-background/95 pb-[env(safe-area-inset-bottom)]",children:[e.jsxs("div",{className:"flex items-start justify-between border-b px-6 py-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Timer"}),e.jsx("div",{className:"text-lg font-semibold",children:"Transition inter-exercice"}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Prochain exercice : ",Bt?.nom_exercice??"À venir"]})]}),e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>{le(!1),O(!1)},"aria-label":"Fermer le timer de repos",children:e.jsx(qe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center gap-6 px-6 py-8",children:[e.jsxs(Le,{className:"w-full max-w-sm rounded-3xl border p-6 shadow-sm",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Temps restant"}),e.jsxs("div",{className:"mt-2 text-5xl font-semibold tracking-tight",children:[Math.floor(w/60),":",String(w%60).padStart(2,"0")]}),e.jsx("div",{className:"mt-6 h-3 w-full overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary",style:{width:ye?`${w/ye*100}%`:"0%"}})}),e.jsxs("div",{className:"mt-6 flex gap-3",children:[e.jsx(C,{variant:"outline",className:"flex-1 h-12 rounded-full text-base font-semibold",onClick:()=>{z.current+=30*1e3,F(s=>s+30)},children:"+30s"}),e.jsxs(C,{variant:"outline",className:"flex-1 h-12 rounded-full text-base font-semibold",onClick:()=>{z.current=Date.now()+ye*1e3,F(ye)},children:[e.jsx(rs,{className:"mr-2 h-4 w-4"})," Reset"]})]})]}),e.jsxs("div",{className:"flex w-full max-w-sm flex-wrap gap-3",children:[e.jsxs(C,{className:"flex-1 rounded-full py-6 text-base font-semibold",onClick:()=>{re&&(z.current=Date.now()+w*1e3),O(s=>!s)},children:[e.jsx(As,{className:"mr-2 h-4 w-4"})," ",re?"Reprendre":"Pause"]}),e.jsxs(C,{variant:"outline",className:"rounded-full px-6 py-6 text-base font-semibold",onClick:()=>{z.current=0,le(!1),F(0),O(!1)},children:["Passer ",e.jsx(Qe,{className:"ml-2 h-4 w-4"})]})]})]})]}),Re&&U?.illustration_gif&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50",onClick:()=>Ae(!1),children:e.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{type:"button","aria-label":"Fermer",className:"absolute -right-3 -top-3 rounded-full bg-background p-2 shadow",onClick:()=>Ae(!1),children:e.jsx(qe,{className:"h-4 w-4"})}),e.jsx("img",{src:U.illustration_gif,alt:"",className:"max-h-[80vh] w-auto max-w-[92vw] rounded-2xl",loading:"lazy"})]})})}),e.jsx(rt,{open:ke,onOpenChange:W,children:e.jsxs(nt,{side:"bottom",className:"max-h-[80vh] overflow-y-auto",children:[e.jsx(it,{children:e.jsx(at,{children:"Aperçu séance"})}),e.jsx("div",{className:"mt-4 space-y-4",children:H.map((s,d)=>{const D=i.find(de=>de.id===s.exercise_id),u=Array.from({length:s.sets}).filter((de,Ie)=>ht.get(`${s.exercise_id}-${Ie+1}`)).length,oe=s.sets?Math.round(u/s.sets*100):0;return e.jsxs(Le,{className:"rounded-3xl border bg-muted/10 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:D?.nom_exercice??s.exercise_name}),e.jsxs("div",{className:"mt-1 text-sm text-muted-foreground",children:[ue(s.sets),"x",ue(s.reps)," ·"," ",s.percent_1rm?`${ue(s.percent_1rm)} 1RM`:"—"]})]}),e.jsxs("div",{className:"rounded-full bg-muted px-3 py-1 text-sm font-semibold",children:[u,"/",ue(s.sets)]})]}),e.jsx("div",{className:"mt-4 h-3 w-full overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary",style:{width:`${oe}%`}})})]},`${s.exercise_id}-${d}`)})})]})}),e.jsx(ls,{open:Me,onOpenChange:we,children:e.jsx(cs,{className:"max-h-[90vh]",children:e.jsxs("div",{className:"mx-auto w-full max-w-md px-4 pb-8",children:[e.jsxs(os,{className:"pb-2",children:[e.jsx(ds,{className:"text-center",children:X==="weight"?"Charge":"Répétitions"}),e.jsxs(us,{className:"text-center",children:["Série ",h,"/",ue(p?.sets)," · Objectif"," ",ue(p?.reps)," reps"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("button",{type:"button",className:te("rounded-xl border-2 p-4 text-center transition-all",X==="weight"?"border-primary bg-primary/10 shadow-sm":"border-muted bg-card hover:border-muted-foreground/30"),onClick:()=>vt("weight"),children:[e.jsx("div",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Charge"}),e.jsx("div",{className:"mt-1 text-2xl font-bold tabular-nums",children:(()=>{const s=X==="weight"?ne:String(ie[h-1]?.weight??ee??"");return s===String(Ke)?"PDC":e.jsxs(e.Fragment,{children:[s||"—",e.jsx("span",{className:"ml-1 text-base font-normal text-muted-foreground",children:"kg"})]})})()})]}),e.jsxs("button",{type:"button",className:te("rounded-xl border-2 p-4 text-center transition-all",X==="reps"?"border-primary bg-primary/10 shadow-sm":"border-muted bg-card hover:border-muted-foreground/30"),onClick:()=>vt("reps"),children:[e.jsx("div",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Reps"}),e.jsxs("div",{className:"mt-1 text-2xl font-bold tabular-nums",children:[X==="reps"?ne||"—":String(ie[h-1]?.reps??p?.reps??"—"),e.jsx("span",{className:"ml-1 text-base font-normal text-muted-foreground",children:"reps"})]})]})]}),X==="weight"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-2",children:"Suggestions"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(C,{variant:ne===String(Ke)?"default":"outline",size:"sm",className:"rounded-full px-4 h-10 text-sm font-semibold",onClick:()=>Y(String(Ke)),children:"PDC"}),ee>0&&[ee-10,ee-5,ee,ee+5,ee+10].filter(s=>s>0).map(s=>e.jsxs(C,{variant:Number(ne)===s?"default":"outline",size:"sm",className:"rounded-full px-4 h-10 text-sm font-semibold",onClick:()=>Y(String(s)),children:[s," kg"]},s))]})]}),X==="reps"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-2",children:"Suggestions"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:[6,8,10,12,15,20].map(s=>e.jsx(C,{variant:Number(ne)===s?"default":"outline",size:"sm",className:"rounded-full px-4 h-10 text-sm font-semibold",onClick:()=>Y(String(s)),children:s},s))})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4",children:[[1,2,3,4,5,6,7,8,9].map(s=>e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>Xe(String(s)),children:s},s)),e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>Xe("."),children:","}),e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>Xe("0"),children:"0"}),e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>{ge(!1),Y(s=>s.slice(0,-1))},children:"⌫"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(C,{variant:"outline",className:"flex-1 h-14 text-base font-semibold rounded-xl",onClick:()=>{ge(!1),Y("")},children:"Effacer"}),e.jsxs(C,{className:"flex-1 h-14 text-base font-semibold rounded-xl",onClick:Zt,children:[e.jsx(_t,{className:"mr-2 h-5 w-5"}),"Valider"]})]})]})})}),v&&e.jsx(Dt,{open:Q,onOpenChange:B,children:e.jsxs(Tt,{children:[e.jsxs(Ft,{children:[e.jsx(Lt,{children:"Quitter la séance ?"}),e.jsx(Pt,{children:"Les séries enregistrées seront conservées."})]}),e.jsxs(qt,{children:[e.jsx($t,{children:"Annuler"}),e.jsx(Ot,{onClick:()=>{B(!1),v()},children:"Quitter"})]})]})}),A&&e.jsx(rt,{open:he,onOpenChange:s=>{if(!s&&p){const d=ct.trim()||null,D=M?.[p.exercise_id]??null;d!==D&&A(p.exercise_id,d)}pe(s)},children:e.jsxs(nt,{side:"bottom",className:"max-h-[60vh]",children:[e.jsx(it,{children:e.jsxs(at,{children:["Notes — ",U?.nom_exercice]})}),e.jsx("textarea",{value:ct,onChange:s=>ot(s.target.value),placeholder:"Réglages machine, repères personnels...",rows:4,className:"flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm mt-4 resize-none ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"})]})})]})}const Vt=(t=[])=>{if(!t.length)return t;const i=t.map((c,x)=>{const g=Number(c.order_index);return{item:c,index:x,order:Number.isFinite(g)?g:null}});return i.some(c=>c.order!==null)?i.sort((c,x)=>c.order===null&&x.order===null?c.index-x.index:c.order===null?1:x.order===null?-1:c.order===x.order?c.index-x.index:c.order-x.order).map(c=>c.item):t},et=t=>t==="endurance"||t==="hypertrophie"||t==="force"?t:"endurance",$s=[{value:"endurance",label:"Endurance",subtitle:"Léger",icon:ys},{value:"hypertrophie",label:"Hypertrophie",subtitle:"Modéré",icon:Fs},{value:"force",label:"Force",subtitle:"Lourd",icon:Ds}],Os={visible:{transition:{staggerChildren:.06}}},Ks={hidden:{opacity:0,y:16},visible:{opacity:1,y:0,transition:{type:"spring",stiffness:400,damping:30}}};function zs({user:t,userId:i,athleteName:o,athleteId:c,athleteKey:x,cycleType:g,searchQuery:y,isLoading:j,setSaveState:f,onCycleChange:k,onSearchChange:N,onStartAssignment:l,onStartCatalog:R,onResumeInProgress:v}){const{toast:M}=lt(),A=Rt(),[L,J]=n.useState(null),[S,K]=n.useState(!1),[T,$]=n.useState(null),[q,se]=n.useState(!1),{data:Z}=fe({queryKey:["assignments",t,"strength"],queryFn:()=>G.getAssignments(t,i,{assignmentType:"strength"}),enabled:!!t}),{data:me}=fe({queryKey:["strength_catalog"],queryFn:()=>G.getStrengthSessions()}),{data:b}=fe({queryKey:["exercises"],queryFn:()=>G.getExercises()}),w=fe({queryKey:["strength_run_in_progress",x],queryFn:()=>G.getStrengthHistory(o,{limit:1,offset:0,order:"desc",status:"in_progress",athleteId:c}),enabled:!!o}).data?.runs?.[0]??null,F=w?.status==="completed"||(w?.progress_pct??0)>=100,ae=Fe({mutationFn:r=>G.deleteStrengthRun(r),onMutate:()=>{f("saving")},onSuccess:r=>{f("saved"),setTimeout(()=>f("idle"),2e3),A.invalidateQueries({queryKey:["strength_run_in_progress",x]}),A.invalidateQueries({queryKey:["strength_history"]}),A.invalidateQueries({queryKey:["assignments",t,"strength"]});const _=r?.source==="local"?"Suppression locale : le serveur n'est pas disponible.":void 0;M({title:"Séance supprimée",description:_})},onError:()=>{f("error"),setTimeout(()=>f("idle"),3e3),M({title:"Erreur",description:"Impossible de supprimer la séance en cours.",variant:"destructive"})}});n.useMemo(()=>b?new Map(b.map(r=>[r.id,r])):new Map,[b]);const le=n.useMemo(()=>Z?.filter(r=>r.session_type==="strength")||[],[Z]),re=n.useMemo(()=>le.filter(r=>r.status!=="completed"),[le]),O=n.useMemo(()=>w?re.find(r=>r.id===w.assignment_id)??null:null,[w,re]),z=n.useMemo(()=>w&&!O?me?.find(r=>r.id===w.session_id)??null:null,[w,O,me]),ve=(!!O?.items?.length||!!z?.items?.length)&&!F,Ce=n.useMemo(()=>re.map(r=>{const _=(r.items??[]).filter(P=>"exercise_id"in P);return{key:`assignment-${r.id}`,title:r.title,description:r.description,type:"assignment",assignedDate:r.assigned_date,session:{id:r.session_id,title:r.title,description:r.description,cycle:et(r.cycle),items:_},assignment:r,exerciseCount:_.length}}),[re]),xe=n.useMemo(()=>(me??[]).map(r=>({key:`catalog-${r.id}`,title:r.title,description:r.description,type:"catalog",session:{...r,cycle:g},exerciseCount:r.items?.length??0})),[me,g]),ce=n.useMemo(()=>{const r=y.trim().toLowerCase(),_=[...Ce,...xe];return r?_.filter(P=>`${P.title} ${P.description}`.toLowerCase().includes(r)):_},[Ce,xe,y]),je=n.useCallback((r,_)=>{if(!["ArrowUp","ArrowDown","Enter"].includes(r.key))return;if(r.preventDefault(),r.key==="Enter"){const E=ce[_];E.type==="assignment"&&E.assignment?l(E.assignment):R(E.session);return}let h=_;r.key==="ArrowUp"&&(h=Math.max(0,_-1)),r.key==="ArrowDown"&&(h=Math.min(ce.length-1,_+1)),J(h),setTimeout(()=>{const E=document.querySelectorAll('[data-session-card="true"]');E[h]&&E[h].focus()},0)},[ce,l,R]);if(j)return e.jsxs("div",{className:"space-y-5 pt-2",children:[e.jsx("div",{className:"grid grid-cols-3 gap-2",children:[1,2,3].map(r=>e.jsx("div",{className:"h-[60px] rounded-2xl bg-muted/50 animate-pulse"},r))}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(r=>e.jsxs("div",{className:"flex items-center gap-4 rounded-2xl bg-card p-4 shadow-sm",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-muted animate-pulse"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-3/5 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-2/5 rounded bg-muted animate-pulse"})]})]},r))})]});const V=ce.length,Ne=V>4||y.length>0;return e.jsxs("div",{className:"space-y-5 animate-in fade-in motion-reduce:animate-none",children:[e.jsx("div",{className:"grid grid-cols-3 gap-2",children:$s.map(r=>{const _=g===r.value,P=r.icon;return e.jsxs("button",{type:"button",onClick:()=>k(et(r.value)),className:te("relative flex flex-col items-center gap-0.5 rounded-2xl px-2 py-3 transition-all active:scale-[0.96]",_?"bg-primary text-primary-foreground shadow-md shadow-primary/25":"bg-muted/40 text-muted-foreground hover:bg-muted/60"),children:[e.jsx(P,{className:te("h-4 w-4 mb-0.5",_?"text-primary-foreground":"text-muted-foreground/60")}),e.jsx("span",{className:"text-[13px] font-bold leading-tight",children:r.label}),e.jsx("span",{className:te("text-[10px] leading-tight",_?"text-primary-foreground/70":"text-muted-foreground/50"),children:r.subtitle})]},r.value)})}),w&&e.jsxs(Pe.div,{initial:{opacity:0,scale:.97},animate:{opacity:1,scale:1},transition:{type:"spring",stiffness:300,damping:25},className:"relative isolate overflow-hidden rounded-2xl bg-gradient-to-br from-primary via-primary to-primary/85 text-primary-foreground p-5 shadow-xl shadow-primary/20",children:[e.jsx("div",{className:"pointer-events-none absolute -top-10 -right-10 h-32 w-32 rounded-full bg-white/10 blur-3xl"}),e.jsx("div",{className:"pointer-events-none absolute -bottom-8 -left-8 h-24 w-24 rounded-full bg-white/5 blur-2xl"}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsxs("span",{className:"relative flex h-2.5 w-2.5",children:[!F&&e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-60"}),e.jsx("span",{className:"relative inline-flex rounded-full h-2.5 w-2.5 bg-white"})]}),e.jsx("span",{className:"text-[11px] font-bold uppercase tracking-widest text-white/80",children:F?"Complétée":"En cours"})]}),e.jsx("h3",{className:"font-display text-xl font-bold uppercase tracking-tight leading-tight mb-1",children:O?.title??z?.title??"Séance en cours"}),e.jsxs("p",{className:"text-sm text-white/50 mb-4",children:["Démarrée le"," ",He(new Date(w.started_at||new Date),"dd MMMM",{locale:Be})]}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("div",{className:"flex justify-between text-[11px] font-bold uppercase tracking-wider mb-1.5",children:[e.jsx("span",{className:"text-white/50",children:"Progression"}),e.jsxs("span",{className:"text-white",children:[Math.round(w.progress_pct??0),"%"]})]}),e.jsx("div",{className:"h-1.5 rounded-full bg-white/15 overflow-hidden",children:e.jsx(Pe.div,{className:"h-full rounded-full bg-white",initial:{width:0},animate:{width:`${w.progress_pct??0}%`},transition:{duration:.8,ease:"easeOut"}})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"secondary",className:"flex-1 h-11 rounded-xl bg-white text-primary font-bold text-sm hover:bg-white/90 shadow-none",disabled:!ve,onClick:()=>{const r=O??z;if(!r)return;const P=(O?.items??z?.items??[]).filter(W=>"exercise_id"in W),h=et(O?.cycle??z?.cycle??P.find(W=>W.cycle_type)?.cycle_type),E=P.filter(W=>W.cycle_type===h),ke=Vt(E.length?E:P);v({assignment:O??null,session:{...r,title:r.title,description:r.description??null,cycle:h,items:ke},runId:w.id,logs:w.logs??[],progressPct:w.progress_pct??0})},children:F?"Voir le résumé":"Reprendre"}),!F&&e.jsx("button",{type:"button",className:"flex h-11 w-11 items-center justify-center rounded-xl border border-white/20 text-white/70 transition hover:bg-white/10 hover:text-white active:scale-95",disabled:ae.isPending,onClick:()=>{w&&($(w.id),K(!0))},"aria-label":"Supprimer la séance",children:e.jsx(qe,{className:"h-4.5 w-4.5"})})]})]})]}),Ne&&e.jsxs("div",{className:"relative",children:[e.jsx(bs,{className:"absolute left-3.5 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground/50 pointer-events-none"}),e.jsx(st,{placeholder:"Rechercher une séance...",className:"h-11 rounded-2xl bg-muted/30 pl-10 pr-4 border-0 text-sm focus-visible:ring-2 focus-visible:ring-primary/30",value:y,onChange:r=>N(r.target.value),"aria-label":"Rechercher une séance"}),y&&e.jsx("button",{type:"button",className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground/40 hover:text-muted-foreground transition",onClick:()=>N(""),"aria-label":"Effacer la recherche",children:e.jsx(qe,{className:"h-4 w-4"})})]}),V>0&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-[11px] font-bold uppercase tracking-widest text-muted-foreground/60",children:[V," séance",V>1?"s":""]}),e.jsx("div",{className:"flex-1 h-px bg-border/50"})]}),V>0?e.jsx(Pe.div,{className:"space-y-2.5 motion-reduce:animate-none",variants:Os,initial:"hidden",animate:"visible",children:ce.map((r,_)=>{const P=L===_||L===null&&_===0,h=r.type==="assignment";return e.jsx(Pe.button,{type:"button",tabIndex:P?0:-1,"data-session-card":"true",onKeyDown:E=>je(E,_),variants:Ks,className:te("group w-full rounded-2xl bg-card text-left transition-all active:scale-[0.98] hover:shadow-md focus:outline-none motion-reduce:animate-none",h?"shadow-sm ring-1 ring-primary/10":"shadow-sm",P&&"ring-2 ring-primary/40"),onClick:()=>{if(h&&r.assignment){l(r.assignment);return}R(r.session)},children:e.jsxs("div",{className:"flex items-center gap-3.5 p-3.5",children:[e.jsx("div",{className:te("flex h-12 w-12 shrink-0 items-center justify-center rounded-xl transition-colors",h?"bg-primary/10 text-primary":"bg-muted/60 text-muted-foreground"),children:e.jsx("span",{className:te("font-display text-lg font-bold",h&&"text-primary"),children:r.exerciseCount})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-0.5",children:e.jsx("h3",{className:"font-display font-bold text-[15px] uppercase tracking-tight truncate leading-tight",children:r.title})}),e.jsxs("div",{className:"flex items-center gap-1.5 text-[13px] text-muted-foreground",children:[h&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"inline-flex items-center rounded-md bg-primary/8 px-1.5 py-px text-[10px] font-bold uppercase tracking-wider text-primary",children:"Coach"}),e.jsx("span",{className:"text-border",children:"·"})]}),e.jsxs("span",{children:[r.exerciseCount," exercice",r.exerciseCount>1?"s":""]}),h&&r.assignedDate&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-border",children:"·"}),e.jsx("span",{children:He(new Date(r.assignedDate),"dd MMM",{locale:Be})})]}),!h&&r.description&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-border",children:"·"}),e.jsx("span",{className:"truncate",children:r.description})]})]})]}),e.jsx(Qe,{className:"h-5 w-5 shrink-0 text-muted-foreground/25 transition-all group-hover:translate-x-0.5 group-hover:text-primary/60"})]})},r.key)})}):e.jsxs("div",{className:"py-16 text-center",children:[e.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-muted/40",children:e.jsx($e,{className:"h-7 w-7 text-muted-foreground/40"})}),e.jsx("h3",{className:"font-display font-bold text-sm uppercase tracking-tight",children:"Aucune séance trouvée"}),e.jsx("p",{className:"text-[13px] text-muted-foreground/60 mt-1.5 max-w-[240px] mx-auto",children:"Changez de cycle ou modifiez votre recherche pour trouver une séance."})]}),e.jsx(Dt,{open:S,onOpenChange:K,children:e.jsxs(Tt,{children:[e.jsxs(Ft,{children:[e.jsx(Lt,{children:"Supprimer la séance ?"}),e.jsx(Pt,{children:"Les séries déjà enregistrées seront perdues."})]}),e.jsxs(qt,{children:[e.jsx($t,{children:"Annuler"}),e.jsx(Ot,{className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",onClick:()=>{T&&ae.mutate(T),K(!1)},children:"Supprimer"})]})]})})]})}const kt=t=>{const i=Number(t);return!Number.isFinite(i)||i<=0?"—":String(i)},Vs=t=>{const i=Number(t);return!Number.isFinite(i)||i<=0?"—":`${i}s`};function Qs({session:t,assignment:i,cycleType:o,cycleOptions:c,exercises:x,oneRMs:g,saveState:y,onBack:j,onLaunch:f}){const k=n.useMemo(()=>new Map(x.map(l=>[l.id,l])),[x]),N=t.items??[];return e.jsxs(Pe.div,{className:"space-y-5 pb-36",variants:vs,initial:"hidden",animate:"visible",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:j,className:"flex h-10 w-10 items-center justify-center rounded-full bg-muted/50 text-muted-foreground transition-colors hover:bg-muted active:scale-95","aria-label":"Retour",children:e.jsx(js,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground truncate",children:c.find(l=>l.value===o)?.label}),e.jsx("h1",{className:"text-xl font-bold tracking-tight truncate",children:t.title})]})]}),e.jsxs("div",{className:"relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary/10 via-primary/5 to-transparent border border-primary/20 p-5",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl -mr-12 -mt-12"}),e.jsxs("div",{className:"relative space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[i&&e.jsxs("span",{className:"inline-flex items-center gap-1.5 rounded-full bg-primary/20 px-3 py-1 text-xs font-bold uppercase text-primary",children:[e.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-primary"}),"Assignée"]}),!i&&e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-3 py-1 text-xs font-semibold text-muted-foreground",children:"Catalogue"}),i?.assigned_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Prévue le ",He(new Date(i.assigned_date),"dd MMM",{locale:Be})]})]}),t.description&&e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:t.description}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-9 w-9 items-center justify-center rounded-xl bg-background/80",children:e.jsx($e,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:N.length}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold",children:"Exercices"})]})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-9 w-9 items-center justify-center rounded-xl bg-background/80",children:e.jsx(Es,{className:"h-4 w-4 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:c.find(l=>l.value===o)?.label}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold",children:"Cycle"})]})]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 pt-1",children:[e.jsxs("span",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:[N.length," exercice",N.length>1?"s":""]}),e.jsx("div",{className:"flex-1 h-px bg-border"})]}),e.jsxs("div",{className:"space-y-2",children:[N.map((l,R)=>{const v=k.get(l.exercise_id),M=Number(l.percent_1rm),A=Number.isFinite(M)&&M>0,L=A?g?.find(se=>se.exercise_id===l.exercise_id)?.weight??0:0,J=A?Math.round(L*(M/100)):0,S=A?J>0?`${J} kg (${M}% 1RM)`:`${M}% 1RM`:null,K=l.notes?.trim(),T=kt(l.sets),$=kt(l.reps),q=Vs(l.rest_seconds);return e.jsxs(rt,{children:[e.jsx(ms,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-3 rounded-xl border bg-card px-3 py-3 text-left transition-all active:scale-[0.98] hover:border-primary/50 hover:shadow-sm",children:[e.jsx("div",{className:"flex h-7 w-7 shrink-0 items-center justify-center rounded-full bg-primary text-xs font-bold text-primary-foreground",children:R+1}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"font-semibold text-sm truncate",children:v?.nom_exercice??l.exercise_name??"Exercice"})}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 text-xs font-medium text-muted-foreground",children:[e.jsxs("span",{className:"font-mono",children:[T,"×",$]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsx("span",{className:"font-mono",children:q}),e.jsx(Qe,{className:"h-4 w-4 text-muted-foreground/50"})]})]})}),e.jsxs(nt,{side:"bottom",className:"max-h-[90vh] overflow-y-auto rounded-t-3xl pb-8",children:[e.jsx(it,{className:"text-left pb-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-primary text-sm font-bold text-primary-foreground",children:R+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(at,{className:"text-xl leading-tight",children:v?.nom_exercice??l.exercise_name??"Exercice"}),v?.exercise_type&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5",children:v.exercise_type})]})]})}),e.jsxs("div",{className:"space-y-4",children:[v?.illustration_gif&&e.jsx("div",{className:"rounded-xl overflow-hidden bg-muted/20 border aspect-video flex items-center justify-center",children:e.jsx("img",{src:v.illustration_gif,alt:v.nom_exercice??"Exercice",className:"w-full h-full max-h-36 object-contain",loading:"lazy",decoding:"async"})}),v?.description&&e.jsx("div",{className:"text-sm text-muted-foreground leading-relaxed",children:v.description}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold leading-none",children:T}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Séries"})]}),e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold leading-none",children:$}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Reps"})]}),e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:S??"—"}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Charge"})]}),e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:q}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Repos"})]})]}),K&&e.jsxs("div",{className:"rounded-xl bg-primary/5 border border-primary/20 p-4",children:[e.jsx("div",{className:"text-[10px] uppercase text-primary font-semibold mb-1",children:"Notes coach"}),e.jsx("div",{className:"text-sm text-foreground",children:K})]})]})]})]},`${l.exercise_id}-${R}`)}),N.length===0&&e.jsx("div",{className:"p-6 border-2 border-dashed rounded-xl text-center text-muted-foreground",children:"Aucun exercice disponible pour cette séance."})]}),e.jsx(Kt,{saveState:y,className:"bottom-0",children:e.jsxs(C,{variant:"default",className:"flex-1 h-14 rounded-xl font-bold text-base shadow-lg",onClick:f,children:[e.jsx(Ns,{className:"h-5 w-5 mr-2"}),"Lancer la séance"]})})]})}function Bs({athleteName:t,athleteId:i,athleteKey:o}){const[c,x]=n.useState("all"),[g,y]=n.useState(""),[j,f]=n.useState(""),k=Yt({queryKey:["strength_history",o,c,g,j],queryFn:({pageParam:l=0})=>G.getStrengthHistory(t,{athleteId:i,limit:10,offset:l,order:"desc",status:c==="all"?void 0:c,from:g||void 0,to:j||void 0}),enabled:!!t,getNextPageParam:l=>{const R=l.pagination.offset+l.pagination.limit;return R<l.pagination.total?R:void 0},initialPageParam:0}),N=k.data?.pages.flatMap(l=>l.runs)??[];return e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(_e,{htmlFor:"strength-history-status",children:"Statut"}),e.jsxs(ws,{value:c,onValueChange:x,children:[e.jsx(Ss,{id:"strength-history-status",children:e.jsx(_s,{placeholder:"Tous"})}),e.jsxs(Cs,{children:[e.jsx(ze,{value:"all",children:"Tous"}),e.jsx(ze,{value:"in_progress",children:"En cours"}),e.jsx(ze,{value:"completed",children:"Terminé"}),e.jsx(ze,{value:"abandoned",children:"Abandonné"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(_e,{htmlFor:"strength-history-from",children:"Du"}),e.jsx(st,{id:"strength-history-from",type:"date",value:g,onChange:l=>y(l.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(_e,{htmlFor:"strength-history-to",children:"Au"}),e.jsx(st,{id:"strength-history-to",type:"date",value:j,onChange:l=>f(l.target.value)})]})]}),N.map(l=>e.jsx(Le,{className:"group hover:border-primary/50 transition-colors",children:e.jsxs(At,{className:"pb-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(It,{className:"text-base font-bold uppercase",children:He(new Date(l.started_at||l.date||l.created_at||new Date),"dd MMM yyyy",{locale:Be})}),e.jsxs("div",{className:"text-sm font-mono font-bold text-muted-foreground group-hover:text-primary",children:[l.duration??0," min"]})]}),e.jsxs("div",{className:"flex gap-2 text-xs font-bold text-muted-foreground",children:[e.jsxs("span",{children:["Difficulté ",l.feeling??l.rpe??0,"/5"]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:[l.logs?.length||0," Séries"]})]})]})},l.id)),N.length===0&&e.jsx("div",{className:"text-center text-muted-foreground py-10",children:"Aucun historique."}),k.hasNextPage&&e.jsx(C,{variant:"outline",size:"sm",className:"w-full",onClick:()=>k.fetchNextPage(),disabled:k.isFetchingNextPage,children:k.isFetchingNextPage?"Chargement...":"Charger plus"})]})}const Hs=t=>t==="endurance"||t==="hypertrophie"||t==="force"?t:"endurance";function Gs({athleteKey:t}){const i="strength-preferences",o=n.useMemo(()=>`strength-focus-state-${t??"anonymous"}`,[t]),[c,x]=n.useState(null),[g,y]=n.useState(null),[j,f]=n.useState(null),[k,N]=n.useState(null),[l,R]=n.useState(0),[v,M]=n.useState("list"),[A,L]=n.useState(!1),[J,S]=n.useState("idle"),[K,T]=n.useState({poolMode:!1,largeText:!1}),[$,q]=n.useState(""),[se,Z]=n.useState("endurance");return n.useEffect(()=>{if(typeof window>"u")return;const b=window.localStorage.getItem(i);if(b)try{const I=JSON.parse(b);T(w=>({...w,...I??{}}))}catch{return}},[]),n.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(i,JSON.stringify(K))},[i,K]),n.useEffect(()=>{if(!(typeof document>"u")){if(v==="focus")return document.body.dataset.focusMode="strength",()=>{document.body.dataset.focusMode==="strength"&&delete document.body.dataset.focusMode};document.body.dataset.focusMode==="strength"&&delete document.body.dataset.focusMode}},[v]),n.useEffect(()=>{if(typeof window>"u"||c)return;const b=window.localStorage.getItem(o);if(b)try{const I=JSON.parse(b),w=I?.screenMode==="focus"?"focus":I?.screenMode==="reader"?"reader":null;if(!w||!I?.session)return;x(I.session),y(I.assignment??null),f(typeof I.runId=="number"?I.runId:null),N(Array.isArray(I.runLogs)?I.runLogs:null),R(Number.isFinite(I.runnerStep)?I.runnerStep:0),I.cycleType&&Z(Hs(I.cycleType)),M(w)}catch{return}},[c,o]),n.useEffect(()=>{if(typeof window>"u")return;if(!(v==="focus"||v==="reader")||!c){window.localStorage.removeItem(o);return}const I={screenMode:v,session:c,assignment:g,runId:j,runLogs:k,runnerStep:l,cycleType:se};window.localStorage.setItem(o,JSON.stringify(I))},[g,j,k,l,c,se,o,v]),{activeSession:c,setActiveSession:x,activeAssignment:g,setActiveAssignment:y,activeRunId:j,setActiveRunId:f,activeRunLogs:k,setActiveRunLogs:N,activeRunnerStep:l,setActiveRunnerStep:R,screenMode:v,setScreenMode:M,isFinishing:A,setIsFinishing:L,saveState:J,setSaveState:S,preferences:K,setPreferences:T,searchQuery:$,setSearchQuery:q,cycleType:se,setCycleType:Z,clearActiveRunState:()=>{x(null),y(null),f(null),N(null),R(0),M("list")}}}const Mt=t=>t==="endurance"||t==="hypertrophie"||t==="force"?t:"endurance",Te=t=>{const i=Number(t);return!Number.isFinite(i)||i<=0?null:i},Ws=(t,i)=>{if(!t)return{sets:null,reps:null,percent1rm:null,restSeries:null,restExercise:null};const o={endurance:{sets:t.Nb_series_endurance,reps:t.Nb_reps_endurance,percent1rm:t.pct_1rm_endurance,restSeries:t.recup_endurance,restExercise:t.recup_exercices_endurance},hypertrophie:{sets:t.Nb_series_hypertrophie,reps:t.Nb_reps_hypertrophie,percent1rm:t.pct_1rm_hypertrophie,restSeries:t.recup_hypertrophie,restExercise:t.recup_exercices_hypertrophie},force:{sets:t.Nb_series_force,reps:t.Nb_reps_force,percent1rm:t.pct_1rm_force,restSeries:t.recup_force,restExercise:t.recup_exercices_force}}[i];return{sets:Te(o.sets),reps:Te(o.reps),percent1rm:Te(o.percent1rm),restSeries:Te(o.restSeries),restExercise:Te(o.restExercise)}},Js=(t=[],i)=>{const o=t.filter(x=>x.cycle_type===i),c=o.length?o:t;return Vt(c)},tt=(t=[],i,o)=>Js(t,i).map(c=>{const x=Ws(o.get(c.exercise_id),i);return{...c,sets:x.sets??0,reps:x.reps??0,rest_seconds:x.restSeries??0,percent_1rm:x.percent1rm??0}}),Dr=t=>{t.setActiveSession(null),t.setActiveAssignment(null),t.setActiveRunId(null),t.setActiveRunLogs(null),t.setActiveRunnerStep(0),t.setScreenMode("list")},Zs=({runId:t,assignmentId:i,startedAt:o})=>({id:t,assignment_id:i??null,started_at:o,progress_pct:0,status:"in_progress",logs:[]}),Et=t=>({runs:t?[t]:[],pagination:{limit:1,offset:0,total:t?1:0},exercise_summary:[]});function Tr(){const{user:t,userId:i,role:o,selectedAthleteId:c,selectedAthleteName:x}=ns(),{toast:g}=lt(),y=Rt(),j=(o==="coach"||o==="admin")&&(c!==null||!!x),f=j?x:t,k=j?c:i,N=k??f,{activeSession:l,setActiveSession:R,activeAssignment:v,setActiveAssignment:M,activeRunId:A,setActiveRunId:L,activeRunLogs:J,setActiveRunLogs:S,activeRunnerStep:K,setActiveRunnerStep:T,screenMode:$,setScreenMode:q,isFinishing:se,setIsFinishing:Z,saveState:me,setSaveState:b,searchQuery:I,setSearchQuery:w,cycleType:F,setCycleType:ae}=Gs({athleteKey:N}),le=[{value:"endurance",label:"Endurance"},{value:"hypertrophie",label:"Hypertrophie"},{value:"force",label:"Force"}],{data:re,isLoading:O,error:z,refetch:ve}=fe({queryKey:["assignments",t,"strength"],queryFn:()=>G.getAssignments(t,i,{assignmentType:"strength"}),enabled:!!t}),{data:Ce,isLoading:xe,error:ce,refetch:je}=fe({queryKey:["strength_catalog"],queryFn:()=>G.getStrengthSessions()}),{data:V,error:Ne,refetch:r}=fe({queryKey:["exercises"],queryFn:()=>G.getExercises()}),_=O||xe,P=z||ce||Ne,h=()=>{ve(),je(),r()},{data:E}=fe({queryKey:["1rm",t,i],queryFn:()=>G.get1RM({athleteName:t,athleteId:i}),enabled:!!t}),ke=n.useMemo(()=>{const a={};return(E??[]).forEach(m=>{m.notes&&(a[m.exercise_id]=m.notes)}),a},[E]),W=n.useMemo(()=>V?new Map(V.map(a=>[a.id,a])):new Map,[V]),Me=n.useMemo(()=>l?tt(l.items??[],F,W):[],[l,F,W]),we=Fe({mutationFn:a=>G.startStrengthRun(a),onMutate:()=>{b("saving")},onSuccess:a=>{if(b("saved"),setTimeout(()=>b("idle"),2e3),a?.run_id&&(L(a.run_id),S(m=>m??[]),N)){const m=Zs({runId:a.run_id,assignmentId:v?.id??null,startedAt:new Date().toISOString()});y.setQueryData(["strength_run_in_progress",N],Et(m))}y.invalidateQueries({queryKey:["assignments",t,"strength"]}),y.invalidateQueries({queryKey:["strength_run_in_progress",N]}),y.invalidateQueries({queryKey:["strength_history"]})},onError:()=>{b("error"),setTimeout(()=>b("idle"),3e3),g({title:"Erreur",description:"Impossible de démarrer la séance.",variant:"destructive"})}}),X=Fe({mutationFn:a=>G.logStrengthSet(a),onMutate:()=>{b("saving")},onSuccess:a=>{b("saved"),setTimeout(()=>b("idle"),2e3),a?.one_rm_updated&&(y.invalidateQueries({queryKey:["1rm",t,i]}),g({title:"Nouveau 1RM détecté",description:"Ton record vient d'être mis à jour."}))},onError:()=>{b("error"),setTimeout(()=>b("idle"),3e3),g({title:"Erreur",description:"Impossible d'enregistrer une série.",variant:"destructive"})}}),Ee=Fe({mutationFn:a=>G.updateStrengthRun(a),onMutate:()=>{b("saving")},onSuccess:(a,m)=>{b("saved"),setTimeout(()=>b("idle"),2e3),Z(!1),y.invalidateQueries({queryKey:["strength_history"]}),m?.status==="completed"&&(N&&y.setQueryData(["strength_run_in_progress",N],Et(null)),y.invalidateQueries({queryKey:["assignments",t]}),y.invalidateQueries({queryKey:["assignments",t,"strength"]}),y.invalidateQueries({queryKey:["1rm",t,i]}),y.invalidateQueries({queryKey:["hall-of-fame"]}),M(null),L(null),R(null),S(null),q("list"),g({title:"Séance sauvegardée",description:"Bravo pour l'effort !"}))},onError:(a,m)=>{b("error"),setTimeout(()=>b("idle"),3e3),m?.status==="completed"&&(Z(!1),g({title:"Erreur",description:"Impossible d'enregistrer la séance. Réessayez.",variant:"destructive"}))}}),ne=Fe({mutationFn:a=>G.updateExerciseNote({athlete_id:i??0,exercise_id:a.exercise_id,notes:a.notes}),onMutate:()=>{b("saving")},onSuccess:()=>{b("saved"),setTimeout(()=>b("idle"),2e3),y.invalidateQueries({queryKey:["1rm",t,i]})},onError:()=>{b("error"),setTimeout(()=>b("idle"),3e3),g({title:"Erreur",description:"Impossible de sauvegarder la note.",variant:"destructive"})}}),Y=(a,m)=>{const Q=a.items??[],B=Mt(m??a.cycle??Q.find(pe=>pe.cycle_type)?.cycle_type),he=tt(Q,B,W);M(a),R({...a,title:a.title,description:a.description,cycle:B,items:he}),L(null),S(null),T(0),q("reader")},We=a=>{if((a.items??[]).length===0){g({title:"Séance vide",description:"Aucun exercice n'est disponible pour cette séance."});return}Y(a,F),L(null),S(null)},ge=a=>{const m=a.items??[],B=m.filter(pe=>pe.cycle_type===F).length>0?F:Mt(a.cycle??m.find(pe=>pe.cycle_type)?.cycle_type),he=tt(m,B,W);if(he.length===0){g({title:"Séance vide",description:"Aucun exercice n'est disponible pour cette séance."});return}R({...a,cycle:B,items:he}),M(null),L(null),S(null),T(0),q("reader")},Re=async()=>{if(!l)return;if(Me.length===0){g({title:"Séance vide",description:"Aucun exercice n'est disponible pour cette séance."});return}const a={...l,cycle:F,items:Me};if(R(a),!A){const m=v?.session_id??l?.id??null;if(!m){g({title:"Session manquante",description:"Impossible de démarrer sans session associée.",variant:"destructive"});return}try{const Q=await we.mutateAsync({assignment_id:v?.id??null,athlete_id:i??null,athleteName:t??void 0,progress_pct:0,session_id:m,cycle_type:a.cycle});Q?.run_id&&(L(Q.run_id),S(B=>B??[]))}catch{return}}T(1),q("focus")};return n.useEffect(()=>{if($!=="reader")return;const a=m=>{m.key==="Escape"&&(m.preventDefault(),q("list"))};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[$]),O||xe?e.jsxs("div",{className:"space-y-4 md:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx(be,{className:"h-7 w-7 rounded-lg"}),e.jsx(be,{className:"h-6 w-24"})]}),e.jsx(be,{className:"h-10 w-full rounded-lg"}),e.jsx("div",{className:"grid grid-cols-3 gap-2 pt-4",children:[1,2,3].map(a=>e.jsx(be,{className:"h-[60px] rounded-2xl"},a))}),e.jsx("div",{className:"space-y-2.5",children:Array.from({length:4}).map((a,m)=>e.jsxs("div",{className:"flex items-center gap-3.5 rounded-2xl bg-card p-3.5 shadow-sm",children:[e.jsx(be,{className:"h-12 w-12 rounded-xl"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(be,{className:"h-4 w-3/5"}),e.jsx(be,{className:"h-3 w-2/5"})]})]},`skeleton-${m}`))})]}):P?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(ks,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:P.message}),e.jsx(C,{variant:"default",onClick:()=>h(),className:"mt-4 h-12 md:h-10",children:"Réessayer"})]}):e.jsx("div",{className:"space-y-4 md:space-y-6",children:$==="focus"&&l?V?e.jsx("div",{className:"animate-in fade-in motion-reduce:animate-none",children:e.jsx(qs,{session:l,exercises:V,oneRMs:E||[],exerciseNotes:ke,onUpdateNote:(a,m)=>ne.mutate({exercise_id:a,notes:m}),initialLogs:J,initialStep:K,isFinishing:se,onStepChange:a=>T(a),onExitFocus:()=>q("reader"),onStart:async()=>{if(A)return;const a=v?.session_id??l?.id??null;if(!a){g({title:"Session manquante",description:"Impossible de démarrer sans session associée.",variant:"destructive"});return}const m={assignment_id:v?.id??null,athlete_id:i??null,athleteName:t??void 0,progress_pct:0,session_id:a,cycle_type:l?.cycle};try{const Q=await we.mutateAsync(m);Q?.run_id&&L(Q.run_id)}catch{return}},onLogSets:async a=>{A&&(S(m=>[...m??[],...a]),await Promise.all(a.map((m,Q)=>X.mutateAsync({run_id:A,exercise_id:m.exercise_id,set_index:m.set_number??Q+1,reps:m.reps??null,weight:m.weight??null,athlete_id:i??null,athlete_name:t??null}))))},onProgress:async a=>{A&&await Ee.mutateAsync({run_id:A,progress_pct:a,status:"in_progress"})},onFinish:a=>{A&&(Z(!0),Ee.mutate({assignment_id:v?.id??void 0,run_id:A,session_id:v?.session_id??l?.id??void 0,athlete_id:i??void 0,date:new Date().toISOString(),progress_pct:100,status:"completed",...a}))}})}):e.jsxs("div",{className:"space-y-4 py-10",children:[e.jsx("div",{className:"mx-auto h-8 w-48 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"mx-auto h-4 w-32 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"space-y-3 pt-4",children:[1,2,3].map(a=>e.jsx("div",{className:"h-20 w-full rounded-xl bg-muted animate-pulse motion-reduce:animate-none"},a))})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sticky top-0 z-overlay -mx-4 backdrop-blur-md bg-background/90 border-b border-primary/15",children:e.jsx("div",{className:"px-4 py-2.5 flex items-center",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx($e,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Séance"})]})})}),e.jsxs(is,{defaultValue:"start",className:"w-full",children:[e.jsxs(as,{className:"grid w-full grid-cols-2",children:[e.jsx(jt,{value:"start",children:"S'entraîner"}),e.jsx(jt,{value:"history",children:"Historique"})]}),e.jsxs(Nt,{value:"start",className:"space-y-5 pt-4",children:[$==="list"&&e.jsx(zs,{user:t,userId:i,athleteName:f,athleteId:k,athleteKey:N,cycleType:F,searchQuery:I,isLoading:_,setSaveState:b,onCycleChange:ae,onSearchChange:w,onStartAssignment:a=>{a.session_type==="strength"&&We(a)},onStartCatalog:ge,onResumeInProgress:({assignment:a,session:m,runId:Q,logs:B,progressPct:he})=>{M(a),R(m),L(Q),S(B),T(zt(m?.items??[],B,he)),q("focus")}}),$==="reader"&&l&&V&&e.jsx(Qs,{session:l,assignment:v,cycleType:F,cycleOptions:le,exercises:V,oneRMs:E||[],saveState:me,onBack:()=>q("list"),onLaunch:Re})]}),e.jsx(Nt,{value:"history",className:"space-y-4 pt-4",children:e.jsx(Bs,{athleteName:f,athleteId:k,athleteKey:N})})]})]})})}export{Et as buildInProgressRunCache,Zs as createInProgressRun,Tr as default,Dr as resetStrengthRunState};
