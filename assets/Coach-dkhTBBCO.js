const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/StrengthCatalog-dZ8cQ0hY.js","assets/vendor-query-BiSH4r2z.js","assets/vendor-react-BzrpNAyj.js","assets/api-7kZ5_ct6.js","assets/index-CtQinl6m.js","assets/vendor-supabase-DFPLkPj_.js","assets/index-AfZEyAPq.css","assets/swim-ByWjuA8u.js","assets/index-CEXJSKCC.js","assets/index-DPRbUSI1.js","assets/index-C1jh4kBp.js","assets/select-DT4KBCNm.js","assets/index-C1gCBIWv.js","assets/chevron-down-DV78WyOp.js","assets/chevron-up-MdqhK7vn.js","assets/CalendarGrid-BZVWJMKl.js","assets/chevron-left-DCu8gu6W.js","assets/chevron-right-i9xETuGH.js","assets/objectiveHelpers-CNYGqJYU.js","assets/dialog-Dax12xkS.js","assets/index-X7Ncu8gA.js","assets/checkbox-Cl0ll_An.js","assets/alert-dialog-BQmpUlRY.js","assets/tabs-D75V-tcN.js","assets/SessionListView-CVdJWrms.js","assets/play-CZF02YhC.js","assets/save-JdTW26Zc.js","assets/circle-alert-xZElTY0e.js","assets/pencil-Tfz3pP5P.js","assets/share-2-BcDSbtu3.js","assets/trash-2-BXWYJZeF.js","assets/drawer-2YFFQ4Vv.js","assets/search-CINrq2Iy.js","assets/plus-DXId7yQv.js","assets/loader-circle-Bd2exQ0_.js","assets/pen-i2FtNLQS.js","assets/SwimCatalog-Dp-CPn8A.js","assets/SwimSessionTimeline-CsQsQTFH.js","assets/swimConsultationUtils-BEdAhnqr.js","assets/timer-CoKMq01O.js","assets/eye-DPi2uzWl.js","assets/clock-qamR0Jla.js","assets/format-B9mPVj_w.js","assets/badge-DLJQrcJz.js","assets/toggle-group-ecxoy0b2.js","assets/separator-2bGUPOr3.js","assets/collapsible-DHx66E2c.js","assets/user-plus-D02mpeTn.js","assets/switch-8dFb7Kfk.js","assets/map-pin-CjYKvkaY.js"])))=>i.map(i=>d[i]);
import{c as ie,B as F,d as W,C as pe,i as he,k as xe,l as ge,g as je,L as O,I as oe,s as $e,W as Xe,D as Ze,R as ds,U as ce,m as us,n as ms,T as ze,u as Be,b as ps,P as Qe,o as hs,_ as es}from"./index-CtQinl6m.js";import{j as e,r as l,u as L,c as de,d as V}from"./vendor-query-BiSH4r2z.js";import{a as D}from"./api-7kZ5_ct6.js";import{B as Y}from"./badge-DLJQrcJz.js";import{T as Le,a as ae}from"./toggle-group-ecxoy0b2.js";import{A as Ae,T as Oe,a as Ee,e as ss,f as ts,F as xs,p as Ue}from"./objectiveHelpers-CNYGqJYU.js";import{S as J,a as X,b as Z,c as ee,d as I}from"./select-DT4KBCNm.js";import{a as gs,b as js,P as fs}from"./CalendarGrid-BZVWJMKl.js";import{S as _e,a as Me,b as ke,c as De,d as Ke,A as fe,e as ve,f as be,g as ye,h as Ne,i as we,j as Se,k as Ce}from"./alert-dialog-BQmpUlRY.js";import{T as ns}from"./trash-2-BXWYJZeF.js";import{C as as}from"./checkbox-Cl0ll_An.js";import{S as vs}from"./separator-2bGUPOr3.js";import{C as bs,a as ys,b as Ns}from"./collapsible-DHx66E2c.js";import{P as re}from"./plus-DXId7yQv.js";import{U as ws,a as Ss}from"./user-plus-D02mpeTn.js";import{C as Cs}from"./chevron-down-DV78WyOp.js";import{S as _s}from"./switch-8dFb7Kfk.js";import{M as Ms}from"./map-pin-CjYKvkaY.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ks=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],Pe=ie("calendar-days",ks);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ds=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],As=ie("copy",Ds);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],rs=ie("external-link",Fs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}],["path",{d:"M3.22 13H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27",key:"auskq0"}]],qs=ie("heart-pulse",Ts);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zs=[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]],Ie=ie("mail",zs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],Re=ie("message-square",Es);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ps=[["path",{d:"M18 21a8 8 0 0 0-16 0",key:"3ypg7q"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3",key:"10s06x"}]],is=ie("users-round",Ps),te=({title:s,description:a,onBack:i,actions:n})=>e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(F,{variant:"ghost",size:"sm",className:"-ml-2",onClick:i,children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),"Retour"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:s}),a?e.jsx("p",{className:"text-sm text-muted-foreground",children:a}):null]}),n?e.jsx("div",{className:"flex items-center gap-2",children:n}):null]}),$s=({onBack:s,athletes:a,groups:i,athletesLoading:n})=>{const{toast:c}=W(),[b,g]=l.useState(""),[o,p]=l.useState(""),h=l.useMemo(()=>a.filter(t=>t.id&&t.email).map(t=>({value:`user:${t.id}`,label:t.group_label?`${t.display_name} · ${t.group_label}`:t.display_name,email:t.email})),[a]),j=l.useMemo(()=>i.map(t=>({value:`group:${t.id}`,label:t.name,id:t.id})),[i]),u=()=>{if(!o)return[];if(o.startsWith("user:")){const t=h.find(m=>m.value===o);return t?[t.email]:[]}if(o.startsWith("group:")){const t=Number(o.split(":")[1]);return a.filter(m=>m.group_id===t&&m.email).map(m=>m.email)}return[]},y=()=>{const t=u();if(!t.length){c({title:"Aucune adresse email",description:"Aucun nageur avec une adresse email dans cette sélection."});return}const m=new URLSearchParams;m.set("bcc",t.join(",")),b.trim()&&m.set("subject",b.trim()),window.location.href=`mailto:?${m.toString()}`},x=u();return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(te,{title:"Contacter par email",description:"Ouvre votre application mail avec les destinataires en CCI.",onBack:s}),e.jsxs(pe,{className:"border-l-4 border-l-primary",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Destinataire"}),e.jsx(ge,{children:"Sélectionnez un nageur ou un groupe."})]}),e.jsxs(je,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Destinataire"}),e.jsxs(J,{value:o,onValueChange:p,children:[e.jsx(X,{children:e.jsx(Z,{placeholder:n?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(ee,{children:[j.length?e.jsxs(e.Fragment,{children:[e.jsx(I,{value:"section-group",disabled:!0,children:"Groupes"}),j.map(t=>e.jsx(I,{value:t.value,children:t.label},t.value))]}):null,h.length?e.jsxs(e.Fragment,{children:[e.jsx(I,{value:"section-athlete",disabled:!0,children:"Nageurs"}),h.map(t=>e.jsx(I,{value:t.value,children:t.label},t.value))]}):null]})]})]}),o&&x.length>0?e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x.length," adresse",x.length>1?"s":""," email",x.length>1?" (envoi en CCI)":""]}):null,o&&x.length===0?e.jsx("p",{className:"text-xs text-destructive",children:"Aucune adresse email disponible pour cette sélection."}):null]})]}),e.jsxs(pe,{children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Objet"}),e.jsx(ge,{children:"Optionnel — pré-rempli dans votre application mail."})]}),e.jsx(je,{children:e.jsx(oe,{value:b,onChange:t=>g(t.target.value),placeholder:"Objet du mail…"})})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsxs(F,{className:"w-full sm:w-auto",onClick:y,disabled:!o||x.length===0,children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),"Ouvrir dans l'app mail",e.jsx(rs,{className:"ml-2 h-3 w-3"})]})})]})},Ls=({onBack:s,athletes:a,groups:i,athletesLoading:n})=>{const{toast:c}=W(),[b,g]=l.useState(""),[o,p]=l.useState(""),{data:h}=L({queryKey:["athlete-phones"],queryFn:async()=>{const{data:r}=await $e.from("user_profiles").select("user_id, phone").not("phone","is",null);return new Map((r??[]).map(k=>[k.user_id,k.phone]))}}),j=l.useMemo(()=>a.filter(r=>r.id!=null).map(r=>({value:`user:${r.id}`,label:r.group_label?`${r.display_name} · ${r.group_label}`:r.display_name,id:r.id})),[a]),u=l.useMemo(()=>i.map(r=>({value:`group:${r.id}`,label:r.name,id:r.id})),[i]),y=()=>{if(!o||!h)return{found:[],total:0};if(o.startsWith("user:")){const r=Number(o.split(":")[1]),k=h.get(r);return{found:k?[k]:[],total:1}}if(o.startsWith("group:")){const r=Number(o.split(":")[1]),k=a.filter(_=>_.group_id===r&&_.id!=null);return{found:k.map(_=>h.get(_.id)).filter(_=>!!_&&_.trim().length>0),total:k.length}}return{found:[],total:0}},{found:x,total:t}=y(),m=t-x.length,M=()=>{if(x.length===0){c({title:"Aucun numéro",description:"Aucun nageur avec un numéro de téléphone dans cette sélection.",variant:"destructive"});return}if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){const k=b.trim()?encodeURIComponent(b.trim()):"",T=/iPhone|iPad|iPod/i.test(navigator.userAgent);let _;if(T){const z=x.join(",");_=k?`sms:/open?addresses=${z}&body=${k}`:`sms:/open?addresses=${z}`}else _=k?`sms:${x.join(",")}?body=${k}`:`sms:${x.join(",")}`;window.location.href=_}else navigator.clipboard.writeText(x.join(", ")).then(()=>{c({title:"Numéros copiés",description:`${x.length} numéro${x.length>1?"s":""} copié${x.length>1?"s":""} dans le presse-papiers. Utilisez votre téléphone pour envoyer le SMS.`})}).catch(()=>{c({title:"Erreur",description:"Impossible de copier les numéros.",variant:"destructive"})})},f=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(te,{title:"Envoyer un SMS",description:"Ouvre votre application SMS ou copie les numéros.",onBack:s}),e.jsxs(pe,{className:"border-l-4 border-l-primary",children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Destinataire"}),e.jsx(ge,{children:"Sélectionnez un nageur ou un groupe."})]}),e.jsxs(je,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Destinataire"}),e.jsxs(J,{value:o,onValueChange:p,children:[e.jsx(X,{children:e.jsx(Z,{placeholder:n?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(ee,{children:[u.length?e.jsxs(e.Fragment,{children:[e.jsx(I,{value:"section-group",disabled:!0,children:"Groupes"}),u.map(r=>e.jsx(I,{value:r.value,children:r.label},r.value))]}):null,j.length?e.jsxs(e.Fragment,{children:[e.jsx(I,{value:"section-athlete",disabled:!0,children:"Nageurs"}),j.map(r=>e.jsx(I,{value:r.value,children:r.label},r.value))]}):null]})]})]}),o&&x.length>0?e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x.length," numéro",x.length>1?"s":""," trouvé",x.length>1?"s":"",m>0?e.jsxs("span",{className:"text-destructive",children:[" · ",m," sans téléphone"]}):null]}):null,o&&x.length===0?e.jsx("p",{className:"text-xs text-destructive",children:"Aucun numéro de téléphone disponible pour cette sélection."}):null]})]}),e.jsxs(pe,{children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Message"}),e.jsx(ge,{children:"Optionnel — pré-rempli dans votre application SMS."})]}),e.jsx(je,{children:e.jsx(Oe,{value:b,onChange:r=>g(r.target.value),placeholder:"Contenu du SMS…",rows:3})})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsx(F,{className:"w-full sm:w-auto",onClick:M,disabled:!o||x.length===0,children:f?e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Ouvrir dans l'app SMS",e.jsx(rs,{className:"ml-2 h-3 w-3"})]}):e.jsxs(e.Fragment,{children:[e.jsx(As,{className:"mr-2 h-4 w-4"}),"Copier les numéros"]})})})]})};function He(s){return String(s).padStart(2,"0")}function le(s){return`${s.getFullYear()}-${He(s.getMonth()+1)}-${He(s.getDate())}`}function Fe(s){return new Date(s.getFullYear(),s.getMonth(),1)}function Ye(s,a){const i=new Date(s);return i.setDate(i.getDate()+a),i}function Os(s){return(s.getDay()+6)%7}function Te(s){if(!s)return"AM";const a=s.toLowerCase();return a==="evening"||a.includes("soir")||a==="pm"?"PM":"AM"}const Ks=[{key:"swim-morning",label:"Nage — Matin",type:"swim",scheduledSlot:"morning"},{key:"swim-evening",label:"Nage — Soir",type:"swim",scheduledSlot:"evening"},{key:"strength",label:"Musculation",type:"strength",scheduledSlot:null}];function Is({groupId:s,userId:a,enabled:i}){const n=l.useMemo(()=>new Date,[]),[c,b]=l.useState(()=>Fe(new Date)),[g,o]=l.useState(()=>le(new Date)),[p,h]=l.useState(null),[j,u]=l.useState(!1),y=l.useMemo(()=>Fe(c),[c]),x=l.useMemo(()=>{const d=Os(y),C=Ye(y,-d),A=[];for(let E=0;E<42;E++)A.push(Ye(C,E));return A},[y]),t=l.useMemo(()=>{const d=le(x[0]),C=le(x[x.length-1]);return{from:d,to:C}},[x]),m=!!(s||a),{data:M=[],isLoading:f}=L({queryKey:["coach-calendar-assignments",s,a,t.from,t.to],queryFn:()=>D.getCoachAssignments({groupId:s??null,userId:a??null,from:t.from,to:t.to}),enabled:m}),r=l.useMemo(()=>{const d=new Map;for(const C of M){const A=C.scheduledDate?.slice(0,10);A&&(d.has(A)||d.set(A,[]),d.get(A).push(C))}return d},[M]),k=l.useMemo(()=>{const d={};for(const C of x){const A=le(C),E=r.get(A)??[],U=E.some(K=>Te(K.scheduledSlot)==="AM"),w=E.some(K=>Te(K.scheduledSlot)==="PM"),R=(U?1:0)+(w?1:0),B=[{slotKey:"AM",expected:U,completed:U,absent:!1},{slotKey:"PM",expected:w,completed:w,absent:!1}];d[A]={completed:R,total:R,slots:B}}return d},[x,r]),T=l.useMemo(()=>{const[d,C,A]=g.split("-").map(Number);return new Date(d,C-1,A)},[g]),_=l.useMemo(()=>r.get(g)??[],[r,g]),z=l.useMemo(()=>{const d=_;return Ks.map(C=>{const A=d.filter(w=>C.type!==w.type?!1:C.type==="swim"?Te(w.scheduledSlot)===(C.scheduledSlot==="morning"?"AM":"PM"):!0),E=A.find(w=>w.targetType==="user"),U=A.find(w=>w.targetType==="group");return{...C,assignment:E??U??null}})},[_]),{data:q=[]}=L({queryKey:["planned-absences-coach",a,t.from,t.to],queryFn:()=>D.getPlannedAbsences({userId:a,from:t.from,to:t.to}),enabled:!!a}),S=l.useMemo(()=>new Set(q.map(d=>d.date)),[q]),v=l.useMemo(()=>{const d={};for(const C of x){const A=le(C),E=r.get(A)??[];d[A]=E.some(U=>U.type==="strength")}return d},[x,r]),P=k[g]??{completed:0,total:0,slots:[{slotKey:"AM",expected:!1,completed:!1,absent:!1},{slotKey:"PM",expected:!1,completed:!1,absent:!1}]},Q=l.useCallback(()=>{b(d=>new Date(d.getFullYear(),d.getMonth()-1,1))},[]),se=l.useCallback(()=>{b(d=>new Date(d.getFullYear(),d.getMonth()+1,1))},[]),G=l.useCallback(()=>{b(Fe(new Date)),o(le(new Date))},[]),N=l.useCallback(d=>{o(d),u(!0)},[]);return{today:n,monthCursor:c,selectedISO:g,selectedDayIndex:p,drawerOpen:j,gridDates:x,completionByISO:k,selectedDate:T,selectedDayStatus:P,assignmentsForSelectedDay:_,slotsForSelectedDay:z,hasStrengthByISO:v,absenceDates:S,isLoading:f,hasFilter:m,setSelectedISO:o,setSelectedDayIndex:h,setDrawerOpen:u,prevMonth:Q,nextMonth:se,jumpToday:G,openDay:N}}function Rs(s){const[a,i,n]=s.split("-").map(Number);return new Date(a,i-1,n).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})}function Vs({onBack:s,athletes:a,groups:i,swimSessions:n,strengthSessions:c}){const[b,g]=l.useState("group"),[o,p]=l.useState(""),[h,j]=l.useState(""),u=b==="group"&&o?Number(o):null,y=b==="user"&&h?Number(h):null,{today:x,monthCursor:t,selectedISO:m,selectedDayIndex:M,drawerOpen:f,gridDates:r,completionByISO:k,selectedDayStatus:T,slotsForSelectedDay:_,hasStrengthByISO:z,absenceDates:q,hasFilter:S,setSelectedISO:v,setSelectedDayIndex:P,setDrawerOpen:Q,prevMonth:se,nextMonth:G,jumpToday:N,openDay:d}=Is({groupId:u,userId:y,enabled:!0}),C=de(),A=V({mutationFn:w=>D.assignments_create(w),onSuccess:()=>{C.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),E=V({mutationFn:w=>D.assignments_delete(w),onSuccess:()=>{C.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),U=(w,R)=>{let B=R;if(w.key==="ArrowLeft"&&(B=Math.max(0,R-1)),w.key==="ArrowRight"&&(B=Math.min(r.length-1,R+1)),w.key==="ArrowUp"&&(B=Math.max(0,R-7)),w.key==="ArrowDown"&&(B=Math.min(r.length-1,R+7)),B!==R){w.preventDefault(),P(B);const K=me=>String(me).padStart(2,"0"),H=r[B],ue=`${H.getFullYear()}-${K(H.getMonth()+1)}-${K(H.getDate())}`;v(ue)}if(w.key==="Enter"||w.key===" "){w.preventDefault();const K=me=>String(me).padStart(2,"0"),H=r[R],ue=`${H.getFullYear()}-${K(H.getMonth()+1)}-${K(H.getDate())}`;d(ue)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx(te,{title:"Calendrier",description:"Vue mensuelle des assignations",onBack:s}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsxs(Le,{type:"single",value:b,onValueChange:w=>{(w==="group"||w==="user")&&g(w)},className:"shrink-0",children:[e.jsx(ae,{value:"group",className:"text-xs px-3",children:"Groupe"}),e.jsx(ae,{value:"user",className:"text-xs px-3",children:"Nageur"})]}),b==="group"?e.jsxs(J,{value:o,onValueChange:p,children:[e.jsx(X,{className:"w-full sm:w-56",children:e.jsx(Z,{placeholder:"Choisir un groupe"})}),e.jsx(ee,{children:i.map(w=>e.jsx(I,{value:String(w.id),children:w.name},String(w.id)))})]}):e.jsxs(J,{value:h,onValueChange:j,children:[e.jsx(X,{className:"w-full sm:w-56",children:e.jsx(Z,{placeholder:"Choisir un nageur"})}),e.jsx(ee,{children:a.filter(w=>w.id!=null).map(w=>e.jsxs(I,{value:String(w.id),children:[w.display_name,w.group_label?` · ${w.group_label}`:""]},String(w.id)))})]})]}),S?e.jsxs("div",{className:"rounded-2xl border bg-card shadow-sm",children:[e.jsx(gs,{monthCursor:t,selectedDayStatus:T,onPrevMonth:se,onNextMonth:G,onJumpToday:N}),e.jsx(js,{monthCursor:t,gridDates:r,completionByISO:k,strengthByISO:z,absenceDates:q,selectedISO:m,selectedDayIndex:M,today:x,onDayClick:d,onKeyDown:U})]}):e.jsx("div",{className:"py-12 text-center text-sm text-muted-foreground",children:"Sélectionnez un groupe ou un nageur pour afficher le calendrier."}),e.jsx(_e,{open:f,onOpenChange:Q,children:e.jsxs(Me,{side:"bottom",className:"max-h-[70vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(ke,{className:"pb-3",children:[e.jsx(De,{className:"capitalize text-left",children:Rs(m)}),e.jsx(Ke,{className:"sr-only",children:"Gérer les assignations pour cette journée"})]}),e.jsxs("div",{className:"space-y-3",children:[q.has(m)&&e.jsx("div",{className:"rounded-xl border border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-900/40 px-3 py-2 flex items-center gap-2",children:e.jsx("span",{className:"text-[10px] font-bold text-red-500 uppercase tracking-wide",children:"Absence prévue"})}),_.map(w=>{const R=w.assignment?.targetType==="group",B=b==="user";return e.jsx(Gs,{slot:w,swimSessions:n,strengthSessions:c,isGroupAssignment:R&&B,onAssign:K=>{A.mutate({assignment_type:w.type,session_id:K,scheduled_date:m,scheduled_slot:w.scheduledSlot??void 0,target_group_id:u,target_user_id:y})},onDelete:K=>{E.mutate(K)},onReplace:(K,H)=>{R&&B?A.mutate({assignment_type:w.type,session_id:H,scheduled_date:m,scheduled_slot:w.scheduledSlot??void 0,target_user_id:y}):E.mutate(K,{onSuccess:()=>{A.mutate({assignment_type:w.type,session_id:H,scheduled_date:m,scheduled_slot:w.scheduledSlot??void 0,target_group_id:u,target_user_id:y})}})},isPending:A.isPending||E.isPending},w.key)})]})]})})]})}function Gs({slot:s,swimSessions:a,strengthSessions:i,isGroupAssignment:n,onAssign:c,onDelete:b,onReplace:g,isPending:o}){const[p,h]=l.useState(!1),j=s.type==="swim",u=j?(a??[]).map(t=>({id:t.id,label:t.name})):(i??[]).map(t=>({id:t.id,label:t.title})),y=s.assignment!==null,x=t=>{const m=Number(t);m&&(y&&p?(g(s.assignment.id,m),h(!1)):c(m))};return e.jsxs("div",{className:"rounded-xl border p-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[j?e.jsx(Xe,{className:"h-4 w-4 text-blue-500 shrink-0"}):e.jsx(Ze,{className:"h-4 w-4 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:s.label})]}),y&&!p?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-sm font-semibold truncate flex-1",children:[s.assignment.title,n&&e.jsx("span",{className:"ml-1.5 text-[10px] font-medium text-muted-foreground bg-muted px-1.5 py-0.5 rounded-full align-middle",children:"Groupe"})]}),e.jsx(F,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0",disabled:o,onClick:()=>h(!0),title:n?"Personnaliser":"Changer",children:e.jsx(ds,{className:"h-3.5 w-3.5"})}),!n&&e.jsx(F,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0 text-destructive hover:text-destructive",disabled:o,onClick:()=>b(s.assignment.id),title:"Supprimer",children:e.jsx(ns,{className:"h-3.5 w-3.5"})})]}):e.jsxs(J,{value:"",onValueChange:x,disabled:o||u.length===0,children:[e.jsx(X,{className:"h-9 text-xs",children:e.jsx(Z,{placeholder:p?n?"Personnaliser pour ce nageur":"Choisir le remplacement":"Choisir une séance"})}),e.jsx(ee,{children:u.map(t=>e.jsx(I,{value:String(t.id),children:t.label},t.id))})]}),p?e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground",onClick:()=>h(!1),children:"Annuler"}):null]})}const ls=({athletes:s,selected:a,onToggle:i,filterToUserIds:n})=>{const[c,b]=l.useState(""),g=l.useMemo(()=>{let p=s.filter(h=>h.id!=null);if(n&&(p=p.filter(h=>n.has(h.id))),c.trim()){const h=c.toLowerCase();p=p.filter(j=>j.display_name.toLowerCase().includes(h))}return p},[s,n,c]),o=l.useMemo(()=>{const p=new Map;for(const h of g){const j=h.group_label||"Sans groupe";p.has(j)||p.set(j,[]),p.get(j).push(h)}return[...p.entries()].sort(([h],[j])=>h.localeCompare(j,"fr"))},[g]);return e.jsxs("div",{className:"space-y-3",children:[e.jsx(oe,{placeholder:"Rechercher un nageur...",value:c,onChange:p=>b(p.target.value)}),e.jsxs("div",{className:"max-h-[50vh] overflow-y-auto space-y-3",children:[o.map(([p,h])=>e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-1.5",children:p}),e.jsx("div",{className:"space-y-1",children:h.map(j=>e.jsxs("label",{className:"flex items-center gap-2.5 rounded-lg border px-3 py-2 cursor-pointer hover:bg-muted/50 transition-colors",children:[e.jsx(as,{checked:a.has(j.id),onCheckedChange:()=>i(j.id)}),e.jsx("span",{className:"text-sm",children:j.display_name})]},j.id))})]},p)),o.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun nageur trouvé."})]}),a.size>0&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.size," nageur",a.size>1?"s":""," ","sélectionné",a.size>1?"s":""]})]})},os=({open:s,onOpenChange:a,athletes:i,parentGroupId:n,parentMembers:c,onCreated:b})=>{const{toast:g}=W(),[o,p]=l.useState(""),[h,j]=l.useState(new Set),u=t=>{j(m=>{const M=new Set(m);return M.has(t)?M.delete(t):M.add(t),M})},y=V({mutationFn:()=>D.createTemporaryGroup({name:o.trim(),member_user_ids:[...h],parent_group_id:n??void 0}),onSuccess:()=>{g({title:"Groupe créé",description:`Le groupe "${o.trim()}" a été créé avec ${h.size} nageur${h.size>1?"s":""}.`}),p(""),j(new Set),a(!1),b()},onError:t=>{g({title:"Erreur",description:t.message,variant:"destructive"})}}),x=()=>{if(!o.trim()){g({title:"Nom requis",description:"Veuillez saisir un nom pour le groupe.",variant:"destructive"});return}y.mutate()};return e.jsx(_e,{open:s,onOpenChange:a,children:e.jsxs(Me,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ke,{children:[e.jsx(De,{children:n?"Créer un sous-groupe":"Créer un groupe"}),e.jsx(Ke,{children:n?"Sélectionnez des nageurs du groupe parent pour ce sous-groupe.":"Créez un groupe temporaire (stage, compétition) avec des nageurs de différents groupes."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"group-name",children:"Nom du groupe"}),e.jsx(oe,{id:"group-name",placeholder:"Ex : Stage Pâques 2026",value:o,onChange:t=>p(t.target.value)})]}),e.jsx(vs,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Nageurs"}),e.jsx(ls,{athletes:i,selected:h,onToggle:u,filterToUserIds:c??null})]}),e.jsx(F,{className:"w-full",onClick:x,disabled:y.isPending||!o.trim(),children:y.isPending?"Création...":"Créer le groupe"})]})]})})},Bs=({open:s,onOpenChange:a,groupId:i,athletes:n,existingMemberIds:c,onAdded:b})=>{const{toast:g}=W(),[o,p]=l.useState(new Set),h=l.useMemo(()=>n.filter(y=>y.id!=null&&!c.has(y.id)),[n,c]),j=y=>{p(x=>{const t=new Set(x);return t.has(y)?t.delete(y):t.add(y),t})},u=V({mutationFn:()=>D.addTemporaryGroupMembers(i,[...o]),onSuccess:()=>{g({title:"Nageurs ajoutés",description:`${o.size} nageur${o.size>1?"s":""} ajouté${o.size>1?"s":""}.`}),p(new Set),a(!1),b()},onError:y=>{g({title:"Erreur",description:y.message,variant:"destructive"})}});return e.jsx(_e,{open:s,onOpenChange:a,children:e.jsxs(Me,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ke,{children:[e.jsx(De,{children:"Ajouter des nageurs"}),e.jsx(Ke,{children:"Sélectionnez les nageurs à ajouter au groupe."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx(ls,{athletes:h,selected:o,onToggle:j}),e.jsx(F,{className:"w-full",onClick:()=>u.mutate(),disabled:u.isPending||o.size===0,children:u.isPending?"Ajout...":`Ajouter ${o.size} nageur${o.size>1?"s":""}`})]})]})})},Qs=({groupId:s,athletes:a,onBack:i})=>{const{toast:n}=W(),c=de(),[b,g]=l.useState(!1),[o,p]=l.useState(!1),[h,j]=l.useState(null),{data:u,isLoading:y}=L({queryKey:["temp-group-detail",s],queryFn:()=>D.getTemporaryGroupDetail(s)}),x=V({mutationFn:f=>D.removeTemporaryGroupMember(s,f),onSuccess:()=>{n({title:"Nageur retiré"}),c.invalidateQueries({queryKey:["temp-group-detail",s]}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:f=>{n({title:"Erreur",description:f.message,variant:"destructive"})}}),t=()=>{c.invalidateQueries({queryKey:["temp-group-detail",s]}),c.invalidateQueries({queryKey:["temp-groups"]})},m=l.useMemo(()=>new Set((u?.members??[]).map(f=>f.user_id)),[u]),M=l.useMemo(()=>new Set((u?.members??[]).map(f=>f.user_id)),[u]);return y?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(F,{variant:"ghost",size:"sm",className:"-ml-2",onClick:i,children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(f=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted"})},f))})]}):u?e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(F,{variant:"ghost",size:"sm",className:"-ml-2",onClick:i,children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:u.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{variant:u.is_active?"default":"secondary",children:u.is_active?"Actif":"Terminé"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[u.members.length," membre",u.members.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Membres"}),u.is_active&&e.jsxs(F,{size:"sm",variant:"outline",onClick:()=>g(!0),children:[e.jsx(ws,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]}),u.members.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun membre dans ce groupe."}):e.jsx("div",{className:"space-y-1.5",children:u.members.map(f=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:f.display_name}),f.permanent_group_label&&e.jsx(Y,{variant:"secondary",className:"text-[10px] px-1.5 py-0 mt-0.5",children:f.permanent_group_label})]}),u.is_active&&e.jsx(F,{size:"icon",variant:"ghost",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>j({userId:f.user_id,name:f.display_name}),title:"Retirer du groupe",children:e.jsx(Ss,{className:"h-4 w-4"})})]},f.user_id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Sous-groupes"}),u.is_active&&e.jsxs(F,{size:"sm",variant:"outline",onClick:()=>p(!0),children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Sous-groupe"]})]}),u.subgroups.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun sous-groupe."}):e.jsx("div",{className:"space-y-2",children:u.subgroups.map(f=>e.jsxs(bs,{children:[e.jsxs(ys,{className:"flex w-full items-center justify-between rounded-xl border bg-card p-3 text-left hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-semibold",children:f.name}),e.jsx(Y,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:f.members.length})]}),e.jsx(Cs,{className:"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]_&]:rotate-180"})]}),e.jsx(Ns,{children:e.jsxs("div",{className:"ml-4 mt-1 space-y-1",children:[f.members.map(r=>e.jsx("div",{className:"flex items-center gap-2 rounded-lg border px-3 py-2",children:e.jsx("span",{className:"text-sm",children:r.display_name})},r.user_id)),f.members.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground py-2",children:"Aucun membre."})]})})]},f.id))})]}),e.jsx(Bs,{open:b,onOpenChange:g,groupId:s,athletes:a,existingMemberIds:m,onAdded:t}),e.jsx(os,{open:o,onOpenChange:p,athletes:a,parentGroupId:s,parentMembers:M,onCreated:t}),e.jsx(fe,{open:!!h,onOpenChange:f=>{f||j(null)},children:e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Retirer du groupe"}),e.jsxs(Ne,{children:["Voulez-vous retirer ",h?.name," de ce groupe ?",u.subgroups.length>0?" Le nageur sera aussi retiré des sous-groupes.":""]})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(Ce,{onClick:()=>{h&&(x.mutate(h.userId),j(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Retirer"})]})]})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(F,{variant:"ghost",size:"sm",className:"-ml-2",onClick:i,children:[e.jsx(Ae,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Groupe introuvable."})]})},We=({group:s,onManage:a,onDeactivate:i,onReactivate:n,onDelete:c})=>{const b=new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"});return e.jsxs("div",{className:"rounded-xl border bg-card p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-bold truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1 flex-wrap",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.member_count," membre",s.member_count!==1?"s":""]}),s.subgroup_count>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.subgroup_count," sous-groupe",s.subgroup_count!==1?"s":""]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:b})]})]}),e.jsx(Y,{variant:s.is_active?"default":"secondary",children:s.is_active?"Actif":"Terminé"})]}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:s.is_active?e.jsxs(e.Fragment,{children:[e.jsxs(F,{size:"sm",variant:"outline",onClick:()=>a(s.id),children:[e.jsx(us,{className:"mr-1.5 h-3.5 w-3.5"}),"Gérer"]}),e.jsxs(F,{size:"sm",variant:"outline",onClick:()=>i(s.id),children:[e.jsx(fs,{className:"mr-1.5 h-3.5 w-3.5"}),"Terminer"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(F,{size:"sm",variant:"outline",onClick:()=>n(s.id),children:[e.jsx(ms,{className:"mr-1.5 h-3.5 w-3.5"}),"Réactiver"]}),e.jsxs(F,{size:"sm",variant:"outline",className:"text-destructive hover:text-destructive",onClick:()=>c(s.id),children:[e.jsx(ns,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})})]})},Us=({onBack:s,athletes:a,athletesLoading:i})=>{const{toast:n}=W(),c=de(),[b,g]=l.useState("list"),[o,p]=l.useState(null),[h,j]=l.useState(!1),[u,y]=l.useState(null),[x,t]=l.useState(null),{data:m=[],isLoading:M}=L({queryKey:["temp-groups"],queryFn:()=>D.getTemporaryGroups()}),f=l.useMemo(()=>m.filter(S=>S.is_active),[m]),r=l.useMemo(()=>m.filter(S=>!S.is_active),[m]),k=V({mutationFn:S=>D.deactivateTemporaryGroup(S),onSuccess:()=>{n({title:"Groupe terminé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:S=>{n({title:"Erreur",description:S.message,variant:"destructive"})}}),T=V({mutationFn:S=>D.reactivateTemporaryGroup(S),onSuccess:()=>{n({title:"Groupe réactivé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:S=>{n({title:"Erreur",description:S.message,variant:"destructive"})}}),_=V({mutationFn:S=>D.deleteTemporaryGroup(S),onSuccess:()=>{n({title:"Groupe supprimé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:S=>{n({title:"Erreur",description:S.message,variant:"destructive"})}}),z=S=>{p(S),g("detail")},q=()=>{p(null),g("list"),c.invalidateQueries({queryKey:["temp-groups"]})};return b==="detail"&&o!=null?e.jsx(Qs,{groupId:o,athletes:a,onBack:q}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(te,{title:"Groupes temporaires",description:"Créez et gérez des groupes pour les stages, compétitions ou événements.",onBack:s,actions:e.jsxs(F,{size:"sm",onClick:()=>j(!0),children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un groupe"]})}),M||i?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(S=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-6 w-16 rounded bg-muted"})]})},S))}):m.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ce,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun groupe temporaire pour le moment."}),e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>j(!0),children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer le premier groupe"]})]}):e.jsxs(e.Fragment,{children:[f.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Actifs (",f.length,")"]}),f.map(S=>e.jsx(We,{group:S,onManage:z,onDeactivate:v=>y(v),onReactivate:v=>T.mutate(v),onDelete:v=>t(v)},S.id))]}),r.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Terminés (",r.length,")"]}),r.map(S=>e.jsx(We,{group:S,onManage:z,onDeactivate:v=>y(v),onReactivate:v=>T.mutate(v),onDelete:v=>t(v)},S.id))]})]}),e.jsx(os,{open:h,onOpenChange:j,athletes:a,onCreated:()=>{c.invalidateQueries({queryKey:["temp-groups"]})}}),e.jsx(fe,{open:u!=null,onOpenChange:S=>{S||y(null)},children:e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Terminer le groupe"}),e.jsx(Ne,{children:"Voulez-vous marquer ce groupe comme terminé ? Les sous-groupes seront aussi désactivés. Vous pourrez le réactiver plus tard si nécessaire."})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(Ce,{onClick:()=>{u!=null&&(k.mutate(u),y(null))},children:"Terminer"})]})]})}),e.jsx(fe,{open:x!=null,onOpenChange:S=>{S||t(null)},children:e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Supprimer le groupe"}),e.jsx(Ne,{children:"Cette action est irréversible. Le groupe et tous ses sous-groupes seront supprimés définitivement."})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(Ce,{onClick:()=>{x!=null&&(_.mutate(x),t(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function qe(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Hs(s){const a=new Date;a.setHours(0,0,0,0);const i=new Date(s+"T00:00:00");return Math.ceil((i.getTime()-a.getTime())/(1e3*60*60*24))}const Ys=({open:s,onOpenChange:a,competition:i})=>{const{toast:n}=W(),c=de(),b=!!i,[g,o]=l.useState(""),[p,h]=l.useState(""),[j,u]=l.useState(""),[y,x]=l.useState(!0),[t,m]=l.useState(""),[M,f]=l.useState(""),[r,k]=l.useState(!1),[T,_]=l.useState(new Set),{data:z=[]}=L({queryKey:["athletes"],queryFn:()=>D.getAthletes()}),{data:q=[]}=L({queryKey:["groups"],queryFn:()=>D.getGroups()}),{data:S}=L({queryKey:["competition-assignments",i?.id],queryFn:()=>D.getCompetitionAssignments(i.id),enabled:!!i?.id});l.useEffect(()=>{s&&(i?(o(i.name),h(i.date),u(i.end_date??""),x(!!i.end_date),m(i.location??""),f(i.description??""),S&&_(new Set(S.map(N=>N.athlete_id)))):(o(""),h(""),u(""),x(!0),m(""),f(""),_(new Set)))},[s,i,S]);const v=V({mutationFn:N=>D.createCompetition(N),onSuccess:async N=>{if(T.size>0)try{await D.setCompetitionAssignments(N.id,Array.from(T))}catch(d){console.warn("[EAC] Failed to save competition assignments:",d)}n({title:"Competition creee"}),c.invalidateQueries({queryKey:["competitions"]}),c.invalidateQueries({queryKey:["competition-assignments"]}),a(!1)},onError:N=>{n({title:"Erreur",description:N.message,variant:"destructive"})}}),P=V({mutationFn:N=>D.updateCompetition(i.id,N),onSuccess:async()=>{try{await D.setCompetitionAssignments(i.id,Array.from(T))}catch(N){console.warn("[EAC] Failed to save competition assignments:",N)}n({title:"Competition mise a jour"}),c.invalidateQueries({queryKey:["competitions"]}),c.invalidateQueries({queryKey:["competition-assignments"]}),a(!1)},onError:N=>{n({title:"Erreur",description:N.message,variant:"destructive"})}}),Q=V({mutationFn:()=>D.deleteCompetition(i.id),onSuccess:()=>{n({title:"Competition supprimee"}),c.invalidateQueries({queryKey:["competitions"]}),a(!1)},onError:N=>{n({title:"Erreur",description:N.message,variant:"destructive"})}}),se=()=>{if(!g.trim()){n({title:"Nom requis",description:"Veuillez saisir un nom pour la competition.",variant:"destructive"});return}if(!p){n({title:"Date requise",description:"Veuillez saisir une date.",variant:"destructive"});return}const N={name:g.trim(),date:p,end_date:y&&j?j:null,location:t.trim()||null,description:M.trim()||null};b?P.mutate(N):v.mutate(N)},G=v.isPending||P.isPending||Q.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(_e,{open:s,onOpenChange:a,children:e.jsxs(Me,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(ke,{children:e.jsx(De,{children:b?"Modifier la competition":"Nouvelle competition"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"comp-name",children:"Nom *"}),e.jsx(oe,{id:"comp-name",placeholder:"Ex : Championnats Regionaux",value:g,onChange:N=>o(N.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"comp-date",children:"Date *"}),e.jsx("input",{id:"comp-date",type:"date",value:p,onChange:N=>h(N.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(O,{htmlFor:"comp-multiday",children:"Multi-jours"}),e.jsx(_s,{id:"comp-multiday",checked:y,onCheckedChange:x})]}),y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"comp-end-date",children:"Date de fin"}),e.jsx("input",{id:"comp-end-date",type:"date",value:j,onChange:N=>u(N.target.value),min:p||void 0,className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"comp-location",children:"Lieu"}),e.jsx(oe,{id:"comp-location",placeholder:"Ex : Piscine de Strasbourg",value:t,onChange:N=>m(N.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:"comp-description",children:"Description"}),e.jsx(Oe,{id:"comp-description",placeholder:"Notes, informations complementaires...",value:M,onChange:N=>f(N.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(O,{children:"Nageurs assignes"})]}),e.jsxs(J,{value:"",onValueChange:N=>{const d=z.filter(C=>C.group_id===Number(N));_(C=>{const A=new Set(C);return d.forEach(E=>{E.id!=null&&A.add(E.id)}),A})},children:[e.jsx(X,{children:e.jsx(Z,{placeholder:"Ajouter un groupe..."})}),e.jsx(ee,{children:q.filter(N=>!N.is_temporary).map(N=>e.jsx(I,{value:String(N.id),children:N.name},N.id))})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto rounded-md border p-2 space-y-1",children:z.map(N=>{if(N.id==null)return null;const d=T.has(N.id);return e.jsxs("label",{className:"flex items-center gap-2 py-1 px-1 rounded hover:bg-muted/50 cursor-pointer",children:[e.jsx(as,{checked:d,onCheckedChange:C=>{_(A=>{const E=new Set(A);return C?E.add(N.id):E.delete(N.id),E})}}),e.jsx("span",{className:"text-sm",children:N.display_name}),N.group_label&&e.jsx("span",{className:"text-xs text-muted-foreground ml-auto",children:N.group_label})]},N.id)})}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[T.size," nageur",T.size>1?"s":""," assigne",T.size>1?"s":""]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(F,{className:"w-full",onClick:se,disabled:G||!g.trim()||!p,children:G?"Enregistrement...":b?"Enregistrer":"Creer"}),b&&e.jsx(F,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>k(!0),disabled:G,children:"Supprimer cette competition"})]})]})]})}),e.jsx(fe,{open:r,onOpenChange:k,children:e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Supprimer la competition"}),e.jsxs(Ne,{children:["Cette action est irreversible. La competition «"," ",i?.name," » sera supprimee definitivement."]})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(Ce,{onClick:()=>{Q.mutate(),k(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Ws=({competition:s,onEdit:a,onSendSms:i})=>{const{data:n=[]}=L({queryKey:["competition-assignments",s.id],queryFn:()=>D.getCompetitionAssignments(s.id)}),c=Hs(s.date),b=c<0,g=c>=0,o=s.end_date?`du ${qe(s.date)} au ${qe(s.end_date)}`:qe(s.date);return e.jsxs("button",{type:"button",className:`w-full text-left rounded-xl border bg-card p-3 space-y-1 transition-colors hover:bg-muted/50 ${b?"opacity-60":""}`,onClick:()=>a(s),children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:o})]}),e.jsxs("div",{className:"flex items-center gap-1.5 shrink-0",children:[g&&e.jsxs(Y,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:["J-",c]}),b&&e.jsx(Y,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Passee"})]})]}),s.location&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(Ms,{className:"h-3 w-3 shrink-0"}),e.jsx("span",{className:"truncate",children:s.location})]}),n.length>0&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(ce,{className:"h-3 w-3 shrink-0"}),e.jsxs("span",{children:[n.length," nageur",n.length>1?"s":""]})]}),n.length>0&&i&&e.jsxs("button",{type:"button",className:"flex items-center gap-1 text-xs text-primary hover:underline",onClick:p=>{p.stopPropagation(),i(s,n)},children:[e.jsx(Re,{className:"h-3 w-3"}),"SMS"]})]})},Js=({onBack:s})=>{const{toast:a}=W(),[i,n]=l.useState(!1),[c,b]=l.useState(null),{data:g=[],isLoading:o}=L({queryKey:["competitions"],queryFn:()=>D.getCompetitions()}),{data:p}=L({queryKey:["athlete-phones"],queryFn:async()=>{const{data:t}=await $e.from("user_profiles").select("user_id, phone").not("phone","is",null);return new Map((t??[]).map(m=>[m.user_id,m.phone]))}}),h=l.useMemo(()=>{const t=new Date;t.setHours(0,0,0,0);const m=t.getTime(),M=[],f=[];for(const r of g)new Date(r.date+"T00:00:00").getTime()>=m?M.push(r):f.push(r);return M.sort((r,k)=>new Date(r.date+"T00:00:00").getTime()-new Date(k.date+"T00:00:00").getTime()),f.sort((r,k)=>new Date(k.date+"T00:00:00").getTime()-new Date(r.date+"T00:00:00").getTime()),[...M,...f]},[g]),j=()=>{b(null),n(!0)},u=t=>{b(t),n(!0)},y=(t,m)=>{if(!p)return;const M=m.map(r=>p.get(r.athlete_id)).filter(r=>!!r&&r.trim().length>0);if(M.length===0){a({title:"Aucun numero",description:"Aucun nageur assigne n'a renseigne de numero de telephone.",variant:"destructive"});return}if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){const r=encodeURIComponent(`[${t.name}] `);/iPhone|iPad|iPod/i.test(navigator.userAgent)?window.location.href=`sms:/open?addresses=${M.join(",")}&body=${r}`:window.location.href=`sms:${M.join(",")}?body=${r}`}else navigator.clipboard.writeText(M.join(", ")).then(()=>{a({title:"Numeros copies",description:`${M.length} numero${M.length>1?"s":""} copie${M.length>1?"s":""} dans le presse-papiers. Utilisez votre telephone pour envoyer le SMS.`})}).catch(()=>{a({title:"Erreur",description:"Impossible de copier les numéros.",variant:"destructive"})})},x=g.length===0?"Gerez les competitions du club.":`${g.length} competition${g.length>1?"s":""}`;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(te,{title:"Competitions",description:x,onBack:s,actions:e.jsxs(F,{variant:"outline",size:"sm",onClick:j,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),o?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},t))}):h.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ze,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucune competition creee."}),e.jsxs(F,{variant:"outline",size:"sm",onClick:j,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer la premiere competition"]})]}):e.jsx("div",{className:"space-y-2",children:h.map(t=>e.jsx(Ws,{competition:t,onEdit:u,onSendSms:y},t.id))}),e.jsx(Ys,{open:i,onOpenChange:n,competition:c})]})};async function Xs(s){const{data:a,error:i}=await $e.rpc("get_auth_uid_for_user",{p_user_id:s});return i?(console.error("[objectives] Failed to resolve auth UUID:",i.message),null):a}const Zs=({open:s,onOpenChange:a,objective:i,athleteName:n,athleteAuthId:c,competitions:b})=>{const{toast:g}=W(),o=de(),p=!!i,[h,j]=l.useState("chrono"),[u,y]=l.useState(""),[x,t]=l.useState("25"),[m,M]=l.useState(""),[f,r]=l.useState(""),[k,T]=l.useState(""),[_,z]=l.useState(!1);l.useEffect(()=>{if(s)if(i){const d=!!i.event_code,C=!!i.text;j(d&&C?"both":C?"texte":"chrono"),y(i.event_code??""),t(String(i.pool_length??25)),M(i.target_time_seconds!=null?ts(i.target_time_seconds):""),r(i.text??""),T(i.competition_id??"")}else j("chrono"),y(""),t("25"),M(""),r(""),T("")},[s,i]);const q=V({mutationFn:d=>D.createObjective(d),onSuccess:()=>{g({title:"Objectif cree"}),o.invalidateQueries({queryKey:["objectives"]}),a(!1)},onError:d=>{g({title:"Erreur",description:d.message,variant:"destructive"})}}),S=V({mutationFn:d=>D.updateObjective(i.id,d),onSuccess:()=>{g({title:"Objectif mis a jour"}),o.invalidateQueries({queryKey:["objectives"]}),a(!1)},onError:d=>{g({title:"Erreur",description:d.message,variant:"destructive"})}}),v=V({mutationFn:()=>D.deleteObjective(i.id),onSuccess:()=>{g({title:"Objectif supprime"}),o.invalidateQueries({queryKey:["objectives"]}),a(!1)},onError:d=>{g({title:"Erreur",description:d.message,variant:"destructive"})}}),P=h==="chrono"||h==="both",Q=h==="texte"||h==="both",se=()=>{if(P&&!u){g({title:"Epreuve requise",description:"Veuillez selectionner une epreuve.",variant:"destructive"});return}if(P&&m&&Ue(m)===null){g({title:"Format invalide",description:"Le temps doit être au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(Q&&!f.trim()){g({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const d={athlete_id:c,competition_id:k&&k!=="none"?k:null,event_code:P?u:null,pool_length:P?Number(x):null,target_time_seconds:P&&m?Ue(m):null,text:Q?f.trim():null};p?S.mutate(d):q.mutate(d)},G=q.isPending||S.isPending||v.isPending,N=l.useMemo(()=>{const d=new Date;return d.setHours(0,0,0,0),b.filter(C=>new Date(C.date+"T00:00:00").getTime()>=d.getTime())},[b]);return e.jsxs(e.Fragment,{children:[e.jsx(_e,{open:s,onOpenChange:a,children:e.jsxs(Me,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(ke,{children:e.jsx(De,{children:p?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:n})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Type d'objectif"}),e.jsxs(Le,{type:"single",variant:"outline",value:h,onValueChange:d=>{d&&j(d)},className:"justify-start",children:[e.jsx(ae,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(ae,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(ae,{value:"both",className:"text-xs",children:"Les deux"})]})]}),P&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Epreuve *"}),e.jsxs(J,{value:u,onValueChange:y,children:[e.jsx(X,{children:e.jsx(Z,{placeholder:"Choisir une epreuve"})}),e.jsx(ee,{children:xs.map(d=>e.jsx(I,{value:d,children:ss(d)},d))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Bassin"}),e.jsxs(J,{value:x,onValueChange:t,children:[e.jsx(X,{children:e.jsx(Z,{})}),e.jsxs(ee,{children:[e.jsx(I,{value:"25",children:"25m"}),e.jsx(I,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(oe,{placeholder:"Ex : 1:05:30",value:m,onChange:d=>M(d.target.value)})]})]}),Q&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Objectif texte *"}),e.jsx(Oe,{placeholder:"Ex : Ameliorer la coulée de dos",value:f,onChange:d=>r(d.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Lier a une competition"}),e.jsxs(J,{value:k,onValueChange:T,children:[e.jsx(X,{children:e.jsx(Z,{placeholder:"Aucune"})}),e.jsxs(ee,{children:[e.jsx(I,{value:"none",children:"Aucune"}),N.map(d=>e.jsxs(I,{value:d.id,children:[d.name," (",d.date,")"]},d.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(F,{className:"w-full",onClick:se,disabled:G,children:G?"Enregistrement...":p?"Enregistrer":"Creer"}),p&&e.jsx(F,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>z(!0),disabled:G,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(fe,{open:_,onOpenChange:z,children:e.jsxs(ve,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Supprimer l'objectif"}),e.jsx(Ne,{children:"Cette action est irreversible. L'objectif sera supprime definitivement."})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(Ce,{onClick:()=>{v.mutate(),z(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},et=({objective:s,onEdit:a})=>{const i=!!s.event_code,n=!!s.text;return e.jsxs("button",{type:"button",className:"w-full text-left rounded-xl border bg-card p-3 space-y-1.5 transition-colors hover:bg-muted/50",onClick:()=>a(s),children:[i&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:ss(s.event_code)}),s.pool_length&&e.jsxs(Y,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[s.pool_length,"m"]}),s.target_time_seconds!=null&&e.jsx(Y,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:ts(s.target_time_seconds)})]}),n&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.text}),s.competition_name&&e.jsx(Y,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:s.competition_name})]})},st=({onBack:s,athletes:a,athletesLoading:i})=>{const{toast:n}=W(),[c,b]=l.useState(""),[g,o]=l.useState(!1),[p,h]=l.useState(null),j=l.useMemo(()=>c?a.find(_=>_.id!=null&&String(_.id)===c)??null:null,[a,c]),{data:u,isLoading:y}=L({queryKey:["auth-uid",c],queryFn:()=>Xs(Number(c)),enabled:!!c}),{data:x=[]}=L({queryKey:["competitions"],queryFn:()=>D.getCompetitions()}),{data:t=[],isLoading:m}=L({queryKey:["objectives",u],queryFn:()=>D.getObjectives(u),enabled:!!u}),M=l.useMemo(()=>{const _=a.filter(q=>q.id!=null),z=new Map;for(const q of _){const S=q.group_label||"Sans groupe";z.has(S)||z.set(S,[]),z.get(S).push(q)}return[...z.entries()].sort(([q],[S])=>q.localeCompare(S,"fr"))},[a]),f=()=>{if(!u){n({title:"Nageur requis",description:"Veuillez selectionner un nageur.",variant:"destructive"});return}h(null),o(!0)},r=_=>{h(_),o(!0)},k=i||!!c&&y,T=!!u&&!y;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(te,{title:"Objectifs",description:"Definissez des objectifs chrono ou texte pour chaque nageur.",onBack:s,actions:e.jsxs(F,{variant:"outline",size:"sm",onClick:f,disabled:!u,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Nageur"}),e.jsxs(J,{value:c,onValueChange:b,children:[e.jsx(X,{children:e.jsx(Z,{placeholder:"Selectionner un nageur"})}),e.jsx(ee,{children:M.map(([_,z])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:_}),z.map(q=>e.jsx(I,{value:String(q.id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:q.display_name}),q.group_label&&e.jsx(Y,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:q.group_label})]})},q.id))]},_))})]})]}),!c&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ee,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selectionnez un nageur pour voir et gerer ses objectifs."})]}),k&&c&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(_=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},_))}),T&&m&&e.jsx("div",{className:"space-y-2",children:[1,2].map(_=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},_))}),T&&!m&&t.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ee,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif defini pour ",j?.display_name,"."]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:f,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer le premier objectif"]})]}),T&&!m&&t.length>0&&e.jsx("div",{className:"space-y-2",children:t.map(_=>e.jsx(et,{objective:_,onEdit:r},_.id))}),u&&j&&e.jsx(Zs,{open:g,onOpenChange:o,objective:p,athleteName:j.display_name,athleteAuthId:u,competitions:x})]})},tt=l.lazy(()=>es(()=>import("./StrengthCatalog-dZ8cQ0hY.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35]))),nt=l.lazy(()=>es(()=>import("./SwimCatalog-Dp-CPn8A.js"),__vite__mapDeps([36,1,2,3,4,5,6,7,19,20,10,12,22,17,37,38,14,39,40,13,41,24,16,25,26,9,8,15,27,28,29,30,18,11,33,42,32,43,44,21,45,46,47,48,49]))),at=({onNavigate:s,onOpenRecordsAdmin:a,onOpenRecordsClub:i,athletes:n,athletesLoading:c,upcomingBirthdays:b,birthdaysLoading:g,kpiLoading:o,kpiPeriod:p,onKpiPeriodChange:h,fatigueAlerts:j,mostLoadedAthlete:u,swimSessionCount:y,strengthSessionCount:x})=>{const t=new Date().getHours(),m=t<12?"Bonjour":t<18?"Bon après-midi":"Bonsoir",M=new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),f=j.length>0;return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-display font-bold uppercase italic",children:[m,", ",e.jsx("span",{className:"text-primary",children:"Coach"})]}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:M})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Signaux · ",p,"j"]}),e.jsxs(Le,{type:"single",size:"sm",variant:"outline",value:String(p),onValueChange:r=>{r&&h(Number(r))},children:[e.jsx(ae,{value:"7",className:"h-7 px-2 text-xs","aria-label":"7 jours",children:"7j"}),e.jsx(ae,{value:"30",className:"h-7 px-2 text-xs","aria-label":"30 jours",children:"30j"}),e.jsx(ae,{value:"365",className:"h-7 px-2 text-xs","aria-label":"1 an",children:"1an"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:`rounded-xl border p-3 ${f?"border-destructive/30 bg-destructive/5":"bg-muted/30"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Fatigue 5/5"}),e.jsx(qs,{className:`h-3.5 w-3.5 ${f?"text-destructive":"text-muted-foreground"}`})]}),e.jsx("p",{className:"text-xl font-bold tabular-nums",children:o?"–":j.length}),e.jsx("p",{className:"text-[11px] text-muted-foreground truncate",children:o?"Chargement…":f?j.slice(0,2).map(r=>r.athleteName.split(" ")[0]).join(", "):"Aucune alerte"})]}),e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Plus chargé"}),e.jsx(ce,{className:"h-3.5 w-3.5 text-muted-foreground"})]}),e.jsx("p",{className:"text-xl font-bold truncate",children:o?"–":u?.athleteName?.split(" ")[0]??"–"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:o?"Calcul…":u?`Charge ${Math.round(u.loadScore)}`:"Pas de données"})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>s("calendar"),className:"flex items-center gap-1.5 rounded-full bg-primary text-primary-foreground px-3.5 py-2 text-sm font-semibold active:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(Pe,{className:"h-3.5 w-3.5"}),"Assigner"]}),e.jsxs("button",{type:"button",onClick:()=>s("messaging"),className:"flex items-center gap-1.5 rounded-full border px-3.5 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(Ie,{className:"h-3.5 w-3.5"}),"Email"]}),e.jsxs("button",{type:"button",onClick:()=>s("sms"),className:"flex items-center gap-1.5 rounded-full border px-3.5 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(Re,{className:"h-3.5 w-3.5"}),"SMS"]}),e.jsxs("button",{type:"button",onClick:()=>s("groups"),className:"flex items-center gap-1.5 rounded-full border px-3.5 py-2 text-sm font-semibold active:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:[e.jsx(is,{className:"h-3.5 w-3.5"}),"Groupes"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",onClick:()=>s("swim"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Xe,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Natation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:y!=null?`${y} séance${y!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("strength"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Ze,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Musculation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:x!=null?`${x} séance${x!==1?"s":""}`:"Bibliothèque"})]}),e.jsxs("button",{type:"button",onClick:()=>s("swimmers"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ce,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Nageurs"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:c?"Chargement…":`${n.length} nageur${n.length!==1?"s":""}`})]}),e.jsxs("button",{type:"button",onClick:a,className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ze,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Records club"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Import & administration"})]}),e.jsxs("button",{type:"button",onClick:()=>s("competitions"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(ze,{className:"h-5 w-5 text-amber-500 mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Compétitions"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Échéances & calendrier"})]}),e.jsxs("button",{type:"button",onClick:()=>s("objectives"),className:"rounded-xl border bg-card p-4 text-left shadow-sm active:bg-muted/50 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",children:[e.jsx(Ee,{className:"h-5 w-5 text-primary mb-2"}),e.jsx("p",{className:"text-sm font-bold",children:"Objectifs"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Temps cibles & objectifs"})]})]}),e.jsx("button",{type:"button",onClick:i,className:"w-full text-center text-sm text-primary font-semibold py-1 active:opacity-70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded",children:"Voir les records du club"}),!g&&b&&b.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Anniversaires"}),e.jsx("div",{className:"space-y-1.5",children:b.slice(0,3).map(r=>e.jsxs("div",{className:"flex items-center justify-between gap-2 rounded-lg border px-3 py-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("span",{className:"text-sm font-medium truncate block",children:r.display_name}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:rt(r.next_birthday)})]}),e.jsxs("span",{className:"text-xs font-bold text-primary shrink-0",children:["J-",r.days_until]})]},r.id))})]}):null]})},rt=s=>{if(!s)return"-";const a=new Date(s);return Number.isNaN(a.getTime())?s:a.toLocaleDateString("fr-FR")},Je=s=>s.toISOString().split("T")[0],it=s=>new Date(s.completed_at||s.started_at||s.date||s.created_at||0).getTime(),lt=s=>{if(!s.length)return null;const a=s.reduce((n,c)=>n+c,0)/s.length,i=Math.min(5,Math.max(1,Math.round(a/10*5)));return{average:a,rating:i}};function ot(){const s=Be(v=>v.role),a=Be(v=>v.setSelectedAthlete),[,i]=ps(),[n,c]=l.useState("home"),[b,g]=l.useState(7);l.useEffect(()=>{const v=()=>c("home");return window.addEventListener("nav:reset",v),()=>window.removeEventListener("nav:reset",v)},[]);const o=s==="coach"||s==="admin",p=n==="home"||n==="calendar",h=n==="home"||n==="messaging"||n==="sms"||n==="swimmers"||n==="calendar"||n==="groups"||n==="objectives",j=n==="messaging"||n==="sms"||n==="calendar"||n==="groups",u=n==="home"||n==="swimmers",{data:y}=L({queryKey:["swim_catalog"],queryFn:()=>D.getSwimCatalog(),enabled:o&&p}),{data:x}=L({queryKey:["strength_catalog"],queryFn:()=>D.getStrengthSessions(),enabled:o&&p}),{data:t=[],isLoading:m}=L({queryKey:["athletes"],queryFn:()=>D.getAthletes(),enabled:o&&h}),M=l.useMemo(()=>t.slice(0,5),[t]),{data:f=[]}=L({queryKey:["groups"],queryFn:()=>D.getGroups(),enabled:o&&j}),r=L({queryKey:["upcoming-birthdays"],queryFn:()=>D.getUpcomingBirthdays({days:30}),enabled:o&&u}),k=r.data,T=L({queryKey:["coach-kpis",b,M.map(v=>v.id??v.display_name)],enabled:o&&n==="home"&&M.length>0,queryFn:async()=>{const v=b,P=new Date;P.setDate(P.getDate()-v);const Q=Je(P),se=Je(new Date),G=await Promise.all(M.map(async C=>{const[A,E]=await Promise.all([D.getSessions(C.display_name,C.id),D.getStrengthHistory(C.display_name,{athleteId:C.id,limit:50,from:Q,to:se})]),U=A.filter($=>new Date($.date).getTime()>=P.getTime()),w=U.map($=>$.fatigue??$.feeling).filter($=>Number.isFinite($)),R=U.reduce(($,ne)=>$+(Number(ne.duration)||0)*(Number(ne.effort)||0),0),K=(E?.runs??[]).filter($=>it($)>=P.getTime()),H=K.map($=>$.fatigue??$.feeling??$.rpe).filter($=>Number.isFinite(Number($))).map($=>Number($)),ue=K.reduce(($,ne)=>{const Ve=Number(ne.feeling??ne.rpe??0),Ge=Number(ne.duration??0);if(Ge>0&&Ve>0)return $+Ge*Ve;const cs=Array.isArray(ne.logs)?ne.logs.length:0;return $+cs*5},0),me=lt([...w,...H]);return{athleteName:C.display_name,loadScore:R+ue,fatigueRating:me}})),N=G.filter(C=>C.fatigueRating?.rating===5).map(C=>({athleteName:C.athleteName,rating:C.fatigueRating?.rating??0})),d=G.filter(C=>C.loadScore>0).sort((C,A)=>A.loadScore-C.loadScore)[0];return{fatigueAlerts:N,mostLoadedAthlete:d??null}}}),_=v=>{a({id:v.id??null,name:v.display_name}),i("/progress")},{toast:z}=W(),q=de(),S=V({mutationFn:async v=>{const P=await D.importSingleSwimmer(v.iuf,v.name);return await D.recalculateClubRecords(),P},onSuccess:v=>{z({title:"Import terminé",description:`${v.total_found} trouvées, ${v.new_imported} nouvelles.`}),q.invalidateQueries({queryKey:["club-records"]})},onError:v=>{z({title:"Erreur import",description:v.message,variant:"destructive"})}});return o?e.jsxs("div",{className:"space-y-6",children:[n==="home"?e.jsx(at,{onNavigate:c,onOpenRecordsAdmin:()=>i("/records-admin"),onOpenRecordsClub:()=>i("/records-club"),athletes:t,athletesLoading:m,upcomingBirthdays:k,birthdaysLoading:r.isLoading,kpiLoading:T.isLoading,kpiPeriod:b,onKpiPeriodChange:g,fatigueAlerts:T.data?.fatigueAlerts??[],mostLoadedAthlete:T.data?.mostLoadedAthlete??null,swimSessionCount:y?.length,strengthSessionCount:x?.length}):null,n==="swim"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(te,{title:"Bibliothèque natation",description:"Accédez aux séances et aux templates natation.",onBack:()=>c("home"),actions:e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>c("calendar"),children:[e.jsx(Pe,{className:"mr-1.5 h-3.5 w-3.5"}),"Assigner"]})}),e.jsx(l.Suspense,{fallback:e.jsx(Qe,{}),children:e.jsx(nt,{})})]}):null,n==="strength"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(te,{title:"Bibliothèque musculation",description:"Consultez et créez des séances musculation.",onBack:()=>c("home"),actions:e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>c("calendar"),children:[e.jsx(Pe,{className:"mr-1.5 h-3.5 w-3.5"}),"Assigner"]})}),e.jsx(l.Suspense,{fallback:e.jsx(Qe,{}),children:e.jsx(tt,{})})]}):null,n==="swimmers"?e.jsxs("div",{className:"space-y-4",children:[e.jsx(te,{title:"Nageurs",description:m?"Chargement…":`${t.length} nageur${t.length!==1?"s":""} inscrit${t.length!==1?"s":""}`,onBack:()=>c("home"),actions:e.jsxs(F,{variant:"outline",size:"sm",onClick:()=>c("messaging"),children:[e.jsx(Ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Email"]})}),m?e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(v=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-8 w-16 rounded bg-muted"})]})},v))}):t.length?e.jsx("div",{className:"space-y-2",children:t.map(v=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:v.display_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[v.group_label?e.jsx(Y,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:v.group_label}):null,v.ffn_iuf?e.jsx("span",{className:"text-[10px] font-mono text-muted-foreground",children:v.ffn_iuf}):null]})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[v.ffn_iuf?e.jsx(F,{size:"icon",variant:"ghost",className:"h-8 w-8",disabled:S.isPending,onClick:()=>S.mutate({iuf:v.ffn_iuf,name:v.display_name}),title:"Importer performances FFN",children:e.jsx(hs,{className:"h-4 w-4"})}):null,e.jsx(F,{size:"sm",variant:"outline",onClick:()=>_(v),children:"Fiche"})]})]},v.id??v.display_name))}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun nageur disponible."})]}):null,n==="messaging"?e.jsx($s,{onBack:()=>c("home"),athletes:t,groups:f,athletesLoading:m}):null,n==="sms"?e.jsx(Ls,{onBack:()=>c("home"),athletes:t,groups:f,athletesLoading:m}):null,n==="calendar"?e.jsx(Vs,{onBack:()=>c("home"),athletes:t,groups:f,swimSessions:y,strengthSessions:x}):null,n==="groups"?e.jsx(Us,{onBack:()=>c("home"),athletes:t,groups:f,athletesLoading:m}):null,n==="competitions"?e.jsx(Js,{onBack:()=>c("home")}):null,n==="objectives"?e.jsx(st,{onBack:()=>c("home"),athletes:t,athletesLoading:m}):null]}):e.jsx("div",{className:"flex items-center justify-center min-h-[60vh] animate-in fade-in motion-reduce:animate-none",children:e.jsxs(pe,{className:"w-full max-w-sm shadow-xl border-t-4 border-t-primary",children:[e.jsxs(he,{children:[e.jsxs(xe,{className:"flex items-center gap-2 uppercase italic",children:[e.jsx(ce,{className:"h-5 w-5 text-primary"}),"Accès Coach"]}),e.jsx(ge,{children:"Cette section est réservée aux coachs et administrateurs."})]}),e.jsx(je,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connectez-vous avec un compte autorisé pour accéder aux outils de gestion."})})]})})}const Mt=Object.freeze(Object.defineProperty({__proto__:null,default:ot},Symbol.toStringTag,{value:"Module"}));export{As as C,Mt as a};
