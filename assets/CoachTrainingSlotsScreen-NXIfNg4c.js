import{c as he,r as d,d as X,j as e,u as G}from"./vendor-query-DyA9aSKS.js";import{u as Tt,d as $t,a as L,c as At}from"./api-BqRQTNHo.js";import{b as pe,L as E,l as tt,P as se,B as q,I as oe,f as Et,W as qt,d as Ee,u as Pt,a4 as st}from"./index-O16scsGl.js";import{C as It}from"./Coach-NyutYdEP.js";import{S as ge,a as fe,b as be,c as je,d as ve}from"./sheet-BVjFRx5x.js";import{B as qe}from"./badge-BWmgQcpX.js";import{C as Lt}from"./checkbox-bO_CL2JK.js";import{A as rt,a as nt,b as at,c as it,d as lt,e as ot,f as dt,g as ct}from"./alert-dialog-3hjNm7W9.js";import{C as mt}from"./clock-DG3BsbJz.js";import{M as Pe}from"./map-pin-s6SbXGX1.js";import{L as ut}from"./loader-circle-LMbdGmUd.js";import{P as xt}from"./pencil-CGWmd8-S.js";import{E as zt}from"./eye-off-CRR8hUD_.js";import{E as Vt}from"./eye-D7wHLujH.js";import{C as Rt}from"./copy-Bgkd_ALU.js";import{T as ht}from"./trash-2-CWLTF99L.js";import{w as Ht}from"./swim--0w5uie8.js";import{c as Ot}from"./swimSessionUtils-DN7EW4yB.js";import{S as Bt}from"./search-D2exaJAg.js";import{S as Kt}from"./separator-ByC_Pe78.js";import{S as re,a as ne,b as ae,c as ie,d as H,f as te}from"./select-CIupFAp1.js";import{R as Gt,a as Ge}from"./radio-group-BIjRWhYq.js";import{C as De}from"./chevron-left-KMM-GzJV.js";import{C as pt}from"./chevron-right-Bz19ZUVk.js";import{C as Wt}from"./index-Cs8y90i4.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-CdEQiqf9.js";import"./trophy-DNtLz_jw.js";import"./bell-ring-0pK-Oimy.js";import"./zap-BB2ia91Q.js";import"./index-C2Zyn6WL.js";import"./index-DCX2sNhR.js";import"./index-CgT1NBnm.js";import"./chevron-down-CtGdB8yM.js";import"./chevron-up-Cx_lvk3V.js";import"./index-CAuyrQPe.js";import"./circle-C-tQqOa7.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=[["path",{d:"M4.929 4.929 19.07 19.071",key:"196cmz"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],gt=pe("ban",Qt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]],Fe=pe("book-open",Ut);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"M10.1 2.182a10 10 0 0 1 3.8 0",key:"5ilxe3"}],["path",{d:"M13.9 21.818a10 10 0 0 1-3.8 0",key:"11zvb9"}],["path",{d:"M17.609 3.721a10 10 0 0 1 2.69 2.7",key:"1iw5b2"}],["path",{d:"M2.182 13.9a10 10 0 0 1 0-3.8",key:"c0bmvh"}],["path",{d:"M20.279 17.609a10 10 0 0 1-2.7 2.69",key:"1ruxm7"}],["path",{d:"M21.818 10.1a10 10 0 0 1 0 3.8",key:"qkgqxc"}],["path",{d:"M3.721 6.391a10 10 0 0 1 2.7-2.69",key:"1mcia2"}],["path",{d:"M6.391 20.279a10 10 0 0 1-2.69-2.7",key:"1fvljs"}]],We=pe("circle-dashed",Yt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=[["path",{d:"M11 17a4 4 0 0 1-8 0V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2Z",key:"1ldrpk"}],["path",{d:"M16.7 13H19a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H7",key:"11i5po"}],["path",{d:"M 7 17h.01",key:"1euzgo"}],["path",{d:"m11 8 2.3-2.3a2.4 2.4 0 0 1 3.404.004L18.6 7.6a2.4 2.4 0 0 1 .026 3.434L9.9 19.8",key:"o2gii7"}]],Xt=pe("swatch-book",Jt);function Zt(t,r){return t?t.visible_from===null||t.visible_from===void 0||t.visible_from<=r?"published":"draft":"empty"}function es(t){const r=parseInt(t.split(":")[0]??"",10);return Number.isFinite(r)?r<12?"morning":r>=13?"evening":null:null}function ts(t,r,n){const o=t.assignments.map(i=>i.group_id),h=n.filter(i=>i.training_slot_id===t.id&&i.scheduled_date===r),u=o.length>0?h.find(i=>i.target_group_id!=null&&o.includes(i.target_group_id)):void 0;if(u)return u;if(h.length>0)return h[0];const b=es(t.start_time);if(!b)return;const c=n.filter(i=>i.scheduled_date===r&&i.training_slot_id==null&&i.scheduled_slot===b),y=o.length>0?c.find(i=>i.target_group_id!=null&&o.includes(i.target_group_id)):void 0;if(y)return y;const p=c.find(i=>i.target_group_id==null);if(p)return p;if(o.length===0&&c.length===1)return c[0]}const ss=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function Qe(t){return t.slice(0,5)}function Ue(t){const[r,n,o]=t.split("-").map(Number),h=new Date(r,n-1,o),u=(h.getDay()+6)%7,b=ss[u],c=h.toLocaleDateString("fr-FR",{month:"long"});return`${b} ${o} ${c}`}const Te={empty:{label:"",badgeClass:""},draft:{label:"Brouillon",badgeClass:"bg-amber-500/15 text-amber-600 dark:text-amber-400 border-amber-500/25"},published:{label:"Publié",badgeClass:"bg-emerald-500/15 text-emerald-600 dark:text-emerald-400 border-emerald-500/25"},cancelled:{label:"Annulé",badgeClass:"bg-muted text-muted-foreground border-border/50"}};function rs({instance:t,open:r,onOpenChange:n,onCreateNew:o,onEditSession:h,onPickTemplate:u,onEditSlot:b,onManageOverride:c}){const y=he(),[p,i]=d.useState([]),[j,C]=d.useState(""),[M,_]=d.useState(!1),[x,N]=d.useState(!1),[v,F]=d.useState("session");d.useEffect(()=>{t&&(i(t.groups.map(A=>A.group_id)),C(t.assignment?.visible_from??t.date),_(!1),N(!1),F(t.state==="cancelled"?"slot":"session"))},[t]);const g=d.useCallback(()=>{y.invalidateQueries({queryKey:["slot-assignments"]})},[y]),D=X({mutationFn:A=>Tt(A),onSuccess:()=>{g(),_(!1)}}),w=X({mutationFn:A=>$t(A),onSuccess:()=>{g(),N(!1),n(!1)}}),T=A=>{i(V=>V.includes(A)?V.filter(K=>K!==A):[...V,A])},P=()=>{t&&D.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date,visibleFrom:j||null})},S=()=>{t&&w.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date})},B=()=>{!t||!b||(n(!1),b(t))},z=()=>{!t||!c||(n(!1),c(t))};if(!t)return null;const{state:$,slot:I,assignment:U,override:k,groups:l}=t,m=Te[$],R=$==="cancelled";return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:r,onOpenChange:n,children:e.jsxs(fe,{side:"bottom",className:"rounded-t-3xl max-h-[85vh] overflow-y-auto px-5 pb-8 pt-4",children:[e.jsx("div",{className:"mx-auto mb-4 h-1 w-10 rounded-full bg-border/60"}),e.jsxs(be,{className:"mb-5 space-y-1.5 text-left",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"text-base font-bold leading-tight",children:Ue(t.date)}),$!=="empty"&&e.jsx(qe,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${m.badgeClass}`,children:m.label})]}),e.jsxs(ve,{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(mt,{className:"h-3 w-3 opacity-60"}),Qe(I.start_time)," – ",Qe(I.end_time)]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Pe,{className:"h-3 w-3 opacity-60"}),I.location]})]})]}),e.jsx(ns,{mode:v,onModeChange:F,sessionDisabled:R}),v==="session"?e.jsxs(e.Fragment,{children:[$==="cancelled"&&e.jsx(as,{override:k}),$==="empty"&&e.jsx(is,{instance:t,groups:l,selectedGroups:p,visibleFrom:j,onToggleGroup:T,onVisibleFromChange:C,onCreateNew:o,onPickTemplate:u,onClose:()=>n(!1)}),($==="draft"||$==="published")&&e.jsx(ls,{instance:t,assignment:U,showVisibilityPicker:M,visibleFrom:j,visibilityLoading:D.isPending,deleteLoading:w.isPending,onToggleVisibilityPicker:()=>_(A=>!A),onVisibleFromChange:C,onSaveVisibility:P,onEditSession:h,onRequestDelete:()=>N(!0)})]}):e.jsx(os,{state:$,override:k,canEditSlot:!!b,canManageOverride:!!c,onEditSlot:B,onManageOverride:z})]})}),e.jsx(rt,{open:x,onOpenChange:N,children:e.jsxs(nt,{children:[e.jsxs(at,{children:[e.jsx(it,{children:"Supprimer la séance ?"}),e.jsxs(lt,{children:["Cette action supprimera définitivement la séance assignée pour ce créneau le ",Ue(t.date),". Les nageurs ne verront plus cette séance."]})]}),e.jsxs(ot,{children:[e.jsx(dt,{disabled:w.isPending,children:"Annuler"}),e.jsx(ct,{onClick:S,disabled:w.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:w.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ut,{className:"mr-2 h-4 w-4 animate-spin"}),"Suppression..."]}):"Supprimer"})]})]})})]})}function ns({mode:t,onModeChange:r,sessionDisabled:n}){return e.jsxs("div",{className:"mb-5 space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-[0.18em] text-muted-foreground",children:"Étape 1"}),e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Choisissez ce que vous voulez gérer"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx(Ye,{title:"Séance",description:n?"Indisponible tant que le créneau est annulé":"Créer, modifier ou publier",active:t==="session",disabled:n,onClick:()=>r("session")}),e.jsx(Ye,{title:"Créneau",description:"Horaires, lieu et exception",active:t==="slot",onClick:()=>r("slot")})]})]})}function Ye({title:t,description:r,active:n,disabled:o=!1,onClick:h}){return e.jsxs("button",{type:"button",onClick:h,disabled:o,className:`
        rounded-2xl border px-4 py-3 text-left transition-all
        ${o?"cursor-not-allowed opacity-50":"active:scale-[0.98]"}
        ${n?"border-primary/40 bg-primary/8 shadow-sm":"border-border/50 bg-muted/20 hover:bg-muted/35"}
      `,children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t}),e.jsx("p",{className:"mt-1 text-[11px] leading-snug text-muted-foreground",children:r})]})}function Ne({title:t,description:r}){return e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-[11px] font-semibold uppercase tracking-[0.18em] text-muted-foreground",children:"Étape 2"}),e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-muted/20 px-4 py-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:r})]})]})}function as({override:t}){return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ne,{title:"Définir une séance",description:"Ce sous-menu redevient disponible quand le créneau n'est plus annulé."}),e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-muted/30 p-4 text-center",children:[e.jsx("div",{className:"mx-auto flex h-10 w-10 items-center justify-center rounded-2xl bg-muted",children:e.jsx(gt,{className:"h-4 w-4 text-muted-foreground"})}),e.jsx("p",{className:"mt-3 text-sm font-medium text-foreground",children:"Ce créneau est annulé"}),t?.reason&&e.jsxs("p",{className:"mt-1.5 text-xs text-muted-foreground",children:["Motif : ",t.reason]})]})]})}function is({instance:t,groups:r,selectedGroups:n,visibleFrom:o,onToggleGroup:h,onVisibleFromChange:u,onCreateNew:b,onPickTemplate:c,onClose:y}){const p=()=>{y(),b(t)},i=()=>{y(),c(t)};return e.jsxs("div",{className:"space-y-5",children:[e.jsx(Ne,{title:"Définir une séance",description:"Choisissez comment renseigner la séance liée à ce créneau."}),r.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Groupes concernés"}),e.jsx("div",{className:"space-y-2.5",children:r.map(j=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx(Lt,{checked:n.includes(j.group_id),onCheckedChange:()=>h(j.group_id),className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:j.group_name})]},j.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(E,{htmlFor:"visible-from-empty",className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:[e.jsx(tt,{className:"mr-1 inline h-3 w-3 opacity-60"}),"Visible à partir du"]}),e.jsx("input",{id:"visible-from-empty",type:"date",value:o,onChange:j=>u(j.target.value),className:"w-full rounded-xl border border-border bg-muted/30 px-3 py-2.5 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]}),e.jsxs("div",{className:"space-y-2.5",children:[e.jsx(W,{icon:e.jsx(se,{className:"h-4 w-4"}),label:"Nouvelle séance",description:"Créer une séance de zéro",onClick:p,highlight:!0}),e.jsx(W,{icon:e.jsx(Fe,{className:"h-4 w-4"}),label:"Depuis la bibliothèque",description:"Réutiliser une séance existante",onClick:i})]})]})}function ls({instance:t,assignment:r,showVisibilityPicker:n,visibleFrom:o,visibilityLoading:h,deleteLoading:u,onToggleVisibilityPicker:b,onVisibleFromChange:c,onSaveVisibility:y,onEditSession:p,onRequestDelete:i}){return e.jsxs("div",{className:"space-y-5",children:[e.jsx(Ne,{title:"Définir une séance",description:"Travaillez sur la séance déjà liée à ce créneau."}),e.jsxs("div",{className:"rounded-xl border border-border/50 bg-muted/30 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground leading-snug",children:r.session_name??"Séance sans nom"}),r.session_distance!=null&&r.session_distance>0&&e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:[r.session_distance," m"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(qe,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${Te[t.state].badgeClass}`,children:Te[t.state].label}),r.visible_from&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Visible le"," ",new Date(r.visible_from).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})]})]})]}),t.groups.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.groups.map(j=>e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full border border-border/50 bg-muted/60 px-2.5 py-1 text-xs font-medium text-muted-foreground",children:j.group_name},j.id))}),e.jsxs("div",{className:"space-y-2.5",children:[r.swim_catalog_id!=null&&e.jsx(W,{icon:e.jsx(xt,{className:"h-4 w-4"}),label:"Modifier la séance",description:"Ouvrir dans l'éditeur",onClick:()=>p(r.swim_catalog_id),highlight:!0}),e.jsx(W,{icon:n?e.jsx(zt,{className:"h-4 w-4"}):e.jsx(Vt,{className:"h-4 w-4"}),label:"Visibilité",description:"Définir la date de publication",onClick:b}),n&&e.jsxs("div",{className:"ml-12 space-y-2.5 rounded-xl border border-border/50 bg-muted/20 p-3",children:[e.jsx(E,{htmlFor:"visible-from-edit",className:"text-xs text-muted-foreground",children:"Visible à partir du"}),e.jsx("input",{id:"visible-from-edit",type:"date",value:o,onChange:j=>c(j.target.value),className:"w-full rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(q,{size:"sm",className:"flex-1 rounded-lg",disabled:h,onClick:y,children:[h?e.jsx(ut,{className:"mr-1.5 h-3.5 w-3.5 animate-spin"}):null,"Enregistrer"]}),e.jsx(q,{size:"sm",variant:"ghost",className:"rounded-lg",disabled:h,onClick:b,children:"Annuler"})]})]}),e.jsx(W,{icon:e.jsx(Rt,{className:"h-4 w-4"}),label:"Dupliquer vers...",description:"Bientôt disponible",disabled:!0,onClick:()=>{}}),e.jsx(W,{icon:e.jsx(ht,{className:"h-4 w-4"}),label:"Supprimer",description:"Retirer cette séance du créneau",variant:"destructive",disabled:u,onClick:i})]})]})}function os({state:t,override:r,canEditSlot:n,canManageOverride:o,onEditSlot:h,onManageOverride:u}){return!n&&!o?null:e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ne,{title:"Gérer le créneau",description:"Modifiez la structure du créneau ou ajustez uniquement cette date."}),t==="cancelled"&&e.jsxs("div",{className:"rounded-2xl border border-border/50 bg-muted/30 px-4 py-3",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Créneau annulé"}),r?.reason&&e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:["Motif : ",r.reason]})]}),e.jsxs("div",{className:"space-y-2.5",children:[n&&e.jsx(W,{icon:e.jsx(xt,{className:"h-4 w-4"}),label:"Modifier le créneau",description:"Horaires, lieu et groupes",onClick:h,highlight:!0}),o&&e.jsx(W,{icon:e.jsx(tt,{className:"h-4 w-4"}),label:"Gérer l'exception",description:"Annuler ou ajuster ce jour précis",onClick:u})]})]})}function W({icon:t,label:r,description:n,variant:o="default",disabled:h=!1,highlight:u=!1,onClick:b}){const c=o==="destructive";return e.jsxs("button",{type:"button",onClick:b,disabled:h,className:`
        flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-left transition-colors
        ${h?"opacity-40 cursor-not-allowed":"active:scale-[0.98]"}
        ${c?"bg-destructive/5 hover:bg-destructive/10 active:bg-destructive/15":u?"bg-primary/10 hover:bg-primary/15 active:bg-primary/20":"bg-muted/40 hover:bg-muted/60 active:bg-muted/80"}
      `,children:[e.jsx("div",{className:`flex h-9 w-9 shrink-0 items-center justify-center rounded-lg ${c?"bg-destructive/10 text-destructive":u?"bg-primary/15 text-primary":"bg-muted text-muted-foreground"}`,children:t}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm font-semibold ${c?"text-destructive":"text-foreground"}`,children:r}),n&&e.jsx("p",{className:"mt-0.5 text-xs text-muted-foreground",children:n})]})]})}function ds({open:t,onOpenChange:r,onSelect:n}){const[o,h]=d.useState(""),{data:u,isLoading:b}=G({queryKey:["swim_catalog"],queryFn:()=>Ht(),enabled:t}),c=d.useMemo(()=>{if(!u)return[];const p=o.trim().toLowerCase();return u.filter(i=>!i.is_archived).filter(i=>!p||i.name.toLowerCase().includes(p)||(i.folder??"").toLowerCase().includes(p)).sort((i,j)=>i.name.localeCompare(j.name,"fr"))},[u,o]),y=p=>{n(p.id,p.name),r(!1)};return e.jsx(ge,{open:t,onOpenChange:r,children:e.jsxs(fe,{side:"bottom",className:"flex h-[80vh] flex-col rounded-t-2xl px-4 pb-4 pt-5",children:[e.jsxs(be,{className:"shrink-0 space-y-1",children:[e.jsx(je,{className:"text-base font-semibold",children:"Choisir une séance"}),e.jsx(ve,{className:"sr-only",children:"Parcourez et recherchez dans la bibliothèque de séances natation"})]}),e.jsxs("div",{className:"relative mt-3 shrink-0",children:[e.jsx(Bt,{className:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(oe,{placeholder:"Rechercher une séance...",value:o,onChange:p=>h(p.target.value),className:"pl-9"})]}),e.jsx("div",{className:"mt-3 flex-1 overflow-y-auto overscroll-contain",children:b?e.jsx("div",{className:"space-y-3",children:Array.from({length:6}).map((p,i)=>e.jsx(Et,{className:"h-[72px] w-full rounded-xl"},i))}):c.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-16 text-muted-foreground",children:[e.jsx(qt,{className:"h-10 w-10 opacity-40"}),e.jsx("p",{className:"text-sm",children:"Aucune séance dans la bibliothèque"})]}):e.jsx("div",{className:"space-y-2",children:c.map(p=>{const i=Ot(p.items??[]);return e.jsxs("button",{type:"button",onClick:()=>y(p),className:"flex w-full items-center gap-3 rounded-xl border border-border bg-card p-3 text-left shadow-sm transition-transform active:scale-[0.98]",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-blue-500/10 text-blue-400",children:e.jsx(Xt,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:p.name}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-2 text-xs text-muted-foreground",children:[i>0&&e.jsxs("span",{children:[i.toLocaleString("fr-FR")," m"]}),i>0&&p.folder&&e.jsx("span",{"aria-hidden":"true",children:"·"}),p.folder&&e.jsx("span",{className:"truncate",children:p.folder})]})]})]},p.id)})})})]})})}const Ie=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],cs=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],de=6,ms=22,ft=ms-de,xe=40,Je=ft*xe,Xe=Array.from({length:ft+1},(t,r)=>de+r);function Q(t){return t.slice(0,5)}function Me(){return new Date().toISOString().slice(0,10)}function Y(t){const[r,n]=t.split(":").map(Number);return r*60+n}function $e(t){return(Y(t)-de*60)/60*xe}function us(t,r){return $e(r)-$e(t)}function Ze(t){const r=new Date(t),n=r.getDay(),o=n===0?-6:1-n;return r.setDate(r.getDate()+o),r.setHours(0,0,0,0),r}function xs(t){const r=new Date(t);r.setHours(0,0,0,0),r.setDate(r.getDate()+3-(r.getDay()+6)%7);const n=new Date(r.getFullYear(),0,4);return 1+Math.round(((r.getTime()-n.getTime())/864e5-3+(n.getDay()+6)%7)/7)}function le(t){return t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function J(t){const r=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${r(t.getMonth()+1)}-${r(t.getDate())}`}function Ae(t){const r=t.toLowerCase();return r.includes("piscine")||r.includes("bassin")||!r.includes("salle")&&!r.includes("muscu")&&!r.includes("ppg")&&!r.includes("gym")}function et(t,r,n){const o={slot:{trainingSlotId:t.slot.id,scheduledDate:t.date,startTime:t.slot.start_time,endTime:t.slot.end_time,location:t.slot.location}};return r==="edit"&&n!=null?{mode:r,swimCatalogId:n,...o}:{mode:"create",...o}}const hs=({open:t,onOpenChange:r,slot:n,groups:o,coaches:h})=>{const{toast:u}=Ee(),b=he(),c=!!n,[y,p]=d.useState("1"),[i,j]=d.useState(""),[C,M]=d.useState(""),[_,x]=d.useState(""),[N,v]=d.useState([]),[F,g]=d.useState(1),[D,w]=d.useState(!1);d.useEffect(()=>{if(t)if(n){p(String(n.day_of_week)),j(Q(n.start_time)),M(Q(n.end_time)),x(n.location);const l=n.assignments.map((m,R)=>({key:R,group_id:String(m.group_id),coach_id:String(m.coach_id),lane_count:m.lane_count!=null?String(m.lane_count):""}));v(l),g(l.length)}else p("1"),j(""),M(""),x(""),v([]),g(1)},[t,n]);const T=()=>{v(l=>[...l,{key:F,group_id:"",coach_id:"",lane_count:""}]),g(l=>l+1)},P=l=>{v(m=>m.filter(R=>R.key!==l))},S=(l,m,R)=>{v(A=>A.map(V=>V.key===l?{...V,[m]:R}:V))},B=()=>!i||!C?(u({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):_.trim()?{day_of_week:Number(y),start_time:i,end_time:C,location:_.trim(),assignments:N.filter(l=>l.group_id&&l.coach_id).map(l=>({group_id:Number(l.group_id),coach_id:Number(l.coach_id),lane_count:l.lane_count?Number(l.lane_count):null}))}:(u({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),z=X({mutationFn:l=>L.createTrainingSlot(l),onSuccess:()=>{u({title:"Creneau cree"}),b.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:l=>{u({title:"Erreur",description:l.message,variant:"destructive"})}}),$=X({mutationFn:l=>L.updateTrainingSlot(n.id,l),onSuccess:()=>{u({title:"Creneau mis a jour"}),b.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:l=>{u({title:"Erreur",description:l.message,variant:"destructive"})}}),I=X({mutationFn:()=>L.deleteTrainingSlot(n.id),onSuccess:()=>{u({title:"Creneau supprime"}),b.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:l=>{u({title:"Erreur",description:l.message,variant:"destructive"})}}),U=()=>{const l=B();l&&(c?$.mutate(l):z.mutate(l))},k=z.isPending||$.isPending||I.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:t,onOpenChange:r,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(je,{children:c?"Modifier le creneau":"Nouveau creneau"}),e.jsx(ve,{children:c?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Jour de la semaine *"}),e.jsxs(re,{value:y,onValueChange:p,children:[e.jsx(ne,{children:e.jsx(ae,{})}),e.jsx(ie,{children:Ie.map((l,m)=>e.jsx(H,{value:String(m+1),children:l},m+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:i,onChange:l=>j(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:C,onChange:l=>M(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(oe,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:_,onChange:l=>x(l.target.value)})]}),e.jsx(Kt,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(E,{children:"Groupes & Coachs"}),e.jsxs(q,{type:"button",variant:"outline",size:"sm",onClick:T,children:[e.jsx(se,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),N.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),N.map(l=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(re,{value:l.group_id,onValueChange:m=>S(l.key,"group_id",m),children:[e.jsx(ne,{className:"h-8 text-xs",children:e.jsx(ae,{placeholder:"Groupe..."})}),e.jsx(ie,{children:o.map(m=>e.jsx(H,{value:String(m.id),children:m.name},m.id))})]}),e.jsxs(re,{value:l.coach_id,onValueChange:m=>S(l.key,"coach_id",m),children:[e.jsx(ne,{className:"h-8 text-xs",children:e.jsx(ae,{placeholder:"Coach..."})}),e.jsx(ie,{children:h.map(m=>e.jsx(H,{value:String(m.id),children:m.display_name},m.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{type:"number",min:0,placeholder:"Lignes d'eau",value:l.lane_count,onChange:m=>S(l.key,"lane_count",m.target.value),className:"h-8 text-xs flex-1"}),e.jsx(q,{type:"button",variant:"ghost",size:"icon",className:"h-10 w-10 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>P(l.key),children:e.jsx(ht,{className:"h-3.5 w-3.5"})})]})]})},l.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(q,{className:"w-full",onClick:U,disabled:k||!i||!C||!_.trim(),children:k?"Enregistrement...":c?"Enregistrer":"Creer"}),c&&e.jsx(q,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>w(!0),disabled:k,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(rt,{open:D,onOpenChange:w,children:e.jsxs(nt,{children:[e.jsxs(at,{children:[e.jsx(it,{children:"Supprimer le creneau"}),e.jsx(lt,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(ot,{children:[e.jsx(dt,{children:"Annuler"}),e.jsx(ct,{onClick:()=>{I.mutate(),w(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},ps=({open:t,onOpenChange:r,slot:n})=>{const{toast:o}=Ee(),h=he(),[u,b]=d.useState(""),[c,y]=d.useState("cancelled"),[p,i]=d.useState(""),[j,C]=d.useState(""),[M,_]=d.useState(""),[x,N]=d.useState("");d.useEffect(()=>{t&&(b(""),y("cancelled"),i(n?Q(n.start_time):""),C(n?Q(n.end_time):""),_(n?.location??""),N(""))},[t,n]);const v=X({mutationFn:g=>L.createSlotOverride(g),onSuccess:()=>{o({title:"Exception enregistree"}),h.invalidateQueries({queryKey:["training-slot-overrides"]}),h.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:g=>{o({title:"Erreur",description:g.message,variant:"destructive"})}}),F=()=>{if(!n)return;if(!u){o({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const g={slot_id:n.id,override_date:u,status:c,new_start_time:c==="modified"&&p||null,new_end_time:c==="modified"&&j||null,new_location:c==="modified"&&M.trim()?M.trim():null,reason:x.trim()||null};v.mutate(g)};return e.jsx(ge,{open:t,onOpenChange:r,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(je,{children:"Exception"}),e.jsx(ve,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:u,onChange:g=>b(g.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Type"}),e.jsxs(Gt,{value:c,onValueChange:g=>y(g),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ge,{value:"cancelled",id:"ovr-cancelled"}),e.jsx(E,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ge,{value:"modified",id:"ovr-modified"}),e.jsx(E,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),c==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:p,onChange:g=>i(g.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:j,onChange:g=>C(g.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(oe,{id:"ovr-location",value:M,onChange:g=>_(g.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(oe,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:x,onChange:g=>N(g.target.value)})]}),e.jsx(q,{className:"w-full",onClick:F,disabled:v.isPending||!u,children:v.isPending?"Enregistrement...":"Enregistrer"})]})]})})};function bt(t){return t?t.state:"empty"}function jt({state:t,compact:r=!1}){const n={empty:{label:"À renseigner",shortLabel:"À faire",icon:We,className:"border-border/60 bg-background/80 text-muted-foreground"},draft:{label:"Brouillon",shortLabel:"Brouillon",icon:We,className:"border-amber-500/30 bg-amber-500/10 text-amber-700 dark:text-amber-300"},published:{label:"Renseignée",shortLabel:"OK",icon:Wt,className:"border-emerald-500/30 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300"},cancelled:{label:"Annulé",shortLabel:"Annulé",icon:gt,className:"border-border/60 bg-muted/60 text-muted-foreground"}},{icon:o,className:h,label:u,shortLabel:b}=n[t];return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-semibold leading-none ${h}`,title:u,"aria-label":u,children:[e.jsx(o,{className:"h-3 w-3 shrink-0"}),!r&&e.jsx("span",{children:b})]})}const gs=({slot:t,instance:r,hasOverrides:n,cancelled:o=!1,onSelect:h})=>{const u=$e(t.start_time),b=us(t.start_time,t.end_time),c=b<50,y=Ae(t.location),p=bt(r),i=!!r?.assignment,j=r?.state==="draft",C=r?.state==="published",M=o?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":C?"bg-emerald-500/12 border-emerald-500/30 hover:bg-emerald-500/18":j?"bg-amber-500/12 border-amber-500/30 hover:bg-amber-500/18":y?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",_=C?"text-emerald-600 dark:text-emerald-400":j?"text-amber-600 dark:text-amber-400":y?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${M}`,style:{top:u,height:b,minHeight:24},onClick:()=>h(t),title:`${Q(t.start_time)}–${Q(t.end_time)} · ${t.location}${r?.assignment?.session_name?` · ${r.assignment.session_name}`:""}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${c?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx(Pe,{className:`h-2.5 w-2.5 shrink-0 ${_}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:t.location}),n&&!o&&e.jsx(st,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),e.jsx("span",{className:"shrink-0",children:e.jsx(jt,{state:p,compact:!0})})]}),!c&&t.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:t.assignments.map(x=>e.jsx(qe,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:x.group_name},x.id))}),!c&&b>=70&&t.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(t.assignments.map(x=>x.coach_name))].join(", ")}),!c&&i&&e.jsx("span",{className:`text-[9px] truncate ${j?"text-amber-700 dark:text-amber-300":"text-emerald-700 dark:text-emerald-300"}`,children:r?.assignment?.session_name??"Séance"})]})})};function fs(t,r){const n=Y(r)-Y(t),o=Math.floor(n/60),h=n%60;return o===0?`${h}min`:h===0?`${o}h`:`${o}h${String(h).padStart(2,"0")}`}const bs=({slotsByDay:t,slotInstancesById:r,weekDates:n,todayStr:o,overridesBySlot:h,cancelledSlotIds:u,onSelect:b,onPrevWeek:c,onNextWeek:y,weekNumber:p})=>{const[i,j]=d.useState(()=>{const x=n.findIndex(N=>J(N)===o);return x>=0?x+1:1});d.useEffect(()=>{const x=n.findIndex(N=>J(N)===o);x>=0?j(x+1):j(1)},[n,o]);const C=t.get(i)??[],M=d.useMemo(()=>{let x=22,N=6;return t.forEach(v=>{for(const F of v){const g=Math.floor(Y(F.start_time)/60),D=Math.ceil(Y(F.end_time)/60);g<x&&(x=g),D>N&&(N=D)}}),x>=N?{start:6,end:22}:{start:Math.max(0,x),end:Math.min(24,N)}},[t]),_=(M.end-M.start)*60;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:c,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",p]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[le(n[0])," – ",le(n[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:y,children:e.jsx(pt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border bg-card overflow-hidden",children:n.map((x,N)=>{const v=N+1,F=J(x)===o,g=v===i,D=t.get(v)??[];return e.jsxs("button",{type:"button",className:`flex flex-col items-center py-2 transition-colors relative ${g?"bg-primary/8":"hover:bg-muted/50 active:bg-muted"}`,onClick:()=>j(v),children:[e.jsx("span",{className:`text-[10px] font-semibold uppercase tracking-wider ${F?"text-primary":"text-muted-foreground"}`,children:cs[N]}),e.jsx("span",{className:`text-sm font-bold tabular-nums mt-0.5 h-10 w-10 flex items-center justify-center rounded-full ${F?"bg-primary text-primary-foreground":g?"text-foreground":"text-foreground/80"}`,children:x.getDate()}),e.jsx("div",{className:"w-full px-1 mt-1.5 h-8 relative",children:D.map(w=>{const T=Y(w.start_time)-M.start*60,P=Y(w.end_time)-M.start*60,S=Math.max(0,T/_*100),B=Math.max(8,(P-T)/_*100),z=Ae(w.location),$=u.has(w.id),I=r.get(w.id),U=I?.state==="published",k=I?.state==="draft";return e.jsx("div",{className:`absolute left-1 right-1 rounded-sm ${$?"bg-muted-foreground/20":U?"bg-emerald-500/50":k?"bg-amber-500/50":z?"bg-blue-500/40":"bg-amber-400/50"}`,style:{top:`${S}%`,height:`${B}%`,minHeight:"3px"}},w.id)})}),g&&e.jsx("div",{className:"absolute bottom-0 left-2 right-2 h-0.5 rounded-full bg-primary"})]},v)})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground px-0.5",children:[Ie[i-1]," ",n[i-1]?.getDate()," ",e.jsx("span",{className:"font-normal text-muted-foreground",children:n[i-1]?.toLocaleDateString("fr-FR",{month:"long"})})]}),C.length===0?e.jsx("div",{className:"rounded-xl border border-dashed border-border/60 bg-muted/20 py-8 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun créneau"})}):e.jsx("div",{className:"space-y-2",children:C.map(x=>{const N=Ae(x.location),v=u.has(x.id),F=h.get(x.id)??[],g=F.length>0,D=r.get(x.id),w=bt(D),T=D?.state==="published",P=D?.state==="draft";return e.jsx("button",{type:"button",className:`w-full text-left rounded-xl border bg-card transition-all active:scale-[0.98] ${v?"opacity-50 border-border":"border-border hover:border-border/80"}`,onClick:()=>b(x),children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`w-1 rounded-l-xl flex-shrink-0 ${v?"bg-muted-foreground/30":N?"bg-blue-500":"bg-amber-400"}`}),e.jsxs("div",{className:"flex-1 px-3 py-2.5 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsxs("span",{className:`text-sm font-bold tabular-nums ${v?"line-through text-muted-foreground":"text-foreground"}`,children:[Q(x.start_time)," – ",Q(x.end_time)]}),e.jsx("span",{className:`text-xs tabular-nums px-1.5 py-0.5 rounded-md font-medium ${N?"bg-blue-500/10 text-blue-600 dark:text-blue-400":"bg-amber-400/10 text-amber-600 dark:text-amber-400"}`,children:fs(x.start_time,x.end_time)})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(jt,{state:w}),g&&!v&&e.jsx(st,{className:"h-3.5 w-3.5 text-orange-500 flex-shrink-0"})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[e.jsx(Pe,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:x.location})]}),D?.assignment?.session_name&&e.jsxs("div",{className:"mt-1.5 flex items-center gap-1.5",children:[e.jsx("span",{className:`inline-flex rounded-md px-1.5 py-0.5 text-[10px] font-semibold ${P?"bg-amber-500/10 text-amber-700 dark:text-amber-300":T?"bg-emerald-500/10 text-emerald-700 dark:text-emerald-300":"bg-muted text-muted-foreground"}`,children:P?"Brouillon":"Publié"}),e.jsx("span",{className:"truncate text-xs font-medium text-foreground",children:D.assignment.session_name})]}),x.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1.5",children:x.assignments.map(S=>e.jsxs("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded-md bg-muted text-muted-foreground",children:[S.group_name,S.coach_name?` · ${S.coach_name.split(" ")[0]}`:"",S.lane_count?` · ${S.lane_count}L`:""]},S.id))}),g&&!v&&e.jsx("div",{className:"mt-1.5 space-y-0.5",children:F.slice(0,2).map(S=>e.jsxs("div",{className:"flex items-center gap-1 text-[10px]",children:[e.jsxs("span",{className:`font-medium ${S.status==="cancelled"?"text-red-500":"text-orange-500"}`,children:[S.status==="cancelled"?"Annulé":"Modifié"," le"," ",new Date(S.override_date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})]}),S.reason&&e.jsxs("span",{className:"text-muted-foreground truncate",children:["— ",S.reason]})]},S.id))})]})]})},x.id)})})]})]})},ar=({onBack:t,groups:r,onOpenLibrary:n})=>{const{toast:o}=Ee(),h=he(),{userId:u}=Pt(),[b,c]=d.useState(!1),[y,p]=d.useState(null),[i,j]=d.useState(null),[C,M]=d.useState(!1),[_,x]=d.useState(null),[N,v]=d.useState(!1),[F,g]=d.useState(!1),[D,w]=d.useState(null),[T,P]=d.useState(()=>Ze(new Date)),S=d.useMemo(()=>xs(T),[T]),B=d.useMemo(()=>{const s=new Date(T);return s.setDate(s.getDate()+6),s},[T]),z=d.useMemo(()=>Array.from({length:7},(s,a)=>{const f=new Date(T);return f.setDate(f.getDate()+a),f}),[T]),$=()=>P(s=>{const a=new Date(s);return a.setDate(a.getDate()-7),a}),I=()=>P(s=>{const a=new Date(s);return a.setDate(a.getDate()+7),a}),U=()=>P(Ze(new Date)),[k,l]=d.useState("all"),{data:m=[],isLoading:R}=G({queryKey:["training-slots"],queryFn:()=>L.getTrainingSlots()}),{data:A=[]}=G({queryKey:["training-slot-overrides"],queryFn:()=>L.getSlotOverrides()}),{data:V=[]}=G({queryKey:["users","coaches"],queryFn:()=>L.listUsers({role:"coach"})}),{data:K=[]}=G({queryKey:["athletes"],queryFn:()=>L.getAthletes()}),O=k.startsWith("swimmer:")?Number(k.split(":")[1]):null,{data:ye}=G({queryKey:["swimmer-slots",O],queryFn:()=>L.getSwimmerSlots(O),enabled:O!=null}),{data:Se}=G({queryKey:["swimmer-slots-exists",O],queryFn:()=>L.hasCustomSlots(O),enabled:O!=null}),we=d.useMemo(()=>ye?ye.map(s=>({id:s.id,day_of_week:s.day_of_week,start_time:s.start_time,end_time:s.end_time,location:s.location,is_active:s.is_active,created_by:s.created_by,created_at:s.created_at,assignments:[]})):[],[ye]),ce=d.useMemo(()=>{if(k==="all")return m;if(k.startsWith("group:")){const s=Number(k.split(":")[1]);return m.filter(a=>a.assignments.some(f=>f.group_id===s))}if(k.startsWith("coach:")){const s=Number(k.split(":")[1]);return m.filter(a=>a.assignments.some(f=>f.coach_id===s))}if(k.startsWith("swimmer:")){if(Se&&we.length>0)return we;const s=K.find(a=>a.id===O);return s?.group_id?m.filter(a=>a.assignments.some(f=>f.group_id===s.group_id)):m}return m},[m,k,Se,we,K,O]),Le=d.useMemo(()=>{const s=new Map;for(let a=1;a<=7;a++)s.set(a,[]);for(const a of ce)s.get(a.day_of_week).push(a);for(const a of s.values())a.sort((f,ee)=>f.start_time.localeCompare(ee.start_time));return s},[ce]),me=J(T),ue=J(B),{data:ze=[]}=G({queryKey:["slot-assignments",me,ue],queryFn:()=>L.getSlotAssignments({from:me,to:ue})}),Z=d.useMemo(()=>A.filter(s=>s.override_date>=me&&s.override_date<=ue),[A,me,ue]),Ve=d.useMemo(()=>{const s=new Map;for(const a of Z){const f=s.get(a.slot_id)??[];f.push(a),s.set(a.slot_id,f)}return s},[Z]),Re=d.useMemo(()=>{const s=new Set;for(const a of Z)a.status==="cancelled"&&s.add(a.slot_id);return s},[Z]),_e=d.useMemo(()=>{const s=new Map,a=Me();for(const f of ce){const ee=z[f.day_of_week-1];if(!ee)continue;const Ce=J(ee),Oe=Z.find(Ke=>Ke.slot_id===f.id&&Ke.override_date===Ce),Be=ts(f,Ce,ze),Ft=Oe?.status==="cancelled"?"cancelled":Zt(Be,a);s.set(f.id,{date:Ce,slot:f,groups:f.assignments,state:Ft,assignment:Be,override:Oe})}return s},[ce,ze,z,Z]),ke=()=>{p(null),c(!0)},vt=s=>{x(s),v(!0)},He=s=>{const a=_e.get(s.id);a&&vt(a)},Nt=s=>{p(s.slot),c(!0)},yt=s=>{j(s.slot),M(!0)},St=s=>{n&&(v(!1),n(et(s,"create")))},wt=s=>{if(n){if(v(!1),!_){n();return}n(et(_,"edit",s))}},_t=s=>{w(s),v(!1),g(!0)},kt=X({mutationFn:async({catalogId:s,instance:a})=>{const f=a.groups.map(ee=>ee.group_id);!u||f.length===0||await L.bulkCreateSlotAssignments({swimCatalogId:s,trainingSlotId:a.slot.id,scheduledDate:a.date,groupIds:f,scheduledSlot:At(a.slot.start_time),visibleFrom:a.date,assignedBy:u})},onSuccess:()=>{h.invalidateQueries({queryKey:["slot-assignments"]}),g(!1),w(null)},onError:s=>{o({title:"Erreur",description:s.message,variant:"destructive"})}}),Ct=s=>{D&&kt.mutate({catalogId:s,instance:D})},Mt=V.map(s=>({id:s.id,display_name:s.display_name})),Dt=m.length===0?"Planning hebdomadaire des entrainements.":`${m.length} creneau${m.length>1?"x":""}`;return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{variant:"ghost",size:"icon",className:"h-10 w-10 -ml-2",onClick:t,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),m.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[m.length," créneau",m.length>1?"x":""," actif",m.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full border border-border bg-card text-primary active:scale-90 transition-all",onClick:()=>n(),"aria-label":"Ouvrir la bibliothèque",children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:ke,children:e.jsx(se,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(It,{title:"Creneaux",description:Dt,onBack:t,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[n&&e.jsxs(q,{variant:"ghost",size:"sm",onClick:()=>n(),children:[e.jsx(Fe,{className:"mr-1.5 h-3.5 w-3.5"}),"Bibliothèque"]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:ke,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})]})})}),!R&&m.length>0&&e.jsx("div",{className:"sm:hidden",children:e.jsxs(re,{value:k,onValueChange:l,children:[e.jsx(ne,{className:"w-full",children:e.jsx(ae,{placeholder:"Filtrer..."})}),e.jsxs(ie,{children:[e.jsx(H,{value:"all",children:"Tous les créneaux"}),e.jsx(te,{}),r.map(s=>e.jsx(H,{value:`group:${s.id}`,children:s.name},s.id)),K.length>0&&e.jsx(te,{}),K.map(s=>e.jsx(H,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(q,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:$,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:U,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",S]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[le(T)," – ",le(B)]})]}),e.jsx(q,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:I,children:e.jsx(pt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-row items-center gap-3",children:e.jsxs(re,{value:k,onValueChange:l,children:[e.jsx(ne,{className:"w-56",children:e.jsx(ae,{placeholder:"Filtrer..."})}),e.jsxs(ie,{children:[e.jsx(H,{value:"all",children:"Tous les créneaux"}),e.jsx(te,{}),r.map(s=>e.jsx(H,{value:`group:${s.id}`,children:s.name},s.id)),V.length>0&&e.jsx(te,{}),V.map(s=>e.jsx(H,{value:`coach:${s.id}`,children:s.display_name},s.id)),K.length>0&&e.jsx(te,{}),K.map(s=>e.jsx(H,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})})]}),R?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-28 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border overflow-hidden",children:Array.from({length:7},(s,a)=>e.jsxs("div",{className:"flex flex-col items-center py-2 gap-1",children:[e.jsx("div",{className:"h-3 w-6 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-5 rounded bg-muted/50 animate-pulse motion-reduce:animate-none mt-1"})]},a))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),Array.from({length:3},(s,a)=>e.jsx("div",{className:"h-20 rounded-xl bg-muted animate-pulse motion-reduce:animate-none"},a))]})]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(s,a)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},a))})]}):m.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(mt,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:ke,children:[e.jsx(se,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[O!=null&&Se===!1&&e.jsx("div",{className:"rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/30 px-3 py-2 text-sm text-blue-700 dark:text-blue-300",children:"Ce nageur hérite des créneaux du groupe. Personnalisez depuis sa fiche."}),e.jsx("div",{className:"sm:hidden",children:e.jsx(bs,{slotsByDay:Le,slotInstancesById:_e,weekDates:z,todayStr:Me(),overridesBySlot:Ve,cancelledSlotIds:Re,onSelect:He,onPrevWeek:$,onNextWeek:I,weekNumber:S})}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",z.map((s,a)=>{const f=J(s)===Me();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:Ie[a]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${f?"text-primary font-bold":"text-muted-foreground/60"}`,children:le(s)})]},a)}),e.jsx("div",{className:"relative",style:{height:Je},children:Xe.map(s=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(s-de)*xe},children:[s,"h"]},s))}),Array.from({length:7},(s,a)=>a+1).map(s=>{const a=Le.get(s)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:Je},children:[Xe.map(f=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(f-de)*xe}},f)),a.map(f=>e.jsx(gs,{slot:f,instance:_e.get(f.id),hasOverrides:(Ve.get(f.id)??[]).length>0,cancelled:Re.has(f.id),onSelect:He},f.id))]},s)})]})})]}),e.jsx(rs,{instance:_,open:N,onOpenChange:v,onCreateNew:St,onEditSession:wt,onPickTemplate:_t,onEditSlot:Nt,onManageOverride:yt}),e.jsx(hs,{open:b,onOpenChange:c,slot:y,groups:r,coaches:Mt}),e.jsx(ps,{open:C,onOpenChange:M,slot:i}),e.jsx(ds,{open:F,onOpenChange:g,onSelect:(s,a)=>Ct(s)})]})};export{ar as default};
