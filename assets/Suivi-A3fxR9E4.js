const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D-sSumw0.js","assets/vendor-query-DyA9aSKS.js","assets/vendor-react-BzrpNAyj.js","assets/vendor-charts-BrQ8X25f.js","assets/vendor-supabase-DFPLkPj_.js","assets/vendor-motion-lao-Njgm.js","assets/index-1RPOWF0g.css"])))=>i.map(i=>d[i]);
import{c as ke,u as _,r as x,d as R,j as e,f as Te}from"./vendor-query-DyA9aSKS.js";import{d as De,B as $,L as A,v as We,_ as Ge,u as H,P as Z,w as Me,I as Qe,s as He,f as ee}from"./index-D-sSumw0.js";import{a as j}from"./api-v-rWGS79.js";import{B as k}from"./badge-q2iM4RMT.js";import{C as Fe,a as qe,b as Ee}from"./collapsible-BuD6HUI-.js";import{T as Ue,a as Je,b as W,c as G}from"./tabs-CRh_yGFv.js";import{M as Oe,S as Xe,w as Ae,a as Pe,G as Ye,C as $e,b as Ze}from"./weekTypeColor-BxgPjd12.js";import{T as L}from"./textarea-C-P82Pf1.js";import{O as U,a as de,F as es,e as ss,f as ts,p as me}from"./ObjectiveCard-BdVCVCTL.js";import{A as ne}from"./arrow-left-BDM8SJRv.js";import{C as as}from"./chevron-up-Dnb3Zm8K.js";import{C as rs}from"./chevron-down-BwNiMzOJ.js";import{C as Q}from"./clock-3XSGuxsj.js";import{C as ue}from"./circle-check-aGrKIqz9.js";import{C as Be}from"./chevron-right-nTHJksD-.js";import{T as Ie}from"./trophy-1d7AwNsx.js";import{T as ns,a as se}from"./toggle-group-CL0CUQEI.js";import{S as xe,a as pe,b as he,c as ge,d as te}from"./select-CeYPqIMw.js";import{S as is,a as cs,b as ls,c as os,d as ds}from"./sheet-DzexlSPX.js";import{A as ms,a as us,b as xs,c as ps,d as hs,e as gs,f as js,g as fs}from"./alert-dialog-5P-XktC0.js";import{S as bs}from"./sparkles-Crs9LIsr.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./swim-Bs_jBCv9.js";import"./index-yOFjNWFg.js";import"./index-BVSEINNm.js";import"./chart-column-CHR225yA.js";import"./index-DeSprgNO.js";import"./index-DCX2sNhR.js";import"./index-DRMXbYLa.js";function z(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function je(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function ys(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Ns(s){const t=new Date;t.setHours(0,0,0,0);const i=new Date(s+"T00:00:00"),c=new Date(s+"T00:00:00");return c.setDate(c.getDate()+6),t>=i&&t<=c}function fe(s,t){const i=[],c=new Date(s+"T00:00:00"),p=new Date(t+"T00:00:00"),o=new Date(c),m=o.getDay(),g=m===0?1:m===1?0:8-m;for(o.setDate(o.getDate()+g);o<=p;)i.push(o.toISOString().split("T")[0]),o.setDate(o.getDate()+7);return i}function be(s,t){const i=new Date(s+"T00:00:00"),c=new Date(t+"T00:00:00");return Math.round((c.getTime()-i.getTime())/(1e3*60*60*24))}function vs({onBack:s,embedded:t=!1}){const{toast:i}=De(),c=ke(),{data:p}=_({queryKey:["auth-user"],queryFn:async()=>{const{data:u}=await(await Ge(async()=>{const{supabase:f}=await import("./index-D-sSumw0.js").then(T=>T.ah);return{supabase:f}},__vite__mapDeps([0,1,2,3,4,5,6]))).supabase.auth.getUser();return u.user}}),o=p?.app_metadata?.app_user_id,{data:m=[],isLoading:g}=_({queryKey:["my-interviews"],queryFn:()=>j.getMyInterviews()}),{data:S=[]}=_({queryKey:["athlete-objectives"],queryFn:()=>j.getAthleteObjectives()}),{data:D}=_({queryKey:["my-profile-iuf"],queryFn:()=>j.getProfile({userId:o}),enabled:!!o}),C=D?.ffn_iuf??null,N=x.useMemo(()=>{const u=new Date;return u.setDate(u.getDate()-360),u.toISOString().slice(0,10)},[]),{data:v=[]}=_({queryKey:["swimmer-performances-recent",C],queryFn:()=>j.getSwimmerPerformances({iuf:C,fromDate:N}),enabled:!!C}),l=x.useCallback(()=>c.invalidateQueries({queryKey:["my-interviews"]}),[c]),a=R({mutationFn:({id:u,input:f})=>j.updateInterviewAthleteSections(u,f),onSuccess:()=>{i({title:"Sauvegardé"}),l()},onError:u=>i({title:"Erreur",description:u.message,variant:"destructive"})}),n=R({mutationFn:u=>j.submitInterviewToCoach(u),onSuccess:()=>{i({title:"Envoyé au coach"}),l()},onError:u=>i({title:"Erreur",description:u.message,variant:"destructive"})}),h=R({mutationFn:u=>j.signInterview(u),onSuccess:()=>{i({title:"Entretien signé"}),l()},onError:u=>i({title:"Erreur",description:u.message,variant:"destructive"})});return e.jsxs("div",{className:"space-y-6 pb-24",children:[!t&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs($,{variant:"ghost",size:"sm",className:"-ml-2",onClick:s,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:"Mes entretiens"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Entretiens individuels avec le coach"})]}),g&&e.jsx("div",{className:"space-y-3",children:[1,2,3].map(u=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-40 rounded bg-muted"})},u))}),!g&&m.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Oe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun entretien en cours. Votre coach initiera les entretiens."})]}),!g&&m.map(u=>e.jsx(ws,{interview:u,objectives:S,performances:v,appUserId:o??null,onSave:(f,T)=>a.mutate({id:f,input:T}),onSubmit:f=>{window.confirm("Envoyer votre préparation au coach ? Vous ne pourrez plus la modifier.")&&n.mutate(f)},onSign:f=>{window.confirm("Confirmer la signature de cet entretien ?")&&h.mutate(f)},isSaving:a.isPending,isSubmitting:n.isPending,isSigning:h.isPending},u.id))]})}function ws({interview:s,objectives:t,performances:i,appUserId:c,onSave:p,onSubmit:o,onSign:m,isSaving:g,isSubmitting:S,isSigning:D}){const C=s.status==="draft_athlete",N=s.status==="draft_coach",v=s.status==="sent",l=s.status==="signed",[a,n]=x.useState(!1),[h,u]=x.useState(s.athlete_successes??""),[f,T]=x.useState(s.athlete_difficulties??""),[M,E]=x.useState(s.athlete_goals??""),[F,P]=x.useState(s.athlete_commitments??""),[w,O]=x.useState(s.athlete_commitment_review??""),{data:d}=_({queryKey:["my-previous-interview",s.date,s.id],queryFn:()=>c?j.getPreviousInterview(c,s.date,s.id):null,enabled:(C||v||l||N)&&!!c}),q=x.useRef(!1),b=x.useCallback(()=>{q.current||!C||(q.current=!0,p(s.id,{athlete_successes:h||null,athlete_difficulties:f||null,athlete_goals:M||null,athlete_commitments:F||null,athlete_commitment_review:w||null}),setTimeout(()=>{q.current=!1},500))},[s.id,h,f,M,F,w,p,C]),B=C?e.jsxs(k,{className:"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400 border-amber-300 dark:border-amber-700",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"À préparer"]}):N?e.jsxs(k,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400 border-blue-300 dark:border-blue-700",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"En préparation"]}):v?e.jsxs(k,{className:"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400 border-emerald-300 dark:border-emerald-700",children:[e.jsx(ue,{className:"h-3 w-3 mr-1"}),"À signer"]}):e.jsx(k,{variant:"secondary",children:"Signé"}),I=C?"border-amber-300 dark:border-amber-700 border-l-4":N?"border-blue-300 dark:border-blue-700 border-l-4":v?"border-emerald-300 dark:border-emerald-700 border-l-4":"";return e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${I}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>n(y=>!y),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:z(s.date)}),B,l&&s.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",z(s.signed_at.slice(0,10))]})]}),a?e.jsx(as,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(rs,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),a&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[C&&e.jsxs(e.Fragment,{children:[d&&(d.athlete_commitments||d.coach_actions)&&e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3 space-y-2",children:[e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Bilan des engagements précédents"}),d.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2 space-y-0.5",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mes engagements"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:d.athlete_commitments})]}),d.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2 space-y-0.5",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions du coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:d.coach_actions})]}),e.jsxs("div",{className:"space-y-1 pt-1",children:[e.jsx(A,{htmlFor:`commitment-review-${s.id}`,className:"text-xs",children:"Comment avez-vous tenu vos engagements ?"}),e.jsx(L,{id:`commitment-review-${s.id}`,placeholder:"Mon bilan sur les engagements pris...",value:w,onChange:y=>O(y.target.value),onBlur:b,rows:3})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:`successes-${s.id}`,children:"Mes réussites"}),e.jsx(L,{id:`successes-${s.id}`,placeholder:"Ce dont je suis fier/fière cette saison...",value:h,onChange:y=>u(y.target.value),onBlur:b,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:`difficulties-${s.id}`,children:"Mes difficultés"}),e.jsx(L,{id:`difficulties-${s.id}`,placeholder:"Les points que je souhaite améliorer...",value:f,onChange:y=>T(y.target.value),onBlur:b,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Mes objectifs"}),t.length>0&&e.jsx("div",{className:"space-y-1.5",children:t.map(y=>e.jsx(U,{objective:y,performances:i,compact:!0},y.id))}),e.jsx(L,{id:`goals-${s.id}`,placeholder:"Objectifs supplémentaires ou commentaires...",value:M,onChange:y=>E(y.target.value),onBlur:b,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:`commitments-${s.id}`,children:"Mes engagements"}),e.jsx(L,{id:`commitments-${s.id}`,placeholder:"Ce que je m'engage à faire...",value:F,onChange:y=>P(y.target.value),onBlur:b,rows:3})]}),g&&e.jsx("p",{className:"text-xs text-muted-foreground animate-pulse",children:"Sauvegarde..."}),e.jsxs($,{className:"w-full gap-2",onClick:()=>o(s.id),disabled:S,children:[e.jsx(Xe,{className:"h-4 w-4"}),S?"Envoi...":"Envoyer au coach"]})]}),N&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-xl border border-dashed border-blue-300 dark:border-blue-700 bg-blue-50/50 dark:bg-blue-950/20 p-6 text-center space-y-2",children:[e.jsx(Q,{className:"h-8 w-8 mx-auto text-blue-500"}),e.jsx("p",{className:"text-sm font-medium",children:"Entretien envoyé au coach"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Votre coach prépare l'entretien. Vous recevrez le compte-rendu complet après l'entretien en présentiel."}),s.submitted_at&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Envoyé le ",z(s.submitted_at.slice(0,10))]})]}),d&&(d.athlete_commitments||d.coach_actions)&&e.jsx(ye,{prevInterview:d,commitmentReview:s.athlete_commitment_review}),c&&e.jsxs(e.Fragment,{children:[e.jsx(V,{label:"Planification"}),e.jsx(Ne,{athleteId:c,interviewDate:s.date})]})]}),(v||l)&&e.jsxs(e.Fragment,{children:[d&&(d.athlete_commitments||d.coach_actions)&&e.jsx(ye,{prevInterview:d,commitmentReview:s.athlete_commitment_review}),e.jsx(ve,{label:"Réussites",athleteText:s.athlete_successes,coachText:s.coach_comment_successes||s.coach_review}),e.jsx(ve,{label:"Difficultés",athleteText:s.athlete_difficulties,coachText:s.coach_comment_difficulties}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{label:"Objectifs"}),t.length>0&&e.jsx("div",{className:"space-y-1.5",children:t.map(y=>e.jsx(U,{objective:y,performances:i,compact:!0},y.id))}),e.jsx(ae,{text:s.athlete_goals}),e.jsx(re,{text:s.coach_comment_goals||s.coach_objectives})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx(V,{label:"Planification"}),e.jsx(Ne,{athleteId:c,interviewDate:s.date})]}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-3 space-y-2",children:[e.jsx(V,{label:"Engagements & Actions"}),e.jsx(ae,{text:s.athlete_commitments,label:"Mes engagements"}),e.jsx(re,{text:s.coach_actions,label:"Actions du coach"})]}),v&&e.jsxs($,{className:"w-full gap-2",onClick:()=>m(s.id),disabled:D,children:[e.jsx(ue,{className:"h-4 w-4"}),D?"Signature...":"Signer l'entretien"]})]})]})]})}function ye({prevInterview:s,commitmentReview:t}){const[i,c]=x.useState(!1);return e.jsxs(Fe,{open:i,onOpenChange:c,children:[e.jsx(qe,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Be,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${i?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements précédents"}),e.jsx(k,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:z(s.date)})]})}),e.jsx(Ee,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[s.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mes engagements"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.athlete_commitments})]}),s.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions du coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.coach_actions})]}),t&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mon bilan"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t})]})]})})]})}function Ne({athleteId:s,interviewDate:t}){const{data:i=[]}=_({queryKey:["competitions"],queryFn:()=>j.getCompetitions()}),{data:c=[]}=_({queryKey:["my-competition-ids",s],queryFn:()=>j.getMyCompetitionIds(s)}),p=x.useMemo(()=>{const l=new Set(c);return i.filter(n=>l.has(n.id)&&n.date>=t).sort((n,h)=>n.date.localeCompare(h.date))[0]??null},[i,c,t]),{data:o=[]}=_({queryKey:["training-cycles","athlete",s],queryFn:()=>j.getTrainingCycles({athleteId:s})}),m=x.useMemo(()=>{const l=new Set(c);return i.filter(a=>l.has(a.id)&&a.date>=t).sort((a,n)=>a.date.localeCompare(n.date))},[i,c,t]),g=x.useMemo(()=>{const l=new Map;return o.slice().sort((a,n)=>(a.end_competition_date??"").localeCompare(n.end_competition_date??"")).forEach(a=>{a.end_competition_id&&!l.has(a.end_competition_id)&&l.set(a.end_competition_id,a)}),l},[o]),S=x.useMemo(()=>{const l=new Set;return m.map(a=>g.get(a.id)??null).filter(a=>!a||l.has(a.id)?!1:(l.add(a.id),!0))},[m,g]),D=Te({queries:S.map(l=>({queryKey:["training-weeks",l.id],queryFn:()=>j.getTrainingWeeks(l.id),enabled:!!l.id}))}),C=x.useMemo(()=>{const l=new Map;return S.forEach((a,n)=>{l.set(a.id,D[n]?.data??[])}),l},[S,D]),N=x.useMemo(()=>new Date().toISOString().split("T")[0],[]),v=p?be(N,p.date):null;return p?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(Ie,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsxs("span",{className:"font-medium",children:[m.length," échéance",m.length>1?"s":""," visible",m.length>1?"s":""]}),e.jsxs(k,{variant:"secondary",className:"text-[10px]",children:["prochaine J-",v]})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Vision multi-macrocycles depuis l'entretien, jusqu'aux prochaines compétitions assignées."})]}),e.jsx("div",{className:"space-y-3",children:m.map((l,a)=>{const n=g.get(l.id)??null,h=n?.start_date??n?.start_competition_date??t,u=h>t?h:t,f=n?fe(u,l.date):[],T=n?fe(h,l.date):[],M=Math.max(T.length-f.length,0),E=be(N,l.date),F=n?C.get(n.id)??[]:[],P=new Map(F.map(w=>[w.week_start,w]));return e.jsxs("div",{className:"rounded-xl border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border bg-muted/20 px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:l.name}),a===0&&e.jsx(k,{className:"text-[10px] bg-primary/10 text-primary border-primary/20",children:"Prochaine"}),e.jsx(k,{variant:"secondary",className:"text-[10px]",children:z(l.date)}),e.jsxs(k,{variant:"outline",className:"text-[10px]",children:["J-",E]})]}),n?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:n.name}),n.start_competition_name&&e.jsxs("span",{children:["depuis ",n.start_competition_name]}),e.jsxs("span",{children:[T.length," sem."]}),M>0&&e.jsxs("span",{children:[M," déjà écoulée",M>1?"s":""]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Aucun macrocycle créé pour cette échéance."})]}),n?f.length===0?e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"Aucune semaine future à afficher sur ce macrocycle."}):e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1.5",children:f.map((w,O)=>{const d=P.get(w),q=Ns(w),b=ys(w);return e.jsxs("div",{className:`rounded-lg border bg-card px-2.5 py-2 text-xs ${q?"ring-2 ring-primary bg-primary/5":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${q?"bg-primary":d?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",M+O+1]}),e.jsxs("span",{className:"text-muted-foreground/70 whitespace-nowrap",children:[je(w)," - ",je(b)]}),d?.week_type&&e.jsx(k,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:Pe(d.week_type),color:Ae(d.week_type)},children:d.week_type})]}),d?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:d.notes})]},w)})})}):e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"La compétition reste visible pour garder la projection long terme, même sans planification détaillée."})]},l.id)})})]}):e.jsx("p",{className:"text-xs text-muted-foreground italic text-center py-2",children:"Aucune compétition assignée à venir."})}function ve({label:s,athleteText:t,coachText:i}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{label:s}),e.jsx(ae,{text:t}),e.jsx(re,{text:i})]})}function V({label:s}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s}),e.jsx("div",{className:"h-px flex-1 bg-border"})]})}function ae({text:s,label:t}){return e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2.5 space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(We,{className:"h-3 w-3 text-blue-500"}),e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-widest text-muted-foreground",children:t??"Nageur"})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseigné"})})]})}function re({text:s,label:t}){return s?.trim()?e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2.5 space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ye,{className:"h-3 w-3 text-amber-500"}),e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-widest text-muted-foreground",children:t??"Coach"})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s})]}):null}function we({onBack:s,embedded:t=!1}){const{toast:i}=De(),c=ke(),[p,o]=x.useState(!1),[m,g]=x.useState(null),[S,D]=x.useState(null),{data:C}=_({queryKey:["auth-user"],queryFn:async()=>{const{data:r}=await He.auth.getUser();return r.user}}),N=C?.id??null,{data:v=[],isLoading:l}=_({queryKey:["athlete-objectives"],queryFn:()=>j.getAthleteObjectives(),enabled:!!N,refetchInterval:3e4}),a=H(r=>r.userId),n=H(r=>r.user),{data:h}=_({queryKey:["my-profile"],queryFn:()=>j.getProfile({displayName:n,userId:a}),enabled:!!a}),u=h?.ffn_iuf??null,f=x.useMemo(()=>{const r=new Date;return r.setDate(r.getDate()-360),r.toISOString().slice(0,10)},[]),{data:T=[]}=_({queryKey:["swimmer-performances-recent",u],queryFn:()=>j.getSwimmerPerformances({iuf:u,fromDate:f}),enabled:!!u}),M=x.useMemo(()=>v.filter(r=>r.created_by!==N),[v,N]),E=x.useMemo(()=>v.filter(r=>r.created_by===N),[v,N]),[F,P]=x.useState("chrono"),[w,O]=x.useState(""),[d,q]=x.useState("25"),[b,B]=x.useState(""),[I,y]=x.useState(""),Ke=()=>{P("chrono"),O(""),q("25"),B(""),y("")},J=()=>{g(null),Ke(),o(!0)},Le=r=>{g(r);const ze=!!r.event_code,oe=!!r.text;P(ze&&oe?"both":oe?"texte":"chrono"),O(r.event_code??""),q(String(r.pool_length??25)),B(r.target_time_seconds!=null?ts(r.target_time_seconds):""),y(r.text??""),o(!0)},X=()=>c.invalidateQueries({queryKey:["athlete-objectives"]}),ie=R({mutationFn:r=>j.createObjective(r),onSuccess:()=>{i({title:"Objectif créé"}),X(),o(!1)},onError:r=>i({title:"Erreur",description:r.message,variant:"destructive"})}),ce=R({mutationFn:r=>j.updateObjective(m.id,r),onSuccess:()=>{i({title:"Objectif mis à jour"}),X(),o(!1)},onError:r=>i({title:"Erreur",description:r.message,variant:"destructive"})}),Re=R({mutationFn:r=>j.deleteObjective(r),onSuccess:()=>{i({title:"Objectif supprimé"}),X(),D(null)},onError:r=>i({title:"Erreur",description:r.message,variant:"destructive"})}),K=F==="chrono"||F==="both",Y=F==="texte"||F==="both",le=ie.isPending||ce.isPending,Ve=()=>{if(K&&!w){i({title:"Épreuve requise",variant:"destructive"});return}if(K&&b&&me(b)===null){i({title:"Format invalide",description:"Format : m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(Y&&!I.trim()){i({title:"Texte requis",variant:"destructive"});return}if(!N)return;const r={athlete_id:N,event_code:K?w:null,pool_length:K?Number(d):null,target_time_seconds:K&&b?me(b):null,text:Y?I.trim():null};m?ce.mutate(r):ie.mutate(r)};return e.jsxs("div",{className:t?"space-y-3":"space-y-6 pb-24",children:[t?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/70",children:"Objectifs"}),e.jsxs($,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:J,children:[e.jsx(Z,{className:"mr-1 h-3 w-3"}),"Ajouter"]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs($,{variant:"ghost",size:"sm",className:"-ml-2",onClick:s,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:"Mon plan"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Mes objectifs d'entraînement"})]}),e.jsxs($,{variant:"outline",size:"sm",onClick:J,children:[e.jsx(Z,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]})]}),l&&e.jsx("div",{className:"space-y-1.5",children:[1,2].map(r=>e.jsx("div",{className:"rounded-lg border p-2.5 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-3.5 w-36 rounded bg-muted"})},r))}),!l&&v.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-2",children:[e.jsx(Me,{className:"h-8 w-8 text-muted-foreground/40 mx-auto"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Aucun objectif pour le moment."}),e.jsxs($,{variant:"ghost",size:"sm",className:"text-xs h-7",onClick:J,children:[e.jsx(Z,{className:"mr-1 h-3 w-3"}),"Ajouter"]})]}),M.length>0&&e.jsxs("div",{className:"space-y-2",children:[!t&&e.jsx("h3",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Objectifs du coach"}),e.jsx(de,{children:M.map(r=>e.jsx(U,{objective:r,performances:T,showCoachBadge:!0},r.id))})]}),E.length>0&&e.jsxs("div",{className:"space-y-2",children:[!t&&e.jsx("h3",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Mes objectifs personnels"}),e.jsx(de,{children:E.map(r=>e.jsx(U,{objective:r,performances:T,onClick:()=>Le(r)},r.id))})]}),e.jsx(is,{open:p,onOpenChange:o,children:e.jsxs(cs,{side:"bottom",className:"max-h-[85vh] overflow-y-auto",children:[e.jsxs(ls,{children:[e.jsx(os,{children:m?"Modifier l'objectif":"Nouvel objectif"}),e.jsx(ds,{children:m?"Modifiez votre objectif personnel.":"Ajoutez un objectif personnel."})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Type d'objectif"}),e.jsxs(ns,{type:"single",variant:"outline",value:F,onValueChange:r=>{r&&P(r)},className:"justify-start",children:[e.jsx(se,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(se,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(se,{value:"both",className:"text-xs",children:"Les deux"})]})]}),K&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Épreuve *"}),e.jsxs(xe,{value:w,onValueChange:O,children:[e.jsx(pe,{children:e.jsx(he,{placeholder:"Choisir une épreuve"})}),e.jsx(ge,{children:es.map(r=>e.jsx(te,{value:r,children:ss(r)},r))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Bassin"}),e.jsxs(xe,{value:d,onValueChange:q,children:[e.jsx(pe,{children:e.jsx(he,{})}),e.jsxs(ge,{children:[e.jsx(te,{value:"25",children:"25m"}),e.jsx(te,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(Qe,{placeholder:"Ex : 1:05:30",value:b,onChange:r=>B(r.target.value)})]})]}),Y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Objectif texte *"}),e.jsx(L,{placeholder:"Ex : Améliorer la coulée de dos",value:I,onChange:r=>y(r.target.value),rows:3})]}),e.jsx($,{className:"w-full",onClick:Ve,disabled:le,children:le?"Enregistrement...":m?"Enregistrer":"Créer"})]})]})}),e.jsx(ms,{open:!!S,onOpenChange:r=>{r||D(null)},children:e.jsxs(us,{children:[e.jsxs(xs,{children:[e.jsx(ps,{children:"Supprimer l'objectif"}),e.jsx(hs,{children:"Cette action est irréversible. L'objectif sera supprimé définitivement."})]}),e.jsxs(gs,{children:[e.jsx(js,{children:"Annuler"}),e.jsx(fs,{onClick:()=>{S&&Re.mutate(S.id)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})}function _s(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function _e(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Cs(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Ss(s){const t=new Date;t.setHours(0,0,0,0);const i=new Date(s+"T00:00:00"),c=new Date(s+"T00:00:00");return c.setDate(c.getDate()+6),t>=i&&t<=c}function Ce(s,t){const i=[],c=new Date(s+"T00:00:00"),p=new Date(t+"T00:00:00"),o=new Date(c),m=o.getDay(),g=m===0?1:m===1?0:8-m;for(o.setDate(o.getDate()+g);o<=p;)i.push(o.toISOString().split("T")[0]),o.setDate(o.getDate()+7);return i}function Se(s,t){const i=new Date(s+"T00:00:00"),c=new Date(t+"T00:00:00");return Math.round((c.getTime()-i.getTime())/(1e3*60*60*24))}function ks({athleteId:s}){const t=x.useMemo(()=>new Date().toISOString().split("T")[0],[]),[i,c]=x.useState([]),{data:p=[]}=_({queryKey:["competitions"],queryFn:()=>j.getCompetitions()}),{data:o=[]}=_({queryKey:["my-competition-ids",s],queryFn:()=>j.getMyCompetitionIds(s)}),{data:m=[]}=_({queryKey:["training-cycles","athlete",s],queryFn:()=>j.getTrainingCycles({athleteId:s})}),g=x.useMemo(()=>{const a=new Set(o);return p.filter(n=>a.has(n.id)&&n.date>=t).sort((n,h)=>n.date.localeCompare(h.date))},[o,p,t]),S=x.useMemo(()=>{const a=new Map;return m.slice().sort((n,h)=>(n.end_competition_date??"").localeCompare(h.end_competition_date??"")).forEach(n=>{n.end_competition_id&&!a.has(n.end_competition_id)&&a.set(n.end_competition_id,n)}),a},[m]),D=x.useMemo(()=>{const a=new Set;return g.map(n=>S.get(n.id)??null).filter(n=>!n||a.has(n.id)?!1:(a.add(n.id),!0))},[S,g]),C=Te({queries:D.map(a=>({queryKey:["training-weeks",a.id],queryFn:()=>j.getTrainingWeeks(a.id),enabled:!!a.id}))}),N=x.useMemo(()=>{const a=new Map;return D.forEach((n,h)=>{a.set(n.id,C[h]?.data??[])}),a},[D,C]),v=g[0]??null,l=a=>{c(n=>n.includes(a)?n.filter(h=>h!==a):[...n,a])};return g.length===0?e.jsxs("div",{className:"rounded-3xl border border-dashed bg-card/70 px-4 py-8 text-center",children:[e.jsx($e,{className:"mx-auto h-10 w-10 text-muted-foreground/60"}),e.jsx("p",{className:"mt-3 text-sm font-medium",children:"Aucune échéance à venir."}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Ton plan apparaîtra ici."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-3xl border bg-gradient-to-br from-primary/[0.08] via-background to-amber-500/[0.08] p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(bs,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-semibold",children:[g.length," échéance",g.length>1?"s":""]}),v&&e.jsxs(k,{variant:"secondary",className:"text-[10px] px-2 py-0.5",children:["cap J-",Se(t,v.date)]})]}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Vue de tes prochains cycles."})]}),e.jsx("div",{className:"space-y-3",children:g.map((a,n)=>{const h=S.get(a.id)??null,u=h?.start_date??h?.start_competition_date??t,f=u>t?u:t,T=h?Ce(f,a.date):[],M=h?Ce(u,a.date):[],E=Math.max(M.length-T.length,0),F=h?N.get(h.id)??[]:[],P=new Map(F.map(d=>[d.week_start,d])),w=Se(t,a.date),O=i.includes(a.id);return e.jsx(Fe,{open:O,onOpenChange:()=>l(a.id),children:e.jsxs("section",{className:"overflow-hidden rounded-3xl border bg-card shadow-sm",children:[e.jsx(qe,{asChild:!0,children:e.jsx("button",{type:"button",className:"w-full border-b border-border bg-muted/20 px-4 py-3 text-left transition-colors hover:bg-muted/30",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Be,{className:`mt-0.5 h-4 w-4 shrink-0 text-muted-foreground transition-transform ${O?"rotate-90":""}`}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:a.name}),n===0&&e.jsx(k,{className:"border-primary/20 bg-primary/10 text-[10px] text-primary",children:"Priorité"}),e.jsx(k,{variant:"secondary",className:"text-[10px]",children:_s(a.date)}),e.jsxs(k,{variant:"outline",className:"text-[10px]",children:["J-",w]})]}),h?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:h.name}),e.jsxs("span",{children:[M.length," sem."]}),E>0&&e.jsxs("span",{children:[E," sem. passée",E>1?"s":""]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Pas de cycle détaillé."})]})]})})}),e.jsx(Ee,{children:h?T.length===0?e.jsx("div",{className:"px-4 py-4 text-xs text-muted-foreground italic",children:"Pas de semaine à venir."}):e.jsx("div",{className:"px-4 py-4",children:e.jsx("div",{className:"relative ml-2 space-y-2 border-l-2 border-border pl-4",children:T.map((d,q)=>{const b=P.get(d),B=Ss(d),I=Cs(d);return e.jsxs("div",{className:`rounded-2xl border bg-card px-3 py-2 text-xs ${B?"ring-2 ring-primary/40 bg-primary/[0.04]":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${B?"bg-primary":b?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"whitespace-nowrap text-muted-foreground",children:["Sem. ",E+q+1]}),e.jsxs("span",{className:"whitespace-nowrap text-muted-foreground/70",children:[_e(d)," - ",_e(I)]}),b?.week_type&&e.jsx(k,{className:"ml-auto border-0 px-1.5 py-0 text-[10px]",style:{backgroundColor:Pe(b.week_type),color:Ae(b.week_type)},children:b.week_type})]}),b?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:b.notes})]},d)})})}):e.jsx("div",{className:"px-4 py-4 text-xs text-muted-foreground italic",children:"L'échéance reste affichée."})})]})},a.id)})})]})}function Ts({athleteId:s,athleteName:t,groupLabel:i,onBack:c,standalone:p,defaultTab:o}){return e.jsxs("div",{className:`mx-auto max-w-4xl pb-24 ${p?"space-y-3":"space-y-4"}`,children:[e.jsxs("div",{className:`rounded-[1.75rem] border bg-gradient-to-br from-primary/[0.12] via-background to-amber-500/[0.08] shadow-sm ${p?"p-3":"p-4"}`,children:[!p&&c&&e.jsxs($,{variant:"ghost",size:"sm",className:"-ml-2 mb-2",onClick:c,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`flex shrink-0 items-center justify-center rounded-2xl bg-primary/12 text-primary ${p?"h-9 w-9":"h-11 w-11"}`,children:e.jsx(Ie,{className:p?"h-4 w-4":"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h1",{className:`font-display font-semibold uppercase italic text-foreground ${p?"text-lg":"text-xl"}`,children:"Mon suivi"}),i&&e.jsx(k,{variant:"secondary",className:"text-[10px]",children:i})]}),!p&&e.jsxs("p",{className:"mt-1 text-sm text-muted-foreground",children:[t,": ton plan d'action, tes entretiens et tes échéances au même endroit."]})]})]})]}),p&&e.jsx(we,{embedded:!0}),e.jsxs(Ue,{defaultValue:o||(p?"ressentis":"objectifs"),className:p?"space-y-3":"space-y-4",children:[e.jsxs(Je,{className:`grid h-auto w-full gap-2 rounded-2xl bg-transparent p-0 ${p?"grid-cols-3":"grid-cols-2 sm:grid-cols-4"}`,children:[!p&&e.jsxs(W,{value:"objectifs",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Me,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Plan d'action"}),e.jsx("span",{className:"hidden sm:inline",children:"Plan d'action"})]}),e.jsxs(W,{value:"ressentis",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Q,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Ressentis"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(W,{value:"entretiens",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Oe,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Entretiens"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]}),e.jsxs(W,{value:"planification",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx($e,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{children:"Planif."})]})]}),!p&&e.jsx(G,{value:"objectifs",className:"mt-0",children:e.jsx(we,{embedded:!0})}),e.jsx(G,{value:"ressentis",className:"mt-0",children:e.jsx(Ze,{athleteId:s,athleteName:t,showProgressAction:!1})}),e.jsx(G,{value:"entretiens",className:"mt-0",children:e.jsx(vs,{embedded:!0})}),e.jsx(G,{value:"planification",className:"mt-0",children:e.jsx(ks,{athleteId:s})})]})]})}function Ds(){return typeof window>"u"?void 0:window.location.hash.match(/[?&]tab=([^&]+)/)?.[1]||void 0}function lt(){const s=H(m=>m.user),t=H(m=>m.userId),{data:i,isLoading:c}=_({queryKey:["profile",s,t],queryFn:()=>j.getProfile({displayName:s,userId:t}),enabled:!!s}),{data:p=[]}=_({queryKey:["profile-groups"],queryFn:()=>j.getGroups(),enabled:!!s}),o=p.find(m=>m.id===i?.group_id)?.name||i?.group_label||null;return c?e.jsxs("div",{className:"mx-auto max-w-4xl space-y-4 p-4",children:[e.jsx(ee,{className:"h-28 rounded-3xl"}),e.jsx(ee,{className:"h-12 rounded-2xl"}),e.jsx(ee,{className:"h-64 rounded-2xl"})]}):e.jsx(Ts,{athleteId:t??0,athleteName:i?.display_name||s||"Nageur",groupLabel:o,standalone:!0,defaultTab:Ds()})}export{lt as default};
