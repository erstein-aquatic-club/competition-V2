import{s as i,u as de}from"./index-BOaNBvLi.js";import{b as v,c as j,n as B,d as q,e as O,f as M,h as c,l as h,S as m,j as N,k as I,m as le,o as Y,p as J,q as K,v as _e,i as $,r as Q,t as me,u as Z,w as W,a as fe,g as ge,x as pe,y as we,z as he,A as ye,C as Se}from"./swim-C2h4iBds.js";const z=e=>({id:q(e.id),numero_exercice:v(e.numero_exercice??e.numero),nom_exercice:e.nom_exercice??e.name??"",description:e.description??null,illustration_gif:e.illustration_gif??null,exercise_type:B(e.exercise_type??e.type??(e.is_warmup?"warmup":"strength")),warmup_reps:v(e.warmup_reps),warmup_duration:v(e.warmup_duration),Nb_series_endurance:v(e.Nb_series_endurance),Nb_reps_endurance:v(e.Nb_reps_endurance),pct_1rm_endurance:j(e.pct_1rm_endurance),recup_endurance:v(e.recup_endurance),recup_exercices_endurance:v(e.recup_exercices_endurance),Nb_series_hypertrophie:v(e.Nb_series_hypertrophie),Nb_reps_hypertrophie:v(e.Nb_reps_hypertrophie),pct_1rm_hypertrophie:j(e.pct_1rm_hypertrophie),recup_hypertrophie:v(e.recup_hypertrophie),recup_exercices_hypertrophie:v(e.recup_exercices_hypertrophie),Nb_series_force:v(e.Nb_series_force),Nb_reps_force:v(e.Nb_reps_force),pct_1rm_force:j(e.pct_1rm_force),recup_force:v(e.recup_force),recup_exercices_force:v(e.recup_exercices_force)}),Ee=e=>{const t={athlete_name:e.athlete_name,session_date:e.date,time_slot:e.slot,distance:e.distance,duration:e.duration,rpe:M(e.effort),performance:M(e.performance??e.feeling),engagement:M(e.engagement??e.feeling),fatigue:M(e.feeling),comments:e.comments};return e.athlete_id!==null&&e.athlete_id!==void 0&&String(e.athlete_id)!==""&&(t.athlete_id=e.athlete_id),e.stroke_distances&&(t.stroke_distances=e.stroke_distances),t},be=e=>{if(!e)return null;const t=String(e.athlete_name||"").trim(),r=String(e.session_date||e.date||"").trim();if(!t||!r)return null;const s=O(v(e.rpe??e.effort)),n=O(v(e.performance??e.feeling)),a=O(v(e.engagement??e.feeling)),o=O(v(e.fatigue??e.feeling)),u=s??3,d=O(v(e.performance??e.engagement??e.fatigue??e.feeling))??3;return{id:q(e.id,Date.now()),athlete_id:e.athlete_id?q(e.athlete_id):void 0,athlete_name:t,date:r,slot:String(e.time_slot||e.slot||""),effort:u,feeling:d,rpe:s,performance:n,engagement:a,fatigue:o,distance:q(e.distance,0),duration:q(e.duration,0),comments:e.comments||"",stroke_distances:e.stroke_distances??null,created_at:e.created_at||e.updated_at||new Date().toISOString()}};async function ve(e){if(!c())return null;let t=i.from("user_profiles").select("*");e.userId?t=t.eq("user_id",e.userId):e.displayName&&(t=t.eq("display_name",e.displayName));const{data:r,error:s}=await t.maybeSingle();if(s)throw new Error(s.message);return r?{id:r.user_id??null,display_name:r.display_name??null,email:r.email??null,birthdate:r.birthdate??null,group_id:v(r.group_id)??null,group_label:r.group_label??null,objectives:r.objectives??null,bio:r.bio??null,avatar_url:r.avatar_url??null,ffn_iuf:r.ffn_iuf??null,phone:r.phone??null,neurotype_result:r.neurotype_result??null}:null}async function Ie(e){if(!c())return{status:"skipped"};const t=e.userId;if(!t)return{status:"skipped"};const r=e.profile.ffn_iuf?.trim()||null;if(r){const{data:n,error:a}=await i.from("club_record_swimmers").select("id").eq("iuf",r).eq("source_type","manual");if(a)throw new Error(a.message);if(n&&n.length>0){const o=n.map(d=>d.id),{error:u}=await i.from("club_record_swimmers").delete().in("id",o);if(u)throw new Error(u.message)}}const{error:s}=await i.from("user_profiles").upsert({user_id:t,...e.profile},{onConflict:"user_id"});if(s)throw new Error(s.message);if(e.profile.display_name){const{error:n}=await i.from("users").update({display_name:e.profile.display_name}).eq("id",t);if(n)throw new Error(n.message)}return{status:"updated"}}async function Te(){if(!c()){const d=new Map,l=(w,b)=>{const T=String(w??"").trim();if(!T)return;const x=b!=null?v(b):null,C=x!==null?`id:${x}`:`name:${T.toLowerCase()}`;d.has(C)||d.set(C,{id:x,display_name:T})};return(h(m.SESSIONS)??[]).forEach(w=>l(w.athlete_name,w.athlete_id)),(h(m.STRENGTH_RUNS)??[]).forEach(w=>l(w.athlete_name,w.athlete_id)),(h(m.ASSIGNMENTS)??[]).forEach(w=>l(w.target_athlete,w.target_user_id)),Array.from(d.values()).sort((w,b)=>w.display_name.localeCompare(b.display_name,"fr"))}const{data:e,error:t}=await i.from("groups").select("id, name");if(t)throw new Error(t.message);const{data:r}=await i.from("user_profiles").select("user_id, ffn_iuf, avatar_url"),s=new Map((r??[]).map(d=>[d.user_id,d]));if(!e?.length){const{data:d,error:l}=await i.from("users").select("id, display_name, email").eq("role","athlete").eq("is_active",!0);if(l)throw new Error(l.message);return(d??[]).map(_=>({id:_.id,display_name:_.display_name,email:_.email??null,ffn_iuf:s.get(_.id)?.ffn_iuf??null,avatar_url:s.get(_.id)?.avatar_url??null})).filter(_=>_.display_name).sort((_,y)=>_.display_name.localeCompare(y.display_name,"fr"))}const{data:n,error:a}=await i.from("group_members").select("user_id, group_id, users!inner(display_name, role, email), groups!inner(is_temporary)").eq("users.role","athlete").eq("groups.is_temporary",!1);if(a)throw new Error(a.message);const o=new Map(e.map(d=>[d.id,d.name])),u=new Map;return(n??[]).forEach(d=>{const l=d.user_id;u.has(l)||u.set(l,{id:l,display_name:d.users?.display_name??"",email:d.users?.email??null,group_id:d.group_id??null,group_label:o.get(d.group_id)??null,ffn_iuf:s.get(l)?.ffn_iuf??null,avatar_url:s.get(l)?.avatar_url??null})}),Array.from(u.values()).filter(d=>d.display_name).sort((d,l)=>d.display_name.localeCompare(l.display_name,"fr"))}async function qe(){if(!c())return[];const{data:e,error:t}=await i.from("groups").select("id, name, description, is_temporary, is_active, parent_group_id");if(t)throw new Error(t.message);return(e??[]).filter(r=>r.is_temporary?r.is_active===!0:!0).map(r=>({id:q(r.id,0),name:String(r.name??`Groupe ${r.id??""}`).trim(),member_count:null,is_temporary:r.is_temporary??!1,is_active:r.is_active??!0,parent_group_id:r.parent_group_id??null})).filter(r=>r.id>0&&r.name).sort((r,s)=>r.is_temporary&&!s.is_temporary?-1:!r.is_temporary&&s.is_temporary?1:r.name.localeCompare(s.name,"fr"))}async function Ne(e){if(!c())return[];const t=e?.days??30,{data:r,error:s}=await i.rpc("get_upcoming_birthdays",{p_days:t});if(s)throw new Error(s.message);return Array.isArray(r)?r:[]}async function xe(e){if(!c())return[];let t=i.from("users").select("id, display_name, role, email, is_active");e?.role&&(t=t.eq("role",e.role)),e?.includeInactive||(t=t.eq("is_active",!0));const{data:r,error:s}=await t.order("display_name");if(s)throw new Error(s.message);return(r??[]).map(n=>({id:n.id,display_name:n.display_name??"",role:n.role??"",email:n.email??null,is_active:n.is_active??null,group_label:null}))}async function Ce(e){if(!c())return{status:"skipped",user:null,initialPassword:null};const{data:t,error:r}=await i.functions.invoke("admin-user",{body:{action:"create_coach",display_name:e.display_name,email:e.email,password:e.password}});if(r)throw new Error(r.message);return{status:"created",user:t?.user??null,initialPassword:t?.initial_password??null}}async function Re(e){if(!c())return{status:"skipped"};const{error:t}=await i.functions.invoke("admin-user",{body:{action:"update_role",user_id:e.userId,role:e.role}});if(t)throw new Error(t.message);return{status:"updated"}}async function Ae(e){if(!c())return{status:"skipped"};const{error:t}=await i.functions.invoke("admin-user",{body:{action:"disable_user",user_id:e.userId}});if(t)throw new Error(t.message);return{status:"disabled"}}async function ke(){if(!c())return[];const{data:e,error:t}=await i.from("user_profiles").select("user_id, display_name, email, users!user_profiles_user_id_fkey(created_at)").eq("is_approved",!1);if(t)throw new Error(t.message);return(e??[]).map(r=>({user_id:r.user_id,display_name:r.display_name,email:r.email,created_at:r.users?.created_at??new Date().toISOString()}))}async function Oe(e){if(!c())return;const{error:t}=await i.from("user_profiles").update({is_approved:!0,approved_at:new Date().toISOString()}).eq("user_id",e);if(t)throw new Error(t.message)}async function De(e){if(!c())return;const{error:t}=await i.from("users").delete().eq("id",e);if(t)throw new Error(t.message)}async function Me(e){if(!c())return{status:"skipped"};const{data:{user:t}}=await i.auth.getUser();if(!e.userId||e.userId===t?.user_metadata?.app_user_id){const{error:s}=await i.auth.updateUser({password:e.password});if(s)throw new Error(s.message);return{status:"updated"}}const{error:r}=await i.functions.invoke("admin-user",{body:{action:"update_password",user_id:e.userId,password:e.password}});if(r)throw new Error(r.message);return{status:"updated"}}async function Ue(e){if(!c())throw new Error("Supabase non disponible");const t=`${e.userId}.${e.extension}`,{error:r}=await i.storage.from("avatars").upload(t,e.blob,{contentType:e.mimeType,upsert:!0});if(r)throw new Error(r.message);const{data:s}=i.storage.from("avatars").getPublicUrl(t),n=`${s.publicUrl}?t=${Date.now()}`,{error:a}=await i.from("user_profiles").update({avatar_url:n}).eq("user_id",e.userId);if(a)throw new Error(a.message);return n}async function Ge(e){if(!c())return;const{error:t}=await i.storage.from("avatars").remove([`${e}.webp`,`${e}.jpg`]);if(t)throw new Error(t.message);const{error:r}=await i.from("user_profiles").update({avatar_url:null}).eq("user_id",e);if(r)throw new Error(r.message)}async function Fe(e=30){if(!c())return[];const t=new Date;t.setDate(t.getDate()-e);const r=t.toISOString().slice(0,10),{data:s,error:n}=await i.from("dim_sessions").select("athlete_id, athlete_name, session_date, rpe, performance, engagement, fatigue").gte("session_date",r).order("session_date",{ascending:!1});if(n)throw new Error(n.message);return(s??[]).map(a=>({athlete_id:a.athlete_id?q(a.athlete_id):null,athlete_name:String(a.athlete_name??""),session_date:String(a.session_date??""),effort:v(a.rpe),performance:v(a.performance),engagement:v(a.engagement),fatigue:v(a.fatigue)}))}const ee=["Piscine","Compétition"];async function Pe(e){if(c()){let r=i.from("timesheet_shifts").select("*").order("shift_date",{ascending:!1});e?.coachId&&(r=r.eq("coach_id",e.coachId)),e?.from&&(r=r.gte("shift_date",e.from)),e?.to&&(r=r.lte("shift_date",e.to));const{data:s,error:n}=await r;if(n)throw new Error(n.message);const a=s??[];if(a.length===0)return a;const o=a.map(l=>l.id),{data:u}=await i.from("timesheet_shift_groups").select("shift_id, group_name").in("shift_id",o),d=new Map;for(const l of u??[]){const _=d.get(l.shift_id)??[];_.push(l.group_name),d.set(l.shift_id,_)}return a.map(l=>({...l,group_names:d.get(l.id)??[]}))}return await N(200),(h(m.TIMESHEET_SHIFTS)||[]).filter(r=>!(e?.coachId&&r.coach_id!==e.coachId||e?.from&&r.shift_date<e.from||e?.to&&r.shift_date>e.to)).sort((r,s)=>r.shift_date!==s.shift_date?r.shift_date<s.shift_date?1:-1:r.start_time<s.start_time?1:-1)}async function He(){if(c()){const{data:s,error:n}=await i.from("timesheet_locations").select("*").order("name");if(n)throw new Error(n.message);return s??[]}await N(120);const e=h(m.TIMESHEET_LOCATIONS);if(Array.isArray(e)&&e.length)return e;const t=new Date().toISOString(),r=ee.map((s,n)=>({id:n+1,name:s,created_at:t,updated_at:t}));return I(m.TIMESHEET_LOCATIONS,r),r}async function Le(e){if(c()){const{error:d}=await i.from("timesheet_locations").insert({name:e.name.trim()});if(d)throw new Error(d.message);return{status:"created"}}await N(120);const t=e.name.trim();if(!t)throw new Error("Missing location name");const r=h(m.TIMESHEET_LOCATIONS),s=new Date().toISOString(),n=Array.isArray(r)&&r.length?r:ee.map((d,l)=>({id:l+1,name:d,created_at:s,updated_at:s}));if(n.some(d=>d.name.toLowerCase()===t.toLowerCase()))return{status:"exists"};const o=new Date().toISOString(),u={id:Date.now(),name:t,created_at:o,updated_at:o};return I(m.TIMESHEET_LOCATIONS,[...n,u]),{status:"created"}}async function je(e){if(c()){const{error:s}=await i.from("timesheet_locations").delete().eq("id",e.id);if(s)throw new Error(s.message);return{status:"deleted"}}await N(120);const r=(h(m.TIMESHEET_LOCATIONS)||[]).filter(s=>s.id!==e.id);return I(m.TIMESHEET_LOCATIONS,r),{status:"deleted"}}async function $e(){if(c()){const{data:e,error:t}=await i.from("users").select("id, display_name").eq("role","coach").eq("is_active",!0);if(t)throw new Error(t.message);return(e??[]).map(r=>({id:r.id,display_name:r.display_name}))}return[]}async function Be(e){if(c()){const{data:s,error:n}=await i.from("timesheet_shifts").insert({coach_id:e.coach_id,shift_date:e.shift_date,start_time:e.start_time,end_time:e.end_time??null,location:e.location??null,is_travel:e.is_travel}).select("id").single();if(n)throw new Error(n.message);return e.group_names?.length&&await te(s.id,e.group_names),{status:"created"}}await N(200);const t=h(m.TIMESHEET_SHIFTS)||[],r={...e,id:Date.now(),created_at:new Date().toISOString()};return I(m.TIMESHEET_SHIFTS,[...t,r]),{status:"created"}}async function We(e){if(c()){const{id:n,group_names:a,...o}=e,{error:u}=await i.from("timesheet_shifts").update(o).eq("id",n);if(u)throw new Error(u.message);return a!==void 0&&await te(n,a??[]),{status:"updated"}}await N(200);const t=h(m.TIMESHEET_SHIFTS)||[],r=t.findIndex(n=>n.id===e.id);if(r===-1)return{status:"missing"};const s=[...t];return s[r]={...s[r],...e,updated_at:new Date().toISOString()},I(m.TIMESHEET_SHIFTS,s),{status:"updated"}}async function ze(e){if(c()){const{error:s}=await i.from("timesheet_shifts").delete().eq("id",e.id);if(s)throw new Error(s.message);return{status:"deleted"}}await N(200);const r=(h(m.TIMESHEET_SHIFTS)||[]).filter(s=>s.id!==e.id);return I(m.TIMESHEET_SHIFTS,r),{status:"deleted"}}async function Xe(){if(c()){const{data:e,error:t}=await i.from("timesheet_group_labels").select("*").order("name");if(t)throw new Error(t.message);return e??[]}return await N(120),h("timesheet_group_labels")||[]}async function Ve(e){if(c()){const{error:a}=await i.from("timesheet_group_labels").insert({name:e.name.trim()});if(a)throw new Error(a.message);return{status:"created"}}await N(120);const t=e.name.trim();if(!t)throw new Error("Missing label name");const r=h("timesheet_group_labels")||[];if(r.some(a=>a.name.toLowerCase()===t.toLowerCase()))return{status:"exists"};const n={id:Date.now(),name:t,created_at:new Date().toISOString()};return I("timesheet_group_labels",[...r,n]),{status:"created"}}async function Ye(e){if(c()){const{error:r}=await i.from("timesheet_group_labels").delete().eq("id",e.id);if(r)throw new Error(r.message);return{status:"deleted"}}await N(120);const t=h("timesheet_group_labels")||[];return I("timesheet_group_labels",t.filter(r=>r.id!==e.id)),{status:"deleted"}}async function te(e,t){if(c()){const{error:r}=await i.from("timesheet_shift_groups").delete().eq("shift_id",e);if(r)throw new Error(r.message);if(t.length>0){const s=t.map(a=>({shift_id:e,group_name:a})),{error:n}=await i.from("timesheet_shift_groups").insert(s);if(n)throw new Error(n.message)}return{status:"updated"}}return{status:"noop"}}async function Je(){if(c()){const{data:e,error:t}=await i.from("groups").select("id, name").eq("is_temporary",!1).eq("is_active",!0).order("name");if(t)throw new Error(t.message);return e??[]}return[]}async function Ke(e){return await N(200),(h(m.NOTIFICATIONS)||[]).filter(r=>r.target_athlete===e||r.target_athlete==="All").reverse()}async function Qe(e){if(c()){const{data:n,error:a}=await i.from("notifications").insert({title:e.title,body:e.body??null,type:e.type}).select("id").single();if(a)throw new Error(a.message);if(n&&e.targets.length>0){const{error:o}=await i.from("notification_targets").insert(e.targets.map(u=>({notification_id:n.id,target_user_id:u.target_user_id??null,target_group_id:u.target_group_id??null})));if(o)throw new Error(o.message)}return{status:"sent"}}const t=h(m.NOTIFICATIONS)||[],r={sender:"Coach",title:e.title,message:e.body||"",type:e.type},s=e.targets.map((n,a)=>({...r,id:Date.now()+a,read:!1,date:new Date().toISOString(),sender_id:null,sender_email:null,target_user_id:n.target_user_id??null,target_group_id:n.target_group_id??null}));return I(m.NOTIFICATIONS,[...t,...s]),{status:"sent"}}async function Ze(e){const r=(h(m.NOTIFICATIONS)||[]).map(s=>s.id===e?{...s,read:!0}:s);I(m.NOTIFICATIONS,r)}async function et(e){const t=e.limit??20,r=Number.isFinite(t)?Math.min(Math.max(Number(t),1),200):20,s=e.offset??0,n=Number.isFinite(s)?Math.max(Number(s),0):0,a=e.order==="asc"?"asc":"desc";if(c()){const f=await le(e.targetUserId??null),w=[];if(e.targetUserId&&w.push(`target_user_id.eq.${e.targetUserId}`),f.forEach(g=>w.push(`target_group_id.eq.${g}`)),!w.length)return{notifications:[],pagination:{limit:r,offset:n,total:0}};let b=i.from("notification_targets").select("*, notifications!inner(*)").or(w.join(",")).order("notifications(created_at)",{ascending:a==="asc"});e.status==="read"?b=b.not("read_at","is",null):e.status==="unread"&&(b=b.is("read_at",null)),e.type&&(b=b.eq("notifications.type",e.type)),e.from&&(b=b.gte("notifications.created_at",e.from)),e.to&&(b=b.lte("notifications.created_at",e.to+"T23:59:59"));const{data:T,error:x}=await b;if(x)throw new Error(x.message);const C=(T??[]).map(g=>{const E=g.notifications||{};return{id:q(g.id,Date.now()),notification_id:v(E.id)??null,target_id:v(g.id)??void 0,target_user_id:v(g.target_user_id)??null,sender_id:v(E.created_by)??null,sender_email:null,target_group_id:v(g.target_group_id)??null,target_group_name:null,sender_name:null,sender_role:null,counterparty_id:null,counterparty_name:null,counterparty_role:null,sender:E.created_by?"Coach":"Système",title:String(E.title||""),message:String(E.body||""),type:String(E.type||"message"),read:!!g.read_at,date:E.created_at||new Date().toISOString(),metadata:E.metadata&&typeof E.metadata=="object"?E.metadata:null}}),p=C.length;return{notifications:C.slice(n,n+r),pagination:{limit:r,offset:n,total:p}}}await N(200);const d=(h(m.NOTIFICATIONS)||[]).filter(f=>!(e.targetUserId&&f.target_user_id!==e.targetUserId||e.targetAthleteName&&!(f.target_athlete===e.targetAthleteName||f.target_athlete==="All")||e.type&&f.type!==e.type||e.status==="read"&&!f.read||e.status==="unread"&&f.read)).sort((f,w)=>{const b=new Date(f.date||f.created_at||0).getTime(),T=new Date(w.date||w.created_at||0).getTime();return a==="asc"?b-T:T-b}),l=d.length;return{notifications:d.slice(n,n+r).map(f=>({id:q(f.id,Date.now()),notification_id:v(f.notification_id)??null,target_user_id:v(f.target_user_id)??null,sender_id:v(f.sender_id)??null,sender_email:f.sender_email?String(f.sender_email):null,sender:String(f.sender||"Coach"),title:String(f.title||""),message:String(f.message||""),type:String(f.type||"message"),read:!!f.read,date:f.date||new Date().toISOString(),metadata:f.metadata&&typeof f.metadata=="object"?f.metadata:null,related_id:f.related_id??void 0})),pagination:{limit:r,offset:n,total:l}}}async function tt(e){const t=e.targetId??e.id;if(!t)throw new Error("Missing target id");if(c()){const{error:n}=await i.from("notification_targets").update({read_at:new Date().toISOString()}).eq("id",t);if(n)throw new Error(n.message);return}const s=(h(m.NOTIFICATIONS)||[]).map(n=>n.id===t?{...n,read:!0}:n);I(m.NOTIFICATIONS,s)}const re=e=>{const t=J(e?.cycle??e?.cycle_type),s=(Array.isArray(e?.items)?e.items:[]).map((a,o)=>K(a,o,t));_e(s);const n=s.sort((a,o)=>a.order_index-o.order_index).map(a=>({ordre:a.order_index,exercise_id:a.exercise_id,cycle_type:a.cycle_type,sets:a.sets,reps:a.reps,pct_1rm:a.percent_1rm,rest_series_s:a.rest_seconds,notes:a.notes}));return{cycle:t,normalizedItems:s,itemsPayload:n}},se=(e,t,r)=>e.map(s=>({session_id:t,ordre:s.ordre,exercise_id:s.exercise_id,block:"main",cycle_type:s.cycle_type??r,sets:s.sets,reps:s.reps,pct_1rm:s.pct_1rm,rest_series_s:s.rest_series_s,notes:s.notes})),rt=(e,t)=>({id:t,assignment_id:e.assignment_id,athlete_id:e.athlete_id??null,athlete_name:e.athleteName??null,session_id:e.session_id??null,cycle_type:e.cycle_type??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString(),logs:[]}),st=e=>({run_id:e.run_id,exercise_id:e.exercise_id,set_index:e.set_index??null,reps:e.reps??null,weight:e.weight??null,pct_1rm_suggested:e.pct_1rm_suggested??null,rest_seconds:e.rest_seconds??null,rpe:e.rpe??null,notes:e.notes??null,completed_at:new Date().toISOString()}),nt=(e,t)=>e.map((r,s)=>({run_id:t,exercise_id:r.exercise_id,set_index:r.set_index??r.set_number??s,reps:r.reps??null,weight:r.weight??null,rpe:r.rpe??null,notes:r.notes??null,completed_at:new Date().toISOString()})),it=e=>{const t={};return e.progress_pct!==void 0&&(t.progress_pct=e.progress_pct),e.status&&(t.status=e.status),e.status==="completed"&&(t.completed_at=new Date().toISOString()),e.fatigue!==void 0&&(t.raw_payload={fatigue:e.fatigue,comments:e.comments}),t},ne=(e,t)=>e.map(r=>{const s=t.find(n=>n.id===r.exercise_id);return{...r,exercise_name:s?.nom_exercice,category:s?.exercise_type}}),V=e=>{const t=new Map;for(const r of e){const s=Y(Number(r.weight),Number(r.reps));if(!s)continue;const n=Number(r.exercise_id);if(!Number.isFinite(n))continue;const a=t.get(n)??0;s>a&&t.set(n,s)}return t};async function at(){if(c()){const{data:r,error:s}=await i.from("dim_exercices").select("*");if(s)throw new Error(s.message);return(r??[]).map(me)}const e=h(m.EXERCISES)||[];return(Array.isArray(e)?e:[]).map(r=>z(r))}async function ot(e){const t=B(e.exercise_type);if(c()){const n=Q({...e,exercise_type:t}),{error:a}=await i.from("dim_exercices").insert(n);if(a)throw new Error(a.message);return{status:"created"}}const r=h(m.EXERCISES)||[],s=z({...e,exercise_type:t,id:Date.now()});return I(m.EXERCISES,[...r,s]),{status:"created"}}async function ct(e){const t=B(e.exercise_type);if(c()){const o=Q({...e,exercise_type:t}),{error:u}=await i.from("dim_exercices").update(o).eq("id",e.id);if(u)throw new Error(u.message);return{status:"updated"}}const r=h(m.EXERCISES)||[],s=r.findIndex(o=>o.id===e.id);if(s===-1)throw new Error("Exercice introuvable");const n=z({...r[s],...e,exercise_type:t}),a=[...r];return a[s]=n,I(m.EXERCISES,a),{status:"updated"}}async function ut(e){if(c()){const{error:a}=await i.from("dim_exercices").delete().eq("id",e);if(a)throw new Error(a.message);return{status:"deleted"}}const r=(h(m.EXERCISES)||[]).filter(a=>a.id!==e);I(m.EXERCISES,r);const n=(h(m.STRENGTH_SESSIONS)||[]).map(a=>({...a,items:Array.isArray(a.items)?a.items.filter(o=>o.exercise_id!==e):a.items}));return I(m.STRENGTH_SESSIONS,n),{status:"deleted"}}async function X(){if(c()){const{data:e,error:t}=await i.from("strength_sessions").select("*, strength_session_items(*, dim_exercices(nom_exercice, exercise_type))").order("created_at",{ascending:!1});if(t)throw new Error(t.message);return(e??[]).map(r=>{const s=Array.isArray(r.strength_session_items)?r.strength_session_items:[],n=J(s[0]?.cycle_type);return{id:q(r.id,Date.now()),title:String(r.name||""),description:r.description??"",cycle:n,folder_id:v(r.folder_id),items:s.sort((a,o)=>(a.ordre??0)-(o.ordre??0)).map((a,o)=>({...K(a,o,n),exercise_name:a.dim_exercices?.nom_exercice??void 0,category:a.dim_exercices?.exercise_type??void 0}))}})}return h(m.STRENGTH_SESSIONS)||[]}async function dt(e){const{cycle:t,normalizedItems:r,itemsPayload:s}=re(e);if(c()){const{data:u,error:d}=await i.from("strength_sessions").insert({name:e?.title??e?.name??"",description:e?.description??"",folder_id:e?.folder_id??null}).select("id").single();if(d)throw new Error(d.message);const l=u.id;if(s.length>0){const{error:_}=await i.from("strength_session_items").insert(se(s,l,t));if(_)throw new Error(_.message)}return{status:"created",id:l}}const n=h(m.STRENGTH_SESSIONS)||[],a=Date.now(),o=ne(r,h(m.EXERCISES)||[]);return I(m.STRENGTH_SESSIONS,[...n,{...e,title:e?.title??e?.name??"",cycle:t,items:o,id:a}]),{status:"created",id:a}}async function ie(e){if(!e?.id)throw new Error("Session id manquant");const{cycle:t,normalizedItems:r,itemsPayload:s}=re(e);if(c()){const l=se(s,e.id,t).map(({session_id:y,...f})=>({ordre:f.ordre,exercise_id:f.exercise_id,block:f.block??"main",cycle_type:f.cycle_type??"normal",sets:f.sets??null,reps:f.reps??null,pct_1rm:f.pct_1rm??null,rest_series_s:f.rest_series_s??null,rest_exercise_s:null,notes:f.notes??null,raw_payload:null})),{error:_}=await i.rpc("update_strength_session_atomic",{p_session_id:e.id,p_name:e?.title??e?.name??"",p_description:e?.description??"",p_folder_id:e?.folder_id??null,p_items:l});if(_)throw new Error(_.message);return{status:"updated"}}const n=h(m.STRENGTH_SESSIONS)||[],a=n.findIndex(l=>l.id===e.id);if(a===-1)throw new Error("Séance introuvable");const o=ne(r,h(m.EXERCISES)||[]),u={...n[a],...e,title:e?.title??e?.name??"",cycle:t,items:o},d=[...n];return d[a]=u,I(m.STRENGTH_SESSIONS,d),{status:"updated"}}async function lt(e){return ie(e)}async function _t(e){if(c()){const{error:s}=await i.from("strength_sessions").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}const r=(h(m.STRENGTH_SESSIONS)||[]).filter(s=>s.id!==e);return I(m.STRENGTH_SESSIONS,r),{status:"deleted"}}async function mt(e){if(c()){const{data:n,error:a}=await i.from("strength_session_runs").insert({assignment_id:e.assignment_id??null,athlete_id:e.athlete_id??null,session_id:e.session_id??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString()}).select("id").single();if(a)throw new Error(a.message);return e.assignment_id&&await i.from("session_assignments").update({status:"in_progress"}).eq("id",e.assignment_id),{run_id:n.id}}const t=h(m.STRENGTH_RUNS)||[],r=Date.now(),s=rt(e,r);if(I(m.STRENGTH_RUNS,[...t,s]),e.assignment_id){const a=(h(m.ASSIGNMENTS)||[]).map(o=>o.id===e.assignment_id?{...o,status:"in_progress"}:o);I(m.ASSIGNMENTS,a)}return{run_id:r}}async function ft(e){const t=async y=>{if($(e.weight))return null;const f=Y(Number(e.weight),Number(e.reps));if(!f)return null;const w=y?.athleteId??null,b=y?.athleteName??null;if(w===null&&!b)return null;const T=await F({athleteName:b,athleteId:w}),C=new Map((T||[]).map(p=>[p.exercise_id,Number(p.weight??0)])).get(e.exercise_id)??0;return f<=C||c()&&(w==null||w==="")?null:(await P({athlete_id:w??void 0,athlete_name:b??void 0,exercise_id:e.exercise_id,one_rm:f}),f)},r=y=>{const f=e.athlete_id??e.athleteId??null,w=e.athlete_name??e.athleteName??null;if(f!==null||w)return{athleteId:f,athleteName:w};if(!y)return{athleteId:null,athleteName:null};const b=y.find(T=>T.id===e.run_id);return{athleteId:b?.athlete_id??null,athleteName:b?.athlete_name??null}};if(c()){const{error:y}=await i.from("strength_set_logs").insert(st(e));if(y)throw new Error(y.message);const f=r(),w=await t(f);return{status:"ok",one_rm_updated:!!w,one_rm:w??void 0}}const s=h(m.STRENGTH_RUNS)||[],n=s.findIndex(y=>y.id===e.run_id),a=n>=0?s[n]:{id:e.run_id,logs:[]},o=[...a.logs||[],{...e,completed_at:new Date().toISOString()}],u={...a,logs:o},d=n>=0?[...s.slice(0,n),u,...s.slice(n+1)]:[...s,u];I(m.STRENGTH_RUNS,d);const l=r(d),_=await t(l);return{status:"ok",one_rm_updated:!!_,one_rm:_??void 0}}async function gt(e){if(c()){const u=it(e),{error:d}=await i.from("strength_session_runs").update(u).eq("id",e.run_id);if(d)throw new Error(d.message);return e.status==="completed"&&e.assignment_id&&await i.from("session_assignments").update({status:"completed"}).eq("id",e.assignment_id),{status:"ok"}}const t=h(m.STRENGTH_RUNS)||[],r=t.findIndex(u=>u.id===e.run_id),s=new Date().toISOString(),n=r>=0?t[r]:{id:e.run_id,started_at:s},a={...n,...e,id:e.run_id,updated_at:s};if(e.status==="completed"&&!a.completed_at&&(a.completed_at=s),e.status==="completed"){const u=e.assignment_id??n.assignment_id;if(u){const l=(h(m.ASSIGNMENTS)||[]).map(_=>_.id===u?{..._,status:"completed"}:_);I(m.ASSIGNMENTS,l)}}const o=r>=0?[...t.slice(0,r),a,...t.slice(r+1)]:[...t,a];return I(m.STRENGTH_RUNS,o),{status:"ok"}}async function pt(e){if(c()){const{error:n}=await i.from("strength_session_runs").delete().eq("id",e);if(n)throw new Error(n.message);return{status:"deleted",source:"remote"}}const t=h(m.STRENGTH_RUNS)||[],r=t.find(n=>n.id===e),s=t.filter(n=>n.id!==e);if(I(m.STRENGTH_RUNS,s),r?.assignment_id){const a=(h(m.ASSIGNMENTS)||[]).map(o=>o.id===r.assignment_id?{...o,status:"assigned"}:o);I(m.ASSIGNMENTS,a)}return{status:"deleted",source:"local"}}async function wt(e){if(c()){let o=e.run_id;if(!o){const{data:d,error:l}=await i.from("strength_session_runs").insert({assignment_id:e.assignment_id??null,athlete_id:e.athlete_id??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString()}).select("id").single();if(l)throw new Error(l.message);o=d.id}if(o&&Array.isArray(e.logs)&&e.logs.length>0){const{error:d}=await i.from("strength_set_logs").insert(nt(e.logs,o));if(d)throw new Error(d.message)}const u=V(Array.isArray(e.logs)?e.logs:[]);if(u.size>0){const d=e.athlete_id??null,l=e.athlete_name??null;if(d!=null&&d!==""){const _=await F({athleteName:l,athleteId:d}),y=new Map((_||[]).map(f=>[f.exercise_id,Number(f.weight??0)]));await Promise.all(Array.from(u.entries()).filter(([f,w])=>w>(y.get(f)??0)).map(([f,w])=>P({athlete_id:d??void 0,athlete_name:l??void 0,exercise_id:f,one_rm:w})))}}return o&&await i.from("strength_session_runs").update({progress_pct:e.progress_pct??100,status:"completed",completed_at:new Date().toISOString()}).eq("id",o),e.assignment_id&&await i.from("session_assignments").update({status:"completed"}).eq("id",e.assignment_id),{status:"ok",run_id:o??null}}const t=h(m.STRENGTH_RUNS)||[],r=e.run_id??Date.now(),s=t.find(o=>o.id===r)||{},n={...s,...e,id:r,status:"completed",started_at:s.started_at??e.started_at??e.date??new Date().toISOString(),completed_at:new Date().toISOString()};if(I(m.STRENGTH_RUNS,[...t.filter(o=>o.id!==r),n]),e.assignment_id){const u=(h(m.ASSIGNMENTS)||[]).map(d=>d.id===e.assignment_id?{...d,status:"completed"}:d);I(m.ASSIGNMENTS,u)}const a=V(Array.isArray(e.logs)?e.logs:[]);if(a.size>0){const o=e.athlete_id??null,u=e.athlete_name??null,d=await F({athleteName:u,athleteId:o}),l=new Map((d||[]).map(_=>[_.exercise_id,Number(_.weight??0)]));await Promise.all(Array.from(a.entries()).filter(([_,y])=>y>(l.get(_)??0)).map(([_,y])=>P({athlete_id:o??void 0,athlete_name:u??void 0,exercise_id:_,one_rm:y})))}return{status:"ok",run_id:r}}async function ht(e,t){const r=t?.limit??50,s=Number.isFinite(r)?Math.min(Math.max(Number(r),1),200):50,n=t?.offset??0,a=Number.isFinite(n)?Math.max(Number(n),0):0,o=t?.order==="asc"?"asc":"desc",u=t?.athleteId,d=u!=null&&u!=="";if(c()){let p=i.from("strength_session_runs").select("*, strength_set_logs(*)").order("started_at",{ascending:o==="asc"}).range(a,a+s-1);d&&(p=p.eq("athlete_id",Number(u))),t?.status&&(p=p.eq("status",t.status)),t?.from&&(p=p.gte("started_at",t.from)),t?.to&&(p=p.lte("started_at",t.to+"T23:59:59"));const{data:S,error:g,count:E}=await p;if(g)throw new Error(g.message);return{runs:S??[],pagination:{limit:s,offset:a,total:E??(S??[]).length},exercise_summary:[]}}const y=(h(m.STRENGTH_RUNS)||[]).filter(p=>{if(d&&String(p.athlete_id)!==String(u)||!d&&e&&p.athlete_name!==e||t?.status&&p.status!==t.status)return!1;if(t?.from||t?.to){const S=new Date(p.date||p.started_at||p.created_at||0).getTime();if(t?.from){const g=new Date(t.from).getTime();if(Number.isFinite(g)&&S<g)return!1}if(t?.to){const g=new Date(t.to);g.setHours(23,59,59,999);const E=g.getTime();if(Number.isFinite(E)&&S>E)return!1}}return!0}).sort((p,S)=>{const g=new Date(p.date||p.started_at||p.created_at||0).getTime(),E=new Date(S.date||S.started_at||S.created_at||0).getTime();return o==="asc"?g-E:E-g}),f=h(m.EXERCISES)||[],w=new Map((Array.isArray(f)?f:[]).map(p=>[q(p.id),p.nom_exercice||p.name||`Exercice ${p.id}`])),b=new Map;y.forEach(p=>{(p.logs||[]).forEach(S=>{const g=q(S.exercise_id);if(!g)return;const E=b.get(g)||{exercise_id:g,exercise_name:w.get(g)||`Exercice ${g}`,total_sets:0,total_reps:0,total_volume:0,max_weight:null,last_performed_at:null},A=Number(S.reps??0)||0,R=S.weight,k=$(R)?0:Number(R??0)||0;E.total_sets+=1,E.total_reps+=A,E.total_volume+=A*k,$(R)||(E.max_weight=Math.max(E.max_weight??0,k)||E.max_weight);const D=S.completed_at||p.completed_at||p.started_at||null;if(D){const G=new Date(D).getTime(),L=E.last_performed_at?new Date(E.last_performed_at).getTime():0;(!E.last_performed_at||G>L)&&(E.last_performed_at=D)}b.set(g,E)})});const T=y.length,x=y.slice(a,a+s),C=Array.from(b.values()).sort((p,S)=>S.total_volume-p.total_volume);return{runs:x,pagination:{limit:s,offset:a,total:T},exercise_summary:C}}async function yt(e,t){const r=t?.limit??200,s=Number.isFinite(r)?Math.min(Math.max(Number(r),1),200):200,n=t?.offset??0,a=Number.isFinite(n)?Math.max(Number(n),0):0,o=t?.order==="asc"?"asc":"desc",u=t?.athleteId,d=u!=null&&u!=="",l=t?.period??"day";if(c()){const S={p_period:l};d&&(S.p_athlete_id=Number(u)),t?.from&&(S.p_from=t.from),t?.to&&(S.p_to=t.to);const{data:g,error:E}=await i.rpc("get_strength_history_aggregate",S);if(E)throw new Error(E.message);const A=Array.isArray(g)?g:[];return{periods:A,pagination:{limit:s,offset:a,total:A.length}}}const y=(h(m.STRENGTH_RUNS)||[]).filter(S=>d?S.athlete_id?String(S.athlete_id)===String(u):!1:S.athlete_name===e),f=t?.from?new Date(t.from):null,w=t?.to?new Date(t.to):null,b=new Map,T=S=>{if(l==="month")return`${S.getUTCFullYear()}-${String(S.getUTCMonth()+1).padStart(2,"0")}`;if(l==="week"){const g=new Date(Date.UTC(S.getUTCFullYear(),S.getUTCMonth(),S.getUTCDate())),E=g.getUTCDay()||7;g.setUTCDate(g.getUTCDate()+4-E);const A=new Date(Date.UTC(g.getUTCFullYear(),0,1)),R=Math.ceil(((g.getTime()-A.getTime())/864e5+1)/7);return`${g.getUTCFullYear()}-W${String(R).padStart(2,"0")}`}return S.toISOString().split("T")[0]};y.forEach(S=>{(Array.isArray(S.logs)?S.logs:[]).forEach(E=>{const A=E.completed_at||S.started_at||S.date||S.created_at;if(!A)return;const R=new Date(A);if(Number.isNaN(R.getTime())||f&&R<f||w&&R>w)return;const k=T(R),D=b.get(k)||{period:k,tonnage:0,volume:0},G=Number(E.reps)||0,L=Number(E.weight)||0;D.volume+=G,D.tonnage+=G*L,b.set(k,D)})});const x=Array.from(b.values()).sort((S,g)=>o==="asc"?S.period.localeCompare(g.period):g.period.localeCompare(S.period)),C=x.length;return{periods:x.slice(a,a+s),pagination:{limit:s,offset:a,total:C}}}async function F(e){const t=typeof e=="string"?e:e?.athleteName??null,r=typeof e=="string"?null:e?.athleteId??null;if(c()){let n=i.from("one_rm_records").select("*");r!=null&&String(r)!==""&&(n=n.eq("athlete_id",Number(r)));const{data:a,error:o}=await n;if(o)throw new Error(o.message);return(a??[]).map(u=>({id:v(u.id),athlete_id:v(u.athlete_id),exercise_id:q(u.exercise_id),weight:Number(u.one_rm??0),recorded_at:u.recorded_at??null,notes:u.notes??null}))}return(h(m.ONE_RM)||[]).filter(n=>n.athlete_name===t)}async function P(e){if(c()){const n=e.athlete_id??e.athleteId,a=e.one_rm??e.weight;if(n==null||n===""||a===null||a===void 0)throw new Error("athlete_id et one_rm sont requis");const o={athlete_id:Number(n),exercise_id:e.exercise_id,one_rm:a,recorded_at:new Date().toISOString()};e.notes!==void 0&&(o.notes=e.notes);const{error:u}=await i.from("one_rm_records").upsert(o,{onConflict:"athlete_id,exercise_id"});if(u)throw new Error(u.message);return{status:"ok"}}const t=h(m.ONE_RM)||[],r=e.athlete_name??e.athleteName,s=t.filter(n=>!(n.athlete_name===r&&n.exercise_id===e.exercise_id));return I(m.ONE_RM,[...s,{...e,athlete_name:r,id:Date.now(),date:new Date().toISOString()}]),{status:"ok"}}async function St(e){if(c()){const{data:s,error:n}=await i.from("one_rm_records").update({notes:e.notes}).eq("athlete_id",Number(e.athlete_id)).eq("exercise_id",e.exercise_id).select("id");if(n)throw new Error(n.message);if(!s||s.length===0){const{error:a}=await i.from("one_rm_records").insert({athlete_id:Number(e.athlete_id),exercise_id:e.exercise_id,notes:e.notes,one_rm:0,recorded_at:new Date().toISOString()});if(a)throw new Error(a.message)}return{status:"ok"}}const t=h(m.ONE_RM)||[],r=t.findIndex(s=>String(s.athlete_id)===String(e.athlete_id)&&s.exercise_id===e.exercise_id);return r>=0?t[r].notes=e.notes:t.push({athlete_id:Number(e.athlete_id),exercise_id:e.exercise_id,one_rm:0,notes:e.notes,id:Date.now(),date:new Date().toISOString()}),I(m.ONE_RM,t),{status:"ok"}}async function Et(e){if(c()){const{data:t,error:r}=await i.from("strength_folders").select("*").eq("type",e).order("sort_order",{ascending:!0});if(r)throw new Error(r.message);return(t??[]).map(s=>({id:q(s.id),name:String(s.name||""),type:s.type,sort_order:q(s.sort_order)}))}return[]}async function bt(e,t){if(!c())throw new Error("Supabase requis");const{data:r,error:s}=await i.from("strength_folders").insert({name:e,type:t}).select("*").single();if(s)throw new Error(s.message);return{id:q(r.id),name:String(r.name),type:r.type,sort_order:q(r.sort_order)}}async function vt(e,t){if(!c())throw new Error("Supabase requis");const{error:r}=await i.from("strength_folders").update({name:t}).eq("id",e);if(r)throw new Error(r.message)}async function It(e){if(!c())throw new Error("Supabase requis");const{error:t}=await i.from("strength_folders").delete().eq("id",e);if(t)throw new Error(t.message)}async function Tt(e,t,r){if(!c())throw new Error("Supabase requis");const{error:s}=await i.from(r).update({folder_id:t}).eq("id",e);if(s)throw new Error(s.message)}async function qt(){return c()?null:(await N(100),h(m.ASSIGNMENTS)||[])}async function Nt(e,t,r){if(c()){const{permanentGroupIds:n,temporaryGroupIds:a,hasActiveTemporary:o}=await Z(t??null),u=[];if(t!=null&&u.push(`target_user_id.eq.${t}`),(o?a:n).forEach(p=>u.push(`target_group_id.eq.${p}`)),!u.length)return[];let l=i.from("session_assignments").select("*").or(u.join(","));r?.assignmentType&&(l=l.eq("assignment_type",r.assignmentType)),r?.status?l=l.eq("status",r.status):l=l.neq("status","completed");const{data:_,error:y}=await l;if(y)throw new Error(y.message);if(!_?.length)return[];const[f,w]=await Promise.all([W(),X()]),b=new Map(f.map(p=>[p.id,p])),T=new Map(w.map(p=>[p.id,p])),x=_.map(p=>{const S=p.assignment_type==="strength"?"strength":"swim",g=v(S==="swim"?p.swim_catalog_id:p.strength_session_id)??0,E=p.scheduled_date||p.created_at||"",A=String(p.status||"assigned"),R=S==="swim"?b.get(g):void 0,k=S==="strength"?T.get(g):void 0,D={id:q(p.id,Date.now()),session_id:g,session_type:S,title:S==="swim"?R?.name??"Séance natation":k?.title??"Séance musculation",description:R?.description??k?.description??"",assigned_date:E||new Date().toISOString(),assigned_slot:p.scheduled_slot??null,status:A,items:k?.items??R?.items};return S==="strength"&&(D.cycle=k?.cycle??"endurance"),D}),C=new Map(x.map(p=>[p.id,p]));return Array.from(C.values())}return await N(200),(h(m.ASSIGNMENTS)||[]).filter(n=>!(t!=null&&String(t)!==""&&String(n.target_user_id)===String(t)||n.target_athlete===e)||r?.assignmentType&&n.session_type!==r.assignmentType?!1:r?.status?n.status===r.status:n.status!=="completed")}async function xt(e,t){const r=e.assignment_type??e.session_type;if(!r)return{status:"error"};const s=e.scheduled_date??e.assigned_date??new Date().toISOString();if(c()){const d={assignment_type:r,scheduled_date:s,scheduled_slot:e.scheduled_slot??null,assigned_by:t??null,status:"assigned"};r==="swim"?d.swim_catalog_id=e.session_id:d.strength_session_id=e.session_id,e.target_user_id!==null&&e.target_user_id!==void 0?d.target_user_id=e.target_user_id:e.target_group_id!==null&&e.target_group_id!==void 0&&(d.target_group_id=e.target_group_id);const{data:l,error:_}=await i.from("session_assignments").insert(d).select("id").single();if(_)throw new Error(_.message);const{data:y,error:f}=await i.from("notifications").insert({title:"Nouvelle séance assignée",body:`Séance prévue le ${s}.`,type:"assignment"}).select("id").single();if(!f&&y){const w={notification_id:y.id};e.target_user_id&&(w.target_user_id=e.target_user_id),e.target_group_id&&(w.target_group_id=e.target_group_id),await i.from("notification_targets").insert(w)}return{status:"assigned"}}let n;if(r==="swim"?n=(h(m.SWIM_SESSIONS)||[]).find(d=>d.id===e.session_id):n=(h(m.STRENGTH_SESSIONS)||[]).find(d=>d.id===e.session_id),!n)return{status:"error"};const a={id:Date.now(),session_id:e.session_id,session_type:r,target_athlete:e.target_athlete??"",target_user_id:e.target_user_id??null,target_group_id:e.target_group_id??null,assigned_date:s,title:n.name??n.title,description:n.description,items:n.items,status:"assigned"},o=h(m.ASSIGNMENTS)||[];I(m.ASSIGNMENTS,[...o,a]);const u=h(m.NOTIFICATIONS)||[];return I(m.NOTIFICATIONS,[...u,{id:Date.now()+1,sender:"Coach",target_athlete:e.target_athlete,target_user_id:e.target_user_id??null,target_group_id:e.target_group_id??null,title:"Nouvelle séance assignée",message:`Séance ${n.title??n.name} prévue le ${s}.`,type:"assignment",related_id:a.id,read:!1,date:new Date().toISOString()}]),{status:"assigned"}}async function Ct(e){if(c()){const{error:s}=await i.from("session_assignments").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}const r=(h(m.ASSIGNMENTS)||[]).filter(s=>s.id!==e);return I(m.ASSIGNMENTS,r),{status:"deleted"}}async function Rt(e){if(!c())return[];let t=i.from("session_assignments").select("*").gte("scheduled_date",e.from).lte("scheduled_date",e.to);if(e.groupId)t=t.eq("target_group_id",e.groupId);else if(e.userId){const{permanentGroupIds:d,temporaryGroupIds:l,hasActiveTemporary:_}=await Z(e.userId),y=[`target_user_id.eq.${e.userId}`];(_?l:d).forEach(w=>y.push(`target_group_id.eq.${w}`)),t=t.or(y.join(","))}else return[];const{data:r,error:s}=await t;if(s)throw new Error(s.message);if(!r?.length)return[];const[n,a]=await Promise.all([W(),X()]),o=new Map(n.map(d=>[d.id,d])),u=new Map(a.map(d=>[d.id,d]));return r.map(d=>{const l=d.assignment_type==="strength"?"strength":"swim",_=v(l==="swim"?d.swim_catalog_id:d.strength_session_id)??0,y=l==="swim"?o.get(_):void 0,f=l==="strength"?u.get(_):void 0;return{id:q(d.id,0),title:l==="swim"?y?.name??"Séance natation":f?.title??"Séance musculation",type:l,scheduledDate:d.scheduled_date??"",scheduledSlot:d.scheduled_slot??null,targetLabel:"",targetType:d.target_group_id?"group":"user",status:d.status??"assigned"}})}function Ns(e){return parseInt(e.split(":")[0],10)<13?"morning":"evening"}async function At(e){if(!c())return{created:0};const t=e.groupIds.map(n=>({assignment_type:"swim",swim_catalog_id:e.swimCatalogId,target_group_id:n,scheduled_date:e.scheduledDate,scheduled_slot:e.scheduledSlot,training_slot_id:e.trainingSlotId,visible_from:e.visibleFrom,assigned_by:e.assignedBy,status:"assigned"})),{data:r,error:s}=await i.from("session_assignments").insert(t).select("id");if(s)throw new Error(s.message);return{created:r?.length??0}}async function kt(e){if(!c())return[];const{data:t,error:r}=await i.from("session_assignments").select(`
      id, swim_catalog_id, training_slot_id, target_group_id,
      scheduled_date, scheduled_slot, visible_from, notified_at, status,
      swim_sessions_catalog(name)
    `).gte("scheduled_date",e.from).lte("scheduled_date",e.to).not("training_slot_id","is",null).order("scheduled_date");if(r)throw new Error(r.message);return(t??[]).map(s=>({id:s.id,swim_catalog_id:s.swim_catalog_id,training_slot_id:s.training_slot_id,target_group_id:s.target_group_id,scheduled_date:s.scheduled_date,scheduled_slot:s.scheduled_slot,visible_from:s.visible_from,notified_at:s.notified_at,status:s.status,session_name:s.swim_sessions_catalog?.name??null,session_distance:null}))}async function Ot(e){if(!c())return;const{error:t}=await i.from("session_assignments").update({visible_from:e.visibleFrom}).eq("training_slot_id",e.trainingSlotId).eq("scheduled_date",e.scheduledDate);if(t)throw new Error(t.message)}async function Dt(e){if(!c())return;const{error:t}=await i.from("session_assignments").delete().eq("training_slot_id",e.trainingSlotId).eq("scheduled_date",e.scheduledDate);if(t)throw new Error(t.message)}async function Mt(e){if(c()){const l=e?{from_date:e}:{},{data:_,error:y}=await i.rpc("get_hall_of_fame",l);if(!y&&_){const f=Array.isArray(_)?_:[],w=[...f].map(g=>({athlete_name:g.athlete_name,total_distance:Number(g.total_distance??0),avatar_url:g.avatar_url??null})).sort((g,E)=>E.total_distance-g.total_distance).slice(0,5),b=[...f].map(g=>({athlete_name:g.athlete_name,avg_effort:Number(g.avg_performance??g.avg_engagement??0),avatar_url:g.avatar_url??null})).sort((g,E)=>E.avg_effort-g.avg_effort).slice(0,5),T=[...f].map(g=>({athlete_name:g.athlete_name,avg_engagement:Number(g.avg_engagement??0),avatar_url:g.avatar_url??null})).sort((g,E)=>E.avg_engagement-g.avg_engagement).slice(0,5);let x=[];const C=e?{from_date:e}:{},{data:p,error:S}=await i.rpc("get_hall_of_fame_strength",C);return!S&&p&&(x=(Array.isArray(p)?p:[]).map(g=>({athlete_name:g.athlete_name??"Inconnu",total_volume:Number(g.total_volume??0),total_reps:Number(g.total_reps??0),total_sets:Number(g.total_sets??0),max_weight:Number(g.max_weight??0),avatar_url:g.avatar_url??null}))),{distance:w,performance:b,engagement:T,strength:x}}}await N(300);const t=h(m.SESSIONS)||[],r=h(m.STRENGTH_RUNS)||[],s=e?t.filter(l=>l.session_date>=e||l.date>=e):t,n=e?r.filter(l=>(l.started_at??l.date??"")>=e):r,a=new Map;s.forEach(l=>{a.has(l.athlete_name)||a.set(l.athlete_name,{distance:0,effortSum:0,count:0,engagementSum:0,engagementCount:0});const _=a.get(l.athlete_name);_.distance+=l.distance,_.effortSum+=l.effort,_.count+=1,l.engagement!==null&&l.engagement!==void 0&&Number.isFinite(l.engagement)&&(_.engagementSum+=l.engagement,_.engagementCount+=1)});const o=Array.from(a.entries()).map(([l,_])=>({athlete_name:l,total_distance:_.distance,avg_effort:_.effortSum/_.count,avg_engagement:_.engagementCount?_.engagementSum/_.engagementCount:0})),u=new Map;n.forEach(l=>{u.has(l.athlete_name)||u.set(l.athlete_name,{volume:0,reps:0,sets:0,maxWeight:0});const _=u.get(l.athlete_name);l.logs&&l.logs.forEach(y=>{const f=Number(y.reps??0),w=Number(y.weight??0);_.volume+=f*w,_.reps+=f,_.sets+=1,w>_.maxWeight&&(_.maxWeight=w)})});const d=Array.from(u.entries()).map(([l,_])=>({athlete_name:l,total_volume:_.volume,total_reps:_.reps,total_sets:_.sets,max_weight:_.maxWeight}));return{distance:[...o].sort((l,_)=>_.total_distance-l.total_distance).slice(0,5),performance:[...o].sort((l,_)=>_.avg_effort-l.avg_effort).slice(0,5),engagement:[...o].sort((l,_)=>_.avg_engagement-l.avg_engagement).slice(0,5),strength:[...d].sort((l,_)=>_.total_volume-l.total_volume).slice(0,5)}}async function Ut(e){if(!c())return[];let t=i.from("club_records").select("*");e.pool_m&&(t=t.eq("pool_m",e.pool_m)),e.sex&&(t=t.eq("sex",e.sex)),e.age&&(t=t.eq("age",e.age)),e.event_code&&(t=t.eq("event_code",e.event_code));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Gt(){if(!c())return[];const{data:e,error:t}=await i.from("club_record_swimmers").select("*");if(t)throw new Error(t.message);return(e??[]).map(r=>({...r,is_active:r.is_active?1:0}))}async function Ft(e){if(!c())return null;const t=e.iuf?.trim()||null;if(t){const{data:n,error:a}=await i.from("club_record_swimmers").select("id, display_name, source_type").eq("iuf",t).limit(1);if(a)throw new Error(a.message);if(n&&n.length>0){const o=n[0],u=o.source_type==="user"?"inscrit":"déjà ajouté";throw new Error(`Un nageur avec cet IUF existe déjà : ${o.display_name} (${u})`)}}const{data:r,error:s}=await i.from("club_record_swimmers").insert({source_type:"manual",display_name:e.display_name,iuf:t,sex:e.sex??null,birthdate:e.birthdate??null,is_active:e.is_active!==!1}).select().single();if(s)throw new Error(s.message);return r?{...r,is_active:r.is_active?1:0}:null}async function Pt(e,t){if(!c())return null;let r;if(t.iuf!==void 0&&(r=typeof t.iuf=="string"&&t.iuf.trim()||null,r)){const{data:o,error:u}=await i.from("club_record_swimmers").select("id, display_name, source_type").eq("iuf",r).neq("id",e).limit(1);if(u)throw new Error(u.message);if(o&&o.length>0){const d=o[0],l=d.source_type==="user"?"inscrit":"déjà ajouté";throw new Error(`Un nageur avec cet IUF existe déjà : ${d.display_name} (${l})`)}}const s={};t.iuf!==void 0&&(s.iuf=r??null),t.is_active!==void 0&&(s.is_active=t.is_active),t.sex!==void 0&&(s.sex=t.sex),t.birthdate!==void 0&&(s.birthdate=t.birthdate);const{data:n,error:a}=await i.from("club_record_swimmers").update(s).eq("id",e).select().single();if(a)throw new Error(a.message);return n?{...n,is_active:n.is_active?1:0}:null}async function Ht(e,t){if(!c())return null;const r={};t.iuf!==void 0&&(r.iuf=t.iuf),t.is_active!==void 0&&(r.is_active=t.is_active),t.sex!==void 0&&(r.sex=t.sex),t.birthdate!==void 0&&(r.birthdate=t.birthdate);const{data:s,error:n}=await i.from("club_record_swimmers").update(r).eq("user_id",e).eq("source_type","user").select().single();if(n)throw new Error(n.message);return s?{...s,is_active:s.is_active?1:0}:null}async function Lt(){if(!c())return null;const{data:e,error:t}=await i.functions.invoke("import-club-records");if(t){const r=e?.error??t.message;throw new Error(String(r))}return e}async function jt(e){if(!c())return[];let t=i.from("import_logs").select("*").order("started_at",{ascending:!1});e?.swimmerIuf&&(t=t.eq("swimmer_iuf",e.swimmerIuf)),e?.limit&&(t=t.limit(e.limit));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function $t(e,t){if(!c())throw new Error("Supabase not configured");const{data:r,error:s}=await i.functions.invoke("ffn-performances",{body:{swimmer_iuf:e,swimmer_name:t??null}});if(s){const n=r?.error??s.message;throw new Error(String(n))}return r??{total_found:0,new_imported:0,already_existed:0}}async function Bt(e){if(c()){const s=e.recordType==="comp"?"swim_records_comp":"swim_records";let n=i.from(s).select("*").order("record_date",{ascending:!1});e.athleteId&&(n=n.eq("athlete_id",e.athleteId)),s==="swim_records"&&(n=n.eq("record_type","training"));const{data:a,error:o}=await n;if(o)throw new Error(o.message);const u=a??[];return{records:u,pagination:{limit:u.length,offset:0,total:u.length}}}const r=(h(m.SWIM_RECORDS)||[]).filter(s=>e.athleteId?s.athlete_id===e.athleteId:e.athleteName?s.athlete_name===e.athleteName:!1);return{records:r,pagination:{limit:r.length,offset:0,total:r.length}}}async function Wt(e){if(c()){const s={athlete_id:e.athlete_id??null,event_name:e.event_name,pool_length:e.pool_length??null,time_seconds:e.time_seconds??null,record_date:e.record_date??null,notes:e.notes??null};if(e.id){const{error:n}=await i.from("swim_records").update(s).eq("id",e.id);if(n)throw new Error(n.message)}else{const{error:n}=await i.from("swim_records").insert(s);if(n)throw new Error(n.message)}return{status:"ok"}}const t=h(m.SWIM_RECORDS)||[];if(e.id){const s=t.map(n=>n.id===e.id?{...n,...e,athlete_id:e.athlete_id??n.athlete_id}:n);return I(m.SWIM_RECORDS,s),{status:"ok"}}const r={...e,id:Date.now(),athlete_id:e.athlete_id??-1,athlete_name:e.athleteName??null};return I(m.SWIM_RECORDS,[...t,r]),{status:"created"}}async function zt(e){if(!c())return[];let t=i.from("swimmer_performances").select("*").order("competition_date",{ascending:!1});e.userId&&(t=t.eq("user_id",e.userId)),e.iuf&&(t=t.eq("swimmer_iuf",e.iuf)),e.eventCode&&(t=t.eq("event_code",e.eventCode)),e.poolLength&&(t=t.eq("pool_length",e.poolLength)),e.fromDate&&(t=t.gte("competition_date",e.fromDate)),e.toDate&&(t=t.lte("competition_date",e.toDate)),e.limit&&(t=t.limit(e.limit));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Xt(e){if(!c())throw new Error("Supabase not configured");const{data:t,error:r}=await i.functions.invoke("ffn-performances",{body:{swimmer_iuf:e.iuf,user_id:e.userId??null}});if(r){const s=t?.error??r.message;throw new Error(String(s))}return t??{total_found:0,new_imported:0,already_existed:0}}async function Vt(){if(!c())return null;const{data:e,error:t}=await i.functions.invoke("import-club-records",{body:{mode:"recalculate"}});if(t){const r=e?.error??t.message;throw new Error(String(r))}return e}async function Yt(){if(!c())return;const{data:e,error:t}=await i.from("users").select("id, display_name, role, birthdate").eq("role","athlete").eq("is_active",!0);if(t)throw new Error(t.message);if(!e||e.length===0)return;const{data:r}=await i.from("club_record_swimmers").select("id, user_id, iuf, sex, birthdate, display_name").eq("source_type","user"),s=new Map((r??[]).map(o=>[o.user_id,o])),{data:n}=await i.from("user_profiles").select("user_id, ffn_iuf, birthdate, sex"),a=new Map((n??[]).map(o=>[o.user_id,o]));for(const o of e){const u=a.get(o.id),d=u?.ffn_iuf??null,l=u?.sex??null,_=u?.birthdate??o.birthdate??null,y=s.get(o.id);if(!y)await i.from("club_record_swimmers").insert({source_type:"user",user_id:o.id,display_name:o.display_name,iuf:d,sex:l,birthdate:_,is_active:!0});else{const f={};d&&d!==y.iuf&&(f.iuf=d),l&&l!==y.sex&&(f.sex=l),_&&_!==y.birthdate&&(f.birthdate=_),o.display_name&&o.display_name!==y.display_name&&(f.display_name=o.display_name),Object.keys(f).length>0&&await i.from("club_record_swimmers").update(f).eq("id",y.id)}}}async function Jt(e){if(!c())return[];let t=i.from("club_performances").select("*").eq("event_code",e.event_code).eq("pool_m",e.pool_m).eq("sex",e.sex).order("time_ms",{ascending:!0});e.age!=null&&(t=t.eq("age",e.age));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Kt(e){if(!c())return null;const{data:t,error:r}=await i.from("app_settings").select("value").eq("key",e).single();return r?null:t?.value??null}async function Qt(e,t){if(!c())throw new Error("Supabase not configured");const{data:r,error:s}=await i.rpc("merge_club_record_swimmers",{p_manual_id:e,p_user_swimmer_id:t});if(s)throw new Error(s.message);return r}async function Zt(e,t){if(!c())return;const{error:r}=await i.from("app_settings").upsert({key:e,value:t,updated_at:new Date().toISOString()},{onConflict:"key"});if(r)throw new Error(r.message)}async function er(e){if(!c())return[];const{data:t,error:r}=await i.from("swim_exercise_logs").select("*").eq("session_id",e).order("created_at",{ascending:!0});if(r)throw new Error(r.message);return(t??[]).map(ae)}async function tr(e,t=50){if(!c())return[];const{data:r,error:s}=await i.from("swim_exercise_logs").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(t);if(s)throw new Error(s.message);return(r??[]).map(ae)}async function rr(e,t,r){if(!c())return;const{error:s}=await i.from("swim_exercise_logs").delete().eq("session_id",e).eq("user_id",t);if(s)throw new Error(s.message);if(r.length===0)return;const n=r.map(o=>({session_id:e,user_id:t,exercise_label:o.exercise_label,source_item_id:o.source_item_id??null,split_times:o.split_times??[],tempo:o.tempo??null,stroke_count:o.stroke_count??[],notes:o.notes??null,event_code:o.event_code??null,pool_length:o.pool_length??null,equipment:o.equipment??["aucun"]})),{error:a}=await i.from("swim_exercise_logs").insert(n);if(a)throw new Error(a.message)}async function sr(e,t){if(!c())return"";const{data:r,error:s}=await i.from("swim_exercise_logs").insert({user_id:e,session_id:null,exercise_label:t.exercise_label,source_item_id:null,split_times:t.split_times??[],tempo:t.tempo??null,stroke_count:t.stroke_count??[],notes:t.notes??null,event_code:t.event_code??null,pool_length:t.pool_length??null,equipment:t.equipment??["aucun"]}).select("id").single();if(s)throw new Error(s.message);return r?.id??""}async function nr(e,t){if(!c())return;const r={updated_at:new Date().toISOString()};t.exercise_label!==void 0&&(r.exercise_label=t.exercise_label),t.split_times!==void 0&&(r.split_times=t.split_times),t.tempo!==void 0&&(r.tempo=t.tempo),t.stroke_count!==void 0&&(r.stroke_count=t.stroke_count),t.notes!==void 0&&(r.notes=t.notes),t.event_code!==void 0&&(r.event_code=t.event_code),t.pool_length!==void 0&&(r.pool_length=t.pool_length),t.equipment!==void 0&&(r.equipment=t.equipment);const{error:s}=await i.from("swim_exercise_logs").update(r).eq("id",e);if(s)throw new Error(s.message)}async function ir(e){if(!c())return;const{error:t}=await i.from("swim_exercise_logs").delete().eq("id",e);if(t)throw new Error(t.message)}function ae(e){return{id:String(e.id),session_id:e.session_id!=null?Number(e.session_id):null,user_id:String(e.user_id),exercise_label:String(e.exercise_label??""),source_item_id:e.source_item_id!=null?Number(e.source_item_id):null,split_times:Array.isArray(e.split_times)?e.split_times:[],tempo:e.tempo!=null?Number(e.tempo):null,stroke_count:Array.isArray(e.stroke_count)?e.stroke_count:[],notes:e.notes!=null?String(e.notes):null,event_code:e.event_code!=null?String(e.event_code):null,pool_length:e.pool_length!=null?Number(e.pool_length):null,equipment:Array.isArray(e.equipment)?e.equipment:[],created_at:String(e.created_at??""),updated_at:String(e.updated_at??"")}}async function ar(){if(!c())return[];const{data:e,error:t}=await i.from("groups").select("id, name, is_active, parent_group_id, created_by, created_at").eq("is_temporary",!0).is("parent_group_id",null).order("created_at",{ascending:!1});if(t)throw new Error(t.message);if(!e?.length)return[];const r=e.map(u=>u.id),{data:s}=await i.from("groups").select("parent_group_id").eq("is_temporary",!0).in("parent_group_id",r),n=new Map;(s??[]).forEach(u=>{n.set(u.parent_group_id,(n.get(u.parent_group_id)??0)+1)});const{data:a}=await i.from("group_members").select("group_id").in("group_id",r),o=new Map;return(a??[]).forEach(u=>{o.set(u.group_id,(o.get(u.group_id)??0)+1)}),e.map(u=>({id:q(u.id,0),name:u.name,is_active:u.is_active??!0,parent_group_id:u.parent_group_id??null,member_count:o.get(u.id)??0,subgroup_count:n.get(u.id)??0,created_at:u.created_at??"",created_by:u.created_by??0}))}async function or(e){if(!c())return null;const{data:t,error:r}=await i.from("groups").select("id, name, is_active").eq("id",e).eq("is_temporary",!0).single();if(r||!t)return null;const{data:s}=await i.from("group_members").select("user_id, users!inner(display_name)").eq("group_id",e),n=(s??[]).map(_=>_.user_id),{data:a}=n.length?await i.from("group_members").select("user_id, group_id, groups!inner(name, is_temporary)").in("user_id",n).eq("groups.is_temporary",!1):{data:[]},o=new Map;(a??[]).forEach(_=>{o.has(_.user_id)||o.set(_.user_id,_.groups?.name??null)});const u=(s??[]).map(_=>({user_id:_.user_id,display_name:_.users?.display_name??"",permanent_group_label:o.get(_.user_id)??null})),{data:d}=await i.from("groups").select("id, name").eq("parent_group_id",e).eq("is_temporary",!0),l=await Promise.all((d??[]).map(async _=>{const{data:y}=await i.from("group_members").select("user_id, users!inner(display_name)").eq("group_id",_.id);return{id:_.id,name:_.name,members:(y??[]).map(f=>({user_id:f.user_id,display_name:f.users?.display_name??""}))}}));return{id:t.id,name:t.name,is_active:t.is_active,members:u,subgroups:l}}async function cr(e){if(!c())throw new Error("Supabase required");if(e.member_user_ids.length>0){const{data:n}=await i.from("group_members").select("user_id, group_id, groups!inner(is_temporary, is_active, parent_group_id)").in("user_id",e.member_user_ids).eq("groups.is_temporary",!0).eq("groups.is_active",!0),a=(n??[]).filter(o=>{const u=o.groups;return!(e.parent_group_id&&(o.group_id===e.parent_group_id||u.parent_group_id===e.parent_group_id))});if(a.length>0){const o=[...new Set(a.map(u=>u.user_id))];throw new Error(`Nageurs déjà dans un groupe temporaire actif: IDs ${o.join(", ")}`)}}if(e.parent_group_id&&e.member_user_ids.length>0){const{data:n}=await i.from("group_members").select("user_id").eq("group_id",e.parent_group_id),a=new Set((n??[]).map(u=>u.user_id)),o=e.member_user_ids.filter(u=>!a.has(u));if(o.length>0)throw new Error(`Nageurs non membres du groupe parent: IDs ${o.join(", ")}`)}const{data:t,error:r}=await i.from("groups").insert({name:e.name.trim(),is_temporary:!0,is_active:!0,parent_group_id:e.parent_group_id??null}).select("id").single();if(r)throw new Error(r.message);const s=t.id;if(e.member_user_ids.length>0){const n=e.member_user_ids.map(o=>({group_id:s,user_id:o})),{error:a}=await i.from("group_members").insert(n);if(a)throw new Error(a.message)}return{id:s}}async function ur(e,t){if(!c())throw new Error("Supabase required");if(!t.length)return;const{data:r}=await i.from("group_members").select("user_id, group_id, groups!inner(is_temporary, is_active, parent_group_id)").in("user_id",t).eq("groups.is_temporary",!0).eq("groups.is_active",!0),s=(r??[]).filter(o=>!(o.group_id===e||o.groups.parent_group_id===e));if(s.length>0){const o=[...new Set(s.map(u=>u.user_id))];throw new Error(`Nageurs déjà dans un groupe temporaire actif: IDs ${o.join(", ")}`)}const n=t.map(o=>({group_id:e,user_id:o})),{error:a}=await i.from("group_members").insert(n);if(a)throw new Error(a.message)}async function dr(e,t){if(!c())throw new Error("Supabase required");const{data:r}=await i.from("groups").select("id").eq("parent_group_id",e).eq("is_temporary",!0),s=[e,...(r??[]).map(a=>a.id)],{error:n}=await i.from("group_members").delete().eq("user_id",t).in("group_id",s);if(n)throw new Error(n.message)}async function lr(e){if(!c())throw new Error("Supabase required");const{error:t}=await i.from("groups").update({is_active:!1}).or(`id.eq.${e},parent_group_id.eq.${e}`).eq("is_temporary",!0);if(t)throw new Error(t.message)}async function _r(e){if(!c())throw new Error("Supabase required");const{data:t}=await i.from("group_members").select("user_id").eq("group_id",e),r=(t??[]).map(n=>n.user_id);if(r.length>0){const{data:n}=await i.from("group_members").select("user_id, groups!inner(is_temporary, is_active)").in("user_id",r).eq("groups.is_temporary",!0).eq("groups.is_active",!0);if(n&&n.length>0)throw new Error("Certains nageurs sont déjà dans un autre groupe temporaire actif.")}const{error:s}=await i.from("groups").update({is_active:!0}).or(`id.eq.${e},parent_group_id.eq.${e}`).eq("is_temporary",!0);if(s)throw new Error(s.message)}async function mr(e){if(!c())throw new Error("Supabase required");const{data:t}=await i.from("groups").select("is_active").eq("id",e).single();if(t?.is_active)throw new Error("Impossible de supprimer un groupe temporaire actif. Désactivez-le d'abord.");await i.from("groups").delete().eq("parent_group_id",e).eq("is_temporary",!0);const{error:r}=await i.from("groups").delete().eq("id",e).eq("is_temporary",!0);if(r)throw new Error(r.message)}async function fr(){if(!c())return[];const{data:e,error:t}=await i.from("competitions").select("*").order("date",{ascending:!0});if(t)throw new Error(t.message);return e??[]}async function gr(e){if(!c())throw new Error("Supabase not available");const{data:{user:t}}=await i.auth.getUser(),{data:r,error:s}=await i.from("competitions").insert({...e,created_by:t?.id}).select().single();if(s)throw new Error(s.message);return r}async function pr(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("competitions").update(t).eq("id",e).select().single();if(s)throw new Error(s.message);return r}async function wr(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("competitions").delete().eq("id",e);if(t)throw new Error(t.message)}async function hr(e){if(!c())return[];const{data:t,error:r}=await i.from("competition_assignments").select("*").eq("competition_id",e);if(r)throw new Error(r.message);return t??[]}async function yr(e,t){if(!c())return;const{error:r}=await i.from("competition_assignments").delete().eq("competition_id",e);if(r)throw new Error(r.message);if(t.length>0){const s=t.map(a=>({competition_id:e,athlete_id:a})),{error:n}=await i.from("competition_assignments").insert(s);if(n)throw new Error(n.message)}}async function Sr(e){if(!c())return[];let t=i.from("competition_assignments").select("competition_id");e&&(t=t.eq("athlete_id",e));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return(r??[]).map(n=>n.competition_id)}async function U(){const{data:{session:e}}=await i.auth.getSession(),t=e?.user?.app_metadata?.app_user_id;if(!t)throw new Error("User ID not found");return t}async function Er(e){if(!c())return[];const t=await U(),{data:r,error:s}=await i.from("competition_races").select("*").eq("competition_id",e).eq("athlete_id",t).order("race_day",{ascending:!0}).order("start_time",{ascending:!0}).order("sort_order",{ascending:!0});if(s)throw new Error(s.message);return r??[]}async function br(e){if(!c())throw new Error("Supabase not available");const t=await U(),{data:r,error:s}=await i.from("competition_races").insert({...e,athlete_id:t}).select().single();if(s)throw new Error(s.message);return r}async function vr(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("competition_races").update(t).eq("id",e).select().single();if(s)throw new Error(s.message);return r}async function Ir(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("competition_races").delete().eq("id",e);if(t)throw new Error(t.message)}async function Tr(){if(!c())return[];const{data:e,error:t}=await i.from("routine_templates").select("*, steps:routine_steps(*)").order("created_at",{ascending:!1});if(t)throw new Error(t.message);return(e??[]).map(r=>({...r,steps:(r.steps??[]).sort((s,n)=>s.sort_order-n.sort_order)}))}async function qr(e,t){if(!c())throw new Error("Supabase not available");const r=await U(),{data:s,error:n}=await i.from("routine_templates").insert({athlete_id:r,name:e}).select().single();if(n)throw new Error(n.message);const a=s;if(t.length>0){const o=t.map((l,_)=>({routine_id:a.id,offset_minutes:l.offset_minutes,label:l.label,sort_order:l.sort_order??_})),{data:u,error:d}=await i.from("routine_steps").insert(o).select();if(d)throw new Error(d.message);a.steps=(u??[]).sort((l,_)=>l.sort_order-_.sort_order)}else a.steps=[];return a}async function Nr(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("routine_templates").delete().eq("id",e);if(t)throw new Error(t.message)}async function xr(e){if(!c())return[];const t=await U(),{data:r,error:s}=await i.from("competition_races").select("id").eq("competition_id",e).eq("athlete_id",t);if(s)throw new Error(s.message);const n=(r??[]).map(u=>u.id);if(n.length===0)return[];const{data:a,error:o}=await i.from("race_routines").select("*").in("race_id",n);if(o)throw new Error(o.message);return a??[]}async function Cr(e,t){if(!c())throw new Error("Supabase not available");await i.from("race_routines").delete().eq("race_id",e);const{error:r}=await i.from("race_routines").insert({race_id:e,routine_id:t});if(r)throw new Error(r.message)}async function Rr(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("race_routines").delete().eq("race_id",e);if(t)throw new Error(t.message)}async function Ar(){if(!c())return[];const{data:e,error:t}=await i.from("checklist_templates").select("*, items:checklist_items(*)").order("created_at",{ascending:!1});if(t)throw new Error(t.message);return(e??[]).map(r=>({...r,items:(r.items??[]).sort((s,n)=>s.sort_order-n.sort_order)}))}async function kr(e,t){if(!c())throw new Error("Supabase not available");const r=await U(),{data:s,error:n}=await i.from("checklist_templates").insert({athlete_id:r,name:e}).select().single();if(n)throw new Error(n.message);const a=s;if(t.length>0){const o=t.map((l,_)=>({checklist_id:a.id,label:l.label,sort_order:l.sort_order??_})),{data:u,error:d}=await i.from("checklist_items").insert(o).select();if(d)throw new Error(d.message);a.items=(u??[]).sort((l,_)=>l.sort_order-_.sort_order)}else a.items=[];return a}async function Or(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("checklist_templates").delete().eq("id",e);if(t)throw new Error(t.message)}async function Dr(e){if(!c())return null;const{data:t,error:r}=await i.from("competition_checklists").select("*").eq("competition_id",e).maybeSingle();if(r)throw new Error(r.message);if(!t)return null;const s=t,{data:n,error:a}=await i.from("competition_checklist_checks").select("*").eq("competition_checklist_id",s.id);if(a)throw new Error(a.message);return{checklist:s,checks:n??[]}}async function Mr(e,t){if(!c())throw new Error("Supabase not available");const r=await U();await i.from("competition_checklists").delete().eq("competition_id",e).eq("athlete_id",r);const{data:s,error:n}=await i.from("competition_checklists").insert({competition_id:e,athlete_id:r,checklist_template_id:t}).select().single();if(n)throw new Error(n.message);const a=s,{data:o,error:u}=await i.from("checklist_items").select("id").eq("checklist_id",t);if(u)throw new Error(u.message);if(o&&o.length>0){const d=o.map(_=>({competition_checklist_id:a.id,checklist_item_id:_.id,checked:!1})),{error:l}=await i.from("competition_checklist_checks").insert(d);if(l)throw new Error(l.message)}return a}async function Ur(e,t){if(!c())throw new Error("Supabase not available");const{error:r}=await i.from("competition_checklist_checks").update({checked:t,checked_at:t?new Date().toISOString():null}).eq("id",e);if(r)throw new Error(r.message)}async function Gr(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("competition_checklists").delete().eq("id",e);if(t)throw new Error(t.message)}async function oe(e){if(!c())return[];let t=i.from("objectives").select("*, competitions(name, date)").order("created_at",{ascending:!1});e&&(t=t.eq("athlete_id",e));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return(r??[]).map(n=>({id:n.id,athlete_id:n.athlete_id,competition_id:n.competition_id,event_code:n.event_code,pool_length:n.pool_length,target_time_seconds:n.target_time_seconds!=null?Number(n.target_time_seconds):null,text:n.text,created_by:n.created_by,created_at:n.created_at,competition_name:n.competitions?.name??null,competition_date:n.competitions?.date??null}))}async function Fr(){if(!c())return[];const{data:{user:e}}=await i.auth.getUser();return e?oe(e.id):[]}async function Pr(e){if(!c())throw new Error("Supabase not available");const{data:{user:t}}=await i.auth.getUser(),{data:r,error:s}=await i.from("objectives").insert({...e,created_by:t?.id}).select().single();if(s)throw new Error(s.message);return r}async function Hr(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("objectives").update(t).eq("id",e).select().single();if(s)throw new Error(s.message);return r}async function Lr(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("objectives").delete().eq("id",e);if(t)throw new Error(t.message)}async function jr(){if(!c())return new Map;const{data:e,error:t}=await i.rpc("get_objectives_counts_by_user");if(t)throw new Error(t.message);const r=new Map;for(const s of e??[])r.set(s.user_id,Number(s.objectives_count));return r}async function $r(e){if(!c())return[];let t=i.from("planned_absences").select("*");e?.userId&&(t=t.eq("user_id",e.userId)),e?.from&&(t=t.gte("date",e.from)),e?.to&&(t=t.lte("date",e.to));const{data:r,error:s}=await t.order("date",{ascending:!0});if(s)throw new Error(s.message);return r??[]}async function Br(){if(!c())return[];const{data:e,error:t}=await i.from("planned_absences").select("*").order("date",{ascending:!0});if(t)throw new Error(t.message);return e??[]}async function Wr(e,t){if(!c())throw new Error("Supabase not available");const{data:{session:r}}=await i.auth.getSession(),s=r?.user?.app_metadata?.app_user_id;if(!s)throw new Error("User ID not found");const{data:n,error:a}=await i.from("planned_absences").upsert({user_id:s,date:e,reason:t??null},{onConflict:"user_id,date"}).select().single();if(a)throw new Error(a.message);return n}async function zr(e){if(!c())return;const{data:{session:t}}=await i.auth.getSession(),r=t?.user?.app_metadata?.app_user_id;if(!r)return;const{error:s}=await i.from("planned_absences").delete().eq("user_id",r).eq("date",e);if(s)throw new Error(s.message)}async function Xr(e){if(!c())return[];let t=i.from("training_cycles").select("*, start_comp:competitions!start_competition_id(name, date), end_comp:competitions!end_competition_id(name, date)").order("created_at",{ascending:!1});e?.athleteId&&(t=t.eq("athlete_id",e.athleteId)),e?.groupId&&(t=t.eq("group_id",e.groupId));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return(r??[]).map(n=>({id:n.id,group_id:n.group_id,athlete_id:n.athlete_id,start_competition_id:n.start_competition_id,end_competition_id:n.end_competition_id,start_date:n.start_date,name:n.name,notes:n.notes,created_by:n.created_by,created_at:n.created_at,start_competition_name:n.start_comp?.name??null,start_competition_date:n.start_comp?.date??null,end_competition_name:n.end_comp?.name??null,end_competition_date:n.end_comp?.date??null}))}async function Vr(e){if(!c())throw new Error("Supabase not available");const{data:{user:t}}=await i.auth.getUser(),{data:r,error:s}=await i.from("training_cycles").insert({...e,created_by:t?.id}).select().single();if(s)throw new Error(s.message);return r}async function Yr(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("training_cycles").update(t).eq("id",e).select().single();if(s)throw new Error(s.message);return r}async function Jr(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("training_cycles").delete().eq("id",e);if(t)throw new Error(t.message)}async function Kr(e){if(!c())return[];const{data:t,error:r}=await i.from("training_weeks").select("*").eq("cycle_id",e).order("week_start",{ascending:!0});if(r)throw new Error(r.message);return t??[]}async function Qr(e){if(!c())throw new Error("Supabase not available");const{data:t,error:r}=await i.from("training_weeks").upsert(e,{onConflict:"cycle_id,week_start"}).select().single();if(r)throw new Error(r.message);return t}async function Zr(e){if(!c())throw new Error("Supabase not available");if(e.length===0)return[];const{data:t,error:r}=await i.from("training_weeks").upsert(e,{onConflict:"cycle_id,week_start"}).select();if(r)throw new Error(r.message);return t??[]}async function es(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("training_weeks").delete().eq("id",e);if(t)throw new Error(t.message)}async function ts(e){if(!c())return[];const{data:t,error:r}=await i.from("interviews").select("*").eq("athlete_id",e).order("date",{ascending:!1});if(r)throw new Error(r.message);return t??[]}async function rs(){if(!c())return[];const{data:{user:e}}=await i.auth.getUser();if(!e)return[];const t=e.app_metadata?.app_user_id;if(!t)return[];const{data:r,error:s}=await i.from("interviews").select("*").eq("athlete_id",t).order("date",{ascending:!1});if(s)throw new Error(s.message);return r??[]}async function ss(e){if(!c())throw new Error("Supabase not available");const{data:{user:t}}=await i.auth.getUser(),{data:r,error:s}=await i.from("interviews").insert({athlete_id:e.athlete_id,date:e.date??new Date().toISOString().slice(0,10),current_cycle_id:e.current_cycle_id??null,status:"draft_athlete",created_by:t?.id}).select().single();if(s)throw new Error(s.message);return r}async function ns(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("interviews").update(t).eq("id",e).eq("status","draft_athlete").select().single();if(s)throw new Error(s.message);return r}async function is(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.rpc("submit_interview_to_coach",{p_interview_id:e});if(t)throw new Error(t.message)}async function as(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("interviews").update(t).eq("id",e).eq("status","draft_coach").select().single();if(s)throw new Error(s.message);return r}async function os(e){if(!c())throw new Error("Supabase not available");const{data:t,error:r}=await i.from("interviews").update({status:"sent",sent_at:new Date().toISOString()}).eq("id",e).eq("status","draft_coach").select().single();if(r)throw new Error(r.message);return t}async function cs(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.rpc("sign_interview",{p_interview_id:e});if(t)throw new Error(t.message)}async function us(e,t,r){if(!c())return null;let s=i.from("interviews").select("*").eq("athlete_id",e).eq("status","signed").lte("date",t).order("date",{ascending:!1}).limit(1);r&&(s=s.neq("id",r));const{data:n,error:a}=await s.maybeSingle();if(a)throw new Error(a.message);return n??null}async function ds(e){if(!c())throw new Error("Supabase not available");const{error:t}=await i.from("interviews").delete().eq("id",e);if(t)throw new Error(t.message)}async function ls(){if(!c())return[];const{data:e,error:t}=await i.from("interviews").select("*, athlete:users!athlete_id(display_name)").neq("status","signed").order("date",{ascending:!0});if(t)throw new Error(t.message);return(e??[]).map(r=>({...r,athlete_name:r.athlete?.display_name??"?",athlete:void 0}))}async function H(){if(!c())return[];const{data:e,error:t}=await i.from("training_slots").select("*").eq("is_active",!0).order("day_of_week").order("start_time");if(t)throw new Error(t.message);if(!e||e.length===0)return[];const r=e.map(o=>o.id),{data:s,error:n}=await i.from("training_slot_assignments").select("*, groups:group_id(name), coach:coach_id(display_name)").in("slot_id",r);if(n)throw new Error(n.message);const a=new Map;for(const o of s??[]){const u={id:o.id,slot_id:o.slot_id,group_id:o.group_id,group_name:o.groups?.name??"?",coach_id:o.coach_id,coach_name:o.coach?.display_name??"?",lane_count:o.lane_count},d=a.get(o.slot_id)??[];d.push(u),a.set(o.slot_id,d)}return e.map(o=>({id:o.id,day_of_week:o.day_of_week,start_time:o.start_time,end_time:o.end_time,location:o.location,is_active:o.is_active,created_by:o.created_by,created_at:o.created_at,assignments:a.get(o.id)??[]}))}async function _s(e){return(await H()).filter(r=>r.assignments.some(s=>s.group_id===e))}async function ms(e){if(!c())throw new Error("Supabase not available");const{data:t,error:r}=await i.from("training_slots").insert({day_of_week:e.day_of_week,start_time:e.start_time,end_time:e.end_time,location:e.location}).select().single();if(r)throw new Error(r.message);const s=e.assignments.map(a=>({slot_id:t.id,group_id:a.group_id,coach_id:a.coach_id,lane_count:a.lane_count}));if(s.length>0){const{error:a}=await i.from("training_slot_assignments").insert(s);if(a)throw new Error(a.message)}return(await H()).find(a=>a.id===t.id)}async function fs(e,t){if(!c())throw new Error("Supabase not available");const{error:r}=await i.from("training_slots").update({day_of_week:t.day_of_week,start_time:t.start_time,end_time:t.end_time,location:t.location}).eq("id",e);if(r)throw new Error(r.message);const{error:s}=await i.from("training_slot_assignments").delete().eq("slot_id",e);if(s)throw new Error(s.message);const n=t.assignments.map(o=>({slot_id:e,group_id:o.group_id,coach_id:o.coach_id,lane_count:o.lane_count}));if(n.length>0){const{error:o}=await i.from("training_slot_assignments").insert(n);if(o)throw new Error(o.message)}return(await H()).find(o=>o.id===e)}async function gs(e){if(!c())return;const{error:t}=await i.from("training_slots").update({is_active:!1}).eq("id",e);if(t)throw new Error(t.message)}async function ps(e){if(!c())return[];let t=i.from("training_slot_overrides").select("*").order("override_date",{ascending:!0});e?.slotId&&(t=t.eq("slot_id",e.slotId)),e?.fromDate&&(t=t.gte("override_date",e.fromDate));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function ws(e){if(!c())throw new Error("Supabase not available");const{data:t,error:r}=await i.from("training_slot_overrides").upsert({slot_id:e.slot_id,override_date:e.override_date,status:e.status,new_start_time:e.new_start_time??null,new_end_time:e.new_end_time??null,new_location:e.new_location??null,reason:e.reason??null},{onConflict:"slot_id,override_date"}).select().single();if(r)throw new Error(r.message);return t}async function hs(e){if(!c())return;const{error:t}=await i.from("training_slot_overrides").delete().eq("id",e);if(t)throw new Error(t.message)}async function ce(e){if(!c())return[];const{data:t,error:r}=await i.from("swimmer_training_slots").select("*").eq("user_id",e).eq("is_active",!0).order("day_of_week").order("start_time");if(r)throw new Error(r.message);return t??[]}async function ys(e){if(!c())return!1;const{count:t,error:r}=await i.from("swimmer_training_slots").select("id",{count:"exact",head:!0}).eq("user_id",e).eq("is_active",!0);if(r)throw new Error(r.message);return(t??0)>0}async function ue(e,t,r){if(!c())throw new Error("Supabase not available");const{data:s,error:n}=await i.from("training_slot_assignments").select("id, slot_id, training_slots!inner(day_of_week, start_time, end_time, location, is_active)").eq("group_id",t);if(n)throw new Error(n.message);const a=(s??[]).filter(u=>u.training_slots?.is_active).map(u=>({user_id:e,source_assignment_id:u.id,day_of_week:u.training_slots.day_of_week,start_time:u.training_slots.start_time,end_time:u.training_slots.end_time,location:u.training_slots.location,created_by:r}));if(a.length===0)return[];const{error:o}=await i.from("swimmer_training_slots").insert(a);if(o)throw new Error(o.message);return ce(e)}async function Ss(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("swimmer_training_slots").insert({user_id:e.user_id,source_assignment_id:e.source_assignment_id??null,day_of_week:e.day_of_week,start_time:e.start_time,end_time:e.end_time,location:e.location,created_by:t}).select().single();if(s)throw new Error(s.message);return r}async function Es(e,t){if(!c())throw new Error("Supabase not available");const{data:r,error:s}=await i.from("swimmer_training_slots").update(t).eq("id",e).select().single();if(s)throw new Error(s.message);return r}async function bs(e){if(!c())return;const{error:t}=await i.from("swimmer_training_slots").update({is_active:!1}).eq("id",e);if(t)throw new Error(t.message)}async function vs(e,t,r){if(!c())throw new Error("Supabase not available");const{error:s}=await i.from("swimmer_training_slots").update({is_active:!1}).eq("user_id",e).eq("is_active",!0);if(s)throw new Error(s.message);return ue(e,t,r)}async function Is(e){if(!c())return[];const{data:t,error:r}=await i.from("swimmer_training_slots").select("user_id, id").eq("source_assignment_id",e).eq("is_active",!0);if(r)throw new Error(r.message);return(t??[]).map(s=>({user_id:s.user_id,slot_id:s.id}))}const xs={async getCapabilities(){return c()?{mode:"supabase",version:null,timesheet:{available:!0},messaging:{available:!0}}:{mode:"local",version:null,timesheet:{available:!0},messaging:{available:!0}}},async syncSession(e){if(c()){const n=Ee(e),{data:a,error:o}=await i.from("dim_sessions").insert(n).select("id").single();if(o)throw new Error(o.message);return{status:"ok",sessionId:a.id}}await N(300);const t=this._get(m.SESSIONS)||[],r=Date.now(),s={...e,id:r,created_at:new Date().toISOString()};return this._save(m.SESSIONS,[...t,s]),{status:"ok",sessionId:r}},async ensureSwimSession(e){if(!c())throw new Error("Supabase required");let t=i.from("dim_sessions").select("id").eq("session_date",e.date).eq("time_slot",e.slot);e.athleteId?t=t.eq("athlete_id",Number(e.athleteId)):t=t.eq("athlete_name",e.athleteName);const{data:r}=await t.maybeSingle();if(r?.id)return r.id;const s={athlete_name:e.athleteName,session_date:e.date,time_slot:e.slot,distance:0,duration:0,rpe:5,performance:5,engagement:5,fatigue:5};e.athleteId&&(s.athlete_id=Number(e.athleteId));const{data:n,error:a}=await i.from("dim_sessions").insert(s).select("id").single();if(a)throw new Error(a.message);return n.id},async getSessions(e,t){const r=t!=null&&String(t)!=="";if(c()){let n=i.from("dim_sessions").select("*").order("session_date",{ascending:!1});r?n=n.eq("athlete_id",Number(t)):n=n.eq("athlete_name",e);const{data:a,error:o}=await n;if(o)throw new Error(o.message);return(a??[]).map(be).filter(u=>!!u)}return await N(200),(this._get(m.SESSIONS)||[]).filter(n=>r&&n.athlete_id?String(n.athlete_id)===String(t):n.athlete_name.toLowerCase()===e.toLowerCase()).map(n=>({...n,effort:O(n.effort)??n.effort,feeling:O(n.feeling)??n.feeling,rpe:O(n.rpe??null),performance:O(n.performance??null),engagement:O(n.engagement??null),fatigue:O(n.fatigue??null)})).sort((n,a)=>new Date(a.date).getTime()-new Date(n.date).getTime())},async updateSession(e){if(c()){const n={athlete_name:e.athlete_name,session_date:e.date,time_slot:e.slot,distance:e.distance,duration:e.duration,rpe:M(e.effort),performance:M(e.performance??e.feeling),engagement:M(e.engagement??e.feeling),fatigue:M(e.feeling),comments:e.comments},{error:a}=await i.from("dim_sessions").update(n).eq("id",e.id);if(a)throw new Error(a.message);return{status:"updated"}}await N(200);const t=this._get(m.SESSIONS)||[],r=t.findIndex(n=>n.id===e.id);if(r===-1)return{status:"missing"};const s=[...t];return s[r]={...s[r],...e},this._save(m.SESSIONS,s),{status:"updated"}},async deleteSession(e){if(c()){const{error:s}=await i.from("dim_sessions").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}await N(200);const r=(this._get(m.SESSIONS)||[]).filter(s=>s.id!==e);return this._save(m.SESSIONS,r),{status:"deleted"}},async seedDemoData(){const e=[{id:1,nom_exercice:"Squat",description:"Flexion des jambes",exercise_type:"strength"},{id:2,nom_exercice:"Développé Couché",description:"Poussée horizontale",exercise_type:"strength"},{id:3,nom_exercice:"Tractions",description:"Tirage vertical",exercise_type:"strength"},{id:4,nom_exercice:"Rotations Élastique",description:"Coiffe des rotateurs",exercise_type:"warmup"}];this._save(m.EXERCISES,e);const t={id:101,title:"Full Body A",description:"Séance globale",cycle:"Endurance",items:[{exercise_id:4,exercise_name:"Rotations Élastique",category:"warmup",order_index:0,sets:2,reps:15,rest_seconds:30,percent_1rm:0},{exercise_id:1,exercise_name:"Squat",category:"strength",order_index:1,sets:4,reps:10,rest_seconds:90,percent_1rm:70},{exercise_id:2,exercise_name:"Développé Couché",category:"strength",order_index:2,sets:4,reps:10,rest_seconds:90,percent_1rm:70}]};this._save(m.STRENGTH_SESSIONS,[t]);const r={id:201,name:"VMA 100",description:"Travail de vitesse",created_by:1,items:[{label:"Échauffement 4N",distance:400,intensity:"Souple",notes:"Progressif"},{label:"Corps NL",distance:1e3,intensity:"Max",notes:"10x100 départ 1:30"}]};this._save(m.SWIM_SESSIONS,[r]);const s=new Date().toISOString().split("T")[0];return await this.assignments_create({session_id:101,assignment_type:"strength",target_athlete:"Camille",assigned_date:s}),{status:"seeded"}},_get(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null},_save(e,t){localStorage.setItem(e,JSON.stringify(t))},resetCache(){Object.values(m).forEach(e=>localStorage.removeItem(e)),window.location.reload()},async getHallOfFame(e){return Mt(e)},async getClubRecords(e){return Ut(e)},async getClubRecordSwimmers(){return Gt()},async createClubRecordSwimmer(e){return Ft(e)},async updateClubRecordSwimmer(e,t){return Pt(e,t)},async updateClubRecordSwimmerForUser(e,t){return Ht(e,t)},async importClubRecords(){return Lt()},async getImportLogs(e){return jt(e)},async importSingleSwimmer(e,t){return $t(e,t)},async getSwimRecords(e){return Bt(e)},async upsertSwimRecord(e){return Wt(e)},async getSwimmerPerformances(e){return zt(e)},async importSwimmerPerformances(e){return Xt(e)},async recalculateClubRecords(){return Vt()},async getClubRanking(e){return Jt(e)},async syncClubRecordSwimmersFromUsers(){return Yt()},async mergeClubRecordSwimmers(e,t){return Qt(e,t)},async getAppSettings(e){return Kt(e)},async updateAppSettings(e,t){return Zt(e,t)},async getExercises(){return at()},async createExercise(e){return ot(e)},async updateExercise(e){return ct(e)},async deleteExercise(e){return ut(e)},async getStrengthSessions(){return X()},async createStrengthSession(e){return dt(e)},async updateStrengthSession(e){return ie(e)},async persistStrengthSessionOrder(e){return lt(e)},async deleteStrengthSession(e){return _t(e)},async startStrengthRun(e){return mt(e)},async logStrengthSet(e){return ft(e)},async updateStrengthRun(e){return gt(e)},async deleteStrengthRun(e){return pt(e)},async saveStrengthRun(e){return wt(e)},async getStrengthHistory(e,t){return ht(e,t)},async getStrengthHistoryAggregate(e,t){return yt(e,t)},async get1RM(e){return F(e)},async update1RM(e){return P(e)},async updateExerciseNote(e){return St(e)},async getStrengthFolders(e){return Et(e)},async createStrengthFolder(e,t){return bt(e,t)},async renameStrengthFolder(e,t){return vt(e,t)},async deleteStrengthFolder(e){return It(e)},async moveToFolder(e,t,r){return Tt(e,t,r)},async getSwimExerciseLogs(e){return er(e)},async getSwimExerciseLogsHistory(e,t){return tr(e,t)},async saveSwimExerciseLogs(e,t,r){return rr(e,t,r)},async createStandaloneSwimLog(e,t){return sr(e,t)},async updateSwimExerciseLog(e,t){return nr(e,t)},async deleteSwimExerciseLog(e){return ir(e)},async getSwimCatalog(){return W()},async createSwimSession(e){return Se(e)},async deleteSwimSession(e){return ye(e)},async archiveSwimSession(e,t){return he(e,t)},async moveSwimSession(e,t){return we(e,t)},async migrateLocalStorageArchive(e){return pe(e)},async generateShareToken(e){return ge(e)},async getSharedSession(e){return fe(e)},async getAssignmentsForCoach(){return qt()},async getCoachAssignments(e){return Rt(e)},async getAssignments(e,t,r){return Nt(e,t,r)},async assignments_create(e){const t=de.getState().userId;return xt(e,t)},async assignments_delete(e){return Ct(e)},async bulkCreateSlotAssignments(e){return At(e)},async getSlotAssignments(e){return kt(e)},async updateSlotVisibility(e){return Ot(e)},async deleteSlotAssignments(e){return Dt(e)},async getNotifications(e){return Ke(e)},async notifications_send(e){return Qe(e)},async markNotificationRead(e){return Ze(e)},async notifications_list(e){return et(e)},async notifications_mark_read(e){return tt(e)},async listTimesheetShifts(e){return Pe(e)},async listTimesheetLocations(){return He()},async createTimesheetLocation(e){return Le(e)},async deleteTimesheetLocation(e){return je(e)},async listTimesheetCoaches(){return $e()},async createTimesheetShift(e){return Be(e)},async updateTimesheetShift(e){return We(e)},async deleteTimesheetShift(e){return ze(e)},async listTimesheetGroupLabels(){return Xe()},async createTimesheetGroupLabel(e){return Ve(e)},async deleteTimesheetGroupLabel(e){return Ye(e)},async listPermanentGroupsForTimesheet(){return Je()},async getTemporaryGroups(){return ar()},async getTemporaryGroupDetail(e){return or(e)},async createTemporaryGroup(e){return cr(e)},async addTemporaryGroupMembers(e,t){return ur(e,t)},async removeTemporaryGroupMember(e,t){return dr(e,t)},async deactivateTemporaryGroup(e){return lr(e)},async reactivateTemporaryGroup(e){return _r(e)},async deleteTemporaryGroup(e){return mr(e)},async getCompetitions(){return fr()},async createCompetition(e){return gr(e)},async updateCompetition(e,t){return pr(e,t)},async deleteCompetition(e){return wr(e)},async getCompetitionAssignments(e){return hr(e)},async setCompetitionAssignments(e,t){return yr(e,t)},async getMyCompetitionIds(e){return Sr(e)},async getCompetitionRaces(e){return Er(e)},async createCompetitionRace(e){return br(e)},async updateCompetitionRace(e,t){return vr(e,t)},async deleteCompetitionRace(e){return Ir(e)},async getRoutineTemplates(){return Tr()},async createRoutineTemplate(e,t){return qr(e,t)},async deleteRoutineTemplate(e){return Nr(e)},async getRaceRoutines(e){return xr(e)},async setRaceRoutine(e,t){return Cr(e,t)},async removeRaceRoutine(e){return Rr(e)},async getChecklistTemplates(){return Ar()},async createChecklistTemplate(e,t){return kr(e,t)},async deleteChecklistTemplate(e){return Or(e)},async getCompetitionChecklist(e){return Dr(e)},async applyChecklistTemplate(e,t){return Mr(e,t)},async toggleChecklistCheck(e,t){return Ur(e,t)},async removeCompetitionChecklist(e){return Gr(e)},async getObjectives(e){return oe(e)},async getAthleteObjectives(){return Fr()},async createObjective(e){return Pr(e)},async updateObjective(e,t){return Hr(e,t)},async deleteObjective(e){return Lr(e)},async getObjectivesCountsByUser(){return jr()},async getPlannedAbsences(e){return $r(e)},async getMyPlannedAbsences(){return Br()},async setPlannedAbsence(e,t){return Wr(e,t)},async removePlannedAbsence(e){return zr(e)},async getTrainingCycles(e){return Xr(e)},async createTrainingCycle(e){return Vr(e)},async updateTrainingCycle(e,t){return Yr(e,t)},async deleteTrainingCycle(e){return Jr(e)},async getTrainingWeeks(e){return Kr(e)},async upsertTrainingWeek(e){return Qr(e)},async bulkUpsertTrainingWeeks(e){return Zr(e)},async deleteTrainingWeek(e){return es(e)},async getInterviews(e){return ts(e)},async getMyInterviews(){return rs()},async createInterview(e){return ss(e)},async updateInterviewAthleteSections(e,t){return ns(e,t)},async submitInterviewToCoach(e){return is(e)},async updateInterviewCoachSections(e,t){return as(e,t)},async sendInterviewToAthlete(e){return os(e)},async signInterview(e){return cs(e)},async deleteInterview(e){return ds(e)},async getPreviousInterview(e,t,r){return us(e,t,r)},async getAllPendingInterviews(){return ls()},async getProfile(e){return ve(e)},async updateProfile(e){return Ie(e)},async getAthletes(){return Te()},async getGroups(){return qe()},async getUpcomingBirthdays(e){return Ne(e)},async listUsers(e){return xe(e)},async createCoach(e){return Ce(e)},async updateUserRole(e){return Re(e)},async disableUser(e){return Ae(e)},async getPendingApprovals(){return ke()},async approveUser(e){return Oe(e)},async rejectUser(e){return De(e)},async authPasswordUpdate(e){return Me(e)},async uploadAvatar(e){return Ue(e)},async deleteAvatar(e){return Ge(e)},async getRecentSessionsAllAthletes(e){return Fe(e)},async getTrainingSlots(){return H()},async getTrainingSlotsForGroup(e){return _s(e)},async createTrainingSlot(e){return ms(e)},async updateTrainingSlot(e,t){return fs(e,t)},async deleteTrainingSlot(e){return gs(e)},async getSlotOverrides(e){return ps(e)},async createSlotOverride(e){return ws(e)},async deleteSlotOverride(e){return hs(e)},async getSwimmerSlots(e){return ce(e)},async hasCustomSlots(e){return ys(e)},async initSwimmerSlots(e,t,r){return ue(e,t,r)},async createSwimmerSlot(e,t){return Ss(e,t)},async updateSwimmerSlot(e,t){return Es(e,t)},async deleteSwimmerSlot(e){return bs(e)},async resetSwimmerSlots(e,t,r){return vs(e,t,r)},async getSwimmersAffectedBySlot(e){return Is(e)}};export{xs as a,Xr as b,Ns as c,Dt as d,ls as g,Ot as u};
