import{r as i,j as e,c as Mt,u as De,d as ve,a as Ie}from"./vendor-query-BiSH4r2z.js";import{a as U}from"./api-ByDHTn7u.js";import{c as _e,b as Qt,W as Dt,X as st,F as _t,u as zt,d as Ht,s as Ue,B as Jt,T as Ut}from"./index-Dcmf1d-1.js";import{D as ot,a as it,b as at,c as lt}from"./dialog-5LIpxght.js";import{P as Vt,C as Ve,M as Yt,a as Wt,b as Xt}from"./CalendarGrid-B34pNY-U.js";import{A as Pe,B as Gt}from"./BottomActionBar-CBNyyXUC.js";import{a as Zt,s as es,l as ct}from"./animations-CrcLFysI.js";import{d as dt}from"./design-tokens-CKgCpdH6.js";import{C as At}from"./chevron-right-EtqRMhxc.js";import{m as be}from"./proxy-Dh0N-Z8G.js";import{C as ts}from"./chevron-down-BpGhIyvM.js";import{C as nt}from"./index-oQ_qoVj8.js";import{P as $e}from"./plus-DMTZpefR.js";import{A as ut,H as mt,f as Ye,p as ss}from"./swimConsultationUtils-B1DFdaDJ.js";import{T as We}from"./trash-2-BBUIfqrf.js";import{T as xt}from"./timer-1MtZV6IO.js";import{P as ns}from"./pencil-tCJSkUX1.js";import{C as rs}from"./circle-alert-DnQoP_lB.js";import"./vendor-react-BzrpNAyj.js";import"./swim-NeORY_KC.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-HRhBXvrO.js";import"./index-fKAHuk8e.js";import"./chevron-left-Cy4XPbiJ.js";import"./loader-circle-C-sCc20K.js";import"./circle-check-CC-lFlg7.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],is=_e("info",os);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=[["path",{d:"M5 12h14",key:"1ays0h"}]],Ct=_e("minus",as);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],cs=_e("settings-2",ls);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],us=_e("sun",ds);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],pt=_e("user-check",ms);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Ke=_e("user-x",xs),Xe={NL:"",DOS:"",BR:"",PAP:"",QN:""};function ft(t){return String(t).padStart(2,"0")}function bt(t){return`${t.getFullYear()}-${ft(t.getMonth()+1)}-${ft(t.getDate())}`}function gt(t){return new Date(t.getFullYear(),t.getMonth(),1)}function ht(t,n){const r=new Date(t);return r.setDate(r.getDate()+n),r}function Ge(t){return(t.getDay()+6)%7}function Ee(t){const n=Number(t);return Number.isFinite(n)?Math.round(n/1e3*100)/100:0}function ps(t){const n=Number(t);return Number.isFinite(n)?Math.round(n*1e3):0}function fs(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(r=>r.trim()).filter(Boolean).flatMap(r=>{const o=r.replace(/^[•\\-–—]\\s*/,"").trim();return o?[o]:[]}):[]}function bs(t){if(!t)return null;const r=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!r)return null;const o=Number(String(r[1]).replace(",","."));return Number.isFinite(o)?r[2].toLowerCase()==="m"?Ee(o):o:null}function gs(t,n){const r=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,o=String(r||"").toLowerCase();if(o.includes("mat")||o.includes("morning")||o==="am")return"AM";if(o.includes("soir")||o.includes("evening")||o==="pm")return"PM";const p=`${t?.title??""} ${t?.description??""}`.toLowerCase();return p.includes("matin")||p.includes(" am ")||p.includes("(am)")?"AM":p.includes("soir")||p.includes(" pm ")||p.includes("(pm)")?"PM":n===0?"AM":"PM"}function hs(t){const n=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!n)return null;const r=String(n),o=r.length>=10?r.slice(0,10):r;return/\d{4}-\d{2}-\d{2}/.test(o)?o:null}function ys(t){if(Array.isArray(t?.items)){let p=0;for(const m of t.items){const h=Number(m?.distance);if(!Number.isFinite(h)||h<=0)continue;const x=m?.raw_payload,v=Number(x?.exercise_repetitions),y=Number(x?.block_repetitions),S=Number.isFinite(v)&&v>0?v:1,_=Number.isFinite(y)&&y>0?y:1;p+=h*S*_}if(p>0)return Ee(p)}const n=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(n!=null&&Number.isFinite(Number(n))){const p=Number(n);return p>0&&p<=50?p:Ee(p)}const r=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(r!=null&&Number.isFinite(Number(r)))return Number(r);const o=bs(`${t?.title??""} ${t?.description??""}`);return o??null}function Ns(t){if(!Array.isArray(t)||t.length===0)return null;const n={crawl:"NL",dos:"DOS",brasse:"BR",pap:"PAP","4n":"QN"},r={NL:0,DOS:0,BR:0,PAP:0,QN:0};for(const p of t){const m=Number(p?.distance);if(!Number.isFinite(m)||m<=0)continue;const h=p?.raw_payload,x=Number(h?.exercise_repetitions),v=Number(h?.block_repetitions),y=Number.isFinite(x)&&x>0?x:1,S=Number.isFinite(v)&&v>0?v:1,_=m*y*S,W=h?.exercise_stroke??h?.stroke??"crawl",ee=n[String(W).toLowerCase()];ee?r[ee]+=_:r.NL+=_}return Object.values(r).some(p=>p>0)?r:null}function yt(t){const n=Number(t);if(!Number.isFinite(n))return"—";const r=Math.round(n*100)/100,o=String(r);return o.endsWith(".0")?o.slice(0,-2):o}function js(){const t={};for(let n=0;n<7;n++)t[n]={AM:!0,PM:!0};return t}function Ze(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function vs({sessions:t,assignments:n,userId:r,user:o}){const p=`swim-dashboard-v2:${r??o??"anon"}`,m=`${p}:presenceDefaults`,h=`${p}:attendanceOverrides`,x=`${p}:stableFields`,[v,y]=i.useState(()=>js()),[S,_]=i.useState({}),[W,ee]=i.useState(90);i.useEffect(()=>{if(typeof window>"u")return;const l=Ze(window.localStorage.getItem(m));l&&y(l);const c=Ze(window.localStorage.getItem(h));c&&_(c);const u=Ze(window.localStorage.getItem(x));u?.duration&&Number.isFinite(u.duration)&&u.duration>=30&&u.duration<=240&&ee(u.duration)},[m,h,x]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(m,JSON.stringify(v))},[v,m]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(h,JSON.stringify(S))},[S,h]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(x,JSON.stringify({duration:W}))},[W,x]);const oe=i.useMemo(()=>new Date,[]),[de,pe]=i.useState(()=>gt(new Date)),[X,ue]=i.useState(()=>bt(new Date)),[G,d]=i.useState(!1),[b,M]=i.useState(!1),[D,$]=i.useState(!1),[B,me]=i.useState(null),[ge,he]=i.useState(!1),[A,q]=i.useState(null),[L,T]=i.useState(!1),[C,O]=i.useTransition(),R=i.useMemo(()=>(Array.isArray(n)?n:[]).filter(c=>c?.session_type==="swim"),[n]),te=i.useMemo(()=>{const l=new Map;for(const c of R){const u=hs(c);u&&(l.has(u)||l.set(u,[]),l.get(u).push(c))}for(const[c,u]of l.entries())u.sort((N,w)=>Number(N?.id??0)-Number(w?.id??0)),l.set(c,u);return l},[R]),V=i.useMemo(()=>{const l=Array.isArray(t)?t:[],c={};for(const u of l){const N=String(u?.date??"").slice(0,10),w=u?.slot==="Soir"?"PM":"AM";c[`${N}__${w}`]=u}return c},[t]),k=i.useRef(new Map);i.useEffect(()=>{k.current.clear()},[te]);const Q=i.useCallback(l=>{const c=k.current;if(c.has(l))return c.get(l);const u=[{id:`${l}__AM`,iso:l,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${l}__PM`,iso:l,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],N=(te.get(l)??[]).slice().sort((g,F)=>(Number(F.id)||0)-(Number(g.id)||0)),w=new Set;return N.forEach((g,F)=>{const H=g,ne=gs(H,F);if(w.has(ne))return;const J=ne==="AM"?0:1,ke=ys(H),Re=Array.isArray(H?.details)?H.details.map(String):fs(g?.description);u[J]={id:`${l}__${ne}`,iso:l,slotKey:ne,title:String(g?.title??"Séance coach"),km:ke,details:Re,assignmentId:typeof g?.id=="number"?g.id:Number(g?.id)||void 0,isEmpty:!1},w.add(ne)}),c.set(l,u),u},[te]),z=i.useCallback((l,c)=>{const u=Ge(c),N=!!v?.[u]?.[l.slotKey],w=S[l.id];return w==="present"?{status:"present",expected:!0,expectedByDefault:N}:w==="absent"?{status:"absent",expected:!0,expectedByDefault:N}:N?{status:"present",expected:!0,expectedByDefault:N}:{status:"not_expected",expected:!1,expectedByDefault:N}},[S,v]),xe=i.useMemo(()=>gt(de),[de]),Y=i.useMemo(()=>{const l=Ge(xe),c=ht(xe,-l),u=[];for(let N=0;N<42;N++)u.push(ht(c,N));return u},[xe]),we=i.useMemo(()=>{const l={};for(const c of Y){const u=bt(c),N=Q(u);let w=0,g=0;const F=[];for(const H of N){const ne=z(H,c);if(!ne.expected){F.push({slotKey:H.slotKey,expected:!1,completed:!1,absent:!1});continue}w+=1;const J=!!V[H.id],ke=ne.status==="absent";J&&(g+=1),F.push({slotKey:H.slotKey,expected:!0,completed:J,absent:ke})}l[u]={completed:g,total:w,slots:F}}return l},[Y,Q,z,V]),P=i.useMemo(()=>{const[l,c,u]=X.split("-").map(Number);return new Date(l,c-1,u)},[X]),Z=i.useMemo(()=>Q(X),[Q,X]),ie=we[X]||{completed:0,total:2,slots:[{slotKey:"AM",expected:!0,completed:!1,absent:!1},{slotKey:"PM",expected:!0,completed:!1,absent:!1}]},Ae=i.useMemo(()=>{const l=Array.isArray(t)?t:[];let c=0;for(const u of l){const N=String(u?.date??"").slice(0,10),w=u?.slot==="Soir"?"PM":"AM",g=`${N}__${w}`;if(S[g]==="absent")continue;const F=Ge(new Date(N));(v?.[F]?.[w]||S[g]==="present")&&Number.isFinite(Number(u?.distance))&&(c+=Number(u.distance))}return yt(Ee(c))},[t,S,v]),fe=i.useMemo(()=>{const l=Z;let c=0;for(const u of l){const N=z(u,P);if(!N.expected||N.status==="absent")continue;const w=V[u.id];w&&Number.isFinite(Number(w?.distance))&&(c+=Number(w.distance))}return yt(Ee(c))},[Z,z,P,V]),Ce=i.useMemo(()=>B&&V[B]||null,[B,V]),ae=i.useMemo(()=>{const l=Ce||{},c=l?.stroke_distances,u=c?{NL:c.NL?String(c.NL):"",DOS:c.DOS?String(c.DOS):"",BR:c.BR?String(c.BR):"",PAP:c.PAP?String(c.PAP):"",QN:c.QN?String(c.QN):""}:Xe;return{difficulty:l?.effort??null,fatigue_end:l?.fatigue??l?.feeling??null,performance:l?.performance??l?.feeling??null,engagement:l?.engagement??l?.feeling??null,comment:String(l?.comments??""),distanceMeters:Number.isFinite(Number(l?.distance))?Number(l.distance):null,showStrokeDetail:!!(c&&Object.values(c).some(N=>N&&N>0)),strokes:u,exerciseLogs:[]}},[Ce]),[qe,se]=i.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:Xe,exerciseLogs:[]}));return i.useEffect(()=>{const l=Z.find(c=>c.id===B);if(l){const c=l.km!=null?ps(l.km):5e3;let u=Xe;if(l.assignmentId){const w=(n??[]).find(g=>g.id===l.assignmentId);if(w?.items){const g=Ns(w.items);g&&(u={NL:String(g.NL||""),DOS:String(g.DOS||""),BR:String(g.BR||""),PAP:String(g.PAP||""),QN:String(g.QN||"")})}}const N=Object.values(ae.strokes).some(w=>w&&Number(w)>0);se(w=>({...w,...ae,distanceMeters:ae.distanceMeters==null?c:ae.distanceMeters,strokes:N?ae.strokes:u,showStrokeDetail:N||Object.values(u).some(g=>g&&Number(g)>0)}));return}se(c=>({...c,...ae}))},[ae,B,Z,n]),i.useEffect(()=>{G&&L&&ie.total>0&&ie.completed>=ie.total&&(d(!1),me(null),he(!1),T(!1))},[G,L,ie.completed,ie.total]),{today:oe,monthCursor:de,selectedISO:X,drawerOpen:G,settingsOpen:b,infoOpen:D,activeSessionId:B,detailsOpen:ge,selectedDayIndex:A,isPending:C,presenceDefaults:v,attendanceOverrideBySessionId:S,stableDurationMin:W,draftState:qe,gridDates:Y,completionByISO:we,selectedDate:P,sessionsForSelectedDay:Z,selectedDayStatus:ie,globalKm:Ae,dayKm:fe,logsBySessionId:V,setMonthCursor:pe,setSelectedISO:ue,setDrawerOpen:d,setSettingsOpen:M,setInfoOpen:$,setActiveSessionId:me,setDetailsOpen:he,setSelectedDayIndex:q,setPresenceDefaults:y,setAttendanceOverrideBySessionId:_,setStableDurationMin:ee,setDraftState:se,setAutoCloseArmed:T,startTransition:O,getSessionStatus:z,getSessionsForISO:Q}}function et(...t){return t.filter(Boolean).join(" ")}const Nt={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function ws({strokes:t,showStrokeDetail:n,disabled:r=!1,onToggle:o,onChange:p}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:r,onClick:o,className:et("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",r?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(At,{className:et("h-4 w-4 transition-transform",n&&"rotate-90")})]}),n&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(Nt).map(m=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:Nt[m]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:r,value:t[m],onChange:h=>p({...t,[m]:h.target.value}),placeholder:"0",className:et("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",r?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},m))})]})}function E(...t){return t.filter(Boolean).join(" ")}function ks(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function Be(t){const n=Number(t);if(!Number.isFinite(n))return"—";const r=Math.round(n*100)/100,o=String(r);return o.endsWith(".0")?o.slice(0,-2):o}function jt(t){const n=Number(t);return Number.isFinite(n)?Math.round(n/1e3*100)/100:0}function Ss(t){const n=Number(t);return Number.isFinite(n)?Math.round(n*1e3):0}const tt=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],Ms=[{key:"AM",label:"Matin",Icon:us},{key:"PM",label:"Soir",Icon:Yt}];function Te({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function Fe({onClick:t,label:n,children:r,tone:o="neutral",disabled:p}){const m={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:p,className:E("inline-flex items-center justify-center rounded-2xl border p-2 transition",m[o],p&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":n,title:n,children:[r,e.jsx("span",{className:"sr-only",children:n})]})}function Ds(t,n){const r=Number(n);return!Number.isFinite(r)||r<1||r>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[r]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[r]}function _s({plannedMeters:t,valueMeters:n,onChange:r,disabled:o}){const x=Number.isFinite(Number(n))?Number(n):t,v=x-t;return e.jsxs("div",{className:E("mt-4 rounded-3xl border px-4 py-3",o?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:E("text-xs font-semibold",o?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),v!==0&&e.jsx("div",{className:E("text-xs font-semibold px-2 py-0.5 rounded-full",v>0?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"),children:v>0?`+${v}m`:`${v}m`})]}),e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:E("text-xs","text-muted-foreground"),children:["Planifié : ",t,"m (",Be(jt(t))," km)"]})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:o||x-100<0,onClick:()=>r(x-100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",o?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"-100m",children:e.jsx(Ct,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-[140px] text-center",children:[e.jsxs("div",{className:E("text-2xl font-bold",o?"text-muted-foreground":"text-foreground"),children:[x,"m"]}),e.jsxs("div",{className:E("text-sm font-medium mt-0.5",o?"text-muted-foreground":"text-primary"),children:[Be(jt(x))," km"]})]}),e.jsx("button",{type:"button",disabled:o||x+100>3e4,onClick:()=>r(x+100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",o?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"+100m",children:e.jsx($e,{className:"h-5 w-5"})})]})]})}function As({onMark:t}){const[n,r]=i.useState(!1),[o,p]=i.useState("");return n?e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("input",{type:"text",placeholder:"Motif (optionnel)",value:o,onChange:m=>p(m.target.value),className:"flex-1 rounded-md border border-input bg-transparent px-3 py-1.5 text-sm",autoFocus:!0}),e.jsx("button",{type:"button",onClick:()=>{t(o||void 0),r(!1),p("")},className:"rounded-md bg-primary px-3 py-1.5 text-sm font-medium text-primary-foreground",children:"OK"})]}):e.jsx("button",{type:"button",className:"w-full rounded-xl border border-dashed border-muted-foreground/30 p-2.5 mb-3 text-sm text-muted-foreground hover:bg-muted/50 transition-colors",onClick:()=>r(!0),children:"Marquer indisponible"})}function Cs({open:t,selectedDate:n,sessionsForSelectedDay:r,selectedDayStatus:o,dayKm:p,activeSessionId:m,detailsOpen:h,draftState:x,saveState:v,isPending:y,logsBySessionId:S,onClose:_,onDayOffAll:W,onOpenSession:ee,onCloseSession:oe,onToggleDetails:de,onMarkAbsent:pe,onMarkPresent:X,onClearOverride:ue,onSaveFeedback:G,onDraftStateChange:d,getSessionStatus:b,isAbsent:M,absenceReason:D,onMarkDayAbsent:$,onRemoveDayAbsence:B}){const[,me]=Qt(),[ge,he]=i.useState(!1),A=i.useMemo(()=>m&&r.find(q=>q.id===m)||null,[m,r]);return e.jsx(Pe,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(be.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:_}),e.jsx(be.div,{className:E("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:Zt,initial:"hidden",animate:"visible",exit:"exit",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden",children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-primary/15 bg-background px-4 sm:px-5 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground shrink-0",children:e.jsx(Dt,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-sm font-display font-bold uppercase italic tracking-tight text-primary",children:ks(n)})})]}),e.jsx(Fe,{onClick:_,label:"Fermer",children:e.jsx(st,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-lg font-bold text-foreground",children:[p," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",o.total>0&&o.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",o.total>0&&o.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})}),e.jsx(Fe,{onClick:W,label:"OFF (absent journée)",tone:"dark",disabled:y,children:e.jsx(Vt,{className:"h-5 w-5"})})]}),$&&B&&(M?e.jsxs("div",{className:"rounded-xl border border-muted bg-muted/30 p-3 mt-3 mb-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Marqué indisponible"}),e.jsx("button",{type:"button",onClick:B,className:"text-xs text-primary hover:underline",children:"Annuler"})]}),D&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:D})]}):e.jsx("div",{className:"mt-3",children:e.jsx(As,{onMark:$})})),(()=>{const q=[],L=[];for(const C of r)b(C,n).status==="not_expected"?L.push(C):q.push(C);const T=C=>{const O=b(C,n),R=!!S[C.id],te=O.status==="absent",V=O.status==="not_expected",k=te||V,Q=O.expected&&!R&&!te,z=R?"bg-status-success-bg border-status-success/30":k?"bg-sky-50 border-sky-200":Q?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",xe=Ms.find(Y=>Y.key===C.slotKey)?.Icon||Ve;return e.jsx("button",{type:"button",onClick:()=>ee(C.id),className:E("w-full rounded-3xl border px-3 py-3 text-left transition",z,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:E("h-10 w-10 rounded-2xl border flex items-center justify-center",R?"border-status-success/30 bg-status-success-bg":k?"border-sky-200 bg-sky-100":Q?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(xe,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:C.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[C.isEmpty?e.jsx(Te,{children:"Vide"}):e.jsxs(Te,{children:[Be(C.km)," km"]}),R&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(nt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),k&&!R&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),Q&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[V&&e.jsx(Fe,{onClick:Y=>{Y.stopPropagation(),X(C.id)},label:"Je suis venu",disabled:y,children:e.jsx(pt,{className:"h-5 w-5"})}),O.expected&&!R&&!te&&e.jsx(Fe,{onClick:Y=>{Y.stopPropagation(),pe(C.id)},label:"Absent",tone:"sky",disabled:y,children:e.jsx(Ke,{className:"h-5 w-5"})})]})]})},C.id)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4 grid gap-2",children:q.map(T)}),L.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",onClick:()=>he(C=>!C),className:"flex w-full items-center gap-2 rounded-2xl px-3 py-2 text-xs font-semibold text-muted-foreground hover:bg-muted transition",children:[e.jsx(ts,{className:E("h-4 w-4 transition-transform",ge&&"rotate-180")}),"Autres séances (",L.length,")"]}),e.jsx(Pe,{children:ge&&e.jsx(be.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"mt-1 grid gap-2",children:L.map(T)})})})]})]})})(),e.jsx(Pe,{children:A&&e.jsx(be.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:dt.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const q=b(A,n),L=q.status==="absent",T=q.status==="not_expected",C=!!S[A.id],O=q.expected&&!L,R=L?"Annuler":T?"Je suis venu":"Absent",te=L?()=>ue(A.id):T?()=>X(A.id):()=>pe(A.id),V=Ss(A.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:A.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[A.isEmpty?e.jsx(Te,{children:"Vide"}):e.jsxs(Te,{children:[Be(A.km)," km"]}),C?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(nt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):L||T?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx(Fe,{onClick:oe,label:"Retour",children:e.jsx(st,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:te,className:E("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",T?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[T?e.jsx(pt,{className:"h-4 w-4"}):e.jsx(Ke,{className:"h-4 w-4"}),R]}),e.jsxs("button",{type:"button",onClick:de,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(_t,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(Pe,{children:h&&e.jsxs(be.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:dt.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:[A.details?.length?e.jsx("ul",{className:"list-disc pl-5 space-y-1 text-sm text-foreground",children:A.details.map((k,Q)=>e.jsx("li",{children:k},Q))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:A.assignmentId?"Séance coach — détails dans la fiche.":"Aucun détail pour ce créneau."}),e.jsx("div",{className:"mt-3",children:e.jsx("button",{type:"button",onClick:()=>me(A.assignmentId?`/swim-session?assignmentId=${A.assignmentId}`:"/swim-session"),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:A.assignmentId?"Ouvrir la fiche complète":"Saisir mes détails techniques"})})]})}),e.jsxs("div",{className:"px-4 pb-4",children:[!O&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:L?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(be.div,{className:"space-y-4",variants:es,initial:"hidden",animate:"visible",children:[tt.map(k=>{const Q=x[k.key];return e.jsxs(be.div,{className:"space-y-2",variants:ct,children:[e.jsx("div",{className:E("text-sm font-semibold",O?"text-foreground":"text-muted-foreground"),children:k.label}),e.jsx("div",{className:"flex items-center gap-2",children:[1,2,3,4,5].map(z=>{const xe=Q===z;return e.jsx("button",{type:"button",disabled:!O,onClick:()=>d({...x,[k.key]:z}),className:E("h-11 w-11 rounded-2xl border text-sm font-semibold transition",O?xe?Ds(k.mode,z):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:z},z)})})]},k.key)}),e.jsxs(be.div,{className:"space-y-2",variants:ct,children:[e.jsx("div",{className:E("text-sm font-semibold",O?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:x.comment,onChange:k=>d({...x,comment:k.target.value}),disabled:!O,rows:3,placeholder:"Sensations, points techniques…",className:E("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",O?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsx(_s,{plannedMeters:V,valueMeters:x.distanceMeters,onChange:k=>d({...x,distanceMeters:k}),disabled:!O}),e.jsx(ws,{strokes:x.strokes,showStrokeDetail:x.showStrokeDetail,disabled:!O,onToggle:()=>d({...x,showStrokeDetail:!x.showStrokeDetail}),onChange:k=>d({...x,strokes:k})})]})]})})()},A.id)})]}),A&&(()=>{const q=b(A,n),L=q.expected&&q.status!=="absent";return e.jsxs(Gt,{saveState:v,position:"static",children:[e.jsx("button",{type:"button",onClick:G,disabled:y||!L||!tt.every(T=>Number.isInteger(x[T.key])),className:E("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",y||!L?"bg-muted text-muted-foreground cursor-not-allowed":tt.every(T=>Number.isInteger(x[T.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["→"," km"]})]})})()]})})]})})}function Os(...t){return t.filter(Boolean).join(" ")}function Fs(t){try{return new Date(t).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return t}}function Is({userId:t,expanded:n,onToggle:r}){const o=Mt(),{data:p,isLoading:m}=De({queryKey:["swim-exercise-logs-history",t],queryFn:()=>U.getSwimExerciseLogsHistory(t,100),enabled:!!t&&n}),h=ve({mutationFn:({logId:y,patch:S})=>U.updateSwimExerciseLog(y,S),onSuccess:()=>{o.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),x=ve({mutationFn:y=>U.deleteSwimExerciseLog(y),onSuccess:()=>{o.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),v=Ie.useMemo(()=>{if(!p?.length)return[];const y=new Map;for(const S of p){const _=(S.created_at??"").slice(0,10);y.has(_)||y.set(_,[]),y.get(_).push(S)}return Array.from(y.entries()).map(([S,_])=>({date:S,entries:_}))},[p]);return e.jsxs("div",{className:"mt-6",children:[e.jsxs("button",{type:"button",onClick:r,className:"flex w-full items-center justify-between rounded-2xl border border-border px-3 py-2.5 text-sm font-semibold text-foreground hover:bg-muted transition",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(_t,{className:"h-4 w-4"}),"Historique notes techniques"]}),e.jsx(At,{className:Os("h-4 w-4 transition-transform",n&&"rotate-90")})]}),n&&e.jsxs("div",{className:"mt-3 space-y-3",children:[m&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Chargement..."}),!m&&v.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucune note technique enregistree."}),v.map(({date:y,entries:S})=>e.jsxs("div",{className:"rounded-2xl border border-border overflow-hidden",children:[e.jsx("div",{className:"bg-muted/50 px-3 py-2 text-xs font-semibold text-muted-foreground",children:Fs(y)}),e.jsx("div",{className:"divide-y divide-border",children:S.map(_=>e.jsx(Es,{log:_,onSave:W=>h.mutate({logId:_.id,patch:W}),onDelete:()=>x.mutate(_.id),saving:h.isPending},_.id))})]},y))]})]})}function Es({log:t,onSave:n,onDelete:r,saving:o}){const[p,m]=i.useState(!1),[h,x]=i.useState({notes:t.notes??"",tempo:t.tempo,split_times:t.split_times,stroke_count:t.stroke_count}),[v,y]=i.useState([]),S=()=>{x({notes:t.notes??"",tempo:t.tempo,split_times:[...t.split_times],stroke_count:[...t.stroke_count]}),y(t.split_times.map(d=>Ye(d.time_seconds))),m(!0)},_=()=>m(!1),W=()=>{n({notes:h.notes.trim()||null,tempo:h.tempo,split_times:h.split_times,stroke_count:h.stroke_count}),m(!1)},ee=()=>{x(d=>({...d,split_times:[...d.split_times,{rep:d.split_times.length+1,time_seconds:0}]})),y(d=>[...d,""])},oe=(d,b)=>{y(M=>M.map((D,$)=>$===d?b:D))},de=d=>{const b=ss(v[d]),M=Ye(b);y(D=>D.map(($,B)=>B===d?M:$)),x(D=>({...D,split_times:D.split_times.map(($,B)=>B===d?{...$,time_seconds:b}:$)}))},pe=d=>{x(b=>({...b,split_times:b.split_times.filter((M,D)=>D!==d).map((M,D)=>({...M,rep:D+1}))})),y(b=>b.filter((M,D)=>D!==d))},X=()=>{x(d=>({...d,stroke_count:[...d.stroke_count,{rep:d.stroke_count.length+1,count:0}]}))},ue=(d,b)=>{x(M=>({...M,stroke_count:M.stroke_count.map((D,$)=>$===d?{...D,count:b}:D)}))},G=d=>{x(b=>({...b,stroke_count:b.stroke_count.filter((M,D)=>D!==d).map((M,D)=>({...M,rep:D+1}))}))};return p?e.jsxs("div",{className:"px-3 py-2.5 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:W,disabled:o,className:"p-1.5 rounded-lg text-primary hover:bg-primary/10 transition","aria-label":"Enregistrer",children:e.jsx(nt,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:_,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Annuler",children:e.jsx(st,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:r,className:"p-1.5 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition","aria-label":"Supprimer",children:e.jsx(We,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground min-w-[80px]",children:[e.jsx(ut,{className:"h-3.5 w-3.5"}),"Tempo"]}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:h.tempo??"",onChange:d=>x(b=>({...b,tempo:d.target.value?Number(d.target.value):null})),placeholder:"coups/min",className:"w-24 rounded-xl border border-border bg-background px-2 py-1.5 text-sm text-center outline-none focus:ring-2 focus:ring-foreground/10"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(xt,{className:"h-3.5 w-3.5"}),"Temps"]}),e.jsxs("button",{type:"button",onClick:ee,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx($e,{className:"h-3 w-3"}),"Rep"]})]}),h.split_times.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:h.split_times.map((d,b)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx("input",{type:"text",inputMode:"numeric",value:v[b]??"",onChange:M=>oe(b,M.target.value),onBlur:()=>de(b),placeholder:"ss:cc",className:"w-16 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>pe(b),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx(We,{className:"h-3 w-3"})})]},b))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(mt,{className:"h-3.5 w-3.5"}),"Coups de bras"]}),e.jsxs("button",{type:"button",onClick:X,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx($e,{className:"h-3 w-3"}),"Rep"]})]}),h.stroke_count.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:h.stroke_count.map((d,b)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,value:d.count||"",onChange:M=>ue(b,Number(M.target.value)||0),placeholder:"nb",className:"w-14 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>G(b),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx(We,{className:"h-3 w-3"})})]},b))})]}),e.jsx("textarea",{value:h.notes,onChange:d=>x(b=>({...b,notes:d.target.value})),placeholder:"Notes libres...",rows:2,className:"w-full resize-none rounded-xl border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"})]}):e.jsxs("div",{className:"px-3 py-2.5 space-y-1.5 group",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsx("button",{type:"button",onClick:S,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Modifier",children:e.jsx(ns,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground",children:[t.tempo!=null&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ut,{className:"h-3 w-3"}),t.tempo," c/min"]}),t.split_times.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(xt,{className:"h-3 w-3"}),t.split_times.map(d=>Ye(d.time_seconds)||"—").join(" / ")]}),t.stroke_count.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(mt,{className:"h-3 w-3"}),t.stroke_count.map(d=>d.count).join(" / ")," cps"]})]}),t.notes&&e.jsx("div",{className:"text-xs text-foreground/70 italic",children:t.notes})]})}const Ls=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],Ps=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],Ks=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function vt(...t){return t.filter(Boolean).join(" ")}function wt(t){return String(t).padStart(2,"0")}function Me(t){return`${t.getFullYear()}-${wt(t.getMonth()+1)}-${wt(t.getDate())}`}function Ts(t){return new Date(t.getFullYear(),t.getMonth(),1)}function $s(t){const n=String(t).split("__");return{iso:n[0],slotKey:n[1]||""}}function kt(t,n){return Number.isFinite(t)?Math.round(t/n)*n:0}function St({globalKm:t,onInfo:n,onSettings:r}){return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(Dt,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Suivi"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[t," km"]}),e.jsx("button",{type:"button",onClick:n,className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Infos",children:e.jsx(is,{className:"h-5 w-5 text-primary"})}),e.jsx("button",{type:"button",onClick:r,className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Paramètres",children:e.jsx(cs,{className:"h-5 w-5 text-primary"})})]})]})}function xn(){const{user:t,userId:n}=zt(),{toast:r}=Ht(),o=Mt(),[p,m]=Ie.useState("idle"),[h,x]=Ie.useState(!1),[v,y]=Ie.useState(null);Ie.useEffect(()=>{Ue.auth.getSession().then(({data:s})=>{y(s.session?.user?.id??null)})},[t]);const{data:S,isLoading:_,error:W,refetch:ee}=De({queryKey:["sessions",n??t],queryFn:()=>U.getSessions(t,n),enabled:!!t}),{data:oe,isLoading:de,error:pe,refetch:X}=De({queryKey:["assignments",t],queryFn:()=>U.getAssignments(t,n),enabled:!!t}),{data:ue=[]}=De({queryKey:["competitions"],queryFn:()=>U.getCompetitions()}),{data:G}=De({queryKey:["my-competition-ids"],queryFn:()=>U.getMyCompetitionIds()}),d=i.useMemo(()=>!G||G.length===0?ue:ue.filter(s=>G.includes(s.id)),[ue,G]),{data:b=[]}=De({queryKey:["my-planned-absences"],queryFn:()=>U.getMyPlannedAbsences()}),M=i.useMemo(()=>new Set(b.map(s=>s.date)),[b]),D=_||de,$=W||pe,B=()=>{ee(),X()},me=ve({mutationFn:s=>U.deleteSession(s),onMutate:()=>{m("saving")},onSuccess:()=>{o.invalidateQueries({queryKey:["sessions"]}),o.invalidateQueries({queryKey:["hall-of-fame"]}),r({title:"Séance supprimée",description:"La saisie a été supprimée."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{r({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),ge=ve({mutationFn:async s=>{const{_exerciseLogs:a,...f}=s,j=await U.syncSession({...f,athlete_name:t,athlete_id:n??void 0});if(a&&a.length>0&&j.sessionId)try{const{data:I}=await Ue.auth.getSession(),K=I.session?.user?.id;K&&await U.saveSwimExerciseLogs(j.sessionId,K,a)}catch(I){console.warn("[EAC] Failed to save exercise logs:",I)}return j},onMutate:()=>{m("saving")},onSuccess:()=>{o.invalidateQueries({queryKey:["sessions"]}),o.invalidateQueries({queryKey:["assignments"]}),o.invalidateQueries({queryKey:["hall-of-fame"]}),r({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{r({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),he=ve({mutationFn:async s=>{const{_exerciseLogs:a,...f}=s,j=await U.updateSession(f);if(a&&f.id)try{const{data:I}=await Ue.auth.getSession(),K=I.session?.user?.id;K&&await U.saveSwimExerciseLogs(f.id,K,a)}catch(I){throw console.error("[EAC] Failed to save exercise logs:",I),I}return j},onMutate:()=>{m("saving")},onSuccess:()=>{o.invalidateQueries({queryKey:["sessions"]}),o.invalidateQueries({queryKey:["hall-of-fame"]}),r({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{r({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),A=ve({mutationFn:({date:s,reason:a})=>U.setPlannedAbsence(s,a),onSuccess:()=>{o.invalidateQueries({queryKey:["my-planned-absences"]}),r({title:"Jour marqué indisponible"})},onError:()=>{r({title:"Erreur",description:"Impossible de marquer ce jour indisponible.",variant:"destructive"})}}),q=ve({mutationFn:s=>U.removePlannedAbsence(s),onSuccess:()=>{o.invalidateQueries({queryKey:["my-planned-absences"]}),r({title:"Disponibilité restaurée"})},onError:()=>{r({title:"Erreur",description:"Impossible de restaurer la disponibilité.",variant:"destructive"})}}),L=vs({sessions:S,assignments:oe,userId:n,user:t}),{today:T,monthCursor:C,selectedISO:O,drawerOpen:R,settingsOpen:te,infoOpen:V,activeSessionId:k,detailsOpen:Q,selectedDayIndex:z,isPending:xe,presenceDefaults:Y,stableDurationMin:we,draftState:P,gridDates:Z,completionByISO:ie,selectedDate:Ae,sessionsForSelectedDay:fe,selectedDayStatus:Ce,globalKm:ae,dayKm:qe,logsBySessionId:se,setMonthCursor:l,setSelectedISO:c,setDrawerOpen:u,setSettingsOpen:N,setInfoOpen:w,setActiveSessionId:g,setDetailsOpen:F,setSelectedDayIndex:H,setPresenceDefaults:ne,setAttendanceOverrideBySessionId:J,setStableDurationMin:ke,setDraftState:Re,setAutoCloseArmed:Le,startTransition:le,getSessionStatus:Qe}=L,Ot=i.useMemo(()=>{const s=new Set;for(const a of d){if(!a.date)continue;const f=a.date.slice(0,10),j=a.end_date?a.end_date.slice(0,10):f;let I=f;for(;I<=j;){s.add(I);const K=new Date(I+"T00:00:00");K.setDate(K.getDate()+1);const ce=K.getFullYear(),ye=String(K.getMonth()+1).padStart(2,"0"),Ne=String(K.getDate()).padStart(2,"0");I=`${ce}-${ye}-${Ne}`}}return s},[d]),re=i.useMemo(()=>{const s=Me(new Date);return d.filter(f=>f.date&&f.date.slice(0,10)>=s).sort((f,j)=>f.date.localeCompare(j.date))[0]??null},[d]),ze=i.useMemo(()=>{if(!re)return null;const s=new Date;s.setHours(0,0,0,0);const a=new Date(re.date.slice(0,10)+"T00:00:00");return Math.round((a.getTime()-s.getTime())/(1e3*60*60*24))},[re]),Se=i.useMemo(()=>{if(!re)return null;const s=Me(new Date),a=re.date.slice(0,10),f=new Set;if(oe)for(const K of oe){const ce=(K.assigned_date||"").slice(0,10);ce>s&&ce<a&&f.add(ce)}const j=new Date(s+"T00:00:00");j.setDate(j.getDate()+1);const I=new Date(a+"T00:00:00");for(;j<I;){const K=Me(j);if(!M.has(K)){const ye=(j.getDay()+6)%7,Ne=!!Y?.[ye]?.AM,je=!!Y?.[ye]?.PM;(Ne||je)&&f.add(K)}j.setDate(j.getDate()+1)}return f.size},[re,oe,M,Y]),Oe=i.useCallback(s=>{c(s),u(!0),g(null),F(!1);const a=ie[s]||{completed:0,total:2};Le(a.total>0&&a.completed<a.total)},[ie,c,u,g,F,Le]),He=i.useCallback(()=>{u(!1),g(null),F(!1),Le(!1),H(null)},[u,g,F,Le,H]),Ft=i.useCallback(()=>{l(s=>new Date(s.getFullYear(),s.getMonth()-1,1))},[l]),It=i.useCallback(()=>{l(s=>new Date(s.getFullYear(),s.getMonth()+1,1))},[l]),Et=i.useCallback(()=>{const s=new Date;l(Ts(s)),Oe(Me(s))},[Oe,l]),Je=i.useCallback(s=>{g(s),F(!1)},[g,F]),Lt=i.useCallback(s=>{le(()=>{J(f=>({...f,[s]:"absent"}))});const a=se[s];a?.id&&me.mutate(Number(a.id))},[me,se,le,J]),Pt=i.useCallback(s=>{le(()=>{J(a=>({...a,[s]:"present"}))})},[le,J]),Kt=i.useCallback(s=>{le(()=>{J(a=>{const f={...a};return delete f[s],f})})},[le,J]),Tt=i.useCallback(()=>{const s=fe.map(a=>Qe(a,Ae).expected?a.id:null).filter(Boolean);s.length!==0&&(le(()=>{J(a=>{const f={...a};for(const j of s)f[j]="absent";return f}),g(null),F(!1)}),s.forEach(a=>{const f=se[a];f?.id&&me.mutate(Number(f.id))}))},[fe,Qe,Ae,le,se,me,J,g,F]),$t=i.useCallback(()=>{if(!k||!t||!Ks.every(je=>Number.isInteger(P[je.key])))return;const{iso:a,slotKey:f}=$s(k),j=f==="PM"?"Soir":"Matin",I=kt(Number(P.distanceMeters??0),100),K=kt(Number(we),15),ce={};for(const[je,Rt]of Object.entries(P.strokes)){const rt=Number(Rt);rt>0&&(ce[je]=rt)}const ye={date:a,slot:j,distance:I,duration:K,effort:Number(P.difficulty),feeling:Number(P.fatigue_end),performance:Number(P.performance),engagement:Number(P.engagement),comments:String(P.comment||"").slice(0,400),athlete_name:t,athlete_id:n??void 0,stroke_distances:Object.keys(ce).length>0?ce:null},Ne=se[k];le(()=>{J(je=>({...je,[k]:"present"}))}),Ne?.id?he.mutate({...ye,id:Ne.id,created_at:Ne.created_at??new Date().toISOString(),_exerciseLogs:P.exerciseLogs.length>0?P.exerciseLogs:[]}):ge.mutate({...ye,_exerciseLogs:P.exerciseLogs.length>0?P.exerciseLogs:void 0}),g(null),F(!1)},[k,t,n,P,we,se,le,he,ge,J,g,F]),Bt=i.useCallback((s,a)=>{ne(f=>({...f,[s]:{...f[s],[a]:!f[s][a]}}))},[ne]);i.useEffect(()=>{if(!R)return;const s=a=>{if(a.key==="Escape"){a.preventDefault(),He();return}(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),fe.length>0&&!k&&Je(fe[0].id))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[R,He,fe,k,Je]);const qt=i.useCallback((s,a)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(s.key))return;if(s.preventDefault(),s.key==="Enter"||s.key===" "){const I=Me(Z[a]);Oe(I);return}let j=a;s.key==="ArrowLeft"&&(j=Math.max(0,a-1)),s.key==="ArrowRight"&&(j=Math.min(Z.length-1,a+1)),s.key==="ArrowUp"&&(j=Math.max(0,a-7)),s.key==="ArrowDown"&&(j=Math.min(Z.length-1,a+7)),H(j),c(Me(Z[j])),setTimeout(()=>{const I=document.querySelectorAll('[data-calendar-cell="true"]');I[j]&&I[j].focus()},0)},[Z,Oe,H,c]);return D?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"h-7 w-7 rounded-lg bg-primary/20 animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((s,a)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${a}`)),Array.from({length:35}).map((s,a)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${a}`))]})})]})})]}):$?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(rs,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:$.message}),e.jsx(Jt,{onClick:()=>B(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsx("div",{className:"px-4 py-2.5 flex items-center justify-between",children:e.jsx(St,{globalKm:ae,onInfo:()=>w(!0),onSettings:()=>N(!0)})})}),e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:[e.jsx("div",{className:"hidden sm:flex items-center justify-between",children:e.jsx(St,{globalKm:ae,onInfo:()=>w(!0),onSettings:()=>N(!0)})}),re&&ze!=null&&e.jsxs("div",{className:"mt-4 rounded-xl border border-status-warning/30 bg-status-warning-bg p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{className:"h-4 w-4 text-status-warning"}),e.jsx("span",{className:"text-sm font-semibold truncate",children:re.name}),e.jsx("span",{className:"text-xs text-status-warning font-bold ml-auto shrink-0",children:ze===0?"Aujourd'hui":`J-${ze}`})]}),(re.location||Se!=null&&Se>0)&&e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[re.location&&e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:re.location}),Se!=null&&Se>0&&e.jsxs("span",{className:"text-xs text-status-warning font-medium ml-auto shrink-0",children:[Se," séance",Se>1?"s":""," d'ici là"]})]})]}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(Wt,{monthCursor:C,selectedDayStatus:Ce,onPrevMonth:Ft,onNextMonth:It,onJumpToday:Et}),e.jsx(Xt,{monthCursor:C,gridDates:Z,completionByISO:ie,competitionDates:Ot,absenceDates:M,selectedISO:O,selectedDayIndex:z,today:T,onDayClick:Oe,onKeyDown:qt})]}),v&&e.jsx(Is,{userId:v,expanded:h,onToggle:()=>x(s=>!s)}),e.jsx(ot,{open:V,onOpenChange:w,children:e.jsxs(it,{className:"max-w-sm rounded-2xl",children:[e.jsx(at,{children:e.jsx(lt,{children:"Codes"})}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-orange-200 bg-orange-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Orange"}),e.jsx("span",{className:"text-foreground",children:"À compléter"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Vert"}),e.jsx("span",{className:"text-foreground",children:"Validé → km"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-sky-200 bg-sky-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Bleu"}),e.jsx("span",{className:"text-foreground",children:"Absent / Non prévu"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Les km comptent uniquement après validation."})]})]})}),e.jsx(ot,{open:te,onOpenChange:N,children:e.jsxs(it,{className:"max-w-sm rounded-2xl",children:[e.jsx(at,{children:e.jsx(lt,{children:"Présence"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Toggle hebdo (séances attendues)."}),e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_110px_110px] bg-muted border-b border-border px-3 py-2 text-xs font-semibold text-muted-foreground",children:[e.jsx("div",{children:"Jour"}),e.jsx("div",{className:"text-center",children:"Matin"}),e.jsx("div",{className:"text-center",children:"Soir"})]}),Ls.map((s,a)=>e.jsxs("div",{className:vt("grid grid-cols-[1fr_110px_110px] items-center px-3 py-2",a!==6&&"border-b border-border"),children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:s}),Ps.map(f=>{const j=!!Y?.[a]?.[f.key];return e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{type:"button",onClick:()=>Bt(a,f.key),className:vt("w-24 rounded-2xl border px-3 py-2 text-sm font-semibold transition",j?"bg-foreground text-background border-foreground":"bg-card text-foreground border-border hover:bg-muted"),"aria-label":`${s} ${f.label}`,children:j?"On":"Off"})},f.key)})]},s))]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>ke(s=>Math.max(30,s-15)),"aria-label":"Diminuer la durée",children:e.jsx(Ct,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[we," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>ke(s=>Math.min(240,s+15)),"aria-label":"Augmenter la durée",children:e.jsx($e,{className:"h-4 w-4"})})]})]})]})]})}),e.jsx(Cs,{open:R,selectedDate:Ae,sessionsForSelectedDay:fe,selectedDayStatus:Ce,dayKm:qe,activeSessionId:k,detailsOpen:Q,draftState:P,saveState:p,isPending:xe,logsBySessionId:se,onClose:He,onDayOffAll:Tt,onOpenSession:Je,onCloseSession:()=>{g(null),F(!1)},onToggleDetails:()=>F(s=>!s),onMarkAbsent:Lt,onMarkPresent:Pt,onClearOverride:Kt,onSaveFeedback:$t,onDraftStateChange:Re,getSessionStatus:Qe,isAbsent:M.has(O),absenceReason:b.find(s=>s.date===O)?.reason??null,onMarkDayAbsent:s=>A.mutate({date:O,reason:s}),onRemoveDayAbsence:()=>q.mutate(O)})]})]})}export{xn as default};
