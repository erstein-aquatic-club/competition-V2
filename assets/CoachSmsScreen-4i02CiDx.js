import{r as i,u as H,j as s}from"./vendor-query-DyA9aSKS.js";import{b as R,d as K,C as w,g as y,i as N,j as _,e as $,L as Q,B as z,c as k,X as M,s as X}from"./index-BCaVfuoN.js";import{B as T}from"./badge-BSjYc9Yn.js";import{T as J}from"./textarea-DQJ5LLXU.js";import{P as V,a as W,b as Y,C as Z,c as ee,d as se,e as te,f as P,g as E}from"./command-9uA2rDCO.js";import{C as ne}from"./Coach-D5XiK1vZ.js";import{S as re,c as O,b as ae}from"./smsUtils-tuKm_6mm.js";import{C as A}from"./index-BEJdaMW8.js";import{E as oe}from"./external-link-rGrXTG4p.js";import{C as ie}from"./copy-2tvCG1OM.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./index-BbbOc500.js";import"./dialog-KTgbDTJt.js";import"./search-L5oZynXz.js";import"./api-C_Au0uo2.js";import"./swim-BBrJAP6S.js";import"./arrow-left-yG3AW9mv.js";import"./trophy-zaLEzKaQ.js";import"./bell-ring-C6s71Bfa.js";import"./chevron-right-C04c_woi.js";import"./zap-BcAewBm5.js";import"./clock-3rH5ykDG.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["path",{d:"m7 15 5 5 5-5",key:"1hf1tw"}],["path",{d:"m7 9 5-5 5 5",key:"sgt6xg"}]],ce=R("chevrons-up-down",le),Ge=({onBack:G,athletes:x,groups:p,athletesLoading:L})=>{const{toast:u}=K(),[g,U]=i.useState(""),[a,j]=i.useState(new Set),[o,f]=i.useState(new Set),[C,B]=i.useState(!1),{data:h}=H({queryKey:["athlete-phones"],queryFn:async()=>{const{data:e}=await X.from("user_profiles").select("user_id, phone").not("phone","is",null);return new Map((e??[]).map(n=>[n.user_id,n.phone]))}}),d=i.useMemo(()=>x.filter(e=>e.id!=null).map(e=>({id:e.id,display_name:e.display_name,group_id:e.group_id??null,group_label:e.group_label??null})),[x]),b=e=>{j(n=>{const t=new Set(n);return t.has(e)?t.delete(e):t.add(e),t})},v=e=>{f(n=>{const t=new Set(n);return t.has(e)?t.delete(e):t.add(e),t})},D=()=>{j(new Set),f(new Set)},{selectedPhones:r,selectedTotal:de,missingCount:S}=i.useMemo(()=>{if(!h)return{selectedPhones:[],selectedTotal:0,missingCount:0};const e=new Set;for(const m of a)for(const c of d)c.group_id===m&&e.add(c.id);for(const m of o)e.add(m);const n=e.size,t=[];for(const m of e){const c=h.get(m);c&&c.trim().length>0&&t.push(c)}return{selectedPhones:t,selectedTotal:n,missingCount:n-t.length}},[a,o,d,h]),l=a.size+o.size,F=i.useMemo(()=>{const e=[];return a.size>0&&e.push(`${a.size} groupe${a.size>1?"s":""}`),o.size>0&&e.push(`${o.size} nageur${o.size>1?"s":""}`),e.join(", ")},[a.size,o.size]),I=()=>{if(r.length===0){u({title:"Aucun numéro",description:"Aucun nageur avec un numéro de téléphone dans cette sélection.",variant:"destructive"});return}if(O()){const e=ae(r,g.trim()||void 0);window.location.href=e}else navigator.clipboard.writeText(r.join(", ")).then(()=>{u({title:"Numéros copiés",description:`${r.length} numéro${r.length>1?"s":""} copié${r.length>1?"s":""} dans le presse-papiers.`})}).catch(()=>{u({title:"Erreur",description:"Impossible de copier les numéros.",variant:"destructive"})})},q=O();return s.jsxs("div",{className:"space-y-6 pb-24",children:[s.jsx(ne,{title:"Envoyer un SMS",description:"Ouvre votre application SMS ou copie les numéros.",onBack:G}),s.jsxs(w,{className:"border-l-4 border-l-primary",children:[s.jsxs(y,{children:[s.jsx(N,{children:"Destinataires"}),s.jsx(_,{children:"Sélectionnez des groupes et/ou des nageurs."})]}),s.jsxs($,{className:"space-y-3",children:[s.jsx(Q,{children:"Destinataires"}),s.jsxs(V,{open:C,onOpenChange:B,children:[s.jsx(W,{asChild:!0,children:s.jsxs(z,{variant:"outline",role:"combobox","aria-expanded":C,className:"w-full justify-between font-normal",children:[s.jsx("span",{className:"truncate",children:l>0?F:L?"Chargement...":"Choisir des destinataires"}),s.jsx(ce,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),s.jsx(Y,{className:"w-[var(--radix-popover-trigger-width)] p-0",align:"start",children:s.jsxs(Z,{children:[s.jsx(ee,{placeholder:"Rechercher..."}),s.jsxs(se,{children:[s.jsx(te,{children:"Aucun résultat."}),p.length>0&&s.jsx(P,{heading:"Groupes",children:p.map(e=>s.jsxs(E,{value:`groupe ${e.name}`,onSelect:()=>b(e.id),children:[s.jsx(A,{className:k("mr-2 h-4 w-4",a.has(e.id)?"opacity-100":"opacity-0")}),e.name]},`group:${e.id}`))}),d.length>0&&s.jsx(P,{heading:"Nageurs",children:d.map(e=>s.jsxs(E,{value:`nageur ${e.display_name} ${e.group_label??""}`,onSelect:()=>v(e.id),children:[s.jsx(A,{className:k("mr-2 h-4 w-4",o.has(e.id)?"opacity-100":"opacity-0")}),s.jsx("span",{className:"truncate",children:e.display_name}),e.group_label&&s.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:e.group_label})]},`user:${e.id}`))})]})]})})]}),l>0&&s.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[[...a].map(e=>{const n=p.find(t=>t.id===e);return n?s.jsxs(T,{variant:"secondary",className:"gap-1 pr-1",children:[n.name,s.jsx("button",{type:"button",onClick:()=>b(e),className:"ml-0.5 rounded-full p-0.5 hover:bg-muted",children:s.jsx(M,{className:"h-3 w-3"})})]},`g:${e}`):null}),[...o].map(e=>{const n=d.find(t=>t.id===e);return n?s.jsxs(T,{variant:"outline",className:"gap-1 pr-1",children:[n.display_name,s.jsx("button",{type:"button",onClick:()=>v(e),className:"ml-0.5 rounded-full p-0.5 hover:bg-muted",children:s.jsx(M,{className:"h-3 w-3"})})]},`u:${e}`):null}),l>1&&s.jsx("button",{type:"button",onClick:D,className:"text-xs text-muted-foreground underline hover:text-foreground",children:"Tout effacer"})]}),l>0&&r.length>0&&s.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.length," numéro",r.length>1?"s":""," trouvé",r.length>1?"s":"",S>0&&s.jsxs("span",{className:"text-destructive",children:[" · ",S," sans téléphone"]})]}),l>0&&r.length===0&&s.jsx("p",{className:"text-xs text-destructive",children:"Aucun numéro de téléphone disponible pour cette sélection."})]})]}),s.jsxs(w,{children:[s.jsxs(y,{children:[s.jsx(N,{children:"Message"}),s.jsx(_,{children:"Optionnel — pré-rempli dans votre application SMS."})]}),s.jsx($,{children:s.jsx(J,{value:g,onChange:e=>U(e.target.value),placeholder:"Contenu du SMS…",rows:3})})]}),s.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:s.jsx(z,{className:"w-full sm:w-auto",onClick:I,disabled:l===0||r.length===0,children:q?s.jsxs(s.Fragment,{children:[s.jsx(re,{className:"mr-2 h-4 w-4"}),"Ouvrir dans Messages",s.jsx(oe,{className:"ml-2 h-3 w-3"})]}):s.jsxs(s.Fragment,{children:[s.jsx(ie,{className:"mr-2 h-4 w-4"}),"Copier les numéros"]})})})]})};export{Ge as default};
