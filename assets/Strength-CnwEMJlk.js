import{j as e,r as i,c as At,u as fe,d as Le,e as es}from"./vendor-query-DyA9aSKS.js";import{a as G}from"./api-BqRQTNHo.js";import{b as lt,c as te,d as ot,D as Oe,B as C,C as Pe,g as It,i as Dt,j as ts,e as ss,L as _e,r as rs,X as $e,t as ns,I as st,u as De,f as be}from"./index-O16scsGl.js";import{T as is,a as as,b as Nt,c as wt}from"./tabs-DcxrwIod.js";import{B as St}from"./badge-BWmgQcpX.js";import{D as ls,a as os,b as cs,c as ds,d as us}from"./drawer-CvAq22Ow.js";import{S as rt,a as nt,b as it,c as at,e as ms}from"./sheet-BVjFRx5x.js";import{S as xs}from"./switch-DaPJhao0.js";import{A as Tt,a as Ft,b as Lt,c as Pt,d as qt,e as $t,f as Ot,g as Kt}from"./alert-dialog-3hjNm7W9.js";import{B as zt}from"./BottomActionBar-D2GUUp6D.js";import{c as Te}from"./design-tokens-CKgCpdH6.js";import{i as _t,B as ze}from"./swim--0w5uie8.js";import{L as hs}from"./loader-circle-LMbdGmUd.js";import{C as ps}from"./circle-check-Dtsm3aWn.js";import{S as fs}from"./sticky-note-BiN2reAs.js";import{C as Ct}from"./index-Cs8y90i4.js";import{T as gs}from"./timer-TpoMEMyV.js";import{C as Be}from"./chevron-right-Bz19ZUVk.js";import{F as ys}from"./flame-BU8PmQTB.js";import{Z as bs}from"./zap-BB2ia91Q.js";import{m as qe}from"./vendor-motion-lao-Njgm.js";import{f as He}from"./fr-W-h3q7wd.js";import{S as vs}from"./search-D2exaJAg.js";import{f as Ge}from"./vendor-date-B8Mnp-Vt.js";import{f as js}from"./animations-CrcLFysI.js";import{C as Ns}from"./chevron-left-KMM-GzJV.js";import{P as ws}from"./play-DyTivqK5.js";import{S as Ss,a as _s,b as Cs,c as ks,d as Ve}from"./select-CIupFAp1.js";import{P as Ms}from"./PageHeader-D9n15S_i.js";import{C as Es}from"./circle-alert-cpzsK4Zu.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-CAuyrQPe.js";import"./index-CgT1NBnm.js";import"./index-C2Zyn6WL.js";import"./index-DCX2sNhR.js";import"./chevron-down-CtGdB8yM.js";import"./chevron-up-Cx_lvk3V.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rs=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],As=lt("calendar",Rs);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]],Ds=lt("pause",Is);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ts=[["circle",{cx:"12",cy:"5",r:"3",key:"rqqgnr"}],["path",{d:"M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z",key:"56o5sh"}]],Fs=lt("weight",Ts),Ls=[1,2,3,4,5];function kt({value:t,onChange:a,className:c,disabled:o=!1,size:m="md",ariaLabel:b="Sélecteur d'échelle 1 à 5"}){const y=m==="sm"?"h-10 w-10 text-xs":"h-11 w-11 text-sm";return e.jsx("div",{className:te("flex items-center gap-2",c),role:"group","aria-label":b,children:Ls.map(j=>{const g=t===j;return e.jsx("button",{type:"button",className:te("flex items-center justify-center rounded-full border font-semibold transition",y,g?"border-primary bg-primary text-primary-foreground":"border-muted-foreground/30 bg-background text-foreground",o&&"opacity-60"),"aria-pressed":g,disabled:o,onClick:()=>{o||a?.(j)},children:j},j)})})}const Ps=()=>{try{const t=new(window.AudioContext||window.webkitAudioContext),a=t.createOscillator(),c=t.createGain();a.connect(c),c.connect(t.destination),a.frequency.value=880,c.gain.value=.3,a.start(),a.stop(t.currentTime+.25);const o=t.createOscillator(),m=t.createGain();o.connect(m),m.connect(t.destination),o.frequency.value=1100,m.gain.value=.3,o.start(t.currentTime+.35),o.stop(t.currentTime+.6),o.onended=()=>t.close()}catch{}try{navigator.vibrate?.([200,100,200])}catch{}},Qe=(t,a)=>{const c=Number(t?.set_index??t?.set_number??t?.setIndex??a);return!Number.isFinite(c)||c<=0?a:c},Vt=(t=[],a,c)=>{if(!t.length)return 0;const o=Array.isArray(a)?a:[];if(o.length>0){const y=new Map;o.forEach((g,k)=>{if(!g?.exercise_id)return;const N=y.get(g.exercise_id)??[];N.push({...g,set_index:Qe(g,k+1)}),y.set(g.exercise_id,N)});let j=t.length+1;for(let g=0;g<t.length;g+=1){const k=t[g];if((y.get(k.exercise_id)??[]).length<(k.sets??0)){j=g+1;break}}return j}const m=Number(c??0);if(!Number.isFinite(m)||m<=0)return 0;const b=Math.min(t.length,Math.max(0,Math.round(m/100*t.length)));return Math.min(t.length,b+1)},ue=(t,a)=>{const c=Number(t);return!Number.isFinite(c)||c<=0?"—":a?`${c}${a}`:String(c)};function qs({session:t,exercises:a,oneRMs:c,onFinish:o,onStart:m,onLogSets:b,onProgress:y,initialLogs:j,isFinishing:g,initialStep:k,onStepChange:N,initialInputOpen:l,initialSeriesOpen:E,onExitFocus:v,exerciseNotes:M,onUpdateNote:A}){const{toast:L}=ot(),J=i.useRef(!1),[S,K]=i.useState(k??0),[T,$]=i.useState([]),[P,se]=i.useState(0),[Z,me]=i.useState(!0),f=i.useRef(Date.now()),I=i.useRef(0),[w,F]=i.useState(0),[ae,le]=i.useState(!1),[re,O]=i.useState(!1),z=i.useRef(0),[ve,Ce]=i.useState(!0),[xe,oe]=i.useState(3),[je,V]=i.useState(3),[Ne,n]=i.useState(""),[_,q]=i.useState(!1),[h,R]=i.useState(1),[ke,W]=i.useState(E??!1),[Me,we]=i.useState(l??!1),[X,Ee]=i.useState("weight"),[ne,Y]=i.useState(""),[We,ge]=i.useState(!1),[Re,Ae]=i.useState(!1),[r,x]=i.useState(!1),[Q,B]=i.useState(!1),[he,pe]=i.useState(!1),[ct,dt]=i.useState("");i.useEffect(()=>{if(!Z)return;const s=()=>{const u=Math.floor((Date.now()-f.current)/1e3)+I.current;se(u)};s();const d=setInterval(s,1e3),D=()=>{document.visibilityState==="visible"&&s()};return document.addEventListener("visibilitychange",D),()=>{clearInterval(d),document.removeEventListener("visibilitychange",D)}},[Z]),i.useEffect(()=>{if(!Re)return;const s=d=>{d.key==="Escape"&&Ae(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[Re]),i.useEffect(()=>{if(!ae||re)return;const s=()=>{if(z.current<=0)return;const u=Math.max(0,Math.ceil((z.current-Date.now())/1e3));F(u),u<=0&&(Ps(),L({title:"Temps de récupération terminé"}),le(!1),O(!1))};s();const d=setInterval(s,1e3),D=()=>{document.visibilityState==="visible"&&s()};return document.addEventListener("visibilitychange",D),()=>{clearInterval(d),document.removeEventListener("visibilitychange",D)}},[ae,re]);const H=t.items||[],Bt=S-1,p=S>0&&S<=H.length?H[Bt]:null,U=p?a.find(s=>s.id===p.exercise_id):null,ut=S<H.length?H[S]:null,Ht=ut?a.find(s=>s.id===ut.exercise_id):null,mt=(()=>{const s=U?.muscle_groups??U?.muscles??U?.muscleGroups??[];return Array.isArray(s)?s:[]})(),ye=p?.rest_seconds??0,xt=H.length?Math.min(100,Math.max(0,Math.round((S-1)/H.length*100))):0,Je=Number(p?.percent_1rm),ht=Number.isFinite(Je)&&Je>0,Gt=ht&&c.find(s=>s.exercise_id===p?.exercise_id)?.weight||0,ee=ht?Math.round(Gt*(Je/100)):0,[ie,Se]=i.useState({}),pt=i.useMemo(()=>{const s=new Map;return T.forEach((d,D)=>{const u=Qe(d,D+1);d.exercise_id&&s.set(`${d.exercise_id}-${u}`,d)}),s},[T]),ft=p?`${p.exercise_id}-${h}`:null,Ze=ft?pt.get(ft):null,gt=Ze?.weight??ie[h-1]?.weight??ee,Wt=Ze?.reps??ie[h-1]?.reps??p?.reps??"",Jt=()=>{if(typeof window>"u")return;const s=[Te.status.success,Te.chart[2],Te.chart[3],Te.destructive,Te.accent],d=120;for(let D=0;D<d;D+=1){const u=document.createElement("div"),ce=Math.random()*6+6;u.style.position="fixed",u.style.top="-10px",u.style.left=`${Math.random()*100}vw`,u.style.width=`${ce}px`,u.style.height=`${ce*.6}px`,u.style.backgroundColor=s[D%s.length],u.style.opacity="0.9",u.style.pointerEvents="none",u.style.zIndex="80",u.style.borderRadius="2px",document.body.appendChild(u);const de=(Math.random()-.5)*200,Ie=1200+Math.random()*800,Ke=Math.random()*360;u.animate([{transform:"translate3d(0, 0, 0) rotate(0deg)",opacity:1},{transform:`translate3d(${de}px, ${window.innerHeight+200}px, 0) rotate(${Ke}deg)`,opacity:0}],{duration:Ie,easing:"ease-out"}).onfinish=()=>u.remove()}};i.useEffect(()=>{if(J.current){j&&$(j);return}if(!j){$(u=>u.length?[]:u),Se(u=>Object.keys(u).length?{}:u);return}if($(j),!j.length){Se(u=>Object.keys(u).length?{}:u),K(u=>u===0?u:0);return}const s=t.items||[];if(!s.length)return;const d=new Map;j.forEach((u,ce)=>{if(!u.exercise_id)return;const de=d.get(u.exercise_id)??[];de.push({...u,set_index:Qe(u,ce+1)}),d.set(u.exercise_id,de)});const D=Vt(s,j);if(D>0&&D<=s.length){const u=s[D-1],ce=d.get(u.exercise_id)??[],de=ce.reduce((Ke,Ye,Xt)=>{const Yt=Qe(Ye,Xt+1);return Ke[Yt-1]={reps:Ye.reps??void 0,weight:Ye.weight??void 0},Ke},{});Se(de);const Ie=Math.min(u.sets??1,ce.length+1);R(Ie)}else Se({}),R(1);K(u=>u===D?u:D)},[j,t.items]),i.useEffect(()=>{S<=H.length||_||(Jt(),q(!0))},[S,H.length,_]);const yt=s=>{K(s),N?.(s)},bt=s=>{s<=0||(z.current=Date.now()+s*1e3,F(s),le(!0),O(!1))},Ue=async()=>{window.scrollTo({top:0,behavior:"smooth"});const s=S+1;R(1),Se({}),yt(s);const d=Math.round(Math.min(s-1,H.length)/H.length*100);try{await y?.(d)}catch{L({title:"Erreur de sauvegarde",description:"Réessayez",variant:"destructive"})}},Zt=async()=>{if(!p)return;if(Ze){h>=p.sets?await Ue():R(d=>Math.min(p.sets,d+1));return}const s={exercise_id:p.exercise_id,set_number:h,reps:ie[h-1]?.reps||p.reps,weight:ie[h-1]?.weight??ee};$(d=>[...d,s]),J.current=!0;try{await b?.([s])}catch{L({title:"Erreur de sauvegarde",description:"Réessayez",variant:"destructive"})}finally{J.current=!1}if(ve&&p.rest_seconds>0&&bt(p.rest_seconds),h>=p.sets){await Ue();return}R(d=>Math.min(p.sets,d+1))},vt=s=>{Ee(s);const d=s==="weight"?ie[h-1]?.weight??ee??"":ie[h-1]?.reps??p?.reps??"";Y(d?String(d):""),ge(!!d),we(!0)},Ut=()=>{if(!p)return;const s=Number(X==="weight"?ne.replace(",","."):ne);Number.isFinite(s)&&(Se(d=>({...d,[h-1]:{...d[h-1],[X]:s}})),we(!1))},Xe=s=>{if(We||ne===String(ze)){ge(!1),Y(s);return}Y(d=>s==="."&&d.includes(".")?d:d+s)},jt=s=>{if(!p)return;Ee(s);const d=s==="weight"?ie[h-1]?.weight??ee??"":ie[h-1]?.reps??p?.reps??"";Y(d?String(d):""),ge(!!d)};return S===0?e.jsxs("div",{className:"space-y-6 text-center py-8 animate-in zoom-in duration-300",children:[e.jsx("div",{className:"h-24 w-24 bg-primary/10 rounded-full flex items-center justify-center mx-auto animate-pulse",children:e.jsx(Oe,{className:"h-10 w-10 text-primary ml-1"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold font-display uppercase",children:t.title}),e.jsx("p",{className:"text-muted-foreground text-lg",children:t.description}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(St,{variant:"outline",className:"text-sm px-3 py-1",children:t.cycle}),e.jsxs(St,{variant:"secondary",className:"text-sm px-3 py-1",children:[H.length," Exercices"]})]})]}),e.jsx(C,{size:"lg",className:"w-full text-xl h-14 font-bold uppercase tracking-wider shadow-lg hover:scale-[1.02] transition-transform",disabled:r,onClick:async()=>{x(!0);try{await m?.(),yt(1)}finally{x(!1)}},children:r?e.jsxs(e.Fragment,{children:[e.jsx(hs,{className:"mr-2 h-5 w-5 animate-spin"}),"CHARGEMENT..."]}):"COMMENCER SÉANCE"})]}):S>H.length?e.jsx("div",{className:"space-y-6 animate-in fade-in",children:e.jsxs(Pe,{className:"border-t-8 border-t-primary shadow-xl",children:[e.jsxs(It,{className:"text-center pb-2",children:[e.jsx("div",{className:"mx-auto bg-primary/10 p-4 rounded-full w-fit mb-4",children:e.jsx(ps,{className:"h-12 w-12 text-primary"})}),e.jsx(Dt,{className:"text-3xl uppercase font-display italic",children:"Séance Terminée !"}),e.jsxs(ts,{className:"text-lg",children:["Durée totale: ",Math.floor(P/60),"m ",P%60,"s"]})]}),e.jsxs(ss,{className:"space-y-6 pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-center",children:[e.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[e.jsx("div",{className:"text-xs uppercase font-bold text-muted-foreground",children:"Volume"}),e.jsxs("div",{className:"text-2xl font-mono font-bold",children:[T.reduce((s,d)=>s+(_t(d.weight)?0:(Number(d.weight)||0)*(Number(d.reps)||0)),0).toLocaleString("fr-FR")," kg"]})]}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg",children:[e.jsx("div",{className:"text-xs uppercase font-bold text-muted-foreground",children:"Séries"}),e.jsx("div",{className:"text-2xl font-mono font-bold",children:T.length})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_e,{className:"uppercase font-bold text-xs text-muted-foreground",children:"Difficulté de la séance"}),e.jsxs("div",{className:"flex items-center justify-between text-[11px] font-semibold text-muted-foreground",children:[e.jsx("span",{children:"Facile"}),e.jsx("span",{children:"Très dur"})]}),e.jsx(kt,{value:xe,onChange:oe})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(_e,{className:"uppercase font-bold text-xs text-muted-foreground",children:"Fatigue fin de séance"}),e.jsxs("div",{className:"flex items-center justify-between text-[11px] font-semibold text-muted-foreground",children:[e.jsx("span",{children:"Frais"}),e.jsx("span",{children:"Épuisé"})]}),e.jsx(kt,{value:je,onChange:V})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{className:"uppercase font-bold text-xs text-muted-foreground",children:"Notes"}),e.jsx("textarea",{placeholder:"Sensations, douleurs...",value:Ne,onChange:s=>n(s.target.value),rows:3,className:"flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 resize-none"})]})]}),e.jsx(rs,{children:e.jsx(C,{className:"w-full h-14 text-lg font-bold uppercase",disabled:g,onClick:()=>{g||o({duration:Math.floor(P/60),feeling:xe,fatigue:je,comments:Ne,logs:T})},children:g?"ENREGISTREMENT...":"ENREGISTRER & FERMER"})})]})}):e.jsxs("div",{className:"space-y-6 pb-44",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button","aria-label":"Voir l'animation de l'exercice",onClick:()=>{U?.illustration_gif&&Ae(!0)},className:"flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-full border bg-card shadow-sm",children:U?.illustration_gif?e.jsx("img",{src:U.illustration_gif,alt:"",className:"h-full w-full object-cover",loading:"lazy",decoding:"async"}):e.jsx(Oe,{className:"h-5 w-5 text-muted-foreground"})}),e.jsx("h2",{className:"flex-1 min-w-0 text-lg font-semibold tracking-tight truncate",children:U?.nom_exercice??"Exercice"}),A&&p&&e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>{dt(M?.[p.exercise_id]??""),pe(!0)},"aria-label":"Notes personnelles",children:e.jsx(fs,{className:te("h-4 w-4",M?.[p?.exercise_id]?"text-primary":"text-muted-foreground")})}),v&&e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0","aria-label":"Quitter le focus",onClick:()=>{T.length>0?B(!0):v()},children:e.jsx($e,{className:"h-4 w-4"})})]}),p&&M?.[p.exercise_id]&&e.jsx("p",{className:"text-xs italic text-muted-foreground line-clamp-2 -mt-1",children:M[p.exercise_id]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"rounded-full bg-primary/10 text-primary px-2.5 py-0.5 text-xs font-bold shrink-0",children:["Ex ",S,"/",H.length]}),e.jsxs("span",{className:"rounded-full bg-muted px-2.5 py-0.5 text-xs font-semibold shrink-0",children:["S ",h,"/",ue(p?.sets)]}),e.jsx("div",{className:"flex-1 h-1.5 overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary transition-all",style:{width:`${xt}%`}})}),e.jsxs("span",{className:"text-xs font-semibold text-muted-foreground shrink-0",children:[xt,"%"]})]}),mt.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:mt.map(s=>e.jsx("span",{className:"rounded-full bg-muted px-2.5 py-0.5 text-xs font-semibold text-muted-foreground",children:s},s))})]}),e.jsxs(Pe,{className:"rounded-3xl border bg-card p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"text-sm font-semibold",children:["Série ",h,"/",ue(p?.sets)," · ",ue(p?.reps)," reps"]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(xs,{checked:ve,onCheckedChange:Ce,className:"scale-90"}),e.jsx("span",{children:"Auto repos"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{type:"button",className:"group relative rounded-2xl border-2 border-primary/20 bg-gradient-to-br from-card to-muted/30 p-4 text-left shadow-sm transition-all active:scale-[0.98] hover:border-primary/40 hover:shadow-md",onClick:()=>vt("weight"),children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wide text-muted-foreground",children:"Charge"}),e.jsx("div",{className:"mt-1 flex items-baseline gap-0.5",children:_t(gt)?e.jsx("span",{className:"text-2xl font-bold tracking-tight",children:"PDC"}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-3xl font-bold tabular-nums tracking-tight",children:gt||"—"}),e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"kg"})]})})]}),e.jsxs("button",{type:"button",className:"group relative rounded-2xl border-2 border-primary/20 bg-gradient-to-br from-card to-muted/30 p-4 text-left shadow-sm transition-all active:scale-[0.98] hover:border-primary/40 hover:shadow-md",onClick:()=>vt("reps"),children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wide text-muted-foreground",children:"Reps"}),e.jsxs("div",{className:"mt-1 flex items-baseline gap-0.5",children:[e.jsx("span",{className:"text-3xl font-bold tabular-nums tracking-tight",children:Wt||"—"}),e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"reps"})]})]})]})]}),(p?.notes||U?.description)&&e.jsxs("div",{className:"rounded-2xl border bg-muted/10 px-4 py-3",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground/70 uppercase tracking-wide mb-1",children:"Notes"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:p?.notes||U?.description})]}),e.jsx(C,{variant:"outline",className:"w-full rounded-2xl",onClick:()=>W(!0),children:"Voir les séries"}),!Me&&!ae?e.jsxs(zt,{className:"bottom-0 z-modal",containerClassName:"gap-3 py-4",children:[e.jsxs(C,{className:"flex-1 min-w-0 h-12 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition-transform",onClick:Zt,children:[e.jsx(Ct,{className:"mr-2 h-5 w-5"})," Valider série"]}),e.jsxs(C,{type:"button",variant:"outline",className:"h-12 rounded-xl px-3 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform",onClick:()=>{ye>0&&bt(ye)},disabled:ye<=0,"aria-label":"Démarrer le repos",children:[e.jsx(gs,{className:"h-4 w-4"}),e.jsx("span",{className:"text-[10px] font-semibold leading-none",children:"Repos"})]}),e.jsxs(C,{type:"button",variant:"outline",className:"h-12 rounded-xl px-3 flex flex-col items-center justify-center gap-0.5 active:scale-95 transition-transform",onClick:()=>Ue(),"aria-label":"Exercice suivant",children:[e.jsx(Be,{className:"h-4 w-4"}),e.jsx("span",{className:"text-[10px] font-semibold leading-none",children:"Passer"})]})]}):null,ae&&e.jsxs("div",{className:"fixed inset-0 z-modal flex flex-col bg-background/95 pb-[env(safe-area-inset-bottom)]",children:[e.jsxs("div",{className:"flex items-start justify-between border-b px-6 py-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Timer"}),e.jsx("div",{className:"text-lg font-semibold",children:"Transition inter-exercice"}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Prochain exercice : ",Ht?.nom_exercice??"À venir"]})]}),e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>{le(!1),O(!1)},"aria-label":"Fermer le timer de repos",children:e.jsx($e,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-1 flex-col items-center justify-center gap-6 px-6 py-8",children:[e.jsxs(Pe,{className:"w-full max-w-sm rounded-3xl border p-6 shadow-sm",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Temps restant"}),e.jsxs("div",{className:"mt-2 text-5xl font-semibold tracking-tight",children:[Math.floor(w/60),":",String(w%60).padStart(2,"0")]}),e.jsx("div",{className:"mt-6 h-3 w-full overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary",style:{width:ye?`${w/ye*100}%`:"0%"}})}),e.jsxs("div",{className:"mt-6 flex gap-3",children:[e.jsx(C,{variant:"outline",className:"flex-1 h-12 rounded-full text-base font-semibold",onClick:()=>{z.current+=30*1e3,F(s=>s+30)},children:"+30s"}),e.jsxs(C,{variant:"outline",className:"flex-1 h-12 rounded-full text-base font-semibold",onClick:()=>{z.current=Date.now()+ye*1e3,F(ye)},children:[e.jsx(ns,{className:"mr-2 h-4 w-4"})," Reset"]})]})]}),e.jsxs("div",{className:"flex w-full max-w-sm flex-wrap gap-3",children:[e.jsxs(C,{className:"flex-1 rounded-full py-6 text-base font-semibold",onClick:()=>{re&&(z.current=Date.now()+w*1e3),O(s=>!s)},children:[e.jsx(Ds,{className:"mr-2 h-4 w-4"})," ",re?"Reprendre":"Pause"]}),e.jsxs(C,{variant:"outline",className:"rounded-full px-6 py-6 text-base font-semibold",onClick:()=>{z.current=0,le(!1),F(0),O(!1)},children:["Passer ",e.jsx(Be,{className:"ml-2 h-4 w-4"})]})]})]})]}),Re&&U?.illustration_gif&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50",onClick:()=>Ae(!1),children:e.jsx("div",{className:"fixed inset-0 flex items-center justify-center p-4",onClick:s=>s.stopPropagation(),children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{type:"button","aria-label":"Fermer",className:"absolute -right-3 -top-3 rounded-full bg-background p-2 shadow",onClick:()=>Ae(!1),children:e.jsx($e,{className:"h-4 w-4"})}),e.jsx("img",{src:U.illustration_gif,alt:"",className:"max-h-[80vh] w-auto max-w-[92vw] rounded-2xl",loading:"lazy"})]})})}),e.jsx(rt,{open:ke,onOpenChange:W,children:e.jsxs(nt,{side:"bottom",className:"max-h-[80vh] overflow-y-auto",children:[e.jsx(it,{children:e.jsx(at,{children:"Aperçu séance"})}),e.jsx("div",{className:"mt-4 space-y-4",children:H.map((s,d)=>{const D=a.find(de=>de.id===s.exercise_id),u=Array.from({length:s.sets}).filter((de,Ie)=>pt.get(`${s.exercise_id}-${Ie+1}`)).length,ce=s.sets?Math.round(u/s.sets*100):0;return e.jsxs(Pe,{className:"rounded-3xl border bg-muted/10 p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:D?.nom_exercice??s.exercise_name}),e.jsxs("div",{className:"mt-1 text-sm text-muted-foreground",children:[ue(s.sets),"x",ue(s.reps)," ·"," ",s.percent_1rm?`${ue(s.percent_1rm)} 1RM`:"—"]})]}),e.jsxs("div",{className:"rounded-full bg-muted px-3 py-1 text-sm font-semibold",children:[u,"/",ue(s.sets)]})]}),e.jsx("div",{className:"mt-4 h-3 w-full overflow-hidden rounded-full bg-muted",children:e.jsx("div",{className:"h-full rounded-full bg-primary",style:{width:`${ce}%`}})})]},`${s.exercise_id}-${d}`)})})]})}),e.jsx(ls,{open:Me,onOpenChange:we,children:e.jsx(os,{className:"max-h-[90vh]",children:e.jsxs("div",{className:"mx-auto w-full max-w-md px-4 pb-8",children:[e.jsxs(cs,{className:"pb-2",children:[e.jsx(ds,{className:"text-center",children:X==="weight"?"Charge":"Répétitions"}),e.jsxs(us,{className:"text-center",children:["Série ",h,"/",ue(p?.sets)," · Objectif"," ",ue(p?.reps)," reps"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs("button",{type:"button",className:te("rounded-xl border-2 p-4 text-center transition-all",X==="weight"?"border-primary bg-primary/10 shadow-sm":"border-muted bg-card hover:border-muted-foreground/30"),onClick:()=>jt("weight"),children:[e.jsx("div",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Charge"}),e.jsx("div",{className:"mt-1 text-2xl font-bold tabular-nums",children:(()=>{const s=X==="weight"?ne:String(ie[h-1]?.weight??ee??"");return s===String(ze)?"PDC":e.jsxs(e.Fragment,{children:[s||"—",e.jsx("span",{className:"ml-1 text-base font-normal text-muted-foreground",children:"kg"})]})})()})]}),e.jsxs("button",{type:"button",className:te("rounded-xl border-2 p-4 text-center transition-all",X==="reps"?"border-primary bg-primary/10 shadow-sm":"border-muted bg-card hover:border-muted-foreground/30"),onClick:()=>jt("reps"),children:[e.jsx("div",{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Reps"}),e.jsxs("div",{className:"mt-1 text-2xl font-bold tabular-nums",children:[X==="reps"?ne||"—":String(ie[h-1]?.reps??p?.reps??"—"),e.jsx("span",{className:"ml-1 text-base font-normal text-muted-foreground",children:"reps"})]})]})]}),X==="weight"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-2",children:"Suggestions"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(C,{variant:ne===String(ze)?"default":"outline",size:"sm",className:"rounded-full px-4 h-10 text-sm font-semibold",onClick:()=>Y(String(ze)),children:"PDC"}),ee>0&&[ee-10,ee-5,ee,ee+5,ee+10].filter(s=>s>0).map(s=>e.jsxs(C,{variant:Number(ne)===s?"default":"outline",size:"sm",className:"rounded-full px-4 h-10 text-sm font-semibold",onClick:()=>Y(String(s)),children:[s," kg"]},s))]})]}),X==="reps"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-2",children:"Suggestions"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:[6,8,10,12,15,20].map(s=>e.jsx(C,{variant:Number(ne)===s?"default":"outline",size:"sm",className:"rounded-full px-4 h-10 text-sm font-semibold",onClick:()=>Y(String(s)),children:s},s))})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4",children:[[1,2,3,4,5,6,7,8,9].map(s=>e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>Xe(String(s)),children:s},s)),e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>Xe("."),children:","}),e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>Xe("0"),children:"0"}),e.jsx(C,{variant:"outline",className:"h-14 text-xl font-semibold rounded-xl active:scale-95 transition-transform",onClick:()=>{ge(!1),Y(s=>s.slice(0,-1))},children:"⌫"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(C,{variant:"outline",className:"flex-1 h-14 text-base font-semibold rounded-xl",onClick:()=>{ge(!1),Y("")},children:"Effacer"}),e.jsxs(C,{className:"flex-1 h-14 text-base font-semibold rounded-xl",onClick:Ut,children:[e.jsx(Ct,{className:"mr-2 h-5 w-5"}),"Valider"]})]})]})})}),v&&e.jsx(Tt,{open:Q,onOpenChange:B,children:e.jsxs(Ft,{children:[e.jsxs(Lt,{children:[e.jsx(Pt,{children:"Quitter la séance ?"}),e.jsx(qt,{children:"Les séries enregistrées seront conservées."})]}),e.jsxs($t,{children:[e.jsx(Ot,{children:"Annuler"}),e.jsx(Kt,{onClick:()=>{B(!1),v()},children:"Quitter"})]})]})}),A&&e.jsx(rt,{open:he,onOpenChange:s=>{if(!s&&p){const d=ct.trim()||null,D=M?.[p.exercise_id]??null;d!==D&&A(p.exercise_id,d)}pe(s)},children:e.jsxs(nt,{side:"bottom",className:"max-h-[60vh]",children:[e.jsx(it,{children:e.jsxs(at,{children:["Notes — ",U?.nom_exercice]})}),e.jsx("textarea",{value:ct,onChange:s=>dt(s.target.value),placeholder:"Réglages machine, repères personnels...",rows:4,className:"flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm mt-4 resize-none ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"})]})})]})}const Qt=(t=[])=>{if(!t.length)return t;const a=t.map((o,m)=>{const b=Number(o.order_index);return{item:o,index:m,order:Number.isFinite(b)?b:null}});return a.some(o=>o.order!==null)?a.sort((o,m)=>o.order===null&&m.order===null?o.index-m.index:o.order===null?1:m.order===null?-1:o.order===m.order?o.index-m.index:o.order-m.order).map(o=>o.item):t},et=t=>t==="endurance"||t==="hypertrophie"||t==="force"?t:"endurance",$s=[{value:"endurance",label:"Endurance",subtitle:"Léger",icon:ys},{value:"hypertrophie",label:"Hypertrophie",subtitle:"Modéré",icon:bs},{value:"force",label:"Force",subtitle:"Lourd",icon:Fs}],Os={visible:{transition:{staggerChildren:.06}}},Ks={hidden:{opacity:0,y:16},visible:{opacity:1,y:0,transition:{type:"spring",stiffness:400,damping:30}}};function zs({user:t,userId:a,athleteName:c,athleteId:o,athleteKey:m,cycleType:b,searchQuery:y,isLoading:j,setSaveState:g,onCycleChange:k,onSearchChange:N,onStartAssignment:l,onStartCatalog:E,onResumeInProgress:v}){const{toast:M}=ot(),A=At(),[L,J]=i.useState(null),[S,K]=i.useState(!1),[T,$]=i.useState(null),[P,se]=i.useState(!1),{data:Z}=fe({queryKey:["assignments",t,"strength"],queryFn:()=>G.getAssignments(t,a,{assignmentType:"strength"}),enabled:!!t}),{data:me}=fe({queryKey:["strength_catalog"],queryFn:()=>G.getStrengthSessions()}),{data:f}=fe({queryKey:["exercises"],queryFn:()=>G.getExercises()}),w=fe({queryKey:["strength_run_in_progress",m],queryFn:()=>G.getStrengthHistory(c,{limit:1,offset:0,order:"desc",status:"in_progress",athleteId:o}),enabled:!!c}).data?.runs?.[0]??null,F=w?.status==="completed"||(w?.progress_pct??0)>=100,ae=Le({mutationFn:n=>G.deleteStrengthRun(n),onMutate:()=>{g("saving")},onSuccess:n=>{g("saved"),setTimeout(()=>g("idle"),2e3),A.invalidateQueries({queryKey:["strength_run_in_progress",m]}),A.invalidateQueries({queryKey:["strength_history"]}),A.invalidateQueries({queryKey:["assignments",t,"strength"]});const _=n?.source==="local"?"Suppression locale : le serveur n'est pas disponible.":void 0;M({title:"Séance supprimée",description:_})},onError:()=>{g("error"),setTimeout(()=>g("idle"),3e3),M({title:"Erreur",description:"Impossible de supprimer la séance en cours.",variant:"destructive"})}});i.useMemo(()=>f?new Map(f.map(n=>[n.id,n])):new Map,[f]);const le=i.useMemo(()=>Z?.filter(n=>n.session_type==="strength")||[],[Z]),re=i.useMemo(()=>le.filter(n=>n.status!=="completed"),[le]),O=i.useMemo(()=>w?re.find(n=>n.id===w.assignment_id)??null:null,[w,re]),z=i.useMemo(()=>w&&!O?me?.find(n=>n.id===w.session_id)??null:null,[w,O,me]),ve=(!!O?.items?.length||!!z?.items?.length)&&!F,Ce=i.useMemo(()=>re.map(n=>{const _=(n.items??[]).filter(q=>"exercise_id"in q);return{key:`assignment-${n.id}`,title:n.title,description:n.description,type:"assignment",assignedDate:n.assigned_date,session:{id:n.session_id,title:n.title,description:n.description,cycle:et(n.cycle),items:_},assignment:n,exerciseCount:_.length}}),[re]),xe=i.useMemo(()=>(me??[]).map(n=>({key:`catalog-${n.id}`,title:n.title,description:n.description,type:"catalog",session:{...n,cycle:b},exerciseCount:n.items?.length??0})),[me,b]),oe=i.useMemo(()=>{const n=y.trim().toLowerCase(),_=[...Ce,...xe];return n?_.filter(q=>`${q.title} ${q.description}`.toLowerCase().includes(n)):_},[Ce,xe,y]),je=i.useCallback((n,_)=>{if(!["ArrowUp","ArrowDown","Enter"].includes(n.key))return;if(n.preventDefault(),n.key==="Enter"){const R=oe[_];R.type==="assignment"&&R.assignment?l(R.assignment):E(R.session);return}let h=_;n.key==="ArrowUp"&&(h=Math.max(0,_-1)),n.key==="ArrowDown"&&(h=Math.min(oe.length-1,_+1)),J(h),setTimeout(()=>{const R=document.querySelectorAll('[data-session-card="true"]');R[h]&&R[h].focus()},0)},[oe,l,E]);if(j)return e.jsxs("div",{className:"space-y-5 pt-2",children:[e.jsx("div",{className:"grid grid-cols-3 gap-2",children:[1,2,3].map(n=>e.jsx("div",{className:"h-[60px] rounded-2xl bg-muted/50 animate-pulse"},n))}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(n=>e.jsxs("div",{className:"flex items-center gap-4 rounded-2xl bg-card p-4 shadow-sm",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-muted animate-pulse"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-3/5 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-2/5 rounded bg-muted animate-pulse"})]})]},n))})]});const V=oe.length,Ne=V>4||y.length>0;return e.jsxs("div",{className:"space-y-5 animate-in fade-in motion-reduce:animate-none",children:[e.jsx("div",{className:"grid grid-cols-3 gap-2",children:$s.map(n=>{const _=b===n.value,q=n.icon;return e.jsxs("button",{type:"button",onClick:()=>k(et(n.value)),className:te("relative flex flex-col items-center gap-0.5 rounded-2xl px-2 py-3 transition-all active:scale-[0.96]",_?"bg-primary text-primary-foreground shadow-md shadow-primary/25":"bg-muted/40 text-muted-foreground hover:bg-muted/60"),children:[e.jsx(q,{className:te("h-4 w-4 mb-0.5",_?"text-primary-foreground":"text-muted-foreground/60")}),e.jsx("span",{className:"text-[13px] font-bold leading-tight",children:n.label}),e.jsx("span",{className:te("text-[10px] leading-tight",_?"text-primary-foreground/70":"text-muted-foreground/50"),children:n.subtitle})]},n.value)})}),w&&e.jsxs(qe.div,{initial:{opacity:0,scale:.97},animate:{opacity:1,scale:1},transition:{type:"spring",stiffness:300,damping:25},className:"relative isolate overflow-hidden rounded-2xl bg-gradient-to-br from-primary via-primary to-primary/85 text-primary-foreground p-5 shadow-xl shadow-primary/20",children:[e.jsx("div",{className:"pointer-events-none absolute -top-10 -right-10 h-32 w-32 rounded-full bg-white/10 blur-3xl"}),e.jsx("div",{className:"pointer-events-none absolute -bottom-8 -left-8 h-24 w-24 rounded-full bg-white/5 blur-2xl"}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsxs("span",{className:"relative flex h-2.5 w-2.5",children:[!F&&e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-60"}),e.jsx("span",{className:"relative inline-flex rounded-full h-2.5 w-2.5 bg-white"})]}),e.jsx("span",{className:"text-[11px] font-bold uppercase tracking-widest text-white/80",children:F?"Complétée":"En cours"})]}),e.jsx("h3",{className:"font-display text-xl font-bold uppercase tracking-tight leading-tight mb-1",children:O?.title??z?.title??"Séance en cours"}),e.jsxs("p",{className:"text-sm text-white/50 mb-4",children:["Démarrée le"," ",Ge(new Date(w.started_at||new Date),"dd MMMM",{locale:He})]}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("div",{className:"flex justify-between text-[11px] font-bold uppercase tracking-wider mb-1.5",children:[e.jsx("span",{className:"text-white/50",children:"Progression"}),e.jsxs("span",{className:"text-white",children:[Math.round(w.progress_pct??0),"%"]})]}),e.jsx("div",{className:"h-1.5 rounded-full bg-white/15 overflow-hidden",children:e.jsx(qe.div,{className:"h-full rounded-full bg-white",initial:{width:0},animate:{width:`${w.progress_pct??0}%`},transition:{duration:.8,ease:"easeOut"}})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"secondary",className:"flex-1 h-11 rounded-xl bg-white text-primary font-bold text-sm hover:bg-white/90 shadow-none",disabled:!ve,onClick:()=>{const n=O??z;if(!n)return;const q=(O?.items??z?.items??[]).filter(W=>"exercise_id"in W),h=et(O?.cycle??z?.cycle??q.find(W=>W.cycle_type)?.cycle_type),R=q.filter(W=>W.cycle_type===h),ke=Qt(R.length?R:q);v({assignment:O??null,session:{...n,title:n.title,description:n.description??null,cycle:h,items:ke},runId:w.id,logs:w.logs??[],progressPct:w.progress_pct??0})},children:F?"Voir le résumé":"Reprendre"}),!F&&e.jsx("button",{type:"button",className:"flex h-11 w-11 items-center justify-center rounded-xl border border-white/20 text-white/70 transition hover:bg-white/10 hover:text-white active:scale-95",disabled:ae.isPending,onClick:()=>{w&&($(w.id),K(!0))},"aria-label":"Supprimer la séance",children:e.jsx($e,{className:"h-4.5 w-4.5"})})]})]})]}),Ne&&e.jsxs("div",{className:"relative",children:[e.jsx(vs,{className:"absolute left-3.5 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground/50 pointer-events-none"}),e.jsx(st,{placeholder:"Rechercher une séance...",className:"h-11 rounded-2xl bg-muted/30 pl-10 pr-4 border-0 text-sm focus-visible:ring-2 focus-visible:ring-primary/30",value:y,onChange:n=>N(n.target.value),"aria-label":"Rechercher une séance"}),y&&e.jsx("button",{type:"button",className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground/40 hover:text-muted-foreground transition",onClick:()=>N(""),"aria-label":"Effacer la recherche",children:e.jsx($e,{className:"h-4 w-4"})})]}),V>0&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-[11px] font-bold uppercase tracking-widest text-muted-foreground/60",children:[V," séance",V>1?"s":""]}),e.jsx("div",{className:"flex-1 h-px bg-border/50"})]}),V>0?e.jsx(qe.div,{className:"space-y-2.5 motion-reduce:animate-none",variants:Os,initial:"hidden",animate:"visible",children:oe.map((n,_)=>{const q=L===_||L===null&&_===0,h=n.type==="assignment";return e.jsx(qe.button,{type:"button",tabIndex:q?0:-1,"data-session-card":"true",onKeyDown:R=>je(R,_),variants:Ks,className:te("group w-full rounded-2xl bg-card text-left transition-all active:scale-[0.98] hover:shadow-md focus:outline-none motion-reduce:animate-none",h?"shadow-sm ring-1 ring-primary/10":"shadow-sm",q&&"ring-2 ring-primary/40"),onClick:()=>{if(h&&n.assignment){l(n.assignment);return}E(n.session)},children:e.jsxs("div",{className:"flex items-center gap-3.5 p-3.5",children:[e.jsx("div",{className:te("flex h-12 w-12 shrink-0 items-center justify-center rounded-xl transition-colors",h?"bg-primary/10 text-primary":"bg-muted/60 text-muted-foreground"),children:e.jsx("span",{className:te("font-display text-lg font-bold",h&&"text-primary"),children:n.exerciseCount})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center gap-2 mb-0.5",children:e.jsx("h3",{className:"font-display font-bold text-[15px] uppercase tracking-tight truncate leading-tight",children:n.title})}),e.jsxs("div",{className:"flex items-center gap-1.5 text-[13px] text-muted-foreground",children:[h&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"inline-flex items-center rounded-md bg-primary/8 px-1.5 py-px text-[10px] font-bold uppercase tracking-wider text-primary",children:"Coach"}),e.jsx("span",{className:"text-border",children:"·"})]}),e.jsxs("span",{children:[n.exerciseCount," exercice",n.exerciseCount>1?"s":""]}),h&&n.assignedDate&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-border",children:"·"}),e.jsx("span",{children:Ge(new Date(n.assignedDate),"dd MMM",{locale:He})})]}),!h&&n.description&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-border",children:"·"}),e.jsx("span",{className:"truncate",children:n.description})]})]})]}),e.jsx(Be,{className:"h-5 w-5 shrink-0 text-muted-foreground/25 transition-all group-hover:translate-x-0.5 group-hover:text-primary/60"})]})},n.key)})}):e.jsxs("div",{className:"py-16 text-center",children:[e.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-muted/40",children:e.jsx(Oe,{className:"h-7 w-7 text-muted-foreground/40"})}),e.jsx("h3",{className:"font-display font-bold text-sm uppercase tracking-tight",children:"Aucune séance trouvée"}),e.jsx("p",{className:"text-[13px] text-muted-foreground/60 mt-1.5 max-w-[240px] mx-auto",children:"Changez de cycle ou modifiez votre recherche pour trouver une séance."})]}),e.jsx(Tt,{open:S,onOpenChange:K,children:e.jsxs(Ft,{children:[e.jsxs(Lt,{children:[e.jsx(Pt,{children:"Supprimer la séance ?"}),e.jsx(qt,{children:"Les séries déjà enregistrées seront perdues."})]}),e.jsxs($t,{children:[e.jsx(Ot,{children:"Annuler"}),e.jsx(Kt,{className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",onClick:()=>{T&&ae.mutate(T),K(!1)},children:"Supprimer"})]})]})})]})}const Mt=t=>{const a=Number(t);return!Number.isFinite(a)||a<=0?"—":String(a)},Vs=t=>{const a=Number(t);return!Number.isFinite(a)||a<=0?"—":`${a}s`};function Qs({session:t,assignment:a,cycleType:c,cycleOptions:o,exercises:m,oneRMs:b,saveState:y,onBack:j,onLaunch:g}){const k=i.useMemo(()=>new Map(m.map(l=>[l.id,l])),[m]),N=t.items??[];return e.jsxs(qe.div,{className:"space-y-5 pb-36",variants:js,initial:"hidden",animate:"visible",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:j,className:"flex h-10 w-10 items-center justify-center rounded-full bg-muted/50 text-muted-foreground transition-colors hover:bg-muted active:scale-95","aria-label":"Retour",children:e.jsx(Ns,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground truncate",children:o.find(l=>l.value===c)?.label}),e.jsx("h1",{className:"text-xl font-bold tracking-tight truncate",children:t.title})]})]}),e.jsxs("div",{className:"relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary/10 via-primary/5 to-transparent border border-primary/20 p-5",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl -mr-12 -mt-12"}),e.jsxs("div",{className:"relative space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[a&&e.jsxs("span",{className:"inline-flex items-center gap-1.5 rounded-full bg-primary/20 px-3 py-1 text-xs font-bold uppercase text-primary",children:[e.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-primary"}),"Assignée"]}),!a&&e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-3 py-1 text-xs font-semibold text-muted-foreground",children:"Catalogue"}),a?.assigned_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Prévue le ",Ge(new Date(a.assigned_date),"dd MMM",{locale:He})]})]}),t.description&&e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:t.description}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-9 w-9 items-center justify-center rounded-xl bg-background/80",children:e.jsx(Oe,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:N.length}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold",children:"Exercices"})]})]}),e.jsx("div",{className:"h-8 w-px bg-border"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex h-9 w-9 items-center justify-center rounded-xl bg-background/80",children:e.jsx(As,{className:"h-4 w-4 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:o.find(l=>l.value===c)?.label}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold",children:"Cycle"})]})]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between gap-2 pt-1",children:[e.jsxs("span",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:[N.length," exercice",N.length>1?"s":""]}),e.jsx("div",{className:"flex-1 h-px bg-border"})]}),e.jsxs("div",{className:"space-y-2",children:[N.map((l,E)=>{const v=k.get(l.exercise_id),M=Number(l.percent_1rm),A=Number.isFinite(M)&&M>0,L=A?b?.find(se=>se.exercise_id===l.exercise_id)?.weight??0:0,J=A?Math.round(L*(M/100)):0,S=A?J>0?`${J} kg (${M}% 1RM)`:`${M}% 1RM`:null,K=l.notes?.trim(),T=Mt(l.sets),$=Mt(l.reps),P=Vs(l.rest_seconds);return e.jsxs(rt,{children:[e.jsx(ms,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-3 rounded-xl border bg-card px-3 py-3 text-left transition-all active:scale-[0.98] hover:border-primary/50 hover:shadow-sm",children:[e.jsx("div",{className:"flex h-7 w-7 shrink-0 items-center justify-center rounded-full bg-primary text-xs font-bold text-primary-foreground",children:E+1}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"font-semibold text-sm truncate",children:v?.nom_exercice??l.exercise_name??"Exercice"})}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0 text-xs font-medium text-muted-foreground",children:[e.jsxs("span",{className:"font-mono",children:[T,"×",$]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsx("span",{className:"font-mono",children:P}),e.jsx(Be,{className:"h-4 w-4 text-muted-foreground/50"})]})]})}),e.jsxs(nt,{side:"bottom",className:"max-h-[90vh] overflow-y-auto rounded-t-3xl pb-8",children:[e.jsx(it,{className:"text-left pb-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-primary text-sm font-bold text-primary-foreground",children:E+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(at,{className:"text-xl leading-tight",children:v?.nom_exercice??l.exercise_name??"Exercice"}),v?.exercise_type&&e.jsx("p",{className:"text-sm text-muted-foreground mt-0.5",children:v.exercise_type})]})]})}),e.jsxs("div",{className:"space-y-4",children:[v?.illustration_gif&&e.jsx("div",{className:"rounded-xl overflow-hidden bg-muted/20 border aspect-video flex items-center justify-center",children:e.jsx("img",{src:v.illustration_gif,alt:v.nom_exercice??"Exercice",className:"w-full h-full max-h-36 object-contain",loading:"lazy",decoding:"async"})}),v?.description&&e.jsx("div",{className:"text-sm text-muted-foreground leading-relaxed",children:v.description}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold leading-none",children:T}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Séries"})]}),e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-2xl font-bold leading-none",children:$}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Reps"})]}),e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:S??"—"}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Charge"})]}),e.jsxs("div",{className:"rounded-xl bg-muted/40 p-3 text-center",children:[e.jsx("p",{className:"text-lg font-bold leading-none",children:P}),e.jsx("p",{className:"text-[10px] uppercase text-muted-foreground font-semibold mt-1",children:"Repos"})]})]}),K&&e.jsxs("div",{className:"rounded-xl bg-primary/5 border border-primary/20 p-4",children:[e.jsx("div",{className:"text-[10px] uppercase text-primary font-semibold mb-1",children:"Notes coach"}),e.jsx("div",{className:"text-sm text-foreground",children:K})]})]})]})]},`${l.exercise_id}-${E}`)}),N.length===0&&e.jsx("div",{className:"p-6 border-2 border-dashed rounded-xl text-center text-muted-foreground",children:"Aucun exercice disponible pour cette séance."})]}),e.jsx(zt,{saveState:y,className:"bottom-0",children:e.jsxs(C,{variant:"default",className:"flex-1 h-14 rounded-xl font-bold text-base shadow-lg",onClick:g,children:[e.jsx(ws,{className:"h-5 w-5 mr-2"}),"Lancer la séance"]})})]})}function Bs({athleteName:t,athleteId:a,athleteKey:c}){const[o,m]=i.useState("all"),[b,y]=i.useState(""),[j,g]=i.useState(""),k=es({queryKey:["strength_history",c,o,b,j],queryFn:({pageParam:l=0})=>G.getStrengthHistory(t,{athleteId:a,limit:10,offset:l,order:"desc",status:o==="all"?void 0:o,from:b||void 0,to:j||void 0}),enabled:!!t,getNextPageParam:l=>{const E=l.pagination.offset+l.pagination.limit;return E<l.pagination.total?E:void 0},initialPageParam:0}),N=k.data?.pages.flatMap(l=>l.runs)??[];return e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(_e,{htmlFor:"strength-history-status",children:"Statut"}),e.jsxs(Ss,{value:o,onValueChange:m,children:[e.jsx(_s,{id:"strength-history-status",children:e.jsx(Cs,{placeholder:"Tous"})}),e.jsxs(ks,{children:[e.jsx(Ve,{value:"all",children:"Tous"}),e.jsx(Ve,{value:"in_progress",children:"En cours"}),e.jsx(Ve,{value:"completed",children:"Terminé"}),e.jsx(Ve,{value:"abandoned",children:"Abandonné"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(_e,{htmlFor:"strength-history-from",children:"Du"}),e.jsx(st,{id:"strength-history-from",type:"date",value:b,onChange:l=>y(l.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(_e,{htmlFor:"strength-history-to",children:"Au"}),e.jsx(st,{id:"strength-history-to",type:"date",value:j,onChange:l=>g(l.target.value)})]})]}),N.map(l=>e.jsx(Pe,{className:"group hover:border-primary/50 transition-colors",children:e.jsxs(It,{className:"pb-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(Dt,{className:"text-base font-bold uppercase",children:Ge(new Date(l.started_at||l.date||l.created_at||new Date),"dd MMM yyyy",{locale:He})}),e.jsxs("div",{className:"text-sm font-mono font-bold text-muted-foreground group-hover:text-primary",children:[l.duration??0," min"]})]}),e.jsxs("div",{className:"flex gap-2 text-xs font-bold text-muted-foreground",children:[e.jsxs("span",{children:["Difficulté ",l.feeling??l.rpe??0,"/5"]}),e.jsx("span",{children:"•"}),e.jsxs("span",{children:[l.logs?.length||0," Séries"]})]})]})},l.id)),N.length===0&&e.jsx("div",{className:"text-center text-muted-foreground py-10",children:"Aucun historique."}),k.hasNextPage&&e.jsx(C,{variant:"outline",size:"sm",className:"w-full",onClick:()=>k.fetchNextPage(),disabled:k.isFetchingNextPage,children:k.isFetchingNextPage?"Chargement...":"Charger plus"})]})}const Hs=t=>t==="endurance"||t==="hypertrophie"||t==="force"?t:"endurance";function Gs({athleteKey:t}){const a="strength-preferences",c=i.useMemo(()=>`strength-focus-state-${t??"anonymous"}`,[t]),[o,m]=i.useState(null),[b,y]=i.useState(null),[j,g]=i.useState(null),[k,N]=i.useState(null),[l,E]=i.useState(0),[v,M]=i.useState("list"),[A,L]=i.useState(!1),[J,S]=i.useState("idle"),[K,T]=i.useState({poolMode:!1,largeText:!1}),[$,P]=i.useState(""),[se,Z]=i.useState("endurance");return i.useEffect(()=>{if(typeof window>"u")return;const f=window.localStorage.getItem(a);if(f)try{const I=JSON.parse(f);T(w=>({...w,...I??{}}))}catch{return}},[]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(a,JSON.stringify(K))},[a,K]),i.useEffect(()=>{if(!(typeof document>"u")){if(v==="focus")return document.body.dataset.focusMode="strength",()=>{document.body.dataset.focusMode==="strength"&&delete document.body.dataset.focusMode};document.body.dataset.focusMode==="strength"&&delete document.body.dataset.focusMode}},[v]),i.useEffect(()=>{if(typeof window>"u"||o)return;const f=window.localStorage.getItem(c);if(f)try{const I=JSON.parse(f),w=I?.screenMode==="focus"?"focus":I?.screenMode==="reader"?"reader":null;if(!w||!I?.session)return;m(I.session),y(I.assignment??null),g(typeof I.runId=="number"?I.runId:null),N(Array.isArray(I.runLogs)?I.runLogs:null),E(Number.isFinite(I.runnerStep)?I.runnerStep:0),I.cycleType&&Z(Hs(I.cycleType)),M(w)}catch{return}},[o,c]),i.useEffect(()=>{if(typeof window>"u")return;if(!(v==="focus"||v==="reader")||!o){window.localStorage.removeItem(c);return}const I={screenMode:v,session:o,assignment:b,runId:j,runLogs:k,runnerStep:l,cycleType:se};window.localStorage.setItem(c,JSON.stringify(I))},[b,j,k,l,o,se,c,v]),i.useEffect(()=>{const f=()=>{M("list"),m(null),y(null),g(null),N(null),E(0),P("")};return window.addEventListener("nav:reset",f),()=>window.removeEventListener("nav:reset",f)},[]),{activeSession:o,setActiveSession:m,activeAssignment:b,setActiveAssignment:y,activeRunId:j,setActiveRunId:g,activeRunLogs:k,setActiveRunLogs:N,activeRunnerStep:l,setActiveRunnerStep:E,screenMode:v,setScreenMode:M,isFinishing:A,setIsFinishing:L,saveState:J,setSaveState:S,preferences:K,setPreferences:T,searchQuery:$,setSearchQuery:P,cycleType:se,setCycleType:Z,clearActiveRunState:()=>{m(null),y(null),g(null),N(null),E(0),M("list")}}}const Et=t=>t==="endurance"||t==="hypertrophie"||t==="force"?t:"endurance",Fe=t=>{const a=Number(t);return!Number.isFinite(a)||a<=0?null:a},Ws=(t,a)=>{if(!t)return{sets:null,reps:null,percent1rm:null,restSeries:null,restExercise:null};const c={endurance:{sets:t.Nb_series_endurance,reps:t.Nb_reps_endurance,percent1rm:t.pct_1rm_endurance,restSeries:t.recup_endurance,restExercise:t.recup_exercices_endurance},hypertrophie:{sets:t.Nb_series_hypertrophie,reps:t.Nb_reps_hypertrophie,percent1rm:t.pct_1rm_hypertrophie,restSeries:t.recup_hypertrophie,restExercise:t.recup_exercices_hypertrophie},force:{sets:t.Nb_series_force,reps:t.Nb_reps_force,percent1rm:t.pct_1rm_force,restSeries:t.recup_force,restExercise:t.recup_exercices_force}}[a];return{sets:Fe(c.sets),reps:Fe(c.reps),percent1rm:Fe(c.percent1rm),restSeries:Fe(c.restSeries),restExercise:Fe(c.restExercise)}},Js=(t=[],a)=>{const c=t.filter(m=>m.cycle_type===a),o=c.length?c:t;return Qt(o)},tt=(t=[],a,c)=>Js(t,a).map(o=>{const m=Ws(c.get(o.exercise_id),a);return{...o,sets:m.sets??0,reps:m.reps??0,rest_seconds:m.restSeries??0,percent_1rm:m.percent1rm??0}}),Lr=t=>{t.setActiveSession(null),t.setActiveAssignment(null),t.setActiveRunId(null),t.setActiveRunLogs(null),t.setActiveRunnerStep(0),t.setScreenMode("list")},Zs=({runId:t,assignmentId:a,startedAt:c})=>({id:t,assignment_id:a??null,started_at:c,progress_pct:0,status:"in_progress",logs:[]}),Rt=t=>({runs:t?[t]:[],pagination:{limit:1,offset:0,total:t?1:0},exercise_summary:[]});function Pr(){const t=De(r=>r.user),a=De(r=>r.userId),c=De(r=>r.role),o=De(r=>r.selectedAthleteId),m=De(r=>r.selectedAthleteName),{toast:b}=ot(),y=At(),j=(c==="coach"||c==="admin")&&(o!==null||!!m),g=j?m:t,k=j?o:a,N=k??g,{activeSession:l,setActiveSession:E,activeAssignment:v,setActiveAssignment:M,activeRunId:A,setActiveRunId:L,activeRunLogs:J,setActiveRunLogs:S,activeRunnerStep:K,setActiveRunnerStep:T,screenMode:$,setScreenMode:P,isFinishing:se,setIsFinishing:Z,saveState:me,setSaveState:f,searchQuery:I,setSearchQuery:w,cycleType:F,setCycleType:ae}=Gs({athleteKey:N}),le=[{value:"endurance",label:"Endurance"},{value:"hypertrophie",label:"Hypertrophie"},{value:"force",label:"Force"}],{data:re,isLoading:O,error:z,refetch:ve}=fe({queryKey:["assignments",t,"strength"],queryFn:()=>G.getAssignments(t,a,{assignmentType:"strength"}),enabled:!!t}),{data:Ce,isLoading:xe,error:oe,refetch:je}=fe({queryKey:["strength_catalog"],queryFn:()=>G.getStrengthSessions()}),{data:V,error:Ne,refetch:n}=fe({queryKey:["exercises"],queryFn:()=>G.getExercises()}),_=O||xe,q=z||oe||Ne,h=()=>{ve(),je(),n()},{data:R}=fe({queryKey:["1rm",t,a],queryFn:()=>G.get1RM({athleteName:t,athleteId:a}),enabled:!!t}),ke=i.useMemo(()=>{const r={};return(R??[]).forEach(x=>{x.notes&&(r[x.exercise_id]=x.notes)}),r},[R]),W=i.useMemo(()=>V?new Map(V.map(r=>[r.id,r])):new Map,[V]),Me=i.useMemo(()=>l?tt(l.items??[],F,W):[],[l,F,W]),we=Le({mutationFn:r=>G.startStrengthRun(r),onMutate:()=>{f("saving")},onSuccess:r=>{if(f("saved"),setTimeout(()=>f("idle"),2e3),r?.run_id&&(L(r.run_id),S(x=>x??[]),N)){const x=Zs({runId:r.run_id,assignmentId:v?.id??null,startedAt:new Date().toISOString()});y.setQueryData(["strength_run_in_progress",N],Rt(x))}y.invalidateQueries({queryKey:["assignments",t,"strength"]}),y.invalidateQueries({queryKey:["strength_run_in_progress",N]}),y.invalidateQueries({queryKey:["strength_history"]})},onError:()=>{f("error"),setTimeout(()=>f("idle"),3e3),b({title:"Erreur",description:"Impossible de démarrer la séance.",variant:"destructive"})}}),X=Le({mutationFn:r=>G.logStrengthSet(r),onMutate:()=>{f("saving")},onSuccess:r=>{f("saved"),setTimeout(()=>f("idle"),2e3),r?.one_rm_updated&&(y.invalidateQueries({queryKey:["1rm",t,a]}),b({title:"Nouveau 1RM détecté",description:"Ton record vient d'être mis à jour."}))},onError:()=>{f("error"),setTimeout(()=>f("idle"),3e3),b({title:"Erreur",description:"Impossible d'enregistrer une série.",variant:"destructive"})}}),Ee=Le({mutationFn:r=>G.updateStrengthRun(r),onMutate:()=>{f("saving")},onSuccess:(r,x)=>{f("saved"),setTimeout(()=>f("idle"),2e3),Z(!1),y.invalidateQueries({queryKey:["strength_history"]}),x?.status==="completed"&&(N&&y.setQueryData(["strength_run_in_progress",N],Rt(null)),y.invalidateQueries({queryKey:["assignments",t]}),y.invalidateQueries({queryKey:["assignments",t,"strength"]}),y.invalidateQueries({queryKey:["1rm",t,a]}),y.invalidateQueries({queryKey:["hall-of-fame"]}),M(null),L(null),E(null),S(null),P("list"),b({title:"Séance sauvegardée",description:"Bravo pour l'effort !"}))},onError:(r,x)=>{f("error"),setTimeout(()=>f("idle"),3e3),x?.status==="completed"&&(Z(!1),b({title:"Erreur",description:"Impossible d'enregistrer la séance. Réessayez.",variant:"destructive"}))}}),ne=Le({mutationFn:r=>G.updateExerciseNote({athlete_id:a??0,exercise_id:r.exercise_id,notes:r.notes}),onMutate:()=>{f("saving")},onSuccess:()=>{f("saved"),setTimeout(()=>f("idle"),2e3),y.invalidateQueries({queryKey:["1rm",t,a]})},onError:()=>{f("error"),setTimeout(()=>f("idle"),3e3),b({title:"Erreur",description:"Impossible de sauvegarder la note.",variant:"destructive"})}}),Y=(r,x)=>{const Q=r.items??[],B=Et(x??r.cycle??Q.find(pe=>pe.cycle_type)?.cycle_type),he=tt(Q,B,W);M(r),E({...r,title:r.title,description:r.description,cycle:B,items:he}),L(null),S(null),T(0),P("reader")},We=r=>{if((r.items??[]).length===0){b({title:"Séance vide",description:"Aucun exercice n'est disponible pour cette séance."});return}Y(r,F),L(null),S(null)},ge=r=>{const x=r.items??[],B=x.filter(pe=>pe.cycle_type===F).length>0?F:Et(r.cycle??x.find(pe=>pe.cycle_type)?.cycle_type),he=tt(x,B,W);if(he.length===0){b({title:"Séance vide",description:"Aucun exercice n'est disponible pour cette séance."});return}E({...r,cycle:B,items:he}),M(null),L(null),S(null),T(0),P("reader")},Re=async()=>{if(!l)return;if(Me.length===0){b({title:"Séance vide",description:"Aucun exercice n'est disponible pour cette séance."});return}const r={...l,cycle:F,items:Me};if(E(r),!A){const x=v?.session_id??l?.id??null;if(!x){b({title:"Session manquante",description:"Impossible de démarrer sans session associée.",variant:"destructive"});return}try{const Q=await we.mutateAsync({assignment_id:v?.id??null,athlete_id:a??null,athleteName:t??void 0,progress_pct:0,session_id:x,cycle_type:r.cycle});Q?.run_id&&(L(Q.run_id),S(B=>B??[]))}catch{return}}T(1),P("focus")};return i.useEffect(()=>{if($!=="reader")return;const r=x=>{x.key==="Escape"&&(x.preventDefault(),P("list"))};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[$]),O||xe?e.jsxs("div",{className:"space-y-4 md:space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx(be,{className:"h-7 w-7 rounded-lg"}),e.jsx(be,{className:"h-6 w-24"})]}),e.jsx(be,{className:"h-10 w-full rounded-lg"}),e.jsx("div",{className:"grid grid-cols-3 gap-2 pt-4",children:[1,2,3].map(r=>e.jsx(be,{className:"h-[60px] rounded-2xl"},r))}),e.jsx("div",{className:"space-y-2.5",children:Array.from({length:4}).map((r,x)=>e.jsxs("div",{className:"flex items-center gap-3.5 rounded-2xl bg-card p-3.5 shadow-sm",children:[e.jsx(be,{className:"h-12 w-12 rounded-xl"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(be,{className:"h-4 w-3/5"}),e.jsx(be,{className:"h-3 w-2/5"})]})]},`skeleton-${x}`))})]}):q?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Es,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:q.message}),e.jsx(C,{variant:"default",onClick:()=>h(),className:"mt-4 h-12 md:h-10",children:"Réessayer"})]}):e.jsx("div",{className:"space-y-4 md:space-y-6",children:$==="focus"&&l?V?e.jsx("div",{className:"animate-in fade-in motion-reduce:animate-none",children:e.jsx(qs,{session:l,exercises:V,oneRMs:R||[],exerciseNotes:ke,onUpdateNote:(r,x)=>ne.mutate({exercise_id:r,notes:x}),initialLogs:J,initialStep:K,isFinishing:se,onStepChange:r=>T(r),onExitFocus:()=>P("reader"),onStart:async()=>{if(A)return;const r=v?.session_id??l?.id??null;if(!r){b({title:"Session manquante",description:"Impossible de démarrer sans session associée.",variant:"destructive"});return}const x={assignment_id:v?.id??null,athlete_id:a??null,athleteName:t??void 0,progress_pct:0,session_id:r,cycle_type:l?.cycle};try{const Q=await we.mutateAsync(x);Q?.run_id&&L(Q.run_id)}catch{return}},onLogSets:async r=>{A&&(S(x=>[...x??[],...r]),await Promise.all(r.map((x,Q)=>X.mutateAsync({run_id:A,exercise_id:x.exercise_id,set_index:x.set_number??Q+1,reps:x.reps??null,weight:x.weight??null,athlete_id:a??null,athlete_name:t??null}))))},onProgress:async r=>{A&&await Ee.mutateAsync({run_id:A,progress_pct:r,status:"in_progress"})},onFinish:r=>{A&&(Z(!0),Ee.mutate({assignment_id:v?.id??void 0,run_id:A,session_id:v?.session_id??l?.id??void 0,athlete_id:a??void 0,date:new Date().toISOString(),progress_pct:100,status:"completed",...r}))}})}):e.jsxs("div",{className:"space-y-4 py-10",children:[e.jsx("div",{className:"mx-auto h-8 w-48 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"mx-auto h-4 w-32 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"space-y-3 pt-4",children:[1,2,3].map(r=>e.jsx("div",{className:"h-20 w-full rounded-xl bg-muted animate-pulse motion-reduce:animate-none"},r))})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ms,{title:"Muscu",icon:e.jsx(Oe,{className:"h-3.5 w-3.5"})}),e.jsxs(is,{defaultValue:"start",className:"w-full",children:[e.jsxs(as,{className:"grid w-full grid-cols-2",children:[e.jsx(Nt,{value:"start",children:"S'entraîner"}),e.jsx(Nt,{value:"history",children:"Historique"})]}),e.jsxs(wt,{value:"start",className:"space-y-5 pt-4",children:[$==="list"&&e.jsx(zs,{user:t,userId:a,athleteName:g,athleteId:k,athleteKey:N,cycleType:F,searchQuery:I,isLoading:_,setSaveState:f,onCycleChange:ae,onSearchChange:w,onStartAssignment:r=>{r.session_type==="strength"&&We(r)},onStartCatalog:ge,onResumeInProgress:({assignment:r,session:x,runId:Q,logs:B,progressPct:he})=>{M(r),E(x),L(Q),S(B),T(Vt(x?.items??[],B,he)),P("focus")}}),$==="reader"&&l&&V&&e.jsx(Qs,{session:l,assignment:v,cycleType:F,cycleOptions:le,exercises:V,oneRMs:R||[],saveState:me,onBack:()=>P("list"),onLaunch:Re})]}),e.jsx(wt,{value:"history",className:"space-y-4 pt-4",children:e.jsx(Bs,{athleteName:g,athleteId:k,athleteKey:N})})]})]})})}export{Rt as buildInProgressRunCache,Zs as createInProgressRun,Pr as default,Lr as resetStrengthRunState};
