import{c as xe,r as l,u as ce,d as Q,j as e}from"./vendor-query-DyA9aSKS.js";import{a as P}from"./api-DX18pG5A.js";import{d as he,B as C,E as Fe,L as _,I as ae}from"./index-DRUe19Fh.js";import{C as Be}from"./Coach-CAizrqAW.js";import{B as de}from"./badge-cLHVyF4A.js";import{S as Ue}from"./separator-BTZntkD4.js";import{S as pe,a as ge,b as fe,c as ve,d as je}from"./sheet-Dv2VsjOk.js";import{A as Ye,a as Je,b as Xe,c as Ze,d as et,e as tt,f as st,g as nt}from"./alert-dialog-Cn2NUika.js";import{S as B,a as U,b as Y,c as J,d as z}from"./select-ClQDu0AH.js";import{R as at,a as Ce}from"./radio-group-D2O4fCJf.js";import{T as rt,a as ke}from"./toggle-group-BGiXJTCR.js";import{C as ue}from"./chevron-left-BUlQW4W5.js";import{P as ne}from"./plus-BOcAN5Ut.js";import{C as Ae}from"./chevron-right-6N-eCPmJ.js";import{C as it}from"./clock-CKulKsbQ.js";import{M as Ie}from"./map-pin-CJfLRjhJ.js";import{T as $e}from"./trash-2-BVw-E_gU.js";import"./vendor-react-BzrpNAyj.js";import"./swim-CiRwn91C.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./target-BZlY_5ka.js";import"./index-CoGuN-7-.js";import"./index-deG5ocwF.js";import"./index-DMRSoOOq.js";import"./index-DCX2sNhR.js";import"./chevron-down-DKpemGEu.js";import"./chevron-up-CK181H0Z.js";import"./index-DUC-c-GA.js";import"./circle-3-EVs7PD.js";const be=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],lt=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],K=6,Oe=22,Le=Oe-K,re=40,De=Le*re,Me=Array.from({length:Le+1},(n,r)=>K+r),se=32;function O(n){return n.slice(0,5)}function Te(){return new Date().toISOString().slice(0,10)}function ie(n){const[r,i]=n.split(":").map(Number);return r*60+i}function me(n){return(ie(n)-K*60)/60*re}function ot(n,r){return me(r)-me(n)}function Ee(n){const r=new Date(n),i=r.getDay(),N=i===0?-6:1-i;return r.setDate(r.getDate()+N),r.setHours(0,0,0,0),r}function ct(n){const r=new Date(n);r.setHours(0,0,0,0),r.setDate(r.getDate()+3-(r.getDay()+6)%7);const i=new Date(r.getFullYear(),0,4);return 1+Math.round(((r.getTime()-i.getTime())/864e5-3+(i.getDay()+6)%7)/7)}function X(n){return n.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Z(n){const r=i=>String(i).padStart(2,"0");return`${n.getFullYear()}-${r(n.getMonth()+1)}-${r(n.getDate())}`}function He(n){const r=n.toLowerCase();return r.includes("piscine")||r.includes("bassin")||!r.includes("salle")&&!r.includes("muscu")&&!r.includes("ppg")&&!r.includes("gym")}const dt=({open:n,onOpenChange:r,slot:i,groups:N,coaches:k})=>{const{toast:h}=he(),g=xe(),o=!!i,[T,D]=l.useState("1"),[j,M]=l.useState(""),[f,S]=l.useState(""),[E,c]=l.useState(""),[u,v]=l.useState([]),[p,x]=l.useState(1),[L,F]=l.useState(!1);l.useEffect(()=>{if(n)if(i){D(String(i.day_of_week)),M(O(i.start_time)),S(O(i.end_time)),c(i.location);const a=i.assignments.map((d,I)=>({key:I,group_id:String(d.group_id),coach_id:String(d.coach_id),lane_count:d.lane_count!=null?String(d.lane_count):""}));v(a),x(a.length)}else D("1"),M(""),S(""),c(""),v([]),x(1)},[n,i]);const $=()=>{v(a=>[...a,{key:p,group_id:"",coach_id:"",lane_count:""}]),x(a=>a+1)},G=a=>{v(d=>d.filter(I=>I.key!==a))},y=(a,d,I)=>{v(R=>R.map(V=>V.key===a?{...V,[d]:I}:V))},H=()=>!j||!f?(h({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):E.trim()?{day_of_week:Number(T),start_time:j,end_time:f,location:E.trim(),assignments:u.filter(a=>a.group_id&&a.coach_id).map(a=>({group_id:Number(a.group_id),coach_id:Number(a.coach_id),lane_count:a.lane_count?Number(a.lane_count):null}))}:(h({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),w=Q({mutationFn:a=>P.createTrainingSlot(a),onSuccess:()=>{h({title:"Creneau cree"}),g.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:a=>{h({title:"Erreur",description:a.message,variant:"destructive"})}}),q=Q({mutationFn:a=>P.updateTrainingSlot(i.id,a),onSuccess:()=>{h({title:"Creneau mis a jour"}),g.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:a=>{h({title:"Erreur",description:a.message,variant:"destructive"})}}),A=Q({mutationFn:()=>P.deleteTrainingSlot(i.id),onSuccess:()=>{h({title:"Creneau supprime"}),g.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:a=>{h({title:"Erreur",description:a.message,variant:"destructive"})}}),W=()=>{const a=H();a&&(o?q.mutate(a):w.mutate(a))},b=w.isPending||q.isPending||A.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(pe,{open:n,onOpenChange:r,children:e.jsxs(ge,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(fe,{children:[e.jsx(ve,{children:o?"Modifier le creneau":"Nouveau creneau"}),e.jsx(je,{children:o?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Jour de la semaine *"}),e.jsxs(B,{value:T,onValueChange:D,children:[e.jsx(U,{children:e.jsx(Y,{})}),e.jsx(J,{children:be.map((a,d)=>e.jsx(z,{value:String(d+1),children:a},d+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:j,onChange:a=>M(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:f,onChange:a=>S(a.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(ae,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:E,onChange:a=>c(a.target.value)})]}),e.jsx(Ue,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(_,{children:"Groupes & Coachs"}),e.jsxs(C,{type:"button",variant:"outline",size:"sm",onClick:$,children:[e.jsx(ne,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),u.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),u.map(a=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(B,{value:a.group_id,onValueChange:d=>y(a.key,"group_id",d),children:[e.jsx(U,{className:"h-8 text-xs",children:e.jsx(Y,{placeholder:"Groupe..."})}),e.jsx(J,{children:N.map(d=>e.jsx(z,{value:String(d.id),children:d.name},d.id))})]}),e.jsxs(B,{value:a.coach_id,onValueChange:d=>y(a.key,"coach_id",d),children:[e.jsx(U,{className:"h-8 text-xs",children:e.jsx(Y,{placeholder:"Coach..."})}),e.jsx(J,{children:k.map(d=>e.jsx(z,{value:String(d.id),children:d.display_name},d.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{type:"number",min:0,placeholder:"Lignes d'eau",value:a.lane_count,onChange:d=>y(a.key,"lane_count",d.target.value),className:"h-8 text-xs flex-1"}),e.jsx(C,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>G(a.key),children:e.jsx($e,{className:"h-3.5 w-3.5"})})]})]})},a.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(C,{className:"w-full",onClick:W,disabled:b||!j||!f||!E.trim(),children:b?"Enregistrement...":o?"Enregistrer":"Creer"}),o&&e.jsx(C,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>F(!0),disabled:b,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(Ye,{open:L,onOpenChange:F,children:e.jsxs(Je,{children:[e.jsxs(Xe,{children:[e.jsx(Ze,{children:"Supprimer le creneau"}),e.jsx(et,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(tt,{children:[e.jsx(st,{children:"Annuler"}),e.jsx(nt,{onClick:()=>{A.mutate(),F(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},ut=({open:n,onOpenChange:r,slot:i})=>{const{toast:N}=he(),k=xe(),[h,g]=l.useState(""),[o,T]=l.useState("cancelled"),[D,j]=l.useState(""),[M,f]=l.useState(""),[S,E]=l.useState(""),[c,u]=l.useState("");l.useEffect(()=>{n&&(g(""),T("cancelled"),j(i?O(i.start_time):""),f(i?O(i.end_time):""),E(i?.location??""),u(""))},[n,i]);const v=Q({mutationFn:x=>P.createSlotOverride(x),onSuccess:()=>{N({title:"Exception enregistree"}),k.invalidateQueries({queryKey:["training-slot-overrides"]}),k.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:x=>{N({title:"Erreur",description:x.message,variant:"destructive"})}}),p=()=>{if(!i)return;if(!h){N({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const x={slot_id:i.id,override_date:h,status:o,new_start_time:o==="modified"&&D||null,new_end_time:o==="modified"&&M||null,new_location:o==="modified"&&S.trim()?S.trim():null,reason:c.trim()||null};v.mutate(x)};return e.jsx(pe,{open:n,onOpenChange:r,children:e.jsxs(ge,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(fe,{children:[e.jsx(ve,{children:"Exception"}),e.jsx(je,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:h,onChange:x=>g(x.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Type"}),e.jsxs(at,{value:o,onValueChange:x=>T(x),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ce,{value:"cancelled",id:"ovr-cancelled"}),e.jsx(_,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ce,{value:"modified",id:"ovr-modified"}),e.jsx(_,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),o==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:D,onChange:x=>j(x.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:M,onChange:x=>f(x.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(ae,{id:"ovr-location",value:S,onChange:x=>E(x.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(ae,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:c,onChange:x=>u(x.target.value)})]}),e.jsx(C,{className:"w-full",onClick:p,disabled:v.isPending||!h,children:v.isPending?"Enregistrement...":"Enregistrer"})]})]})})},mt=({slot:n,hasOverrides:r,cancelled:i=!1,onSelect:N})=>{const k=me(n.start_time),h=ot(n.start_time,n.end_time),g=h<50,o=He(n.location),T=i?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":o?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",D=o?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${T}`,style:{top:k,height:h,minHeight:24},onClick:()=>N(n),title:`${O(n.start_time)}–${O(n.end_time)} · ${n.location}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${g?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx(Ie,{className:`h-2.5 w-2.5 shrink-0 ${D}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:n.location}),r&&!i&&e.jsx(Fe,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),!g&&n.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:n.assignments.map(j=>e.jsx(de,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:j.group_name},j.id))}),!g&&h>=70&&n.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(n.assignments.map(j=>j.coach_name))].join(", ")})]})})},xt=({slot:n,open:r,onOpenChange:i,overrides:N,onEdit:k,onOverride:h,onDeleteOverride:g})=>n?e.jsx(pe,{open:r,onOpenChange:i,children:e.jsxs(ge,{side:"bottom",className:"max-h-[60vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(fe,{className:"pb-2",children:[e.jsxs(ve,{className:"text-left text-base",children:[be[n.day_of_week-1]," · ",O(n.start_time),"–",O(n.end_time)]}),e.jsx(je,{className:"sr-only",children:"Details du creneau"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(Ie,{className:"h-3.5 w-3.5 shrink-0"}),n.location]}),n.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:n.assignments.map(o=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(de,{variant:"secondary",className:"text-xs px-2 py-0.5",children:o.group_name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[o.coach_name,o.lane_count!=null&&` · ${o.lane_count} ligne${o.lane_count>1?"s":""}`]})]},o.id))}),N.length>0&&e.jsxs("div",{className:"space-y-1.5 pt-1 border-t border-dashed",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Exceptions"}),N.map(o=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(Fe,{className:"h-3 w-3 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(o.override_date+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}),e.jsx(de,{variant:o.status==="cancelled"?"destructive":"outline",className:"text-[10px] px-1 py-0",children:o.status==="cancelled"?"Annule":"Modifie"}),o.reason&&e.jsx("span",{className:"text-muted-foreground truncate flex-1",children:o.reason}),e.jsx(C,{variant:"ghost",size:"icon",className:"h-6 w-6 ml-auto shrink-0 text-muted-foreground hover:text-destructive",onClick:()=>g(o.id),children:e.jsx($e,{className:"h-3 w-3"})})]},o.id))]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(C,{variant:"outline",size:"sm",className:"flex-1",onClick:k,children:"Modifier"}),e.jsx(C,{variant:"outline",size:"sm",className:"flex-1",onClick:h,children:"Exception"})]})]})]})}):null,ht=({slotsByDay:n,weekDates:r,todayStr:i,overridesBySlot:N,cancelledSlotIds:k,onSelect:h,mobileTimeRange:g,onPrevWeek:o,onNextWeek:T,weekNumber:D})=>{const j=g.end-g.start,M=j*se,f=Array.from({length:j+1},(c,u)=>g.start+u),S=c=>(ie(c)-g.start*60)/60*se,E=(c,u)=>S(u)-S(c);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-8 w-8 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:o,children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",D]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[X(r[0])," – ",X(r[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-8 w-8 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:T,children:e.jsx(Ae,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"overflow-y-auto -mx-4 px-4",style:{maxHeight:"calc(100vh - 220px)"},children:e.jsxs("div",{className:"grid",style:{gridTemplateColumns:"1.5rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",r.map((c,u)=>{const v=Z(c)===i;return e.jsxs("div",{className:"text-center pb-1.5 sticky top-0 bg-background z-10",children:[e.jsx("span",{className:`text-[9px] font-semibold uppercase tracking-wider ${v?"text-primary":"text-muted-foreground"}`,children:lt[u]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] font-bold tabular-nums ${v?"text-primary":"text-foreground"}`,children:c.getDate()})]},u)}),e.jsx("div",{className:"relative sticky top-0",style:{height:M},children:f.map(c=>e.jsx("span",{className:"absolute right-0.5 text-[8px] text-muted-foreground/60 leading-none -translate-y-1/2 tabular-nums",style:{top:(c-g.start)*se},children:c},c))}),Array.from({length:7},(c,u)=>u+1).map(c=>{const u=n.get(c)??[],v=Z(r[c-1])===i;return e.jsxs("div",{className:`relative border-l ${v?"border-primary/20 bg-primary/3":"border-border/30"}`,style:{height:M},children:[f.map(p=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/15",style:{top:(p-g.start)*se}},p)),u.map(p=>{const x=S(p.start_time),L=E(p.start_time,p.end_time),F=He(p.location),$=k.has(p.id),G=(N.get(p.id)??[]).length>0,y=L<40,H=$?"bg-muted/40 border-muted-foreground/15":F?"bg-blue-500/12 border-blue-400/30 active:bg-blue-500/25":"bg-amber-400/12 border-amber-400/30 active:bg-amber-400/25";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border overflow-hidden text-left transition-colors ${H} ${$?"opacity-50":""}`,style:{top:x,height:Math.max(L,20),minHeight:20},onClick:()=>h(p),children:e.jsxs("div",{className:"px-1 py-0.5 h-full flex flex-col justify-center",children:[e.jsx("span",{className:`text-[8px] font-bold tabular-nums leading-none ${$?"line-through text-muted-foreground":F?"text-blue-700":"text-amber-700"}`,children:O(p.start_time)}),!y&&e.jsx("span",{className:"text-[7px] text-muted-foreground leading-tight mt-0.5 truncate",children:p.location.replace(/Piscine |Salle /i,"")}),!y&&L>=55&&p.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5 mt-0.5",children:p.assignments.slice(0,2).map(w=>e.jsx("span",{className:`text-[6px] font-medium px-1 py-0 rounded leading-tight ${F?"bg-blue-500/10 text-blue-600":"bg-amber-400/10 text-amber-600"}`,children:w.group_name},w.id))}),G&&!$&&e.jsx("div",{className:"absolute top-0.5 right-0.5",children:e.jsx("span",{className:"block h-1.5 w-1.5 rounded-full bg-orange-500"})})]})},p.id)})]},c)})]})})]})},Wt=({onBack:n,groups:r})=>{const{toast:i}=he(),N=xe(),[k,h]=l.useState(!1),[g,o]=l.useState(null),[T,D]=l.useState(null),[j,M]=l.useState(!1),[f,S]=l.useState(null),[E,c]=l.useState(!1),[u,v]=l.useState(()=>Ee(new Date)),p=l.useMemo(()=>ct(u),[u]),x=l.useMemo(()=>{const t=new Date(u);return t.setDate(t.getDate()+6),t},[u]),L=l.useMemo(()=>Array.from({length:7},(t,s)=>{const m=new Date(u);return m.setDate(m.getDate()+s),m}),[u]),F=()=>v(t=>{const s=new Date(t);return s.setDate(s.getDate()-7),s}),$=()=>v(t=>{const s=new Date(t);return s.setDate(s.getDate()+7),s}),G=()=>v(Ee(new Date)),[y,H]=l.useState("group"),[w,q]=l.useState("all"),[A,W]=l.useState("all"),{data:b=[],isLoading:a}=ce({queryKey:["training-slots"],queryFn:()=>P.getTrainingSlots()}),{data:d=[]}=ce({queryKey:["training-slot-overrides"],queryFn:()=>P.getSlotOverrides()}),{data:I=[]}=ce({queryKey:["users","coaches"],queryFn:()=>P.listUsers({role:"coach"})}),R=l.useMemo(()=>{if(y==="coach"&&w!=="all"){const t=Number(w);return b.filter(s=>s.assignments.some(m=>m.coach_id===t))}if(y==="group"&&A!=="all"){const t=Number(A);return b.filter(s=>s.assignments.some(m=>m.group_id===t))}return b},[b,y,w,A]),V=l.useMemo(()=>{const t=new Map;for(let s=1;s<=7;s++)t.set(s,[]);for(const s of R)t.get(s.day_of_week).push(s);for(const s of t.values())s.sort((m,te)=>m.start_time.localeCompare(te.start_time));return t},[R]),Ne=Z(u),ye=Z(x),ee=l.useMemo(()=>d.filter(t=>t.override_date>=Ne&&t.override_date<=ye),[d,Ne,ye]),le=l.useMemo(()=>{const t=new Map;for(const s of ee){const m=t.get(s.slot_id)??[];m.push(s),t.set(s.slot_id,m)}return t},[ee]),Se=l.useMemo(()=>{const t=new Set;for(const s of ee)s.status==="cancelled"&&t.add(s.slot_id);return t},[ee]),Pe=Q({mutationFn:t=>P.deleteSlotOverride(t),onSuccess:()=>{i({title:"Exception supprimee"}),N.invalidateQueries({queryKey:["training-slot-overrides"]})},onError:t=>{i({title:"Erreur",description:t.message,variant:"destructive"})}}),oe=()=>{o(null),h(!0)},we=t=>{S(t),c(!0)},ze=()=>{f&&(c(!1),o(f),h(!0))},qe=()=>{f&&(c(!1),D(f),M(!0))},Re=I.map(t=>({id:t.id,display_name:t.display_name})),Ve=l.useMemo(()=>{let t=22,s=6;for(const m of R){const te=Math.floor(ie(m.start_time)/60),_e=Math.ceil(ie(m.end_time)/60);te<t&&(t=te),_e>s&&(s=_e)}return t>=s?{start:K,end:Oe}:{start:Math.max(0,t-1),end:Math.min(24,s+1)}},[R]),Ke=b.length===0?"Planning hebdomadaire des entrainements.":`${b.length} creneau${b.length>1?"x":""}`,Ge=l.useMemo(()=>{const t=[{id:"all",label:"Tous",mode:"group",value:"all"}];for(const s of r)t.push({id:`g-${s.id}`,label:String(s.name),mode:"group",value:String(s.id)});for(const s of I)t.push({id:`c-${s.id}`,label:s.display_name,mode:"coach",value:String(s.id)});return t},[r,I]),We=l.useMemo(()=>y==="group"&&A==="all"?"all":y==="group"?`g-${A}`:y==="coach"&&w==="all"?"all":`c-${w}`,[y,A,w]),Qe=t=>{t.id==="all"?(H("group"),W("all"),q("all")):t.mode==="group"?(H("group"),W(t.value)):(H("coach"),q(t.value))};return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8 -ml-2",onClick:n,children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),b.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[b.length," créneau",b.length>1?"x":""," actif",b.length>1?"s":""]})]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:oe,children:e.jsx(ne,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(Be,{title:"Creneaux",description:Ke,onBack:n,actions:e.jsxs(C,{variant:"outline",size:"sm",onClick:oe,children:[e.jsx(ne,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})})}),!a&&b.length>0&&e.jsx("div",{className:"sm:hidden -mx-4 px-4 overflow-x-auto no-scrollbar",children:e.jsx("div",{className:"flex gap-1.5 pb-1",children:Ge.map(t=>{const s=t.id===We,m=t.mode==="coach";return e.jsx("button",{type:"button",className:`shrink-0 rounded-full px-3 py-1 text-xs font-medium transition-all active:scale-95 ${s?"bg-foreground text-background shadow-sm":"bg-muted/60 text-muted-foreground hover:bg-muted"}`,onClick:()=>Qe(t),children:m&&t.id!=="all"?`${t.label}`:t.label},t.id)})})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:F,children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:G,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",p]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[X(u)," – ",X(x)]})]}),e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:$,children:e.jsx(Ae,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-row items-center gap-3",children:[e.jsxs(rt,{type:"single",value:y,onValueChange:t=>{(t==="coach"||t==="group")&&H(t)},className:"shrink-0",children:[e.jsx(ke,{value:"group",className:"text-xs px-3",children:"Groupe"}),e.jsx(ke,{value:"coach",className:"text-xs px-3",children:"Coach"})]}),y==="group"?e.jsxs(B,{value:A,onValueChange:W,children:[e.jsx(U,{className:"w-56",children:e.jsx(Y,{placeholder:"Tous les groupes"})}),e.jsxs(J,{children:[e.jsx(z,{value:"all",children:"Tous les groupes"}),r.map(t=>e.jsx(z,{value:String(t.id),children:t.name},t.id))]})]}):e.jsxs(B,{value:w,onValueChange:q,children:[e.jsx(U,{className:"w-56",children:e.jsx(Y,{placeholder:"Tous les coachs"})}),e.jsxs(J,{children:[e.jsx(z,{value:"all",children:"Tous les coachs"}),I.map(t=>e.jsx(z,{value:String(t.id),children:t.display_name},t.id))]})]})]})]}),a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-28 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"})]}),e.jsxs("div",{className:"grid gap-0 -mx-4 px-4",style:{gridTemplateColumns:"1.5rem repeat(7, 1fr)"},children:[e.jsx("div",{}),Array.from({length:7},(t,s)=>e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("div",{className:"h-3 w-6 mx-auto rounded bg-muted animate-pulse motion-reduce:animate-none mb-0.5"}),e.jsx("div",{className:"h-3.5 w-4 mx-auto rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s)),e.jsx("div",{}),Array.from({length:7},(t,s)=>e.jsxs("div",{className:"border-l border-border/30 h-64 relative",children:[e.jsx("div",{className:"absolute left-0.5 right-0.5 top-8 h-16 rounded-md bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"absolute left-0.5 right-0.5 top-32 h-12 rounded-md bg-muted animate-pulse motion-reduce:animate-none"})]},s))]})]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(t,s)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},s))})]}):b.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(it,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(C,{variant:"outline",size:"sm",onClick:oe,children:[e.jsx(ne,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"sm:hidden",children:e.jsx(ht,{slotsByDay:V,weekDates:L,todayStr:Te(),overridesBySlot:le,cancelledSlotIds:Se,onSelect:we,mobileTimeRange:Ve,onPrevWeek:F,onNextWeek:$,weekNumber:p})}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",L.map((t,s)=>{const m=Z(t)===Te();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:be[s]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${m?"text-primary font-bold":"text-muted-foreground/60"}`,children:X(t)})]},s)}),e.jsx("div",{className:"relative",style:{height:De},children:Me.map(t=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(t-K)*re},children:[t,"h"]},t))}),Array.from({length:7},(t,s)=>s+1).map(t=>{const s=V.get(t)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:De},children:[Me.map(m=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(m-K)*re}},m)),s.map(m=>e.jsx(mt,{slot:m,hasOverrides:(le.get(m.id)??[]).length>0,cancelled:Se.has(m.id),onSelect:we},m.id))]},t)})]})})]}),e.jsx(xt,{slot:f,open:E,onOpenChange:c,overrides:f?le.get(f.id)??[]:[],onEdit:ze,onOverride:qe,onDeleteOverride:t=>Pe.mutate(t)}),e.jsx(dt,{open:k,onOpenChange:h,slot:g,groups:r,coaches:Re}),e.jsx(ut,{open:j,onOpenChange:M,slot:T})]})};export{Wt as default};
