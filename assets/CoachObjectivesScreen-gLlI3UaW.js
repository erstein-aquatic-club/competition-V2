import{r as n,u as D,j as e,c as X,d as B}from"./vendor-query-DyA9aSKS.js";import{a as b}from"./api-C0huBFeo.js";import{d as J,B as k,P as H,L as p,w as G,I as Y,s as Z}from"./index-DWyToiXM.js";import{C as $}from"./Coach-BfJYM97U.js";import{T as ee}from"./textarea-Bbbam372.js";import{B as te}from"./badge-skqrzgTN.js";import{S as M,a as P,b as V,c as K,d as w}from"./select-BZUDAg_0.js";import{T as se,a as Q}from"./toggle-group-CJiZwAPh.js";import{S as re,a as ie,b as ae,c as ne}from"./sheet-DCW-WLYR.js";import{A as oe,a as le,b as ce,c as de,d as ue,e as me,f as pe,g as he}from"./alert-dialog--JdSHPZE.js";import{a as xe,O as je,f as ge,F as ve,e as fe,p as R}from"./ObjectiveCard-OQw0EvDi.js";import"./vendor-react-BzrpNAyj.js";import"./swim-_ed_mrF4.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-CrwhBJ9I.js";import"./search-BoUA1Tdu.js";import"./trophy-OhnO5kZq.js";import"./bell-ring-Cj0nMLTn.js";import"./chevron-right-DgACIWeA.js";import"./zap-BAp2tVkz.js";import"./clock-tnF3hwCv.js";import"./index-B-9TwGac.js";import"./index-BxcqhGMB.js";import"./index-DCX2sNhR.js";import"./chevron-down-DyGYup8B.js";import"./chevron-up-D7hF1PRf.js";import"./index-BeTvDkNE.js";import"./index-Cf9qAZUX.js";async function be(h){const{data:c,error:r}=await Z.rpc("get_auth_uid_for_user",{p_user_id:h});return r?(console.error("[objectives] Failed to resolve auth UUID:",r.message),null):c}const ye=({open:h,onOpenChange:c,objective:r,athleteName:z,athleteAuthId:a,competitions:q})=>{const{toast:d}=J(),x=X(),y=!!r,[m,j]=n.useState("chrono"),[l,N]=n.useState(""),[O,g]=n.useState("25"),[u,T]=n.useState(""),[v,_]=n.useState(""),[S,A]=n.useState(""),[I,E]=n.useState(!1);n.useEffect(()=>{if(h)if(r){const t=!!r.event_code,F=!!r.text;j(t&&F?"both":F?"texte":"chrono"),N(r.event_code??""),g(String(r.pool_length??25)),T(r.target_time_seconds!=null?ge(r.target_time_seconds):""),_(r.text??""),A(r.competition_id??"")}else j("chrono"),N(""),g("25"),T(""),_(""),A("")},[h,r]);const L=B({mutationFn:t=>b.createObjective(t),onSuccess:()=>{d({title:"Objectif cree"}),x.invalidateQueries({queryKey:["objectives"]}),c(!1)},onError:t=>{d({title:"Erreur",description:t.message,variant:"destructive"})}}),C=B({mutationFn:t=>b.updateObjective(r.id,t),onSuccess:()=>{d({title:"Objectif mis a jour"}),x.invalidateQueries({queryKey:["objectives"]}),c(!1)},onError:t=>{d({title:"Erreur",description:t.message,variant:"destructive"})}}),s=B({mutationFn:()=>b.deleteObjective(r.id),onSuccess:()=>{d({title:"Objectif supprime"}),x.invalidateQueries({queryKey:["objectives"]}),c(!1)},onError:t=>{d({title:"Erreur",description:t.message,variant:"destructive"})}}),o=m==="chrono"||m==="both",i=m==="texte"||m==="both",f=()=>{if(o&&!l){d({title:"Epreuve requise",description:"Veuillez selectionner une epreuve.",variant:"destructive"});return}if(o&&u&&R(u)===null){d({title:"Format invalide",description:"Le temps doit être au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(i&&!v.trim()){d({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const t={athlete_id:a,competition_id:S&&S!=="none"?S:null,event_code:o?l:null,pool_length:o?Number(O):null,target_time_seconds:o&&u?R(u):null,text:i?v.trim():null};y?C.mutate(t):L.mutate(t)},U=L.isPending||C.isPending||s.isPending,W=n.useMemo(()=>{const t=new Date;return t.setHours(0,0,0,0),q.filter(F=>new Date(F.date+"T00:00:00").getTime()>=t.getTime())},[q]);return e.jsxs(e.Fragment,{children:[e.jsx(re,{open:h,onOpenChange:c,children:e.jsxs(ie,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(ae,{children:e.jsx(ne,{children:y?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:z})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Type d'objectif"}),e.jsxs(se,{type:"single",variant:"outline",value:m,onValueChange:t=>{t&&j(t)},className:"justify-start",children:[e.jsx(Q,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(Q,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(Q,{value:"both",className:"text-xs",children:"Les deux"})]})]}),o&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Epreuve *"}),e.jsxs(M,{value:l,onValueChange:N,children:[e.jsx(P,{children:e.jsx(V,{placeholder:"Choisir une epreuve"})}),e.jsx(K,{children:ve.map(t=>e.jsx(w,{value:t,children:fe(t)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Bassin"}),e.jsxs(M,{value:O,onValueChange:g,children:[e.jsx(P,{children:e.jsx(V,{})}),e.jsxs(K,{children:[e.jsx(w,{value:"25",children:"25m"}),e.jsx(w,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(Y,{placeholder:"Ex : 1:05:30",value:u,onChange:t=>T(t.target.value)})]})]}),i&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Objectif texte *"}),e.jsx(ee,{placeholder:"Ex : Ameliorer la coulée de dos",value:v,onChange:t=>_(t.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Lier a une competition"}),e.jsxs(M,{value:S,onValueChange:A,children:[e.jsx(P,{children:e.jsx(V,{placeholder:"Aucune"})}),e.jsxs(K,{children:[e.jsx(w,{value:"none",children:"Aucune"}),W.map(t=>e.jsxs(w,{value:t.id,children:[t.name," (",t.date,")"]},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(k,{className:"w-full",onClick:f,disabled:U,children:U?"Enregistrement...":y?"Enregistrer":"Creer"}),y&&e.jsx(k,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>E(!0),disabled:U,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(oe,{open:I,onOpenChange:E,children:e.jsxs(le,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"Supprimer l'objectif"}),e.jsx(ue,{children:"Cette action est irreversible. L'objectif sera supprime definitivement."})]}),e.jsxs(me,{children:[e.jsx(pe,{children:"Annuler"}),e.jsx(he,{onClick:()=>{s.mutate(),E(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Ze=({onBack:h,athletes:c,athletesLoading:r})=>{const{toast:z}=J(),[a,q]=n.useState(""),[d,x]=n.useState(!1),[y,m]=n.useState(null),j=n.useMemo(()=>a?c.find(s=>s.id!=null&&String(s.id)===a)??null:null,[c,a]),{data:l,isLoading:N}=D({queryKey:["auth-uid",a],queryFn:()=>be(Number(a)),enabled:!!a}),{data:O=[]}=D({queryKey:["competitions"],queryFn:()=>b.getCompetitions()}),{data:g=[],isLoading:u}=D({queryKey:["objectives",l],queryFn:()=>b.getObjectives(l),enabled:!!l}),{data:T}=D({queryKey:["profile",a],queryFn:()=>b.getProfile({userId:Number(a)}),enabled:!!a}),v=T?.ffn_iuf??null,_=n.useMemo(()=>{const s=new Date;return s.setDate(s.getDate()-360),s.toISOString().slice(0,10)},[]),{data:S=[]}=D({queryKey:["swimmer-performances-recent",v],queryFn:()=>b.getSwimmerPerformances({iuf:v,fromDate:_}),enabled:!!v}),A=n.useMemo(()=>{const s=c.filter(i=>i.id!=null),o=new Map;for(const i of s){const f=i.group_label||"Sans groupe";o.has(f)||o.set(f,[]),o.get(f).push(i)}return[...o.entries()].sort(([i],[f])=>i.localeCompare(f,"fr"))},[c]),I=()=>{if(!l){z({title:"Nageur requis",description:"Veuillez selectionner un nageur.",variant:"destructive"});return}m(null),x(!0)},E=s=>{m(s),x(!0)},L=r||!!a&&N,C=!!l&&!N;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx($,{title:"Objectifs",description:"Definissez des objectifs chrono ou texte pour chaque nageur.",onBack:h,actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:I,disabled:!l,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Nageur"}),e.jsxs(M,{value:a,onValueChange:q,children:[e.jsx(P,{children:e.jsx(V,{placeholder:"Selectionner un nageur"})}),e.jsx(K,{children:A.map(([s,o])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:s}),o.map(i=>e.jsx(w,{value:String(i.id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:i.display_name}),i.group_label&&e.jsx(te,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:i.group_label})]})},i.id))]},s))})]})]}),!a&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(G,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selectionnez un nageur pour voir et gerer ses objectifs."})]}),L&&a&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(s=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},s))}),C&&u&&e.jsx("div",{className:"space-y-2",children:[1,2].map(s=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},s))}),C&&!u&&g.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(G,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif defini pour ",j?.display_name,"."]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:I,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer le premier objectif"]})]}),C&&!u&&g.length>0&&e.jsx(xe,{children:g.map(s=>e.jsx(je,{objective:s,performances:S,onClick:()=>E(s)},s.id))}),l&&j&&e.jsx(ye,{open:d,onOpenChange:x,objective:y,athleteName:j.display_name,athleteAuthId:l,competitions:O})]})};export{Ze as default};
