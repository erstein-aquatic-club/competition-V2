import{r as a,u as P,j as e,c as X,d as K}from"./vendor-query-DyA9aSKS.js";import{a as E}from"./api-Bi5BofyP.js";import{d as R,B as V,P as Q,L as h,w as H,I as Y,s as Z}from"./index-a77HTGTn.js";import{C as $}from"./Coach-C2Y9rieI.js";import{T as ee}from"./textarea-B64rzTdK.js";import{B as te}from"./badge-D4lOcVQC.js";import{S as D,a as q,b as L,c as I,d as T}from"./select-BkX-jYEd.js";import{T as se,a as U}from"./toggle-group-BWMmLBt5.js";import{S as ie,a as re,b as ae,c as ne}from"./sheet-Cm9iCCxG.js";import{A as le,a as oe,b as ce,c as de,d as ue,e as me,f as pe,g as he}from"./alert-dialog-C-2X36En.js";import{O as xe,f as je,F as ve,e as ge,p as G}from"./ObjectiveCard-BmXQeGj1.js";import"./vendor-react-BzrpNAyj.js";import"./swim-DKM5c2mA.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-Cfuqpj5u.js";import"./search-DlCs_c3r.js";import"./trophy-17j0wfM8.js";import"./bell-ring-CzhbyKHp.js";import"./chevron-right-2rf3VcwV.js";import"./zap-CvQdoVrN.js";import"./clock-DjDmXfdz.js";import"./index-BKdYfypj.js";import"./index-B2XLW6kS.js";import"./index-DCX2sNhR.js";import"./chevron-down-BdhKl7su.js";import"./chevron-up-oWpblg1w.js";import"./index-2OXxR3Al.js";import"./index-CRmjOTHB.js";async function fe(x){const{data:o,error:i}=await Z.rpc("get_auth_uid_for_user",{p_user_id:x});return i?(console.error("[objectives] Failed to resolve auth UUID:",i.message),null):o}const be=({open:x,onOpenChange:o,objective:i,athleteName:M,athleteAuthId:n,competitions:F})=>{const{toast:c}=R(),j=X(),b=!!i,[m,v]=a.useState("chrono"),[l,N]=a.useState(""),[O,g]=a.useState("25"),[u,w]=a.useState(""),[y,_]=a.useState(""),[S,f]=a.useState(""),[s,d]=a.useState(!1);a.useEffect(()=>{if(x)if(i){const t=!!i.event_code,A=!!i.text;v(t&&A?"both":A?"texte":"chrono"),N(i.event_code??""),g(String(i.pool_length??25)),w(i.target_time_seconds!=null?je(i.target_time_seconds):""),_(i.text??""),f(i.competition_id??"")}else v("chrono"),N(""),g("25"),w(""),_(""),f("")},[x,i]);const r=K({mutationFn:t=>E.createObjective(t),onSuccess:()=>{c({title:"Objectif cree"}),j.invalidateQueries({queryKey:["objectives"]}),o(!1)},onError:t=>{c({title:"Erreur",description:t.message,variant:"destructive"})}}),p=K({mutationFn:t=>E.updateObjective(i.id,t),onSuccess:()=>{c({title:"Objectif mis a jour"}),j.invalidateQueries({queryKey:["objectives"]}),o(!1)},onError:t=>{c({title:"Erreur",description:t.message,variant:"destructive"})}}),B=K({mutationFn:()=>E.deleteObjective(i.id),onSuccess:()=>{c({title:"Objectif supprime"}),j.invalidateQueries({queryKey:["objectives"]}),o(!1)},onError:t=>{c({title:"Erreur",description:t.message,variant:"destructive"})}}),C=m==="chrono"||m==="both",k=m==="texte"||m==="both",J=()=>{if(C&&!l){c({title:"Epreuve requise",description:"Veuillez selectionner une epreuve.",variant:"destructive"});return}if(C&&u&&G(u)===null){c({title:"Format invalide",description:"Le temps doit être au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(k&&!y.trim()){c({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const t={athlete_id:n,competition_id:S&&S!=="none"?S:null,event_code:C?l:null,pool_length:C?Number(O):null,target_time_seconds:C&&u?G(u):null,text:k?y.trim():null};b?p.mutate(t):r.mutate(t)},z=r.isPending||p.isPending||B.isPending,W=a.useMemo(()=>{const t=new Date;return t.setHours(0,0,0,0),F.filter(A=>new Date(A.date+"T00:00:00").getTime()>=t.getTime())},[F]);return e.jsxs(e.Fragment,{children:[e.jsx(ie,{open:x,onOpenChange:o,children:e.jsxs(re,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(ae,{children:e.jsx(ne,{children:b?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:M})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Type d'objectif"}),e.jsxs(se,{type:"single",variant:"outline",value:m,onValueChange:t=>{t&&v(t)},className:"justify-start",children:[e.jsx(U,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(U,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(U,{value:"both",className:"text-xs",children:"Les deux"})]})]}),C&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Epreuve *"}),e.jsxs(D,{value:l,onValueChange:N,children:[e.jsx(q,{children:e.jsx(L,{placeholder:"Choisir une epreuve"})}),e.jsx(I,{children:ve.map(t=>e.jsx(T,{value:t,children:ge(t)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Bassin"}),e.jsxs(D,{value:O,onValueChange:g,children:[e.jsx(q,{children:e.jsx(L,{})}),e.jsxs(I,{children:[e.jsx(T,{value:"25",children:"25m"}),e.jsx(T,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(Y,{placeholder:"Ex : 1:05:30",value:u,onChange:t=>w(t.target.value)})]})]}),k&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Objectif texte *"}),e.jsx(ee,{placeholder:"Ex : Ameliorer la coulée de dos",value:y,onChange:t=>_(t.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Lier a une competition"}),e.jsxs(D,{value:S,onValueChange:f,children:[e.jsx(q,{children:e.jsx(L,{placeholder:"Aucune"})}),e.jsxs(I,{children:[e.jsx(T,{value:"none",children:"Aucune"}),W.map(t=>e.jsxs(T,{value:t.id,children:[t.name," (",t.date,")"]},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(V,{className:"w-full",onClick:J,disabled:z,children:z?"Enregistrement...":b?"Enregistrer":"Creer"}),b&&e.jsx(V,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>d(!0),disabled:z,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(le,{open:s,onOpenChange:d,children:e.jsxs(oe,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"Supprimer l'objectif"}),e.jsx(ue,{children:"Cette action est irreversible. L'objectif sera supprime definitivement."})]}),e.jsxs(me,{children:[e.jsx(pe,{children:"Annuler"}),e.jsx(he,{onClick:()=>{B.mutate(),d(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Ye=({onBack:x,athletes:o,athletesLoading:i})=>{const{toast:M}=R(),[n,F]=a.useState(""),[c,j]=a.useState(!1),[b,m]=a.useState(null),v=a.useMemo(()=>n?o.find(s=>s.id!=null&&String(s.id)===n)??null:null,[o,n]),{data:l,isLoading:N}=P({queryKey:["auth-uid",n],queryFn:()=>fe(Number(n)),enabled:!!n}),{data:O=[]}=P({queryKey:["competitions"],queryFn:()=>E.getCompetitions()}),{data:g=[],isLoading:u}=P({queryKey:["objectives",l],queryFn:()=>E.getObjectives(l),enabled:!!l}),w=a.useMemo(()=>{const s=o.filter(r=>r.id!=null),d=new Map;for(const r of s){const p=r.group_label||"Sans groupe";d.has(p)||d.set(p,[]),d.get(p).push(r)}return[...d.entries()].sort(([r],[p])=>r.localeCompare(p,"fr"))},[o]),y=()=>{if(!l){M({title:"Nageur requis",description:"Veuillez selectionner un nageur.",variant:"destructive"});return}m(null),j(!0)},_=s=>{m(s),j(!0)},S=i||!!n&&N,f=!!l&&!N;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx($,{title:"Objectifs",description:"Definissez des objectifs chrono ou texte pour chaque nageur.",onBack:x,actions:e.jsxs(V,{variant:"outline",size:"sm",onClick:y,disabled:!l,children:[e.jsx(Q,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Nageur"}),e.jsxs(D,{value:n,onValueChange:F,children:[e.jsx(q,{children:e.jsx(L,{placeholder:"Selectionner un nageur"})}),e.jsx(I,{children:w.map(([s,d])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:s}),d.map(r=>e.jsx(T,{value:String(r.id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:r.display_name}),r.group_label&&e.jsx(te,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:r.group_label})]})},r.id))]},s))})]})]}),!n&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(H,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selectionnez un nageur pour voir et gerer ses objectifs."})]}),S&&n&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(s=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},s))}),f&&u&&e.jsx("div",{className:"space-y-2",children:[1,2].map(s=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},s))}),f&&!u&&g.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(H,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif defini pour ",v?.display_name,"."]}),e.jsxs(V,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(Q,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer le premier objectif"]})]}),f&&!u&&g.length>0&&e.jsx("div",{className:"space-y-2",children:g.map(s=>e.jsx(xe,{objective:s,onClick:()=>_(s)},s.id))}),l&&v&&e.jsx(be,{open:c,onOpenChange:j,objective:b,athleteName:v.display_name,athleteAuthId:l,competitions:O})]})};export{Ye as default};
