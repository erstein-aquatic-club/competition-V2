import{r as n,u as K,j as e,c as $,d as U}from"./vendor-query-DyA9aSKS.js";import{a as F}from"./api-_s3tPHqU.js";import{d as J,B as k,P as H,L as h,I as ee,s as te}from"./index-C0cDZvde.js";import{C as se}from"./Coach-CbsrR8m3.js";import{T as re}from"./textarea-C44-b-2p.js";import{B as q}from"./badge-CBW-u2aJ.js";import{S as L,a as I,b as V,c as M,d as _}from"./select-D6sYM5r5.js";import{T as ie,a as B}from"./toggle-group-DXfj_Mdy.js";import{S as ae,a as ne,b as le,c as oe}from"./sheet-ogziIWug.js";import{A as ce,a as de,b as ue,c as me,d as xe,e as pe,f as he,g as je}from"./alert-dialog-CIBUjIAp.js";import{e as W,f as X,F as ge,p as G}from"./objectiveHelpers-BZkbUkU3.js";import{T as R}from"./target-DGLfKgOJ.js";import"./vendor-react-BzrpNAyj.js";import"./swim-ChU6GHJ_.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./clock-DP-uJaqK.js";import"./index-DyWOy7e5.js";import"./index-CbQlW3u-.js";import"./index-DCX2sNhR.js";import"./chevron-down-CCPH6Yk3.js";import"./chevron-up-Bo9vcLMH.js";import"./index-CHMjYvlU.js";import"./index-0QL3XLbh.js";async function ve(r){const{data:l,error:s}=await te.rpc("get_auth_uid_for_user",{p_user_id:r});return s?(console.error("[objectives] Failed to resolve auth UUID:",s.message),null):l}const fe=({open:r,onOpenChange:l,objective:s,athleteName:T,athleteAuthId:o,competitions:D})=>{const{toast:d}=J(),j=$(),N=!!s,[x,g]=n.useState("chrono"),[c,y]=n.useState(""),[O,v]=n.useState("25"),[m,w]=n.useState(""),[b,A]=n.useState(""),[S,f]=n.useState(""),[i,u]=n.useState(!1);n.useEffect(()=>{if(r)if(s){const t=!!s.event_code,E=!!s.text;g(t&&E?"both":E?"texte":"chrono"),y(s.event_code??""),v(String(s.pool_length??25)),w(s.target_time_seconds!=null?X(s.target_time_seconds):""),A(s.text??""),f(s.competition_id??"")}else g("chrono"),y(""),v("25"),w(""),A(""),f("")},[r,s]);const a=U({mutationFn:t=>F.createObjective(t),onSuccess:()=>{d({title:"Objectif cree"}),j.invalidateQueries({queryKey:["objectives"]}),l(!1)},onError:t=>{d({title:"Erreur",description:t.message,variant:"destructive"})}}),p=U({mutationFn:t=>F.updateObjective(s.id,t),onSuccess:()=>{d({title:"Objectif mis a jour"}),j.invalidateQueries({queryKey:["objectives"]}),l(!1)},onError:t=>{d({title:"Erreur",description:t.message,variant:"destructive"})}}),Q=U({mutationFn:()=>F.deleteObjective(s.id),onSuccess:()=>{d({title:"Objectif supprime"}),j.invalidateQueries({queryKey:["objectives"]}),l(!1)},onError:t=>{d({title:"Erreur",description:t.message,variant:"destructive"})}}),C=x==="chrono"||x==="both",z=x==="texte"||x==="both",Y=()=>{if(C&&!c){d({title:"Epreuve requise",description:"Veuillez selectionner une epreuve.",variant:"destructive"});return}if(C&&m&&G(m)===null){d({title:"Format invalide",description:"Le temps doit être au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(z&&!b.trim()){d({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const t={athlete_id:o,competition_id:S&&S!=="none"?S:null,event_code:C?c:null,pool_length:C?Number(O):null,target_time_seconds:C&&m?G(m):null,text:z?b.trim():null};N?p.mutate(t):a.mutate(t)},P=a.isPending||p.isPending||Q.isPending,Z=n.useMemo(()=>{const t=new Date;return t.setHours(0,0,0,0),D.filter(E=>new Date(E.date+"T00:00:00").getTime()>=t.getTime())},[D]);return e.jsxs(e.Fragment,{children:[e.jsx(ae,{open:r,onOpenChange:l,children:e.jsxs(ne,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(le,{children:e.jsx(oe,{children:N?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:T})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Type d'objectif"}),e.jsxs(ie,{type:"single",variant:"outline",value:x,onValueChange:t=>{t&&g(t)},className:"justify-start",children:[e.jsx(B,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(B,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(B,{value:"both",className:"text-xs",children:"Les deux"})]})]}),C&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Epreuve *"}),e.jsxs(L,{value:c,onValueChange:y,children:[e.jsx(I,{children:e.jsx(V,{placeholder:"Choisir une epreuve"})}),e.jsx(M,{children:ge.map(t=>e.jsx(_,{value:t,children:W(t)},t))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Bassin"}),e.jsxs(L,{value:O,onValueChange:v,children:[e.jsx(I,{children:e.jsx(V,{})}),e.jsxs(M,{children:[e.jsx(_,{value:"25",children:"25m"}),e.jsx(_,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(ee,{placeholder:"Ex : 1:05:30",value:m,onChange:t=>w(t.target.value)})]})]}),z&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Objectif texte *"}),e.jsx(re,{placeholder:"Ex : Ameliorer la coulée de dos",value:b,onChange:t=>A(t.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Lier a une competition"}),e.jsxs(L,{value:S,onValueChange:f,children:[e.jsx(I,{children:e.jsx(V,{placeholder:"Aucune"})}),e.jsxs(M,{children:[e.jsx(_,{value:"none",children:"Aucune"}),Z.map(t=>e.jsxs(_,{value:t.id,children:[t.name," (",t.date,")"]},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(k,{className:"w-full",onClick:Y,disabled:P,children:P?"Enregistrement...":N?"Enregistrer":"Creer"}),N&&e.jsx(k,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>u(!0),disabled:P,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(ce,{open:i,onOpenChange:u,children:e.jsxs(de,{children:[e.jsxs(ue,{children:[e.jsx(me,{children:"Supprimer l'objectif"}),e.jsx(xe,{children:"Cette action est irreversible. L'objectif sera supprime definitivement."})]}),e.jsxs(pe,{children:[e.jsx(he,{children:"Annuler"}),e.jsx(je,{onClick:()=>{Q.mutate(),u(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},Ne=({objective:r,onEdit:l})=>{const s=!!r.event_code,T=!!r.text;return e.jsxs("button",{type:"button",className:"w-full text-left rounded-xl border bg-card p-3 space-y-1.5 transition-colors hover:bg-muted/50",onClick:()=>l(r),children:[s&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:W(r.event_code)}),r.pool_length&&e.jsxs(q,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[r.pool_length,"m"]}),r.target_time_seconds!=null&&e.jsx(q,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:X(r.target_time_seconds)})]}),T&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:r.text}),r.competition_name&&e.jsx(q,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:r.competition_name})]})},Ge=({onBack:r,athletes:l,athletesLoading:s})=>{const{toast:T}=J(),[o,D]=n.useState(""),[d,j]=n.useState(!1),[N,x]=n.useState(null),g=n.useMemo(()=>o?l.find(i=>i.id!=null&&String(i.id)===o)??null:null,[l,o]),{data:c,isLoading:y}=K({queryKey:["auth-uid",o],queryFn:()=>ve(Number(o)),enabled:!!o}),{data:O=[]}=K({queryKey:["competitions"],queryFn:()=>F.getCompetitions()}),{data:v=[],isLoading:m}=K({queryKey:["objectives",c],queryFn:()=>F.getObjectives(c),enabled:!!c}),w=n.useMemo(()=>{const i=l.filter(a=>a.id!=null),u=new Map;for(const a of i){const p=a.group_label||"Sans groupe";u.has(p)||u.set(p,[]),u.get(p).push(a)}return[...u.entries()].sort(([a],[p])=>a.localeCompare(p,"fr"))},[l]),b=()=>{if(!c){T({title:"Nageur requis",description:"Veuillez selectionner un nageur.",variant:"destructive"});return}x(null),j(!0)},A=i=>{x(i),j(!0)},S=s||!!o&&y,f=!!c&&!y;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(se,{title:"Objectifs",description:"Definissez des objectifs chrono ou texte pour chaque nageur.",onBack:r,actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:b,disabled:!c,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Nageur"}),e.jsxs(L,{value:o,onValueChange:D,children:[e.jsx(I,{children:e.jsx(V,{placeholder:"Selectionner un nageur"})}),e.jsx(M,{children:w.map(([i,u])=>e.jsxs("div",{children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:i}),u.map(a=>e.jsx(_,{value:String(a.id),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:a.display_name}),a.group_label&&e.jsx(q,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:a.group_label})]})},a.id))]},i))})]})]}),!o&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(R,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selectionnez un nageur pour voir et gerer ses objectifs."})]}),S&&o&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(i=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},i))}),f&&m&&e.jsx("div",{className:"space-y-2",children:[1,2].map(i=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},i))}),f&&!m&&v.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(R,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif defini pour ",g?.display_name,"."]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:b,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer le premier objectif"]})]}),f&&!m&&v.length>0&&e.jsx("div",{className:"space-y-2",children:v.map(i=>e.jsx(Ne,{objective:i,onEdit:A},i.id))}),c&&g&&e.jsx(fe,{open:d,onOpenChange:j,objective:N,athleteName:g.display_name,athleteAuthId:c,competitions:O})]})};export{Ge as default};
