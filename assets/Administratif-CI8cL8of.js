import{j as e,R as f,c as Nt,a as wt,u as Z,r as Te,d as H}from"./vendor-query-DyA9aSKS.js";import{b as st,c as Mt,B as U,L as X,I as ee,d as Tt,u as ue,m as kt,n as St,o as Dt,p as Ct,P as Lt,q as _t,T as Et,r as At}from"./index-pw1--tKS.js";import{a as E}from"./api-BgPjA6V4.js";import{T as Ft,a as It}from"./toggle-group-D6dgu318.js";import{C as ke}from"./checkbox-zcRnx9IF.js";import{S as Rt,a as $t,b as Pt,c as Ot,d as qt}from"./select-CILSORSE.js";import{f as N,g as Q,c as Gt}from"./timesheetHelpers-Bz--l20Q.js";import{f as w,b as xe,c as Vt,d as zt,a as Kt}from"./vendor-date-B8Mnp-Vt.js";import{s as I}from"./swim-CtMVNajn.js";import{m as A}from"./vendor-motion-lao-Njgm.js";import{C as Bt}from"./clock-BSiP8OH3.js";import{M as He}from"./map-pin-CNqpMlWH.js";import{T as Ht}from"./trending-down-BakiPk5A.js";import{P as Qt,d as Wt,C as Yt,a as Ut,B as Xt,h as Jt,X as Zt,Y as es,T as ts,e as Qe}from"./vendor-charts-BrQ8X25f.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-aTKgBcJP.js";import"./index-BFw1rcIP.js";import"./index-C30zFZRu.js";import"./chevron-down-kSaXNmxm.js";import"./chevron-up-CLR_psg2.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=[["path",{d:"M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16",key:"jecpp"}],["rect",{width:"20",height:"14",x:"2",y:"6",rx:"2",key:"i6l2r4"}]],rs=st("briefcase",ss);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]],ns=st("car",as);function os({children:r,className:s,top:n=!1,bottom:i=!1,left:a=!1,right:u=!1}){return e.jsx("div",{className:Mt(s),style:{paddingTop:n?"env(safe-area-inset-top)":void 0,paddingBottom:i?"env(safe-area-inset-bottom)":void 0,paddingLeft:a?"env(safe-area-inset-left)":void 0,paddingRight:u?"env(safe-area-inset-right)":void 0},children:r})}const J=r=>String(r).padStart(2,"0"),Ce=(r,s,n)=>Math.max(s,Math.min(n,r)),is=(r,s)=>{const n=Math.round(r/s)*s;return Ce(n,0,60-s)},rt=(r,s=5)=>{const[n,i]=r.split(":"),a=Number(n),u=Number(i),g=Ce(Number.isFinite(a)?a:0,0,23),j=Ce(Number.isFinite(u)?u:0,0,59),x=is(j,s);return`${J(g)}:${J(x)}`},ls=(r,s)=>{const n=rt(r,s),[i,a]=n.split(":").map(u=>Number(u));return{hours:i,minutes:a}};function We({value:r,values:s,onChange:n,width:i=68,itemHeight:a=28,visibleCount:u=3,format:g,snapKey:j}){const x=f.useRef(null),v=Math.floor(u/2)*a,[T,L]=f.useState(r),M=f.useRef(r),k=f.useRef(r),h=f.useRef(null),m=f.useRef(null),b=f.useRef(!1);return f.useEffect(()=>{k.current=r,M.current=r,L(r);const p=x.current;if(!p||b.current)return;const D=Math.max(0,s.indexOf(r));p.scrollTo({top:D*a,behavior:"instant"})},[a,r,s]),f.useEffect(()=>{const p=x.current;if(!p)return;const D=Math.max(0,s.indexOf(r));p.scrollTo({top:D*a,behavior:"instant"})},[a,j,r,s]),f.useEffect(()=>{const p=x.current;if(!p)return;const D=()=>{const C=Math.round(p.scrollTop/a),F=s[Math.max(0,Math.min(s.length-1,C))];M.current=F,L(F)},z=()=>{const C=M.current;C!==k.current&&n(C),b.current=!1},O=()=>{b.current=!0,h.current&&cancelAnimationFrame(h.current),h.current=requestAnimationFrame(D),m.current&&window.clearTimeout(m.current),m.current=window.setTimeout(z,140)};return p.addEventListener("scroll",O,{passive:!0}),()=>{p.removeEventListener("scroll",O),h.current&&cancelAnimationFrame(h.current),m.current&&window.clearTimeout(m.current)}},[a,n,s]),e.jsx("div",{style:{width:i,minWidth:0,flex:`0 0 ${i}px`},children:e.jsxs("div",{className:"relative overflow-hidden rounded-xl border border-border bg-card",children:[e.jsx("div",{className:"pointer-events-none absolute left-0 right-0 top-0 z-[2]",style:{height:v,background:"linear-gradient(hsl(var(--background)), transparent)"}}),e.jsx("div",{className:"pointer-events-none absolute left-0 right-0 bottom-0 z-[2]",style:{height:v,background:"linear-gradient(transparent, hsl(var(--background)))"}}),e.jsx("div",{className:"pointer-events-none absolute left-1.5 right-1.5 z-[1] rounded-lg",style:{top:v,height:a,background:"rgba(17,17,17,0.14)",boxShadow:"inset 0 0 0 1px rgba(17,17,17,0.25)"}}),e.jsx("div",{ref:x,style:{height:a*u,overflowY:"auto",overflowX:"hidden",scrollSnapType:"y mandatory",scrollSnapStop:"always",WebkitOverflowScrolling:"touch",paddingTop:v,paddingBottom:v,touchAction:"pan-y",overscrollBehavior:"contain"},children:s.map(p=>{const D=p===T;return e.jsx("div",{className:`flex items-center justify-center text-[15px] font-bold ${D?"text-foreground":"text-muted-foreground"}`,style:{height:a,scrollSnapAlign:"center",fontWeight:D?900:700,userSelect:"none"},children:g?g(p):String(p)},p)})})]})})}function Ye({label:r,value:s,onChange:n,allowEmpty:i=!1,showEmptyButton:a=!0,snapKey:u}){const g=f.useMemo(()=>Array.from({length:24},(m,b)=>b),[]),j=f.useMemo(()=>Array.from({length:12},(m,b)=>b*5),[]),x=s||"00:00",v=f.useMemo(()=>ls(x,5),[x]),[T,L]=f.useState(v.hours),[M,k]=f.useState(v.minutes);f.useEffect(()=>{L(v.hours),k(v.minutes)},[v.hours,v.minutes]),f.useEffect(()=>{if(!s)return;const m=rt(s,5),[b,p]=m.split(":");L(Number(b)),k(Number(p))},[s]);const h=f.useCallback((m,b)=>{n(`${J(m)}:${J(b)}`)},[n]);return e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-black text-foreground",children:r}),e.jsxs("div",{className:"flex flex-wrap items-end justify-center gap-2",children:[e.jsx(We,{value:T,values:g,onChange:m=>{L(m),h(m,M)},format:m=>J(m),snapKey:u}),e.jsx(We,{value:M,values:j,onChange:m=>{k(m),h(T,m)},format:m=>J(m),snapKey:u})]}),i&&a?e.jsx("button",{type:"button",onClick:()=>n(""),className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-foreground",children:"En cours"}):null]})}const pe=r=>String(r).padStart(2,"0"),Se=()=>{const r=new Date,s=Math.round(r.getMinutes()/5)*5,n=s===60?1:0,i=(r.getHours()+n)%24,a=s===60?0:s;return`${pe(i)}:${pe(a)}`},ds=(r,s)=>{const[n,i]=r.split(":").map(v=>Number(v)),a=Number.isFinite(n)?n:0,u=Number.isFinite(i)?i:0,g=(a*60+u+s+1440)%1440,j=Math.floor(g/60),x=g%60;return`${pe(j)}:${pe(x)}`};function cs({isOpen:r,isEditing:s,isSaving:n,date:i,startTime:a,endTime:u,location:g,isTravel:j,durationLabel:x,locations:v,onClose:T,onSubmit:L,onDateChange:M,onStartTimeChange:k,onEndTimeChange:h,onLocationChange:m,onTravelChange:b,onCreateLocation:p,onDeleteLocation:D,permanentGroups:z,customGroupLabels:O,selectedGroupNames:C,onGroupToggle:F,onCreateGroupLabel:K,onDeleteGroupLabel:he}){const te=f.useMemo(()=>r?Date.now():0,[r]),[se,fe]=f.useState(!1),[re,ae]=f.useState("");f.useEffect(()=>{if(!r||s||a)return;const o=Se();k(o),u||h(ds(o,60))},[u,s,r,h,k,a]);const[W,ne]=f.useState(""),$=()=>{const o=W.trim();o&&(K(o),ne(""))};return r?e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":s?"Modifier shift":"Nouveau shift",className:"fixed inset-0 z-modal flex items-end justify-center bg-black/35 px-3 pb-3",onClick:T,children:e.jsxs("div",{className:"w-full max-w-3xl overflow-hidden rounded-2xl bg-card shadow-[0_12px_40px_rgba(0,0,0,0.2)]",onClick:o=>o.stopPropagation(),children:[e.jsx("div",{className:"mx-auto mt-2 h-1.5 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"grid grid-cols-[1fr_auto] items-center gap-2 px-4 pb-2 pt-3 text-sm font-black",children:[e.jsx("div",{children:s?"Modifier shift":"Nouveau shift"}),e.jsx(U,{type:"button",variant:"outline",size:"sm",onClick:T,children:"Fermer"}),e.jsxs("div",{className:"col-span-2 text-center text-sm font-black text-card-foreground",children:[a||"—"," → ",u||"En cours",x?` • Durée ${x}`:null]})]}),e.jsxs("form",{onSubmit:L,className:"max-h-[72vh] space-y-4 overflow-y-auto px-4 pb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"shift-date",children:"Date"}),e.jsx(ee,{id:"shift-date",type:"date",value:i,onChange:o=>M(o.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ye,{label:"Heure d’arrivée",value:a,onChange:k,snapKey:te}),e.jsx("button",{type:"button","aria-label":"Heure d'arrivée maintenant",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>{const o=Se();k(o)},children:"Maintenant"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ye,{label:"Heure de sortie",value:u,onChange:h,allowEmpty:!0,showEmptyButton:!1,snapKey:te}),e.jsx("button",{type:"button","aria-label":"Heure de sortie maintenant",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>{const o=Se();h(o)},children:"Maintenant"}),e.jsx("button",{type:"button","aria-label":"Marquer comme en cours",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>h(""),children:"En cours"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"shift-location",children:"Lieu"}),e.jsxs(Rt,{value:g||void 0,onValueChange:m,children:[e.jsx($t,{id:"shift-location",children:e.jsx(Pt,{placeholder:"Sélectionner un lieu"})}),e.jsx(Ot,{children:v.map(o=>e.jsx(qt,{value:o.name,children:o.name},o.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{children:"Groupes encadrés"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[z.map(o=>e.jsxs("label",{className:"flex items-center gap-1.5 rounded-full border border-border bg-muted/30 px-3 py-1.5 text-xs font-semibold cursor-pointer select-none",children:[e.jsx(ke,{checked:C.includes(o.name),onCheckedChange:()=>F(o.name)}),e.jsx("span",{children:o.name})]},`perm-${o.id}`)),O.map(o=>e.jsxs("label",{className:"flex items-center gap-1.5 rounded-full border border-border bg-muted/30 px-3 py-1.5 text-xs font-semibold cursor-pointer select-none",children:[e.jsx(ke,{checked:C.includes(o.name),onCheckedChange:()=>F(o.name)}),e.jsx("span",{children:o.name}),e.jsx("button",{type:"button",className:"ml-1 text-muted-foreground hover:text-foreground",onClick:q=>{q.preventDefault(),he(o.id)},"aria-label":`Supprimer ${o.name}`,children:"✕"})]},`custom-${o.id}`))]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{value:W,onChange:o=>ne(o.target.value),placeholder:"Ajouter un groupe...",className:"h-8 flex-1 text-xs",onKeyDown:o=>{o.key==="Enter"&&(o.preventDefault(),$())}}),e.jsx(U,{type:"button",variant:"outline",size:"sm",className:"h-8 text-xs",onClick:$,disabled:!W.trim(),children:"+"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{id:"shift-travel",checked:j,onCheckedChange:o=>b(o===!0)}),e.jsx(X,{htmlFor:"shift-travel",children:"Temps de trajet"})]}),e.jsxs("div",{className:"flex gap-3 border-t border-border pt-3",children:[e.jsx(U,{type:"button",variant:"outline",className:"flex-1",onClick:T,children:"Annuler"}),e.jsx(U,{type:"submit",className:"flex-1",disabled:n,children:s?"Enregistrer":"Ajouter"})]})]})]})}):null}const me=r=>{if(!r)return"—";const s=new Date(r);return Number.isNaN(s.getTime())?"—":w(s,"HH:mm")},us=r=>{const s=new Date(r);return Number.isNaN(s.getTime())?r:new Intl.DateTimeFormat("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(s)};function ms({groups:r,onEdit:s,onDelete:n}){return e.jsx("div",{className:"rounded-2xl border border-border bg-card shadow-[0_1px_6px_rgba(0,0,0,0.04)]",children:r.length===0?e.jsx("div",{className:"px-4 py-4 text-sm text-muted-foreground",children:"Aucun shift pour l’instant."}):r.map(i=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 border-b border-border bg-muted px-3 py-2 text-xs font-black capitalize text-foreground",children:[e.jsx("span",{children:us(i.date)}),e.jsx("span",{children:N(i.totalMinutes)})]}),e.jsx("div",{children:i.shifts.map(a=>{const u=Q(a),g=u===null;return e.jsxs("div",{className:"flex flex-wrap items-start gap-3 border-b border-border/50 px-3 py-3",children:[e.jsx("span",{className:a.is_travel?"rounded-full border border-border bg-status-warning-bg px-2 py-1 text-[11px] font-semibold text-foreground":"rounded-full border border-border bg-tag-swim-bg/10 px-2 py-1 text-[11px] font-semibold text-foreground",children:a.is_travel?"Trajet":"Travail"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-baseline justify-between gap-2",children:[e.jsxs("div",{className:"text-sm font-black text-foreground",children:[me(a.start_time)," → ",a.end_time?me(a.end_time):"En cours",u!==null?e.jsxs("span",{className:"ml-1 text-xs font-semibold text-muted-foreground",children:["(",N(u),")"]}):null]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[e.jsx("button",{type:"button",className:"rounded-lg border border-border bg-card px-3 py-2.5 text-xs font-bold text-foreground cursor-pointer min-h-[44px] min-w-[44px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",onClick:()=>s(a),"aria-label":`Modifier le shift ${me(a.start_time)}`,children:"Modifier"}),e.jsx("button",{type:"button",className:"rounded-lg border border-border bg-card px-3 py-2.5 text-xs font-bold text-foreground cursor-pointer min-h-[44px] min-w-[44px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",onClick:()=>n(a.id),"aria-label":`Supprimer le shift ${me(a.start_time)}`,children:"Suppr."})]})]}),e.jsx("div",{className:"mt-1 text-sm text-foreground",children:a.location||"Lieu non précisé"}),a.group_names&&a.group_names.length>0?e.jsx("div",{className:"mt-1 flex flex-wrap gap-1",children:a.group_names.map(j=>e.jsx("span",{className:"rounded-full bg-primary/10 px-2 py-0.5 text-[10px] font-semibold text-primary",children:j},j))}):null,g?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:"En cours"}):null]})]},a.id)})})]},i.date))})}const Ue="hsl(var(--primary))",Xe="hsl(var(--chart-2))",De={"7d":"7 jours",month:"Ce mois",prevMonth:"Mois préc.",custom:"Dates"},Je=r=>{if(!r)return"";if(/^\d{2}:\d{2}(:\d{2})?$/.test(r))return r.slice(0,5);const s=new Date(r);return Number.isNaN(s.getTime())?"":w(s,"HH:mm")},V=r=>r.shift_date,Ze=(r,s,n)=>{const i=new Date(r).getTime(),a=new Date(s).getTime(),u=new Date(n).getTime();return i>=Math.min(a,u)&&i<=Math.max(a,u)},et=r=>r.find(s=>s.name==="Piscine")?.name??r[0]?.name??"Piscine",xs=(r,s=new Date)=>{switch(r){case"7d":return[w(Kt(s,6),"yyyy-MM-dd"),w(s,"yyyy-MM-dd")];case"month":return[w(xe(s),"yyyy-MM-dd"),w(s,"yyyy-MM-dd")];case"prevMonth":{const n=Vt(s);return[w(xe(n),"yyyy-MM-dd"),w(zt(n),"yyyy-MM-dd")]}default:return[w(xe(s),"yyyy-MM-dd"),w(s,"yyyy-MM-dd")]}},tt={visible:{transition:{staggerChildren:.06}}},R={hidden:{opacity:0,y:14},visible:{opacity:1,y:0,transition:{duration:.28,ease:"easeOut"}}};function Is({initialTab:r="POINTAGE"}){const{useMemo:s,useState:n}=wt,{toast:i}=Tt(),a=Nt(),u=typeof window>"u"?ue.getState().role:ue(t=>t.role),g=typeof window>"u"?ue.getState().userId:ue(t=>t.userId),j=u==="coach"||u==="admin",[x,v]=n(r),[T,L]=n(()=>w(new Date,"yyyy-MM-dd")),[M,k]=n(""),[h,m]=n(""),[b,p]=n("Piscine"),[D,z]=n(!1),[O,C]=n(!0),[F,K]=n(null),[he,te]=n(!1),[se,fe]=n(""),[re,ae]=n([]),[W,ne]=n("month"),[$,o]=n(()=>w(xe(new Date),"yyyy-MM-dd")),[q,Le]=n(()=>w(new Date,"yyyy-MM-dd")),{data:_=[],error:_e}=Z({queryKey:["timesheet-shifts",g],queryFn:()=>E.listTimesheetShifts({coachId:g??void 0}),enabled:j}),{data:G=[],error:Ee}=Z({queryKey:["timesheet-locations"],queryFn:()=>E.listTimesheetLocations(),enabled:j}),{data:at=[]}=Z({queryKey:["timesheet-permanent-groups"],queryFn:()=>E.listPermanentGroupsForTimesheet(),enabled:j}),{data:nt=[]}=Z({queryKey:["timesheet-group-labels"],queryFn:()=>E.listTimesheetGroupLabels(),enabled:j}),{data:Ae,error:Fe}=Z({queryKey:["capabilities","timesheet"],queryFn:()=>E.getCapabilities(),enabled:At.hasSupabase}),oe=s(()=>et(G),[G]),be=Te.useCallback(()=>{L(w(new Date,"yyyy-MM-dd")),k(""),m(""),p(oe),z(!1),ae([])},[oe]),Ie=H({mutationFn:t=>E.createTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]}),be(),i({title:"Shift enregistré"})},onError:t=>{i({title:"Erreur",description:I(t,"Impossible d'enregistrer le shift.").message})}}),Re=H({mutationFn:t=>E.updateTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]}),C(!1),K(null),be(),i({title:"Shift mis à jour"})},onError:t=>{i({title:"Erreur",description:I(t,"Impossible de modifier le shift.").message})}}),ot=H({mutationFn:t=>E.deleteTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]})},onError:t=>{i({title:"Erreur",description:I(t,"Impossible de supprimer le shift.").message})}}),ge=H({mutationFn:t=>E.createTimesheetLocation(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-locations"]})},onError:t=>{i({title:"Erreur",description:I(t,"Impossible d'ajouter le lieu.").message})}}),ve=H({mutationFn:t=>E.deleteTimesheetLocation(t),onSuccess:(t,d)=>{a.invalidateQueries({queryKey:["timesheet-locations"]});const l=G.filter(c=>c.id!==d.id);b&&l.every(c=>c.name!==b)&&p(et(l))},onError:t=>{i({title:"Erreur",description:I(t,"Impossible de supprimer le lieu.").message})}}),it=H({mutationFn:t=>E.createTimesheetGroupLabel(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-group-labels"]})},onError:t=>{i({title:"Erreur",description:I(t,"Impossible d'ajouter le groupe.").message})}}),lt=H({mutationFn:t=>E.deleteTimesheetGroupLabel(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-group-labels"]})},onError:t=>{i({title:"Erreur",description:I(t,"Impossible de supprimer le groupe.").message})}}),ie=w(new Date,"yyyy-MM-dd"),dt=s(()=>_.reduce((t,d)=>{if(V(d)!==ie)return t;const l=Q(d);return l?t+l:t},0),[_,ie]),je=s(()=>_.filter(t=>V(t)===ie&&!t.end_time).length,[_,ie]),Y=s(()=>Gt(_),[_]),ct=s(()=>{const t=[..._].sort((l,c)=>l.start_time<c.start_time?1:-1),d=new Map;return t.forEach(l=>{const c=V(l);d.has(c)||d.set(c,[]),d.get(c)?.push(l)}),Array.from(d.entries()).map(([l,c])=>{const S=c.reduce((de,Ne)=>{const we=Q(Ne);return we?de+we:de},0);return{date:l,shifts:c,totalMinutes:S}}).sort((l,c)=>l.date<c.date?1:-1)},[_]),P=s(()=>_.filter(t=>Ze(V(t),$,q)),[_,$,q]),y=s(()=>P.reduce((t,d)=>{const l=Q(d)??0;return d.is_travel?t.travel+=l:t.work+=l,t.total+=l,t},{count:P.length,work:0,travel:0,total:0}),[P]),ye=s(()=>new Set(P.map(t=>V(t))).size,[P]),ut=ye>0?y.total/ye:0,B=s(()=>{const t=new Date($),l=new Date(q).getTime()-t.getTime(),c=new Date(t.getTime()-864e5),S=new Date(c.getTime()-l),de=w(S,"yyyy-MM-dd"),Ne=w(c,"yyyy-MM-dd"),ce=_.filter(Me=>Ze(V(Me),de,Ne)).reduce((Me,yt)=>Me+(Q(yt)??0),0),Be=y.total-ce,jt=ce>0?Math.round(Be/ce*100):0;return{prevTotal:ce,delta:Be,percent:jt}},[$,q,y.total,_]),$e=B.prevTotal>0&&B.delta!==0,le=s(()=>[{name:"Travail",value:y.work,fill:Ue},{name:"Trajet",value:y.travel,fill:Xe}].filter(t=>t.value>0),[y]),Pe=s(()=>{const t=new Map;return P.forEach(d=>{const l=V(d),c=Q(d)??0,S=t.get(l)??{work:0,travel:0};d.is_travel?S.travel+=c:S.work+=c,t.set(l,S)}),Array.from(t.entries()).map(([d,{work:l,travel:c}])=>({date:d,label:w(new Date(d),"dd/MM"),work:Number((l/60).toFixed(2)),travel:Number((c/60).toFixed(2))})).sort((d,l)=>d.date<l.date?-1:1)},[P]),Oe=s(()=>{const t=new Map;P.forEach(c=>{const S=c.location||"Non précisé";t.set(S,(t.get(S)??0)+(Q(c)??0))});const d=Array.from(t.entries()).map(([c,S])=>({name:c,minutes:S})).sort((c,S)=>S.minutes-c.minutes),l=d[0]?.minutes??0;return d.map(c=>({...c,percent:l>0?c.minutes/l*100:0}))},[P]),qe=new Intl.DateTimeFormat("fr-FR",{weekday:"short",day:"numeric",month:"short"}),mt=s(()=>{if(!M||!h)return null;const t=new Date(`${T}T${M}`),d=new Date(`${T}T${h}`);if(Number.isNaN(t.getTime())||Number.isNaN(d.getTime()))return null;const l=(d.getTime()-t.getTime())/6e4;return l>0?N(l):null},[T,M,h]),xt=Ie.isPending||Re.isPending,Ge=ge.isPending||ve.isPending,pt=t=>{if(ne(t),t!=="custom"){const[d,l]=xs(t);o(d),Le(l)}},ht=t=>{if(t.preventDefault(),!T||!M){i({title:"Champs requis",description:"Date et heure de début obligatoires."});return}if(h&&h<=M){i({title:"Heures invalides",description:"La fin doit être après le début."});return}if(!g){i({title:"Utilisateur manquant"});return}F?Re.mutate({id:F,coach_id:g,shift_date:T,start_time:M,end_time:h||null,location:b.trim()||null,is_travel:D,group_names:re}):Ie.mutate({coach_id:g,shift_date:T,start_time:M,end_time:h||null,location:b.trim()||null,is_travel:D,group_names:re})},ft=()=>{be(),K(null),C(!0)},bt=t=>{K(t.id),L(V(t)),k(Je(t.start_time)),m(t.end_time?Je(t.end_time):""),p(t.location??""),z(t.is_travel),ae(t.group_names??[]),C(!0)},gt=()=>{C(!1),K(null)},vt=()=>{const t=se.trim();t&&(ge.mutate({name:t}),fe(""))};if(Te.useEffect(()=>{x==="DASHBOARD"&&(C(!1),K(null))},[x]),Te.useEffect(()=>{!O||F||(!b||G.every(t=>t.name!==b))&&p(oe)},[oe,F,O,b,G]),!j)return typeof window>"u"?null:e.jsx(kt,{to:"/"});const Ve=Fe?I(Fe,"Impossible de vérifier le module de pointage.").message:Ae?.mode==="supabase"&&!Ae.timesheet.available?"Pointage heures indisponible (tables manquantes côté D1).":null,ze=_e?I(_e,"Impossible de charger les shifts.").message:null,Ke=Ee?I(Ee,"Impossible de charger les lieux.").message:null;return e.jsxs(os,{top:!0,bottom:!0,className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"mx-auto flex w-full max-w-3xl flex-col gap-4 px-4 pt-4 text-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic",children:"Administratif"}),e.jsxs("div",{role:"tablist","aria-label":"Sections administratives",className:"flex items-center gap-1 rounded-full border border-border bg-card p-1 text-xs font-extrabold",children:[e.jsx("button",{role:"tab",type:"button","aria-selected":x==="POINTAGE","aria-controls":"tab-panel-pointage",id:"tab-pointage",className:`rounded-full px-3 py-2 transition-colors ${x==="POINTAGE"?"bg-primary text-primary-foreground":"text-foreground"}`,onClick:()=>v("POINTAGE"),children:"Pointage"}),e.jsx("button",{role:"tab",type:"button","aria-selected":x==="DASHBOARD","aria-controls":"tab-panel-dashboard",id:"tab-dashboard",className:`rounded-full px-3 py-2 transition-colors ${x==="DASHBOARD"?"bg-primary text-primary-foreground":"text-foreground"}`,onClick:()=>v("DASHBOARD"),children:"Dashboard"})]})]}),Ve?e.jsx("div",{className:"rounded-xl border border-dashed border-border bg-card px-4 py-3 text-sm text-muted-foreground",children:Ve}):null,ze?e.jsx("div",{className:"rounded-xl border border-destructive/20 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:ze}):null,Ke?e.jsx("div",{className:"rounded-xl border border-destructive/20 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:Ke}):null,x==="POINTAGE"?e.jsxs(A.div,{role:"tabpanel",id:"tab-panel-pointage","aria-labelledby":"tab-pointage",initial:"hidden",animate:"visible",variants:tt,className:"flex flex-col gap-4",children:[e.jsxs(A.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-[11px] text-muted-foreground",children:[e.jsx(Bt,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Heures aujourd'hui"})]}),e.jsx("div",{className:"mt-1 text-3xl font-bold tabular-nums text-foreground",children:N(dt)}),je>0?e.jsxs("div",{className:"mt-1.5 flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-primary animate-pulse motion-reduce:animate-none"}),je," shift",je>1?"s":""," en cours"]}):null]}),e.jsxs(A.div,{variants:R,className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Semaine"}),e.jsx("div",{className:"text-lg font-bold tabular-nums",children:N(Y.week.totalMinutes)}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[N(Y.week.workMinutes)," trav. · ",N(Y.week.travelMinutes)," trajet"]})]}),e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Mois"}),e.jsx("div",{className:"text-lg font-bold tabular-nums",children:N(Y.month.totalMinutes)}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[N(Y.month.workMinutes)," trav. · ",N(Y.month.travelMinutes)," trajet"]})]})]}),e.jsxs(A.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-bold text-foreground",children:[e.jsx(He,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Lieux"]}),e.jsx(U,{type:"button",variant:"outline",size:"sm",className:"h-8 text-xs",onClick:()=>te(t=>!t),children:"Gérer"})]}),he?e.jsxs("div",{className:"mt-3 space-y-3 text-sm text-muted-foreground",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:G.length?G.map(t=>e.jsxs("div",{className:"flex items-center gap-2 rounded-full border border-border bg-muted/30 px-3 py-1 text-xs font-semibold text-foreground",children:[e.jsx("span",{children:t.name}),e.jsx("button",{type:"button",className:"text-muted-foreground transition hover:text-foreground",onClick:()=>ve.mutate({id:t.id}),"aria-label":`Supprimer ${t.name}`,disabled:Ge,children:"✕"})]},t.id)):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Aucun lieu enregistré."})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(ee,{value:se,onChange:t=>fe(t.target.value),placeholder:"Nouveau lieu",className:"min-w-[160px] flex-1 h-9"}),e.jsx(U,{type:"button",size:"sm",className:"h-9",onClick:vt,disabled:!se.trim()||Ge,children:"Ajouter"})]})]}):null]}),e.jsx(A.div,{variants:R,children:e.jsx(ms,{groups:ct,onEdit:bt,onDelete:t=>ot.mutate({id:t})})}),e.jsx(St,{children:e.jsxs(Dt,{children:[e.jsx(Ct,{asChild:!0,children:e.jsx("button",{type:"button",className:"fixed bottom-4 right-4 z-fab flex h-14 w-14 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-[0_8px_20px_-2px_hsl(var(--primary)/0.25)] hover:bg-primary/90 transition-colors",onClick:ft,"aria-label":"Nouveau shift",children:e.jsx(Lt,{className:"h-6 w-6"})})}),e.jsx(_t,{side:"left",children:"Nouveau shift"})]})})]},"pointage"):null,x==="DASHBOARD"?e.jsxs(A.div,{role:"tabpanel",id:"tab-panel-dashboard","aria-labelledby":"tab-dashboard",initial:"hidden",animate:"visible",variants:tt,className:"flex flex-col gap-4",children:[e.jsxs(A.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Période"}),e.jsx(Ft,{type:"single",size:"sm",variant:"outline",value:W,onValueChange:t=>{t&&pt(t)},className:"flex flex-wrap gap-1",children:Object.keys(De).map(t=>e.jsx(It,{value:t,className:"h-8 px-3 text-xs","aria-label":De[t],children:De[t]},t))}),W==="custom"?e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsxs("div",{className:"min-w-[140px] flex-1 space-y-1",children:[e.jsx(X,{htmlFor:"db-from",className:"text-[11px]",children:"Du"}),e.jsx(ee,{id:"db-from",type:"date",value:$,onChange:t=>o(t.target.value),className:"h-9 text-sm"})]}),e.jsxs("div",{className:"min-w-[140px] flex-1 space-y-1",children:[e.jsx(X,{htmlFor:"db-to",className:"text-[11px]",children:"Au"}),e.jsx(ee,{id:"db-to",type:"date",value:q,onChange:t=>Le(t.target.value),className:"h-9 text-sm"})]})]}):e.jsxs("div",{className:"mt-2 text-[11px] text-muted-foreground",children:[qe.format(new Date($))," → ",qe.format(new Date(q))]})]}),e.jsxs(A.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Total période"}),e.jsx("div",{className:"text-4xl font-bold tabular-nums",children:N(y.total)})]}),$e?e.jsxs("div",{className:`flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-bold ${B.delta>0?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"}`,children:[B.delta>0?e.jsx(Et,{className:"h-3 w-3"}):e.jsx(Ht,{className:"h-3 w-3"}),B.delta>0?"+":"",B.percent,"%"]}):null]}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[y.count," shift",y.count!==1?"s":"",ye>0?` · Moy. ${N(ut)}/jour`:"",$e?` · vs ${N(B.prevTotal)} période préc.`:""]})]}),e.jsxs(A.div,{variants:R,className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[e.jsx(rs,{className:"h-3.5 w-3.5 text-primary"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Travail"})]}),e.jsx("div",{className:"text-xl font-bold tabular-nums",children:N(y.work)}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:y.total>0?`${Math.round(y.work/y.total*100)}%`:"–"})]}),e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[e.jsx(ns,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Trajet"})]}),e.jsx("div",{className:"text-xl font-bold tabular-nums",children:N(y.travel)}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:y.total>0?`${Math.round(y.travel/y.total*100)}%`:"–"})]})]}),le.length>0?e.jsxs(A.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Répartition"}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx(Qt,{width:140,height:140,children:e.jsx(Wt,{data:le,cx:70,cy:70,innerRadius:42,outerRadius:65,paddingAngle:3,dataKey:"value",strokeWidth:0,children:le.map(t=>e.jsx(Yt,{fill:t.fill},t.name))})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("span",{className:"text-sm font-bold tabular-nums",children:N(y.total)})})]}),e.jsx("div",{className:"flex-1 space-y-3",children:le.map(t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"h-3 w-3 rounded-sm shrink-0",style:{backgroundColor:t.fill}}),e.jsx("span",{className:"text-sm text-foreground",children:t.name}),e.jsx("span",{className:"ml-auto text-sm font-semibold tabular-nums",children:N(t.value)})]},t.name))})]})]}):null,e.jsxs(A.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Heures par jour"}),Pe.length>0?e.jsx("div",{className:"h-52 w-full",children:e.jsx(Ut,{width:"100%",height:"100%",children:e.jsxs(Xt,{data:Pe,margin:{top:4,right:8,left:-16,bottom:4},children:[e.jsx(Jt,{strokeDasharray:"3 3",vertical:!1,stroke:"hsl(var(--border))"}),e.jsx(Zt,{dataKey:"label",tickLine:!1,axisLine:!1,tick:{fontSize:11}}),e.jsx(es,{tickLine:!1,axisLine:!1,tick:{fontSize:11},tickFormatter:t=>`${t}h`}),e.jsx(ts,{formatter:(t,d)=>[`${t.toFixed(1)}h`,d==="work"?"Travail":"Trajet"],labelFormatter:t=>`${t}`,contentStyle:{borderRadius:8,border:"1px solid hsl(var(--border))",fontSize:12}}),e.jsx(Qe,{dataKey:"work",name:"Travail",stackId:"hours",fill:Ue}),e.jsx(Qe,{dataKey:"travel",name:"Trajet",stackId:"hours",fill:Xe,radius:[4,4,0,0]})]})})}):e.jsx("p",{className:"py-6 text-center text-sm text-muted-foreground",children:"Aucune donnée sur la période."})]}),Oe.length>0?e.jsxs(A.div,{variants:R,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Top lieux"}),e.jsx("div",{className:"space-y-3",children:Oe.map(t=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(He,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{children:t.name})]}),e.jsx("span",{className:"text-sm font-semibold tabular-nums",children:N(t.minutes)})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-2 rounded-full bg-primary transition-all duration-500",style:{width:`${t.percent}%`}})})]},t.name))})]}):null]},"dashboard"):null]}),x==="POINTAGE"?e.jsx(cs,{isOpen:O,isEditing:!!F,isSaving:xt,date:T,startTime:M,endTime:h,location:b,isTravel:D,durationLabel:mt,locations:G,onClose:gt,onSubmit:ht,onDateChange:L,onStartTimeChange:k,onEndTimeChange:m,onLocationChange:p,onTravelChange:z,onCreateLocation:t=>ge.mutate({name:t}),onDeleteLocation:t=>ve.mutate({id:t}),permanentGroups:at,customGroupLabels:nt,selectedGroupNames:re,onGroupToggle:t=>{ae(d=>d.includes(t)?d.filter(l=>l!==t):[...d,t])},onCreateGroupLabel:t=>it.mutate({name:t}),onDeleteGroupLabel:t=>lt.mutate({id:t})}):null]})}export{Is as default};
