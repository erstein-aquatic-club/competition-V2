import{c as oe,r as o,u as F,d as Q,j as e}from"./vendor-query-BiSH4r2z.js";import{u as le,b as ce,d as de,B as g,C as me,g as ue,S as y,s as $}from"./index-B4tlk-w1.js";import{B as O}from"./badge-CCR39kqK.js";import{S as pe}from"./separator-Cn-sqPqu.js";import{S as xe,E as ge}from"./SwimSessionTimeline-D9MZxAQ6.js";import{a as h}from"./api-DsW9sRiV.js";import{g as he}from"./swim-BcIsjb7Y.js";import{C as fe}from"./circle-alert-CygSs18U.js";import{C as be}from"./chevron-left-DZ5XozPv.js";import{S as je}from"./share-2-xvCdJkRn.js";import{P as we}from"./plus-DgnIAJ0Z.js";import{T as ve}from"./trash-2-F2qcFsrW.js";import{L as Ne}from"./loader-circle-BkKTqvp6.js";import{S as ye}from"./save-DgXvNw65.js";import{f as U}from"./format-B9mPVj_w.js";import{f as H}from"./fr-CFyqyHeU.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./swimConsultationUtils-7FPzL3GC.js";import"./chevron-up-CHViC04b.js";import"./timer-CrEO-TQA.js";import"./eye-D0MTEVxk.js";import"./chevron-down-CTXCf6UF.js";import"./clock-ppHi3spC.js";const Se={assigned:"Assignée",pending:"Assignée",in_progress:"En cours",completed:"Terminée",cancelled:"Annulée"},_e=r=>{if(!r)return"-";const c=new Date(r);return Number.isNaN(c.getTime())?r:U(c,"dd MMM",{locale:H})};function Ce(r){const c=new Map;for(const d of r)d.source_item_id!=null&&c.set(d.source_item_id,{exercise_label:d.exercise_label,source_item_id:d.source_item_id,split_times:d.split_times,tempo:d.tempo,stroke_count:d.stroke_count,notes:d.notes});return c}function ke(r){return r&&new Date(r).getHours()>=14?"Soir":"Matin"}function Ye(){const{user:r,userId:c}=le(),[d,A]=ce(),{toast:p}=de(),S=oe(),[V,G]=o.useState(null),[_,J]=o.useState(null),[W,f]=o.useState(!1),[C,j]=o.useState([]),[w,q]=o.useState(""),[k,T]=o.useState(1),[X,E]=o.useState(null),z=o.useMemo(()=>{const s=window.location.hash||"",t=s.indexOf("?");if(t===-1)return null;const n=new URLSearchParams(s.slice(t)).get("assignmentId"),u=n?Number(n):NaN;return Number.isFinite(u)?u:null},[d]),{data:Y,isLoading:L,error:R,refetch:Z}=F({queryKey:["assignments",r],queryFn:()=>h.getAssignments(r,c),enabled:!!r}),ee=Y?.filter(s=>s.session_type==="swim")||[],a=z?ee.find(s=>s.id===z):void 0,P=a?.session_id,{data:M}=F({queryKey:["swim-exercise-logs-by-catalog",P,c],queryFn:async()=>{const{data:s}=await $.auth.getSession(),t=s.session?.user?.id;if(!t)return[];const n=(await h.getSessions(r,c)).map(i=>i.id);if(n.length===0)return[];const u=[];for(const i of n.slice(0,10)){const m=await h.getSwimExerciseLogs(i);u.push(...m.filter(b=>b.user_id===t))}const x=new Set((a?.items??[]).map(i=>i.id).filter(Boolean));return u.filter(i=>i.source_item_id!=null&&x.has(i.source_item_id))},enabled:!!P&&!!c&&!!r}),v=o.useMemo(()=>_||(M?Ce(M):new Map),[_,M]),se=o.useCallback(s=>{G(t=>t===s?null:s)},[]),te=o.useCallback((s,t)=>{J(l=>{const n=new Map(l??v);return n.set(s,t),n}),f(!0)},[v]),K=o.useCallback(()=>{const s=w.trim();if(!s)return;const t=Date.now();j(l=>[...l,{id:t,label:s,reps:k,log:{exercise_label:s,split_times:[],stroke_count:[],tempo:null,notes:null}}]),q(""),T(1),E(t),f(!0)},[w,k]),ae=o.useCallback(s=>{j(t=>t.filter(l=>l.id!==s)),f(!0)},[]),ne=o.useCallback((s,t)=>{j(l=>l.map(n=>n.id===s?{...n,log:t}:n)),f(!0)},[]),I=Q({mutationFn:async()=>{const{data:s}=await $.auth.getSession(),t=s.session?.user?.id;if(!t||!r)throw new Error("Non authentifié");const l=a?.assigned_date?new Date(a.assigned_date).toISOString().slice(0,10):new Date().toISOString().slice(0,10),n=ke(a?.assigned_date),u=await h.ensureSwimSession({athleteName:r,athleteId:c,date:l,slot:n}),x=[];if(a)for(const[,i]of v){const m=(i.split_times??[]).some(N=>N.time_seconds>0),b=(i.stroke_count??[]).some(N=>N.count>0);(m||b||i.tempo!=null||i.notes?.trim())&&x.push(i)}else for(const i of C){const m=i.log,b=(m.split_times??[]).some(D=>D.time_seconds>0),B=(m.stroke_count??[]).some(D=>D.count>0);(b||B||m.tempo!=null||m.notes?.trim())&&x.push({...m,exercise_label:i.label})}if(x.length===0)throw new Error("Aucune donnée à sauvegarder");await h.saveSwimExerciseLogs(u,t,x)},onSuccess:()=>{f(!1),a||j([]),S.invalidateQueries({queryKey:["swim-exercise-logs-by-catalog"]}),S.invalidateQueries({queryKey:["swim-exercise-logs-history"]}),p({title:"Notes techniques sauvegardées"})},onError:s=>{p({title:"Erreur",description:s.message,variant:"destructive"})}}),ie=Q({mutationFn:s=>h.assignments_delete(s),onSuccess:()=>{S.invalidateQueries({queryKey:["assignments"]}),p({title:"Séance retirée",description:"La séance a été retirée de votre feed."}),A("/")},onError:()=>{p({title:"Erreur",description:"Impossible de retirer la séance.",variant:"destructive"})}}),re=async()=>{if(a)try{const s=await he(a.session_id),t=`${window.location.origin}${window.location.pathname}#/s/${s}`;navigator.share?await navigator.share({title:a.title,url:t}):(await navigator.clipboard.writeText(t),p({title:"Lien copié !",description:"Le lien de partage a été copié dans le presse-papier."}))}catch{p({title:"Erreur",description:"Impossible de générer le lien de partage.",variant:"destructive"})}};return R?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(fe,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:R.message}),e.jsx(g,{onClick:()=>Z(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>A("/"),"aria-label":"Retour à l'accueil",children:e.jsx(be,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Séance natation"}),e.jsx("h1",{className:"text-2xl font-display font-bold uppercase",children:"Détails"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a?e.jsx(g,{variant:"ghost",size:"icon",onClick:re,"aria-label":"Partager la séance",children:e.jsx(je,{className:"h-5 w-5"})}):null,a?e.jsx(O,{variant:"secondary",className:"text-xs",children:Se[a.status]??"Assignée"}):null]})]}),e.jsx(me,{className:"border border-border shadow-sm",children:e.jsxs(ue,{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight",children:a?.title??"Détails techniques libres"}),a?.description?e.jsx("p",{className:"text-sm text-muted-foreground",children:a.description}):!a&&!L?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Saisissez vos exercices et détails techniques manuellement."}):null]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx(O,{variant:"outline",className:"text-xs",children:a?_e(a.assigned_date):U(new Date,"dd MMM",{locale:H})}),a?e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{window.confirm("Retirer cette séance de votre feed ?")&&ie.mutate(a.id)},className:"text-xs text-muted-foreground hover:text-foreground",children:"Retirer de mon feed"}):null]}),e.jsx(pe,{}),L?null:e.jsx("div",{className:"rounded-xl bg-muted/50 px-3 py-2 text-xs text-muted-foreground leading-relaxed",children:a?"Tapez sur un exercice pour ajouter vos temps et détails techniques.":"Ajoutez vos exercices manuellement et renseignez vos détails techniques."}),L?e.jsxs("div",{className:"space-y-4","aria-live":"polite","aria-busy":"true",children:[e.jsx("div",{className:"sr-only",children:"Chargement de la séance..."}),e.jsx(y,{className:"h-6 w-48"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,t)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"h-5 w-32"}),e.jsx(y,{className:"h-4 w-full"}),e.jsx(y,{className:"h-4 w-3/4"})]},`skeleton-${t}`))})]}):a?e.jsx(xe,{title:a.title,description:a.description,items:a.items,showHeader:!0,exerciseLogs:v,expandedItemId:V,onToggleExpand:se,onLogChange:te}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Exercice"}),e.jsx("input",{type:"text",placeholder:"ex: 6x50m crawl",value:w,onChange:s=>q(s.target.value),onKeyDown:s=>{s.key==="Enter"&&K()},className:"h-9 w-full rounded-md border border-input bg-background px-3 text-sm focus:outline-none focus:ring-1 focus:ring-ring"})]}),e.jsxs("div",{className:"w-16 space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Reps"}),e.jsx("input",{type:"number",min:1,inputMode:"numeric",value:k,onChange:s=>T(Math.max(1,parseInt(s.target.value,10)||1)),className:"h-9 w-full rounded-md border border-input bg-background px-2 text-sm text-center focus:outline-none focus:ring-1 focus:ring-ring"})]}),e.jsxs(g,{size:"sm",onClick:K,disabled:!w.trim(),className:"h-9 gap-1",children:[e.jsx(we,{className:"h-4 w-4"}),"Ajouter"]})]}),C.length===0?e.jsx("div",{className:"rounded-2xl border border-dashed border-muted/70 bg-muted/30 p-6 text-center text-sm text-muted-foreground",children:"Ajoutez un exercice ci-dessus pour commencer."}):e.jsx("div",{className:"space-y-2",children:C.map(s=>{const t=X===s.id,l={label:s.label,raw_payload:{exercise_repetitions:s.reps}};return e.jsxs("div",{className:"rounded-xl border border-border overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2.5 cursor-pointer hover:bg-muted/40",onClick:()=>E(t?null:s.id),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium",children:s.label}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.reps," rep",s.reps>1?"s":""]})]}),e.jsx("button",{type:"button",onClick:n=>{n.stopPropagation(),ae(s.id)},className:"p-1 rounded-md hover:bg-destructive/10 text-muted-foreground hover:text-destructive","aria-label":"Supprimer",children:e.jsx(ve,{className:"h-4 w-4"})})]}),t&&e.jsx(ge,{item:l,log:s.log,onChange:n=>ne(s.id,n),onCollapse:()=>E(null)})]},s.id)})})]})]})}),W&&e.jsx("div",{className:"fixed bottom-6 left-0 right-0 flex justify-center z-50 px-4",children:e.jsxs(g,{onClick:()=>I.mutate(),disabled:I.isPending,className:"gap-2 shadow-lg",children:[I.isPending?e.jsx(Ne,{className:"h-4 w-4 animate-spin"}):e.jsx(ye,{className:"h-4 w-4"}),"Enregistrer"]})})]})}export{Ye as default};
