import{r as o,j as e}from"./vendor-ui-C9ymspZo.js";import{b as ie,u as ne,c as h}from"./vendor-query-kM2vrB_e.js";import{u as le,i as ce,g as l,m as de,B as p,k as E,C as w,b as R,c as I,d as A,f as L,I as m,S as oe}from"./index-Djet-LYk.js";import{S as ue}from"./switch-BrxC9xGE.js";import{B as Q}from"./badge-BfZ-seYZ.js";import{T as H,a as O,b as T,c as i,d as G,e as n}from"./table-CvDHojz4.js";import{S as J,a as X,b as W,c as Y,d as Z}from"./select-Ch_ubs6O.js";import{E as me}from"./eye-rHffST8d.js";import{R as xe}from"./refresh-cw-DWDvwBvG.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-D7BsaA6r.js";import"./check-HkluqtKb.js";const ee=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],he=a=>a==="user"?"Compte":"Ancien",pe=a=>{if(!a)return"-";const r=new Date(a);return Number.isNaN(r.getTime())?a:r.toLocaleDateString("fr-FR")+" "+r.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},je=a=>{if(!a)return"Jamais";const r=new Date(a);return Number.isNaN(r.getTime())?a:r.toLocaleDateString("fr-FR")},ge=(a,r=30)=>{if(!a)return!0;const j=new Date(a);return Number.isNaN(j.getTime())?!0:Date.now()-j.getTime()>r*24*60*60*1e3},fe=a=>{switch(a){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},ve=a=>{switch(a){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return a}};function ke(){const a=le(s=>s.role),{toast:r}=ce(),j=ie(),[c,f]=o.useState({display_name:"",iuf:"",sex:"",birthdate:""}),[g,$]=o.useState([]),[v,M]=o.useState(!1),[b,z]=o.useState(null),[B,se]=o.useState(!1),[u,N]=o.useState(null),y=a==="coach"||a==="admin",k=a==="admin",{data:q=[],refetch:S}=ne({queryKey:["import-logs"],queryFn:()=>l.getImportLogs({limit:20}),enabled:y}),x=o.useCallback(async()=>{if(y){M(!0),z(null);try{await l.syncClubRecordSwimmersFromUsers();const s=await l.getClubRecordSwimmers();$(s)}catch(s){const t=de(s,"Impossible de charger la liste.");z(t.message),$([])}finally{M(!1)}}},[y]);o.useEffect(()=>{x()},[x]),o.useEffect(()=>{k&&l.getAppSettings("import_rate_limits").then(s=>{s&&N(s)})},[k]);const U=h({mutationFn:()=>l.createClubRecordSwimmer({display_name:c.display_name.trim(),iuf:c.iuf.trim()||null,sex:c.sex?c.sex:null,birthdate:c.birthdate||null,is_active:!0}),onSuccess:()=>{r({title:"Nageur ajouté"}),f({display_name:"",iuf:"",sex:"",birthdate:""}),x()},onError:()=>{r({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),te=h({mutationFn:({id:s,payload:t})=>l.updateClubRecordSwimmer(s,t),onSuccess:()=>{x(),r({title:"Sauvegardé"})},onError:()=>{r({title:"Mise à jour impossible",variant:"destructive"})}}),re=h({mutationFn:({userId:s,payload:t})=>l.updateClubRecordSwimmerForUser(s,t),onSuccess:()=>{x(),r({title:"Sauvegardé"})},onError:()=>{r({title:"Mise à jour impossible",variant:"destructive"})}}),_=(s,t)=>{if(s.source_type==="user"&&s.user_id){re.mutate({userId:s.user_id,payload:t});return}s.id&&te.mutate({id:s.id,payload:t})},D=h({mutationFn:()=>l.importClubRecords(),onSuccess:s=>{r({title:"Import terminé",description:s?`Performances importées: ${s.imported??0}. Erreurs: ${s.errors??0}.`:""}),x(),S(),j.invalidateQueries({queryKey:["club-records"]})},onError:s=>{const t=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:"Import impossible";r({title:t,variant:"destructive"}),S()}}),V=h({mutationFn:({iuf:s,name:t})=>l.importSingleSwimmer(s,t),onSuccess:(s,t)=>{r({title:`Import de ${t.name??t.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),S(),l.recalculateClubRecords().then(()=>{j.invalidateQueries({queryKey:["club-records"]})}),x()},onError:(s,t)=>{const F=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:`Erreur import ${t.name??t.iuf}`;r({title:F,variant:"destructive"}),S()}}),K=h({mutationFn:s=>l.updateAppSettings("import_rate_limits",s),onSuccess:()=>{r({title:"Limites sauvegardées"})},onError:()=>{r({title:"Erreur de sauvegarde",variant:"destructive"})}}),ae=o.useMemo(()=>[...g].sort((s,t)=>s.source_type!==t.source_type?s.source_type.localeCompare(t.source_type):s.display_name.localeCompare(t.display_name)),[g]),C=o.useMemo(()=>g.filter(s=>s.is_active&&(!s.iuf||!s.sex||!s.birthdate)).length,[g]),P=h({mutationFn:()=>l.recalculateClubRecords(),onSuccess:()=>{r({title:"Records recalculés"}),j.invalidateQueries({queryKey:["club-records"]})},onError:()=>{r({title:"Erreur de recalcul",variant:"destructive"})}});return y?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gérez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>{window.location.hash="#/records-club"},children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),"Voir les records"]}),e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>P.mutate(),disabled:P.isPending,children:[e.jsx(xe,{className:E("h-4 w-4 mr-1",P.isPending&&"animate-spin")}),"Recalculer"]}),e.jsx(p,{onClick:()=>D.mutate(),disabled:D.isPending,children:D.isPending?"Import en cours...":"Mettre à jour les records"})]})]}),e.jsxs(w,{children:[e.jsxs(R,{children:[e.jsx(I,{children:"Ajouter un ancien nageur"}),e.jsx(A,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(L,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_1fr_auto]",children:[e.jsx(m,{placeholder:"Nom du nageur",value:c.display_name,onChange:s=>f(t=>({...t,display_name:s.target.value}))}),e.jsx(m,{placeholder:"IUF",value:c.iuf,onChange:s=>f(t=>({...t,iuf:s.target.value}))}),e.jsxs(J,{value:c.sex,onValueChange:s=>f(t=>({...t,sex:s})),children:[e.jsx(X,{children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Y,{children:ee.map(s=>e.jsx(Z,{value:s.value,children:s.label},s.value))})]}),e.jsx(m,{type:"date",value:c.birthdate,onChange:s=>f(t=>({...t,birthdate:s.target.value}))}),e.jsx(p,{onClick:()=>U.mutate(),disabled:!c.display_name.trim()||U.isPending,children:"Ajouter"})]})]}),e.jsxs(w,{children:[e.jsxs(R,{children:[e.jsx(I,{children:"Liste des nageurs suivis"}),e.jsx(A,{children:"Mettre à jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(L,{children:[!v&&C>0&&e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-300 bg-amber-50 p-3 text-sm text-amber-800 dark:border-amber-700 dark:bg-amber-950/30 dark:text-amber-300",children:[e.jsxs("strong",{children:[C," nageur",C>1?"s":""," incomplet",C>1?"s":""]})," ","— les champs IUF, Sexe et Date de naissance sont tous requis pour le calcul des records."]}),v&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s))}),b&&e.jsx("p",{className:"text-sm text-destructive",children:b}),!v&&!b&&g.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!v&&!b&&g.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(T,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Source"}),e.jsx(i,{children:"IUF"}),e.jsx(i,{children:"Sexe"}),e.jsx(i,{children:"Naissance"}),e.jsx(i,{children:"Dernière maj"}),e.jsx(i,{children:"Actif"}),e.jsx(i,{children:"Actions"})]})}),e.jsx(G,{children:ae.map(s=>{const t=s.id??`user-${s.user_id??"unknown"}`,F=ge(s.last_imported_at);return e.jsxs(T,{className:F?"bg-amber-50/50 dark:bg-amber-950/10":"",children:[e.jsx(n,{className:"font-medium",children:s.display_name}),e.jsx(n,{children:e.jsx(Q,{variant:s.source_type==="manual"?"secondary":"outline",children:he(s.source_type)})}),e.jsx(n,{children:e.jsx(m,{defaultValue:s.iuf??"",onBlur:d=>_(s,{iuf:d.target.value.trim()||null}),className:E("w-24",s.is_active&&!s.iuf&&"ring-2 ring-destructive/50")},`${t}-${s.iuf??""}`)}),e.jsx(n,{children:e.jsxs(J,{value:s.sex??"",onValueChange:d=>_(s,{sex:d||null}),children:[e.jsx(X,{className:E("w-28",s.is_active&&!s.sex&&"ring-2 ring-destructive/50"),children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Y,{children:ee.map(d=>e.jsx(Z,{value:d.value,children:d.label},d.value))})]})}),e.jsx(n,{children:e.jsx(m,{type:"date",defaultValue:s.birthdate??"",onBlur:d=>_(s,{birthdate:d.target.value||null}),className:E("w-36",s.is_active&&!s.birthdate&&"ring-2 ring-destructive/50")},`${t}-${s.birthdate??""}`)}),e.jsx(n,{children:e.jsx("span",{className:F?"text-amber-600 dark:text-amber-400 text-xs font-medium":"text-xs text-muted-foreground",children:je(s.last_imported_at)})}),e.jsx(n,{children:e.jsx(ue,{checked:!!s.is_active,onCheckedChange:d=>_(s,{is_active:d})})}),e.jsx(n,{children:s.iuf?e.jsx(p,{size:"sm",variant:"outline",disabled:V.isPending,onClick:()=>V.mutate({iuf:s.iuf,name:s.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},t)})})]})})]})]}),e.jsxs(w,{children:[e.jsxs(R,{children:[e.jsx(I,{children:"Historique des imports"}),e.jsx(A,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(L,{children:q.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectué."}):e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(T,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Statut"}),e.jsx(i,{children:"Trouvées"}),e.jsx(i,{children:"Importées"}),e.jsx(i,{children:"Date"}),e.jsx(i,{children:"Erreur"})]})}),e.jsx(G,{children:q.map(s=>e.jsxs(T,{children:[e.jsx(n,{className:"font-medium",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(n,{children:e.jsx(Q,{variant:fe(s.status),children:ve(s.status)})}),e.jsx(n,{children:s.performances_found??"-"}),e.jsx(n,{children:s.performances_imported??"-"}),e.jsx(n,{className:"text-xs",children:pe(s.started_at)}),e.jsx(n,{className:"max-w-[200px] truncate text-xs text-destructive",children:s.error_message??""})]},s.id))})]})})]}),k&&e.jsxs(w,{children:[e.jsxs(R,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(I,{children:"Paramètres d'import"}),e.jsx(A,{children:"Limites mensuelles d'import par rôle."})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>se(!B),children:e.jsx(oe,{className:"h-4 w-4"})})]}),B&&u&&e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Coach (par mois)"}),e.jsx(m,{type:"number",value:u.coach_monthly,onChange:s=>N({...u,coach_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Nageur (par mois)"}),e.jsx(m,{type:"number",value:u.athlete_monthly,onChange:s=>N({...u,athlete_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Admin (par mois, -1=illimité)"}),e.jsx(m,{type:"number",value:u.admin_monthly,onChange:s=>N({...u,admin_monthly:Number(s.target.value)}),min:-1})]})]}),e.jsx(p,{size:"sm",onClick:()=>K.mutate(u),disabled:K.isPending,children:"Enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Accès réservé aux coachs."})]})}export{ke as default};
