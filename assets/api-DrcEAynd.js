import{s as a,u as ne}from"./index-aTdcEMh_.js";import{a as v,b as H,n as P,c as T,d as D,e as U,f as d,l as w,S as _,h as q,i as I,j as ie,k as z,m as W,o as X,v as ae,p as Y,q as oe,r as V,t as L,u as ce,g as ue,w as de,x as le,y as me,z as _e,A as fe}from"./swim-BD8VwGGa.js";const j=e=>({id:T(e.id),numero_exercice:v(e.numero_exercice??e.numero),nom_exercice:e.nom_exercice??e.name??"",description:e.description??null,illustration_gif:e.illustration_gif??null,exercise_type:P(e.exercise_type??e.type??(e.is_warmup?"warmup":"strength")),warmup_reps:v(e.warmup_reps),warmup_duration:v(e.warmup_duration),Nb_series_endurance:v(e.Nb_series_endurance),Nb_reps_endurance:v(e.Nb_reps_endurance),pct_1rm_endurance:H(e.pct_1rm_endurance),recup_endurance:v(e.recup_endurance),recup_exercices_endurance:v(e.recup_exercices_endurance),Nb_series_hypertrophie:v(e.Nb_series_hypertrophie),Nb_reps_hypertrophie:v(e.Nb_reps_hypertrophie),pct_1rm_hypertrophie:H(e.pct_1rm_hypertrophie),recup_hypertrophie:v(e.recup_hypertrophie),recup_exercices_hypertrophie:v(e.recup_exercices_hypertrophie),Nb_series_force:v(e.Nb_series_force),Nb_reps_force:v(e.Nb_reps_force),pct_1rm_force:H(e.pct_1rm_force),recup_force:v(e.recup_force),recup_exercices_force:v(e.recup_exercices_force)}),ge=e=>{const t={athlete_name:e.athlete_name,session_date:e.date,time_slot:e.slot,distance:e.distance,duration:e.duration,rpe:U(e.effort),performance:U(e.performance??e.feeling),engagement:U(e.engagement??e.feeling),fatigue:U(e.feeling),comments:e.comments};return e.athlete_id!==null&&e.athlete_id!==void 0&&String(e.athlete_id)!==""&&(t.athlete_id=e.athlete_id),e.stroke_distances&&(t.stroke_distances=e.stroke_distances),t},pe=e=>{if(!e)return null;const t=String(e.athlete_name||"").trim(),r=String(e.session_date||e.date||"").trim();if(!t||!r)return null;const s=D(v(e.rpe??e.effort)),n=D(v(e.performance??e.feeling)),i=D(v(e.engagement??e.feeling)),o=D(v(e.fatigue??e.feeling)),c=s??3,u=D(v(e.performance??e.engagement??e.fatigue??e.feeling))??3;return{id:T(e.id,Date.now()),athlete_id:e.athlete_id?T(e.athlete_id):void 0,athlete_name:t,date:r,slot:String(e.time_slot||e.slot||""),effort:c,feeling:u,rpe:s,performance:n,engagement:i,fatigue:o,distance:T(e.distance,0),duration:T(e.duration,0),comments:e.comments||"",stroke_distances:e.stroke_distances??null,created_at:e.created_at||e.updated_at||new Date().toISOString()}};async function he(e){if(!d())return null;let t=a.from("user_profiles").select("*");e.userId?t=t.eq("user_id",e.userId):e.displayName&&(t=t.eq("display_name",e.displayName));const{data:r,error:s}=await t.maybeSingle();if(s)throw new Error(s.message);return r?{id:r.user_id??null,display_name:r.display_name??null,email:r.email??null,birthdate:r.birthdate??null,group_id:v(r.group_id)??null,group_label:r.group_label??null,objectives:r.objectives??null,bio:r.bio??null,avatar_url:r.avatar_url??null,ffn_iuf:r.ffn_iuf??null,phone:r.phone??null}:null}async function we(e){if(!d())return{status:"skipped"};const t=e.userId;if(!t)return{status:"skipped"};const r=e.profile.ffn_iuf?.trim()||null;if(r){const{data:n,error:i}=await a.from("club_record_swimmers").select("id").eq("iuf",r).eq("source_type","manual");if(i)throw new Error(i.message);if(n&&n.length>0){const o=n.map(u=>u.id),{error:c}=await a.from("club_record_swimmers").delete().in("id",o);if(c)throw new Error(c.message)}}const{error:s}=await a.from("user_profiles").upsert({user_id:t,...e.profile},{onConflict:"user_id"});if(s)throw new Error(s.message);return{status:"updated"}}async function Se(){if(!d()){const u=new Map,l=(h,b)=>{const N=String(h??"").trim();if(!N)return;const x=b!=null?v(b):null,R=x!==null?`id:${x}`:`name:${N.toLowerCase()}`;u.has(R)||u.set(R,{id:x,display_name:N})};return(w(_.SESSIONS)??[]).forEach(h=>l(h.athlete_name,h.athlete_id)),(w(_.STRENGTH_RUNS)??[]).forEach(h=>l(h.athlete_name,h.athlete_id)),(w(_.ASSIGNMENTS)??[]).forEach(h=>l(h.target_athlete,h.target_user_id)),Array.from(u.values()).sort((h,b)=>h.display_name.localeCompare(b.display_name,"fr"))}const{data:e,error:t}=await a.from("groups").select("id, name");if(t)throw new Error(t.message);const{data:r}=await a.from("user_profiles").select("user_id, ffn_iuf"),s=new Map((r??[]).map(u=>[u.user_id,u]));if(!e?.length){const{data:u,error:l}=await a.from("users").select("id, display_name, email").eq("role","athlete").eq("is_active",!0);if(l)throw new Error(l.message);return(u??[]).map(m=>({id:m.id,display_name:m.display_name,email:m.email??null,ffn_iuf:s.get(m.id)?.ffn_iuf??null})).filter(m=>m.display_name).sort((m,S)=>m.display_name.localeCompare(S.display_name,"fr"))}const{data:n,error:i}=await a.from("group_members").select("user_id, group_id, users!inner(display_name, role, email)").eq("users.role","athlete");if(i)throw new Error(i.message);const o=new Map(e.map(u=>[u.id,u.name])),c=new Map;return(n??[]).forEach(u=>{const l=u.user_id;c.has(l)||c.set(l,{id:l,display_name:u.users?.display_name??"",email:u.users?.email??null,group_id:u.group_id??null,group_label:o.get(u.group_id)??null,ffn_iuf:s.get(l)?.ffn_iuf??null})}),Array.from(c.values()).filter(u=>u.display_name).sort((u,l)=>u.display_name.localeCompare(l.display_name,"fr"))}async function ye(){if(!d())return[];const{data:e,error:t}=await a.from("groups").select("id, name, description, is_temporary, is_active, parent_group_id");if(t)throw new Error(t.message);return(e??[]).filter(r=>r.is_temporary?r.is_active===!0:!0).map(r=>({id:T(r.id,0),name:String(r.name??`Groupe ${r.id??""}`).trim(),member_count:null,is_temporary:r.is_temporary??!1,is_active:r.is_active??!0,parent_group_id:r.parent_group_id??null})).filter(r=>r.id>0&&r.name).sort((r,s)=>r.is_temporary&&!s.is_temporary?-1:!r.is_temporary&&s.is_temporary?1:r.name.localeCompare(s.name,"fr"))}async function Ee(e){if(!d())return[];const t=e?.days??30,{data:r,error:s}=await a.rpc("get_upcoming_birthdays",{p_days:t});if(s)throw new Error(s.message);return Array.isArray(r)?r:[]}async function be(e){if(!d())return[];let t=a.from("users").select("id, display_name, role, email, is_active");e?.role&&(t=t.eq("role",e.role)),e?.includeInactive||(t=t.eq("is_active",!0));const{data:r,error:s}=await t.order("display_name");if(s)throw new Error(s.message);return(r??[]).map(n=>({id:n.id,display_name:n.display_name??"",role:n.role??"",email:n.email??null,is_active:n.is_active??null,group_label:null}))}async function ve(e){if(!d())return{status:"skipped",user:null,initialPassword:null};const{data:t,error:r}=await a.functions.invoke("admin-user",{body:{action:"create_coach",display_name:e.display_name,email:e.email,password:e.password}});if(r)throw new Error(r.message);return{status:"created",user:t?.user??null,initialPassword:t?.initial_password??null}}async function Ie(e){if(!d())return{status:"skipped"};const{error:t}=await a.functions.invoke("admin-user",{body:{action:"update_role",user_id:e.userId,role:e.role}});if(t)throw new Error(t.message);return{status:"updated"}}async function Ne(e){if(!d())return{status:"skipped"};const{error:t}=await a.functions.invoke("admin-user",{body:{action:"disable_user",user_id:e.userId}});if(t)throw new Error(t.message);return{status:"disabled"}}async function Te(){if(!d())return[];const{data:e,error:t}=await a.from("user_profiles").select("user_id, display_name, email, users!user_profiles_user_id_fkey(created_at)").eq("is_approved",!1);if(t)throw new Error(t.message);return(e??[]).map(r=>({user_id:r.user_id,display_name:r.display_name,email:r.email,created_at:r.users?.created_at??new Date().toISOString()}))}async function xe(e){if(!d())return;const{error:t}=await a.from("user_profiles").update({is_approved:!0,approved_at:new Date().toISOString()}).eq("user_id",e);if(t)throw new Error(t.message)}async function qe(e){if(!d())return;const{error:t}=await a.from("users").delete().eq("id",e);if(t)throw new Error(t.message)}async function Re(e){if(!d())return{status:"skipped"};const{data:{user:t}}=await a.auth.getUser();if(!e.userId||e.userId===t?.user_metadata?.app_user_id){const{error:s}=await a.auth.updateUser({password:e.password});if(s)throw new Error(s.message);return{status:"updated"}}const{error:r}=await a.functions.invoke("admin-user",{body:{action:"update_password",user_id:e.userId,password:e.password}});if(r)throw new Error(r.message);return{status:"updated"}}async function Ae(e){if(!d())throw new Error("Supabase non disponible");const t=`${e.userId}.${e.extension}`,{error:r}=await a.storage.from("avatars").upload(t,e.blob,{contentType:e.mimeType,upsert:!0});if(r)throw new Error(r.message);const{data:s}=a.storage.from("avatars").getPublicUrl(t),n=`${s.publicUrl}?t=${Date.now()}`,{error:i}=await a.from("user_profiles").update({avatar_url:n}).eq("user_id",e.userId);if(i)throw new Error(i.message);return n}async function Ce(e){if(!d())return;const{error:t}=await a.storage.from("avatars").remove([`${e}.webp`,`${e}.jpg`]);if(t)throw new Error(t.message);const{error:r}=await a.from("user_profiles").update({avatar_url:null}).eq("user_id",e);if(r)throw new Error(r.message)}const J=["Piscine","Compétition"];async function Oe(e){if(d()){let r=a.from("timesheet_shifts").select("*").order("shift_date",{ascending:!1});e?.coachId&&(r=r.eq("coach_id",e.coachId)),e?.from&&(r=r.gte("shift_date",e.from)),e?.to&&(r=r.lte("shift_date",e.to));const{data:s,error:n}=await r;if(n)throw new Error(n.message);return s??[]}return await q(200),(w(_.TIMESHEET_SHIFTS)||[]).filter(r=>!(e?.coachId&&r.coach_id!==e.coachId||e?.from&&r.shift_date<e.from||e?.to&&r.shift_date>e.to)).sort((r,s)=>r.shift_date!==s.shift_date?r.shift_date<s.shift_date?1:-1:r.start_time<s.start_time?1:-1)}async function De(){if(d()){const{data:s,error:n}=await a.from("timesheet_locations").select("*").order("name");if(n)throw new Error(n.message);return s??[]}await q(120);const e=w(_.TIMESHEET_LOCATIONS);if(Array.isArray(e)&&e.length)return e;const t=new Date().toISOString(),r=J.map((s,n)=>({id:n+1,name:s,created_at:t,updated_at:t}));return I(_.TIMESHEET_LOCATIONS,r),r}async function Me(e){if(d()){const{error:u}=await a.from("timesheet_locations").insert({name:e.name.trim()});if(u)throw new Error(u.message);return{status:"created"}}await q(120);const t=e.name.trim();if(!t)throw new Error("Missing location name");const r=w(_.TIMESHEET_LOCATIONS),s=new Date().toISOString(),n=Array.isArray(r)&&r.length?r:J.map((u,l)=>({id:l+1,name:u,created_at:s,updated_at:s}));if(n.some(u=>u.name.toLowerCase()===t.toLowerCase()))return{status:"exists"};const o=new Date().toISOString(),c={id:Date.now(),name:t,created_at:o,updated_at:o};return I(_.TIMESHEET_LOCATIONS,[...n,c]),{status:"created"}}async function Ue(e){if(d()){const{error:s}=await a.from("timesheet_locations").delete().eq("id",e.id);if(s)throw new Error(s.message);return{status:"deleted"}}await q(120);const r=(w(_.TIMESHEET_LOCATIONS)||[]).filter(s=>s.id!==e.id);return I(_.TIMESHEET_LOCATIONS,r),{status:"deleted"}}async function Ge(){if(d()){const{data:e,error:t}=await a.from("users").select("id, display_name").eq("role","coach").eq("is_active",!0);if(t)throw new Error(t.message);return(e??[]).map(r=>({id:r.id,display_name:r.display_name}))}return[]}async function ke(e){if(d()){const{error:s}=await a.from("timesheet_shifts").insert({coach_id:e.coach_id,shift_date:e.shift_date,start_time:e.start_time,end_time:e.end_time??null,location:e.location??null,is_travel:e.is_travel});if(s)throw new Error(s.message);return{status:"created"}}await q(200);const t=w(_.TIMESHEET_SHIFTS)||[],r={...e,id:Date.now(),created_at:new Date().toISOString()};return I(_.TIMESHEET_SHIFTS,[...t,r]),{status:"created"}}async function Fe(e){if(d()){const{id:n,...i}=e,{error:o}=await a.from("timesheet_shifts").update(i).eq("id",n);if(o)throw new Error(o.message);return{status:"updated"}}await q(200);const t=w(_.TIMESHEET_SHIFTS)||[],r=t.findIndex(n=>n.id===e.id);if(r===-1)return{status:"missing"};const s=[...t];return s[r]={...s[r],...e,updated_at:new Date().toISOString()},I(_.TIMESHEET_SHIFTS,s),{status:"updated"}}async function He(e){if(d()){const{error:s}=await a.from("timesheet_shifts").delete().eq("id",e.id);if(s)throw new Error(s.message);return{status:"deleted"}}await q(200);const r=(w(_.TIMESHEET_SHIFTS)||[]).filter(s=>s.id!==e.id);return I(_.TIMESHEET_SHIFTS,r),{status:"deleted"}}async function Pe(e){return await q(200),(w(_.NOTIFICATIONS)||[]).filter(r=>r.target_athlete===e||r.target_athlete==="All").reverse()}async function Le(e){if(d()){const{data:n,error:i}=await a.from("notifications").insert({title:e.title,body:e.body??null,type:e.type}).select("id").single();if(i)throw new Error(i.message);if(n&&e.targets.length>0){const{error:o}=await a.from("notification_targets").insert(e.targets.map(c=>({notification_id:n.id,target_user_id:c.target_user_id??null,target_group_id:c.target_group_id??null})));if(o)throw new Error(o.message)}return{status:"sent"}}const t=w(_.NOTIFICATIONS)||[],r={sender:"Coach",title:e.title,message:e.body||"",type:e.type},s=e.targets.map((n,i)=>({...r,id:Date.now()+i,read:!1,date:new Date().toISOString(),sender_id:null,sender_email:null,target_user_id:n.target_user_id??null,target_group_id:n.target_group_id??null}));return I(_.NOTIFICATIONS,[...t,...s]),{status:"sent"}}async function je(e){const r=(w(_.NOTIFICATIONS)||[]).map(s=>s.id===e?{...s,read:!0}:s);I(_.NOTIFICATIONS,r)}async function $e(e){const t=e.limit??20,r=Number.isFinite(t)?Math.min(Math.max(Number(t),1),200):20,s=e.offset??0,n=Number.isFinite(s)?Math.max(Number(s),0):0,i=e.order==="asc"?"asc":"desc";if(d()){const f=await ie(e.targetUserId??null),h=[];if(e.targetUserId&&h.push(`target_user_id.eq.${e.targetUserId}`),f.forEach(g=>h.push(`target_group_id.eq.${g}`)),!h.length)return{notifications:[],pagination:{limit:r,offset:n,total:0}};let b=a.from("notification_targets").select("*, notifications!inner(*)").or(h.join(",")).order("notifications(created_at)",{ascending:i==="asc"});e.status==="read"?b=b.not("read_at","is",null):e.status==="unread"&&(b=b.is("read_at",null)),e.type&&(b=b.eq("notifications.type",e.type)),e.from&&(b=b.gte("notifications.created_at",e.from)),e.to&&(b=b.lte("notifications.created_at",e.to+"T23:59:59"));const{data:N,error:x}=await b;if(x)throw new Error(x.message);const R=(N??[]).map(g=>{const E=g.notifications||{};return{id:T(g.id,Date.now()),target_id:v(g.id)??void 0,target_user_id:v(g.target_user_id)??null,sender_id:v(E.created_by)??null,sender_email:null,target_group_id:v(g.target_group_id)??null,target_group_name:null,sender_name:null,sender_role:null,counterparty_id:null,counterparty_name:null,counterparty_role:null,sender:E.created_by?"Coach":"Système",title:String(E.title||""),message:String(E.body||""),type:String(E.type||"message"),read:!!g.read_at,date:E.created_at||new Date().toISOString()}}),p=R.length;return{notifications:R.slice(n,n+r),pagination:{limit:r,offset:n,total:p}}}await q(200);const u=(w(_.NOTIFICATIONS)||[]).filter(f=>!(e.targetUserId&&f.target_user_id!==e.targetUserId||e.targetAthleteName&&!(f.target_athlete===e.targetAthleteName||f.target_athlete==="All")||e.type&&f.type!==e.type||e.status==="read"&&!f.read||e.status==="unread"&&f.read)).sort((f,h)=>{const b=new Date(f.date||f.created_at||0).getTime(),N=new Date(h.date||h.created_at||0).getTime();return i==="asc"?b-N:N-b}),l=u.length;return{notifications:u.slice(n,n+r).map(f=>({id:T(f.id,Date.now()),target_user_id:v(f.target_user_id)??null,sender_id:v(f.sender_id)??null,sender_email:f.sender_email?String(f.sender_email):null,sender:String(f.sender||"Coach"),title:String(f.title||""),message:String(f.message||""),type:String(f.type||"message"),read:!!f.read,date:f.date||new Date().toISOString(),related_id:f.related_id??void 0})),pagination:{limit:r,offset:n,total:l}}}async function Be(e){const t=e.targetId??e.id;if(!t)throw new Error("Missing target id");if(d()){const{error:n}=await a.from("notification_targets").update({read_at:new Date().toISOString()}).eq("id",t);if(n)throw new Error(n.message);return}const s=(w(_.NOTIFICATIONS)||[]).map(n=>n.id===t?{...n,read:!0}:n);I(_.NOTIFICATIONS,s)}const K=e=>{const t=W(e?.cycle??e?.cycle_type),s=(Array.isArray(e?.items)?e.items:[]).map((i,o)=>X(i,o,t));ae(s);const n=s.sort((i,o)=>i.order_index-o.order_index).map(i=>({ordre:i.order_index,exercise_id:i.exercise_id,cycle_type:i.cycle_type,sets:i.sets,reps:i.reps,pct_1rm:i.percent_1rm,rest_series_s:i.rest_seconds,notes:i.notes}));return{cycle:t,normalizedItems:s,itemsPayload:n}},Q=(e,t,r)=>e.map(s=>({session_id:t,ordre:s.ordre,exercise_id:s.exercise_id,block:"main",cycle_type:s.cycle_type??r,sets:s.sets,reps:s.reps,pct_1rm:s.pct_1rm,rest_series_s:s.rest_series_s,notes:s.notes})),ze=(e,t)=>({id:t,assignment_id:e.assignment_id,athlete_id:e.athlete_id??null,athlete_name:e.athleteName??null,session_id:e.session_id??null,cycle_type:e.cycle_type??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString(),logs:[]}),We=e=>({run_id:e.run_id,exercise_id:e.exercise_id,set_index:e.set_index??null,reps:e.reps??null,weight:e.weight??null,pct_1rm_suggested:e.pct_1rm_suggested??null,rest_seconds:e.rest_seconds??null,rpe:e.rpe??null,notes:e.notes??null,completed_at:new Date().toISOString()}),Xe=(e,t)=>e.map((r,s)=>({run_id:t,exercise_id:r.exercise_id,set_index:r.set_index??r.set_number??s,reps:r.reps??null,weight:r.weight??null,rpe:r.rpe??null,notes:r.notes??null,completed_at:new Date().toISOString()})),Ye=e=>{const t={};return e.progress_pct!==void 0&&(t.progress_pct=e.progress_pct),e.status&&(t.status=e.status),e.status==="completed"&&(t.completed_at=new Date().toISOString()),e.fatigue!==void 0&&(t.raw_payload={fatigue:e.fatigue,comments:e.comments}),t},Z=(e,t)=>e.map(r=>{const s=t.find(n=>n.id===r.exercise_id);return{...r,exercise_name:s?.nom_exercice,category:s?.exercise_type}}),B=e=>{const t=new Map;for(const r of e){const s=z(Number(r.weight),Number(r.reps));if(!s)continue;const n=Number(r.exercise_id);if(!Number.isFinite(n))continue;const i=t.get(n)??0;s>i&&t.set(n,s)}return t};async function Ve(){if(d()){const{data:r,error:s}=await a.from("dim_exercices").select("*");if(s)throw new Error(s.message);return(r??[]).map(oe)}const e=w(_.EXERCISES)||[];return(Array.isArray(e)?e:[]).map(r=>j(r))}async function Je(e){const t=P(e.exercise_type);if(d()){const n=Y({...e,exercise_type:t}),{error:i}=await a.from("dim_exercices").insert(n);if(i)throw new Error(i.message);return{status:"created"}}const r=w(_.EXERCISES)||[],s=j({...e,exercise_type:t,id:Date.now()});return I(_.EXERCISES,[...r,s]),{status:"created"}}async function Ke(e){const t=P(e.exercise_type);if(d()){const o=Y({...e,exercise_type:t}),{error:c}=await a.from("dim_exercices").update(o).eq("id",e.id);if(c)throw new Error(c.message);return{status:"updated"}}const r=w(_.EXERCISES)||[],s=r.findIndex(o=>o.id===e.id);if(s===-1)throw new Error("Exercice introuvable");const n=j({...r[s],...e,exercise_type:t}),i=[...r];return i[s]=n,I(_.EXERCISES,i),{status:"updated"}}async function Qe(e){if(d()){const{error:i}=await a.from("dim_exercices").delete().eq("id",e);if(i)throw new Error(i.message);return{status:"deleted"}}const r=(w(_.EXERCISES)||[]).filter(i=>i.id!==e);I(_.EXERCISES,r);const n=(w(_.STRENGTH_SESSIONS)||[]).map(i=>({...i,items:Array.isArray(i.items)?i.items.filter(o=>o.exercise_id!==e):i.items}));return I(_.STRENGTH_SESSIONS,n),{status:"deleted"}}async function $(){if(d()){const{data:e,error:t}=await a.from("strength_sessions").select("*, strength_session_items(*, dim_exercices(nom_exercice, exercise_type))").order("created_at",{ascending:!1});if(t)throw new Error(t.message);return(e??[]).map(r=>{const s=Array.isArray(r.strength_session_items)?r.strength_session_items:[],n=W(s[0]?.cycle_type);return{id:T(r.id,Date.now()),title:String(r.name||""),description:r.description??"",cycle:n,folder_id:v(r.folder_id),items:s.sort((i,o)=>(i.ordre??0)-(o.ordre??0)).map((i,o)=>({...X(i,o,n),exercise_name:i.dim_exercices?.nom_exercice??void 0,category:i.dim_exercices?.exercise_type??void 0}))}})}return w(_.STRENGTH_SESSIONS)||[]}async function Ze(e){const{cycle:t,normalizedItems:r,itemsPayload:s}=K(e);if(d()){const{data:c,error:u}=await a.from("strength_sessions").insert({name:e?.title??e?.name??"",description:e?.description??"",folder_id:e?.folder_id??null}).select("id").single();if(u)throw new Error(u.message);const l=c.id;if(s.length>0){const{error:m}=await a.from("strength_session_items").insert(Q(s,l,t));if(m)throw new Error(m.message)}return{status:"created",id:l}}const n=w(_.STRENGTH_SESSIONS)||[],i=Date.now(),o=Z(r,w(_.EXERCISES)||[]);return I(_.STRENGTH_SESSIONS,[...n,{...e,title:e?.title??e?.name??"",cycle:t,items:o,id:i}]),{status:"created",id:i}}async function ee(e){if(!e?.id)throw new Error("Session id manquant");const{cycle:t,normalizedItems:r,itemsPayload:s}=K(e);if(d()){const{error:l}=await a.from("strength_sessions").update({name:e?.title??e?.name??"",description:e?.description??"",folder_id:e?.folder_id??null}).eq("id",e.id);if(l)throw new Error(l.message);if(await a.from("strength_session_items").delete().eq("session_id",e.id),s.length>0){const{error:m}=await a.from("strength_session_items").insert(Q(s,e.id,t));if(m)throw new Error(m.message)}return{status:"updated"}}const n=w(_.STRENGTH_SESSIONS)||[],i=n.findIndex(l=>l.id===e.id);if(i===-1)throw new Error("Séance introuvable");const o=Z(r,w(_.EXERCISES)||[]),c={...n[i],...e,title:e?.title??e?.name??"",cycle:t,items:o},u=[...n];return u[i]=c,I(_.STRENGTH_SESSIONS,u),{status:"updated"}}async function et(e){return ee(e)}async function tt(e){if(d()){const{error:s}=await a.from("strength_sessions").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}const r=(w(_.STRENGTH_SESSIONS)||[]).filter(s=>s.id!==e);return I(_.STRENGTH_SESSIONS,r),{status:"deleted"}}async function rt(e){if(d()){const{data:n,error:i}=await a.from("strength_session_runs").insert({assignment_id:e.assignment_id??null,athlete_id:e.athlete_id??null,session_id:e.session_id??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString()}).select("id").single();if(i)throw new Error(i.message);return e.assignment_id&&await a.from("session_assignments").update({status:"in_progress"}).eq("id",e.assignment_id),{run_id:n.id}}const t=w(_.STRENGTH_RUNS)||[],r=Date.now(),s=ze(e,r);if(I(_.STRENGTH_RUNS,[...t,s]),e.assignment_id){const i=(w(_.ASSIGNMENTS)||[]).map(o=>o.id===e.assignment_id?{...o,status:"in_progress"}:o);I(_.ASSIGNMENTS,i)}return{run_id:r}}async function st(e){const t=async S=>{const f=z(Number(e.weight),Number(e.reps));if(!f)return null;const h=S?.athleteId??null,b=S?.athleteName??null;if(h===null&&!b)return null;const N=await k({athleteName:b,athleteId:h}),R=new Map((N||[]).map(p=>[p.exercise_id,Number(p.weight??0)])).get(e.exercise_id)??0;return f<=R||d()&&(h==null||h==="")?null:(await F({athlete_id:h??void 0,athlete_name:b??void 0,exercise_id:e.exercise_id,one_rm:f}),f)},r=S=>{const f=e.athlete_id??e.athleteId??null,h=e.athlete_name??e.athleteName??null;if(f!==null||h)return{athleteId:f,athleteName:h};if(!S)return{athleteId:null,athleteName:null};const b=S.find(N=>N.id===e.run_id);return{athleteId:b?.athlete_id??null,athleteName:b?.athlete_name??null}};if(d()){const{error:S}=await a.from("strength_set_logs").insert(We(e));if(S)throw new Error(S.message);const f=r(),h=await t(f);return{status:"ok",one_rm_updated:!!h,one_rm:h??void 0}}const s=w(_.STRENGTH_RUNS)||[],n=s.findIndex(S=>S.id===e.run_id),i=n>=0?s[n]:{id:e.run_id,logs:[]},o=[...i.logs||[],{...e,completed_at:new Date().toISOString()}],c={...i,logs:o},u=n>=0?[...s.slice(0,n),c,...s.slice(n+1)]:[...s,c];I(_.STRENGTH_RUNS,u);const l=r(u),m=await t(l);return{status:"ok",one_rm_updated:!!m,one_rm:m??void 0}}async function nt(e){if(d()){const c=Ye(e),{error:u}=await a.from("strength_session_runs").update(c).eq("id",e.run_id);if(u)throw new Error(u.message);return e.status==="completed"&&e.assignment_id&&await a.from("session_assignments").update({status:"completed"}).eq("id",e.assignment_id),{status:"ok"}}const t=w(_.STRENGTH_RUNS)||[],r=t.findIndex(c=>c.id===e.run_id),s=new Date().toISOString(),n=r>=0?t[r]:{id:e.run_id,started_at:s},i={...n,...e,id:e.run_id,updated_at:s};if(e.status==="completed"&&!i.completed_at&&(i.completed_at=s),e.status==="completed"){const c=e.assignment_id??n.assignment_id;if(c){const l=(w(_.ASSIGNMENTS)||[]).map(m=>m.id===c?{...m,status:"completed"}:m);I(_.ASSIGNMENTS,l)}}const o=r>=0?[...t.slice(0,r),i,...t.slice(r+1)]:[...t,i];return I(_.STRENGTH_RUNS,o),{status:"ok"}}async function it(e){if(d()){const{error:n}=await a.from("strength_session_runs").delete().eq("id",e);if(n)throw new Error(n.message);return{status:"deleted",source:"remote"}}const t=w(_.STRENGTH_RUNS)||[],r=t.find(n=>n.id===e),s=t.filter(n=>n.id!==e);if(I(_.STRENGTH_RUNS,s),r?.assignment_id){const i=(w(_.ASSIGNMENTS)||[]).map(o=>o.id===r.assignment_id?{...o,status:"assigned"}:o);I(_.ASSIGNMENTS,i)}return{status:"deleted",source:"local"}}async function at(e){if(d()){let o=e.run_id;if(!o){const{data:u,error:l}=await a.from("strength_session_runs").insert({assignment_id:e.assignment_id??null,athlete_id:e.athlete_id??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString()}).select("id").single();if(l)throw new Error(l.message);o=u.id}if(o&&Array.isArray(e.logs)&&e.logs.length>0){const{error:u}=await a.from("strength_set_logs").insert(Xe(e.logs,o));if(u)throw new Error(u.message)}const c=B(Array.isArray(e.logs)?e.logs:[]);if(c.size>0){const u=e.athlete_id??null,l=e.athlete_name??null;if(u!=null&&u!==""){const m=await k({athleteName:l,athleteId:u}),S=new Map((m||[]).map(f=>[f.exercise_id,Number(f.weight??0)]));await Promise.all(Array.from(c.entries()).filter(([f,h])=>h>(S.get(f)??0)).map(([f,h])=>F({athlete_id:u??void 0,athlete_name:l??void 0,exercise_id:f,one_rm:h})))}}return o&&await a.from("strength_session_runs").update({progress_pct:e.progress_pct??100,status:"completed",completed_at:new Date().toISOString()}).eq("id",o),e.assignment_id&&await a.from("session_assignments").update({status:"completed"}).eq("id",e.assignment_id),{status:"ok",run_id:o??null}}const t=w(_.STRENGTH_RUNS)||[],r=e.run_id??Date.now(),s=t.find(o=>o.id===r)||{},n={...s,...e,id:r,status:"completed",started_at:s.started_at??e.started_at??e.date??new Date().toISOString(),completed_at:new Date().toISOString()};if(I(_.STRENGTH_RUNS,[...t.filter(o=>o.id!==r),n]),e.assignment_id){const c=(w(_.ASSIGNMENTS)||[]).map(u=>u.id===e.assignment_id?{...u,status:"completed"}:u);I(_.ASSIGNMENTS,c)}const i=B(Array.isArray(e.logs)?e.logs:[]);if(i.size>0){const o=e.athlete_id??null,c=e.athlete_name??null,u=await k({athleteName:c,athleteId:o}),l=new Map((u||[]).map(m=>[m.exercise_id,Number(m.weight??0)]));await Promise.all(Array.from(i.entries()).filter(([m,S])=>S>(l.get(m)??0)).map(([m,S])=>F({athlete_id:o??void 0,athlete_name:c??void 0,exercise_id:m,one_rm:S})))}return{status:"ok",run_id:r}}async function ot(e,t){const r=t?.limit??50,s=Number.isFinite(r)?Math.min(Math.max(Number(r),1),200):50,n=t?.offset??0,i=Number.isFinite(n)?Math.max(Number(n),0):0,o=t?.order==="asc"?"asc":"desc",c=t?.athleteId,u=c!=null&&c!=="";if(d()){let p=a.from("strength_session_runs").select("*, strength_set_logs(*)").order("started_at",{ascending:o==="asc"}).range(i,i+s-1);u&&(p=p.eq("athlete_id",Number(c))),t?.status&&(p=p.eq("status",t.status)),t?.from&&(p=p.gte("started_at",t.from)),t?.to&&(p=p.lte("started_at",t.to+"T23:59:59"));const{data:y,error:g,count:E}=await p;if(g)throw new Error(g.message);return{runs:y??[],pagination:{limit:s,offset:i,total:E??(y??[]).length},exercise_summary:[]}}const S=(w(_.STRENGTH_RUNS)||[]).filter(p=>{if(u&&String(p.athlete_id)!==String(c)||!u&&e&&p.athlete_name!==e||t?.status&&p.status!==t.status)return!1;if(t?.from||t?.to){const y=new Date(p.date||p.started_at||p.created_at||0).getTime();if(t?.from){const g=new Date(t.from).getTime();if(Number.isFinite(g)&&y<g)return!1}if(t?.to){const g=new Date(t.to);g.setHours(23,59,59,999);const E=g.getTime();if(Number.isFinite(E)&&y>E)return!1}}return!0}).sort((p,y)=>{const g=new Date(p.date||p.started_at||p.created_at||0).getTime(),E=new Date(y.date||y.started_at||y.created_at||0).getTime();return o==="asc"?g-E:E-g}),f=w(_.EXERCISES)||[],h=new Map((Array.isArray(f)?f:[]).map(p=>[T(p.id),p.nom_exercice||p.name||`Exercice ${p.id}`])),b=new Map;S.forEach(p=>{(p.logs||[]).forEach(y=>{const g=T(y.exercise_id);if(!g)return;const E=b.get(g)||{exercise_id:g,exercise_name:h.get(g)||`Exercice ${g}`,total_sets:0,total_reps:0,total_volume:0,max_weight:null,last_performed_at:null},C=Number(y.reps??0)||0,A=Number(y.weight??0)||0;E.total_sets+=1,E.total_reps+=C,E.total_volume+=C*A,E.max_weight=Math.max(E.max_weight??0,A)||E.max_weight;const O=y.completed_at||p.completed_at||p.started_at||null;if(O){const M=new Date(O).getTime(),G=E.last_performed_at?new Date(E.last_performed_at).getTime():0;(!E.last_performed_at||M>G)&&(E.last_performed_at=O)}b.set(g,E)})});const N=S.length,x=S.slice(i,i+s),R=Array.from(b.values()).sort((p,y)=>y.total_volume-p.total_volume);return{runs:x,pagination:{limit:s,offset:i,total:N},exercise_summary:R}}async function ct(e,t){const r=t?.limit??200,s=Number.isFinite(r)?Math.min(Math.max(Number(r),1),200):200,n=t?.offset??0,i=Number.isFinite(n)?Math.max(Number(n),0):0,o=t?.order==="asc"?"asc":"desc",c=t?.athleteId,u=c!=null&&c!=="",l=t?.period??"day";if(d()){const y={p_period:l};u&&(y.p_athlete_id=Number(c)),t?.from&&(y.p_from=t.from),t?.to&&(y.p_to=t.to);const{data:g,error:E}=await a.rpc("get_strength_history_aggregate",y);if(E)throw new Error(E.message);const C=Array.isArray(g)?g:[];return{periods:C,pagination:{limit:s,offset:i,total:C.length}}}const S=(w(_.STRENGTH_RUNS)||[]).filter(y=>u?y.athlete_id?String(y.athlete_id)===String(c):!1:y.athlete_name===e),f=t?.from?new Date(t.from):null,h=t?.to?new Date(t.to):null,b=new Map,N=y=>{if(l==="month")return`${y.getUTCFullYear()}-${String(y.getUTCMonth()+1).padStart(2,"0")}`;if(l==="week"){const g=new Date(Date.UTC(y.getUTCFullYear(),y.getUTCMonth(),y.getUTCDate())),E=g.getUTCDay()||7;g.setUTCDate(g.getUTCDate()+4-E);const C=new Date(Date.UTC(g.getUTCFullYear(),0,1)),A=Math.ceil(((g.getTime()-C.getTime())/864e5+1)/7);return`${g.getUTCFullYear()}-W${String(A).padStart(2,"0")}`}return y.toISOString().split("T")[0]};S.forEach(y=>{(Array.isArray(y.logs)?y.logs:[]).forEach(E=>{const C=E.completed_at||y.started_at||y.date||y.created_at;if(!C)return;const A=new Date(C);if(Number.isNaN(A.getTime())||f&&A<f||h&&A>h)return;const O=N(A),M=b.get(O)||{period:O,tonnage:0,volume:0},G=Number(E.reps)||0,se=Number(E.weight)||0;M.volume+=G,M.tonnage+=G*se,b.set(O,M)})});const x=Array.from(b.values()).sort((y,g)=>o==="asc"?y.period.localeCompare(g.period):g.period.localeCompare(y.period)),R=x.length;return{periods:x.slice(i,i+s),pagination:{limit:s,offset:i,total:R}}}async function k(e){const t=typeof e=="string"?e:e?.athleteName??null,r=typeof e=="string"?null:e?.athleteId??null;if(d()){let n=a.from("one_rm_records").select("*");r!=null&&String(r)!==""&&(n=n.eq("athlete_id",Number(r)));const{data:i,error:o}=await n;if(o)throw new Error(o.message);return(i??[]).map(c=>({id:v(c.id),athlete_id:v(c.athlete_id),exercise_id:T(c.exercise_id),weight:Number(c.one_rm??0),recorded_at:c.recorded_at??null,notes:c.notes??null}))}return(w(_.ONE_RM)||[]).filter(n=>n.athlete_name===t)}async function F(e){if(d()){const n=e.athlete_id??e.athleteId,i=e.one_rm??e.weight;if(n==null||n===""||i===null||i===void 0)throw new Error("athlete_id et one_rm sont requis");const o={athlete_id:Number(n),exercise_id:e.exercise_id,one_rm:i,recorded_at:new Date().toISOString()};e.notes!==void 0&&(o.notes=e.notes);const{error:c}=await a.from("one_rm_records").upsert(o,{onConflict:"athlete_id,exercise_id"});if(c)throw new Error(c.message);return{status:"ok"}}const t=w(_.ONE_RM)||[],r=e.athlete_name??e.athleteName,s=t.filter(n=>!(n.athlete_name===r&&n.exercise_id===e.exercise_id));return I(_.ONE_RM,[...s,{...e,athlete_name:r,id:Date.now(),date:new Date().toISOString()}]),{status:"ok"}}async function ut(e){if(d()){const{data:s,error:n}=await a.from("one_rm_records").update({notes:e.notes}).eq("athlete_id",Number(e.athlete_id)).eq("exercise_id",e.exercise_id).select("id");if(n)throw new Error(n.message);if(!s||s.length===0){const{error:i}=await a.from("one_rm_records").insert({athlete_id:Number(e.athlete_id),exercise_id:e.exercise_id,notes:e.notes,one_rm:0,recorded_at:new Date().toISOString()});if(i)throw new Error(i.message)}return{status:"ok"}}const t=w(_.ONE_RM)||[],r=t.findIndex(s=>String(s.athlete_id)===String(e.athlete_id)&&s.exercise_id===e.exercise_id);return r>=0?t[r].notes=e.notes:t.push({athlete_id:Number(e.athlete_id),exercise_id:e.exercise_id,one_rm:0,notes:e.notes,id:Date.now(),date:new Date().toISOString()}),I(_.ONE_RM,t),{status:"ok"}}async function dt(e){if(d()){const{data:t,error:r}=await a.from("strength_folders").select("*").eq("type",e).order("sort_order",{ascending:!0});if(r)throw new Error(r.message);return(t??[]).map(s=>({id:T(s.id),name:String(s.name||""),type:s.type,sort_order:T(s.sort_order)}))}return[]}async function lt(e,t){if(!d())throw new Error("Supabase requis");const{data:r,error:s}=await a.from("strength_folders").insert({name:e,type:t}).select("*").single();if(s)throw new Error(s.message);return{id:T(r.id),name:String(r.name),type:r.type,sort_order:T(r.sort_order)}}async function mt(e,t){if(!d())throw new Error("Supabase requis");const{error:r}=await a.from("strength_folders").update({name:t}).eq("id",e);if(r)throw new Error(r.message)}async function _t(e){if(!d())throw new Error("Supabase requis");const{error:t}=await a.from("strength_folders").delete().eq("id",e);if(t)throw new Error(t.message)}async function ft(e,t,r){if(!d())throw new Error("Supabase requis");const{error:s}=await a.from(r).update({folder_id:t}).eq("id",e);if(s)throw new Error(s.message)}async function gt(){return d()?null:(await q(100),w(_.ASSIGNMENTS)||[])}async function pt(e,t,r){if(d()){const{permanentGroupIds:n,temporaryGroupIds:i,hasActiveTemporary:o}=await V(t??null),c=[];if(t!=null&&c.push(`target_user_id.eq.${t}`),(o?i:n).forEach(p=>c.push(`target_group_id.eq.${p}`)),!c.length)return[];let l=a.from("session_assignments").select("*").or(c.join(","));r?.assignmentType&&(l=l.eq("assignment_type",r.assignmentType)),r?.status?l=l.eq("status",r.status):l=l.neq("status","completed");const{data:m,error:S}=await l;if(S)throw new Error(S.message);if(!m?.length)return[];const[f,h]=await Promise.all([L(),$()]),b=new Map(f.map(p=>[p.id,p])),N=new Map(h.map(p=>[p.id,p])),x=m.map(p=>{const y=p.assignment_type==="strength"?"strength":"swim",g=v(y==="swim"?p.swim_catalog_id:p.strength_session_id)??0,E=p.scheduled_date||p.created_at||"",C=String(p.status||"assigned"),A=y==="swim"?b.get(g):void 0,O=y==="strength"?N.get(g):void 0,M={id:T(p.id,Date.now()),session_id:g,session_type:y,title:y==="swim"?A?.name??"Séance natation":O?.title??"Séance musculation",description:A?.description??O?.description??"",assigned_date:E||new Date().toISOString(),assigned_slot:p.scheduled_slot??null,status:C,items:O?.items??A?.items};return y==="strength"&&(M.cycle=O?.cycle??"endurance"),M}),R=new Map(x.map(p=>[p.id,p]));return Array.from(R.values())}return await q(200),(w(_.ASSIGNMENTS)||[]).filter(n=>!(t!=null&&String(t)!==""&&String(n.target_user_id)===String(t)||n.target_athlete===e)||r?.assignmentType&&n.session_type!==r.assignmentType?!1:r?.status?n.status===r.status:n.status!=="completed")}async function ht(e,t){const r=e.assignment_type??e.session_type;if(!r)return{status:"error"};const s=e.scheduled_date??e.assigned_date??new Date().toISOString();if(d()){const u={assignment_type:r,scheduled_date:s,scheduled_slot:e.scheduled_slot??null,assigned_by:t??null,status:"assigned"};r==="swim"?u.swim_catalog_id=e.session_id:u.strength_session_id=e.session_id,e.target_user_id!==null&&e.target_user_id!==void 0?u.target_user_id=e.target_user_id:e.target_group_id!==null&&e.target_group_id!==void 0&&(u.target_group_id=e.target_group_id);const{data:l,error:m}=await a.from("session_assignments").insert(u).select("id").single();if(m)throw new Error(m.message);const{data:S,error:f}=await a.from("notifications").insert({title:"Nouvelle séance assignée",body:`Séance prévue le ${s}.`,type:"assignment"}).select("id").single();if(!f&&S){const h={notification_id:S.id};e.target_user_id&&(h.target_user_id=e.target_user_id),e.target_group_id&&(h.target_group_id=e.target_group_id),await a.from("notification_targets").insert(h)}return{status:"assigned"}}let n;if(r==="swim"?n=(w(_.SWIM_SESSIONS)||[]).find(u=>u.id===e.session_id):n=(w(_.STRENGTH_SESSIONS)||[]).find(u=>u.id===e.session_id),!n)return{status:"error"};const i={id:Date.now(),session_id:e.session_id,session_type:r,target_athlete:e.target_athlete??"",target_user_id:e.target_user_id??null,target_group_id:e.target_group_id??null,assigned_date:s,title:n.name??n.title,description:n.description,items:n.items,status:"assigned"},o=w(_.ASSIGNMENTS)||[];I(_.ASSIGNMENTS,[...o,i]);const c=w(_.NOTIFICATIONS)||[];return I(_.NOTIFICATIONS,[...c,{id:Date.now()+1,sender:"Coach",target_athlete:e.target_athlete,target_user_id:e.target_user_id??null,target_group_id:e.target_group_id??null,title:"Nouvelle séance assignée",message:`Séance ${n.title??n.name} prévue le ${s}.`,type:"assignment",related_id:i.id,read:!1,date:new Date().toISOString()}]),{status:"assigned"}}async function wt(e){if(d()){const{error:s}=await a.from("session_assignments").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}const r=(w(_.ASSIGNMENTS)||[]).filter(s=>s.id!==e);return I(_.ASSIGNMENTS,r),{status:"deleted"}}async function St(e){if(!d())return[];let t=a.from("session_assignments").select("*").gte("scheduled_date",e.from).lte("scheduled_date",e.to);if(e.groupId)t=t.eq("target_group_id",e.groupId);else if(e.userId){const{permanentGroupIds:u,temporaryGroupIds:l,hasActiveTemporary:m}=await V(e.userId),S=[`target_user_id.eq.${e.userId}`];(m?l:u).forEach(h=>S.push(`target_group_id.eq.${h}`)),t=t.or(S.join(","))}else return[];const{data:r,error:s}=await t;if(s)throw new Error(s.message);if(!r?.length)return[];const[n,i]=await Promise.all([L(),$()]),o=new Map(n.map(u=>[u.id,u])),c=new Map(i.map(u=>[u.id,u]));return r.map(u=>{const l=u.assignment_type==="strength"?"strength":"swim",m=v(l==="swim"?u.swim_catalog_id:u.strength_session_id)??0,S=l==="swim"?o.get(m):void 0,f=l==="strength"?c.get(m):void 0;return{id:T(u.id,0),title:l==="swim"?S?.name??"Séance natation":f?.title??"Séance musculation",type:l,scheduledDate:u.scheduled_date??"",scheduledSlot:u.scheduled_slot??null,targetLabel:"",targetType:u.target_group_id?"group":"user",status:u.status??"assigned"}})}async function yt(e){if(d()){const l=e?{from_date:e}:{},{data:m,error:S}=await a.rpc("get_hall_of_fame",l);if(!S&&m){const f=Array.isArray(m)?m:[],h=[...f].map(g=>({athlete_name:g.athlete_name,total_distance:Number(g.total_distance??0)})).sort((g,E)=>E.total_distance-g.total_distance).slice(0,5),b=[...f].map(g=>({athlete_name:g.athlete_name,avg_effort:Number(g.avg_performance??g.avg_engagement??0)})).sort((g,E)=>E.avg_effort-g.avg_effort).slice(0,5),N=[...f].map(g=>({athlete_name:g.athlete_name,avg_engagement:Number(g.avg_engagement??0)})).sort((g,E)=>E.avg_engagement-g.avg_engagement).slice(0,5);let x=[];const R=e?{from_date:e}:{},{data:p,error:y}=await a.rpc("get_hall_of_fame_strength",R);return!y&&p&&(x=(Array.isArray(p)?p:[]).map(g=>({athlete_name:g.athlete_name??"Inconnu",total_volume:Number(g.total_volume??0),total_reps:Number(g.total_reps??0),total_sets:Number(g.total_sets??0),max_weight:Number(g.max_weight??0)}))),{distance:h,performance:b,engagement:N,strength:x}}}await q(300);const t=w(_.SESSIONS)||[],r=w(_.STRENGTH_RUNS)||[],s=e?t.filter(l=>l.session_date>=e||l.date>=e):t,n=e?r.filter(l=>(l.started_at??l.date??"")>=e):r,i=new Map;s.forEach(l=>{i.has(l.athlete_name)||i.set(l.athlete_name,{distance:0,effortSum:0,count:0,engagementSum:0,engagementCount:0});const m=i.get(l.athlete_name);m.distance+=l.distance,m.effortSum+=l.effort,m.count+=1,l.engagement!==null&&l.engagement!==void 0&&Number.isFinite(l.engagement)&&(m.engagementSum+=l.engagement,m.engagementCount+=1)});const o=Array.from(i.entries()).map(([l,m])=>({athlete_name:l,total_distance:m.distance,avg_effort:m.effortSum/m.count,avg_engagement:m.engagementCount?m.engagementSum/m.engagementCount:0})),c=new Map;n.forEach(l=>{c.has(l.athlete_name)||c.set(l.athlete_name,{volume:0,reps:0,sets:0,maxWeight:0});const m=c.get(l.athlete_name);l.logs&&l.logs.forEach(S=>{const f=Number(S.reps??0),h=Number(S.weight??0);m.volume+=f*h,m.reps+=f,m.sets+=1,h>m.maxWeight&&(m.maxWeight=h)})});const u=Array.from(c.entries()).map(([l,m])=>({athlete_name:l,total_volume:m.volume,total_reps:m.reps,total_sets:m.sets,max_weight:m.maxWeight}));return{distance:[...o].sort((l,m)=>m.total_distance-l.total_distance).slice(0,5),performance:[...o].sort((l,m)=>m.avg_effort-l.avg_effort).slice(0,5),engagement:[...o].sort((l,m)=>m.avg_engagement-l.avg_engagement).slice(0,5),strength:[...u].sort((l,m)=>m.total_volume-l.total_volume).slice(0,5)}}async function Et(e){if(!d())return[];let t=a.from("club_records").select("*");e.pool_m&&(t=t.eq("pool_m",e.pool_m)),e.sex&&(t=t.eq("sex",e.sex)),e.age&&(t=t.eq("age",e.age)),e.event_code&&(t=t.eq("event_code",e.event_code));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function bt(){if(!d())return[];const{data:e,error:t}=await a.from("club_record_swimmers").select("*");if(t)throw new Error(t.message);return(e??[]).map(r=>({...r,is_active:r.is_active?1:0}))}async function vt(e){if(!d())return null;const t=e.iuf?.trim()||null;if(t){const{data:n,error:i}=await a.from("club_record_swimmers").select("id, display_name, source_type").eq("iuf",t).limit(1);if(i)throw new Error(i.message);if(n&&n.length>0){const o=n[0],c=o.source_type==="user"?"inscrit":"déjà ajouté";throw new Error(`Un nageur avec cet IUF existe déjà : ${o.display_name} (${c})`)}}const{data:r,error:s}=await a.from("club_record_swimmers").insert({source_type:"manual",display_name:e.display_name,iuf:t,sex:e.sex??null,birthdate:e.birthdate??null,is_active:e.is_active!==!1}).select().single();if(s)throw new Error(s.message);return r?{...r,is_active:r.is_active?1:0}:null}async function It(e,t){if(!d())return null;let r;if(t.iuf!==void 0&&(r=typeof t.iuf=="string"&&t.iuf.trim()||null,r)){const{data:o,error:c}=await a.from("club_record_swimmers").select("id, display_name, source_type").eq("iuf",r).neq("id",e).limit(1);if(c)throw new Error(c.message);if(o&&o.length>0){const u=o[0],l=u.source_type==="user"?"inscrit":"déjà ajouté";throw new Error(`Un nageur avec cet IUF existe déjà : ${u.display_name} (${l})`)}}const s={};t.iuf!==void 0&&(s.iuf=r??null),t.is_active!==void 0&&(s.is_active=t.is_active),t.sex!==void 0&&(s.sex=t.sex),t.birthdate!==void 0&&(s.birthdate=t.birthdate);const{data:n,error:i}=await a.from("club_record_swimmers").update(s).eq("id",e).select().single();if(i)throw new Error(i.message);return n?{...n,is_active:n.is_active?1:0}:null}async function Nt(e,t){if(!d())return null;const r={};t.iuf!==void 0&&(r.iuf=t.iuf),t.is_active!==void 0&&(r.is_active=t.is_active),t.sex!==void 0&&(r.sex=t.sex),t.birthdate!==void 0&&(r.birthdate=t.birthdate);const{data:s,error:n}=await a.from("club_record_swimmers").update(r).eq("user_id",e).eq("source_type","user").select().single();if(n)throw new Error(n.message);return s?{...s,is_active:s.is_active?1:0}:null}async function Tt(){if(!d())return null;const{data:e,error:t}=await a.functions.invoke("import-club-records");if(t){const r=e?.error??t.message;throw new Error(String(r))}return e}async function xt(e){if(!d())return[];let t=a.from("import_logs").select("*").order("started_at",{ascending:!1});e?.swimmerIuf&&(t=t.eq("swimmer_iuf",e.swimmerIuf)),e?.limit&&(t=t.limit(e.limit));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function qt(e,t){if(!d())throw new Error("Supabase not configured");const{data:r,error:s}=await a.functions.invoke("ffn-performances",{body:{swimmer_iuf:e,swimmer_name:t??null}});if(s){const n=r?.error??s.message;throw new Error(String(n))}return r??{total_found:0,new_imported:0,already_existed:0}}async function Rt(e){if(d()){let s=a.from("swim_records").select("*").order("record_date",{ascending:!1});e.athleteId&&(s=s.eq("athlete_id",e.athleteId));const{data:n,error:i}=await s;if(i)throw new Error(i.message);const o=n??[];return{records:o,pagination:{limit:o.length,offset:0,total:o.length}}}const r=(w(_.SWIM_RECORDS)||[]).filter(s=>e.athleteId?s.athlete_id===e.athleteId:e.athleteName?s.athlete_name===e.athleteName:!1);return{records:r,pagination:{limit:r.length,offset:0,total:r.length}}}async function At(e){if(d()){const s={athlete_id:e.athlete_id??null,event_name:e.event_name,pool_length:e.pool_length??null,time_seconds:e.time_seconds??null,record_date:e.record_date??null,notes:e.notes??null};if(e.id){const{error:n}=await a.from("swim_records").update(s).eq("id",e.id);if(n)throw new Error(n.message)}else{const{error:n}=await a.from("swim_records").insert(s);if(n)throw new Error(n.message)}return{status:"ok"}}const t=w(_.SWIM_RECORDS)||[];if(e.id){const s=t.map(n=>n.id===e.id?{...n,...e,athlete_id:e.athlete_id??n.athlete_id}:n);return I(_.SWIM_RECORDS,s),{status:"ok"}}const r={...e,id:Date.now(),athlete_id:e.athlete_id??-1,athlete_name:e.athleteName??null};return I(_.SWIM_RECORDS,[...t,r]),{status:"created"}}async function Ct(e){if(!d())return[];let t=a.from("swimmer_performances").select("*").order("competition_date",{ascending:!1});e.userId&&(t=t.eq("user_id",e.userId)),e.iuf&&(t=t.eq("swimmer_iuf",e.iuf)),e.eventCode&&(t=t.eq("event_code",e.eventCode)),e.poolLength&&(t=t.eq("pool_length",e.poolLength)),e.fromDate&&(t=t.gte("competition_date",e.fromDate)),e.toDate&&(t=t.lte("competition_date",e.toDate)),e.limit&&(t=t.limit(e.limit));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Ot(e){if(!d())throw new Error("Supabase not configured");const{data:t,error:r}=await a.functions.invoke("ffn-performances",{body:{swimmer_iuf:e.iuf,user_id:e.userId??null}});if(r){const s=t?.error??r.message;throw new Error(String(s))}return t??{total_found:0,new_imported:0,already_existed:0}}async function Dt(){if(!d())return null;const{data:e,error:t}=await a.functions.invoke("import-club-records",{body:{mode:"recalculate"}});if(t){const r=e?.error??t.message;throw new Error(String(r))}return e}async function Mt(){if(!d())return;const{data:e,error:t}=await a.from("users").select("id, display_name, role, birthdate").eq("role","athlete").eq("is_active",!0);if(t)throw new Error(t.message);if(!e||e.length===0)return;const{data:r}=await a.from("club_record_swimmers").select("id, user_id, iuf, sex, birthdate, display_name").eq("source_type","user"),s=new Map((r??[]).map(o=>[o.user_id,o])),{data:n}=await a.from("user_profiles").select("user_id, ffn_iuf, birthdate, sex"),i=new Map((n??[]).map(o=>[o.user_id,o]));for(const o of e){const c=i.get(o.id),u=c?.ffn_iuf??null,l=c?.sex??null,m=c?.birthdate??o.birthdate??null,S=s.get(o.id);if(!S)await a.from("club_record_swimmers").insert({source_type:"user",user_id:o.id,display_name:o.display_name,iuf:u,sex:l,birthdate:m,is_active:!0});else{const f={};u&&u!==S.iuf&&(f.iuf=u),l&&l!==S.sex&&(f.sex=l),m&&m!==S.birthdate&&(f.birthdate=m),o.display_name&&o.display_name!==S.display_name&&(f.display_name=o.display_name),Object.keys(f).length>0&&await a.from("club_record_swimmers").update(f).eq("id",S.id)}}}async function Ut(e){if(!d())return[];let t=a.from("club_performances").select("*").eq("event_code",e.event_code).eq("pool_m",e.pool_m).eq("sex",e.sex).order("time_ms",{ascending:!0});e.age!=null&&(t=t.eq("age",e.age));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Gt(e){if(!d())return null;const{data:t,error:r}=await a.from("app_settings").select("value").eq("key",e).single();return r?null:t?.value??null}async function kt(e,t){if(!d())return;const{error:r}=await a.from("app_settings").upsert({key:e,value:t,updated_at:new Date().toISOString()},{onConflict:"key"});if(r)throw new Error(r.message)}async function Ft(e){if(!d())return[];const{data:t,error:r}=await a.from("swim_exercise_logs").select("*").eq("session_id",e).order("created_at",{ascending:!0});if(r)throw new Error(r.message);return(t??[]).map(te)}async function Ht(e,t=50){if(!d())return[];const{data:r,error:s}=await a.from("swim_exercise_logs").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(t);if(s)throw new Error(s.message);return(r??[]).map(te)}async function Pt(e,t,r){if(!d())return;const{error:s}=await a.from("swim_exercise_logs").delete().eq("session_id",e).eq("user_id",t);if(s)throw new Error(s.message);if(r.length===0)return;const n=r.map(o=>({session_id:e,user_id:t,exercise_label:o.exercise_label,source_item_id:o.source_item_id??null,split_times:o.split_times??[],tempo:o.tempo??null,stroke_count:o.stroke_count??[],notes:o.notes??null})),{error:i}=await a.from("swim_exercise_logs").insert(n);if(i)throw new Error(i.message)}async function Lt(e,t){if(!d())return;const r={updated_at:new Date().toISOString()};t.exercise_label!==void 0&&(r.exercise_label=t.exercise_label),t.split_times!==void 0&&(r.split_times=t.split_times),t.tempo!==void 0&&(r.tempo=t.tempo),t.stroke_count!==void 0&&(r.stroke_count=t.stroke_count),t.notes!==void 0&&(r.notes=t.notes);const{error:s}=await a.from("swim_exercise_logs").update(r).eq("id",e);if(s)throw new Error(s.message)}async function jt(e){if(!d())return;const{error:t}=await a.from("swim_exercise_logs").delete().eq("id",e);if(t)throw new Error(t.message)}function te(e){return{id:String(e.id),session_id:Number(e.session_id),user_id:String(e.user_id),exercise_label:String(e.exercise_label??""),source_item_id:e.source_item_id!=null?Number(e.source_item_id):null,split_times:Array.isArray(e.split_times)?e.split_times:[],tempo:e.tempo!=null?Number(e.tempo):null,stroke_count:Array.isArray(e.stroke_count)?e.stroke_count:[],notes:e.notes!=null?String(e.notes):null,created_at:String(e.created_at??""),updated_at:String(e.updated_at??"")}}async function $t(){if(!d())return[];const{data:e,error:t}=await a.from("groups").select("id, name, is_active, parent_group_id, created_by, created_at").eq("is_temporary",!0).is("parent_group_id",null).order("created_at",{ascending:!1});if(t)throw new Error(t.message);if(!e?.length)return[];const r=e.map(c=>c.id),{data:s}=await a.from("groups").select("parent_group_id").eq("is_temporary",!0).in("parent_group_id",r),n=new Map;(s??[]).forEach(c=>{n.set(c.parent_group_id,(n.get(c.parent_group_id)??0)+1)});const{data:i}=await a.from("group_members").select("group_id").in("group_id",r),o=new Map;return(i??[]).forEach(c=>{o.set(c.group_id,(o.get(c.group_id)??0)+1)}),e.map(c=>({id:T(c.id,0),name:c.name,is_active:c.is_active??!0,parent_group_id:c.parent_group_id??null,member_count:o.get(c.id)??0,subgroup_count:n.get(c.id)??0,created_at:c.created_at??"",created_by:c.created_by??0}))}async function Bt(e){if(!d())return null;const{data:t,error:r}=await a.from("groups").select("id, name, is_active").eq("id",e).eq("is_temporary",!0).single();if(r||!t)return null;const{data:s}=await a.from("group_members").select("user_id, users!inner(display_name)").eq("group_id",e),n=(s??[]).map(m=>m.user_id),{data:i}=n.length?await a.from("group_members").select("user_id, group_id, groups!inner(name, is_temporary)").in("user_id",n).eq("groups.is_temporary",!1):{data:[]},o=new Map;(i??[]).forEach(m=>{o.has(m.user_id)||o.set(m.user_id,m.groups?.name??null)});const c=(s??[]).map(m=>({user_id:m.user_id,display_name:m.users?.display_name??"",permanent_group_label:o.get(m.user_id)??null})),{data:u}=await a.from("groups").select("id, name").eq("parent_group_id",e).eq("is_temporary",!0),l=await Promise.all((u??[]).map(async m=>{const{data:S}=await a.from("group_members").select("user_id, users!inner(display_name)").eq("group_id",m.id);return{id:m.id,name:m.name,members:(S??[]).map(f=>({user_id:f.user_id,display_name:f.users?.display_name??""}))}}));return{id:t.id,name:t.name,is_active:t.is_active,members:c,subgroups:l}}async function zt(e){if(!d())throw new Error("Supabase required");if(e.member_user_ids.length>0){const{data:n}=await a.from("group_members").select("user_id, group_id, groups!inner(is_temporary, is_active, parent_group_id)").in("user_id",e.member_user_ids).eq("groups.is_temporary",!0).eq("groups.is_active",!0),i=(n??[]).filter(o=>{const c=o.groups;return!(e.parent_group_id&&(o.group_id===e.parent_group_id||c.parent_group_id===e.parent_group_id))});if(i.length>0){const o=[...new Set(i.map(c=>c.user_id))];throw new Error(`Nageurs déjà dans un groupe temporaire actif: IDs ${o.join(", ")}`)}}if(e.parent_group_id&&e.member_user_ids.length>0){const{data:n}=await a.from("group_members").select("user_id").eq("group_id",e.parent_group_id),i=new Set((n??[]).map(c=>c.user_id)),o=e.member_user_ids.filter(c=>!i.has(c));if(o.length>0)throw new Error(`Nageurs non membres du groupe parent: IDs ${o.join(", ")}`)}const{data:t,error:r}=await a.from("groups").insert({name:e.name.trim(),is_temporary:!0,is_active:!0,parent_group_id:e.parent_group_id??null}).select("id").single();if(r)throw new Error(r.message);const s=t.id;if(e.member_user_ids.length>0){const n=e.member_user_ids.map(o=>({group_id:s,user_id:o})),{error:i}=await a.from("group_members").insert(n);if(i)throw new Error(i.message)}return{id:s}}async function Wt(e,t){if(!d())throw new Error("Supabase required");if(!t.length)return;const{data:r}=await a.from("group_members").select("user_id, group_id, groups!inner(is_temporary, is_active, parent_group_id)").in("user_id",t).eq("groups.is_temporary",!0).eq("groups.is_active",!0),s=(r??[]).filter(o=>!(o.group_id===e||o.groups.parent_group_id===e));if(s.length>0){const o=[...new Set(s.map(c=>c.user_id))];throw new Error(`Nageurs déjà dans un groupe temporaire actif: IDs ${o.join(", ")}`)}const n=t.map(o=>({group_id:e,user_id:o})),{error:i}=await a.from("group_members").insert(n);if(i)throw new Error(i.message)}async function Xt(e,t){if(!d())throw new Error("Supabase required");const{data:r}=await a.from("groups").select("id").eq("parent_group_id",e).eq("is_temporary",!0),s=[e,...(r??[]).map(i=>i.id)],{error:n}=await a.from("group_members").delete().eq("user_id",t).in("group_id",s);if(n)throw new Error(n.message)}async function Yt(e){if(!d())throw new Error("Supabase required");const{error:t}=await a.from("groups").update({is_active:!1}).or(`id.eq.${e},parent_group_id.eq.${e}`).eq("is_temporary",!0);if(t)throw new Error(t.message)}async function Vt(e){if(!d())throw new Error("Supabase required");const{data:t}=await a.from("group_members").select("user_id").eq("group_id",e),r=(t??[]).map(n=>n.user_id);if(r.length>0){const{data:n}=await a.from("group_members").select("user_id, groups!inner(is_temporary, is_active)").in("user_id",r).eq("groups.is_temporary",!0).eq("groups.is_active",!0);if(n&&n.length>0)throw new Error("Certains nageurs sont déjà dans un autre groupe temporaire actif.")}const{error:s}=await a.from("groups").update({is_active:!0}).or(`id.eq.${e},parent_group_id.eq.${e}`).eq("is_temporary",!0);if(s)throw new Error(s.message)}async function Jt(e){if(!d())throw new Error("Supabase required");const{data:t}=await a.from("groups").select("is_active").eq("id",e).single();if(t?.is_active)throw new Error("Impossible de supprimer un groupe temporaire actif. Désactivez-le d'abord.");await a.from("groups").delete().eq("parent_group_id",e).eq("is_temporary",!0);const{error:r}=await a.from("groups").delete().eq("id",e).eq("is_temporary",!0);if(r)throw new Error(r.message)}async function Kt(){if(!d())return[];const{data:e,error:t}=await a.from("competitions").select("*").order("date",{ascending:!0});if(t)throw new Error(t.message);return e??[]}async function Qt(e){if(!d())throw new Error("Supabase not available");const{data:{user:t}}=await a.auth.getUser(),{data:r,error:s}=await a.from("competitions").insert({...e,created_by:t?.id}).select().single();if(s)throw new Error(s.message);return r}async function Zt(e,t){if(!d())throw new Error("Supabase not available");const{data:r,error:s}=await a.from("competitions").update(t).eq("id",e).select().single();if(s)throw new Error(s.message);return r}async function er(e){if(!d())throw new Error("Supabase not available");const{error:t}=await a.from("competitions").delete().eq("id",e);if(t)throw new Error(t.message)}async function tr(e){if(!d())return[];const{data:t,error:r}=await a.from("competition_assignments").select("*").eq("competition_id",e);if(r)throw new Error(r.message);return t??[]}async function rr(e,t){if(!d())return;const{error:r}=await a.from("competition_assignments").delete().eq("competition_id",e);if(r)throw new Error(r.message);if(t.length>0){const s=t.map(i=>({competition_id:e,athlete_id:i})),{error:n}=await a.from("competition_assignments").insert(s);if(n)throw new Error(n.message)}}async function sr(){if(!d())return[];const{data:e,error:t}=await a.from("competition_assignments").select("competition_id");if(t)throw new Error(t.message);return(e??[]).map(r=>r.competition_id)}async function re(e){if(!d())return[];let t=a.from("objectives").select("*, competitions(name, date)").order("created_at",{ascending:!1});e&&(t=t.eq("athlete_id",e));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return(r??[]).map(n=>({id:n.id,athlete_id:n.athlete_id,competition_id:n.competition_id,event_code:n.event_code,pool_length:n.pool_length,target_time_seconds:n.target_time_seconds!=null?Number(n.target_time_seconds):null,text:n.text,created_by:n.created_by,created_at:n.created_at,competition_name:n.competitions?.name??null,competition_date:n.competitions?.date??null}))}async function nr(){if(!d())return[];const{data:{user:e}}=await a.auth.getUser();return e?re(e.id):[]}async function ir(e){if(!d())throw new Error("Supabase not available");const{data:{user:t}}=await a.auth.getUser(),{data:r,error:s}=await a.from("objectives").insert({...e,created_by:t?.id}).select().single();if(s)throw new Error(s.message);return r}async function ar(e,t){if(!d())throw new Error("Supabase not available");const{data:r,error:s}=await a.from("objectives").update(t).eq("id",e).select().single();if(s)throw new Error(s.message);return r}async function or(e){if(!d())throw new Error("Supabase not available");const{error:t}=await a.from("objectives").delete().eq("id",e);if(t)throw new Error(t.message)}async function cr(e){if(!d())return[];let t=a.from("planned_absences").select("*");e?.userId&&(t=t.eq("user_id",e.userId)),e?.from&&(t=t.gte("date",e.from)),e?.to&&(t=t.lte("date",e.to));const{data:r,error:s}=await t.order("date",{ascending:!0});if(s)throw new Error(s.message);return r??[]}async function ur(){if(!d())return[];const{data:e,error:t}=await a.from("planned_absences").select("*").order("date",{ascending:!0});if(t)throw new Error(t.message);return e??[]}async function dr(e,t){if(!d())throw new Error("Supabase not available");const{data:{session:r}}=await a.auth.getSession(),s=r?.user?.app_metadata?.app_user_id;if(!s)throw new Error("User ID not found");const{data:n,error:i}=await a.from("planned_absences").upsert({user_id:s,date:e,reason:t??null},{onConflict:"user_id,date"}).select().single();if(i)throw new Error(i.message);return n}async function lr(e){if(!d())return;const{data:{session:t}}=await a.auth.getSession(),r=t?.user?.app_metadata?.app_user_id;if(!r)return;const{error:s}=await a.from("planned_absences").delete().eq("user_id",r).eq("date",e);if(s)throw new Error(s.message)}const fr={async getCapabilities(){return d()?{mode:"supabase",version:null,timesheet:{available:!0},messaging:{available:!0}}:{mode:"local",version:null,timesheet:{available:!0},messaging:{available:!0}}},async syncFfnSwimRecords(e){if(!d())throw new Error("Supabase not configured");const{data:t,error:r}=await a.functions.invoke("ffn-sync",{body:{athlete_id:e.athleteId??null,athlete_name:e.athleteName??null,iuf:e.iuf}});if(r)throw new Error(r.message);return t??{inserted:0,updated:0,skipped:0}},async syncSession(e){if(d()){const n=ge(e),{data:i,error:o}=await a.from("dim_sessions").insert(n).select("id").single();if(o)throw new Error(o.message);return{status:"ok",sessionId:i.id}}await q(300);const t=this._get(_.SESSIONS)||[],r=Date.now(),s={...e,id:r,created_at:new Date().toISOString()};return this._save(_.SESSIONS,[...t,s]),{status:"ok",sessionId:r}},async ensureSwimSession(e){if(!d())throw new Error("Supabase required");let t=a.from("dim_sessions").select("id").eq("session_date",e.date).eq("time_slot",e.slot);e.athleteId?t=t.eq("athlete_id",Number(e.athleteId)):t=t.eq("athlete_name",e.athleteName);const{data:r}=await t.maybeSingle();if(r?.id)return r.id;const s={athlete_name:e.athleteName,session_date:e.date,time_slot:e.slot,distance:0,duration:0,rpe:5,performance:5,engagement:5,fatigue:5};e.athleteId&&(s.athlete_id=Number(e.athleteId));const{data:n,error:i}=await a.from("dim_sessions").insert(s).select("id").single();if(i)throw new Error(i.message);return n.id},async getSessions(e,t){const r=t!=null&&String(t)!=="";if(d()){let n=a.from("dim_sessions").select("*").order("session_date",{ascending:!1});r?n=n.eq("athlete_id",Number(t)):n=n.eq("athlete_name",e);const{data:i,error:o}=await n;if(o)throw new Error(o.message);return(i??[]).map(pe).filter(c=>!!c)}return await q(200),(this._get(_.SESSIONS)||[]).filter(n=>r&&n.athlete_id?String(n.athlete_id)===String(t):n.athlete_name.toLowerCase()===e.toLowerCase()).map(n=>({...n,effort:D(n.effort)??n.effort,feeling:D(n.feeling)??n.feeling,rpe:D(n.rpe??null),performance:D(n.performance??null),engagement:D(n.engagement??null),fatigue:D(n.fatigue??null)})).sort((n,i)=>new Date(i.date).getTime()-new Date(n.date).getTime())},async updateSession(e){if(d()){const n={athlete_name:e.athlete_name,session_date:e.date,time_slot:e.slot,distance:e.distance,duration:e.duration,rpe:U(e.effort),performance:U(e.performance??e.feeling),engagement:U(e.engagement??e.feeling),fatigue:U(e.feeling),comments:e.comments},{error:i}=await a.from("dim_sessions").update(n).eq("id",e.id);if(i)throw new Error(i.message);return{status:"updated"}}await q(200);const t=this._get(_.SESSIONS)||[],r=t.findIndex(n=>n.id===e.id);if(r===-1)return{status:"missing"};const s=[...t];return s[r]={...s[r],...e},this._save(_.SESSIONS,s),{status:"updated"}},async deleteSession(e){if(d()){const{error:s}=await a.from("dim_sessions").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}await q(200);const r=(this._get(_.SESSIONS)||[]).filter(s=>s.id!==e);return this._save(_.SESSIONS,r),{status:"deleted"}},async seedDemoData(){const e=[{id:1,nom_exercice:"Squat",description:"Flexion des jambes",exercise_type:"strength"},{id:2,nom_exercice:"Développé Couché",description:"Poussée horizontale",exercise_type:"strength"},{id:3,nom_exercice:"Tractions",description:"Tirage vertical",exercise_type:"strength"},{id:4,nom_exercice:"Rotations Élastique",description:"Coiffe des rotateurs",exercise_type:"warmup"}];this._save(_.EXERCISES,e);const t={id:101,title:"Full Body A",description:"Séance globale",cycle:"Endurance",items:[{exercise_id:4,exercise_name:"Rotations Élastique",category:"warmup",order_index:0,sets:2,reps:15,rest_seconds:30,percent_1rm:0},{exercise_id:1,exercise_name:"Squat",category:"strength",order_index:1,sets:4,reps:10,rest_seconds:90,percent_1rm:70},{exercise_id:2,exercise_name:"Développé Couché",category:"strength",order_index:2,sets:4,reps:10,rest_seconds:90,percent_1rm:70}]};this._save(_.STRENGTH_SESSIONS,[t]);const r={id:201,name:"VMA 100",description:"Travail de vitesse",created_by:1,items:[{label:"Échauffement 4N",distance:400,intensity:"Souple",notes:"Progressif"},{label:"Corps NL",distance:1e3,intensity:"Max",notes:"10x100 départ 1:30"}]};this._save(_.SWIM_SESSIONS,[r]);const s=new Date().toISOString().split("T")[0];return await this.assignments_create({session_id:101,assignment_type:"strength",target_athlete:"Camille",assigned_date:s}),{status:"seeded"}},_get(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null},_save(e,t){localStorage.setItem(e,JSON.stringify(t))},resetCache(){Object.values(_).forEach(e=>localStorage.removeItem(e)),window.location.reload()},async getHallOfFame(e){return yt(e)},async getClubRecords(e){return Et(e)},async getClubRecordSwimmers(){return bt()},async createClubRecordSwimmer(e){return vt(e)},async updateClubRecordSwimmer(e,t){return It(e,t)},async updateClubRecordSwimmerForUser(e,t){return Nt(e,t)},async importClubRecords(){return Tt()},async getImportLogs(e){return xt(e)},async importSingleSwimmer(e,t){return qt(e,t)},async getSwimRecords(e){return Rt(e)},async upsertSwimRecord(e){return At(e)},async getSwimmerPerformances(e){return Ct(e)},async importSwimmerPerformances(e){return Ot(e)},async recalculateClubRecords(){return Dt()},async getClubRanking(e){return Ut(e)},async syncClubRecordSwimmersFromUsers(){return Mt()},async getAppSettings(e){return Gt(e)},async updateAppSettings(e,t){return kt(e,t)},async getExercises(){return Ve()},async createExercise(e){return Je(e)},async updateExercise(e){return Ke(e)},async deleteExercise(e){return Qe(e)},async getStrengthSessions(){return $()},async createStrengthSession(e){return Ze(e)},async updateStrengthSession(e){return ee(e)},async persistStrengthSessionOrder(e){return et(e)},async deleteStrengthSession(e){return tt(e)},async startStrengthRun(e){return rt(e)},async logStrengthSet(e){return st(e)},async updateStrengthRun(e){return nt(e)},async deleteStrengthRun(e){return it(e)},async saveStrengthRun(e){return at(e)},async getStrengthHistory(e,t){return ot(e,t)},async getStrengthHistoryAggregate(e,t){return ct(e,t)},async get1RM(e){return k(e)},async update1RM(e){return F(e)},async updateExerciseNote(e){return ut(e)},async getStrengthFolders(e){return dt(e)},async createStrengthFolder(e,t){return lt(e,t)},async renameStrengthFolder(e,t){return mt(e,t)},async deleteStrengthFolder(e){return _t(e)},async moveToFolder(e,t,r){return ft(e,t,r)},async getSwimExerciseLogs(e){return Ft(e)},async getSwimExerciseLogsHistory(e,t){return Ht(e,t)},async saveSwimExerciseLogs(e,t,r){return Pt(e,t,r)},async updateSwimExerciseLog(e,t){return Lt(e,t)},async deleteSwimExerciseLog(e){return jt(e)},async getSwimCatalog(){return L()},async createSwimSession(e){return fe(e)},async deleteSwimSession(e){return _e(e)},async archiveSwimSession(e,t){return me(e,t)},async moveSwimSession(e,t){return le(e,t)},async migrateLocalStorageArchive(e){return de(e)},async generateShareToken(e){return ue(e)},async getSharedSession(e){return ce(e)},async getAssignmentsForCoach(){return gt()},async getCoachAssignments(e){return St(e)},async getAssignments(e,t,r){return pt(e,t,r)},async assignments_create(e){const t=ne.getState().userId;return ht(e,t)},async assignments_delete(e){return wt(e)},async getNotifications(e){return Pe(e)},async notifications_send(e){return Le(e)},async markNotificationRead(e){return je(e)},async notifications_list(e){return $e(e)},async notifications_mark_read(e){return Be(e)},async listTimesheetShifts(e){return Oe(e)},async listTimesheetLocations(){return De()},async createTimesheetLocation(e){return Me(e)},async deleteTimesheetLocation(e){return Ue(e)},async listTimesheetCoaches(){return Ge()},async createTimesheetShift(e){return ke(e)},async updateTimesheetShift(e){return Fe(e)},async deleteTimesheetShift(e){return He(e)},async getTemporaryGroups(){return $t()},async getTemporaryGroupDetail(e){return Bt(e)},async createTemporaryGroup(e){return zt(e)},async addTemporaryGroupMembers(e,t){return Wt(e,t)},async removeTemporaryGroupMember(e,t){return Xt(e,t)},async deactivateTemporaryGroup(e){return Yt(e)},async reactivateTemporaryGroup(e){return Vt(e)},async deleteTemporaryGroup(e){return Jt(e)},async getCompetitions(){return Kt()},async createCompetition(e){return Qt(e)},async updateCompetition(e,t){return Zt(e,t)},async deleteCompetition(e){return er(e)},async getCompetitionAssignments(e){return tr(e)},async setCompetitionAssignments(e,t){return rr(e,t)},async getMyCompetitionIds(){return sr()},async getObjectives(e){return re(e)},async getAthleteObjectives(){return nr()},async createObjective(e){return ir(e)},async updateObjective(e,t){return ar(e,t)},async deleteObjective(e){return or(e)},async getPlannedAbsences(e){return cr(e)},async getMyPlannedAbsences(){return ur()},async setPlannedAbsence(e,t){return dr(e,t)},async removePlannedAbsence(e){return lr(e)},async getProfile(e){return he(e)},async updateProfile(e){return we(e)},async getAthletes(){return Se()},async getGroups(){return ye()},async getUpcomingBirthdays(e){return Ee(e)},async listUsers(e){return be(e)},async createCoach(e){return ve(e)},async updateUserRole(e){return Ie(e)},async disableUser(e){return Ne(e)},async getPendingApprovals(){return Te()},async approveUser(e){return xe(e)},async rejectUser(e){return qe(e)},async authPasswordUpdate(e){return Re(e)},async uploadAvatar(e){return Ae(e)},async deleteAvatar(e){return Ce(e)}};export{fr as a};
