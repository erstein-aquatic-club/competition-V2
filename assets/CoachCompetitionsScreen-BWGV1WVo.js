import{r as h,u as P,j as e,c as B,d as $}from"./vendor-query-DyA9aSKS.js";import{a as b}from"./api-BtIHeptF.js";import{B as K,P as H,T as J,a as F,d as O,L as z,I as U}from"./index-CmT0igch.js";import{C as X}from"./Coach-C5qD3zzh.js";import{T as W}from"./textarea-BvUuicJr.js";import{S as Y,a as Z,b as ee,c as te}from"./sheet-GOROUIyc.js";import{A as se,a as ae,b as ne,c as re,d as ie,e as oe,f as le,g as de}from"./alert-dialog-BTjV-RLR.js";import{C as ce}from"./checkbox-5KZ4u2h4.js";import{S as me,a as ue,b as pe,c as xe,d as he}from"./select-CcgvEoDx.js";import{C as ge}from"./chevron-down-BFbyBy5H.js";import"./vendor-react-BzrpNAyj.js";import"./swim-yZ4Uojp_.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./toggle-group-DSdRciWu.js";import"./index-C7BZntNZ.js";import"./index-wd9XrE0z.js";import"./target-DPR3H2c2.js";import"./clock-CF_682Ol.js";import"./index-CxxJXSn6.js";import"./index-BtqdAbXv.js";import"./index-DCX2sNhR.js";import"./chevron-up-BpCENxFh.js";function fe(r){const c=new Date;c.setHours(0,0,0,0);const a=new Date(r+"T00:00:00");return Math.ceil((a.getTime()-c.getTime())/(1e3*60*60*24))}function ve(r){return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}-${String(r.getDate()).padStart(2,"0")}`}function _(r,c){return Math.max(0,Math.round((new Date(c+"T00:00:00").getTime()-new Date(r+"T00:00:00").getTime())/6048e5))}const je=7,be=20,ye=72;function q(r){return Math.min(ye,Math.max(be,r*je))}const Ne=({open:r,onOpenChange:c,competition:a})=>{const{toast:p}=O(),x=B(),d=!!a,[f,y]=h.useState(""),[g,N]=h.useState(""),[s,m]=h.useState(""),[i,o]=h.useState(""),[u,w]=h.useState(""),[S,n]=h.useState(!1),[l,j]=h.useState(new Set),{data:C=[]}=P({queryKey:["athletes"],queryFn:()=>b.getAthletes()}),{data:I=[]}=P({queryKey:["groups"],queryFn:()=>b.getGroups()}),{data:E}=P({queryKey:["competition-assignments",a?.id],queryFn:()=>b.getCompetitionAssignments(a.id),enabled:!!a?.id});h.useEffect(()=>{r&&(a?(y(a.name),N(a.date),m(a.end_date??a.date??""),o(a.location??""),w(a.description??""),E&&j(new Set(E.map(t=>t.athlete_id)))):(y(""),N(""),m(""),o(""),w(""),j(new Set)))},[r,a,E]);const v=$({mutationFn:t=>b.createCompetition(t),onSuccess:async t=>{if(l.size>0)try{await b.setCompetitionAssignments(t.id,Array.from(l))}catch(D){console.warn("[EAC] Failed to save competition assignments:",D)}p({title:"Competition creee"}),x.invalidateQueries({queryKey:["competitions"]}),x.invalidateQueries({queryKey:["competition-assignments"]}),c(!1)},onError:t=>{p({title:"Erreur",description:t.message,variant:"destructive"})}}),k=$({mutationFn:t=>b.updateCompetition(a.id,t),onSuccess:async()=>{try{await b.setCompetitionAssignments(a.id,Array.from(l))}catch(t){console.warn("[EAC] Failed to save competition assignments:",t)}p({title:"Competition mise a jour"}),x.invalidateQueries({queryKey:["competitions"]}),x.invalidateQueries({queryKey:["competition-assignments"]}),c(!1)},onError:t=>{p({title:"Erreur",description:t.message,variant:"destructive"})}}),R=$({mutationFn:()=>b.deleteCompetition(a.id),onSuccess:()=>{p({title:"Competition supprimee"}),x.invalidateQueries({queryKey:["competitions"]}),c(!1)},onError:t=>{p({title:"Erreur",description:t.message,variant:"destructive"})}}),G=()=>{if(!f.trim()){p({title:"Nom requis",description:"Veuillez saisir un nom pour la competition.",variant:"destructive"});return}if(!g){p({title:"Date requise",description:"Veuillez saisir une date.",variant:"destructive"});return}const t={name:f.trim(),date:g,end_date:s||g||null,location:i.trim()||null,description:u.trim()||null};d?k.mutate(t):v.mutate(t)},L=v.isPending||k.isPending||R.isPending,Q="flex h-9 w-full rounded-lg border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",V=t=>{N(t),(!s||s<t)&&m(t)};return e.jsxs(e.Fragment,{children:[e.jsx(Y,{open:r,onOpenChange:c,children:e.jsxs(Z,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(ee,{children:e.jsx(te,{children:d?"Modifier":"Nouvelle compétition"})}),e.jsxs("div",{className:"mt-5 space-y-5",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(z,{htmlFor:"comp-name",className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Nom"}),e.jsx(U,{id:"comp-name",placeholder:"Ex : Championnats Régionaux",value:f,onChange:t=>y(t.target.value),className:"text-[15px] font-medium"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("span",{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Dates"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"comp-date",className:"text-[10px] text-muted-foreground/60 pl-0.5",children:"Début"}),e.jsx("input",{id:"comp-date",type:"date",value:g,onChange:t=>V(t.target.value),className:Q})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"comp-end-date",className:"text-[10px] text-muted-foreground/60 pl-0.5",children:"Fin"}),e.jsx("input",{id:"comp-end-date",type:"date",value:s,onChange:t=>m(t.target.value),min:g||void 0,className:Q})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(z,{htmlFor:"comp-location",className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Lieu"}),e.jsx(U,{id:"comp-location",placeholder:"Ex : Piscine de Strasbourg",value:i,onChange:t=>o(t.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(z,{htmlFor:"comp-description",className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Notes"}),e.jsx(W,{id:"comp-description",placeholder:"Informations complémentaires...",value:u,onChange:t=>w(t.target.value),rows:2,className:"resize-none"})]}),e.jsx("div",{className:"border-t border-border/40"}),e.jsxs("div",{className:"space-y-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Nageurs"}),e.jsxs("span",{className:"text-[10px] tabular-nums text-muted-foreground/50",children:[l.size," sélectionné",l.size>1?"s":""]})]}),e.jsxs(me,{value:"",onValueChange:t=>{const D=C.filter(M=>M.group_id===Number(t));j(M=>{const T=new Set(M);return D.forEach(A=>{A.id!=null&&T.add(A.id)}),T})},children:[e.jsx(ue,{className:"h-8 text-xs",children:e.jsx(pe,{placeholder:"Ajouter un groupe..."})}),e.jsx(xe,{children:I.filter(t=>!t.is_temporary).map(t=>e.jsx(he,{value:String(t.id),children:t.name},t.id))})]}),e.jsx("div",{className:"max-h-44 overflow-y-auto rounded-lg border p-1.5 space-y-0.5",children:C.map(t=>{if(t.id==null)return null;const D=l.has(t.id);return e.jsxs("label",{className:F("flex items-center gap-2 py-1 px-1.5 rounded-md cursor-pointer transition-colors",D?"bg-primary/5":"hover:bg-muted/50"),children:[e.jsx(ce,{checked:D,onCheckedChange:M=>{j(T=>{const A=new Set(T);return M?A.add(t.id):A.delete(t.id),A})}}),e.jsx("span",{className:"text-[13px]",children:t.display_name}),t.group_label&&e.jsx("span",{className:"text-[10px] text-muted-foreground/50 ml-auto",children:t.group_label})]},t.id)})})]}),e.jsxs("div",{className:"space-y-3 pt-1",children:[e.jsx(K,{className:"w-full",onClick:G,disabled:L||!f.trim()||!g||!s,children:L?"Enregistrement...":d?"Enregistrer":"Créer la compétition"}),d&&e.jsx("button",{type:"button",className:"w-full text-center text-[11px] text-destructive/50 hover:text-destructive py-1.5 transition-colors",onClick:()=>n(!0),disabled:L,children:"Supprimer cette compétition"})]})]})]})}),e.jsx(se,{open:S,onOpenChange:n,children:e.jsxs(ae,{children:[e.jsxs(ne,{children:[e.jsx(re,{children:"Supprimer la compétition"}),e.jsxs(ie,{children:["Cette action est irréversible. La compétition «"," ",a?.name," » sera supprimée définitivement."]})]}),e.jsxs(oe,{children:[e.jsx(le,{children:"Annuler"}),e.jsx(de,{onClick:()=>{R.mutate(),n(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},we=({competitions:r,onEdit:c})=>{const[a,p]=h.useState(!1),{items:x,todayIdx:d}=h.useMemo(()=>{const s=[...r].sort((n,l)=>n.date.localeCompare(l.date)),m=new Date;m.setHours(0,0,0,0);const i=ve(m),o=[];let u="",w="",S=!1;for(const n of s){const l=n.date<i,j=fe(n.date),C=n.date.slice(0,7),I=C!==w,E=new Date(n.date+"T00:00:00").toLocaleDateString("fr-FR",{month:"short"}).replace(".","").toUpperCase();if(!S&&!l){if(u){const k=_(u,i);k>=1&&o.push({kind:"gap",weeks:k,height:q(k)})}o.push({kind:"today"}),S=!0;const v=_(i,n.date);v>=1&&o.push({kind:"gap",weeks:v,height:q(v)})}else if(u){const v=_(u,n.date);v>=1&&o.push({kind:"gap",weeks:v,height:q(v)})}o.push({kind:"comp",comp:n,isPast:l,days:j,isNewMonth:I,monthLabel:E}),u=n.end_date||n.date,w=C}if(!S){if(u){const n=_(u,i);n>=1&&o.push({kind:"gap",weeks:n,height:q(n)})}o.push({kind:"today"})}return{items:o,todayIdx:o.findIndex(n=>n.kind==="today")}},[r]);if(r.length===0)return null;const f=d>0?x.slice(0,d):[],y=d>=0?x.slice(d):x,g=f.filter(s=>s.kind==="comp").length,N=(s,m)=>{if(s.kind==="gap")return e.jsx("div",{className:"relative",style:{height:s.height},children:s.weeks>=2&&e.jsxs("span",{className:"absolute left-[-0.8rem] -translate-x-1/2 top-1/2 -translate-y-1/2 text-[9px] tabular-nums font-medium text-muted-foreground/30 bg-background px-1 select-none",children:[s.weeks,"s"]})},`g${m}`);if(s.kind==="today")return e.jsxs("div",{className:"relative flex items-center h-7 -ml-14",children:[e.jsx("div",{className:"absolute left-0 right-0 h-[2px] bg-emerald-500/60"}),e.jsx("span",{className:"relative text-[10px] font-bold tracking-widest text-emerald-600 dark:text-emerald-400 bg-background pl-2 pr-1.5 select-none",children:"AUJOURD'HUI"})]},"today");const{comp:i,isPast:o,days:u,isNewMonth:w,monthLabel:S}=s,n=(()=>{const l=new Date(i.date+"T00:00:00");if(!i.end_date||i.end_date===i.date)return l.toLocaleDateString("fr-FR",{day:"numeric",month:"short"}).replace(".","");const j=new Date(i.end_date+"T00:00:00"),C=j.toLocaleDateString("fr-FR",{day:"numeric",month:"short"}).replace(".","");return l.getMonth()===j.getMonth()?`${l.getDate()}–${C}`:`${l.toLocaleDateString("fr-FR",{day:"numeric",month:"short"}).replace(".","")} → ${C}`})();return e.jsxs("button",{type:"button",className:F("relative w-full flex items-start text-left py-1.5 group transition-opacity",o?"opacity-40 hover:opacity-70":"hover:opacity-80"),onClick:()=>c(i),children:[w&&e.jsx("span",{className:"absolute left-[-3.25rem] top-[3px] w-[2rem] text-[10px] font-bold uppercase tracking-widest text-muted-foreground/50 text-right select-none",children:S}),e.jsx("div",{className:F("absolute left-[-0.8rem] top-[5px] h-[10px] w-[10px] rounded-full -translate-x-1/2 z-10 border-2 border-background transition-transform group-hover:scale-150",o?"bg-muted-foreground/30":"bg-amber-500 shadow-[0_0_6px_rgba(245,158,11,0.4)]")}),e.jsxs("div",{className:"min-w-0 flex-1 pl-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 min-w-0",children:[e.jsx("span",{className:F("text-[13px] font-semibold truncate flex-1 min-w-0",o?"text-muted-foreground":"text-foreground"),children:i.name}),!o&&u>=0&&e.jsxs("span",{className:"text-[10px] font-bold tabular-nums shrink-0 px-1.5 py-0.5 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",children:["J-",u]})]}),e.jsxs("p",{className:F("text-[11px] truncate",o?"text-muted-foreground/60":"text-muted-foreground"),children:[n,i.location&&i.location!=="??"&&` · ${i.location}`]})]})]},i.id)};return e.jsxs("div",{className:"relative pl-14",children:[e.jsx("div",{className:"absolute left-[2.625rem] top-1 bottom-1 w-[2px] rounded-full bg-gradient-to-b from-border/10 via-border/40 to-border/10"}),g>0&&e.jsxs("button",{type:"button",className:"relative flex items-center gap-1.5 py-2 text-[11px] font-medium text-muted-foreground/50 hover:text-muted-foreground transition-colors select-none",onClick:()=>p(s=>!s),children:[e.jsx(ge,{className:F("h-3 w-3 shrink-0 transition-transform",a&&"rotate-180")}),e.jsxs("span",{children:["Passées (",g,")"]})]}),a&&f.map((s,m)=>N(s,m)),y.map((s,m)=>N(s,f.length+m))]})},Je=({onBack:r})=>{const[c,a]=h.useState(!1),[p,x]=h.useState(null),{data:d=[],isLoading:f}=P({queryKey:["competitions"],queryFn:()=>b.getCompetitions()}),y=()=>{x(null),a(!0)},g=s=>{x(s),a(!0)},N=d.length===0?"Gerez les competitions du club.":`${d.length} competition${d.length>1?"s":""}`;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(X,{title:"Competitions",description:N,onBack:r,actions:e.jsxs(K,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})}),f?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(s=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},s))}):d.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(J,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucune competition creee."}),e.jsxs(K,{variant:"outline",size:"sm",onClick:y,children:[e.jsx(H,{className:"mr-1.5 h-3.5 w-3.5"}),"Creer la premiere competition"]})]}):e.jsx(we,{competitions:d,onEdit:g}),e.jsx(Ne,{open:c,onOpenChange:a,competition:p})]})};export{Je as default};
