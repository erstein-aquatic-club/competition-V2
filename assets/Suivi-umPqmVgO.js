const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B-cV5_et.js","assets/vendor-query-DyA9aSKS.js","assets/vendor-react-BzrpNAyj.js","assets/vendor-charts-BrQ8X25f.js","assets/vendor-supabase-DFPLkPj_.js","assets/vendor-motion-lao-Njgm.js","assets/index-1RPOWF0g.css"])))=>i.map(i=>d[i]);
import{c as Te,u as _,r as x,d as V,j as e,f as De}from"./vendor-query-DyA9aSKS.js";import{d as Me,B as $,L as A,v as We,_ as Ge,u as U,P as Z,w as Fe,I as Qe,s as He,f as ee}from"./index-B-cV5_et.js";import{a as j}from"./api-C0PicKMC.js";import{B as T}from"./badge-DBaRoe0f.js";import{C as qe,a as Ee,b as Oe}from"./collapsible-BRcSdiaG.js";import{T as Ue,a as Je,b as G,c as Q}from"./tabs-Dul-VTZ3.js";import{M as Ae,S as Xe,w as Pe,a as $e,G as Ye,C as Be,b as Ze}from"./weekTypeColor-D0Xrs8LQ.js";import{T as L}from"./textarea-C95ofduR.js";import{O as R,a as me,F as es,e as ss,f as ts,p as ue}from"./ObjectiveCard-DJ-9B701.js";import{A as ne}from"./arrow-left-YXszS7qP.js";import{C as as}from"./chevron-up-D9OZ1wvS.js";import{C as rs}from"./chevron-down-DzU4HlaE.js";import{C as H}from"./clock-DLHLZGwJ.js";import{C as xe}from"./circle-check-B0o53wnP.js";import{C as Ie}from"./chevron-right-C5442no3.js";import{T as Ke}from"./trophy-BGli27ad.js";import{T as ns,a as se}from"./toggle-group-4zYcX4Ft.js";import{S as pe,a as he,b as ge,c as je,d as te}from"./select-DgPuQ9AQ.js";import{S as is,a as cs,b as ls,c as os,d as ds}from"./sheet-BRNJIvAi.js";import{A as ms,a as us,b as xs,c as ps,d as hs,e as gs,f as js,g as fs}from"./alert-dialog-VAqJp1al.js";import{S as bs}from"./sparkles-CMgIE7BP.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./swim-DPYx-c4I.js";import"./index-D40ARvHG.js";import"./index-DNgpBUD1.js";import"./chart-column-DKwyrx2Q.js";import"./index-DV6B5lzW.js";import"./index-DCX2sNhR.js";import"./index-DIjaVZHU.js";function W(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function fe(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function ys(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Ns(s){const t=new Date;t.setHours(0,0,0,0);const i=new Date(s+"T00:00:00"),c=new Date(s+"T00:00:00");return c.setDate(c.getDate()+6),t>=i&&t<=c}function be(s,t){const i=[],c=new Date(s+"T00:00:00"),p=new Date(t+"T00:00:00"),o=new Date(c),m=o.getDay(),g=m===0?1:m===1?0:8-m;for(o.setDate(o.getDate()+g);o<=p;)i.push(o.toISOString().split("T")[0]),o.setDate(o.getDate()+7);return i}function ye(s,t){const i=new Date(s+"T00:00:00"),c=new Date(t+"T00:00:00");return Math.round((c.getTime()-i.getTime())/(1e3*60*60*24))}function vs({onBack:s,embedded:t=!1}){const{toast:i}=Me(),c=Te(),{data:p}=_({queryKey:["auth-user"],queryFn:async()=>{const{data:u}=await(await Ge(async()=>{const{supabase:f}=await import("./index-B-cV5_et.js").then(S=>S.ah);return{supabase:f}},__vite__mapDeps([0,1,2,3,4,5,6]))).supabase.auth.getUser();return u.user}}),o=p?.app_metadata?.app_user_id,{data:m=[],isLoading:g}=_({queryKey:["my-interviews"],queryFn:()=>j.getMyInterviews()}),{data:k=[]}=_({queryKey:["athlete-objectives"],queryFn:()=>j.getAthleteObjectives()}),{data:M}=_({queryKey:["my-profile-iuf"],queryFn:()=>j.getProfile({userId:o}),enabled:!!o}),C=M?.ffn_iuf??null,N=x.useMemo(()=>{const u=new Date;return u.setDate(u.getDate()-360),u.toISOString().slice(0,10)},[]),{data:v=[]}=_({queryKey:["swimmer-performances-recent",C],queryFn:()=>j.getSwimmerPerformances({iuf:C,fromDate:N}),enabled:!!C}),l=x.useCallback(()=>c.invalidateQueries({queryKey:["my-interviews"]}),[c]),r=V({mutationFn:({id:u,input:f})=>j.updateInterviewAthleteSections(u,f),onSuccess:()=>{i({title:"Sauvegardé"}),l()},onError:u=>i({title:"Erreur",description:u.message,variant:"destructive"})}),n=V({mutationFn:u=>j.submitInterviewToCoach(u),onSuccess:()=>{i({title:"Envoyé au coach"}),l()},onError:u=>i({title:"Erreur",description:u.message,variant:"destructive"})}),h=V({mutationFn:u=>j.signInterview(u),onSuccess:()=>{i({title:"Entretien signé"}),l()},onError:u=>i({title:"Erreur",description:u.message,variant:"destructive"})});return e.jsxs("div",{className:"space-y-6 pb-24",children:[!t&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs($,{variant:"ghost",size:"sm",className:"-ml-2",onClick:s,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:"Mes entretiens"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Entretiens individuels avec le coach"})]}),g&&e.jsx("div",{className:"space-y-3",children:[1,2,3].map(u=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-40 rounded bg-muted"})},u))}),!g&&m.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Ae,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun entretien en cours. Votre coach initiera les entretiens."})]}),!g&&m.map(u=>e.jsx(ws,{interview:u,objectives:k,performances:v,appUserId:o??null,onSave:(f,S)=>r.mutate({id:f,input:S}),onSubmit:f=>{window.confirm("Envoyer votre préparation au coach ? Vous ne pourrez plus la modifier.")&&n.mutate(f)},onSign:f=>{window.confirm("Confirmer la signature de cet entretien ?")&&h.mutate(f)},isSaving:r.isPending,isSubmitting:n.isPending,isSigning:h.isPending},u.id))]})}function ws({interview:s,objectives:t,performances:i,appUserId:c,onSave:p,onSubmit:o,onSign:m,isSaving:g,isSubmitting:k,isSigning:M}){const C=s.status==="draft_athlete",N=s.status==="draft_coach",v=s.status==="sent",l=s.status==="signed",[r,n]=x.useState(!1),[h,u]=x.useState(s.athlete_successes??""),[f,S]=x.useState(s.athlete_difficulties??""),[D,q]=x.useState(s.athlete_goals??""),[F,P]=x.useState(s.athlete_commitments??""),[w,O]=x.useState(s.athlete_commitment_review??""),{data:d}=_({queryKey:["my-previous-interview",s.date,s.id],queryFn:()=>c?j.getPreviousInterview(c,s.date,s.id):null,enabled:(C||v||l||N)&&!!c}),E=x.useRef(!1),b=x.useCallback(()=>{E.current||!C||(E.current=!0,p(s.id,{athlete_successes:h||null,athlete_difficulties:f||null,athlete_goals:D||null,athlete_commitments:F||null,athlete_commitment_review:w||null}),setTimeout(()=>{E.current=!1},500))},[s.id,h,f,D,F,w,p,C]),B=C?e.jsxs(T,{className:"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400 border-amber-300 dark:border-amber-700",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),"À préparer"]}):N?e.jsxs(T,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400 border-blue-300 dark:border-blue-700",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),"En préparation"]}):v?e.jsxs(T,{className:"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400 border-emerald-300 dark:border-emerald-700",children:[e.jsx(xe,{className:"h-3 w-3 mr-1"}),"À signer"]}):e.jsx(T,{variant:"secondary",children:"Signé"}),I=C?"border-amber-300 dark:border-amber-700 border-l-4":N?"border-blue-300 dark:border-blue-700 border-l-4":v?"border-emerald-300 dark:border-emerald-700 border-l-4":"";return e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${I}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>n(y=>!y),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:W(s.date)}),B,l&&s.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",W(s.signed_at.slice(0,10))]})]}),r?e.jsx(as,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(rs,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),r&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[C&&e.jsxs(e.Fragment,{children:[d&&(d.athlete_commitments||d.coach_actions)&&e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3 space-y-2",children:[e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Bilan des engagements précédents"}),d.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2 space-y-0.5",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mes engagements"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:d.athlete_commitments})]}),d.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2 space-y-0.5",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions du coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:d.coach_actions})]}),e.jsxs("div",{className:"space-y-1 pt-1",children:[e.jsx(A,{htmlFor:`commitment-review-${s.id}`,className:"text-xs",children:"Comment avez-vous tenu vos engagements ?"}),e.jsx(L,{id:`commitment-review-${s.id}`,placeholder:"Mon bilan sur les engagements pris...",value:w,onChange:y=>O(y.target.value),onBlur:b,rows:3})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:`successes-${s.id}`,children:"Mes réussites"}),e.jsx(L,{id:`successes-${s.id}`,placeholder:"Ce dont je suis fier/fière cette saison...",value:h,onChange:y=>u(y.target.value),onBlur:b,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:`difficulties-${s.id}`,children:"Mes difficultés"}),e.jsx(L,{id:`difficulties-${s.id}`,placeholder:"Les points que je souhaite améliorer...",value:f,onChange:y=>S(y.target.value),onBlur:b,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Mes objectifs"}),t.length>0&&e.jsx("div",{className:"space-y-1.5",children:t.map(y=>e.jsx(R,{objective:y,performances:i,compact:!0},y.id))}),e.jsx(L,{id:`goals-${s.id}`,placeholder:"Objectifs supplémentaires ou commentaires...",value:D,onChange:y=>q(y.target.value),onBlur:b,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{htmlFor:`commitments-${s.id}`,children:"Mes engagements"}),e.jsx(L,{id:`commitments-${s.id}`,placeholder:"Ce que je m'engage à faire...",value:F,onChange:y=>P(y.target.value),onBlur:b,rows:3})]}),g&&e.jsx("p",{className:"text-xs text-muted-foreground animate-pulse",children:"Sauvegarde..."}),e.jsxs($,{className:"w-full gap-2",onClick:()=>o(s.id),disabled:k,children:[e.jsx(Xe,{className:"h-4 w-4"}),k?"Envoi...":"Envoyer au coach"]})]}),N&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-xl border border-dashed border-blue-300 dark:border-blue-700 bg-blue-50/50 dark:bg-blue-950/20 p-6 text-center space-y-2",children:[e.jsx(H,{className:"h-8 w-8 mx-auto text-blue-500"}),e.jsx("p",{className:"text-sm font-medium",children:"Entretien envoyé au coach"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Votre coach prépare l'entretien. Vous recevrez le compte-rendu complet après l'entretien en présentiel."}),s.submitted_at&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Envoyé le ",W(s.submitted_at.slice(0,10))]})]}),d&&(d.athlete_commitments||d.coach_actions)&&e.jsx(Ne,{prevInterview:d,commitmentReview:s.athlete_commitment_review}),c&&e.jsxs(e.Fragment,{children:[e.jsx(z,{label:"Planification"}),e.jsx(ve,{athleteId:c,interviewDate:s.date})]})]}),(v||l)&&e.jsxs(e.Fragment,{children:[d&&(d.athlete_commitments||d.coach_actions)&&e.jsx(Ne,{prevInterview:d,commitmentReview:s.athlete_commitment_review}),e.jsx(we,{label:"Réussites",athleteText:s.athlete_successes,coachText:s.coach_comment_successes||s.coach_review}),e.jsx(we,{label:"Difficultés",athleteText:s.athlete_difficulties,coachText:s.coach_comment_difficulties}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{label:"Objectifs"}),t.length>0&&e.jsx("div",{className:"space-y-1.5",children:t.map(y=>e.jsx(R,{objective:y,performances:i,compact:!0},y.id))}),e.jsx(ae,{text:s.athlete_goals}),e.jsx(re,{text:s.coach_comment_goals||s.coach_objectives})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx(z,{label:"Planification"}),e.jsx(ve,{athleteId:c,interviewDate:s.date})]}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-3 space-y-2",children:[e.jsx(z,{label:"Engagements & Actions"}),e.jsx(ae,{text:s.athlete_commitments,label:"Mes engagements"}),e.jsx(re,{text:s.coach_actions,label:"Actions du coach"})]}),v&&e.jsxs($,{className:"w-full gap-2",onClick:()=>m(s.id),disabled:M,children:[e.jsx(xe,{className:"h-4 w-4"}),M?"Signature...":"Signer l'entretien"]})]})]})]})}function Ne({prevInterview:s,commitmentReview:t}){const[i,c]=x.useState(!1);return e.jsxs(qe,{open:i,onOpenChange:c,children:[e.jsx(Ee,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Ie,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${i?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements précédents"}),e.jsx(T,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:W(s.date)})]})}),e.jsx(Oe,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[s.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mes engagements"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.athlete_commitments})]}),s.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions du coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.coach_actions})]}),t&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mon bilan"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t})]})]})})]})}function ve({athleteId:s,interviewDate:t}){const{data:i=[]}=_({queryKey:["competitions"],queryFn:()=>j.getCompetitions()}),{data:c=[]}=_({queryKey:["my-competition-ids",s],queryFn:()=>j.getMyCompetitionIds(s)}),p=x.useMemo(()=>{const l=new Set(c);return i.filter(n=>l.has(n.id)&&n.date>=t).sort((n,h)=>n.date.localeCompare(h.date))[0]??null},[i,c,t]),{data:o=[]}=_({queryKey:["training-cycles","athlete",s],queryFn:()=>j.getTrainingCycles({athleteId:s})}),m=x.useMemo(()=>{const l=new Set(c);return i.filter(r=>l.has(r.id)&&r.date>=t).sort((r,n)=>r.date.localeCompare(n.date))},[i,c,t]),g=x.useMemo(()=>{const l=new Map;return o.slice().sort((r,n)=>(r.end_competition_date??"").localeCompare(n.end_competition_date??"")).forEach(r=>{r.end_competition_id&&!l.has(r.end_competition_id)&&l.set(r.end_competition_id,r)}),l},[o]),k=x.useMemo(()=>{const l=new Set;return m.map(r=>g.get(r.id)??null).filter(r=>!r||l.has(r.id)?!1:(l.add(r.id),!0))},[m,g]),M=De({queries:k.map(l=>({queryKey:["training-weeks",l.id],queryFn:()=>j.getTrainingWeeks(l.id),enabled:!!l.id}))}),C=x.useMemo(()=>{const l=new Map;return k.forEach((r,n)=>{l.set(r.id,M[n]?.data??[])}),l},[k,M]),N=x.useMemo(()=>new Date().toISOString().split("T")[0],[]),v=p?ye(N,p.date):null;return p?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(Ke,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsxs("span",{className:"font-medium",children:[m.length," échéance",m.length>1?"s":""," visible",m.length>1?"s":""]}),e.jsxs(T,{variant:"secondary",className:"text-[10px]",children:["prochaine J-",v]})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Vision multi-macrocycles depuis l'entretien, jusqu'aux prochaines compétitions assignées."})]}),e.jsx("div",{className:"space-y-3",children:m.map((l,r)=>{const n=g.get(l.id)??null,h=n?.start_date??n?.start_competition_date??t,u=h>t?h:t,f=n?be(u,l.date):[],S=n?be(h,l.date):[],D=Math.max(S.length-f.length,0),q=ye(N,l.date),F=n?C.get(n.id)??[]:[],P=new Map(F.map(w=>[w.week_start,w]));return e.jsxs("div",{className:"rounded-xl border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border bg-muted/20 px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:l.name}),r===0&&e.jsx(T,{className:"text-[10px] bg-primary/10 text-primary border-primary/20",children:"Prochaine"}),e.jsx(T,{variant:"secondary",className:"text-[10px]",children:W(l.date)}),e.jsxs(T,{variant:"outline",className:"text-[10px]",children:["J-",q]})]}),n?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:n.name}),n.start_competition_name&&e.jsxs("span",{children:["depuis ",n.start_competition_name]}),e.jsxs("span",{children:[S.length," sem."]}),D>0&&e.jsxs("span",{children:[D," déjà écoulée",D>1?"s":""]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Aucun macrocycle créé pour cette échéance."})]}),n?f.length===0?e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"Aucune semaine future à afficher sur ce macrocycle."}):e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1.5",children:f.map((w,O)=>{const d=P.get(w),E=Ns(w),b=ys(w);return e.jsxs("div",{className:`rounded-lg border bg-card px-2.5 py-2 text-xs ${E?"ring-2 ring-primary bg-primary/5":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${E?"bg-primary":d?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",D+O+1]}),e.jsxs("span",{className:"text-muted-foreground/70 whitespace-nowrap",children:[fe(w)," - ",fe(b)]}),d?.week_type&&e.jsx(T,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:$e(d.week_type),color:Pe(d.week_type)},children:d.week_type})]}),d?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:d.notes})]},w)})})}):e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"La compétition reste visible pour garder la projection long terme, même sans planification détaillée."})]},l.id)})})]}):e.jsx("p",{className:"text-xs text-muted-foreground italic text-center py-2",children:"Aucune compétition assignée à venir."})}function we({label:s,athleteText:t,coachText:i}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{label:s}),e.jsx(ae,{text:t}),e.jsx(re,{text:i})]})}function z({label:s}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s}),e.jsx("div",{className:"h-px flex-1 bg-border"})]})}function ae({text:s,label:t}){return e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2.5 space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(We,{className:"h-3 w-3 text-blue-500"}),e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-widest text-muted-foreground",children:t??"Nageur"})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseigné"})})]})}function re({text:s,label:t}){return s?.trim()?e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2.5 space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ye,{className:"h-3 w-3 text-amber-500"}),e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-widest text-muted-foreground",children:t??"Coach"})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s})]}):null}function _e({onBack:s,embedded:t=!1}){const{toast:i}=Me(),c=Te(),[p,o]=x.useState(!1),[m,g]=x.useState(null),[k,M]=x.useState(null),{data:C}=_({queryKey:["auth-user"],queryFn:async()=>{const{data:a}=await He.auth.getUser();return a.user}}),N=C?.id??null,{data:v=[],isLoading:l}=_({queryKey:["athlete-objectives"],queryFn:()=>j.getAthleteObjectives(),enabled:!!N,refetchInterval:3e4}),r=U(a=>a.userId),n=U(a=>a.user),{data:h}=_({queryKey:["my-profile"],queryFn:()=>j.getProfile({displayName:n,userId:r}),enabled:!!r}),u=h?.ffn_iuf??null,f=x.useMemo(()=>{const a=new Date;return a.setDate(a.getDate()-360),a.toISOString().slice(0,10)},[]),{data:S=[]}=_({queryKey:["swimmer-performances-recent",u],queryFn:()=>j.getSwimmerPerformances({iuf:u,fromDate:f}),enabled:!!u}),D=x.useMemo(()=>v.filter(a=>a.created_by!==N),[v,N]),q=x.useMemo(()=>v.filter(a=>a.created_by===N),[v,N]),[F,P]=x.useState("chrono"),[w,O]=x.useState(""),[d,E]=x.useState("25"),[b,B]=x.useState(""),[I,y]=x.useState(""),Le=()=>{P("chrono"),O(""),E("25"),B(""),y("")},J=()=>{g(null),Le(),o(!0)},ie=a=>{g(a);const ze=!!a.event_code,de=!!a.text;P(ze&&de?"both":de?"texte":"chrono"),O(a.event_code??""),E(String(a.pool_length??25)),B(a.target_time_seconds!=null?ts(a.target_time_seconds):""),y(a.text??""),o(!0)},X=()=>c.invalidateQueries({queryKey:["athlete-objectives"]}),ce=V({mutationFn:a=>j.createObjective(a),onSuccess:()=>{i({title:"Objectif créé"}),X(),o(!1)},onError:a=>i({title:"Erreur",description:a.message,variant:"destructive"})}),le=V({mutationFn:a=>j.updateObjective(m.id,a),onSuccess:()=>{i({title:"Objectif mis à jour"}),X(),o(!1)},onError:a=>i({title:"Erreur",description:a.message,variant:"destructive"})}),Re=V({mutationFn:a=>j.deleteObjective(a),onSuccess:()=>{i({title:"Objectif supprimé"}),X(),M(null)},onError:a=>i({title:"Erreur",description:a.message,variant:"destructive"})}),K=F==="chrono"||F==="both",Y=F==="texte"||F==="both",oe=ce.isPending||le.isPending,Ve=()=>{if(K&&!w){i({title:"Épreuve requise",variant:"destructive"});return}if(K&&b&&ue(b)===null){i({title:"Format invalide",description:"Format : m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(Y&&!I.trim()){i({title:"Texte requis",variant:"destructive"});return}if(!N)return;const a={athlete_id:N,event_code:K?w:null,pool_length:K?Number(d):null,target_time_seconds:K&&b?ue(b):null,text:Y?I.trim():null};m?le.mutate(a):ce.mutate(a)};return e.jsxs("div",{className:t?"space-y-3":"space-y-6 pb-24",children:[t?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/70",children:"Objectifs"}),e.jsxs($,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:J,children:[e.jsx(Z,{className:"mr-1 h-3 w-3"}),"Ajouter"]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs($,{variant:"ghost",size:"sm",className:"-ml-2",onClick:s,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:"Mon plan"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Mes objectifs d'entraînement"})]}),e.jsxs($,{variant:"outline",size:"sm",onClick:J,children:[e.jsx(Z,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]})]}),l&&e.jsx("div",{className:"space-y-1.5",children:[1,2].map(a=>e.jsx("div",{className:"rounded-lg border p-2.5 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-3.5 w-36 rounded bg-muted"})},a))}),!l&&v.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-2",children:[e.jsx(Fe,{className:"h-8 w-8 text-muted-foreground/40 mx-auto"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Aucun objectif pour le moment."}),e.jsxs($,{variant:"ghost",size:"sm",className:"text-xs h-7",onClick:J,children:[e.jsx(Z,{className:"mr-1 h-3 w-3"}),"Ajouter"]})]}),D.length>0&&e.jsxs("div",{className:"space-y-2",children:[!t&&e.jsx("h3",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Objectifs du coach"}),t?e.jsx("div",{className:"space-y-1.5",children:D.map(a=>e.jsx(R,{objective:a,performances:S,compact:!0,showCoachBadge:!0},a.id))}):e.jsx(me,{children:D.map(a=>e.jsx(R,{objective:a,performances:S,showCoachBadge:!0},a.id))})]}),q.length>0&&e.jsxs("div",{className:"space-y-2",children:[!t&&e.jsx("h3",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Mes objectifs personnels"}),t?e.jsx("div",{className:"space-y-1.5",children:q.map(a=>e.jsx(R,{objective:a,performances:S,onClick:()=>ie(a),compact:!0},a.id))}):e.jsx(me,{children:q.map(a=>e.jsx(R,{objective:a,performances:S,onClick:()=>ie(a)},a.id))})]}),e.jsx(is,{open:p,onOpenChange:o,children:e.jsxs(cs,{side:"bottom",className:"max-h-[85vh] overflow-y-auto",children:[e.jsxs(ls,{children:[e.jsx(os,{children:m?"Modifier l'objectif":"Nouvel objectif"}),e.jsx(ds,{children:m?"Modifiez votre objectif personnel.":"Ajoutez un objectif personnel."})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Type d'objectif"}),e.jsxs(ns,{type:"single",variant:"outline",value:F,onValueChange:a=>{a&&P(a)},className:"justify-start",children:[e.jsx(se,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(se,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(se,{value:"both",className:"text-xs",children:"Les deux"})]})]}),K&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Épreuve *"}),e.jsxs(pe,{value:w,onValueChange:O,children:[e.jsx(he,{children:e.jsx(ge,{placeholder:"Choisir une épreuve"})}),e.jsx(je,{children:es.map(a=>e.jsx(te,{value:a,children:ss(a)},a))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Bassin"}),e.jsxs(pe,{value:d,onValueChange:E,children:[e.jsx(he,{children:e.jsx(ge,{})}),e.jsxs(je,{children:[e.jsx(te,{value:"25",children:"25m"}),e.jsx(te,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(Qe,{placeholder:"Ex : 1:05:30",value:b,onChange:a=>B(a.target.value)})]})]}),Y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Objectif texte *"}),e.jsx(L,{placeholder:"Ex : Améliorer la coulée de dos",value:I,onChange:a=>y(a.target.value),rows:3})]}),e.jsx($,{className:"w-full",onClick:Ve,disabled:oe,children:oe?"Enregistrement...":m?"Enregistrer":"Créer"})]})]})}),e.jsx(ms,{open:!!k,onOpenChange:a=>{a||M(null)},children:e.jsxs(us,{children:[e.jsxs(xs,{children:[e.jsx(ps,{children:"Supprimer l'objectif"}),e.jsx(hs,{children:"Cette action est irréversible. L'objectif sera supprimé définitivement."})]}),e.jsxs(gs,{children:[e.jsx(js,{children:"Annuler"}),e.jsx(fs,{onClick:()=>{k&&Re.mutate(k.id)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})}function _s(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Ce(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Cs(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Ss(s){const t=new Date;t.setHours(0,0,0,0);const i=new Date(s+"T00:00:00"),c=new Date(s+"T00:00:00");return c.setDate(c.getDate()+6),t>=i&&t<=c}function Se(s,t){const i=[],c=new Date(s+"T00:00:00"),p=new Date(t+"T00:00:00"),o=new Date(c),m=o.getDay(),g=m===0?1:m===1?0:8-m;for(o.setDate(o.getDate()+g);o<=p;)i.push(o.toISOString().split("T")[0]),o.setDate(o.getDate()+7);return i}function ke(s,t){const i=new Date(s+"T00:00:00"),c=new Date(t+"T00:00:00");return Math.round((c.getTime()-i.getTime())/(1e3*60*60*24))}function ks({athleteId:s}){const t=x.useMemo(()=>new Date().toISOString().split("T")[0],[]),[i,c]=x.useState([]),{data:p=[]}=_({queryKey:["competitions"],queryFn:()=>j.getCompetitions()}),{data:o=[]}=_({queryKey:["my-competition-ids",s],queryFn:()=>j.getMyCompetitionIds(s)}),{data:m=[]}=_({queryKey:["training-cycles","athlete",s],queryFn:()=>j.getTrainingCycles({athleteId:s})}),g=x.useMemo(()=>{const r=new Set(o);return p.filter(n=>r.has(n.id)&&n.date>=t).sort((n,h)=>n.date.localeCompare(h.date))},[o,p,t]),k=x.useMemo(()=>{const r=new Map;return m.slice().sort((n,h)=>(n.end_competition_date??"").localeCompare(h.end_competition_date??"")).forEach(n=>{n.end_competition_id&&!r.has(n.end_competition_id)&&r.set(n.end_competition_id,n)}),r},[m]),M=x.useMemo(()=>{const r=new Set;return g.map(n=>k.get(n.id)??null).filter(n=>!n||r.has(n.id)?!1:(r.add(n.id),!0))},[k,g]),C=De({queries:M.map(r=>({queryKey:["training-weeks",r.id],queryFn:()=>j.getTrainingWeeks(r.id),enabled:!!r.id}))}),N=x.useMemo(()=>{const r=new Map;return M.forEach((n,h)=>{r.set(n.id,C[h]?.data??[])}),r},[M,C]),v=g[0]??null,l=r=>{c(n=>n.includes(r)?n.filter(h=>h!==r):[...n,r])};return g.length===0?e.jsxs("div",{className:"rounded-3xl border border-dashed bg-card/70 px-4 py-8 text-center",children:[e.jsx(Be,{className:"mx-auto h-10 w-10 text-muted-foreground/60"}),e.jsx("p",{className:"mt-3 text-sm font-medium",children:"Aucune échéance à venir."}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Ton plan apparaîtra ici."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-3xl border bg-gradient-to-br from-primary/[0.08] via-background to-amber-500/[0.08] p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(bs,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-semibold",children:[g.length," échéance",g.length>1?"s":""]}),v&&e.jsxs(T,{variant:"secondary",className:"text-[10px] px-2 py-0.5",children:["cap J-",ke(t,v.date)]})]}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Vue de tes prochains cycles."})]}),e.jsx("div",{className:"space-y-3",children:g.map((r,n)=>{const h=k.get(r.id)??null,u=h?.start_date??h?.start_competition_date??t,f=u>t?u:t,S=h?Se(f,r.date):[],D=h?Se(u,r.date):[],q=Math.max(D.length-S.length,0),F=h?N.get(h.id)??[]:[],P=new Map(F.map(d=>[d.week_start,d])),w=ke(t,r.date),O=i.includes(r.id);return e.jsx(qe,{open:O,onOpenChange:()=>l(r.id),children:e.jsxs("section",{className:"overflow-hidden rounded-3xl border bg-card shadow-sm",children:[e.jsx(Ee,{asChild:!0,children:e.jsx("button",{type:"button",className:"w-full border-b border-border bg-muted/20 px-4 py-3 text-left transition-colors hover:bg-muted/30",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ie,{className:`mt-0.5 h-4 w-4 shrink-0 text-muted-foreground transition-transform ${O?"rotate-90":""}`}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:r.name}),n===0&&e.jsx(T,{className:"border-primary/20 bg-primary/10 text-[10px] text-primary",children:"Priorité"}),e.jsx(T,{variant:"secondary",className:"text-[10px]",children:_s(r.date)}),e.jsxs(T,{variant:"outline",className:"text-[10px]",children:["J-",w]})]}),h?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:h.name}),e.jsxs("span",{children:[D.length," sem."]}),q>0&&e.jsxs("span",{children:[q," sem. passée",q>1?"s":""]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Pas de cycle détaillé."})]})]})})}),e.jsx(Oe,{children:h?S.length===0?e.jsx("div",{className:"px-4 py-4 text-xs text-muted-foreground italic",children:"Pas de semaine à venir."}):e.jsx("div",{className:"px-4 py-4",children:e.jsx("div",{className:"relative ml-2 space-y-2 border-l-2 border-border pl-4",children:S.map((d,E)=>{const b=P.get(d),B=Ss(d),I=Cs(d);return e.jsxs("div",{className:`rounded-2xl border bg-card px-3 py-2 text-xs ${B?"ring-2 ring-primary/40 bg-primary/[0.04]":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${B?"bg-primary":b?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"whitespace-nowrap text-muted-foreground",children:["Sem. ",q+E+1]}),e.jsxs("span",{className:"whitespace-nowrap text-muted-foreground/70",children:[Ce(d)," - ",Ce(I)]}),b?.week_type&&e.jsx(T,{className:"ml-auto border-0 px-1.5 py-0 text-[10px]",style:{backgroundColor:$e(b.week_type),color:Pe(b.week_type)},children:b.week_type})]}),b?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:b.notes})]},d)})})}):e.jsx("div",{className:"px-4 py-4 text-xs text-muted-foreground italic",children:"L'échéance reste affichée."})})]})},r.id)})})]})}function Ts({athleteId:s,athleteName:t,groupLabel:i,onBack:c,standalone:p,defaultTab:o}){return e.jsxs("div",{className:`mx-auto max-w-4xl pb-24 ${p?"space-y-3":"space-y-4"}`,children:[e.jsxs("div",{className:`rounded-[1.75rem] border bg-gradient-to-br from-primary/[0.12] via-background to-amber-500/[0.08] shadow-sm ${p?"p-3":"p-4"}`,children:[!p&&c&&e.jsxs($,{variant:"ghost",size:"sm",className:"-ml-2 mb-2",onClick:c,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`flex shrink-0 items-center justify-center rounded-2xl bg-primary/12 text-primary ${p?"h-9 w-9":"h-11 w-11"}`,children:e.jsx(Ke,{className:p?"h-4 w-4":"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h1",{className:`font-display font-semibold uppercase italic text-foreground ${p?"text-lg":"text-xl"}`,children:"Mon suivi"}),i&&e.jsx(T,{variant:"secondary",className:"text-[10px]",children:i})]}),!p&&e.jsxs("p",{className:"mt-1 text-sm text-muted-foreground",children:[t,": ton plan d'action, tes entretiens et tes échéances au même endroit."]})]})]})]}),p&&e.jsx(_e,{embedded:!0}),e.jsxs(Ue,{defaultValue:o||(p?"ressentis":"objectifs"),className:p?"space-y-3":"space-y-4",children:[e.jsxs(Je,{className:`grid h-auto w-full gap-2 rounded-2xl bg-transparent p-0 ${p?"grid-cols-3":"grid-cols-2 sm:grid-cols-4"}`,children:[!p&&e.jsxs(G,{value:"objectifs",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Fe,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Plan d'action"}),e.jsx("span",{className:"hidden sm:inline",children:"Plan d'action"})]}),e.jsxs(G,{value:"ressentis",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(H,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Ressentis"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(G,{value:"entretiens",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Ae,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Entretiens"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]}),e.jsxs(G,{value:"planification",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Be,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{children:"Planif."})]})]}),!p&&e.jsx(Q,{value:"objectifs",className:"mt-0",children:e.jsx(_e,{embedded:!0})}),e.jsx(Q,{value:"ressentis",className:"mt-0",children:e.jsx(Ze,{athleteId:s,athleteName:t,showProgressAction:!1})}),e.jsx(Q,{value:"entretiens",className:"mt-0",children:e.jsx(vs,{embedded:!0})}),e.jsx(Q,{value:"planification",className:"mt-0",children:e.jsx(ks,{athleteId:s})})]})]})}function Ds(){return typeof window>"u"?void 0:window.location.hash.match(/[?&]tab=([^&]+)/)?.[1]||void 0}function lt(){const s=U(m=>m.user),t=U(m=>m.userId),{data:i,isLoading:c}=_({queryKey:["profile",s,t],queryFn:()=>j.getProfile({displayName:s,userId:t}),enabled:!!s}),{data:p=[]}=_({queryKey:["profile-groups"],queryFn:()=>j.getGroups(),enabled:!!s}),o=p.find(m=>m.id===i?.group_id)?.name||i?.group_label||null;return c?e.jsxs("div",{className:"mx-auto max-w-4xl space-y-4 p-4",children:[e.jsx(ee,{className:"h-28 rounded-3xl"}),e.jsx(ee,{className:"h-12 rounded-2xl"}),e.jsx(ee,{className:"h-64 rounded-2xl"})]}):e.jsx(Ts,{athleteId:t??0,athleteName:i?.display_name||s||"Nageur",groupLabel:o,standalone:!0,defaultTab:Ds()})}export{lt as default};
