import{c as $,r as x,u as U,d as S,j as e}from"./vendor-query-DyA9aSKS.js";import{a as C}from"./api-DaVd0xqR.js";import{d as z,B as g,P as M,U as se,Y as te,t as re,L as P,I as V}from"./index-DukBoFI0.js";import{B as _}from"./badge-q9Cx6pzV.js";import{C as ae}from"./checkbox-BJfx20kf.js";import{S as ie}from"./separator-8WzO7oss.js";import{S as B,a as O,b as H,c as Y,d as J}from"./sheet-CJcayetJ.js";import{A as k,a as D,b as G,c as T,d as q,e as R,f as E,g as F}from"./alert-dialog-BDb6cgrL.js";import{C as ne,a as oe,b as le}from"./collapsible-Db7VRhne.js";import{C as ce,U as de}from"./Coach-BfKvy4BD.js";import{A}from"./target-BvgPgZtA.js";import{a as me,U as ue}from"./user-plus-B6na-I7N.js";import{C as pe}from"./chevron-down-DRe1EDOM.js";import{P as xe}from"./power-Cgwu6HNx.js";import{T as he}from"./trash-2-2kLHQvr2.js";import"./vendor-react-BzrpNAyj.js";import"./swim-DsbmPiVN.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./index-DCX2sNhR.js";import"./index-C82jO-LZ.js";import"./index-2CTScZXj.js";import"./toggle-group-fRRXrIA-.js";import"./index-BWlK1_Ix.js";import"./index-BAUf6cFa.js";import"./bell-ring-D6XiTrAE.js";import"./clock-q5D54Uxz.js";const W=({athletes:s,selected:u,onToggle:j,filterToUserIds:l})=>{const[c,v]=x.useState(""),h=x.useMemo(()=>{let i=s.filter(n=>n.id!=null);if(l&&(i=i.filter(n=>l.has(n.id))),c.trim()){const n=c.toLowerCase();i=i.filter(o=>o.display_name.toLowerCase().includes(n))}return i},[s,l,c]),d=x.useMemo(()=>{const i=new Map;for(const n of h){const o=n.group_label||"Sans groupe";i.has(o)||i.set(o,[]),i.get(o).push(n)}return[...i.entries()].sort(([n],[o])=>n.localeCompare(o,"fr"))},[h]);return e.jsxs("div",{className:"space-y-3",children:[e.jsx(V,{placeholder:"Rechercher un nageur...",value:c,onChange:i=>v(i.target.value)}),e.jsxs("div",{className:"max-h-[50vh] overflow-y-auto space-y-3",children:[d.map(([i,n])=>e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-1.5",children:i}),e.jsx("div",{className:"space-y-1",children:n.map(o=>e.jsxs("label",{className:"flex items-center gap-2.5 rounded-lg border px-3 py-2 cursor-pointer hover:bg-muted/50 transition-colors",children:[e.jsx(ae,{checked:u.has(o.id),onCheckedChange:()=>j(o.id)}),e.jsx("span",{className:"text-sm",children:o.display_name})]},o.id))})]},i)),d.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun nageur trouvé."})]}),u.size>0&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[u.size," nageur",u.size>1?"s":""," ","sélectionné",u.size>1?"s":""]})]})},X=({open:s,onOpenChange:u,athletes:j,parentGroupId:l,parentMembers:c,onCreated:v})=>{const{toast:h}=z(),[d,i]=x.useState(""),[n,o]=x.useState(new Set),r=m=>{o(y=>{const b=new Set(y);return b.has(m)?b.delete(m):b.add(m),b})},p=S({mutationFn:()=>C.createTemporaryGroup({name:d.trim(),member_user_ids:[...n],parent_group_id:l??void 0}),onSuccess:()=>{h({title:"Groupe créé",description:`Le groupe "${d.trim()}" a été créé avec ${n.size} nageur${n.size>1?"s":""}.`}),i(""),o(new Set),u(!1),v()},onError:m=>{h({title:"Erreur",description:m.message,variant:"destructive"})}}),N=()=>{if(!d.trim()){h({title:"Nom requis",description:"Veuillez saisir un nom pour le groupe.",variant:"destructive"});return}p.mutate()};return e.jsx(B,{open:s,onOpenChange:u,children:e.jsxs(O,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(H,{children:[e.jsx(Y,{children:l?"Créer un sous-groupe":"Créer un groupe"}),e.jsx(J,{children:l?"Sélectionnez des nageurs du groupe parent pour ce sous-groupe.":"Créez un groupe temporaire (stage, compétition) avec des nageurs de différents groupes."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{htmlFor:"group-name",children:"Nom du groupe"}),e.jsx(V,{id:"group-name",placeholder:"Ex : Stage Pâques 2026",value:d,onChange:m=>i(m.target.value)})]}),e.jsx(ie,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(P,{children:"Nageurs"}),e.jsx(W,{athletes:j,selected:n,onToggle:r,filterToUserIds:c??null})]}),e.jsx(g,{className:"w-full",onClick:N,disabled:p.isPending||!d.trim(),children:p.isPending?"Création...":"Créer le groupe"})]})]})})},ge=({open:s,onOpenChange:u,groupId:j,athletes:l,existingMemberIds:c,onAdded:v})=>{const{toast:h}=z(),[d,i]=x.useState(new Set),n=x.useMemo(()=>l.filter(p=>p.id!=null&&!c.has(p.id)),[l,c]),o=p=>{i(N=>{const m=new Set(N);return m.has(p)?m.delete(p):m.add(p),m})},r=S({mutationFn:()=>C.addTemporaryGroupMembers(j,[...d]),onSuccess:()=>{h({title:"Nageurs ajoutés",description:`${d.size} nageur${d.size>1?"s":""} ajouté${d.size>1?"s":""}.`}),i(new Set),u(!1),v()},onError:p=>{h({title:"Erreur",description:p.message,variant:"destructive"})}});return e.jsx(B,{open:s,onOpenChange:u,children:e.jsxs(O,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Ajouter des nageurs"}),e.jsx(J,{children:"Sélectionnez les nageurs à ajouter au groupe."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx(W,{athletes:n,selected:d,onToggle:o}),e.jsx(g,{className:"w-full",onClick:()=>r.mutate(),disabled:r.isPending||d.size===0,children:r.isPending?"Ajout...":`Ajouter ${d.size} nageur${d.size>1?"s":""}`})]})]})})},je=({groupId:s,athletes:u,onBack:j})=>{const{toast:l}=z(),c=$(),[v,h]=x.useState(!1),[d,i]=x.useState(!1),[n,o]=x.useState(null),{data:r,isLoading:p}=U({queryKey:["temp-group-detail",s],queryFn:()=>C.getTemporaryGroupDetail(s)}),N=S({mutationFn:a=>C.removeTemporaryGroupMember(s,a),onSuccess:()=>{l({title:"Nageur retiré"}),c.invalidateQueries({queryKey:["temp-group-detail",s]}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:a=>{l({title:"Erreur",description:a.message,variant:"destructive"})}}),m=()=>{c.invalidateQueries({queryKey:["temp-group-detail",s]}),c.invalidateQueries({queryKey:["temp-groups"]})},y=x.useMemo(()=>new Set((r?.members??[]).map(a=>a.user_id)),[r]),b=x.useMemo(()=>new Set((r?.members??[]).map(a=>a.user_id)),[r]);return p?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(g,{variant:"ghost",size:"sm",className:"-ml-2",onClick:j,children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(a=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted"})},a))})]}):r?e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(g,{variant:"ghost",size:"sm",className:"-ml-2",onClick:j,children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:r.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{variant:r.is_active?"default":"secondary",children:r.is_active?"Actif":"Terminé"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[r.members.length," membre",r.members.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Membres"}),r.is_active&&e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>h(!0),children:[e.jsx(me,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]}),r.members.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun membre dans ce groupe."}):e.jsx("div",{className:"space-y-1.5",children:r.members.map(a=>e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border bg-card p-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:a.display_name}),a.permanent_group_label&&e.jsx(_,{variant:"secondary",className:"text-[10px] px-1.5 py-0 mt-0.5",children:a.permanent_group_label})]}),r.is_active&&e.jsx(g,{size:"icon",variant:"ghost",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:()=>o({userId:a.user_id,name:a.display_name}),title:"Retirer du groupe",children:e.jsx(ue,{className:"h-4 w-4"})})]},a.user_id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Sous-groupes"}),r.is_active&&e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>i(!0),children:[e.jsx(M,{className:"mr-1.5 h-3.5 w-3.5"}),"Sous-groupe"]})]}),r.subgroups.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun sous-groupe."}):e.jsx("div",{className:"space-y-2",children:r.subgroups.map(a=>e.jsxs(ne,{children:[e.jsxs(oe,{className:"flex w-full items-center justify-between rounded-xl border bg-card p-3 text-left hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-semibold",children:a.name}),e.jsx(_,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:a.members.length})]}),e.jsx(pe,{className:"h-4 w-4 text-muted-foreground transition-transform [[data-state=open]_&]:rotate-180"})]}),e.jsx(le,{children:e.jsxs("div",{className:"ml-4 mt-1 space-y-1",children:[a.members.map(w=>e.jsx("div",{className:"flex items-center gap-2 rounded-lg border px-3 py-2",children:e.jsx("span",{className:"text-sm",children:w.display_name})},w.user_id)),a.members.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground py-2",children:"Aucun membre."})]})})]},a.id))})]}),e.jsx(ge,{open:v,onOpenChange:h,groupId:s,athletes:u,existingMemberIds:y,onAdded:m}),e.jsx(X,{open:d,onOpenChange:i,athletes:u,parentGroupId:s,parentMembers:b,onCreated:m}),e.jsx(k,{open:!!n,onOpenChange:a=>{a||o(null)},children:e.jsxs(D,{children:[e.jsxs(G,{children:[e.jsx(T,{children:"Retirer du groupe"}),e.jsxs(q,{children:["Voulez-vous retirer ",n?.name," de ce groupe ?",r.subgroups.length>0?" Le nageur sera aussi retiré des sous-groupes.":""]})]}),e.jsxs(R,{children:[e.jsx(E,{children:"Annuler"}),e.jsx(F,{onClick:()=>{n&&(N.mutate(n.userId),o(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Retirer"})]})]})})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs(g,{variant:"ghost",size:"sm",className:"-ml-2",onClick:j,children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Retour aux groupes"]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Groupe introuvable."})]})},Q=({group:s,onManage:u,onDeactivate:j,onReactivate:l,onDelete:c})=>{const v=new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"});return e.jsxs("div",{className:"rounded-xl border bg-card p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-bold truncate",children:s.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1 flex-wrap",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.member_count," membre",s.member_count!==1?"s":""]}),s.subgroup_count>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.subgroup_count," sous-groupe",s.subgroup_count!==1?"s":""]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:v})]})]}),e.jsx(_,{variant:s.is_active?"default":"secondary",children:s.is_active?"Actif":"Terminé"})]}),e.jsx("div",{className:"flex items-center gap-2 flex-wrap",children:s.is_active?e.jsxs(e.Fragment,{children:[e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>u(s.id),children:[e.jsx(te,{className:"mr-1.5 h-3.5 w-3.5"}),"Gérer"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>j(s.id),children:[e.jsx(xe,{className:"mr-1.5 h-3.5 w-3.5"}),"Terminer"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>l(s.id),children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Réactiver"]}),e.jsxs(g,{size:"sm",variant:"outline",className:"text-destructive hover:text-destructive",onClick:()=>c(s.id),children:[e.jsx(he,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})})]})},Oe=({onBack:s,athletes:u,athletesLoading:j})=>{const{toast:l}=z(),c=$(),[v,h]=x.useState("list"),[d,i]=x.useState(null),[n,o]=x.useState(!1),[r,p]=x.useState(null),[N,m]=x.useState(null),{data:y=[],isLoading:b}=U({queryKey:["temp-groups"],queryFn:()=>C.getTemporaryGroups()}),a=x.useMemo(()=>y.filter(t=>t.is_active),[y]),w=x.useMemo(()=>y.filter(t=>!t.is_active),[y]),Z=S({mutationFn:t=>C.deactivateTemporaryGroup(t),onSuccess:()=>{l({title:"Groupe terminé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:t=>{l({title:"Erreur",description:t.message,variant:"destructive"})}}),L=S({mutationFn:t=>C.reactivateTemporaryGroup(t),onSuccess:()=>{l({title:"Groupe réactivé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:t=>{l({title:"Erreur",description:t.message,variant:"destructive"})}}),I=S({mutationFn:t=>C.deleteTemporaryGroup(t),onSuccess:()=>{l({title:"Groupe supprimé"}),c.invalidateQueries({queryKey:["temp-groups"]})},onError:t=>{l({title:"Erreur",description:t.message,variant:"destructive"})}}),K=t=>{i(t),h("detail")},ee=()=>{i(null),h("list"),c.invalidateQueries({queryKey:["temp-groups"]})};return v==="detail"&&d!=null?e.jsx(je,{groupId:d,athletes:u,onBack:ee}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(ce,{title:"Groupes temporaires",description:"Créez et gérez des groupes pour les stages, compétitions ou événements.",onBack:s,actions:e.jsxs(g,{size:"sm",onClick:()=>o(!0),children:[e.jsx(M,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un groupe"]})}),b||j?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-6 w-16 rounded bg-muted"})]})},t))}):y.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(se,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun groupe temporaire pour le moment."}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>o(!0),children:[e.jsx(M,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer le premier groupe"]})]}):e.jsxs(e.Fragment,{children:[a.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Actifs (",a.length,")"]}),a.map(t=>e.jsx(Q,{group:t,onManage:K,onDeactivate:f=>p(f),onReactivate:f=>L.mutate(f),onDelete:f=>m(f)},t.id))]}),w.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:["Terminés (",w.length,")"]}),w.map(t=>e.jsx(Q,{group:t,onManage:K,onDeactivate:f=>p(f),onReactivate:f=>L.mutate(f),onDelete:f=>m(f)},t.id))]})]}),e.jsx(X,{open:n,onOpenChange:o,athletes:u,onCreated:()=>{c.invalidateQueries({queryKey:["temp-groups"]})}}),e.jsx(k,{open:r!=null,onOpenChange:t=>{t||p(null)},children:e.jsxs(D,{children:[e.jsxs(G,{children:[e.jsx(T,{children:"Terminer le groupe"}),e.jsx(q,{children:"Voulez-vous marquer ce groupe comme terminé ? Les sous-groupes seront aussi désactivés. Vous pourrez le réactiver plus tard si nécessaire."})]}),e.jsxs(R,{children:[e.jsx(E,{children:"Annuler"}),e.jsx(F,{onClick:()=>{r!=null&&(Z.mutate(r),p(null))},children:"Terminer"})]})]})}),e.jsx(k,{open:N!=null,onOpenChange:t=>{t||m(null)},children:e.jsxs(D,{children:[e.jsxs(G,{children:[e.jsx(T,{children:"Supprimer le groupe"}),e.jsx(q,{children:"Cette action est irréversible. Le groupe et tous ses sous-groupes seront supprimés définitivement."})]}),e.jsxs(R,{children:[e.jsx(E,{children:"Annuler"}),e.jsx(F,{onClick:()=>{N!=null&&(I.mutate(N),m(null))},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};export{Oe as default};
