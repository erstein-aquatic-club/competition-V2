import{r as d,u as q,j as e,c as ye,d as z,f as hs}from"./vendor-query-Dcze6zAc.js";import{B as M,d as be,L as U,I as Ee,s as Je,X as gs,a5 as fs,T as js,a9 as ys,b as bs,u as Ns}from"./index-HVj7Sga3.js";import{a as p}from"./api-BSxRcekn.js";import{T as vs,a as _s,b as Ce,c as we}from"./tabs-DPb8O9Re.js";import{B as W}from"./badge-BKqy0wYJ.js";import{C as Xe,w as Ye,a as Ze,S as Ie,G as es,b as Cs}from"./SwimmerFeedbackTab-B1oqdRT6.js";import{T as Ke}from"./textarea-BY30vITl.js";import{S as se,a as te,b as ae,c as ne,d as J}from"./select-DusLvjgc.js";import{T as ws,a as Fe}from"./toggle-group-CUDRIbn3.js";import{S as ss,a as ts,b as as,c as ns}from"./sheet-CFv-akYv.js";import{A as de,a as ue,b as me,c as xe,d as pe,e as he,f as ge,g as fe}from"./alert-dialog-Du5Zx0Tf.js";import{T as qe,s as rs,a as is,c as ls,d as Ss,S as cs,e as Le,f as je,b as ks,F as Ts,p as Qe,M as os,A as Ds}from"./objectiveHelpers-AtJV9vOE.js";import{P as ie}from"./plus-KRO_fjWF.js";import{T as $e}from"./trash-2-CD8NfPMn.js";import{t as Pe}from"./date-NdbyDBh_.js";import{C as Es}from"./copy-CizSIklW.js";import{C as qs}from"./index-Cokk-ZbJ.js";import{P as Fs}from"./pencil-BQ0yRazU.js";import{C as As,a as Ps,b as Ms}from"./collapsible-DvAHAqMP.js";import{C as Os}from"./chevron-up-CEKBePU7.js";import{C as Ks}from"./chevron-down-CVoiiV_C.js";import{C as ds}from"./clock-DJUPw4Fo.js";import{C as Ls}from"./chevron-right-rT7kR3Iv.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./swim-DntigO34.js";import"./index-B1G9ca0o.js";import"./index-MOM2i9PG.js";import"./chart-column-CJ1tv4Sd.js";import"./index-ByeJ4xqm.js";import"./format-B9mPVj_w.js";async function $s(s){const{data:t,error:a}=await Je.rpc("get_auth_uid_for_user",{p_user_id:s});return a?(console.error("[objectives-tab] Failed to resolve auth UUID:",a.message),null):t}const Ws=({open:s,onOpenChange:t,objective:a,athleteName:i,athleteAuthId:o,competitions:l})=>{const{toast:r}=be(),u=ye(),N=!!a,[j,_]=d.useState("chrono"),[b,f]=d.useState(""),[v,w]=d.useState("25"),[F,T]=d.useState(""),[k,O]=d.useState(""),[y,I]=d.useState(""),[K,L]=d.useState(!1);d.useEffect(()=>{if(s)if(a){const c=!!a.event_code,D=!!a.text;_(c&&D?"both":D?"texte":"chrono"),f(a.event_code??""),w(String(a.pool_length??25)),T(a.target_time_seconds!=null?je(a.target_time_seconds):""),O(a.text??""),I(a.competition_id??"")}else _("chrono"),f(""),w("25"),T(""),O(""),I("")},[s,a]);const m=z({mutationFn:c=>p.createObjective(c),onSuccess:()=>{r({title:"Objectif crÃ©Ã©"}),u.invalidateQueries({queryKey:["objectives",o]}),t(!1)},onError:c=>{r({title:"Erreur",description:c.message,variant:"destructive"})}}),x=z({mutationFn:c=>p.updateObjective(a.id,c),onSuccess:()=>{r({title:"Objectif mis Ã  jour"}),u.invalidateQueries({queryKey:["objectives",o]}),t(!1)},onError:c=>{r({title:"Erreur",description:c.message,variant:"destructive"})}}),h=z({mutationFn:()=>p.deleteObjective(a.id),onSuccess:()=>{r({title:"Objectif supprimÃ©"}),u.invalidateQueries({queryKey:["objectives",o]}),t(!1)},onError:c=>{r({title:"Erreur",description:c.message,variant:"destructive"})}}),A=j==="chrono"||j==="both",$=j==="texte"||j==="both",R=()=>{if(A&&!b){r({title:"Ã‰preuve requise",description:"Veuillez sÃ©lectionner une Ã©preuve.",variant:"destructive"});return}if(A&&F&&Qe(F)===null){r({title:"Format invalide",description:"Le temps doit Ãªtre au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if($&&!k.trim()){r({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const c={athlete_id:o,competition_id:y&&y!=="none"?y:null,event_code:A?b:null,pool_length:A?Number(v):null,target_time_seconds:A&&F?Qe(F):null,text:$?k.trim():null};N?x.mutate(c):m.mutate(c)},P=m.isPending||x.isPending||h.isPending,g=d.useMemo(()=>{const c=new Date;return c.setHours(0,0,0,0),l.filter(D=>new Date(D.date+"T00:00:00").getTime()>=c.getTime())},[l]);return e.jsxs(e.Fragment,{children:[e.jsx(ss,{open:s,onOpenChange:t,children:e.jsxs(ts,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(as,{children:e.jsx(ns,{children:N?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:i})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Type d'objectif"}),e.jsxs(ws,{type:"single",variant:"outline",value:j,onValueChange:c=>{c&&_(c)},className:"justify-start",children:[e.jsx(Fe,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(Fe,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(Fe,{value:"both",className:"text-xs",children:"Les deux"})]})]}),A&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Ã‰preuve *"}),e.jsxs(se,{value:b,onValueChange:f,children:[e.jsx(te,{children:e.jsx(ae,{placeholder:"Choisir une Ã©preuve"})}),e.jsx(ne,{children:Ts.map(c=>e.jsx(J,{value:c,children:Le(c)},c))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Bassin"}),e.jsxs(se,{value:v,onValueChange:w,children:[e.jsx(te,{children:e.jsx(ae,{})}),e.jsxs(ne,{children:[e.jsx(J,{value:"25",children:"25m"}),e.jsx(J,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Temps cible (min:sec:centiÃ¨mes)"}),e.jsx(Ee,{placeholder:"Ex : 1:05:30",value:F,onChange:c=>T(c.target.value)})]})]}),$&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Objectif texte *"}),e.jsx(Ke,{placeholder:"Ex : AmÃ©liorer la coulÃ©e de dos",value:k,onChange:c=>O(c.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Lier Ã  une compÃ©tition"}),e.jsxs(se,{value:y,onValueChange:I,children:[e.jsx(te,{children:e.jsx(ae,{placeholder:"Aucune"})}),e.jsxs(ne,{children:[e.jsx(J,{value:"none",children:"Aucune"}),g.map(c=>e.jsxs(J,{value:c.id,children:[c.name," (",c.date,")"]},c.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(M,{className:"w-full",onClick:R,disabled:P,children:P?"Enregistrement...":N?"Enregistrer":"CrÃ©er"}),N&&e.jsx(M,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>L(!0),disabled:P,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(de,{open:K,onOpenChange:L,children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Supprimer l'objectif"}),e.jsx(pe,{children:"Cette action est irrÃ©versible. L'objectif sera supprimÃ© dÃ©finitivement."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>{h.mutate(),L(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function Rs(s){const t=s.split("-");return t.length===3?`${t[2]}/${t[1]}/${t[0]}`:s}const zs=({objective:s,performances:t,onEdit:a})=>{const i=s.event_code?rs(s.event_code):null,o=i?cs[i]??"":"",l=s.event_code?is(t,s.event_code,s.pool_length):null;let r=null,u=null;l&&s.target_time_seconds!=null&&s.event_code&&(r=l.time-s.target_time_seconds,u=ls(l.time,s.target_time_seconds,s.event_code));const N=!!s.competition_name,j=s.competition_date?Ss(s.competition_date):null;return e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card p-3 text-sm space-y-1.5 transition-colors hover:bg-muted/50 ${o?`border-l-4 ${o}`:""}`,onClick:()=>a(s),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(qe,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-center gap-1.5 flex-wrap",children:[s.event_code&&e.jsx("span",{className:"font-medium",children:Le(s.event_code)}),s.event_code&&s.pool_length&&e.jsxs("span",{className:"text-muted-foreground",children:["(",s.pool_length,"m)"]}),s.target_time_seconds!=null&&e.jsx("span",{className:"font-mono text-xs text-primary",children:je(s.target_time_seconds)})]}),e.jsx($e,{className:"h-3.5 w-3.5 text-muted-foreground/40 shrink-0"})]}),s.text&&e.jsx("p",{className:"text-muted-foreground text-xs pl-5 line-clamp-2",children:s.text}),s.event_code&&l&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:je(l.time)})]}),l.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",Rs(l.date),")"]}),r!=null&&e.jsx("span",{className:r<=0?"text-emerald-600 font-medium":"text-amber-600",children:r<=0?"Objectif atteint !":`+${r.toFixed(2)}s`})]}),s.event_code&&!l&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"}),u!=null&&e.jsx("div",{className:"pl-5 pr-1",children:e.jsx("div",{className:"h-1.5 w-full rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${ks(u)}`,style:{width:`${Math.min(u,100)}%`}})})}),N&&e.jsx("div",{className:"pl-5",children:e.jsxs(W,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:[s.competition_name,j!=null&&j>0&&e.jsxs("span",{className:"ml-1 font-bold",children:["J-",j]})]})})]})},Is=({athleteId:s,athleteName:t})=>{const[a,i]=d.useState(!1),[o,l]=d.useState(null),{data:r,isLoading:u}=q({queryKey:["auth-uid",s],queryFn:()=>$s(s),enabled:!!s}),{data:N=[]}=q({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),{data:j=[],isLoading:_}=q({queryKey:["objectives",r],queryFn:()=>p.getObjectives(r),enabled:!!r}),{data:b}=q({queryKey:["profile",s],queryFn:()=>p.getProfile({userId:s}),enabled:!!s}),f=b?.ffn_iuf??null,v=d.useMemo(()=>{const y=new Date;return y.setDate(y.getDate()-360),y.toISOString().slice(0,10)},[]),{data:w=[]}=q({queryKey:["swimmer-performances-recent",f],queryFn:()=>p.getSwimmerPerformances({iuf:f,fromDate:v}),enabled:!!f}),F=()=>{l(null),i(!0)},T=y=>{l(y),i(!0)},k=u,O=!!r&&!u;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(M,{variant:"outline",size:"sm",onClick:F,disabled:!r,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter un objectif"]})}),k&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},y))}),O&&_&&e.jsx("div",{className:"space-y-2",children:[1,2].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},y))}),O&&!_&&j.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(qe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif dÃ©fini pour ",t,"."]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:F,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),"CrÃ©er le premier objectif"]})]}),O&&!_&&j.length>0&&e.jsxs("div",{className:"space-y-2",children:[j.map(y=>e.jsx(zs,{objective:y,performances:w,onEdit:T},y.id)),e.jsx("p",{className:"text-[10px] text-muted-foreground/60 italic text-center pt-1",children:"Les temps Â« Actuel Â» correspondent Ã  la meilleure performance des 360 derniers jours sur l'Ã©preuve."})]}),r&&e.jsx(Ws,{open:a,onOpenChange:i,objective:o,athleteName:t,athleteAuthId:r,competitions:N})]})},Me="__today__";function Oe(s,t){const a=[],i=new Date(s+"T00:00:00"),o=new Date(t+"T00:00:00"),l=new Date(i),r=l.getDay(),u=r===0?1:r===1?0:8-r;for(l.setDate(l.getDate()+u);l<=o;)a.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return a}function oe(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Se(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Qs(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Us(s){const t=new Date;t.setHours(0,0,0,0);const a=new Date(s+"T00:00:00"),i=new Date(s+"T00:00:00");return i.setDate(i.getDate()+6),t>=a&&t<=i}const Bs=({athleteId:s})=>{const{toast:t}=be(),a=ye(),[i,o]=d.useState(null),[l,r]=d.useState(null),[u,N]=d.useState(""),[j,_]=d.useState(""),[b,f]=d.useState(!1),[v,w]=d.useState(!1),[F,T]=d.useState(!1),[k,O]=d.useState(""),[y,I]=d.useState(""),[K,L]=d.useState(""),{data:m=[]}=q({queryKey:["athletes"],queryFn:()=>p.getAthletes()}),x=d.useMemo(()=>m.find(S=>S.id===s)?.group_id??null,[m,s]),{data:h=[],isLoading:A}=q({queryKey:["training-cycles","athlete",s],queryFn:()=>p.getTrainingCycles({athleteId:s})}),{data:$=[],isLoading:R}=q({queryKey:["training-cycles","group",x],queryFn:()=>p.getTrainingCycles({groupId:x}),enabled:x!=null}),P=h.length===0&&$.length>0,g=h.length>0?h:$;d.useEffect(()=>{g.length>0&&(!i||!g.find(n=>n.id===i))&&o(g[0].id)},[g,i]);const c=g.find(n=>n.id===i)??null,{data:D=[],isLoading:C}=q({queryKey:["training-weeks",i],queryFn:()=>p.getTrainingWeeks(i),enabled:!!i}),{data:E=[]}=q({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),le=d.useMemo(()=>[...E].sort((n,S)=>n.date.localeCompare(S.date)),[E]),B=d.useMemo(()=>{const n=new Set;return D.forEach(S=>{S.week_type&&n.add(S.week_type)}),Array.from(n).sort()},[D]),X=c?.start_competition_date??c?.start_date??null,Ne=d.useMemo(()=>{if(!c)return[];const n=X,S=c.end_competition_date;return!n||!S?[]:Oe(n,S)},[c,X]),ve=d.useMemo(()=>{const n=new Map;return D.forEach(S=>n.set(S.week_start,S)),n},[D]),_e=A||R,Z=z({mutationFn:async n=>{const S=await p.createTrainingCycle(n),Q=n.start_date??E.find(G=>G.id===n.start_competition_id)?.date,V=E.find(G=>G.id===n.end_competition_id);if(Q&&V){const G=Oe(Q,V.date);G.length>0&&await p.bulkUpsertTrainingWeeks(G.map(ce=>({cycle_id:S.id,week_start:ce})))}return S},onSuccess:n=>{t({title:"Cycle cree"}),o(n.id),f(!1),O(""),I(""),L(""),a.invalidateQueries({queryKey:["training-cycles"]}),a.invalidateQueries({queryKey:["training-weeks",n.id]})},onError:n=>{t({title:"Erreur",description:n.message,variant:"destructive"})}}),ee=z({mutationFn:n=>p.deleteTrainingCycle(n),onSuccess:()=>{t({title:"Cycle supprime"}),o(null),w(!1),a.invalidateQueries({queryKey:["training-cycles"]})},onError:n=>{t({title:"Erreur",description:n.message,variant:"destructive"})}}),We=z({mutationFn:n=>p.upsertTrainingWeek(n),onSuccess:()=>{r(null),a.invalidateQueries({queryKey:["training-weeks",i]})},onError:n=>{t({title:"Erreur",description:n.message,variant:"destructive"})}}),Re=z({mutationFn:async()=>{for(const n of $){const S=await p.createTrainingCycle({athlete_id:s,group_id:null,start_competition_id:n.start_competition_id,end_competition_id:n.end_competition_id,name:n.name,notes:n.notes}),Q=await p.getTrainingWeeks(n.id);Q.length>0&&await p.bulkUpsertTrainingWeeks(Q.map(V=>({cycle_id:S.id,week_start:V.week_start,week_type:V.week_type,notes:V.notes})))}},onSuccess:()=>{t({title:"Planification personnalisee"}),T(!1),o(null),a.invalidateQueries({queryKey:["training-cycles"]})},onError:n=>{t({title:"Erreur",description:n.message,variant:"destructive"})}}),ze=()=>{if(!k.trim()){t({title:"Nom requis",variant:"destructive"});return}if(!y||!K){t({title:"Dates requises",description:"Choisis un debut et une fin.",variant:"destructive"});return}const n=y===Me,S=n?Pe(new Date):null,Q=n?null:E.find(ce=>ce.id===y),V=E.find(ce=>ce.id===K),G=n?S:Q?.date;if(G&&V&&V.date<=G){t({title:"Dates invalides",description:"La fin doit etre apres le debut.",variant:"destructive"});return}Z.mutate({athlete_id:s,group_id:null,start_competition_id:n?null:y,end_competition_id:K,start_date:S,name:k.trim()})},us=n=>{r(n.id),N(n.week_type??""),_(n.notes??"")},ms=n=>{r(`new:${n}`),N(""),_("")},xs=(n,S)=>{i&&We.mutate({cycle_id:i,week_start:n,week_type:u.trim()||null,notes:j.trim()||null})},ps=()=>{r(null)};return!_e&&g.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Xe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun cycle pour ce nageur."}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>f(!0),children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau cycle"]}),e.jsx(Ue,{open:b,onOpenChange:f,competitions:le,name:k,setName:O,startId:y,setStartId:I,endId:K,setEndId:L,onSubmit:ze,isPending:Z.isPending})]}):_e?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(n=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-48 rounded bg-muted"})},n))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[g.length>1?e.jsxs(se,{value:i??"",onValueChange:o,children:[e.jsx(te,{className:"w-auto min-w-[180px] h-8 text-sm",children:e.jsx(ae,{placeholder:"Choisir un cycle"})}),e.jsx(ne,{children:g.map(n=>e.jsx(J,{value:n.id,children:n.name},n.id))})]}):c?e.jsx("span",{className:"text-sm font-semibold",children:c.name}):null,P&&e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Planif. groupe"}),e.jsx("div",{className:"flex-1"}),P&&e.jsxs(M,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>T(!0),children:[e.jsx(Es,{className:"mr-1 h-3 w-3"}),"Personnaliser"]}),e.jsxs(M,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>f(!0),children:[e.jsx(ie,{className:"mr-1 h-3 w-3"}),"Nouveau"]}),c&&!P&&e.jsx(M,{variant:"ghost",size:"sm",className:"text-xs h-7 text-destructive hover:text-destructive",onClick:()=>w(!0),children:e.jsx($e,{className:"h-3 w-3"})})]}),c&&e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:c.start_competition_id?"ðŸŠ":"ðŸ“…"}),e.jsx("span",{className:"text-sm font-medium",children:c.start_competition_id?c.start_competition_name??"Competition":"Debut du cycle"}),X&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",oe(X),")"]})]}),e.jsx("div",{className:"relative ml-3 border-l-2 border-border pl-4 space-y-1",children:C?e.jsx("div",{className:"py-4",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"})}):Ne.map((n,S)=>{const Q=ve.get(n),V=Us(n),G=l===(Q?.id??`new:${n}`);return e.jsx(Vs,{monday:n,weekNumber:S+1,week:Q,isCurrent:V,isEditing:G,isGroupPlan:P,editWeekType:u,setEditWeekType:N,editWeekNotes:j,setEditWeekNotes:_,existingWeekTypes:B,onStartEdit:()=>Q?us(Q):ms(n),onSave:()=>xs(n),onCancel:ps,isSaving:We.isPending},n)})}),e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:"ðŸŽ¯"}),e.jsx("span",{className:"text-sm font-medium",children:c.end_competition_name??"Competition"}),c.end_competition_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",oe(c.end_competition_date),")"]})]})]}),e.jsx(Ue,{open:b,onOpenChange:f,competitions:le,name:k,setName:O,startId:y,setStartId:I,endId:K,setEndId:L,onSubmit:ze,isPending:Z.isPending}),e.jsx(de,{open:v,onOpenChange:w,children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Supprimer le cycle"}),e.jsx(pe,{children:"Le cycle et ses semaines seront supprimes."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>i&&ee.mutate(i),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(de,{open:F,onOpenChange:T,children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Personnaliser la planification"}),e.jsx(pe,{children:"Copie le plan du groupe pour ce nageur. Tu pourras ensuite l'ajuster."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>Re.mutate(),children:Re.isPending?"Copie...":"Personnaliser"})]})]})})]})},Vs=({monday:s,weekNumber:t,week:a,isCurrent:i,isEditing:o,isGroupPlan:l,editWeekType:r,setEditWeekType:u,editWeekNotes:N,setEditWeekNotes:j,existingWeekTypes:_,onStartEdit:b,onSave:f,onCancel:v,isSaving:w})=>{const F=Qs(s),T=`week-types-${s}`;return o?e.jsxs("div",{className:`rounded-lg border bg-card p-3 space-y-2 ${i?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground",children:["Sem. ",t," (",Se(s)," - ",Se(F),")"]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(U,{className:"text-xs",children:"Type de semaine"}),e.jsx(Ee,{className:"h-7 text-sm",placeholder:"Ex : Foncier, Affutage",list:T,value:r,onChange:k=>u(k.target.value)}),e.jsx("datalist",{id:T,children:_.map(k=>e.jsx("option",{value:k},k))})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(U,{className:"text-xs",children:"Notes"}),e.jsx(Ke,{className:"text-sm min-h-[48px]",placeholder:"Note optionnelle",rows:2,value:N,onChange:k=>j(k.target.value)})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(M,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:v,children:[e.jsx(gs,{className:"mr-1 h-3 w-3"}),"Annuler"]}),e.jsxs(M,{size:"sm",className:"h-7 text-xs",onClick:f,disabled:w,children:[e.jsx(qs,{className:"mr-1 h-3 w-3"}),w?"...":"Enregistrer"]})]})]}):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-3 py-2 flex items-center gap-2 transition-colors ${l?"cursor-default":"hover:bg-muted/50"} ${i?"ring-2 ring-primary":""}`,onClick:l?void 0:b,disabled:l,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-xs font-medium text-muted-foreground whitespace-nowrap",children:["Sem. ",t]}),e.jsxs("span",{className:"text-[10px] text-muted-foreground/70 whitespace-nowrap",children:["(",Se(s)," - ",Se(F),")"]}),a?.week_type&&e.jsx(W,{className:"text-[10px] px-1.5 py-0 border-0",style:{backgroundColor:Ze(a.week_type),color:Ye(a.week_type)},children:a.week_type})]}),a?.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:a.notes})]}),!l&&e.jsx(Fs,{className:"h-3 w-3 text-muted-foreground/40 shrink-0"})]})},Ue=({open:s,onOpenChange:t,competitions:a,name:i,setName:o,startId:l,setStartId:r,endId:u,setEndId:N,onSubmit:j,isPending:_})=>(d.useEffect(()=>{s&&(o(""),r(""),N(""))},[s]),e.jsx(ss,{open:s,onOpenChange:t,children:e.jsxs(ts,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(as,{children:e.jsx(ns,{children:"Nouveau cycle"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Nom du cycle *"}),e.jsx(Ee,{placeholder:"Ex : Preparation hiver",value:i,onChange:b=>o(b.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Date de debut *"}),e.jsxs(se,{value:l,onValueChange:r,children:[e.jsx(te,{children:e.jsx(ae,{placeholder:"Choisir..."})}),e.jsxs(ne,{children:[e.jsxs(J,{value:Me,children:["Aujourd'hui (",oe(Pe(new Date)),")"]}),a.map(b=>e.jsxs(J,{value:b.id,children:[b.name," (",oe(b.date),")"]},b.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(U,{children:"Competition de fin *"}),e.jsxs(se,{value:u,onValueChange:N,children:[e.jsx(te,{children:e.jsx(ae,{placeholder:"Choisir..."})}),e.jsx(ne,{children:a.map(b=>e.jsxs(J,{value:b.id,children:[b.name," (",oe(b.date),")"]},b.id))})]})]}),l&&u&&(()=>{const f=l===Me?Pe(new Date):a.find(w=>w.id===l)?.date,v=a.find(w=>w.id===u);if(f&&v&&v.date>f){const w=Oe(f,v.date).length;return e.jsxs("p",{className:"text-xs text-muted-foreground",children:[w," semaine",w>1?"s":""," seront generees."]})}return null})(),e.jsx(M,{className:"w-full",onClick:j,disabled:_,children:_?"Creation...":"Creer le cycle"})]})]})}));function re(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function ke(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Gs(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Hs(s){const t=new Date;t.setHours(0,0,0,0);const a=new Date(s+"T00:00:00"),i=new Date(s+"T00:00:00");return i.setDate(i.getDate()+6),t>=a&&t<=i}function Ae(s,t){const a=[],i=new Date(s+"T00:00:00"),o=new Date(t+"T00:00:00"),l=new Date(i),r=l.getDay(),u=r===0?1:r===1?0:8-r;for(l.setDate(l.getDate()+u);l<=o;)a.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return a}function Be(s,t){const a=new Date(s+"T00:00:00"),i=new Date(t+"T00:00:00");return Math.round((i.getTime()-a.getTime())/(1e3*60*60*24))}const Js={draft_athlete:{label:"En attente nageur",variant:"secondary",className:"bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300 border-amber-200 dark:border-amber-800"},draft_coach:{label:"PrÃ©paration coach",variant:"secondary",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800"},sent:{label:"EnvoyÃ©",variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300 border-green-200 dark:border-green-800"},signed:{label:"SignÃ©",variant:"secondary",className:"bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-300 border-slate-200 dark:border-slate-700"}};function Xs(s){const t=Js[s];return e.jsx(W,{variant:t.variant,className:`text-[10px] px-1.5 py-0 ${t.className}`,children:t.label})}async function Ys(s){const{data:t,error:a}=await Je.rpc("get_auth_uid_for_user",{p_user_id:s});return a?(console.error("[interviews-tab] Failed to resolve auth UUID:",a.message),null):t}const Y=({label:s,text:t})=>e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(fs,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),Te=({label:s,text:t})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(es,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),De=({label:s,value:t,onChange:a,onBlur:i,placeholder:o,rows:l=3})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(es,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s})]}),e.jsx(Ke,{className:"bg-white dark:bg-background",placeholder:o,value:t,onChange:r=>a(r.target.value),onBlur:i,rows:l})]}),H=({label:s})=>e.jsxs("div",{className:"flex items-center gap-2 pt-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),Ve=({objective:s,performances:t=[]})=>{const a=!!s.event_code,i=!!s.text,o=a?rs(s.event_code):null,l=o?cs[o]??"":"",r=a?is(t,s.event_code,s.pool_length):null;let u=null;return r&&s.target_time_seconds!=null&&s.event_code&&(u=r.time-s.target_time_seconds,ls(r.time,s.target_time_seconds,s.event_code)),e.jsxs("div",{className:`rounded-lg border bg-card p-2.5 text-sm space-y-1 ${a?`border-l-4 ${l}`:""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(qe,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:a?Le(s.event_code):""}),s.pool_length&&e.jsxs(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[s.pool_length,"m"]}),s.target_time_seconds!=null&&e.jsx(W,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:je(s.target_time_seconds)})]}),i&&e.jsx("p",{className:"text-muted-foreground line-clamp-2 pl-5",children:s.text}),r&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:je(r.time)})]}),r.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",re(r.date),")"]}),u!=null&&e.jsx("span",{className:u<=0?"text-emerald-600 font-medium":"text-amber-600",children:u<=0?"Objectif atteint !":`+${u.toFixed(2)}s`})]}),!r&&a&&s.target_time_seconds!=null&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"})]})},Ge=({prevInterview:s,commitmentReview:t})=>{const[a,i]=d.useState(!1);return e.jsxs(As,{open:a,onOpenChange:i,children:[e.jsx(Ps,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Ls,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${a?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements prÃ©cÃ©dents"}),e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:re(s.date)})]})}),e.jsx(Ms,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[s.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Engagements nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.athlete_commitments})]}),s.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.coach_actions})]}),t&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Bilan du nageur"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t})]})]})})]})},He=({athleteId:s,interviewDate:t})=>{const{toast:a}=be(),i=ye(),{data:o=[]}=q({queryKey:["competitions"],queryFn:()=>p.getCompetitions()}),{data:l=[]}=q({queryKey:["my-competition-ids",s],queryFn:()=>p.getMyCompetitionIds(s)}),r=d.useMemo(()=>{const m=new Set(l);return o.filter(x=>m.has(x.id)).sort((x,h)=>x.date.localeCompare(h.date))},[o,l]),u=d.useMemo(()=>r.filter(m=>m.date>=t),[r,t]),{data:N=[]}=q({queryKey:["training-cycles","athlete",s],queryFn:()=>p.getTrainingCycles({athleteId:s})}),j=d.useMemo(()=>{const m=new Map;return N.slice().sort((x,h)=>(x.end_competition_date??"").localeCompare(h.end_competition_date??"")).forEach(x=>{x.end_competition_id&&!m.has(x.end_competition_id)&&m.set(x.end_competition_id,x)}),m},[N]),_=d.useMemo(()=>{const m=new Set;return u.map(x=>j.get(x.id)??null).filter(x=>!x||m.has(x.id)?!1:(m.add(x.id),!0))},[u,j]),b=hs({queries:_.map(m=>({queryKey:["training-weeks",m.id],queryFn:()=>p.getTrainingWeeks(m.id),enabled:!!m.id}))}),[f,v]=d.useState(null),[w,F]=d.useState(""),T=d.useMemo(()=>{const m=new Map;return _.forEach((x,h)=>{m.set(x.id,b[h]?.data??[])}),m},[_,b]),k=d.useMemo(()=>{const m=new Set;return T.forEach(x=>{x.forEach(h=>{h.week_type&&m.add(h.week_type)})}),Array.from(m).sort()},[T]),O=u[0]??null,y=d.useMemo(()=>new Date().toISOString().split("T")[0],[]),I=O?Be(y,O.date):null,K=z({mutationFn:async m=>{const x=r.find(g=>g.id===m);if(!x)throw new Error("Pas de compÃ©tition");const h=r.findIndex(g=>g.id===m),A=h>0?r[h-1]:null,$=A?.date??t,R=await p.createTrainingCycle({athlete_id:s,group_id:null,start_competition_id:A?.id??null,start_date:A?null:t,end_competition_id:x.id,name:`PrÃ©paration ${x.name}`}),P=Ae($,x.date);return P.length>0&&await p.bulkUpsertTrainingWeeks(P.map(g=>({cycle_id:R.id,week_start:g}))),R},onSuccess:()=>{a({title:"Planification crÃ©Ã©e"}),i.invalidateQueries({queryKey:["training-cycles"]}),i.invalidateQueries({queryKey:["training-weeks"]})},onError:m=>{a({title:"Erreur",description:m.message,variant:"destructive"})}}),L=z({mutationFn:m=>p.upsertTrainingWeek(m),onSuccess:()=>{v(null),i.invalidateQueries({queryKey:["training-weeks"]})},onError:m=>{a({title:"Erreur",description:m.message,variant:"destructive"})}});return O?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(js,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsxs("span",{className:"font-medium",children:[u.length," Ã©chÃ©ance",u.length>1?"s":""," Ã  planifier"]}),I!=null&&e.jsxs(W,{variant:"secondary",className:"text-[10px]",children:["prochaine J-",I]})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Une carte par compÃ©tition cible pour construire et piloter plusieurs macrocycles Ã  l'avance."})]}),e.jsx("div",{className:"space-y-3",children:u.map((m,x)=>{const h=j.get(m.id)??null,A=h?T.get(h.id)??[]:[],$=new Map(A.map(E=>[E.week_start,E])),R=h?.start_date??h?.start_competition_date??t,P=R>t?R:t,g=h?Ae(P,m.date):[],c=h?Ae(R,m.date):[],D=Math.max(c.length-g.length,0),C=Be(y,m.date);return e.jsxs("div",{className:"rounded-xl border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border bg-muted/20 px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:m.name}),x===0&&e.jsx(W,{className:"text-[10px] bg-primary/10 text-primary border-primary/20",children:"PrioritÃ©"}),e.jsx(W,{variant:"secondary",className:"text-[10px]",children:re(m.date)}),e.jsxs(W,{variant:"outline",className:"text-[10px]",children:["J-",C]})]}),h?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:h.name}),h.start_competition_name&&e.jsxs("span",{children:["depuis ",h.start_competition_name]}),e.jsxs("span",{children:[c.length," sem."]}),D>0&&e.jsxs("span",{children:[D," dÃ©jÃ  passÃ©es"]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Aucun macrocycle crÃ©Ã© pour cette Ã©chÃ©ance."})]}),h?g.length===0?e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"Aucune semaine future Ã  afficher sur ce macrocycle."}):e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1.5",children:g.map((E,le)=>{const B=$.get(E),X=Hs(E),Ne=Gs(E),ve=`${h.id}:${E}`,_e=f===ve,Z=`inline-week-${h.id}-${E}`;return _e?e.jsxs("div",{className:`rounded-lg border bg-card p-2 space-y-1.5 ${X?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Sem. ",D+le+1," (",ke(E)," - ",ke(Ne),")"]}),e.jsx(Ee,{className:"h-7 text-sm",placeholder:"Foncier, Techni., AffÃ»tage...",list:Z,value:w,onChange:ee=>F(ee.target.value)}),e.jsx("datalist",{id:Z,children:k.map(ee=>e.jsx("option",{value:ee},ee))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(M,{variant:"ghost",size:"sm",className:"h-6 text-xs px-2",onClick:()=>v(null),children:"Annuler"}),e.jsx(M,{size:"sm",className:"h-6 text-xs px-2",onClick:()=>{L.mutate({cycle_id:h.id,week_start:E,week_type:w.trim()||null,notes:B?.notes??null})},disabled:L.isPending,children:"OK"})]})]},E):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-2.5 py-2 text-xs transition-colors hover:bg-muted/50 ${X?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>{v(ve),F(B?.week_type??"")},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${X?"bg-primary":B?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",D+le+1]}),e.jsxs("span",{className:"text-muted-foreground/70 whitespace-nowrap",children:[ke(E)," - ",ke(Ne)]}),B?.week_type&&e.jsx(W,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:Ze(B.week_type),color:Ye(B.week_type)},children:B.week_type})]}),B?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:B.notes})]},E)})})}):e.jsxs("div",{className:"px-3 py-3 space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"CrÃ©ez un macrocycle dÃ©diÃ© pour donner de la visibilitÃ© long terme sur cette cible."}),e.jsx(M,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:()=>K.mutate(m.id),disabled:K.isPending,children:K.isPending?"CrÃ©ation...":"CrÃ©er ce macrocycle"})]})]},m.id)})})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"Aucune compÃ©tition assignÃ©e Ã  venir â€” planification non disponible."})})},Zs=({interview:s,athleteId:t,objectives:a,performances:i})=>{const{toast:o}=be(),l=ye(),[r,u]=d.useState(!1),[N,j]=d.useState(s.coach_comment_successes??""),[_,b]=d.useState(s.coach_comment_difficulties??""),[f,v]=d.useState(s.coach_comment_goals??""),w=s.coach_review??"",F=s.coach_objectives??"",[T,k]=d.useState(s.coach_actions??""),[O,y]=d.useState(!1),[I,K]=d.useState(!1),L=d.useRef(!1),{data:m}=q({queryKey:["previous-interview",t,s.date,s.id],queryFn:()=>p.getPreviousInterview(t,s.date,s.id),enabled:!!s.date}),x=d.useCallback(()=>({coach_comment_successes:N.trim()||null,coach_comment_difficulties:_.trim()||null,coach_comment_goals:f.trim()||null,coach_review:w.trim()||null,coach_objectives:F.trim()||null,coach_actions:T.trim()||null}),[T,_,f,N,F,w]),h=d.useCallback(()=>{const C=x();return(s.coach_comment_successes??null)!==C.coach_comment_successes||(s.coach_comment_difficulties??null)!==C.coach_comment_difficulties||(s.coach_comment_goals??null)!==C.coach_comment_goals||(s.coach_review??null)!==C.coach_review||(s.coach_objectives??null)!==C.coach_objectives||(s.coach_actions??null)!==C.coach_actions},[x,s]),A=z({mutationFn:C=>p.updateInterviewCoachSections(s.id,C),onSuccess:()=>{l.invalidateQueries({queryKey:["interviews",t]})},onError:C=>{o({title:"Erreur",description:C.message,variant:"destructive"})}}),$=z({mutationFn:async()=>(await p.updateInterviewCoachSections(s.id,x()),p.sendInterviewToAthlete(s.id)),onSuccess:()=>{o({title:"Entretien envoyÃ© au nageur"}),l.invalidateQueries({queryKey:["interviews",t]})},onError:C=>{o({title:"Erreur",description:C.message,variant:"destructive"})}}),R=z({mutationFn:()=>p.deleteInterview(s.id),onSuccess:()=>{o({title:"Entretien supprimÃ©"}),l.invalidateQueries({queryKey:["interviews",t]})},onError:C=>{o({title:"Erreur",description:C.message,variant:"destructive"})}}),P=A.isPending||$.isPending||R.isPending,g=s.status,c=g==="draft_athlete"?"border-amber-300 dark:border-amber-700 border-l-4":g==="draft_coach"?"border-blue-300 dark:border-blue-700 border-l-4":g==="sent"?"border-emerald-300 dark:border-emerald-700 border-l-4":"",D=d.useCallback(()=>{g!=="draft_coach"||L.current||P||!h()||(L.current=!0,A.mutate(x()),window.setTimeout(()=>{L.current=!1},500))},[x,h,P,A,g]);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${c}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>u(C=>!C),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:re(s.date)}),Xs(g),g==="signed"&&s.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",re(s.signed_at.slice(0,10))]})]}),r?e.jsx(Os,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(Ks,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),r&&e.jsxs("div",{className:"px-4 pb-4 space-y-5",children:[g==="draft_athlete"&&e.jsxs("div",{className:"rounded-xl border border-dashed border-amber-300 bg-amber-50/50 dark:bg-amber-950/20 p-6 text-center space-y-2",children:[e.jsx(ds,{className:"h-8 w-8 mx-auto text-amber-500"}),e.jsx("p",{className:"text-sm font-medium",children:"En attente de la prÃ©paration du nageur"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Le contenu n'est pas encore visible. Le nageur doit d'abord remplir ses sections."})]}),g==="draft_coach"&&e.jsxs(e.Fragment,{children:[m&&e.jsx(Ge,{prevInterview:m,commitmentReview:s.athlete_commitment_review}),e.jsx(H,{label:"RÃ©ussites"}),e.jsx(Y,{label:"Nageur",text:s.athlete_successes}),e.jsx(De,{label:"Coach",value:N,onChange:j,onBlur:D,placeholder:"Votre commentaire sur les rÃ©ussites..."}),e.jsx(H,{label:"DifficultÃ©s"}),e.jsx(Y,{label:"Nageur",text:s.athlete_difficulties}),e.jsx(De,{label:"Coach",value:_,onChange:b,onBlur:D,placeholder:"Votre commentaire sur les difficultÃ©s..."}),e.jsx(H,{label:"Objectifs"}),a.length>0&&e.jsx("div",{className:"space-y-1.5",children:a.map(C=>e.jsx(Ve,{objective:C,performances:i},C.id))}),e.jsx(Y,{label:"Nageur",text:s.athlete_goals}),e.jsx(De,{label:"Coach",value:f,onChange:v,onBlur:D,placeholder:"Objectifs complÃ©mentaires, commentaires..."}),e.jsx(H,{label:"Planification"}),e.jsx(He,{athleteId:t,interviewDate:s.date}),e.jsx(H,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(Y,{label:"Engagements du nageur",text:s.athlete_commitments}),e.jsx(De,{label:"Actions du coach",value:T,onChange:k,onBlur:D,placeholder:"Actions concrÃ¨tes, points de suivi..."})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:A.isPending?"Sauvegarde...":"Sauvegarde automatique a la sortie d'un champ."})]}),(g==="sent"||g==="signed")&&e.jsxs(e.Fragment,{children:[m&&e.jsx(Ge,{prevInterview:m,commitmentReview:s.athlete_commitment_review}),e.jsx(H,{label:"RÃ©ussites"}),e.jsx(Y,{label:"Nageur",text:s.athlete_successes}),e.jsx(Te,{label:"Coach",text:s.coach_comment_successes||s.coach_review}),e.jsx(H,{label:"DifficultÃ©s"}),e.jsx(Y,{label:"Nageur",text:s.athlete_difficulties}),e.jsx(Te,{label:"Coach",text:s.coach_comment_difficulties}),e.jsx(H,{label:"Objectifs"}),a.length>0&&e.jsx("div",{className:"space-y-1.5",children:a.map(C=>e.jsx(Ve,{objective:C,performances:i},C.id))}),e.jsx(Y,{label:"Nageur",text:s.athlete_goals}),e.jsx(Te,{label:"Coach",text:s.coach_comment_goals||s.coach_objectives}),e.jsx(H,{label:"Planification"}),e.jsx(He,{athleteId:t,interviewDate:s.date}),e.jsx(H,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(Y,{label:"Engagements du nageur",text:s.athlete_commitments}),e.jsx(Te,{label:"Actions du coach",text:s.coach_actions})]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[g==="draft_coach"&&e.jsxs(M,{className:"w-full",onClick:()=>K(!0),disabled:P,children:[e.jsx(Ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer au nageur"]}),e.jsxs(M,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>y(!0),disabled:P,children:[e.jsx($e,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})]})]}),e.jsx(de,{open:O,onOpenChange:y,children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Supprimer l'entretien"}),e.jsxs(pe,{children:["Cette action est irrÃ©versible. L'entretien du ",s.date?re(s.date):""," sera supprimÃ© dÃ©finitivement."]})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsx(fe,{onClick:()=>{R.mutate(),y(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(de,{open:I,onOpenChange:K,children:e.jsxs(ue,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:"Envoyer au nageur"}),e.jsx(pe,{children:"L'entretien sera envoyÃ© au nageur pour consultation. Les sections coach seront enregistrÃ©es automatiquement."})]}),e.jsxs(he,{children:[e.jsx(ge,{children:"Annuler"}),e.jsxs(fe,{onClick:()=>{$.mutate(),K(!1)},children:[e.jsx(Ie,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer"]})]})]})})]})},et=({athleteId:s,athleteName:t})=>{const{toast:a}=be(),i=ye(),{data:o}=q({queryKey:["auth-uid",s],queryFn:()=>Ys(s),enabled:!!s}),{data:l=[]}=q({queryKey:["objectives",o],queryFn:()=>p.getObjectives(o),enabled:!!o}),{data:r}=q({queryKey:["athlete-profile",s],queryFn:()=>p.getProfile({userId:s}),enabled:!!s}),u=r?.ffn_iuf??null,N=d.useMemo(()=>{const v=new Date;return v.setDate(v.getDate()-360),v.toISOString().slice(0,10)},[]),{data:j=[]}=q({queryKey:["swimmer-performances-recent",u],queryFn:()=>p.getSwimmerPerformances({iuf:u,fromDate:N}),enabled:!!u}),{data:_=[],isLoading:b}=q({queryKey:["interviews",s],queryFn:()=>p.getInterviews(s),enabled:!!s}),f=z({mutationFn:()=>p.createInterview({athlete_id:s}),onSuccess:()=>{a({title:"Entretien crÃ©Ã©"}),i.invalidateQueries({queryKey:["interviews",s]})},onError:v=>{a({title:"Erreur",description:v.message,variant:"destructive"})}});return b?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(v=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-24 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-20 rounded bg-muted"})]})},v))}):_.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(os,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun entretien pour ",t,"."]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>f.mutate(),disabled:f.isPending,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),f.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Entretiens"}),e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:_.length})]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>f.mutate(),disabled:f.isPending,children:[e.jsx(ie,{className:"mr-1.5 h-3.5 w-3.5"}),f.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}),e.jsx("div",{className:"space-y-2",children:_.map(v=>e.jsx(Zs,{interview:v,athleteId:s,objectives:l,performances:j},v.id))})]})};function Ft(){const[,s]=ys("/coach/swimmer/:id"),[,t]=bs(),{selectedAthleteId:a,selectedAthleteName:i}=Ns(),o=s?.id?Number(s.id):a,l=i,{data:r}=q({queryKey:["profile",o],queryFn:()=>p.getProfile({userId:o}),enabled:o!=null}),u=r?.display_name??l??"Nageur",N=r?.avatar_url??null,j=r?.group_label??null;return o?e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>t("/coach?section=swimmers"),className:"h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition","aria-label":"Retour",children:e.jsx(Ds,{className:"h-4 w-4"})}),N?e.jsx("img",{src:N,alt:"",className:"h-10 w-10 rounded-full object-cover border border-border"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary",children:u.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-lg font-bold truncate",children:u}),j&&e.jsx(W,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:j})]})]}),e.jsxs(vs,{defaultValue:"ressentis",children:[e.jsxs(_s,{className:"w-full grid grid-cols-4",children:[e.jsxs(Ce,{value:"ressentis",className:"text-xs gap-1",children:[e.jsx(ds,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(Ce,{value:"objectifs",className:"text-xs gap-1",children:[e.jsx(qe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Objectifs"})]}),e.jsxs(Ce,{value:"planification",className:"text-xs gap-1",children:[e.jsx(Xe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Planif."})]}),e.jsxs(Ce,{value:"entretiens",className:"text-xs gap-1",children:[e.jsx(os,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]})]}),e.jsx(we,{value:"ressentis",className:"mt-4",children:e.jsx(Cs,{athleteId:o,athleteName:u})}),e.jsx(we,{value:"objectifs",className:"mt-4",children:e.jsx(Is,{athleteId:o,athleteName:u})}),e.jsx(we,{value:"planification",className:"mt-4",children:e.jsx(Bs,{athleteId:o})}),e.jsx(we,{value:"entretiens",className:"mt-4",children:e.jsx(et,{athleteId:o,athleteName:u})})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx("p",{children:"Aucun nageur sÃ©lectionnÃ©."}),e.jsx("button",{type:"button",onClick:()=>t("/coach?section=swimmers"),className:"mt-2 text-primary underline",children:"Retour au dashboard"})]})}export{Ft as default};
