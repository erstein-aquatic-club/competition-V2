import{r as o,j as e}from"./vendor-ui-C9ymspZo.js";import{b as ne,u as ce,c as p}from"./vendor-query-kM2vrB_e.js";import{u as le,i as de,g as d,m as oe,B as h,k as w,C as E,b as k,c as I,d as R,f as A,I as j,S as ue}from"./index-CqCj6e7S.js";import{S as me}from"./switch-DN9m-ebn.js";import{B as H}from"./badge-reuX9qFj.js";import{T as O,a as G,b as L,c as n,d as J,e as c}from"./table-dQG7B3HT.js";import{S as X,a as Y,b as W,c as Z,d as ee}from"./select-Djt44khy.js";import{E as xe}from"./eye-BMxkyUBl.js";import{R as pe}from"./refresh-cw-DJjzXT5m.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-ryiQySsg.js";import"./check-DzX_e55C.js";const se=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],he=a=>a==="user"?"Compte":"Ancien",je=a=>{if(!a)return"-";const r=new Date(a);return Number.isNaN(r.getTime())?a:r.toLocaleDateString("fr-FR")+" "+r.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},ge=a=>{if(!a)return"Jamais";const r=new Date(a);return Number.isNaN(r.getTime())?a:r.toLocaleDateString("fr-FR")},fe=(a,r=30)=>{if(!a)return!0;const g=new Date(a);return Number.isNaN(g.getTime())?!0:Date.now()-g.getTime()>r*24*60*60*1e3},ve=a=>{switch(a){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},be=a=>{switch(a){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return a}};function Te(){const a=le(s=>s.role),{toast:r}=de(),g=ne(),[u,b]=o.useState({display_name:"",iuf:"",sex:""}),[f,M]=o.useState([]),[_,z]=o.useState(!1),[y,B]=o.useState(null),[q,te]=o.useState(!1),[m,N]=o.useState(null),S=a==="coach"||a==="admin",T=a==="admin",{data:U=[],refetch:C}=ce({queryKey:["import-logs"],queryFn:()=>d.getImportLogs({limit:20}),enabled:S}),x=o.useCallback(async()=>{if(S){z(!0),B(null);try{await d.syncClubRecordSwimmersFromUsers();const s=await d.getClubRecordSwimmers();M(s)}catch(s){const t=oe(s,"Impossible de charger la liste.");B(t.message),M([])}finally{z(!1)}}},[S]);o.useEffect(()=>{x()},[x]),o.useEffect(()=>{T&&d.getAppSettings("import_rate_limits").then(s=>{s&&N(s)})},[T]);const V=p({mutationFn:()=>d.createClubRecordSwimmer({display_name:u.display_name.trim(),iuf:u.iuf.trim()||null,sex:u.sex?u.sex:null,is_active:!0}),onSuccess:()=>{r({title:"Nageur ajouté"}),b({display_name:"",iuf:"",sex:""}),x()},onError:()=>{r({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),re=p({mutationFn:({id:s,payload:t})=>d.updateClubRecordSwimmer(s,t),onSuccess:()=>{x(),r({title:"Sauvegardé"})},onError:()=>{r({title:"Mise à jour impossible",variant:"destructive"})}}),ae=p({mutationFn:({userId:s,payload:t})=>d.updateClubRecordSwimmerForUser(s,t),onSuccess:()=>{x(),r({title:"Sauvegardé"})},onError:()=>{r({title:"Mise à jour impossible",variant:"destructive"})}}),v=(s,t)=>{if(s.source_type==="user"&&s.user_id){ae.mutate({userId:s.user_id,payload:t});return}s.id&&re.mutate({id:s.id,payload:t})},D=p({mutationFn:()=>d.importClubRecords(),onSuccess:s=>{const t=s?.summary??s,l=s?.recalc_stats;let i=t?`Performances importées: ${t.imported??0}. Erreurs: ${t.errors??0}.`:"";l&&(i+=` Records: ${l.club_records_upserted} (${l.processed} perfs traitées).`,l.skipped_no_age&&(i+=` Ignorées (pas d'âge): ${l.skipped_no_age}.`)),r({title:"Import terminé",description:i}),x(),C(),g.invalidateQueries({queryKey:["club-records"]})},onError:s=>{const t=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:"Import impossible";r({title:t,variant:"destructive"}),C()}}),K=p({mutationFn:({iuf:s,name:t})=>d.importSingleSwimmer(s,t),onSuccess:(s,t)=>{r({title:`Import de ${t.name??t.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),C(),d.recalculateClubRecords().then(()=>{g.invalidateQueries({queryKey:["club-records"]})}),x()},onError:(s,t)=>{const l=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:`Erreur import ${t.name??t.iuf}`;r({title:l,variant:"destructive"}),C()}}),Q=p({mutationFn:s=>d.updateAppSettings("import_rate_limits",s),onSuccess:()=>{r({title:"Limites sauvegardées"})},onError:()=>{r({title:"Erreur de sauvegarde",variant:"destructive"})}}),ie=o.useMemo(()=>[...f].sort((s,t)=>s.source_type!==t.source_type?s.source_type.localeCompare(t.source_type):s.display_name.localeCompare(t.display_name)),[f]),F=o.useMemo(()=>f.filter(s=>s.is_active&&(!s.iuf||!s.sex||!s.birthdate)).length,[f]),P=p({mutationFn:()=>d.recalculateClubRecords(),onSuccess:s=>{const t=s?.recalc_stats,l=t?`${t.swimmers_with_sex} nageur(s), ${t.total_performances} perfs, ${t.processed} traitées, ${t.club_records_upserted} records.${t.skipped_no_swimmer?` Ignorées (pas de nageur): ${t.skipped_no_swimmer}.`:""}${t.skipped_no_event_code?` Ignorées (épreuve inconnue): ${t.skipped_no_event_code}.`:""}${t.skipped_no_age?` Ignorées (pas d'âge): ${t.skipped_no_age}.`:""}${t.unmapped_event_codes?.length?` Épreuves inconnues: ${t.unmapped_event_codes.join(", ")}`:""}`:"";r({title:"Records recalculés",description:l}),g.invalidateQueries({queryKey:["club-records"]})},onError:()=>{r({title:"Erreur de recalcul",variant:"destructive"})}});return S?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gérez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>{window.location.hash="#/records-club"},children:[e.jsx(xe,{className:"h-4 w-4 mr-1"}),"Voir les records"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>P.mutate(),disabled:P.isPending,children:[e.jsx(pe,{className:w("h-4 w-4 mr-1",P.isPending&&"animate-spin")}),"Recalculer"]}),e.jsx(h,{onClick:()=>D.mutate(),disabled:D.isPending,children:D.isPending?"Import en cours...":"Mettre à jour les records"})]})]}),e.jsxs(E,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Ajouter un ancien nageur"}),e.jsx(R,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(A,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_auto]",children:[e.jsx(j,{placeholder:"Nom du nageur",value:u.display_name,onChange:s=>b(t=>({...t,display_name:s.target.value}))}),e.jsx(j,{placeholder:"IUF",value:u.iuf,onChange:s=>b(t=>({...t,iuf:s.target.value}))}),e.jsxs(X,{value:u.sex,onValueChange:s=>b(t=>({...t,sex:s})),children:[e.jsx(Y,{children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Z,{children:se.map(s=>e.jsx(ee,{value:s.value,children:s.label},s.value))})]}),e.jsx(h,{onClick:()=>V.mutate(),disabled:!u.display_name.trim()||V.isPending,children:"Ajouter"})]})]}),e.jsxs(E,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Liste des nageurs suivis"}),e.jsx(R,{children:"Mettre à jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(A,{children:[!_&&F>0&&e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-300 bg-amber-50 p-3 text-sm text-amber-800 dark:border-amber-700 dark:bg-amber-950/30 dark:text-amber-300",children:[e.jsxs("strong",{children:[F," nageur",F>1?"s":""," incomplet",F>1?"s":""]})," ","— les champs IUF, Sexe et Année de naissance sont requis pour le calcul des records."]}),_&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s))}),y&&e.jsx("p",{className:"text-sm text-destructive",children:y}),!_&&!y&&f.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!_&&!y&&f.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(O,{children:[e.jsx(G,{children:e.jsxs(L,{children:[e.jsx(n,{children:"Nageur"}),e.jsx(n,{children:"Source"}),e.jsx(n,{children:"IUF"}),e.jsx(n,{children:"Sexe"}),e.jsx(n,{children:"Année naiss."}),e.jsx(n,{children:"Dernière maj"}),e.jsx(n,{children:"Actif"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(J,{children:ie.map(s=>{const t=s.id??`user-${s.user_id??"unknown"}`,l=fe(s.last_imported_at);return e.jsxs(L,{className:l?"bg-amber-50/50 dark:bg-amber-950/10":"",children:[e.jsx(c,{className:"font-medium",children:s.display_name}),e.jsx(c,{children:e.jsx(H,{variant:s.source_type==="manual"?"secondary":"outline",children:he(s.source_type)})}),e.jsx(c,{children:e.jsx(j,{defaultValue:s.iuf??"",onBlur:i=>v(s,{iuf:i.target.value.trim()||null}),className:w("w-24",s.is_active&&!s.iuf&&"ring-2 ring-destructive/50")},`${t}-${s.iuf??""}`)}),e.jsx(c,{children:e.jsxs(X,{value:s.sex??"",onValueChange:i=>v(s,{sex:i||null}),children:[e.jsx(Y,{className:w("w-28",s.is_active&&!s.sex&&"ring-2 ring-destructive/50"),children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Z,{children:se.map(i=>e.jsx(ee,{value:i.value,children:i.label},i.value))})]})}),e.jsx(c,{children:e.jsx(j,{type:"number",placeholder:"Année",defaultValue:s.birthdate?new Date(s.birthdate).getFullYear():"",onBlur:i=>{const $=i.target.value.trim();$&&/^\d{4}$/.test($)?v(s,{birthdate:`${$}-01-01`}):$||v(s,{birthdate:null})},className:w("w-20",s.is_active&&!s.birthdate&&"ring-2 ring-amber-400/50")},`${t}-birth-${s.birthdate??""}`)}),e.jsx(c,{children:e.jsx("span",{className:l?"text-amber-600 dark:text-amber-400 text-xs font-medium":"text-xs text-muted-foreground",children:ge(s.last_imported_at)})}),e.jsx(c,{children:e.jsx(me,{checked:!!s.is_active,onCheckedChange:i=>v(s,{is_active:i})})}),e.jsx(c,{children:s.iuf?e.jsx(h,{size:"sm",variant:"outline",disabled:K.isPending,onClick:()=>K.mutate({iuf:s.iuf,name:s.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},t)})})]})})]})]}),e.jsxs(E,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Historique des imports"}),e.jsx(R,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(A,{children:U.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectué."}):e.jsxs(O,{children:[e.jsx(G,{children:e.jsxs(L,{children:[e.jsx(n,{children:"Nageur"}),e.jsx(n,{children:"Statut"}),e.jsx(n,{children:"Trouvées"}),e.jsx(n,{children:"Importées"}),e.jsx(n,{children:"Date"}),e.jsx(n,{children:"Erreur"})]})}),e.jsx(J,{children:U.map(s=>e.jsxs(L,{children:[e.jsx(c,{className:"font-medium",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(c,{children:e.jsx(H,{variant:ve(s.status),children:be(s.status)})}),e.jsx(c,{children:s.performances_found??"-"}),e.jsx(c,{children:s.performances_imported??"-"}),e.jsx(c,{className:"text-xs",children:je(s.started_at)}),e.jsx(c,{className:"max-w-[200px] truncate text-xs text-destructive",children:s.error_message??""})]},s.id))})]})})]}),T&&e.jsxs(E,{children:[e.jsxs(k,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(I,{children:"Paramètres d'import"}),e.jsx(R,{children:"Limites mensuelles d'import par rôle."})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>te(!q),children:e.jsx(ue,{className:"h-4 w-4"})})]}),q&&m&&e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Coach (par mois)"}),e.jsx(j,{type:"number",value:m.coach_monthly,onChange:s=>N({...m,coach_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Nageur (par mois)"}),e.jsx(j,{type:"number",value:m.athlete_monthly,onChange:s=>N({...m,athlete_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Admin (par mois, -1=illimité)"}),e.jsx(j,{type:"number",value:m.admin_monthly,onChange:s=>N({...m,admin_monthly:Number(s.target.value)}),min:-1})]})]}),e.jsx(h,{size:"sm",onClick:()=>Q.mutate(m),disabled:Q.isPending,children:"Enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Accès réservé aux coachs."})]})}export{Te as default};
