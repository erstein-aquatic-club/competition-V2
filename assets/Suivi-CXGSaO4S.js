const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BWLEYywn.js","assets/vendor-query-DyA9aSKS.js","assets/vendor-react-BzrpNAyj.js","assets/vendor-charts-BrQ8X25f.js","assets/vendor-supabase-DFPLkPj_.js","assets/vendor-motion-lao-Njgm.js","assets/index-CFGBaL7w.css"])))=>i.map(i=>d[i]);
import{c as ke,u as C,r as u,d as R,j as e,f as Te}from"./vendor-query-DyA9aSKS.js";import{d as De,B,L as O,v as We,_ as Ge,u as H,P as Z,w as Me,I as Qe,s as He,a as Ue,f as ee}from"./index-BWLEYywn.js";import{a as g}from"./api-DtJKJYEh.js";import{B as T}from"./badge-KvaXzAG-.js";import{C as Fe,a as qe,b as Ee}from"./collapsible-BPOVWy-d.js";import{T as Je,a as Xe,b as W,c as G}from"./tabs-C7kknq0p.js";import{M as Oe,S as Ye,w as Ae,a as Pe,G as Ze,C as $e,b as es}from"./weekTypeColor-CKsaGkQk.js";import{T as K}from"./textarea-CCcFfB-j.js";import{O as U,a as de,F as ss,e as ts,f as as,p as me}from"./ObjectiveCard-BJ8Y0YVF.js";import{A as ne}from"./arrow-left-CK1TSxXl.js";import{C as rs}from"./chevron-up-DM-A--Kn.js";import{C as ns}from"./chevron-down-Df3Vhf7a.js";import{C as Q}from"./clock-CqdX3G8e.js";import{C as ue}from"./circle-check-CgVDXwcA.js";import{C as Be}from"./chevron-right-YrjIFFUh.js";import{T as Ie}from"./trophy-B-F4wOVB.js";import{T as is,a as se}from"./toggle-group-DKW8Baax.js";import{S as xe,a as pe,b as he,c as ge,d as te}from"./select-B3WbyVOX.js";import{S as cs,a as os,b as ls,c as ds,d as ms}from"./sheet-CgAgOD5y.js";import{A as us,a as xs,b as ps,c as hs,d as gs,e as js,f as fs,g as bs}from"./alert-dialog-BvHWYKKg.js";import{S as ys}from"./sparkles-DP2TvzRs.js";import{E as Ns}from"./external-link-BH395jTL.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./swim-D7dS4aWH.js";import"./index-B6bYOGau.js";import"./index-3CP1u4J-.js";import"./chart-column-Dpacqqxq.js";import"./index-DYAPSAZw.js";import"./index-DCX2sNhR.js";import"./index-DQ_Gn1DA.js";function z(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function je(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function vs(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function ws(s){const t=new Date;t.setHours(0,0,0,0);const n=new Date(s+"T00:00:00"),c=new Date(s+"T00:00:00");return c.setDate(c.getDate()+6),t>=n&&t<=c}function fe(s,t){const n=[],c=new Date(s+"T00:00:00"),p=new Date(t+"T00:00:00"),d=new Date(c),m=d.getDay(),v=m===0?1:m===1?0:8-m;for(d.setDate(d.getDate()+v);d<=p;)n.push(d.toISOString().split("T")[0]),d.setDate(d.getDate()+7);return n}function be(s,t){const n=new Date(s+"T00:00:00"),c=new Date(t+"T00:00:00");return Math.round((c.getTime()-n.getTime())/(1e3*60*60*24))}function _s({onBack:s,embedded:t=!1}){const{toast:n}=De(),c=ke(),{data:p}=C({queryKey:["auth-user"],queryFn:async()=>{const{data:i}=await(await Ge(async()=>{const{supabase:j}=await import("./index-BWLEYywn.js").then(q=>q.ah);return{supabase:j}},__vite__mapDeps([0,1,2,3,4,5,6]))).supabase.auth.getUser();return i.user}}),d=p?.app_metadata?.app_user_id,{data:m=[],isLoading:v}=C({queryKey:["my-interviews"],queryFn:()=>g.getMyInterviews()}),{data:y=[]}=C({queryKey:["athlete-objectives"],queryFn:()=>g.getAthleteObjectives()}),{data:F}=C({queryKey:["my-profile-iuf"],queryFn:()=>g.getProfile({userId:d}),enabled:!!d}),w=F?.ffn_iuf??null,N=u.useMemo(()=>{const i=new Date;return i.setDate(i.getDate()-360),i.toISOString().slice(0,10)},[]),{data:S=[]}=C({queryKey:["swimmer-performances-recent",w],queryFn:()=>g.getSwimmerPerformances({iuf:w,fromDate:N}),enabled:!!w}),l=u.useCallback(()=>c.invalidateQueries({queryKey:["my-interviews"]}),[c]),x=R({mutationFn:({id:i,input:j})=>g.updateInterviewAthleteSections(i,j),onSuccess:()=>{n({title:"Sauvegardé"}),l()},onError:i=>n({title:"Erreur",description:i.message,variant:"destructive"})}),a=R({mutationFn:i=>g.submitInterviewToCoach(i),onSuccess:()=>{n({title:"Envoyé au coach"}),l()},onError:i=>n({title:"Erreur",description:i.message,variant:"destructive"})}),o=R({mutationFn:i=>g.signInterview(i),onSuccess:()=>{n({title:"Entretien signé"}),l()},onError:i=>n({title:"Erreur",description:i.message,variant:"destructive"})});return e.jsxs("div",{className:"space-y-6 pb-24",children:[!t&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs(B,{variant:"ghost",size:"sm",className:"-ml-2",onClick:s,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:"Mes entretiens"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Entretiens individuels avec le coach"})]}),v&&e.jsx("div",{className:"space-y-3",children:[1,2,3].map(i=>e.jsx("div",{className:"rounded-xl border p-4 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-40 rounded bg-muted"})},i))}),!v&&m.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(Oe,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun entretien en cours. Votre coach initiera les entretiens."})]}),!v&&m.map(i=>e.jsx(Cs,{interview:i,objectives:y,performances:S,appUserId:d??null,onSave:(j,q)=>x.mutate({id:j,input:q}),onSubmit:j=>{window.confirm("Envoyer votre préparation au coach ? Vous ne pourrez plus la modifier.")&&a.mutate(j)},onSign:j=>{window.confirm("Confirmer la signature de cet entretien ?")&&o.mutate(j)},isSaving:x.isPending,isSubmitting:a.isPending,isSigning:o.isPending},i.id))]})}function Cs({interview:s,objectives:t,performances:n,appUserId:c,onSave:p,onSubmit:d,onSign:m,isSaving:v,isSubmitting:y,isSigning:F}){const w=s.status==="draft_athlete",N=s.status==="draft_coach",S=s.status==="sent",l=s.status==="signed",[x,a]=u.useState(!1),[o,i]=u.useState(s.athlete_successes??""),[j,q]=u.useState(s.athlete_difficulties??""),[D,A]=u.useState(s.athlete_goals??""),[k,P]=u.useState(s.athlete_commitments??""),[_,$]=u.useState(s.athlete_commitment_review??""),{data:h}=C({queryKey:["my-previous-interview",s.date,s.id],queryFn:()=>c?g.getPreviousInterview(c,s.date,s.id):null,enabled:(w||S||l||N)&&!!c}),b=u.useRef(!1),M=u.useCallback(()=>{b.current||!w||(b.current=!0,p(s.id,{athlete_successes:o||null,athlete_difficulties:j||null,athlete_goals:D||null,athlete_commitments:k||null,athlete_commitment_review:_||null}),setTimeout(()=>{b.current=!1},500))},[s.id,o,j,D,k,_,p,w]),E=w?e.jsxs(T,{className:"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400 border-amber-300 dark:border-amber-700",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"À préparer"]}):N?e.jsxs(T,{className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400 border-blue-300 dark:border-blue-700",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"En préparation"]}):S?e.jsxs(T,{className:"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400 border-emerald-300 dark:border-emerald-700",children:[e.jsx(ue,{className:"h-3 w-3 mr-1"}),"À signer"]}):e.jsx(T,{variant:"secondary",children:"Signé"}),I=w?"border-amber-300 dark:border-amber-700 border-l-4":N?"border-blue-300 dark:border-blue-700 border-l-4":S?"border-emerald-300 dark:border-emerald-700 border-l-4":"";return e.jsxs("div",{className:`rounded-xl border bg-card shadow-sm ${I}`,children:[e.jsxs("button",{type:"button",className:"w-full flex items-center justify-between p-4 text-left",onClick:()=>a(f=>!f),children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:z(s.date)}),E,l&&s.signed_at&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["le ",z(s.signed_at.slice(0,10))]})]}),x?e.jsx(rs,{className:"h-4 w-4 text-muted-foreground shrink-0"}):e.jsx(ns,{className:"h-4 w-4 text-muted-foreground shrink-0"})]}),x&&e.jsxs("div",{className:"px-4 pb-4 space-y-4",children:[w&&e.jsxs(e.Fragment,{children:[h&&(h.athlete_commitments||h.coach_actions)&&e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3 space-y-2",children:[e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Bilan des engagements précédents"}),h.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2 space-y-0.5",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mes engagements"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:h.athlete_commitments})]}),h.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2 space-y-0.5",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions du coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:h.coach_actions})]}),e.jsxs("div",{className:"space-y-1 pt-1",children:[e.jsx(O,{htmlFor:`commitment-review-${s.id}`,className:"text-xs",children:"Comment avez-vous tenu vos engagements ?"}),e.jsx(K,{id:`commitment-review-${s.id}`,placeholder:"Mon bilan sur les engagements pris...",value:_,onChange:f=>$(f.target.value),onBlur:M,rows:3})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:`successes-${s.id}`,children:"Mes réussites"}),e.jsx(K,{id:`successes-${s.id}`,placeholder:"Ce dont je suis fier/fière cette saison...",value:o,onChange:f=>i(f.target.value),onBlur:M,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:`difficulties-${s.id}`,children:"Mes difficultés"}),e.jsx(K,{id:`difficulties-${s.id}`,placeholder:"Les points que je souhaite améliorer...",value:j,onChange:f=>q(f.target.value),onBlur:M,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Mes objectifs"}),t.length>0&&e.jsx("div",{className:"space-y-1.5",children:t.map(f=>e.jsx(U,{objective:f,performances:n,compact:!0},f.id))}),e.jsx(K,{id:`goals-${s.id}`,placeholder:"Objectifs supplémentaires ou commentaires...",value:D,onChange:f=>A(f.target.value),onBlur:M,rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{htmlFor:`commitments-${s.id}`,children:"Mes engagements"}),e.jsx(K,{id:`commitments-${s.id}`,placeholder:"Ce que je m'engage à faire...",value:k,onChange:f=>P(f.target.value),onBlur:M,rows:3})]}),v&&e.jsx("p",{className:"text-xs text-muted-foreground animate-pulse",children:"Sauvegarde..."}),e.jsxs(B,{className:"w-full gap-2",onClick:()=>d(s.id),disabled:y,children:[e.jsx(Ye,{className:"h-4 w-4"}),y?"Envoi...":"Envoyer au coach"]})]}),N&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-xl border border-dashed border-blue-300 dark:border-blue-700 bg-blue-50/50 dark:bg-blue-950/20 p-6 text-center space-y-2",children:[e.jsx(Q,{className:"h-8 w-8 mx-auto text-blue-500"}),e.jsx("p",{className:"text-sm font-medium",children:"Entretien envoyé au coach"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Votre coach prépare l'entretien. Vous recevrez le compte-rendu complet après l'entretien en présentiel."}),s.submitted_at&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Envoyé le ",z(s.submitted_at.slice(0,10))]})]}),h&&(h.athlete_commitments||h.coach_actions)&&e.jsx(ye,{prevInterview:h,commitmentReview:s.athlete_commitment_review}),c&&e.jsxs(e.Fragment,{children:[e.jsx(V,{label:"Planification"}),e.jsx(Ne,{athleteId:c,interviewDate:s.date})]})]}),(S||l)&&e.jsxs(e.Fragment,{children:[h&&(h.athlete_commitments||h.coach_actions)&&e.jsx(ye,{prevInterview:h,commitmentReview:s.athlete_commitment_review}),e.jsx(ve,{label:"Réussites",athleteText:s.athlete_successes,coachText:s.coach_comment_successes||s.coach_review}),e.jsx(ve,{label:"Difficultés",athleteText:s.athlete_difficulties,coachText:s.coach_comment_difficulties}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{label:"Objectifs"}),t.length>0&&e.jsx("div",{className:"space-y-1.5",children:t.map(f=>e.jsx(U,{objective:f,performances:n,compact:!0},f.id))}),e.jsx(ae,{text:s.athlete_goals}),e.jsx(re,{text:s.coach_comment_goals||s.coach_objectives})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx(V,{label:"Planification"}),e.jsx(Ne,{athleteId:c,interviewDate:s.date})]}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-3 space-y-2",children:[e.jsx(V,{label:"Engagements & Actions"}),e.jsx(ae,{text:s.athlete_commitments,label:"Mes engagements"}),e.jsx(re,{text:s.coach_actions,label:"Actions du coach"})]}),S&&e.jsxs(B,{className:"w-full gap-2",onClick:()=>m(s.id),disabled:F,children:[e.jsx(ue,{className:"h-4 w-4"}),F?"Signature...":"Signer l'entretien"]})]})]})]})}function ye({prevInterview:s,commitmentReview:t}){const[n,c]=u.useState(!1);return e.jsxs(Fe,{open:n,onOpenChange:c,children:[e.jsx(qe,{asChild:!0,children:e.jsxs("button",{type:"button",className:"w-full flex items-center gap-2 rounded-xl border bg-muted/30 px-3 py-2.5 text-left transition-colors hover:bg-muted/50",children:[e.jsx(Be,{className:`h-3.5 w-3.5 text-muted-foreground shrink-0 transition-transform ${n?"rotate-90":""}`}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Rappel engagements précédents"}),e.jsx(T,{variant:"secondary",className:"text-[10px] px-1.5 py-0 ml-auto",children:z(s.date)})]})}),e.jsx(Ee,{children:e.jsxs("div",{className:"rounded-b-xl border border-t-0 bg-muted/30 px-3 pb-3 space-y-2",children:[s.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mes engagements"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.athlete_commitments})]}),s.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Actions du coach"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:s.coach_actions})]}),t&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-2",children:[e.jsx("p",{className:"text-[10px] font-semibold text-muted-foreground",children:"Mon bilan"}),e.jsx("p",{className:"text-xs whitespace-pre-wrap",children:t})]})]})})]})}function Ne({athleteId:s,interviewDate:t}){const{data:n=[]}=C({queryKey:["competitions"],queryFn:()=>g.getCompetitions()}),{data:c=[]}=C({queryKey:["my-competition-ids",s],queryFn:()=>g.getMyCompetitionIds(s)}),p=u.useMemo(()=>{const l=new Set(c);return n.filter(a=>l.has(a.id)&&a.date>=t).sort((a,o)=>a.date.localeCompare(o.date))[0]??null},[n,c,t]),{data:d=[]}=C({queryKey:["training-cycles","athlete",s],queryFn:()=>g.getTrainingCycles({athleteId:s})}),m=u.useMemo(()=>{const l=new Set(c);return n.filter(x=>l.has(x.id)&&x.date>=t).sort((x,a)=>x.date.localeCompare(a.date))},[n,c,t]),v=u.useMemo(()=>{const l=new Map;return d.slice().sort((x,a)=>(x.end_competition_date??"").localeCompare(a.end_competition_date??"")).forEach(x=>{x.end_competition_id&&!l.has(x.end_competition_id)&&l.set(x.end_competition_id,x)}),l},[d]),y=u.useMemo(()=>{const l=new Set;return m.map(x=>v.get(x.id)??null).filter(x=>!x||l.has(x.id)?!1:(l.add(x.id),!0))},[m,v]),F=Te({queries:y.map(l=>({queryKey:["training-weeks",l.id],queryFn:()=>g.getTrainingWeeks(l.id),enabled:!!l.id}))}),w=u.useMemo(()=>{const l=new Map;return y.forEach((x,a)=>{l.set(x.id,F[a]?.data??[])}),l},[y,F]),N=u.useMemo(()=>new Date().toISOString().split("T")[0],[]),S=p?be(N,p.date):null;return p?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/20 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(Ie,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsxs("span",{className:"font-medium",children:[m.length," échéance",m.length>1?"s":""," visible",m.length>1?"s":""]}),e.jsxs(T,{variant:"secondary",className:"text-[10px]",children:["prochaine J-",S]})]}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Vision multi-macrocycles depuis l'entretien, jusqu'aux prochaines compétitions assignées."})]}),e.jsx("div",{className:"space-y-3",children:m.map((l,x)=>{const a=v.get(l.id)??null,o=a?.start_date??a?.start_competition_date??t,i=o>t?o:t,j=a?fe(i,l.date):[],q=a?fe(o,l.date):[],D=Math.max(q.length-j.length,0),A=be(N,l.date),k=a?w.get(a.id)??[]:[],P=new Map(k.map(_=>[_.week_start,_]));return e.jsxs("div",{className:"rounded-xl border bg-card shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border bg-muted/20 px-3 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:l.name}),x===0&&e.jsx(T,{className:"text-[10px] bg-primary/10 text-primary border-primary/20",children:"Prochaine"}),e.jsx(T,{variant:"secondary",className:"text-[10px]",children:z(l.date)}),e.jsxs(T,{variant:"outline",className:"text-[10px]",children:["J-",A]})]}),a?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:a.name}),a.start_competition_name&&e.jsxs("span",{children:["depuis ",a.start_competition_name]}),e.jsxs("span",{children:[q.length," sem."]}),D>0&&e.jsxs("span",{children:[D," déjà écoulée",D>1?"s":""]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Aucun macrocycle créé pour cette échéance."})]}),a?j.length===0?e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"Aucune semaine future à afficher sur ce macrocycle."}):e.jsx("div",{className:"px-3 py-3",children:e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1.5",children:j.map((_,$)=>{const h=P.get(_),b=ws(_),M=vs(_);return e.jsxs("div",{className:`rounded-lg border bg-card px-2.5 py-2 text-xs ${b?"ring-2 ring-primary bg-primary/5":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${b?"bg-primary":h?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",D+$+1]}),e.jsxs("span",{className:"text-muted-foreground/70 whitespace-nowrap",children:[je(_)," - ",je(M)]}),h?.week_type&&e.jsx(T,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:Pe(h.week_type),color:Ae(h.week_type)},children:h.week_type})]}),h?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:h.notes})]},_)})})}):e.jsx("div",{className:"px-3 py-3 text-xs text-muted-foreground italic",children:"La compétition reste visible pour garder la projection long terme, même sans planification détaillée."})]},l.id)})})]}):e.jsx("p",{className:"text-xs text-muted-foreground italic text-center py-2",children:"Aucune compétition assignée à venir."})}function ve({label:s,athleteText:t,coachText:n}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{label:s}),e.jsx(ae,{text:t}),e.jsx(re,{text:n})]})}function V({label:s}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:s}),e.jsx("div",{className:"h-px flex-1 bg-border"})]})}function ae({text:s,label:t}){return e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-2.5 space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(We,{className:"h-3 w-3 text-blue-500"}),e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-widest text-muted-foreground",children:t??"Nageur"})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseigné"})})]})}function re({text:s,label:t}){return s?.trim()?e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-2.5 space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ze,{className:"h-3 w-3 text-amber-500"}),e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-widest text-muted-foreground",children:t??"Coach"})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s})]}):null}function we({onBack:s,embedded:t=!1}){const{toast:n}=De(),c=ke(),[p,d]=u.useState(!1),[m,v]=u.useState(null),[y,F]=u.useState(null),{data:w}=C({queryKey:["auth-user"],queryFn:async()=>{const{data:r}=await He.auth.getUser();return r.user}}),N=w?.id??null,{data:S=[],isLoading:l}=C({queryKey:["athlete-objectives"],queryFn:()=>g.getAthleteObjectives(),enabled:!!N,refetchInterval:3e4}),x=H(r=>r.userId),a=H(r=>r.user),{data:o}=C({queryKey:["my-profile"],queryFn:()=>g.getProfile({displayName:a,userId:x}),enabled:!!x}),i=o?.ffn_iuf??null,j=u.useMemo(()=>{const r=new Date;return r.setDate(r.getDate()-360),r.toISOString().slice(0,10)},[]),{data:q=[]}=C({queryKey:["swimmer-performances-recent",i],queryFn:()=>g.getSwimmerPerformances({iuf:i,fromDate:j}),enabled:!!i}),D=u.useMemo(()=>S.filter(r=>r.created_by!==N),[S,N]),A=u.useMemo(()=>S.filter(r=>r.created_by===N),[S,N]),[k,P]=u.useState("chrono"),[_,$]=u.useState(""),[h,b]=u.useState("25"),[M,E]=u.useState(""),[I,f]=u.useState(""),Le=()=>{P("chrono"),$(""),b("25"),E(""),f("")},J=()=>{v(null),Le(),d(!0)},Ke=r=>{v(r);const ze=!!r.event_code,le=!!r.text;P(ze&&le?"both":le?"texte":"chrono"),$(r.event_code??""),b(String(r.pool_length??25)),E(r.target_time_seconds!=null?as(r.target_time_seconds):""),f(r.text??""),d(!0)},X=()=>c.invalidateQueries({queryKey:["athlete-objectives"]}),ie=R({mutationFn:r=>g.createObjective(r),onSuccess:()=>{n({title:"Objectif créé"}),X(),d(!1)},onError:r=>n({title:"Erreur",description:r.message,variant:"destructive"})}),ce=R({mutationFn:r=>g.updateObjective(m.id,r),onSuccess:()=>{n({title:"Objectif mis à jour"}),X(),d(!1)},onError:r=>n({title:"Erreur",description:r.message,variant:"destructive"})}),Re=R({mutationFn:r=>g.deleteObjective(r),onSuccess:()=>{n({title:"Objectif supprimé"}),X(),F(null)},onError:r=>n({title:"Erreur",description:r.message,variant:"destructive"})}),L=k==="chrono"||k==="both",Y=k==="texte"||k==="both",oe=ie.isPending||ce.isPending,Ve=()=>{if(L&&!_){n({title:"Épreuve requise",variant:"destructive"});return}if(L&&M&&me(M)===null){n({title:"Format invalide",description:"Format : m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(Y&&!I.trim()){n({title:"Texte requis",variant:"destructive"});return}if(!N)return;const r={athlete_id:N,event_code:L?_:null,pool_length:L?Number(h):null,target_time_seconds:L&&M?me(M):null,text:Y?I.trim():null};m?ce.mutate(r):ie.mutate(r)};return e.jsxs("div",{className:t?"space-y-3":"space-y-6 pb-24",children:[t?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/70",children:"Objectifs"}),e.jsxs(B,{variant:"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:J,children:[e.jsx(Z,{className:"mr-1 h-3 w-3"}),"Ajouter"]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs(B,{variant:"ghost",size:"sm",className:"-ml-2",onClick:s,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:"Mon plan"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Mes objectifs d'entraînement"})]}),e.jsxs(B,{variant:"outline",size:"sm",onClick:J,children:[e.jsx(Z,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter"]})]})]}),l&&e.jsx("div",{className:"space-y-1.5",children:[1,2].map(r=>e.jsx("div",{className:"rounded-lg border p-2.5 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-3.5 w-36 rounded bg-muted"})},r))}),!l&&S.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-2",children:[e.jsx(Me,{className:"h-8 w-8 text-muted-foreground/40 mx-auto"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Aucun objectif pour le moment."}),e.jsxs(B,{variant:"ghost",size:"sm",className:"text-xs h-7",onClick:J,children:[e.jsx(Z,{className:"mr-1 h-3 w-3"}),"Ajouter"]})]}),D.length>0&&e.jsxs("div",{className:"space-y-2",children:[!t&&e.jsx("h3",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Objectifs du coach"}),e.jsx(de,{children:D.map(r=>e.jsx(U,{objective:r,performances:q,showCoachBadge:!0},r.id))})]}),A.length>0&&e.jsxs("div",{className:"space-y-2",children:[!t&&e.jsx("h3",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Mes objectifs personnels"}),e.jsx(de,{children:A.map(r=>e.jsx(U,{objective:r,performances:q,onClick:()=>Ke(r)},r.id))})]}),e.jsx(cs,{open:p,onOpenChange:d,children:e.jsxs(os,{side:"bottom",className:"max-h-[85vh] overflow-y-auto",children:[e.jsxs(ls,{children:[e.jsx(ds,{children:m?"Modifier l'objectif":"Nouvel objectif"}),e.jsx(ms,{children:m?"Modifiez votre objectif personnel.":"Ajoutez un objectif personnel."})]}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Type d'objectif"}),e.jsxs(is,{type:"single",variant:"outline",value:k,onValueChange:r=>{r&&P(r)},className:"justify-start",children:[e.jsx(se,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(se,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(se,{value:"both",className:"text-xs",children:"Les deux"})]})]}),L&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Épreuve *"}),e.jsxs(xe,{value:_,onValueChange:$,children:[e.jsx(pe,{children:e.jsx(he,{placeholder:"Choisir une épreuve"})}),e.jsx(ge,{children:ss.map(r=>e.jsx(te,{value:r,children:ts(r)},r))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Bassin"}),e.jsxs(xe,{value:h,onValueChange:b,children:[e.jsx(pe,{children:e.jsx(he,{})}),e.jsxs(ge,{children:[e.jsx(te,{value:"25",children:"25m"}),e.jsx(te,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Temps cible (min:sec:centièmes)"}),e.jsx(Qe,{placeholder:"Ex : 1:05:30",value:M,onChange:r=>E(r.target.value)})]})]}),Y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(O,{children:"Objectif texte *"}),e.jsx(K,{placeholder:"Ex : Améliorer la coulée de dos",value:I,onChange:r=>f(r.target.value),rows:3})]}),e.jsx(B,{className:"w-full",onClick:Ve,disabled:oe,children:oe?"Enregistrement...":m?"Enregistrer":"Créer"})]})]})}),e.jsx(us,{open:!!y,onOpenChange:r=>{r||F(null)},children:e.jsxs(xs,{children:[e.jsxs(ps,{children:[e.jsx(hs,{children:"Supprimer l'objectif"}),e.jsx(gs,{children:"Cette action est irréversible. L'objectif sera supprimé définitivement."})]}),e.jsxs(js,{children:[e.jsx(fs,{children:"Annuler"}),e.jsx(bs,{onClick:()=>{y&&Re.mutate(y.id)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})}function Ss(s){return new Date(s+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function _e(s){return new Date(s+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function ks(s){const t=new Date(s+"T00:00:00");return t.setDate(t.getDate()+6),t.toISOString().split("T")[0]}function Ts(s){const t=new Date;t.setHours(0,0,0,0);const n=new Date(s+"T00:00:00"),c=new Date(s+"T00:00:00");return c.setDate(c.getDate()+6),t>=n&&t<=c}function Ce(s,t){const n=[],c=new Date(s+"T00:00:00"),p=new Date(t+"T00:00:00"),d=new Date(c),m=d.getDay(),v=m===0?1:m===1?0:8-m;for(d.setDate(d.getDate()+v);d<=p;)n.push(d.toISOString().split("T")[0]),d.setDate(d.getDate()+7);return n}function Se(s,t){const n=new Date(s+"T00:00:00"),c=new Date(t+"T00:00:00");return Math.round((c.getTime()-n.getTime())/(1e3*60*60*24))}function Ds({athleteId:s}){const[,t]=Ue(),n=u.useMemo(()=>new Date().toISOString().split("T")[0],[]),[c,p]=u.useState([]),{data:d=[]}=C({queryKey:["competitions"],queryFn:()=>g.getCompetitions()}),{data:m=[]}=C({queryKey:["my-competition-ids",s],queryFn:()=>g.getMyCompetitionIds(s)}),{data:v=[]}=C({queryKey:["training-cycles","athlete",s],queryFn:()=>g.getTrainingCycles({athleteId:s})}),y=u.useMemo(()=>{const a=new Set(m);return d.filter(o=>a.has(o.id)&&o.date>=n).sort((o,i)=>o.date.localeCompare(i.date))},[m,d,n]),F=u.useMemo(()=>{const a=new Map;return v.slice().sort((o,i)=>(o.end_competition_date??"").localeCompare(i.end_competition_date??"")).forEach(o=>{o.end_competition_id&&!a.has(o.end_competition_id)&&a.set(o.end_competition_id,o)}),a},[v]),w=u.useMemo(()=>{const a=new Set;return y.map(o=>F.get(o.id)??null).filter(o=>!o||a.has(o.id)?!1:(a.add(o.id),!0))},[F,y]),N=Te({queries:w.map(a=>({queryKey:["training-weeks",a.id],queryFn:()=>g.getTrainingWeeks(a.id),enabled:!!a.id}))}),S=u.useMemo(()=>{const a=new Map;return w.forEach((o,i)=>{a.set(o.id,N[i]?.data??[])}),a},[w,N]),l=y[0]??null,x=a=>{p(o=>o.includes(a)?o.filter(i=>i!==a):[...o,a])};return y.length===0?e.jsxs("div",{className:"rounded-3xl border border-dashed bg-card/70 px-4 py-8 text-center",children:[e.jsx($e,{className:"mx-auto h-10 w-10 text-muted-foreground/60"}),e.jsx("p",{className:"mt-3 text-sm font-medium",children:"Aucune échéance à venir."}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Ton plan apparaîtra ici."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-3xl border bg-gradient-to-br from-primary/[0.08] via-background to-amber-500/[0.08] p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ys,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-semibold",children:[y.length," échéance",y.length>1?"s":""]}),l&&e.jsxs(T,{variant:"secondary",className:"text-[10px] px-2 py-0.5",children:["cap J-",Se(n,l.date)]})]}),e.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:"Vue de tes prochains cycles."})]}),e.jsx("div",{className:"space-y-3",children:y.map((a,o)=>{const i=F.get(a.id)??null,j=i?.start_date??i?.start_competition_date??n,q=j>n?j:n,D=i?Ce(q,a.date):[],A=i?Ce(j,a.date):[],k=Math.max(A.length-D.length,0),P=i?S.get(i.id)??[]:[],_=new Map(P.map(b=>[b.week_start,b])),$=Se(n,a.date),h=c.includes(a.id);return e.jsx(Fe,{open:h,onOpenChange:()=>x(a.id),children:e.jsxs("section",{className:"overflow-hidden rounded-3xl border bg-card shadow-sm",children:[e.jsx(qe,{asChild:!0,children:e.jsx("button",{type:"button",className:"w-full border-b border-border bg-muted/20 px-4 py-3 text-left transition-colors hover:bg-muted/30",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Be,{className:`mt-0.5 h-4 w-4 shrink-0 text-muted-foreground transition-transform ${h?"rotate-90":""}`}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:a.name}),o===0&&e.jsx(T,{className:"border-primary/20 bg-primary/10 text-[10px] text-primary",children:"Priorité"}),e.jsx(T,{variant:"secondary",className:"text-[10px]",children:Ss(a.date)}),e.jsxs(T,{variant:"outline",className:"text-[10px]",children:["J-",$]}),e.jsx("button",{type:"button",className:"ml-auto shrink-0 rounded-lg p-1 text-muted-foreground hover:text-foreground hover:bg-muted transition",onClick:b=>{b.stopPropagation(),t(`/competition/${a.id}`)},"aria-label":"Voir la compétition",children:e.jsx(Ns,{className:"h-3.5 w-3.5"})})]}),i?e.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:i.name}),e.jsxs("span",{children:[A.length," sem."]}),k>0&&e.jsxs("span",{children:[k," sem. passée",k>1?"s":""]})]}):e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Pas de cycle détaillé."})]})]})})}),e.jsx(Ee,{children:i?D.length===0?e.jsx("div",{className:"px-4 py-4 text-xs text-muted-foreground italic",children:"Pas de semaine à venir."}):e.jsx("div",{className:"px-4 py-4",children:e.jsx("div",{className:"relative ml-2 space-y-2 border-l-2 border-border pl-4",children:D.map((b,M)=>{const E=_.get(b),I=Ts(b),f=ks(b);return e.jsxs("div",{className:`rounded-2xl border bg-card px-3 py-2 text-xs ${I?"ring-2 ring-primary/40 bg-primary/[0.04]":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${I?"bg-primary":E?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"whitespace-nowrap text-muted-foreground",children:["Sem. ",k+M+1]}),e.jsxs("span",{className:"whitespace-nowrap text-muted-foreground/70",children:[_e(b)," - ",_e(f)]}),E?.week_type&&e.jsx(T,{className:"ml-auto border-0 px-1.5 py-0 text-[10px]",style:{backgroundColor:Pe(E.week_type),color:Ae(E.week_type)},children:E.week_type})]}),E?.notes&&e.jsx("p",{className:"mt-1 pl-4 text-[11px] text-muted-foreground line-clamp-2",children:E.notes})]},b)})})}):e.jsx("div",{className:"px-4 py-4 text-xs text-muted-foreground italic",children:"L'échéance reste affichée."})})]})},a.id)})})]})}function Ms({athleteId:s,athleteName:t,groupLabel:n,onBack:c,standalone:p,defaultTab:d}){return e.jsxs("div",{className:`mx-auto max-w-4xl pb-24 ${p?"space-y-3":"space-y-4"}`,children:[e.jsxs("div",{className:`rounded-[1.75rem] border bg-gradient-to-br from-primary/[0.12] via-background to-amber-500/[0.08] shadow-sm ${p?"p-3":"p-4"}`,children:[!p&&c&&e.jsxs(B,{variant:"ghost",size:"sm",className:"-ml-2 mb-2",onClick:c,children:[e.jsx(ne,{className:"mr-1.5 h-4 w-4"}),"Retour"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`flex shrink-0 items-center justify-center rounded-2xl bg-primary/12 text-primary ${p?"h-9 w-9":"h-11 w-11"}`,children:e.jsx(Ie,{className:p?"h-4 w-4":"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("h1",{className:`font-display font-semibold uppercase italic text-foreground ${p?"text-lg":"text-xl"}`,children:"Mon suivi"}),n&&e.jsx(T,{variant:"secondary",className:"text-[10px]",children:n})]}),!p&&e.jsxs("p",{className:"mt-1 text-sm text-muted-foreground",children:[t,": ton plan d'action, tes entretiens et tes échéances au même endroit."]})]})]})]}),p&&e.jsx(we,{embedded:!0}),e.jsxs(Je,{defaultValue:d||(p?"ressentis":"objectifs"),className:p?"space-y-3":"space-y-4",children:[e.jsxs(Xe,{className:`grid h-auto w-full gap-2 rounded-2xl bg-transparent p-0 ${p?"grid-cols-3":"grid-cols-2 sm:grid-cols-4"}`,children:[!p&&e.jsxs(W,{value:"objectifs",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Me,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Plan d'action"}),e.jsx("span",{className:"hidden sm:inline",children:"Plan d'action"})]}),e.jsxs(W,{value:"ressentis",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Q,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Ressentis"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(W,{value:"entretiens",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx(Oe,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{className:"sm:hidden",children:"Entretiens"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]}),e.jsxs(W,{value:"planification",className:"gap-1 rounded-2xl border border-border bg-card px-3 py-2.5 text-xs data-[state=active]:border-primary/30 data-[state=active]:bg-primary/5 data-[state=active]:text-primary",children:[e.jsx($e,{className:"hidden h-3.5 w-3.5 sm:block"}),e.jsx("span",{children:"Planif."})]})]}),!p&&e.jsx(G,{value:"objectifs",className:"mt-0",children:e.jsx(we,{embedded:!0})}),e.jsx(G,{value:"ressentis",className:"mt-0",children:e.jsx(es,{athleteId:s,athleteName:t,showProgressAction:!1})}),e.jsx(G,{value:"entretiens",className:"mt-0",children:e.jsx(_s,{embedded:!0})}),e.jsx(G,{value:"planification",className:"mt-0",children:e.jsx(Ds,{athleteId:s})})]})]})}function Fs(){return typeof window>"u"?void 0:window.location.hash.match(/[?&]tab=([^&]+)/)?.[1]||void 0}function mt(){const s=H(m=>m.user),t=H(m=>m.userId),{data:n,isLoading:c}=C({queryKey:["profile",s,t],queryFn:()=>g.getProfile({displayName:s,userId:t}),enabled:!!s}),{data:p=[]}=C({queryKey:["profile-groups"],queryFn:()=>g.getGroups(),enabled:!!s}),d=p.find(m=>m.id===n?.group_id)?.name||n?.group_label||null;return c?e.jsxs("div",{className:"mx-auto max-w-4xl space-y-4 p-4",children:[e.jsx(ee,{className:"h-28 rounded-3xl"}),e.jsx(ee,{className:"h-12 rounded-2xl"}),e.jsx(ee,{className:"h-64 rounded-2xl"})]}):e.jsx(Ms,{athleteId:t??0,athleteName:n?.display_name||s||"Nageur",groupLabel:d,standalone:!0,defaultTab:Fs()})}export{mt as default};
