import{c as he,r as c,u as R,d as B,j as e}from"./vendor-query-DyA9aSKS.js";import{a as E}from"./api-luxBoELH.js";import{d as pe,B as k,P as re,a4 as ge,L as C,I as ae}from"./index-CM6RwWsH.js";import{C as Re}from"./Coach-CYYUUCym.js";import{B as ce}from"./badge-DU2HnYXT.js";import{S as Ve}from"./separator-CjqUufDc.js";import{S as fe,a as ve,b as je,c as be,d as Ne}from"./sheet-DzaNs1nT.js";import{A as Ke,a as We,b as Qe,c as Ge,d as Ue,e as Ye,f as Be,g as Je}from"./alert-dialog-CQRjVuY3.js";import{S as J,a as X,b as Z,c as ee,d as A,f as Y}from"./select-CJQ6B3_D.js";import{R as Xe,a as De}from"./radio-group-B82brGRA.js";import{C as me}from"./chevron-left-4p3UoKpS.js";import{C as $e}from"./chevron-right-BNK2hQC0.js";import{C as Ze}from"./clock-CLpxBZRJ.js";import{M as ye}from"./map-pin-DLu_VsGK.js";import{T as Ae}from"./trash-2-RYJ6eSS8.js";import"./vendor-react-BzrpNAyj.js";import"./swim-DwaXT8Pm.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-_XzE3Ody.js";import"./search-BmAKBxxU.js";import"./trophy-CvDDEePN.js";import"./bell-ring-MD-ERykR.js";import"./zap-DlUTqzvA.js";import"./index-DVXZbP3K.js";import"./index-D1a4e-V0.js";import"./index-DaucO7v7.js";import"./index-DCX2sNhR.js";import"./chevron-down-DIelldvR.js";import"./check-DvVw7ObJ.js";import"./chevron-up-DyyKSR-o.js";import"./index-BSwnPOrN.js";import"./circle-D3YOL8sA.js";const le=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],et=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],se=6,tt=22,Le=tt-se,ie=40,Me=Le*ie,Fe=Array.from({length:Le+1},(s,r)=>se+r);function L(s){return s.slice(0,5)}function Ee(){return new Date().toISOString().slice(0,10)}function q(s){const[r,i]=s.split(":").map(Number);return r*60+i}function ue(s){return(q(s)-se*60)/60*ie}function st(s,r){return ue(r)-ue(s)}function Te(s){const r=new Date(s),i=r.getDay(),v=i===0?-6:1-i;return r.setDate(r.getDate()+v),r.setHours(0,0,0,0),r}function nt(s){const r=new Date(s);r.setHours(0,0,0,0),r.setDate(r.getDate()+3-(r.getDay()+6)%7);const i=new Date(r.getFullYear(),0,4);return 1+Math.round(((r.getTime()-i.getTime())/864e5-3+(i.getDay()+6)%7)/7)}function te(s){return s.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function V(s){const r=i=>String(i).padStart(2,"0");return`${s.getFullYear()}-${r(s.getMonth()+1)}-${r(s.getDate())}`}function xe(s){const r=s.toLowerCase();return r.includes("piscine")||r.includes("bassin")||!r.includes("salle")&&!r.includes("muscu")&&!r.includes("ppg")&&!r.includes("gym")}const rt=({open:s,onOpenChange:r,slot:i,groups:v,coaches:N})=>{const{toast:h}=pe(),w=he(),d=!!i,[F,S]=c.useState("1"),[b,D]=c.useState(""),[j,M]=c.useState(""),[o,x]=c.useState(""),[u,g]=c.useState([]),[_,l]=c.useState(1),[T,I]=c.useState(!1);c.useEffect(()=>{if(s)if(i){S(String(i.day_of_week)),D(L(i.start_time)),M(L(i.end_time)),x(i.location);const n=i.assignments.map((m,O)=>({key:O,group_id:String(m.group_id),coach_id:String(m.coach_id),lane_count:m.lane_count!=null?String(m.lane_count):""}));g(n),l(n.length)}else S("1"),D(""),M(""),x(""),g([]),l(1)},[s,i]);const z=()=>{g(n=>[...n,{key:_,group_id:"",coach_id:"",lane_count:""}]),l(n=>n+1)},K=n=>{g(m=>m.filter(O=>O.key!==n))},y=(n,m,O)=>{g(U=>U.map(P=>P.key===n?{...P,[m]:O}:P))},H=()=>!b||!j?(h({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):o.trim()?{day_of_week:Number(F),start_time:b,end_time:j,location:o.trim(),assignments:u.filter(n=>n.group_id&&n.coach_id).map(n=>({group_id:Number(n.group_id),coach_id:Number(n.coach_id),lane_count:n.lane_count?Number(n.lane_count):null}))}:(h({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),f=B({mutationFn:n=>E.createTrainingSlot(n),onSuccess:()=>{h({title:"Creneau cree"}),w.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:n=>{h({title:"Erreur",description:n.message,variant:"destructive"})}}),W=B({mutationFn:n=>E.updateTrainingSlot(i.id,n),onSuccess:()=>{h({title:"Creneau mis a jour"}),w.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:n=>{h({title:"Erreur",description:n.message,variant:"destructive"})}}),Q=B({mutationFn:()=>E.deleteTrainingSlot(i.id),onSuccess:()=>{h({title:"Creneau supprime"}),w.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:n=>{h({title:"Erreur",description:n.message,variant:"destructive"})}}),G=()=>{const n=H();n&&(d?W.mutate(n):f.mutate(n))},$=f.isPending||W.isPending||Q.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(fe,{open:s,onOpenChange:r,children:e.jsxs(ve,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(je,{children:[e.jsx(be,{children:d?"Modifier le creneau":"Nouveau creneau"}),e.jsx(Ne,{children:d?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Jour de la semaine *"}),e.jsxs(J,{value:F,onValueChange:S,children:[e.jsx(X,{children:e.jsx(Z,{})}),e.jsx(ee,{children:le.map((n,m)=>e.jsx(A,{value:String(m+1),children:n},m+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:b,onChange:n=>D(n.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:j,onChange:n=>M(n.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(ae,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:o,onChange:n=>x(n.target.value)})]}),e.jsx(Ve,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(C,{children:"Groupes & Coachs"}),e.jsxs(k,{type:"button",variant:"outline",size:"sm",onClick:z,children:[e.jsx(re,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),u.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),u.map(n=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(J,{value:n.group_id,onValueChange:m=>y(n.key,"group_id",m),children:[e.jsx(X,{className:"h-8 text-xs",children:e.jsx(Z,{placeholder:"Groupe..."})}),e.jsx(ee,{children:v.map(m=>e.jsx(A,{value:String(m.id),children:m.name},m.id))})]}),e.jsxs(J,{value:n.coach_id,onValueChange:m=>y(n.key,"coach_id",m),children:[e.jsx(X,{className:"h-8 text-xs",children:e.jsx(Z,{placeholder:"Coach..."})}),e.jsx(ee,{children:N.map(m=>e.jsx(A,{value:String(m.id),children:m.display_name},m.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{type:"number",min:0,placeholder:"Lignes d'eau",value:n.lane_count,onChange:m=>y(n.key,"lane_count",m.target.value),className:"h-8 text-xs flex-1"}),e.jsx(k,{type:"button",variant:"ghost",size:"icon",className:"h-10 w-10 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>K(n.key),children:e.jsx(Ae,{className:"h-3.5 w-3.5"})})]})]})},n.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(k,{className:"w-full",onClick:G,disabled:$||!b||!j||!o.trim(),children:$?"Enregistrement...":d?"Enregistrer":"Creer"}),d&&e.jsx(k,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>I(!0),disabled:$,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(Ke,{open:T,onOpenChange:I,children:e.jsxs(We,{children:[e.jsxs(Qe,{children:[e.jsx(Ge,{children:"Supprimer le creneau"}),e.jsx(Ue,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(Ye,{children:[e.jsx(Be,{children:"Annuler"}),e.jsx(Je,{onClick:()=>{Q.mutate(),I(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},at=({open:s,onOpenChange:r,slot:i})=>{const{toast:v}=pe(),N=he(),[h,w]=c.useState(""),[d,F]=c.useState("cancelled"),[S,b]=c.useState(""),[D,j]=c.useState(""),[M,o]=c.useState(""),[x,u]=c.useState("");c.useEffect(()=>{s&&(w(""),F("cancelled"),b(i?L(i.start_time):""),j(i?L(i.end_time):""),o(i?.location??""),u(""))},[s,i]);const g=B({mutationFn:l=>E.createSlotOverride(l),onSuccess:()=>{v({title:"Exception enregistree"}),N.invalidateQueries({queryKey:["training-slot-overrides"]}),N.invalidateQueries({queryKey:["training-slots"]}),r(!1)},onError:l=>{v({title:"Erreur",description:l.message,variant:"destructive"})}}),_=()=>{if(!i)return;if(!h){v({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const l={slot_id:i.id,override_date:h,status:d,new_start_time:d==="modified"&&S||null,new_end_time:d==="modified"&&D||null,new_location:d==="modified"&&M.trim()?M.trim():null,reason:x.trim()||null};g.mutate(l)};return e.jsx(fe,{open:s,onOpenChange:r,children:e.jsxs(ve,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(je,{children:[e.jsx(be,{children:"Exception"}),e.jsx(Ne,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:h,onChange:l=>w(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Type"}),e.jsxs(Xe,{value:d,onValueChange:l=>F(l),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(De,{value:"cancelled",id:"ovr-cancelled"}),e.jsx(C,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(De,{value:"modified",id:"ovr-modified"}),e.jsx(C,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),d==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:S,onChange:l=>b(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:D,onChange:l=>j(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(ae,{id:"ovr-location",value:M,onChange:l=>o(l.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(ae,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:x,onChange:l=>u(l.target.value)})]}),e.jsx(k,{className:"w-full",onClick:_,disabled:g.isPending||!h,children:g.isPending?"Enregistrement...":"Enregistrer"})]})]})})},it=({slot:s,hasOverrides:r,cancelled:i=!1,onSelect:v})=>{const N=ue(s.start_time),h=st(s.start_time,s.end_time),w=h<50,d=xe(s.location),F=i?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":d?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",S=d?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${F}`,style:{top:N,height:h,minHeight:24},onClick:()=>v(s),title:`${L(s.start_time)}–${L(s.end_time)} · ${s.location}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${w?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx(ye,{className:`h-2.5 w-2.5 shrink-0 ${S}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:s.location}),r&&!i&&e.jsx(ge,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),!w&&s.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:s.assignments.map(b=>e.jsx(ce,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:b.group_name},b.id))}),!w&&h>=70&&s.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(s.assignments.map(b=>b.coach_name))].join(", ")})]})})},lt=({slot:s,open:r,onOpenChange:i,overrides:v,onEdit:N,onOverride:h,onDeleteOverride:w})=>s?e.jsx(fe,{open:r,onOpenChange:i,children:e.jsxs(ve,{side:"bottom",className:"max-h-[60vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(je,{className:"pb-2",children:[e.jsxs(be,{className:"text-left text-base",children:[le[s.day_of_week-1]," · ",L(s.start_time),"–",L(s.end_time)]}),e.jsx(Ne,{className:"sr-only",children:"Details du creneau"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(ye,{className:"h-3.5 w-3.5 shrink-0"}),s.location]}),s.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.assignments.map(d=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ce,{variant:"secondary",className:"text-xs px-2 py-0.5",children:d.group_name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[d.coach_name,d.lane_count!=null&&` · ${d.lane_count} ligne${d.lane_count>1?"s":""}`]})]},d.id))}),v.length>0&&e.jsxs("div",{className:"space-y-1.5 pt-1 border-t border-dashed",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Exceptions"}),v.map(d=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(ge,{className:"h-3 w-3 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(d.override_date+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}),e.jsx(ce,{variant:d.status==="cancelled"?"destructive":"outline",className:"text-[10px] px-1 py-0",children:d.status==="cancelled"?"Annule":"Modifie"}),d.reason&&e.jsx("span",{className:"text-muted-foreground truncate flex-1",children:d.reason}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-6 w-6 ml-auto shrink-0 text-muted-foreground hover:text-destructive",onClick:()=>w(d.id),children:e.jsx(Ae,{className:"h-3 w-3"})})]},d.id))]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(k,{variant:"outline",size:"sm",className:"flex-1",onClick:N,children:"Modifier"}),e.jsx(k,{variant:"outline",size:"sm",className:"flex-1",onClick:h,children:"Exception"})]})]})]})}):null;function ot(s,r){const i=q(r)-q(s),v=Math.floor(i/60),N=i%60;return v===0?`${N}min`:N===0?`${v}h`:`${v}h${String(N).padStart(2,"0")}`}const dt=({slotsByDay:s,weekDates:r,todayStr:i,overridesBySlot:v,cancelledSlotIds:N,onSelect:h,onPrevWeek:w,onNextWeek:d,weekNumber:F})=>{const[S,b]=c.useState(()=>{const o=r.findIndex(x=>V(x)===i);return o>=0?o+1:1});c.useEffect(()=>{const o=r.findIndex(x=>V(x)===i);o>=0?b(o+1):b(1)},[r,i]);const D=s.get(S)??[],j=c.useMemo(()=>{let o=22,x=6;return s.forEach(u=>{for(const g of u){const _=Math.floor(q(g.start_time)/60),l=Math.ceil(q(g.end_time)/60);_<o&&(o=_),l>x&&(x=l)}}),o>=x?{start:6,end:22}:{start:Math.max(0,o),end:Math.min(24,x)}},[s]),M=(j.end-j.start)*60;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:w,children:e.jsx(me,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",F]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[te(r[0])," – ",te(r[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:d,children:e.jsx($e,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border bg-card overflow-hidden",children:r.map((o,x)=>{const u=x+1,g=V(o)===i,_=u===S,l=s.get(u)??[];return e.jsxs("button",{type:"button",className:`flex flex-col items-center py-2 transition-colors relative ${_?"bg-primary/8":"hover:bg-muted/50 active:bg-muted"}`,onClick:()=>b(u),children:[e.jsx("span",{className:`text-[10px] font-semibold uppercase tracking-wider ${g?"text-primary":"text-muted-foreground"}`,children:et[x]}),e.jsx("span",{className:`text-sm font-bold tabular-nums mt-0.5 h-10 w-10 flex items-center justify-center rounded-full ${g?"bg-primary text-primary-foreground":_?"text-foreground":"text-foreground/80"}`,children:o.getDate()}),e.jsx("div",{className:"w-full px-1 mt-1.5 h-8 relative",children:l.map(T=>{const I=q(T.start_time)-j.start*60,z=q(T.end_time)-j.start*60,K=Math.max(0,I/M*100),y=Math.max(8,(z-I)/M*100),H=xe(T.location),f=N.has(T.id);return e.jsx("div",{className:`absolute left-1 right-1 rounded-sm ${f?"bg-muted-foreground/20":H?"bg-blue-500/40":"bg-amber-400/50"}`,style:{top:`${K}%`,height:`${y}%`,minHeight:"3px"}},T.id)})}),_&&e.jsx("div",{className:"absolute bottom-0 left-2 right-2 h-0.5 rounded-full bg-primary"})]},u)})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground px-0.5",children:[le[S-1]," ",r[S-1]?.getDate()," ",e.jsx("span",{className:"font-normal text-muted-foreground",children:r[S-1]?.toLocaleDateString("fr-FR",{month:"long"})})]}),D.length===0?e.jsx("div",{className:"rounded-xl border border-dashed border-border/60 bg-muted/20 py-8 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun créneau"})}):e.jsx("div",{className:"space-y-2",children:D.map(o=>{const x=xe(o.location),u=N.has(o.id),g=v.get(o.id)??[],_=g.length>0;return e.jsx("button",{type:"button",className:`w-full text-left rounded-xl border bg-card transition-all active:scale-[0.98] ${u?"opacity-50 border-border":"border-border hover:border-border/80"}`,onClick:()=>h(o),children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`w-1 rounded-l-xl flex-shrink-0 ${u?"bg-muted-foreground/30":x?"bg-blue-500":"bg-amber-400"}`}),e.jsxs("div",{className:"flex-1 px-3 py-2.5 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:`text-sm font-bold tabular-nums ${u?"line-through text-muted-foreground":"text-foreground"}`,children:[L(o.start_time)," – ",L(o.end_time)]}),e.jsx("span",{className:`text-xs tabular-nums px-1.5 py-0.5 rounded-md font-medium ${x?"bg-blue-500/10 text-blue-600 dark:text-blue-400":"bg-amber-400/10 text-amber-600 dark:text-amber-400"}`,children:ot(o.start_time,o.end_time)})]}),_&&!u&&e.jsx(ge,{className:"h-3.5 w-3.5 text-orange-500 flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[e.jsx(ye,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:o.location})]}),o.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1.5",children:o.assignments.map(l=>e.jsxs("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded-md bg-muted text-muted-foreground",children:[l.group_name,l.coach_name?` · ${l.coach_name.split(" ")[0]}`:"",l.lane_count?` · ${l.lane_count}L`:""]},l.id))}),_&&!u&&e.jsx("div",{className:"mt-1.5 space-y-0.5",children:g.slice(0,2).map(l=>e.jsxs("div",{className:"flex items-center gap-1 text-[10px]",children:[e.jsxs("span",{className:`font-medium ${l.status==="cancelled"?"text-red-500":"text-orange-500"}`,children:[l.status==="cancelled"?"Annulé":"Modifié"," le"," ",new Date(l.override_date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})]}),l.reason&&e.jsxs("span",{className:"text-muted-foreground truncate",children:["— ",l.reason]})]},l.id))})]})]})},o.id)})})]})]})},Kt=({onBack:s,groups:r})=>{const{toast:i}=pe(),v=he(),[N,h]=c.useState(!1),[w,d]=c.useState(null),[F,S]=c.useState(null),[b,D]=c.useState(!1),[j,M]=c.useState(null),[o,x]=c.useState(!1),[u,g]=c.useState(()=>Te(new Date)),_=c.useMemo(()=>nt(u),[u]),l=c.useMemo(()=>{const t=new Date(u);return t.setDate(t.getDate()+6),t},[u]),T=c.useMemo(()=>Array.from({length:7},(t,a)=>{const p=new Date(u);return p.setDate(p.getDate()+a),p}),[u]),I=()=>g(t=>{const a=new Date(t);return a.setDate(a.getDate()-7),a}),z=()=>g(t=>{const a=new Date(t);return a.setDate(a.getDate()+7),a}),K=()=>g(Te(new Date)),[y,H]=c.useState("all"),{data:f=[],isLoading:W}=R({queryKey:["training-slots"],queryFn:()=>E.getTrainingSlots()}),{data:Q=[]}=R({queryKey:["training-slot-overrides"],queryFn:()=>E.getSlotOverrides()}),{data:G=[]}=R({queryKey:["users","coaches"],queryFn:()=>E.listUsers({role:"coach"})}),{data:$=[]}=R({queryKey:["athletes"],queryFn:()=>E.getAthletes()}),n=y.startsWith("swimmer:")?Number(y.split(":")[1]):null,{data:m}=R({queryKey:["swimmer-slots",n],queryFn:()=>E.getSwimmerSlots(n),enabled:n!=null}),{data:O}=R({queryKey:["swimmer-slots-exists",n],queryFn:()=>E.hasCustomSlots(n),enabled:n!=null}),U=c.useMemo(()=>m?m.map(t=>({id:t.id,day_of_week:t.day_of_week,start_time:t.start_time,end_time:t.end_time,location:t.location,is_active:t.is_active,created_by:t.created_by,created_at:t.created_at,assignments:[]})):[],[m]),P=c.useMemo(()=>{if(y==="all")return f;if(y.startsWith("group:")){const t=Number(y.split(":")[1]);return f.filter(a=>a.assignments.some(p=>p.group_id===t))}if(y.startsWith("coach:")){const t=Number(y.split(":")[1]);return f.filter(a=>a.assignments.some(p=>p.coach_id===t))}if(y.startsWith("swimmer:")){if(O&&U.length>0)return U;const t=$.find(a=>a.id===n);return t?.group_id?f.filter(a=>a.assignments.some(p=>p.group_id===t.group_id)):f}return f},[f,y,O,U,$,n]),we=c.useMemo(()=>{const t=new Map;for(let a=1;a<=7;a++)t.set(a,[]);for(const a of P)t.get(a.day_of_week).push(a);for(const a of t.values())a.sort((p,Pe)=>p.start_time.localeCompare(Pe.start_time));return t},[P]),Se=V(u),_e=V(l),ne=c.useMemo(()=>Q.filter(t=>t.override_date>=Se&&t.override_date<=_e),[Q,Se,_e]),oe=c.useMemo(()=>{const t=new Map;for(const a of ne){const p=t.get(a.slot_id)??[];p.push(a),t.set(a.slot_id,p)}return t},[ne]),Ce=c.useMemo(()=>{const t=new Set;for(const a of ne)a.status==="cancelled"&&t.add(a.slot_id);return t},[ne]),Ie=B({mutationFn:t=>E.deleteSlotOverride(t),onSuccess:()=>{i({title:"Exception supprimee"}),v.invalidateQueries({queryKey:["training-slot-overrides"]})},onError:t=>{i({title:"Erreur",description:t.message,variant:"destructive"})}}),de=()=>{d(null),h(!0)},ke=t=>{M(t),x(!0)},Oe=()=>{j&&(x(!1),d(j),h(!0))},qe=()=>{j&&(x(!1),S(j),D(!0))},ze=G.map(t=>({id:t.id,display_name:t.display_name})),He=f.length===0?"Planning hebdomadaire des entrainements.":`${f.length} creneau${f.length>1?"x":""}`;return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-10 w-10 -ml-2",onClick:s,children:e.jsx(me,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),f.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[f.length," créneau",f.length>1?"x":""," actif",f.length>1?"s":""]})]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:de,children:e.jsx(re,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(Re,{title:"Creneaux",description:He,onBack:s,actions:e.jsxs(k,{variant:"outline",size:"sm",onClick:de,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})})}),!W&&f.length>0&&e.jsx("div",{className:"sm:hidden",children:e.jsxs(J,{value:y,onValueChange:H,children:[e.jsx(X,{className:"w-full",children:e.jsx(Z,{placeholder:"Filtrer..."})}),e.jsxs(ee,{children:[e.jsx(A,{value:"all",children:"Tous les créneaux"}),e.jsx(Y,{}),r.map(t=>e.jsx(A,{value:`group:${t.id}`,children:t.name},t.id)),$.length>0&&e.jsx(Y,{}),$.map(t=>e.jsx(A,{value:`swimmer:${t.id}`,children:t.display_name},`swimmer:${t.id}`))]})]})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(k,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:I,children:e.jsx(me,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:K,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",_]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[te(u)," – ",te(l)]})]}),e.jsx(k,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:z,children:e.jsx($e,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-row items-center gap-3",children:e.jsxs(J,{value:y,onValueChange:H,children:[e.jsx(X,{className:"w-56",children:e.jsx(Z,{placeholder:"Filtrer..."})}),e.jsxs(ee,{children:[e.jsx(A,{value:"all",children:"Tous les créneaux"}),e.jsx(Y,{}),r.map(t=>e.jsx(A,{value:`group:${t.id}`,children:t.name},t.id)),G.length>0&&e.jsx(Y,{}),G.map(t=>e.jsx(A,{value:`coach:${t.id}`,children:t.display_name},t.id)),$.length>0&&e.jsx(Y,{}),$.map(t=>e.jsx(A,{value:`swimmer:${t.id}`,children:t.display_name},`swimmer:${t.id}`))]})]})})]}),W?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-28 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border overflow-hidden",children:Array.from({length:7},(t,a)=>e.jsxs("div",{className:"flex flex-col items-center py-2 gap-1",children:[e.jsx("div",{className:"h-3 w-6 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-5 rounded bg-muted/50 animate-pulse motion-reduce:animate-none mt-1"})]},a))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),Array.from({length:3},(t,a)=>e.jsx("div",{className:"h-20 rounded-xl bg-muted animate-pulse motion-reduce:animate-none"},a))]})]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(t,a)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},a))})]}):f.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(Ze,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(k,{variant:"outline",size:"sm",onClick:de,children:[e.jsx(re,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[n!=null&&O===!1&&e.jsx("div",{className:"rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/30 px-3 py-2 text-sm text-blue-700 dark:text-blue-300",children:"Ce nageur hérite des créneaux du groupe. Personnalisez depuis sa fiche."}),e.jsx("div",{className:"sm:hidden",children:e.jsx(dt,{slotsByDay:we,weekDates:T,todayStr:Ee(),overridesBySlot:oe,cancelledSlotIds:Ce,onSelect:ke,onPrevWeek:I,onNextWeek:z,weekNumber:_})}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",T.map((t,a)=>{const p=V(t)===Ee();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:le[a]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${p?"text-primary font-bold":"text-muted-foreground/60"}`,children:te(t)})]},a)}),e.jsx("div",{className:"relative",style:{height:Me},children:Fe.map(t=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(t-se)*ie},children:[t,"h"]},t))}),Array.from({length:7},(t,a)=>a+1).map(t=>{const a=we.get(t)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:Me},children:[Fe.map(p=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(p-se)*ie}},p)),a.map(p=>e.jsx(it,{slot:p,hasOverrides:(oe.get(p.id)??[]).length>0,cancelled:Ce.has(p.id),onSelect:ke},p.id))]},t)})]})})]}),e.jsx(lt,{slot:j,open:o,onOpenChange:x,overrides:j?oe.get(j.id)??[]:[],onEdit:Oe,onOverride:qe,onDeleteOverride:t=>Ie.mutate(t)}),e.jsx(rt,{open:N,onOpenChange:h,slot:w,groups:r,coaches:ze}),e.jsx(at,{open:b,onOpenChange:D,slot:F})]})};export{Kt as default};
