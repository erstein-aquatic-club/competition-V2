import{r,u as ee,c as re,d as te,j as t}from"./vendor-query-DyA9aSKS.js";import{C as le,a as ie}from"./CalendarGrid-0Ceg7DUe.js";import{a as T}from"./api-e21mt4C7.js";import{C as ce}from"./Coach-BCJKYurp.js";import{S as H,a as W,b as J,c as X,d as Z}from"./select-BNZb-H69.js";import{T as de,a as se}from"./toggle-group-D452TGEX.js";import{W as ue,D as me,B as ne,v as pe}from"./index-CSB2Cdyn.js";import{S as he,a as ge,b as xe,c as fe,d as ye}from"./sheet-CeMxITAT.js";import{I as Se}from"./InlineBanner-dMoPPgtW.js";import{C as be}from"./circle-alert-DSO0my_k.js";import{T as Me}from"./trash-2-BSeZWd8n.js";import"./vendor-react-BzrpNAyj.js";import"./chevron-left-Ba0igdaN.js";import"./chevron-right-1zqJKJ2X.js";import"./circle-C4mVLHzg.js";import"./swim-BszNSVMm.js";import"./target-C6Jkx9Y3.js";import"./bell-ring-RyfDIQC4.js";import"./clock-BAMrqpdw.js";import"./vendor-charts-BrQ8X25f.js";import"./index-aUKB5s89.js";import"./index-TDPhH-S8.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-DCX2sNhR.js";import"./chevron-down-DKXv3dxW.js";import"./chevron-up-BC2FkYKU.js";import"./index-BPjtHAcu.js";import"./vendor-motion-CMsaQ8FX.js";import"./index-Cme9gNRH.js";function ae(n){return String(n).padStart(2,"0")}function k(n){return`${n.getFullYear()}-${ae(n.getMonth()+1)}-${ae(n.getDate())}`}function U(n){return new Date(n.getFullYear(),n.getMonth(),1)}function oe(n,i){const S=new Date(n);return S.setDate(S.getDate()+i),S}function je(n){return(n.getDay()+6)%7}function E(n){if(!n)return"AM";const i=n.toLowerCase();return i==="evening"||i.includes("soir")||i==="pm"?"PM":"AM"}const De=[{key:"swim-morning",label:"Nage — Matin",type:"swim",scheduledSlot:"morning"},{key:"swim-evening",label:"Nage — Soir",type:"swim",scheduledSlot:"evening"},{key:"strength",label:"Musculation",type:"strength",scheduledSlot:null}];function we({groupId:n,userId:i,enabled:S}){const b=r.useMemo(()=>new Date,[]),[v,x]=r.useState(()=>U(new Date)),[M,f]=r.useState(()=>k(new Date)),[N,D]=r.useState(null),[_,w]=r.useState(!1),y=r.useMemo(()=>U(v),[v]),u=r.useMemo(()=>{const s=je(y),l=oe(y,-s),o=[];for(let d=0;d<42;d++)o.push(oe(l,d));return o},[y]),a=r.useMemo(()=>{const s=k(u[0]),l=k(u[u.length-1]);return{from:s,to:l}},[u]),m=!!(n||i),{data:F=[],isLoading:K}=ee({queryKey:["coach-calendar-assignments",n,i,a.from,a.to],queryFn:()=>T.getCoachAssignments({groupId:n??null,userId:i??null,from:a.from,to:a.to}),enabled:m}),h=r.useMemo(()=>{const s=new Map;for(const l of F){const o=l.scheduledDate?.slice(0,10);o&&(s.has(o)||s.set(o,[]),s.get(o).push(l))}return s},[F]),O=r.useMemo(()=>{const s={};for(const l of u){const o=k(l),d=h.get(o)??[],C=d.some(c=>E(c.scheduledSlot)==="AM"),e=d.some(c=>E(c.scheduledSlot)==="PM"),p=(C?1:0)+(e?1:0),g=[{slotKey:"AM",expected:C,completed:C,absent:!1},{slotKey:"PM",expected:e,completed:e,absent:!1}];s[o]={completed:p,total:p,slots:g}}return s},[u,h]),P=r.useMemo(()=>{const[s,l,o]=M.split("-").map(Number);return new Date(s,l-1,o)},[M]),I=r.useMemo(()=>h.get(M)??[],[h,M]),B=r.useMemo(()=>{const s=I;return De.map(l=>{const o=s.filter(e=>l.type!==e.type?!1:l.type==="swim"?E(e.scheduledSlot)===(l.scheduledSlot==="morning"?"AM":"PM"):!0),d=o.find(e=>e.targetType==="user"),C=o.find(e=>e.targetType==="group");return{...l,assignment:d??C??null}})},[I]),{data:A=[]}=ee({queryKey:["planned-absences-coach",i,a.from,a.to],queryFn:()=>T.getPlannedAbsences({userId:i,from:a.from,to:a.to}),enabled:!!i}),$=r.useMemo(()=>new Set(A.map(s=>s.date)),[A]),R=r.useMemo(()=>{const s={};for(const l of u){const o=k(l),d=h.get(o)??[];s[o]=d.some(C=>C.type==="strength")}return s},[u,h]),q=O[M]??{completed:0,total:0,slots:[{slotKey:"AM",expected:!1,completed:!1,absent:!1},{slotKey:"PM",expected:!1,completed:!1,absent:!1}]},G=r.useCallback(()=>{x(s=>new Date(s.getFullYear(),s.getMonth()-1,1))},[]),Y=r.useCallback(()=>{x(s=>new Date(s.getFullYear(),s.getMonth()+1,1))},[]),V=r.useCallback(()=>{x(U(new Date)),f(k(new Date))},[]),L=r.useCallback(s=>{f(s),w(!0)},[]);return{today:b,monthCursor:v,selectedISO:M,selectedDayIndex:N,drawerOpen:_,gridDates:u,completionByISO:O,selectedDate:P,selectedDayStatus:q,assignmentsForSelectedDay:I,slotsForSelectedDay:B,hasStrengthByISO:R,absenceDates:$,isLoading:K,hasFilter:m,setSelectedISO:f,setSelectedDayIndex:D,setDrawerOpen:w,prevMonth:G,nextMonth:Y,jumpToday:V,openDay:L}}function Ce(n){const[i,S,b]=n.split("-").map(Number);return new Date(i,S-1,b).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"})}function st({onBack:n,athletes:i,groups:S,swimSessions:b,strengthSessions:v}){const[x,M]=r.useState("group"),[f,N]=r.useState(""),[D,_]=r.useState(""),w=x==="group"&&f?Number(f):null,y=x==="user"&&D?Number(D):null,{today:u,monthCursor:a,selectedISO:m,selectedDayIndex:F,drawerOpen:K,gridDates:h,completionByISO:O,selectedDayStatus:P,slotsForSelectedDay:I,hasStrengthByISO:B,absenceDates:A,hasFilter:$,setSelectedISO:R,setSelectedDayIndex:q,setDrawerOpen:G,prevMonth:Y,nextMonth:V,jumpToday:L,openDay:s}=we({groupId:w,userId:y,enabled:!0}),l=re(),o=te({mutationFn:e=>T.assignments_create(e),onSuccess:()=>{l.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),d=te({mutationFn:e=>T.assignments_delete(e),onSuccess:()=>{l.invalidateQueries({queryKey:["coach-calendar-assignments"]})}}),C=(e,p)=>{let g=p;if(e.key==="ArrowLeft"&&(g=Math.max(0,p-1)),e.key==="ArrowRight"&&(g=Math.min(h.length-1,p+1)),e.key==="ArrowUp"&&(g=Math.max(0,p-7)),e.key==="ArrowDown"&&(g=Math.min(h.length-1,p+7)),g!==p){e.preventDefault(),q(g);const c=Q=>String(Q).padStart(2,"0"),j=h[g],z=`${j.getFullYear()}-${c(j.getMonth()+1)}-${c(j.getDate())}`;R(z)}if(e.key==="Enter"||e.key===" "){e.preventDefault();const c=Q=>String(Q).padStart(2,"0"),j=h[p],z=`${j.getFullYear()}-${c(j.getMonth()+1)}-${c(j.getDate())}`;s(z)}};return t.jsxs("div",{className:"space-y-4",children:[t.jsx(ce,{title:"Calendrier",description:"Vue mensuelle des assignations",onBack:n}),t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[t.jsxs(de,{type:"single",value:x,onValueChange:e=>{(e==="group"||e==="user")&&M(e)},className:"shrink-0",children:[t.jsx(se,{value:"group",className:"text-xs px-3",children:"Groupe"}),t.jsx(se,{value:"user",className:"text-xs px-3",children:"Nageur"})]}),x==="group"?t.jsxs(H,{value:f,onValueChange:N,children:[t.jsx(W,{className:"w-full sm:w-56",children:t.jsx(J,{placeholder:"Choisir un groupe"})}),t.jsx(X,{children:S.map(e=>t.jsx(Z,{value:String(e.id),children:e.name},String(e.id)))})]}):t.jsxs(H,{value:D,onValueChange:_,children:[t.jsx(W,{className:"w-full sm:w-56",children:t.jsx(J,{placeholder:"Choisir un nageur"})}),t.jsx(X,{children:i.filter(e=>e.id!=null).map(e=>t.jsxs(Z,{value:String(e.id),children:[e.display_name,e.group_label?` · ${e.group_label}`:""]},String(e.id)))})]})]}),$?t.jsxs("div",{className:"rounded-2xl border bg-card shadow-sm",children:[t.jsx(le,{monthCursor:a,selectedDayStatus:P,onPrevMonth:Y,onNextMonth:V,onJumpToday:L}),t.jsx(ie,{monthCursor:a,gridDates:h,completionByISO:O,strengthByISO:B,absenceDates:A,selectedISO:m,selectedDayIndex:F,today:u,onDayClick:s,onKeyDown:C})]}):t.jsx("div",{className:"py-12 text-center text-sm text-muted-foreground",children:"Sélectionnez un groupe ou un nageur pour afficher le calendrier."}),t.jsx(he,{open:K,onOpenChange:G,children:t.jsxs(ge,{side:"bottom",className:"max-h-[70vh] overflow-y-auto rounded-t-2xl",children:[t.jsxs(xe,{className:"pb-3",children:[t.jsx(fe,{className:"capitalize text-left",children:Ce(m)}),t.jsx(ye,{className:"sr-only",children:"Gérer les assignations pour cette journée"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(Se,{variant:"red",icon:t.jsx(be,{}),label:"Absence prévue",visible:A.has(m),animate:!1}),I.map(e=>{const p=e.assignment?.targetType==="group",g=x==="user";return t.jsx(ve,{slot:e,swimSessions:b,strengthSessions:v,isGroupAssignment:p&&g,onAssign:c=>{o.mutate({assignment_type:e.type,session_id:c,scheduled_date:m,scheduled_slot:e.scheduledSlot??void 0,target_group_id:w,target_user_id:y})},onDelete:c=>{d.mutate(c)},onReplace:(c,j)=>{p&&g?o.mutate({assignment_type:e.type,session_id:j,scheduled_date:m,scheduled_slot:e.scheduledSlot??void 0,target_user_id:y}):d.mutate(c,{onSuccess:()=>{o.mutate({assignment_type:e.type,session_id:j,scheduled_date:m,scheduled_slot:e.scheduledSlot??void 0,target_group_id:w,target_user_id:y})}})},isPending:o.isPending||d.isPending},e.key)})]})]})})]})}function ve({slot:n,swimSessions:i,strengthSessions:S,isGroupAssignment:b,onAssign:v,onDelete:x,onReplace:M,isPending:f}){const[N,D]=r.useState(!1),_=n.type==="swim",w=_?(i??[]).map(a=>({id:a.id,label:a.name})):(S??[]).map(a=>({id:a.id,label:a.title})),y=n.assignment!==null,u=a=>{const m=Number(a);m&&(y&&N?(M(n.assignment.id,m),D(!1)):v(m))};return t.jsxs("div",{className:"rounded-xl border p-3 space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[_?t.jsx(ue,{className:"h-4 w-4 text-blue-500 shrink-0"}):t.jsx(me,{className:"h-4 w-4 text-orange-500 shrink-0"}),t.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wide",children:n.label})]}),y&&!N?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("p",{className:"text-sm font-semibold truncate flex-1",children:[n.assignment.title,b&&t.jsx("span",{className:"ml-1.5 text-[10px] font-medium text-muted-foreground bg-muted px-1.5 py-0.5 rounded-full align-middle",children:"Groupe"})]}),t.jsx(ne,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0",disabled:f,onClick:()=>D(!0),title:b?"Personnaliser":"Changer",children:t.jsx(pe,{className:"h-3.5 w-3.5"})}),!b&&t.jsx(ne,{type:"button",size:"icon",variant:"ghost",className:"h-7 w-7 shrink-0 text-destructive hover:text-destructive",disabled:f,onClick:()=>x(n.assignment.id),title:"Supprimer",children:t.jsx(Me,{className:"h-3.5 w-3.5"})})]}):t.jsxs(H,{value:"",onValueChange:u,disabled:f||w.length===0,children:[t.jsx(W,{className:"h-9 text-xs",children:t.jsx(J,{placeholder:N?b?"Personnaliser pour ce nageur":"Choisir le remplacement":"Choisir une séance"})}),t.jsx(X,{children:w.map(a=>t.jsx(Z,{value:String(a.id),children:a.label},a.id))})]}),N?t.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-foreground",onClick:()=>D(!1),children:"Annuler"}):null]})}export{st as default};
