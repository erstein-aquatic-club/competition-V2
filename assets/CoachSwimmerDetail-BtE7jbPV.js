import{r as d,u as S,j as e,c as ge,d as $}from"./vendor-query-BiSH4r2z.js";import{c as bt,b as Ye,u as Ze,B as q,d as fe,L as R,I as Ce,s as et,X as Nt,a0 as tt,T as Te,a4 as vt}from"./index-B1RGpE9v.js";import{a as g}from"./api-BvP3ajaI.js";import{T as _t,a as wt,b as ye,c as be}from"./tabs-DQ8sIun2.js";import{B as z}from"./badge-DlT5y0S2.js";import{C as Ct}from"./chart-column-CpTM_4wq.js";import{C as kt}from"./chevron-down-DAlI01ET.js";import{T as Ae}from"./textarea-B5vknWqe.js";import{S as ee,a as te,b as se,c as ae,d as H}from"./select-CmtMsvq6.js";import{T as St,a as De}from"./toggle-group-BJYNJEER.js";import{S as Me,a as Le,b as Oe,c as Ke}from"./sheet-D60gobG_.js";import{A as le,a as ce,b as oe,c as de,d as me,e as ue,f as xe,g as pe}from"./alert-dialog-w1F8pdOd.js";import{T as ke,s as st,a as at,c as nt,d as Tt,S as rt,e as $e,f as he,b as Dt,F as Et,p as Ue,M as it,A as qt}from"./objectiveHelpers-Cyuy8ILO.js";import{P as ne}from"./plus-BryhlDD7.js";import{T as We}from"./trash-2-B986GPF2.js";import{w as lt,a as ct,S as Ve,G as ot}from"./weekTypeColor-HsBctnRH.js";import{t as qe}from"./date-NdbyDBh_.js";import{C as Ft}from"./copy-DWPF-dEn.js";import{C as Pt}from"./index-BH1a5ION.js";import{P as At}from"./pencil-DPEIR4eM.js";import{C as dt}from"./clock-CkMiyiJj.js";import{C as Mt}from"./circle-check-CZkrb68H.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./swim-CLUg5uAA.js";import"./index-eTE4ORFq.js";import"./index-D2gBeTzS.js";import"./index-BG7J5PnS.js";import"./chevron-up-oQ0K7fQ1.js";import"./index-BBkhEnbu.js";import"./format-B9mPVj_w.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M17 14h-6",key:"bkmgh3"}],["path",{d:"M13 18H7",key:"bb0bb7"}],["path",{d:"M7 14h.01",key:"1qa3f1"}],["path",{d:"M17 18h.01",key:"1bdyru"}]],mt=bt("calendar-range",Lt);function Ee(...t){return t.filter(Boolean).join(" ")}const Ot=[{key:"effort",label:"Diff.",mode:"hard"},{key:"feeling",label:"Fat.",mode:"hard"},{key:"performance",label:"Perf",mode:"good"},{key:"engagement",label:"Eng.",mode:"good"}];function Kt(t,a){const s=Number(a);if(!Number.isFinite(s)||s<1||s>5)return"bg-muted text-muted-foreground";const r=t==="hard"?6-s:s;return r>=4?"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400":r>=3?"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400":"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"}function $t({athleteId:t,athleteName:a}){const[,s]=Ye(),{setSelectedAthlete:r}=Ze(),[c,l]=d.useState(20),[n,m]=d.useState(null),[f,h]=d.useState(null),{data:v=[],isLoading:p}=S({queryKey:["sessions",t],queryFn:()=>g.getSessions(a,t)}),N=v.slice(0,c),T=v.length>c;if(p)return e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(j=>e.jsxs("div",{className:"rounded-2xl border bg-card p-3 animate-pulse motion-reduce:animate-none",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted mb-2"}),e.jsx("div",{className:"h-3 w-full rounded bg-muted"})]},j))});if(v.length===0)return e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun ressenti enregistre."});const x=()=>{r({id:t,name:a}),s("/progress")};return e.jsxs("div",{className:"space-y-2",children:[e.jsxs(q,{variant:"outline",size:"sm",className:"w-full text-xs gap-1.5",onClick:x,children:[e.jsx(Ct,{className:"h-3.5 w-3.5"}),"Voir la progression"]}),N.map(j=>{const k=n===j.id;return e.jsxs("button",{type:"button",onClick:()=>{h(null),m(k?null:j.id)},className:"w-full rounded-2xl border bg-card p-3 text-left hover:border-primary/20 transition-all",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:new Date(j.date).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}),e.jsx("span",{className:"text-xs text-muted-foreground ml-1.5",children:j.slot})]}),e.jsx("div",{className:"flex items-center gap-1",children:Ot.map(b=>{const D=j[b.key],y=`${j.id}-${b.key}`,u=f===y;return e.jsxs("span",{className:"relative group",onClick:w=>{w.stopPropagation(),h(u?null:y)},children:[e.jsx("span",{className:Ee("inline-flex items-center justify-center h-6 w-6 rounded-lg text-[10px] font-bold cursor-pointer",Kt(b.mode,D)),children:D??"â€”"}),e.jsx("span",{className:Ee("absolute -top-7 left-1/2 -translate-x-1/2 rounded-md bg-foreground text-background px-1.5 py-0.5 text-[9px] font-semibold whitespace-nowrap pointer-events-none transition-opacity","opacity-0 group-hover:opacity-100",u&&"opacity-100"),children:b.label})]},b.key)})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1.5",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:j.distance>0?`${j.distance}m`:"â€”"}),j.comments&&e.jsx(kt,{className:Ee("h-3.5 w-3.5 text-muted-foreground transition-transform",k&&"rotate-180")})]}),k&&j.comments&&e.jsx("div",{className:"mt-2 pt-2 border-t border-border",children:e.jsx("p",{className:"text-xs text-foreground whitespace-pre-wrap",children:j.comments})})]},j.id)}),T&&e.jsxs("button",{type:"button",onClick:j=>{j.stopPropagation(),l(k=>k+20)},className:"w-full rounded-2xl border border-dashed border-border py-2 text-xs font-medium text-muted-foreground hover:bg-muted transition",children:["Charger plus (",v.length-c," restants)"]})]})}async function Wt(t){const{data:a,error:s}=await et.rpc("get_auth_uid_for_user",{p_user_id:t});return s?(console.error("[objectives-tab] Failed to resolve auth UUID:",s.message),null):a}const Rt=({open:t,onOpenChange:a,objective:s,athleteName:r,athleteAuthId:c,competitions:l})=>{const{toast:n}=fe(),m=ge(),f=!!s,[h,v]=d.useState("chrono"),[p,N]=d.useState(""),[T,x]=d.useState("25"),[j,k]=d.useState(""),[b,D]=d.useState(""),[y,u]=d.useState(""),[w,_]=d.useState(!1);d.useEffect(()=>{if(t)if(s){const o=!!s.event_code,O=!!s.text;v(o&&O?"both":O?"texte":"chrono"),N(s.event_code??""),x(String(s.pool_length??25)),k(s.target_time_seconds!=null?he(s.target_time_seconds):""),D(s.text??""),u(s.competition_id??"")}else v("chrono"),N(""),x("25"),k(""),D(""),u("")},[t,s]);const F=$({mutationFn:o=>g.createObjective(o),onSuccess:()=>{n({title:"Objectif crÃ©Ã©"}),m.invalidateQueries({queryKey:["objectives",c]}),a(!1)},onError:o=>{n({title:"Erreur",description:o.message,variant:"destructive"})}}),P=$({mutationFn:o=>g.updateObjective(s.id,o),onSuccess:()=>{n({title:"Objectif mis Ã  jour"}),m.invalidateQueries({queryKey:["objectives",c]}),a(!1)},onError:o=>{n({title:"Erreur",description:o.message,variant:"destructive"})}}),A=$({mutationFn:()=>g.deleteObjective(s.id),onSuccess:()=>{n({title:"Objectif supprimÃ©"}),m.invalidateQueries({queryKey:["objectives",c]}),a(!1)},onError:o=>{n({title:"Erreur",description:o.message,variant:"destructive"})}}),M=h==="chrono"||h==="both",L=h==="texte"||h==="both",X=()=>{if(M&&!p){n({title:"Ã‰preuve requise",description:"Veuillez sÃ©lectionner une Ã©preuve.",variant:"destructive"});return}if(M&&j&&Ue(j)===null){n({title:"Format invalide",description:"Le temps doit Ãªtre au format m:ss:cc (ex: 1:05:30)",variant:"destructive"});return}if(L&&!b.trim()){n({title:"Texte requis",description:"Veuillez saisir un objectif texte.",variant:"destructive"});return}const o={athlete_id:c,competition_id:y&&y!=="none"?y:null,event_code:M?p:null,pool_length:M?Number(T):null,target_time_seconds:M&&j?Ue(j):null,text:L?b.trim():null};f?P.mutate(o):F.mutate(o)},U=F.isPending||P.isPending||A.isPending,K=d.useMemo(()=>{const o=new Date;return o.setHours(0,0,0,0),l.filter(O=>new Date(O.date+"T00:00:00").getTime()>=o.getTime())},[l]);return e.jsxs(e.Fragment,{children:[e.jsx(Me,{open:t,onOpenChange:a,children:e.jsxs(Le,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(Oe,{children:e.jsx(Ke,{children:f?"Modifier l'objectif":"Nouvel objectif"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Nageur"}),e.jsx("p",{className:"text-sm font-medium",children:r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Type d'objectif"}),e.jsxs(St,{type:"single",variant:"outline",value:h,onValueChange:o=>{o&&v(o)},className:"justify-start",children:[e.jsx(De,{value:"chrono",className:"text-xs",children:"Chrono"}),e.jsx(De,{value:"texte",className:"text-xs",children:"Texte"}),e.jsx(De,{value:"both",className:"text-xs",children:"Les deux"})]})]}),M&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Ã‰preuve *"}),e.jsxs(ee,{value:p,onValueChange:N,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Choisir une Ã©preuve"})}),e.jsx(ae,{children:Et.map(o=>e.jsx(H,{value:o,children:$e(o)},o))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Bassin"}),e.jsxs(ee,{value:T,onValueChange:x,children:[e.jsx(te,{children:e.jsx(se,{})}),e.jsxs(ae,{children:[e.jsx(H,{value:"25",children:"25m"}),e.jsx(H,{value:"50",children:"50m"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Temps cible (min:sec:centiÃ¨mes)"}),e.jsx(Ce,{placeholder:"Ex : 1:05:30",value:j,onChange:o=>k(o.target.value)})]})]}),L&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Objectif texte *"}),e.jsx(Ae,{placeholder:"Ex : AmÃ©liorer la coulÃ©e de dos",value:b,onChange:o=>D(o.target.value),rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Lier Ã  une compÃ©tition"}),e.jsxs(ee,{value:y,onValueChange:u,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Aucune"})}),e.jsxs(ae,{children:[e.jsx(H,{value:"none",children:"Aucune"}),K.map(o=>e.jsxs(H,{value:o.id,children:[o.name," (",o.date,")"]},o.id))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(q,{className:"w-full",onClick:X,disabled:U,children:U?"Enregistrement...":f?"Enregistrer":"CrÃ©er"}),f&&e.jsx(q,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>_(!0),disabled:U,children:"Supprimer cet objectif"})]})]})]})}),e.jsx(le,{open:w,onOpenChange:_,children:e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Supprimer l'objectif"}),e.jsx(me,{children:"Cette action est irrÃ©versible. L'objectif sera supprimÃ© dÃ©finitivement."})]}),e.jsxs(ue,{children:[e.jsx(xe,{children:"Annuler"}),e.jsx(pe,{onClick:()=>{A.mutate(),_(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})};function zt(t){const a=t.split("-");return a.length===3?`${a[2]}/${a[1]}/${a[0]}`:t}const It=({objective:t,performances:a,onEdit:s})=>{const r=t.event_code?st(t.event_code):null,c=r?rt[r]??"":"",l=t.event_code?at(a,t.event_code,t.pool_length):null;let n=null,m=null;l&&t.target_time_seconds!=null&&t.event_code&&(n=l.time-t.target_time_seconds,m=nt(l.time,t.target_time_seconds,t.event_code));const f=!!t.competition_name,h=t.competition_date?Tt(t.competition_date):null;return e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card p-3 text-sm space-y-1.5 transition-colors hover:bg-muted/50 ${c?`border-l-4 ${c}`:""}`,onClick:()=>s(t),children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ke,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0 flex items-center gap-1.5 flex-wrap",children:[t.event_code&&e.jsx("span",{className:"font-medium",children:$e(t.event_code)}),t.event_code&&t.pool_length&&e.jsxs("span",{className:"text-muted-foreground",children:["(",t.pool_length,"m)"]}),t.target_time_seconds!=null&&e.jsx("span",{className:"font-mono text-xs text-primary",children:he(t.target_time_seconds)})]}),e.jsx(We,{className:"h-3.5 w-3.5 text-muted-foreground/40 shrink-0"})]}),t.text&&e.jsx("p",{className:"text-muted-foreground text-xs pl-5 line-clamp-2",children:t.text}),t.event_code&&l&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:he(l.time)})]}),l.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",zt(l.date),")"]}),n!=null&&e.jsx("span",{className:n<=0?"text-emerald-600 font-medium":"text-amber-600",children:n<=0?"Objectif atteint !":`+${n.toFixed(2)}s`})]}),t.event_code&&!l&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"}),m!=null&&e.jsx("div",{className:"pl-5 pr-1",children:e.jsx("div",{className:"h-1.5 w-full rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all duration-500 ${Dt(m)}`,style:{width:`${Math.min(m,100)}%`}})})}),f&&e.jsx("div",{className:"pl-5",children:e.jsxs(z,{variant:"outline",className:"border-orange-300 text-orange-600 dark:text-orange-400 text-[10px] px-1.5 py-0",children:[t.competition_name,h!=null&&h>0&&e.jsxs("span",{className:"ml-1 font-bold",children:["J-",h]})]})})]})},Qt=({athleteId:t,athleteName:a})=>{const[s,r]=d.useState(!1),[c,l]=d.useState(null),{data:n,isLoading:m}=S({queryKey:["auth-uid",t],queryFn:()=>Wt(t),enabled:!!t}),{data:f=[]}=S({queryKey:["competitions"],queryFn:()=>g.getCompetitions()}),{data:h=[],isLoading:v}=S({queryKey:["objectives",n],queryFn:()=>g.getObjectives(n),enabled:!!n}),{data:p}=S({queryKey:["profile",t],queryFn:()=>g.getProfile({userId:t}),enabled:!!t}),N=p?.ffn_iuf??null,T=d.useMemo(()=>{const y=new Date;return y.setDate(y.getDate()-360),y.toISOString().slice(0,10)},[]),{data:x=[]}=S({queryKey:["swimmer-performances-recent",N],queryFn:()=>g.getSwimmerPerformances({iuf:N,fromDate:T}),enabled:!!N}),j=()=>{l(null),r(!0)},k=y=>{l(y),r(!0)},b=m,D=!!n&&!m;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(q,{variant:"outline",size:"sm",onClick:j,disabled:!n,children:[e.jsx(ne,{className:"mr-1.5 h-3.5 w-3.5"}),"Ajouter un objectif"]})}),b&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-12 rounded bg-muted"})]})},y))}),D&&v&&e.jsx("div",{className:"space-y-2",children:[1,2].map(y=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-16 rounded bg-muted"})]})},y))}),D&&!v&&h.length===0&&e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(ke,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun objectif dÃ©fini pour ",a,"."]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:j,children:[e.jsx(ne,{className:"mr-1.5 h-3.5 w-3.5"}),"CrÃ©er le premier objectif"]})]}),D&&!v&&h.length>0&&e.jsxs("div",{className:"space-y-2",children:[h.map(y=>e.jsx(It,{objective:y,performances:x,onEdit:k},y.id)),e.jsx("p",{className:"text-[10px] text-muted-foreground/60 italic text-center pt-1",children:"Les temps Â« Actuel Â» correspondent Ã  la meilleure performance des 360 derniers jours sur l'Ã©preuve."})]}),n&&e.jsx(Rt,{open:s,onOpenChange:r,objective:c,athleteName:a,athleteAuthId:n,competitions:f})]})},Fe="__today__";function Pe(t,a){const s=[],r=new Date(t+"T00:00:00"),c=new Date(a+"T00:00:00"),l=new Date(r),n=l.getDay(),m=n===0?1:n===1?0:8-n;for(l.setDate(l.getDate()+m);l<=c;)s.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return s}function ie(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function Ne(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Ut(t){const a=new Date(t+"T00:00:00");return a.setDate(a.getDate()+6),a.toISOString().split("T")[0]}function Vt(t){const a=new Date;a.setHours(0,0,0,0);const s=new Date(t+"T00:00:00"),r=new Date(t+"T00:00:00");return r.setDate(r.getDate()+6),a>=s&&a<=r}const Bt=({athleteId:t})=>{const{toast:a}=fe(),s=ge(),[r,c]=d.useState(null),[l,n]=d.useState(null),[m,f]=d.useState(""),[h,v]=d.useState(""),[p,N]=d.useState(!1),[T,x]=d.useState(!1),[j,k]=d.useState(!1),[b,D]=d.useState(""),[y,u]=d.useState(""),[w,_]=d.useState(""),{data:F=[]}=S({queryKey:["athletes"],queryFn:()=>g.getAthletes()}),P=d.useMemo(()=>F.find(C=>C.id===t)?.group_id??null,[F,t]),{data:A=[],isLoading:M}=S({queryKey:["training-cycles","athlete",t],queryFn:()=>g.getTrainingCycles({athleteId:t})}),{data:L=[],isLoading:X}=S({queryKey:["training-cycles","group",P],queryFn:()=>g.getTrainingCycles({groupId:P}),enabled:P!=null}),U=A.length===0&&L.length>0,K=A.length>0?A:L;d.useEffect(()=>{K.length>0&&(!r||!K.find(i=>i.id===r))&&c(K[0].id)},[K,r]);const o=K.find(i=>i.id===r)??null,{data:O=[],isLoading:je}=S({queryKey:["training-weeks",r],queryFn:()=>g.getTrainingWeeks(r),enabled:!!r}),{data:B=[]}=S({queryKey:["competitions"],queryFn:()=>g.getCompetitions()}),Z=d.useMemo(()=>[...B].sort((i,C)=>i.date.localeCompare(C.date)),[B]),G=d.useMemo(()=>{const i=new Set;return O.forEach(C=>{C.week_type&&i.add(C.week_type)}),Array.from(i).sort()},[O]),E=o?.start_competition_date??o?.start_date??null,xt=d.useMemo(()=>{if(!o)return[];const i=E,C=o.end_competition_date;return!i||!C?[]:Pe(i,C)},[o,E]),pt=d.useMemo(()=>{const i=new Map;return O.forEach(C=>i.set(C.week_start,C)),i},[O]),Re=M||X,Se=$({mutationFn:async i=>{const C=await g.createTrainingCycle(i),W=i.start_date??B.find(Q=>Q.id===i.start_competition_id)?.date,I=B.find(Q=>Q.id===i.end_competition_id);if(W&&I){const Q=Pe(W,I.date);Q.length>0&&await g.bulkUpsertTrainingWeeks(Q.map(re=>({cycle_id:C.id,week_start:re})))}return C},onSuccess:i=>{a({title:"Cycle cree"}),c(i.id),N(!1),D(""),u(""),_(""),s.invalidateQueries({queryKey:["training-cycles"]}),s.invalidateQueries({queryKey:["training-weeks",i.id]})},onError:i=>{a({title:"Erreur",description:i.message,variant:"destructive"})}}),ht=$({mutationFn:i=>g.deleteTrainingCycle(i),onSuccess:()=>{a({title:"Cycle supprime"}),c(null),x(!1),s.invalidateQueries({queryKey:["training-cycles"]})},onError:i=>{a({title:"Erreur",description:i.message,variant:"destructive"})}}),ze=$({mutationFn:i=>g.upsertTrainingWeek(i),onSuccess:()=>{n(null),s.invalidateQueries({queryKey:["training-weeks",r]})},onError:i=>{a({title:"Erreur",description:i.message,variant:"destructive"})}}),Ie=$({mutationFn:async()=>{for(const i of L){const C=await g.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:i.start_competition_id,end_competition_id:i.end_competition_id,name:i.name,notes:i.notes}),W=await g.getTrainingWeeks(i.id);W.length>0&&await g.bulkUpsertTrainingWeeks(W.map(I=>({cycle_id:C.id,week_start:I.week_start,week_type:I.week_type,notes:I.notes})))}},onSuccess:()=>{a({title:"Planification personnalisee"}),k(!1),c(null),s.invalidateQueries({queryKey:["training-cycles"]})},onError:i=>{a({title:"Erreur",description:i.message,variant:"destructive"})}}),Qe=()=>{if(!b.trim()){a({title:"Nom requis",variant:"destructive"});return}if(!y||!w){a({title:"Dates requises",description:"Selectionnez le debut et la fin du cycle.",variant:"destructive"});return}const i=y===Fe,C=i?qe(new Date):null,W=i?null:B.find(re=>re.id===y),I=B.find(re=>re.id===w),Q=i?C:W?.date;if(Q&&I&&I.date<=Q){a({title:"Dates invalides",description:"La competition de fin doit etre apres la date de debut.",variant:"destructive"});return}Se.mutate({athlete_id:t,group_id:null,start_competition_id:i?null:y,end_competition_id:w,start_date:C,name:b.trim()})},gt=i=>{n(i.id),f(i.week_type??""),v(i.notes??"")},ft=i=>{n(`new:${i}`),f(""),v("")},jt=(i,C)=>{r&&ze.mutate({cycle_id:r,week_start:i,week_type:m.trim()||null,notes:h.trim()||null})},yt=()=>{n(null)};return!Re&&K.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(mt,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun cycle de planification."}),e.jsxs(q,{variant:"outline",size:"sm",onClick:()=>N(!0),children:[e.jsx(ne,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau cycle"]}),e.jsx(Be,{open:p,onOpenChange:N,competitions:Z,name:b,setName:D,startId:y,setStartId:u,endId:w,setEndId:_,onSubmit:Qe,isPending:Se.isPending})]}):Re?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(i=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsx("div",{className:"h-4 w-48 rounded bg-muted"})},i))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[K.length>1?e.jsxs(ee,{value:r??"",onValueChange:c,children:[e.jsx(te,{className:"w-auto min-w-[180px] h-8 text-sm",children:e.jsx(se,{placeholder:"Choisir un cycle"})}),e.jsx(ae,{children:K.map(i=>e.jsx(H,{value:i.id,children:i.name},i.id))})]}):o?e.jsx("span",{className:"text-sm font-semibold",children:o.name}):null,U&&e.jsx(z,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Planif. groupe"}),e.jsx("div",{className:"flex-1"}),U&&e.jsxs(q,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>k(!0),children:[e.jsx(Ft,{className:"mr-1 h-3 w-3"}),"Personnaliser"]}),e.jsxs(q,{variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>N(!0),children:[e.jsx(ne,{className:"mr-1 h-3 w-3"}),"Nouveau"]}),o&&!U&&e.jsx(q,{variant:"ghost",size:"sm",className:"text-xs h-7 text-destructive hover:text-destructive",onClick:()=>x(!0),children:e.jsx(We,{className:"h-3 w-3"})})]}),o&&e.jsxs("div",{className:"space-y-0",children:[e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:o.start_competition_id?"ðŸŠ":"ðŸ“…"}),e.jsx("span",{className:"text-sm font-medium",children:o.start_competition_id?o.start_competition_name??"Competition":"Debut du cycle"}),E&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",ie(E),")"]})]}),e.jsx("div",{className:"relative ml-3 border-l-2 border-border pl-4 space-y-1",children:je?e.jsx("div",{className:"py-4",children:e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"})}):xt.map((i,C)=>{const W=pt.get(i),I=Vt(i),Q=l===(W?.id??`new:${i}`);return e.jsx(Gt,{monday:i,weekNumber:C+1,week:W,isCurrent:I,isEditing:Q,isGroupPlan:U,editWeekType:m,setEditWeekType:f,editWeekNotes:h,setEditWeekNotes:v,existingWeekTypes:G,onStartEdit:()=>W?gt(W):ft(i),onSave:()=>jt(i),onCancel:yt,isSaving:ze.isPending},i)})}),e.jsxs("div",{className:"flex items-center gap-2 py-2 px-1",children:[e.jsx("span",{className:"text-base","aria-hidden":"true",children:"ðŸŽ¯"}),e.jsx("span",{className:"text-sm font-medium",children:o.end_competition_name??"Competition"}),o.end_competition_date&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",ie(o.end_competition_date),")"]})]})]}),e.jsx(Be,{open:p,onOpenChange:N,competitions:Z,name:b,setName:D,startId:y,setStartId:u,endId:w,setEndId:_,onSubmit:Qe,isPending:Se.isPending}),e.jsx(le,{open:T,onOpenChange:x,children:e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Supprimer le cycle"}),e.jsx(me,{children:"Cette action est irreversible. Le cycle et toutes ses semaines seront supprimes."})]}),e.jsxs(ue,{children:[e.jsx(xe,{children:"Annuler"}),e.jsx(pe,{onClick:()=>r&&ht.mutate(r),className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(le,{open:j,onOpenChange:k,children:e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Personnaliser la planification"}),e.jsx(me,{children:"Les cycles du groupe seront copies en tant que planification individuelle pour ce nageur. Vous pourrez ensuite les modifier independamment."})]}),e.jsxs(ue,{children:[e.jsx(xe,{children:"Annuler"}),e.jsx(pe,{onClick:()=>Ie.mutate(),children:Ie.isPending?"Copie...":"Personnaliser"})]})]})})]})},Gt=({monday:t,weekNumber:a,week:s,isCurrent:r,isEditing:c,isGroupPlan:l,editWeekType:n,setEditWeekType:m,editWeekNotes:f,setEditWeekNotes:h,existingWeekTypes:v,onStartEdit:p,onSave:N,onCancel:T,isSaving:x})=>{const j=Ut(t),k=`week-types-${t}`;return c?e.jsxs("div",{className:`rounded-lg border bg-card p-3 space-y-2 ${r?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground",children:["Sem. ",a," (",Ne(t)," - ",Ne(j),")"]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(R,{className:"text-xs",children:"Type de semaine"}),e.jsx(Ce,{className:"h-7 text-sm",placeholder:"Ex : Foncier, Affutage, Recup...",list:k,value:n,onChange:b=>m(b.target.value)}),e.jsx("datalist",{id:k,children:v.map(b=>e.jsx("option",{value:b},b))})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(R,{className:"text-xs",children:"Notes"}),e.jsx(Ae,{className:"text-sm min-h-[48px]",placeholder:"Notes optionnelles...",rows:2,value:f,onChange:b=>h(b.target.value)})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(q,{variant:"ghost",size:"sm",className:"h-7 text-xs",onClick:T,children:[e.jsx(Nt,{className:"mr-1 h-3 w-3"}),"Annuler"]}),e.jsxs(q,{size:"sm",className:"h-7 text-xs",onClick:N,disabled:x,children:[e.jsx(Pt,{className:"mr-1 h-3 w-3"}),x?"...":"Enregistrer"]})]})]}):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg border bg-card px-3 py-2 flex items-center gap-2 transition-colors ${l?"cursor-default":"hover:bg-muted/50"} ${r?"ring-2 ring-primary":""}`,onClick:l?void 0:p,disabled:l,children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"text-xs font-medium text-muted-foreground whitespace-nowrap",children:["Sem. ",a]}),e.jsxs("span",{className:"text-[10px] text-muted-foreground/70 whitespace-nowrap",children:["(",Ne(t)," - ",Ne(j),")"]}),s?.week_type&&e.jsx(z,{className:"text-[10px] px-1.5 py-0 border-0",style:{backgroundColor:ct(s.week_type),color:lt(s.week_type)},children:s.week_type})]}),s?.notes&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:s.notes})]}),!l&&e.jsx(At,{className:"h-3 w-3 text-muted-foreground/40 shrink-0"})]})},Be=({open:t,onOpenChange:a,competitions:s,name:r,setName:c,startId:l,setStartId:n,endId:m,setEndId:f,onSubmit:h,isPending:v})=>(d.useEffect(()=>{t&&(c(""),n(""),f(""))},[t]),e.jsx(Me,{open:t,onOpenChange:a,children:e.jsxs(Le,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsx(Oe,{children:e.jsx(Ke,{children:"Nouveau cycle"})}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Nom du cycle *"}),e.jsx(Ce,{placeholder:"Ex : Preparation hiver",value:r,onChange:p=>c(p.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Date de debut *"}),e.jsxs(ee,{value:l,onValueChange:n,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Choisir..."})}),e.jsxs(ae,{children:[e.jsxs(H,{value:Fe,children:["Aujourd'hui (",ie(qe(new Date)),")"]}),s.map(p=>e.jsxs(H,{value:p.id,children:[p.name," (",ie(p.date),")"]},p.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(R,{children:"Competition de fin *"}),e.jsxs(ee,{value:m,onValueChange:f,children:[e.jsx(te,{children:e.jsx(se,{placeholder:"Choisir..."})}),e.jsx(ae,{children:s.map(p=>e.jsxs(H,{value:p.id,children:[p.name," (",ie(p.date),")"]},p.id))})]})]}),l&&m&&(()=>{const N=l===Fe?qe(new Date):s.find(x=>x.id===l)?.date,T=s.find(x=>x.id===m);if(N&&T&&T.date>N){const x=Pe(N,T.date).length;return e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x," semaine",x>1?"s":""," seront generees."]})}return null})(),e.jsx(q,{className:"w-full",onClick:h,disabled:v,children:v?"Creation...":"Creer le cycle"})]})]})}));function J(t){return new Date(t+"T12:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"})}function ve(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Ht(t){const a=new Date(t+"T00:00:00");return a.setDate(a.getDate()+6),a.toISOString().split("T")[0]}function Jt(t){const a=new Date;a.setHours(0,0,0,0);const s=new Date(t+"T00:00:00"),r=new Date(t+"T00:00:00");return r.setDate(r.getDate()+6),a>=s&&a<=r}function Ge(t,a){const s=[],r=new Date(t+"T00:00:00"),c=new Date(a+"T00:00:00"),l=new Date(r),n=l.getDay(),m=n===0?1:n===1?0:8-n;for(l.setDate(l.getDate()+m);l<=c;)s.push(l.toISOString().split("T")[0]),l.setDate(l.getDate()+7);return s}function Xt(t,a){const s=new Date(t+"T00:00:00"),r=new Date(a+"T00:00:00");return Math.round((r.getTime()-s.getTime())/(1e3*60*60*24))}const Yt={draft_athlete:{label:"En attente nageur",variant:"secondary",className:"bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300 border-amber-200 dark:border-amber-800"},draft_coach:{label:"PrÃ©paration coach",variant:"secondary",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300 border-blue-200 dark:border-blue-800"},sent:{label:"EnvoyÃ©",variant:"secondary",className:"bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300 border-green-200 dark:border-green-800"},signed:{label:"SignÃ©",variant:"secondary",className:"bg-slate-100 text-slate-600 dark:bg-slate-800/40 dark:text-slate-300 border-slate-200 dark:border-slate-700"}};function ut(t){const a=Yt[t];return e.jsx(z,{variant:a.variant,className:`text-[10px] px-1.5 py-0 ${a.className}`,children:a.label})}function Zt(t){const a=[t.athlete_successes,t.athlete_difficulties,t.athlete_goals,t.athlete_commitments,t.coach_review,t.coach_objectives,t.coach_actions];for(const s of a)if(s&&s.trim())return s.trim();return null}async function es(t){const{data:a,error:s}=await et.rpc("get_auth_uid_for_user",{p_user_id:t});return s?(console.error("[interviews-tab] Failed to resolve auth UUID:",s.message),null):a}const Y=({label:t,text:a})=>e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(tt,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:a?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),_e=({label:t,text:a})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ot,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:a?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),we=({label:t,value:a,onChange:s,placeholder:r,rows:c=3})=>e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ot,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t})]}),e.jsx(Ae,{className:"bg-white dark:bg-background",placeholder:r,value:a,onChange:l=>s(l.target.value),rows:c})]}),V=({label:t})=>e.jsxs("div",{className:"flex items-center gap-2 pt-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:t}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),He=({objective:t,performances:a=[]})=>{const s=!!t.event_code,r=!!t.text,c=s?st(t.event_code):null,l=c?rt[c]??"":"",n=s?at(a,t.event_code,t.pool_length):null;let m=null;return n&&t.target_time_seconds!=null&&t.event_code&&(m=n.time-t.target_time_seconds,nt(n.time,t.target_time_seconds,t.event_code)),e.jsxs("div",{className:`rounded-lg border bg-card p-2.5 text-sm space-y-1 ${s?`border-l-4 ${l}`:""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ke,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx("span",{className:"font-medium",children:s?$e(t.event_code):""}),t.pool_length&&e.jsxs(z,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:[t.pool_length,"m"]}),t.target_time_seconds!=null&&e.jsx(z,{variant:"outline",className:"text-[10px] px-1.5 py-0 font-mono",children:he(t.target_time_seconds)})]}),r&&e.jsx("p",{className:"text-muted-foreground line-clamp-2 pl-5",children:t.text}),n&&e.jsxs("div",{className:"flex items-center gap-2 pl-5 text-xs text-muted-foreground flex-wrap",children:[e.jsxs("span",{children:["Actuel : ",e.jsx("span",{className:"font-mono",children:he(n.time)})]}),n.date&&e.jsxs("span",{className:"text-muted-foreground/60",children:["(",J(n.date),")"]}),m!=null&&e.jsx("span",{className:m<=0?"text-emerald-600 font-medium":"text-amber-600",children:m<=0?"Objectif atteint !":`+${m.toFixed(2)}s`})]}),!n&&s&&t.target_time_seconds!=null&&e.jsx("p",{className:"text-[10px] text-muted-foreground italic pl-5",children:"Pas encore de temps enregistrÃ©"})]})},Je=({prevInterview:t})=>e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Bilan du cycle prÃ©cÃ©dent"}),e.jsx(z,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:J(t.date)})]}),t.athlete_commitments&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Engagements nageur"}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.athlete_commitments})]}),t.coach_actions&&e.jsxs("div",{className:"border-l-4 border-amber-400 rounded-r-lg bg-amber-50/50 dark:bg-amber-950/20 p-3 space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Actions coach"}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.coach_actions})]}),t.athlete_commitment_review&&e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/80 dark:bg-blue-950/30 p-3 space-y-1",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground",children:"Bilan du nageur"}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:t.athlete_commitment_review})]}),!t.athlete_commitments&&!t.coach_actions&&e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"Aucun engagement enregistrÃ©."})]}),Xe=({athleteId:t,interviewDate:a})=>{const{toast:s}=fe(),r=ge(),{data:c=[]}=S({queryKey:["competitions"],queryFn:()=>g.getCompetitions()}),{data:l=[]}=S({queryKey:["my-competition-ids",t],queryFn:()=>g.getMyCompetitionIds(t)}),n=d.useMemo(()=>{const u=new Set(l);return c.filter(_=>u.has(_.id)&&_.date>=a).sort((_,F)=>_.date.localeCompare(F.date))[0]??null},[c,l,a]),{data:m=[]}=S({queryKey:["training-cycles","athlete",t],queryFn:()=>g.getTrainingCycles({athleteId:t})}),f=d.useMemo(()=>n?m.find(u=>u.end_competition_id===n.id||u.end_competition_date&&u.end_competition_date>=a)??null:null,[m,n,a]),{data:h=[]}=S({queryKey:["training-weeks",f?.id],queryFn:()=>g.getTrainingWeeks(f.id),enabled:!!f}),[v,p]=d.useState(null),[N,T]=d.useState(""),x=d.useMemo(()=>{const u=new Set;return h.forEach(w=>{w.week_type&&u.add(w.week_type)}),Array.from(u).sort()},[h]),j=d.useMemo(()=>{const u=new Map;return h.forEach(w=>u.set(w.week_start,w)),u},[h]),k=d.useMemo(()=>{if(!n)return[];const u=a,w=n.date;return Ge(u,w)},[n,a]),b=n?Xt(new Date().toISOString().split("T")[0],n.date):null,D=$({mutationFn:async()=>{if(!n)throw new Error("Pas de compÃ©tition");const w=c.filter(P=>P.date<=a).sort((P,A)=>A.date.localeCompare(P.date))[0]??n,_=await g.createTrainingCycle({athlete_id:t,group_id:null,start_competition_id:w.id,end_competition_id:n.id,name:`PrÃ©paration ${n.name}`}),F=Ge(a,n.date);return F.length>0&&await g.bulkUpsertTrainingWeeks(F.map(P=>({cycle_id:_.id,week_start:P}))),_},onSuccess:()=>{s({title:"Planification crÃ©Ã©e"}),r.invalidateQueries({queryKey:["training-cycles"]}),r.invalidateQueries({queryKey:["training-weeks"]})},onError:u=>{s({title:"Erreur",description:u.message,variant:"destructive"})}}),y=$({mutationFn:u=>g.upsertTrainingWeek(u),onSuccess:()=>{p(null),r.invalidateQueries({queryKey:["training-weeks",f?.id]})},onError:u=>{s({title:"Erreur",description:u.message,variant:"destructive"})}});return n?f?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(Te,{className:"h-4 w-4 text-amber-500 shrink-0"}),e.jsx("span",{className:"font-medium",children:n.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",J(n.date),")"]}),b!=null&&e.jsxs(z,{variant:"secondary",className:"text-[10px]",children:["J-",b]})]}),e.jsx("div",{className:"relative ml-2 border-l-2 border-border pl-3 space-y-1",children:k.map((u,w)=>{const _=j.get(u),F=Jt(u),P=v===u,A=Ht(u),M=`inline-week-${u}`;return P?e.jsxs("div",{className:`rounded-lg border bg-card p-2 space-y-1.5 ${F?"ring-2 ring-primary":""}`,children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Sem. ",w+1," (",ve(u)," - ",ve(A),")"]}),e.jsx(Ce,{className:"h-7 text-sm",placeholder:"Foncier, Techni., AffÃ»tage...",list:M,value:N,onChange:L=>T(L.target.value)}),e.jsx("datalist",{id:M,children:x.map(L=>e.jsx("option",{value:L},L))}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(q,{variant:"ghost",size:"sm",className:"h-6 text-xs px-2",onClick:()=>p(null),children:"Annuler"}),e.jsx(q,{size:"sm",className:"h-6 text-xs px-2",onClick:()=>{f&&y.mutate({cycle_id:f.id,week_start:u,week_type:N.trim()||null})},disabled:y.isPending,children:"OK"})]})]},u):e.jsxs("button",{type:"button",className:`w-full text-left rounded-lg px-2 py-1.5 flex items-center gap-2 text-xs transition-colors hover:bg-muted/50 ${F?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>{p(u),T(_?.week_type??"")},children:[e.jsx("span",{className:`h-2 w-2 rounded-full shrink-0 ${F?"bg-primary":_?.week_type?"bg-muted-foreground/40":"bg-muted-foreground/20"}`}),e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["Sem. ",w+1]}),e.jsxs("span",{className:"text-muted-foreground/60 whitespace-nowrap",children:[ve(u)," - ",ve(A)]}),_?.week_type&&e.jsx(z,{className:"text-[10px] px-1.5 py-0 border-0 ml-auto",style:{backgroundColor:ct(_.week_type),color:lt(_.week_type)},children:_.week_type})]},u)})}),e.jsxs("div",{className:"flex items-center gap-2 ml-2 pl-3 text-xs",children:[e.jsx(Te,{className:"h-3.5 w-3.5 text-amber-500"}),e.jsx("span",{className:"font-semibold",children:n.name})]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Te,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"font-medium",children:n.name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",J(n.date),")"]}),b!=null&&e.jsxs(z,{variant:"secondary",className:"text-[10px]",children:["J-",b]})]}),e.jsx(q,{variant:"outline",size:"sm",className:"w-full text-xs",onClick:()=>D.mutate(),disabled:D.isPending,children:D.isPending?"CrÃ©ation...":"CrÃ©er la planification"})]}):e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-xs text-muted-foreground italic",children:"Aucune compÃ©tition assignÃ©e Ã  venir â€” planification non disponible."})})},ts=({open:t,onOpenChange:a,interview:s,athleteId:r,athleteAuthId:c})=>{const{toast:l}=fe(),n=ge(),[m,f]=d.useState(""),[h,v]=d.useState(""),[p,N]=d.useState(""),[T,x]=d.useState(""),[j,k]=d.useState(""),[b,D]=d.useState(""),[y,u]=d.useState(!1),[w,_]=d.useState(!1),[F,P]=d.useState(null);t&&s&&s.id!==F&&(f(s.coach_comment_successes??""),v(s.coach_comment_difficulties??""),N(s.coach_comment_goals??""),x(s.coach_review??""),k(s.coach_objectives??""),D(s.coach_actions??""),P(s.id)),!t&&F!==null&&P(null);const{data:A}=S({queryKey:["previous-interview",r,s?.date,s?.id],queryFn:()=>g.getPreviousInterview(r,s.date,s.id),enabled:!!s?.date}),{data:M=[]}=S({queryKey:["objectives",c],queryFn:()=>g.getObjectives(c),enabled:!!c}),{data:L}=S({queryKey:["athlete-profile",r],queryFn:()=>g.getProfile({userId:r}),enabled:!!r}),X=L?.ffn_iuf??null,U=d.useMemo(()=>{const E=new Date;return E.setDate(E.getDate()-360),E.toISOString().slice(0,10)},[]),{data:K=[]}=S({queryKey:["swimmer-performances-recent",X],queryFn:()=>g.getSwimmerPerformances({iuf:X,fromDate:U}),enabled:!!X}),o=()=>({coach_comment_successes:m.trim()||null,coach_comment_difficulties:h.trim()||null,coach_comment_goals:p.trim()||null,coach_review:T.trim()||null,coach_objectives:j.trim()||null,coach_actions:b.trim()||null}),O=$({mutationFn:()=>g.updateInterviewCoachSections(s.id,o()),onSuccess:()=>{l({title:"EnregistrÃ©"}),n.invalidateQueries({queryKey:["interviews",r]})},onError:E=>{l({title:"Erreur",description:E.message,variant:"destructive"})}}),je=$({mutationFn:async()=>(await g.updateInterviewCoachSections(s.id,o()),g.sendInterviewToAthlete(s.id)),onSuccess:()=>{l({title:"Entretien envoyÃ© au nageur"}),n.invalidateQueries({queryKey:["interviews",r]}),a(!1)},onError:E=>{l({title:"Erreur",description:E.message,variant:"destructive"})}}),B=$({mutationFn:()=>g.deleteInterview(s.id),onSuccess:()=>{l({title:"Entretien supprimÃ©"}),n.invalidateQueries({queryKey:["interviews",r]}),a(!1)},onError:E=>{l({title:"Erreur",description:E.message,variant:"destructive"})}}),Z=O.isPending||je.isPending||B.isPending;if(!s)return null;const G=s.status;return e.jsxs(e.Fragment,{children:[e.jsx(Me,{open:t,onOpenChange:a,children:e.jsxs(Le,{side:"right",className:"w-full sm:max-w-lg overflow-y-auto",children:[e.jsx(Oe,{children:e.jsxs(Ke,{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{children:["Entretien du ",J(s.date)]}),ut(G)]})}),e.jsxs("div",{className:"mt-6 space-y-5",children:[G==="draft_athlete"&&e.jsxs("div",{className:"rounded-xl border border-dashed border-amber-300 bg-amber-50/50 dark:bg-amber-950/20 p-6 text-center space-y-2",children:[e.jsx(dt,{className:"h-8 w-8 mx-auto text-amber-500"}),e.jsx("p",{className:"text-sm font-medium",children:"En attente de la prÃ©paration du nageur"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Le contenu n'est pas encore visible. Le nageur doit d'abord remplir ses sections."})]}),G==="draft_coach"&&e.jsxs(e.Fragment,{children:[A&&e.jsx(Je,{prevInterview:A}),e.jsx(V,{label:"RÃ©ussites"}),e.jsx(Y,{label:"Nageur",text:s.athlete_successes}),e.jsx(we,{label:"Coach",value:m,onChange:f,placeholder:"Votre commentaire sur les rÃ©ussites..."}),e.jsx(V,{label:"DifficultÃ©s"}),e.jsx(Y,{label:"Nageur",text:s.athlete_difficulties}),e.jsx(we,{label:"Coach",value:h,onChange:v,placeholder:"Votre commentaire sur les difficultÃ©s..."}),e.jsx(V,{label:"Objectifs"}),M.length>0&&e.jsx("div",{className:"space-y-1.5",children:M.map(E=>e.jsx(He,{objective:E,performances:K},E.id))}),e.jsx(Y,{label:"Nageur",text:s.athlete_goals}),e.jsx(we,{label:"Coach",value:p,onChange:N,placeholder:"Objectifs complÃ©mentaires, commentaires..."}),e.jsx(V,{label:"Planification"}),e.jsx(Xe,{athleteId:r,interviewDate:s.date}),e.jsx(V,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsxs("div",{className:"border-l-4 border-blue-400 rounded-r-lg bg-blue-50/50 dark:bg-blue-950/20 p-3 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(tt,{className:"h-3.5 w-3.5 text-blue-500"}),e.jsx("p",{className:"text-xs font-bold uppercase tracking-widest text-muted-foreground",children:"Engagements du nageur"})]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.athlete_commitments?.trim()||e.jsx("span",{className:"italic text-muted-foreground",children:"Non renseignÃ©"})})]}),e.jsx(we,{label:"Actions du coach",value:b,onChange:D,placeholder:"Actions concrÃ¨tes, points de suivi..."})]})]}),(G==="sent"||G==="signed")&&e.jsxs(e.Fragment,{children:[A&&e.jsx(Je,{prevInterview:A}),e.jsx(V,{label:"RÃ©ussites"}),e.jsx(Y,{label:"Nageur",text:s.athlete_successes}),e.jsx(_e,{label:"Coach",text:s.coach_comment_successes||s.coach_review}),e.jsx(V,{label:"DifficultÃ©s"}),e.jsx(Y,{label:"Nageur",text:s.athlete_difficulties}),e.jsx(_e,{label:"Coach",text:s.coach_comment_difficulties}),e.jsx(V,{label:"Objectifs"}),M.length>0&&e.jsx("div",{className:"space-y-1.5",children:M.map(E=>e.jsx(He,{objective:E,performances:K},E.id))}),e.jsx(Y,{label:"Nageur",text:s.athlete_goals}),e.jsx(_e,{label:"Coach",text:s.coach_comment_goals||s.coach_objectives}),e.jsx(V,{label:"Planification"}),e.jsx(Xe,{athleteId:r,interviewDate:s.date}),e.jsx(V,{label:"Engagements & Actions"}),e.jsxs("div",{className:"rounded-xl bg-card border shadow-sm p-4 space-y-3",children:[e.jsx(Y,{label:"Engagements du nageur",text:s.athlete_commitments}),e.jsx(_e,{label:"Actions du coach",text:s.coach_actions})]}),G==="signed"&&s.signed_at&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Mt,{className:"h-4 w-4 text-green-600"}),e.jsxs("span",{children:["SignÃ© le ",J(s.signed_at.slice(0,10))]})]})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[G==="draft_coach"&&e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-full",variant:"outline",onClick:()=>O.mutate(),disabled:Z,children:O.isPending?"Enregistrement...":"Enregistrer"}),e.jsxs(q,{className:"w-full",onClick:()=>_(!0),disabled:Z,children:[e.jsx(Ve,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer au nageur"]})]}),e.jsxs(q,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>u(!0),disabled:Z,children:[e.jsx(We,{className:"mr-1.5 h-3.5 w-3.5"}),"Supprimer"]})]})]})]})}),e.jsx(le,{open:y,onOpenChange:u,children:e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Supprimer l'entretien"}),e.jsxs(me,{children:["Cette action est irrÃ©versible. L'entretien du ",s.date?J(s.date):""," sera supprimÃ© dÃ©finitivement."]})]}),e.jsxs(ue,{children:[e.jsx(xe,{children:"Annuler"}),e.jsx(pe,{onClick:()=>{B.mutate(),u(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})}),e.jsx(le,{open:w,onOpenChange:_,children:e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Envoyer au nageur"}),e.jsx(me,{children:"L'entretien sera envoyÃ© au nageur pour consultation. Les sections coach seront enregistrÃ©es automatiquement."})]}),e.jsxs(ue,{children:[e.jsx(xe,{children:"Annuler"}),e.jsxs(pe,{onClick:()=>{je.mutate(),_(!1)},children:[e.jsx(Ve,{className:"mr-1.5 h-3.5 w-3.5"}),"Envoyer"]})]})]})})]})},ss=({interview:t,onClick:a})=>{const s=Zt(t);return e.jsxs("button",{type:"button",className:"w-full text-left rounded-xl border bg-card p-3 space-y-1.5 transition-colors hover:bg-muted/50",onClick:a,children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm font-semibold",children:J(t.date)}),ut(t.status)]}),s&&e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:s})]})},as=({athleteId:t,athleteName:a})=>{const{toast:s}=fe(),r=ge(),[c,l]=d.useState(null),[n,m]=d.useState(!1),{data:f}=S({queryKey:["auth-uid",t],queryFn:()=>es(t),enabled:!!t}),{data:h=[],isLoading:v}=S({queryKey:["interviews",t],queryFn:()=>g.getInterviews(t),enabled:!!t}),p=$({mutationFn:()=>g.createInterview({athlete_id:t}),onSuccess:x=>{s({title:"Entretien crÃ©Ã©"}),r.invalidateQueries({queryKey:["interviews",t]}),l(x),m(!0)},onError:x=>{s({title:"Erreur",description:x.message,variant:"destructive"})}}),N=x=>{l(x),m(!0)},T=x=>{m(x),x||l(null)};return v?e.jsx("div",{className:"space-y-2",children:[1,2,3].map(x=>e.jsx("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-24 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-5 w-20 rounded bg-muted"})]})},x))}):h.length===0?e.jsxs("div",{className:"text-center py-12 space-y-3",children:[e.jsx(it,{className:"h-10 w-10 text-muted-foreground mx-auto"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Aucun entretien pour ",a,"."]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:()=>p.mutate(),disabled:p.isPending,children:[e.jsx(ne,{className:"mr-1.5 h-3.5 w-3.5"}),p.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Entretiens"}),e.jsx(z,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:h.length})]}),e.jsxs(q,{variant:"outline",size:"sm",onClick:()=>p.mutate(),disabled:p.isPending,children:[e.jsx(ne,{className:"mr-1.5 h-3.5 w-3.5"}),p.isPending?"CrÃ©ation...":"Nouvel entretien"]})]}),e.jsx("div",{className:"space-y-2",children:h.map(x=>e.jsx(ss,{interview:x,onClick:()=>N(x)},x.id))}),e.jsx(ts,{open:n,onOpenChange:T,interview:c,athleteId:t,athleteAuthId:f??null})]})};function Ms(){const[,t]=vt("/coach/swimmer/:id"),[,a]=Ye(),{selectedAthleteId:s,selectedAthleteName:r}=Ze(),c=t?.id?Number(t.id):s,l=r,{data:n}=S({queryKey:["profile",c],queryFn:()=>g.getProfile({userId:c}),enabled:c!=null}),m=n?.display_name??l??"Nageur",f=n?.avatar_url??null,h=n?.group_label??null;return c?e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>a("/coach?section=swimmers"),className:"h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition","aria-label":"Retour",children:e.jsx(qt,{className:"h-4 w-4"})}),f?e.jsx("img",{src:f,alt:"",className:"h-10 w-10 rounded-full object-cover border border-border"}):e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center text-sm font-bold text-primary",children:m.charAt(0).toUpperCase()}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-lg font-bold truncate",children:m}),h&&e.jsx(z,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:h})]})]}),e.jsxs(_t,{defaultValue:"ressentis",children:[e.jsxs(wt,{className:"w-full grid grid-cols-4",children:[e.jsxs(ye,{value:"ressentis",className:"text-xs gap-1",children:[e.jsx(dt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Ressentis"})]}),e.jsxs(ye,{value:"objectifs",className:"text-xs gap-1",children:[e.jsx(ke,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Objectifs"})]}),e.jsxs(ye,{value:"planification",className:"text-xs gap-1",children:[e.jsx(mt,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Planif."})]}),e.jsxs(ye,{value:"entretiens",className:"text-xs gap-1",children:[e.jsx(it,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Entretiens"})]})]}),e.jsx(be,{value:"ressentis",className:"mt-4",children:e.jsx($t,{athleteId:c,athleteName:m})}),e.jsx(be,{value:"objectifs",className:"mt-4",children:e.jsx(Qt,{athleteId:c,athleteName:m})}),e.jsx(be,{value:"planification",className:"mt-4",children:e.jsx(Bt,{athleteId:c})}),e.jsx(be,{value:"entretiens",className:"mt-4",children:e.jsx(as,{athleteId:c,athleteName:m})})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx("p",{children:"Aucun nageur sÃ©lectionnÃ©."}),e.jsx("button",{type:"button",onClick:()=>a("/coach?section=swimmers"),className:"mt-2 text-primary underline",children:"Retour au dashboard"})]})}export{Ms as default};
