import{c as xe,r as c,u as oe,d as R,j as e}from"./vendor-query-DyA9aSKS.js";import{a as I}from"./api-CsdB_TuZ.js";import{d as he,B as w,W as Be,D as Ue,E as ge,U as Ye,L as S,I as te}from"./index-B_cXFuxW.js";import{C as Je}from"./Coach-CXjrDC3C.js";import{B as ce}from"./badge-djv9vjDc.js";import{S as Xe}from"./separator-B70ifb90.js";import{S as pe,a as fe,b as ve,c as je,d as Ne}from"./sheet-ogR7Ugjq.js";import{A as Ze,a as es,b as ss,c as ts,d as ns,e as as,f as rs,g as is}from"./alert-dialog-Eb7XNrzv.js";import{S as V,a as H,b as W,c as K,d as L}from"./select-CWU8MNvd.js";import{R as ls,a as Ce}from"./radio-group-CuqIGhAU.js";import{T as os,a as De}from"./toggle-group-BU6vK69e.js";import{C as de}from"./chevron-left-CFMvXEFS.js";import{P as ee}from"./plus-DE1m7Qaf.js";import{C as Ae}from"./chevron-right-Idup6kjj.js";import{C as ke}from"./clock-DzRHsT0x.js";import{M as $e}from"./map-pin-35rZyVDS.js";import{T as Ie}from"./trash-2-D3h5P1Nc.js";import"./vendor-react-BzrpNAyj.js";import"./swim-4KufcwQI.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./target-im_pf6UT.js";import"./index-B197rP1d.js";import"./index-BShhY6OQ.js";import"./index-BJxn_GPi.js";import"./index-DCX2sNhR.js";import"./chevron-down-Y1rxb1c3.js";import"./chevron-up-B86Zzyxc.js";import"./index-C3jJ35jx.js";import"./circle-CZND0dn9.js";const ne=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],cs=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],Q=6,ds=22,Oe=ds-Q,ae=40,Me=Oe*ae,Te=Array.from({length:Oe+1},(t,a)=>Q+a);function F(t){return t.slice(0,5)}function Ee(){return new Date().toISOString().slice(0,10)}function ue(t){const[a,i]=t.split(":").map(Number);return a*60+i}function me(t){return(ue(t)-Q*60)/60*ae}function us(t,a){return me(a)-me(t)}function Fe(t){const a=new Date(t),i=a.getDay(),f=i===0?-6:1-i;return a.setDate(a.getDate()+f),a.setHours(0,0,0,0),a}function ms(t){const a=new Date(t);a.setHours(0,0,0,0),a.setDate(a.getDate()+3-(a.getDay()+6)%7);const i=new Date(a.getFullYear(),0,4);return 1+Math.round(((a.getTime()-i.getTime())/864e5-3+(i.getDay()+6)%7)/7)}function G(t){return t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function se(t){const a=i=>String(i).padStart(2,"0");return`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}`}function xs(){const t=new Date().getDay();return t===0?7:t}function Le(t){const a=t.toLowerCase();return a.includes("piscine")||a.includes("bassin")||!a.includes("salle")&&!a.includes("muscu")&&!a.includes("ppg")&&!a.includes("gym")}const hs=({open:t,onOpenChange:a,slot:i,groups:f,coaches:y})=>{const{toast:d}=he(),h=xe(),o=!!i,[b,g]=c.useState("1"),[x,p]=c.useState(""),[v,j]=c.useState(""),[D,N]=c.useState(""),[T,k]=c.useState([]),[_,m]=c.useState(1),[B,q]=c.useState(!1);c.useEffect(()=>{if(t)if(i){g(String(i.day_of_week)),p(F(i.start_time)),j(F(i.end_time)),N(i.location);const r=i.assignments.map((l,A)=>({key:A,group_id:String(l.group_id),coach_id:String(l.coach_id),lane_count:l.lane_count!=null?String(l.lane_count):""}));k(r),m(r.length)}else g("1"),p(""),j(""),N(""),k([]),m(1)},[t,i]);const U=()=>{k(r=>[...r,{key:_,group_id:"",coach_id:"",lane_count:""}]),m(r=>r+1)},Y=r=>{k(l=>l.filter(A=>A.key!==r))},z=(r,l,A)=>{k(J=>J.map($=>$.key===r?{...$,[l]:A}:$))},re=()=>!x||!v?(d({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):D.trim()?{day_of_week:Number(b),start_time:x,end_time:v,location:D.trim(),assignments:T.filter(r=>r.group_id&&r.coach_id).map(r=>({group_id:Number(r.group_id),coach_id:Number(r.coach_id),lane_count:r.lane_count?Number(r.lane_count):null}))}:(d({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),C=R({mutationFn:r=>I.createTrainingSlot(r),onSuccess:()=>{d({title:"Creneau cree"}),h.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:r=>{d({title:"Erreur",description:r.message,variant:"destructive"})}}),O=R({mutationFn:r=>I.updateTrainingSlot(i.id,r),onSuccess:()=>{d({title:"Creneau mis a jour"}),h.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:r=>{d({title:"Erreur",description:r.message,variant:"destructive"})}}),E=R({mutationFn:()=>I.deleteTrainingSlot(i.id),onSuccess:()=>{d({title:"Creneau supprime"}),h.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:r=>{d({title:"Erreur",description:r.message,variant:"destructive"})}}),P=()=>{const r=re();r&&(o?O.mutate(r):C.mutate(r))},M=C.isPending||O.isPending||E.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(pe,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsx(je,{children:o?"Modifier le creneau":"Nouveau creneau"}),e.jsx(Ne,{children:o?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Jour de la semaine *"}),e.jsxs(V,{value:b,onValueChange:g,children:[e.jsx(H,{children:e.jsx(W,{})}),e.jsx(K,{children:ne.map((r,l)=>e.jsx(L,{value:String(l+1),children:r},l+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:x,onChange:r=>p(r.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:v,onChange:r=>j(r.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(te,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:D,onChange:r=>N(r.target.value)})]}),e.jsx(Xe,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(S,{children:"Groupes & Coachs"}),e.jsxs(w,{type:"button",variant:"outline",size:"sm",onClick:U,children:[e.jsx(ee,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),T.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),T.map(r=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(V,{value:r.group_id,onValueChange:l=>z(r.key,"group_id",l),children:[e.jsx(H,{className:"h-8 text-xs",children:e.jsx(W,{placeholder:"Groupe..."})}),e.jsx(K,{children:f.map(l=>e.jsx(L,{value:String(l.id),children:l.name},l.id))})]}),e.jsxs(V,{value:r.coach_id,onValueChange:l=>z(r.key,"coach_id",l),children:[e.jsx(H,{className:"h-8 text-xs",children:e.jsx(W,{placeholder:"Coach..."})}),e.jsx(K,{children:y.map(l=>e.jsx(L,{value:String(l.id),children:l.display_name},l.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{type:"number",min:0,placeholder:"Lignes d'eau",value:r.lane_count,onChange:l=>z(r.key,"lane_count",l.target.value),className:"h-8 text-xs flex-1"}),e.jsx(w,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>Y(r.key),children:e.jsx(Ie,{className:"h-3.5 w-3.5"})})]})]})},r.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(w,{className:"w-full",onClick:P,disabled:M||!x||!v||!D.trim(),children:M?"Enregistrement...":o?"Enregistrer":"Creer"}),o&&e.jsx(w,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>q(!0),disabled:M,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(Ze,{open:B,onOpenChange:q,children:e.jsxs(es,{children:[e.jsxs(ss,{children:[e.jsx(ts,{children:"Supprimer le creneau"}),e.jsx(ns,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(as,{children:[e.jsx(rs,{children:"Annuler"}),e.jsx(is,{onClick:()=>{E.mutate(),q(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},gs=({open:t,onOpenChange:a,slot:i})=>{const{toast:f}=he(),y=xe(),[d,h]=c.useState(""),[o,b]=c.useState("cancelled"),[g,x]=c.useState(""),[p,v]=c.useState(""),[j,D]=c.useState(""),[N,T]=c.useState("");c.useEffect(()=>{t&&(h(""),b("cancelled"),x(i?F(i.start_time):""),v(i?F(i.end_time):""),D(i?.location??""),T(""))},[t,i]);const k=R({mutationFn:m=>I.createSlotOverride(m),onSuccess:()=>{f({title:"Exception enregistree"}),y.invalidateQueries({queryKey:["training-slot-overrides"]}),y.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:m=>{f({title:"Erreur",description:m.message,variant:"destructive"})}}),_=()=>{if(!i)return;if(!d){f({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const m={slot_id:i.id,override_date:d,status:o,new_start_time:o==="modified"&&g||null,new_end_time:o==="modified"&&p||null,new_location:o==="modified"&&j.trim()?j.trim():null,reason:N.trim()||null};k.mutate(m)};return e.jsx(pe,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsx(je,{children:"Exception"}),e.jsx(Ne,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:d,onChange:m=>h(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{children:"Type"}),e.jsxs(ls,{value:o,onValueChange:m=>b(m),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ce,{value:"cancelled",id:"ovr-cancelled"}),e.jsx(S,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ce,{value:"modified",id:"ovr-modified"}),e.jsx(S,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),o==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:g,onChange:m=>x(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:p,onChange:m=>v(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(te,{id:"ovr-location",value:j,onChange:m=>D(m.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(te,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:N,onChange:m=>T(m.target.value)})]}),e.jsx(w,{className:"w-full",onClick:_,disabled:k.isPending||!d,children:k.isPending?"Enregistrement...":"Enregistrer"})]})]})})},ps=({slot:t,hasOverrides:a,cancelled:i=!1,onSelect:f})=>{const y=me(t.start_time),d=us(t.start_time,t.end_time),h=d<50,o=Le(t.location),b=i?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":o?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",g=o?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${b}`,style:{top:y,height:d,minHeight:24},onClick:()=>f(t),title:`${F(t.start_time)}–${F(t.end_time)} · ${t.location}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${h?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx($e,{className:`h-2.5 w-2.5 shrink-0 ${g}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:t.location}),a&&!i&&e.jsx(ge,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),!h&&t.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:t.assignments.map(x=>e.jsx(ce,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:x.group_name},x.id))}),!h&&d>=70&&t.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(t.assignments.map(x=>x.coach_name))].join(", ")})]})})},fs=({slot:t,open:a,onOpenChange:i,overrides:f,onEdit:y,onOverride:d,onDeleteOverride:h})=>t?e.jsx(pe,{open:a,onOpenChange:i,children:e.jsxs(fe,{side:"bottom",className:"max-h-[60vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(ve,{className:"pb-2",children:[e.jsxs(je,{className:"text-left text-base",children:[ne[t.day_of_week-1]," · ",F(t.start_time),"–",F(t.end_time)]}),e.jsx(Ne,{className:"sr-only",children:"Details du creneau"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx($e,{className:"h-3.5 w-3.5 shrink-0"}),t.location]}),t.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.assignments.map(o=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ce,{variant:"secondary",className:"text-xs px-2 py-0.5",children:o.group_name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[o.coach_name,o.lane_count!=null&&` · ${o.lane_count} ligne${o.lane_count>1?"s":""}`]})]},o.id))}),f.length>0&&e.jsxs("div",{className:"space-y-1.5 pt-1 border-t border-dashed",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Exceptions"}),f.map(o=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(ge,{className:"h-3 w-3 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(o.override_date+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}),e.jsx(ce,{variant:o.status==="cancelled"?"destructive":"outline",className:"text-[10px] px-1 py-0",children:o.status==="cancelled"?"Annule":"Modifie"}),o.reason&&e.jsx("span",{className:"text-muted-foreground truncate flex-1",children:o.reason}),e.jsx(w,{variant:"ghost",size:"icon",className:"h-6 w-6 ml-auto shrink-0 text-muted-foreground hover:text-destructive",onClick:()=>h(o.id),children:e.jsx(Ie,{className:"h-3 w-3"})})]},o.id))]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(w,{variant:"outline",size:"sm",className:"flex-1",onClick:y,children:"Modifier"}),e.jsx(w,{variant:"outline",size:"sm",className:"flex-1",onClick:d,children:"Exception"})]})]})]})}):null,vs=({selectedDay:t,onSelectDay:a,weekDates:i,todayIso:f,onPrevWeek:y,onNextWeek:d,weekNumber:h,slotsCountByDay:o})=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-8 w-8 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:y,children:e.jsx(de,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",h]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[G(i[0])," – ",G(i[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-8 w-8 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:d,children:e.jsx(Ae,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 px-0.5",children:i.map((b,g)=>{const x=g+1,p=x===t,v=se(b)===f,j=o.get(x)??0;return e.jsxs("button",{type:"button",className:`relative flex flex-col items-center justify-center rounded-2xl py-2 transition-all active:scale-90 ${p?"bg-foreground text-background shadow-lg shadow-foreground/10":v?"bg-primary/8 text-foreground ring-1 ring-primary/20":"text-muted-foreground hover:bg-muted/60"}`,onClick:()=>a(x),children:[e.jsx("span",{className:`text-[10px] font-medium uppercase leading-none ${p?"text-background/70":"text-muted-foreground"}`,children:cs[g]}),e.jsx("span",{className:`text-base font-bold leading-tight mt-0.5 tabular-nums ${p?"":"text-foreground"}`,children:b.getDate()}),j>0&&!p&&e.jsx("div",{className:"flex gap-0.5 mt-1",children:Array.from({length:Math.min(j,3)},(D,N)=>e.jsx("span",{className:"h-1 w-1 rounded-full bg-primary/50"},N))}),j>0&&p&&e.jsx("div",{className:"flex gap-0.5 mt-1",children:Array.from({length:Math.min(j,3)},(D,N)=>e.jsx("span",{className:"h-1 w-1 rounded-full bg-background/50"},N))}),j===0&&e.jsx("div",{className:"h-1 mt-1"})]},x)})})]}),js=({slot:t,cancelled:a,hasOverrides:i,onSelect:f,index:y})=>{const d=Le(t.location),h=a?"bg-muted-foreground/20":d?"bg-blue-500":"bg-amber-500",o=ue(t.start_time),g=ue(t.end_time)-o,x=g>=60?`${Math.floor(g/60)}h${g%60>0?String(g%60).padStart(2,"0"):""}`:`${g}min`;return e.jsx("button",{type:"button",className:`group w-full text-left transition-all active:scale-[0.97] ${a?"opacity-40":""}`,onClick:()=>f(t),style:{animationDelay:`${y*50}ms`},children:e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex flex-col items-end shrink-0 w-14 pt-0.5",children:[e.jsx("span",{className:`text-sm font-bold tabular-nums leading-tight ${a?"line-through text-muted-foreground":"text-foreground"}`,children:F(t.start_time)}),e.jsx("span",{className:"text-[10px] text-muted-foreground tabular-nums leading-tight",children:F(t.end_time)})]}),e.jsxs("div",{className:"relative flex flex-col items-center shrink-0 py-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${h}`}),e.jsx("div",{className:`flex-1 w-0.5 ${h} opacity-30 my-0.5`}),e.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${h} opacity-40`})]}),e.jsx("div",{className:"flex-1 min-w-0 pb-4",children:e.jsxs("div",{className:"rounded-xl bg-card border border-border/60 p-3 group-hover:shadow-md group-hover:border-border transition-all",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 min-w-0",children:[d?e.jsx(Be,{className:"h-3.5 w-3.5 text-blue-500 shrink-0"}):e.jsx(Ue,{className:"h-3.5 w-3.5 text-amber-500 shrink-0"}),e.jsx("span",{className:`text-sm font-semibold truncate ${a?"line-through text-muted-foreground":"text-foreground"}`,children:t.location})]}),e.jsxs("div",{className:"flex items-center gap-1.5 shrink-0",children:[i&&!a&&e.jsx("span",{className:"flex items-center gap-0.5 rounded-full bg-orange-500/10 text-orange-600 px-1.5 py-0.5 text-[9px] font-medium",children:e.jsx(ge,{className:"h-2.5 w-2.5"})}),a&&e.jsx("span",{className:"rounded-full bg-destructive/10 text-destructive px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide",children:"Annulé"}),e.jsx("span",{className:"text-[10px] text-muted-foreground tabular-nums",children:x})]})]}),t.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap items-center gap-1.5 mt-2",children:t.assignments.map(p=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-md px-1.5 py-0.5 text-[10px] font-medium ${d?"bg-blue-500/8 text-blue-700":"bg-amber-500/8 text-amber-700"}`,children:[e.jsx(Ye,{className:"h-2.5 w-2.5"}),p.group_name]}),e.jsx("span",{className:"text-[10px] text-muted-foreground",children:p.coach_name})]},p.id))})]})})]})})},Js=({onBack:t,groups:a})=>{const{toast:i}=he(),f=xe(),[y,d]=c.useState(!1),[h,o]=c.useState(null),[b,g]=c.useState(null),[x,p]=c.useState(!1),[v,j]=c.useState(null),[D,N]=c.useState(!1),[T,k]=c.useState(()=>xs()),[_,m]=c.useState(()=>Fe(new Date)),B=c.useMemo(()=>ms(_),[_]),q=c.useMemo(()=>{const s=new Date(_);return s.setDate(s.getDate()+6),s},[_]),U=c.useMemo(()=>Array.from({length:7},(s,n)=>{const u=new Date(_);return u.setDate(u.getDate()+n),u}),[_]),Y=()=>m(s=>{const n=new Date(s);return n.setDate(n.getDate()-7),n}),z=()=>m(s=>{const n=new Date(s);return n.setDate(n.getDate()+7),n}),re=()=>m(Fe(new Date)),[C,O]=c.useState("group"),[E,P]=c.useState("all"),[M,r]=c.useState("all"),{data:l=[],isLoading:A}=oe({queryKey:["training-slots"],queryFn:()=>I.getTrainingSlots()}),{data:J=[]}=oe({queryKey:["training-slot-overrides"],queryFn:()=>I.getSlotOverrides()}),{data:$=[]}=oe({queryKey:["users","coaches"],queryFn:()=>I.listUsers({role:"coach"})}),ye=c.useMemo(()=>{if(C==="coach"&&E!=="all"){const s=Number(E);return l.filter(n=>n.assignments.some(u=>u.coach_id===s))}if(C==="group"&&M!=="all"){const s=Number(M);return l.filter(n=>n.assignments.some(u=>u.group_id===s))}return l},[l,C,E,M]),X=c.useMemo(()=>{const s=new Map;for(let n=1;n<=7;n++)s.set(n,[]);for(const n of ye)s.get(n.day_of_week).push(n);for(const n of s.values())n.sort((u,Qe)=>u.start_time.localeCompare(Qe.start_time));return s},[ye]),be=se(_),Se=se(q),Z=c.useMemo(()=>J.filter(s=>s.override_date>=be&&s.override_date<=Se),[J,be,Se]),ie=c.useMemo(()=>{const s=new Map;for(const n of Z){const u=s.get(n.slot_id)??[];u.push(n),s.set(n.slot_id,u)}return s},[Z]),we=c.useMemo(()=>{const s=new Set;for(const n of Z)n.status==="cancelled"&&s.add(n.slot_id);return s},[Z]),qe=R({mutationFn:s=>I.deleteSlotOverride(s),onSuccess:()=>{i({title:"Exception supprimee"}),f.invalidateQueries({queryKey:["training-slot-overrides"]})},onError:s=>{i({title:"Erreur",description:s.message,variant:"destructive"})}}),le=()=>{o(null),d(!0)},_e=s=>{j(s),N(!0)},ze=()=>{v&&(N(!1),o(v),d(!0))},Pe=()=>{v&&(N(!1),g(v),p(!0))},Re=$.map(s=>({id:s.id,display_name:s.display_name})),Ve=c.useMemo(()=>{const s=new Map;for(let n=1;n<=7;n++)s.set(n,(X.get(n)??[]).length);return s},[X]),He=l.length===0?"Planning hebdomadaire des entrainements.":`${l.length} creneau${l.length>1?"x":""}`,We=c.useMemo(()=>{const s=[{id:"all",label:"Tous",mode:"group",value:"all"}];for(const n of a)s.push({id:`g-${n.id}`,label:String(n.name),mode:"group",value:String(n.id)});for(const n of $)s.push({id:`c-${n.id}`,label:n.display_name,mode:"coach",value:String(n.id)});return s},[a,$]),Ke=c.useMemo(()=>C==="group"&&M==="all"?"all":C==="group"?`g-${M}`:C==="coach"&&E==="all"?"all":`c-${E}`,[C,M,E]),Ge=s=>{s.id==="all"?(O("group"),r("all"),P("all")):s.mode==="group"?(O("group"),r(s.value)):(O("coach"),P(s.value))};return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{variant:"ghost",size:"icon",className:"h-8 w-8 -ml-2",onClick:t,children:e.jsx(de,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),l.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[l.length," créneau",l.length>1?"x":""," actif",l.length>1?"s":""]})]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:le,children:e.jsx(ee,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(Je,{title:"Creneaux",description:He,onBack:t,actions:e.jsxs(w,{variant:"outline",size:"sm",onClick:le,children:[e.jsx(ee,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})})}),!A&&l.length>0&&e.jsx("div",{className:"sm:hidden -mx-4 px-4 overflow-x-auto no-scrollbar",children:e.jsx("div",{className:"flex gap-1.5 pb-1",children:We.map(s=>{const n=s.id===Ke,u=s.mode==="coach";return e.jsx("button",{type:"button",className:`shrink-0 rounded-full px-3 py-1 text-xs font-medium transition-all active:scale-95 ${n?"bg-foreground text-background shadow-sm":"bg-muted/60 text-muted-foreground hover:bg-muted"}`,onClick:()=>Ge(s),children:u&&s.id!=="all"?`${s.label}`:s.label},s.id)})})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(w,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:Y,children:e.jsx(de,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:re,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",B]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[G(_)," – ",G(q)]})]}),e.jsx(w,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:z,children:e.jsx(Ae,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-row items-center gap-3",children:[e.jsxs(os,{type:"single",value:C,onValueChange:s=>{(s==="coach"||s==="group")&&O(s)},className:"shrink-0",children:[e.jsx(De,{value:"group",className:"text-xs px-3",children:"Groupe"}),e.jsx(De,{value:"coach",className:"text-xs px-3",children:"Coach"})]}),C==="group"?e.jsxs(V,{value:M,onValueChange:r,children:[e.jsx(H,{className:"w-56",children:e.jsx(W,{placeholder:"Tous les groupes"})}),e.jsxs(K,{children:[e.jsx(L,{value:"all",children:"Tous les groupes"}),a.map(s=>e.jsx(L,{value:String(s.id),children:s.name},s.id))]})]}):e.jsxs(V,{value:E,onValueChange:P,children:[e.jsx(H,{className:"w-56",children:e.jsx(W,{placeholder:"Tous les coachs"})}),e.jsxs(K,{children:[e.jsx(L,{value:"all",children:"Tous les coachs"}),$.map(s=>e.jsx(L,{value:String(s.id),children:s.display_name},s.id))]})]})]})]}),A?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-3",children:[e.jsx("div",{className:"grid grid-cols-7 gap-1 px-0.5",children:Array.from({length:7},(s,n)=>e.jsx("div",{className:"h-16 rounded-2xl bg-muted animate-pulse motion-reduce:animate-none"},n))}),Array.from({length:3},(s,n)=>e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-14 h-10 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"flex-1 h-20 rounded-xl bg-muted animate-pulse motion-reduce:animate-none"})]},n))]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(s,n)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},n))})]}):l.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(ke,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(w,{variant:"outline",size:"sm",onClick:le,children:[e.jsx(ee,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-1",children:[e.jsx(vs,{selectedDay:T,onSelectDay:k,weekDates:U,todayIso:Ee(),onPrevWeek:Y,onNextWeek:z,weekNumber:B,slotsCountByDay:Ve}),(()=>{const s=X.get(T)??[];return s.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 space-y-2",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-muted/50 flex items-center justify-center",children:e.jsx(ke,{className:"h-4.5 w-4.5 text-muted-foreground/60"})}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Aucun créneau ",ne[T-1].toLowerCase()]})]}):e.jsx("div",{className:"pt-3 pl-0.5",children:s.map((n,u)=>e.jsx(js,{slot:n,cancelled:we.has(n.id),hasOverrides:(ie.get(n.id)??[]).length>0,onSelect:_e,index:u},n.id))})})()]}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",U.map((s,n)=>{const u=se(s)===Ee();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:ne[n]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${u?"text-primary font-bold":"text-muted-foreground/60"}`,children:G(s)})]},n)}),e.jsx("div",{className:"relative",style:{height:Me},children:Te.map(s=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(s-Q)*ae},children:[s,"h"]},s))}),Array.from({length:7},(s,n)=>n+1).map(s=>{const n=X.get(s)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:Me},children:[Te.map(u=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(u-Q)*ae}},u)),n.map(u=>e.jsx(ps,{slot:u,hasOverrides:(ie.get(u.id)??[]).length>0,cancelled:we.has(u.id),onSelect:_e},u.id))]},s)})]})})]}),e.jsx(fs,{slot:v,open:D,onOpenChange:N,overrides:v?ie.get(v.id)??[]:[],onEdit:ze,onOverride:Pe,onDeleteOverride:s=>qe.mutate(s)}),e.jsx(hs,{open:y,onOpenChange:d,slot:h,groups:a,coaches:Re}),e.jsx(gs,{open:x,onOpenChange:p,slot:b})]})};export{Js as default};
