import{r as i,u as R,j as s}from"./vendor-query-DyA9aSKS.js";import{c as q,d as K,C as y,h as w,j as N,k as _,e as k,L as Q,B as $,a as M,X as z,s as V}from"./index-CO2ncg_o.js";import{B as T}from"./badge-kC5Mf_CH.js";import{T as X}from"./textarea-gpgFIn1h.js";import{P as J,a as W,b as Y,C as Z,c as ee,d as se,e as te,f as P,g as O}from"./command-BteDCJNx.js";import{C as ne}from"./Coach-CZwYUx0j.js";import{S as re,c as A,b as ae}from"./smsUtils-DmbhPWmI.js";import{C as E}from"./index-Dch8R4su.js";import{C as oe}from"./copy-DsQIGI1N.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./index-BFeblcdz.js";import"./dialog-BPuT4ndl.js";import"./search-C2i_JIya.js";import"./api-CiuAheZr.js";import"./swim-D4dwFqEg.js";import"./arrow-left-CUwGOUZR.js";import"./chevron-right-D_O0HqWu.js";import"./clock-BpHocNoZ.js";import"./bell-ring-DWd2dgzu.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"m7 15 5 5 5-5",key:"1hf1tw"}],["path",{d:"m7 9 5-5 5 5",key:"sgt6xg"}]],le=q("chevrons-up-down",ie);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],de=q("external-link",ce),Ae=({onBack:G,athletes:x,groups:p,athletesLoading:L})=>{const{toast:u}=K(),[g,U]=i.useState(""),[a,j]=i.useState(new Set),[o,f]=i.useState(new Set),[C,B]=i.useState(!1),{data:h}=R({queryKey:["athlete-phones"],queryFn:async()=>{const{data:e}=await V.from("user_profiles").select("user_id, phone").not("phone","is",null);return new Map((e??[]).map(n=>[n.user_id,n.phone]))}}),d=i.useMemo(()=>x.filter(e=>e.id!=null).map(e=>({id:e.id,display_name:e.display_name,group_id:e.group_id??null,group_label:e.group_label??null})),[x]),v=e=>{j(n=>{const t=new Set(n);return t.has(e)?t.delete(e):t.add(e),t})},b=e=>{f(n=>{const t=new Set(n);return t.has(e)?t.delete(e):t.add(e),t})},D=()=>{j(new Set),f(new Set)},{selectedPhones:r,selectedTotal:me,missingCount:S}=i.useMemo(()=>{if(!h)return{selectedPhones:[],selectedTotal:0,missingCount:0};const e=new Set;for(const m of a)for(const c of d)c.group_id===m&&e.add(c.id);for(const m of o)e.add(m);const n=e.size,t=[];for(const m of e){const c=h.get(m);c&&c.trim().length>0&&t.push(c)}return{selectedPhones:t,selectedTotal:n,missingCount:n-t.length}},[a,o,d,h]),l=a.size+o.size,F=i.useMemo(()=>{const e=[];return a.size>0&&e.push(`${a.size} groupe${a.size>1?"s":""}`),o.size>0&&e.push(`${o.size} nageur${o.size>1?"s":""}`),e.join(", ")},[a.size,o.size]),H=()=>{if(r.length===0){u({title:"Aucun numéro",description:"Aucun nageur avec un numéro de téléphone dans cette sélection.",variant:"destructive"});return}if(A()){const e=ae(r,g.trim()||void 0);window.location.href=e}else navigator.clipboard.writeText(r.join(", ")).then(()=>{u({title:"Numéros copiés",description:`${r.length} numéro${r.length>1?"s":""} copié${r.length>1?"s":""} dans le presse-papiers.`})}).catch(()=>{u({title:"Erreur",description:"Impossible de copier les numéros.",variant:"destructive"})})},I=A();return s.jsxs("div",{className:"space-y-6 pb-24",children:[s.jsx(ne,{title:"Envoyer un SMS",description:"Ouvre votre application SMS ou copie les numéros.",onBack:G}),s.jsxs(y,{className:"border-l-4 border-l-primary",children:[s.jsxs(w,{children:[s.jsx(N,{children:"Destinataires"}),s.jsx(_,{children:"Sélectionnez des groupes et/ou des nageurs."})]}),s.jsxs(k,{className:"space-y-3",children:[s.jsx(Q,{children:"Destinataires"}),s.jsxs(J,{open:C,onOpenChange:B,children:[s.jsx(W,{asChild:!0,children:s.jsxs($,{variant:"outline",role:"combobox","aria-expanded":C,className:"w-full justify-between font-normal",children:[s.jsx("span",{className:"truncate",children:l>0?F:L?"Chargement...":"Choisir des destinataires"}),s.jsx(le,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),s.jsx(Y,{className:"w-[var(--radix-popover-trigger-width)] p-0",align:"start",children:s.jsxs(Z,{children:[s.jsx(ee,{placeholder:"Rechercher..."}),s.jsxs(se,{children:[s.jsx(te,{children:"Aucun résultat."}),p.length>0&&s.jsx(P,{heading:"Groupes",children:p.map(e=>s.jsxs(O,{value:`groupe ${e.name}`,onSelect:()=>v(e.id),children:[s.jsx(E,{className:M("mr-2 h-4 w-4",a.has(e.id)?"opacity-100":"opacity-0")}),e.name]},`group:${e.id}`))}),d.length>0&&s.jsx(P,{heading:"Nageurs",children:d.map(e=>s.jsxs(O,{value:`nageur ${e.display_name} ${e.group_label??""}`,onSelect:()=>b(e.id),children:[s.jsx(E,{className:M("mr-2 h-4 w-4",o.has(e.id)?"opacity-100":"opacity-0")}),s.jsx("span",{className:"truncate",children:e.display_name}),e.group_label&&s.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:e.group_label})]},`user:${e.id}`))})]})]})})]}),l>0&&s.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[[...a].map(e=>{const n=p.find(t=>t.id===e);return n?s.jsxs(T,{variant:"secondary",className:"gap-1 pr-1",children:[n.name,s.jsx("button",{type:"button",onClick:()=>v(e),className:"ml-0.5 rounded-full p-0.5 hover:bg-muted",children:s.jsx(z,{className:"h-3 w-3"})})]},`g:${e}`):null}),[...o].map(e=>{const n=d.find(t=>t.id===e);return n?s.jsxs(T,{variant:"outline",className:"gap-1 pr-1",children:[n.display_name,s.jsx("button",{type:"button",onClick:()=>b(e),className:"ml-0.5 rounded-full p-0.5 hover:bg-muted",children:s.jsx(z,{className:"h-3 w-3"})})]},`u:${e}`):null}),l>1&&s.jsx("button",{type:"button",onClick:D,className:"text-xs text-muted-foreground underline hover:text-foreground",children:"Tout effacer"})]}),l>0&&r.length>0&&s.jsxs("p",{className:"text-xs text-muted-foreground",children:[r.length," numéro",r.length>1?"s":""," trouvé",r.length>1?"s":"",S>0&&s.jsxs("span",{className:"text-destructive",children:[" · ",S," sans téléphone"]})]}),l>0&&r.length===0&&s.jsx("p",{className:"text-xs text-destructive",children:"Aucun numéro de téléphone disponible pour cette sélection."})]})]}),s.jsxs(y,{children:[s.jsxs(w,{children:[s.jsx(N,{children:"Message"}),s.jsx(_,{children:"Optionnel — pré-rempli dans votre application SMS."})]}),s.jsx(k,{children:s.jsx(X,{value:g,onChange:e=>U(e.target.value),placeholder:"Contenu du SMS…",rows:3})})]}),s.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:s.jsx($,{className:"w-full sm:w-auto",onClick:H,disabled:l===0||r.length===0,children:I?s.jsxs(s.Fragment,{children:[s.jsx(re,{className:"mr-2 h-4 w-4"}),"Ouvrir dans Messages",s.jsx(de,{className:"ml-2 h-3 w-3"})]}):s.jsxs(s.Fragment,{children:[s.jsx(oe,{className:"mr-2 h-4 w-4"}),"Copier les numéros"]})})})]})};export{Ae as default};
