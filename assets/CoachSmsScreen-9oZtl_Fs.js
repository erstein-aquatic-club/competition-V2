import{r as c,u as F,j as e}from"./vendor-query-DyA9aSKS.js";import{c as R,d as H,C as S,g as w,i as N,j as $,e as _,L as K,B as P,a as M,X as z,s as Q}from"./index-DWMfxnKm.js";import{B as k}from"./badge-D2Huo2Or.js";import{T as X}from"./textarea-CwK1WzWi.js";import{P as J,a as V,b as W,C as Y,c as Z,d as ee,e as se,f as A,g as T}from"./command-CWlmTDpL.js";import{C as te}from"./Coach-Bs_jkMzi.js";import{C as E}from"./index-BDKOUw5a.js";import{M as ne}from"./target-CBFewydn.js";import{E as oe}from"./external-link-AFXN_a-3.js";import{C as re}from"./copy-TSbk6S0B.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./index-BwDKbDm0.js";import"./dialog-DgrP10Gr.js";import"./search-BwXRSr7M.js";import"./api-Bvmnrh7j.js";import"./swim-Cj1bygPc.js";import"./toggle-group-4QUn-Afv.js";import"./index-CtBaY3Qw.js";import"./index-DIhoOuTf.js";import"./clock-DzIBwX4X.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"m7 15 5 5 5-5",key:"1hf1tw"}],["path",{d:"m7 9 5-5 5 5",key:"sgt6xg"}]],ie=R("chevrons-up-down",ae),Ae=({onBack:O,athletes:g,groups:p,athletesLoading:G})=>{const{toast:u}=H(),[h,I]=c.useState(""),[r,j]=c.useState(new Set),[a,f]=c.useState(new Set),[b,L]=c.useState(!1),{data:x}=F({queryKey:["athlete-phones"],queryFn:async()=>{const{data:s}=await Q.from("user_profiles").select("user_id, phone").not("phone","is",null);return new Map((s??[]).map(t=>[t.user_id,t.phone]))}}),m=c.useMemo(()=>g.filter(s=>s.id!=null).map(s=>({id:s.id,display_name:s.display_name,group_id:s.group_id??null,group_label:s.group_label??null})),[g]),C=s=>{j(t=>{const n=new Set(t);return n.has(s)?n.delete(s):n.add(s),n})},v=s=>{f(t=>{const n=new Set(t);return n.has(s)?n.delete(s):n.add(s),n})},U=()=>{j(new Set),f(new Set)},{selectedPhones:o,selectedTotal:le,missingCount:y}=c.useMemo(()=>{if(!x)return{selectedPhones:[],selectedTotal:0,missingCount:0};const s=new Set;for(const i of r)for(const l of m)l.group_id===i&&s.add(l.id);for(const i of a)s.add(i);const t=s.size,n=[];for(const i of s){const l=x.get(i);l&&l.trim().length>0&&n.push(l)}return{selectedPhones:n,selectedTotal:t,missingCount:t-n.length}},[r,a,m,x]),d=r.size+a.size,B=c.useMemo(()=>{const s=[];return r.size>0&&s.push(`${r.size} groupe${r.size>1?"s":""}`),a.size>0&&s.push(`${a.size} nageur${a.size>1?"s":""}`),s.join(", ")},[r.size,a.size]),D=()=>{if(o.length===0){u({title:"Aucun numéro",description:"Aucun nageur avec un numéro de téléphone dans cette sélection.",variant:"destructive"});return}if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){const t=h.trim()?encodeURIComponent(h.trim()):"",n=/iPhone|iPad|iPod/i.test(navigator.userAgent);let i;if(n){const l=o.join(",");i=t?`sms:/open?addresses=${l}&body=${t}`:`sms:/open?addresses=${l}`}else i=t?`sms:${o.join(",")}?body=${t}`:`sms:${o.join(",")}`;window.location.href=i}else navigator.clipboard.writeText(o.join(", ")).then(()=>{u({title:"Numéros copiés",description:`${o.length} numéro${o.length>1?"s":""} copié${o.length>1?"s":""} dans le presse-papiers.`})}).catch(()=>{u({title:"Erreur",description:"Impossible de copier les numéros.",variant:"destructive"})})},q=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(te,{title:"Envoyer un SMS",description:"Ouvre votre application SMS ou copie les numéros.",onBack:O}),e.jsxs(S,{className:"border-l-4 border-l-primary",children:[e.jsxs(w,{children:[e.jsx(N,{children:"Destinataires"}),e.jsx($,{children:"Sélectionnez des groupes et/ou des nageurs."})]}),e.jsxs(_,{className:"space-y-3",children:[e.jsx(K,{children:"Destinataires"}),e.jsxs(J,{open:b,onOpenChange:L,children:[e.jsx(V,{asChild:!0,children:e.jsxs(P,{variant:"outline",role:"combobox","aria-expanded":b,className:"w-full justify-between font-normal",children:[e.jsx("span",{className:"truncate",children:d>0?B:G?"Chargement...":"Choisir des destinataires"}),e.jsx(ie,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(W,{className:"w-[var(--radix-popover-trigger-width)] p-0",align:"start",children:e.jsxs(Y,{children:[e.jsx(Z,{placeholder:"Rechercher..."}),e.jsxs(ee,{children:[e.jsx(se,{children:"Aucun résultat."}),p.length>0&&e.jsx(A,{heading:"Groupes",children:p.map(s=>e.jsxs(T,{value:`groupe ${s.name}`,onSelect:()=>C(s.id),children:[e.jsx(E,{className:M("mr-2 h-4 w-4",r.has(s.id)?"opacity-100":"opacity-0")}),s.name]},`group:${s.id}`))}),m.length>0&&e.jsx(A,{heading:"Nageurs",children:m.map(s=>e.jsxs(T,{value:`nageur ${s.display_name} ${s.group_label??""}`,onSelect:()=>v(s.id),children:[e.jsx(E,{className:M("mr-2 h-4 w-4",a.has(s.id)?"opacity-100":"opacity-0")}),e.jsx("span",{className:"truncate",children:s.display_name}),s.group_label&&e.jsx("span",{className:"ml-auto text-xs text-muted-foreground",children:s.group_label})]},`user:${s.id}`))})]})]})})]}),d>0&&e.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[[...r].map(s=>{const t=p.find(n=>n.id===s);return t?e.jsxs(k,{variant:"secondary",className:"gap-1 pr-1",children:[t.name,e.jsx("button",{type:"button",onClick:()=>C(s),className:"ml-0.5 rounded-full p-0.5 hover:bg-muted",children:e.jsx(z,{className:"h-3 w-3"})})]},`g:${s}`):null}),[...a].map(s=>{const t=m.find(n=>n.id===s);return t?e.jsxs(k,{variant:"outline",className:"gap-1 pr-1",children:[t.display_name,e.jsx("button",{type:"button",onClick:()=>v(s),className:"ml-0.5 rounded-full p-0.5 hover:bg-muted",children:e.jsx(z,{className:"h-3 w-3"})})]},`u:${s}`):null}),d>1&&e.jsx("button",{type:"button",onClick:U,className:"text-xs text-muted-foreground underline hover:text-foreground",children:"Tout effacer"})]}),d>0&&o.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[o.length," numéro",o.length>1?"s":""," trouvé",o.length>1?"s":"",y>0&&e.jsxs("span",{className:"text-destructive",children:[" · ",y," sans téléphone"]})]}),d>0&&o.length===0&&e.jsx("p",{className:"text-xs text-destructive",children:"Aucun numéro de téléphone disponible pour cette sélection."})]})]}),e.jsxs(S,{children:[e.jsxs(w,{children:[e.jsx(N,{children:"Message"}),e.jsx($,{children:"Optionnel — pré-rempli dans votre application SMS."})]}),e.jsx(_,{children:e.jsx(X,{value:h,onChange:s=>I(s.target.value),placeholder:"Contenu du SMS…",rows:3})})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsx(P,{className:"w-full sm:w-auto",onClick:D,disabled:d===0||o.length===0,children:q?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Ouvrir dans l'app SMS",e.jsx(oe,{className:"ml-2 h-3 w-3"})]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"mr-2 h-4 w-4"}),"Copier les numéros"]})})})]})};export{Ae as default};
