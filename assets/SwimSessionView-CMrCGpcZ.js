import{c as le,r as o,u as F,d as Q,j as e}from"./vendor-query-DyA9aSKS.js";import{u as $,b as ce,d as de,B as g,C as ue,e as me,g as y,P as pe,s as O}from"./index-BEFtN8Ff.js";import{B as U}from"./badge-BjNkEWSb.js";import{S as xe}from"./separator-jYohwG5b.js";import{S as ge,E as he}from"./SwimSessionTimeline-DtWZG8r5.js";import{a as h}from"./api-CSvc7NK_.js";import{g as fe}from"./swim-BtCWSpXS.js";import{C as be}from"./circle-alert-6c47PJ6y.js";import{C as je}from"./chevron-left-vupj7URZ.js";import{S as we}from"./share-2-C6iscZOY.js";import{T as ve}from"./trash-2-BD52lqhR.js";import{L as Ne}from"./loader-circle-CsOm8Dj4.js";import{S as ye}from"./save-BlS9-PT5.js";import{f as H}from"./vendor-date-B8Mnp-Vt.js";import{f as V}from"./fr-W-h3q7wd.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./SwimTimeInput-BlWPPZ1M.js";import"./chevron-up-B0G5VQaA.js";import"./timer-DemyM3t7.js";import"./eye-DO6IzHrw.js";import"./chevron-down-BFSZSmkk.js";import"./clock-Bdoc0C4T.js";const Se={assigned:"Assignée",pending:"Assignée",in_progress:"En cours",completed:"Terminée",cancelled:"Annulée"},_e=r=>{if(!r)return"-";const c=new Date(r);return Number.isNaN(c.getTime())?r:H(c,"dd MMM",{locale:V})};function Ce(r){const c=new Map;for(const d of r)d.source_item_id!=null&&c.set(d.source_item_id,{exercise_label:d.exercise_label,source_item_id:d.source_item_id,split_times:d.split_times,tempo:d.tempo,stroke_count:d.stroke_count,notes:d.notes});return c}function ke(r){return r&&new Date(r).getHours()>=14?"Soir":"Matin"}function Ze(){const r=$(s=>s.user),c=$(s=>s.userId),[d,A]=ce(),{toast:p}=de(),S=le(),[G,J]=o.useState(null),[_,W]=o.useState(null),[X,f]=o.useState(!1),[C,j]=o.useState([]),[w,q]=o.useState(""),[k,T]=o.useState(1),[Y,E]=o.useState(null),z=o.useMemo(()=>{const s=window.location.hash||"",t=s.indexOf("?");if(t===-1)return null;const n=new URLSearchParams(s.slice(t)).get("assignmentId"),m=n?Number(n):NaN;return Number.isFinite(m)?m:null},[d]),{data:Z,isLoading:L,error:R,refetch:ee}=F({queryKey:["assignments",r],queryFn:()=>h.getAssignments(r,c),enabled:!!r}),se=Z?.filter(s=>s.session_type==="swim")||[],a=z?se.find(s=>s.id===z):void 0,P=a?.session_id,{data:M}=F({queryKey:["swim-exercise-logs-by-catalog",P,c],queryFn:async()=>{const{data:s}=await O.auth.getSession(),t=s.session?.user?.id;if(!t)return[];const n=(await h.getSessions(r,c)).map(i=>i.id);if(n.length===0)return[];const m=[];for(const i of n.slice(0,10)){const u=await h.getSwimExerciseLogs(i);m.push(...u.filter(b=>b.user_id===t))}const x=new Set((a?.items??[]).map(i=>i.id).filter(Boolean));return m.filter(i=>i.source_item_id!=null&&x.has(i.source_item_id))},enabled:!!P&&!!c&&!!r}),v=o.useMemo(()=>_||(M?Ce(M):new Map),[_,M]),te=o.useCallback(s=>{J(t=>t===s?null:s)},[]),ae=o.useCallback((s,t)=>{W(l=>{const n=new Map(l??v);return n.set(s,t),n}),f(!0)},[v]),K=o.useCallback(()=>{const s=w.trim();if(!s)return;const t=Date.now();j(l=>[...l,{id:t,label:s,reps:k,log:{exercise_label:s,split_times:[],stroke_count:[],tempo:null,notes:null}}]),q(""),T(1),E(t),f(!0)},[w,k]),ne=o.useCallback(s=>{j(t=>t.filter(l=>l.id!==s)),f(!0)},[]),ie=o.useCallback((s,t)=>{j(l=>l.map(n=>n.id===s?{...n,log:t}:n)),f(!0)},[]),I=Q({mutationFn:async()=>{const{data:s}=await O.auth.getSession(),t=s.session?.user?.id;if(!t||!r)throw new Error("Non authentifié");const l=a?.assigned_date?new Date(a.assigned_date).toISOString().slice(0,10):new Date().toISOString().slice(0,10),n=ke(a?.assigned_date),m=await h.ensureSwimSession({athleteName:r,athleteId:c,date:l,slot:n}),x=[];if(a)for(const[,i]of v){const u=(i.split_times??[]).some(N=>N.time_seconds>0),b=(i.stroke_count??[]).some(N=>N.count>0);(u||b||i.tempo!=null||i.notes?.trim())&&x.push(i)}else for(const i of C){const u=i.log,b=(u.split_times??[]).some(D=>D.time_seconds>0),B=(u.stroke_count??[]).some(D=>D.count>0);(b||B||u.tempo!=null||u.notes?.trim())&&x.push({...u,exercise_label:i.label})}if(x.length===0)throw new Error("Aucune donnée à sauvegarder");await h.saveSwimExerciseLogs(m,t,x)},onSuccess:()=>{f(!1),a||j([]),S.invalidateQueries({queryKey:["swim-exercise-logs-by-catalog"]}),S.invalidateQueries({queryKey:["swim-exercise-logs-history"]}),p({title:"Notes techniques sauvegardées"})},onError:s=>{p({title:"Erreur",description:s.message,variant:"destructive"})}}),re=Q({mutationFn:s=>h.assignments_delete(s),onSuccess:()=>{S.invalidateQueries({queryKey:["assignments"]}),p({title:"Séance retirée",description:"La séance a été retirée de votre feed."}),A("/")},onError:()=>{p({title:"Erreur",description:"Impossible de retirer la séance.",variant:"destructive"})}}),oe=async()=>{if(a)try{const s=await fe(a.session_id),t=`${window.location.origin}${window.location.pathname}#/s/${s}`;navigator.share?await navigator.share({title:a.title,url:t}):(await navigator.clipboard.writeText(t),p({title:"Lien copié !",description:"Le lien de partage a été copié dans le presse-papier."}))}catch{p({title:"Erreur",description:"Impossible de générer le lien de partage.",variant:"destructive"})}};return R?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(be,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:R.message}),e.jsx(g,{onClick:()=>ee(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>A("/"),"aria-label":"Retour à l'accueil",children:e.jsx(je,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Séance natation"}),e.jsx("h1",{className:"text-2xl font-display font-bold uppercase",children:"Détails"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a?e.jsx(g,{variant:"ghost",size:"icon",onClick:oe,"aria-label":"Partager la séance",children:e.jsx(we,{className:"h-5 w-5"})}):null,a?e.jsx(U,{variant:"secondary",className:"text-xs",children:Se[a.status]??"Assignée"}):null]})]}),e.jsx(ue,{className:"border border-border shadow-sm",children:e.jsxs(me,{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight",children:a?.title??"Détails techniques libres"}),!a&&!L?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Saisissez vos exercices et détails techniques manuellement."}):null]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx(U,{variant:"outline",className:"text-xs",children:a?_e(a.assigned_date):H(new Date,"dd MMM",{locale:V})}),a?e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{window.confirm("Retirer cette séance de votre feed ?")&&re.mutate(a.id)},className:"text-xs text-muted-foreground hover:text-foreground",children:"Retirer de mon feed"}):null]}),e.jsx(xe,{}),L?null:e.jsx("div",{className:"rounded-xl bg-muted/50 px-3 py-2 text-xs text-muted-foreground leading-relaxed",children:a?"Tapez sur un exercice pour ajouter vos temps et détails techniques.":"Ajoutez vos exercices manuellement et renseignez vos détails techniques."}),L?e.jsxs("div",{className:"space-y-4","aria-live":"polite","aria-busy":"true",children:[e.jsx("div",{className:"sr-only",children:"Chargement de la séance..."}),e.jsx(y,{className:"h-6 w-48"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,t)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"h-5 w-32"}),e.jsx(y,{className:"h-4 w-full"}),e.jsx(y,{className:"h-4 w-3/4"})]},`skeleton-${t}`))})]}):a?e.jsx(ge,{title:a.title,description:a.description,items:a.items,showHeader:!0,exerciseLogs:v,expandedItemId:G,onToggleExpand:te,onLogChange:ae}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Exercice"}),e.jsx("input",{type:"text",placeholder:"ex: 6x50m crawl",value:w,onChange:s=>q(s.target.value),onKeyDown:s=>{s.key==="Enter"&&K()},className:"h-9 w-full rounded-md border border-input bg-background px-3 text-sm focus:outline-none focus:ring-1 focus:ring-ring"})]}),e.jsxs("div",{className:"w-16 space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Reps"}),e.jsx("input",{type:"number",min:1,inputMode:"numeric",value:k,onChange:s=>T(Math.max(1,parseInt(s.target.value,10)||1)),className:"h-9 w-full rounded-md border border-input bg-background px-2 text-sm text-center focus:outline-none focus:ring-1 focus:ring-ring"})]}),e.jsxs(g,{size:"sm",onClick:K,disabled:!w.trim(),className:"h-9 gap-1",children:[e.jsx(pe,{className:"h-4 w-4"}),"Ajouter"]})]}),C.length===0?e.jsx("div",{className:"rounded-2xl border border-dashed border-muted/70 bg-muted/30 p-6 text-center text-sm text-muted-foreground",children:"Ajoutez un exercice ci-dessus pour commencer."}):e.jsx("div",{className:"space-y-2",children:C.map(s=>{const t=Y===s.id,l={label:s.label,raw_payload:{exercise_repetitions:s.reps}};return e.jsxs("div",{className:"rounded-xl border border-border overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2.5 cursor-pointer hover:bg-muted/40",onClick:()=>E(t?null:s.id),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium",children:s.label}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s.reps," rep",s.reps>1?"s":""]})]}),e.jsx("button",{type:"button",onClick:n=>{n.stopPropagation(),ne(s.id)},className:"p-1 rounded-md hover:bg-destructive/10 text-muted-foreground hover:text-destructive","aria-label":"Supprimer",children:e.jsx(ve,{className:"h-4 w-4"})})]}),t&&e.jsx(he,{item:l,log:s.log,onChange:n=>ie(s.id,n),onCollapse:()=>E(null)})]},s.id)})})]})]})}),X&&e.jsx("div",{className:"fixed bottom-6 left-0 right-0 flex justify-center z-50 px-4",children:e.jsxs(g,{onClick:()=>I.mutate(),disabled:I.isPending,className:"gap-2 shadow-lg",children:[I.isPending?e.jsx(Ne,{className:"h-4 w-4 animate-spin"}):e.jsx(ye,{className:"h-4 w-4"}),"Enregistrer"]})})]})}export{Ze as default};
