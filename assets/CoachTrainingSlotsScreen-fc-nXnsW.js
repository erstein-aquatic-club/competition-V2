import{c as he,r as o,d as U,j as e,u as H}from"./vendor-query-DyA9aSKS.js";import{u as Tt,d as $t,a as I,c as Et}from"./api-DH3S2bDc.js";import{b as pe,L as $,l as st,P as te,B as P,I as le,f as At,W as qt,d as Ae,u as Pt,a4 as at}from"./index-CKOp3laj.js";import{C as It}from"./Coach-Byz1Ge8c.js";import{S as ge,a as fe,b as be,c as je,d as ve}from"./sheet-Cn2eTIxn.js";import{B as qe}from"./badge-CUY68dk4.js";import{C as Lt}from"./checkbox-DKY9-mYV.js";import{S as Ne}from"./separator-mo9I2cXM.js";import{A as rt,a as nt,b as it,c as lt,d as ot,e as dt,f as ct,g as mt}from"./alert-dialog-Dq5B--PU.js";import{C as ut}from"./clock-BVe1tolP.js";import{M as Pe}from"./map-pin-DkEZPo4r.js";import{L as xt}from"./loader-circle-CS0lcH0k.js";import{P as ht}from"./pencil-Ig7VrKD1.js";import{C as Vt}from"./copy-Dg3I4HC6.js";import{E as zt}from"./eye-off-BqTJbVnV.js";import{E as Rt}from"./eye-ClJQOC11.js";import{T as pt}from"./trash-2-BQv-XUf6.js";import{w as Ot}from"./swim-DtScx2FQ.js";import{c as Ht}from"./swimSessionUtils-DN7EW4yB.js";import{S as Bt}from"./search-B8-89IkC.js";import{S as se,a as ae,b as re,c as ne,d as z,f as ee}from"./select-D1b_6E6w.js";import{R as Kt,a as Qe}from"./radio-group-DeZYKD91.js";import{C as De}from"./chevron-left-BlNxr-HM.js";import{C as gt}from"./chevron-right-a5KQZPs8.js";import{C as Wt}from"./index-DdZuhBjQ.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./arrow-left-DenKjfV1.js";import"./trophy-DfrB0oOG.js";import"./bell-ring-C3uCTd83.js";import"./zap-B17Inx0e.js";import"./index-CDTWfNF6.js";import"./index-DCX2sNhR.js";import"./index-DUMkj-cL.js";import"./chevron-down-CvY7q17H.js";import"./chevron-up-BIy5Ncdb.js";import"./index-CT7pRBuX.js";import"./circle-DYMtKYdJ.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gt=[["path",{d:"M4.929 4.929 19.07 19.071",key:"196cmz"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],Qt=pe("ban",Gt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]],Fe=pe("book-open",Ut);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"M10.1 2.182a10 10 0 0 1 3.8 0",key:"5ilxe3"}],["path",{d:"M13.9 21.818a10 10 0 0 1-3.8 0",key:"11zvb9"}],["path",{d:"M17.609 3.721a10 10 0 0 1 2.69 2.7",key:"1iw5b2"}],["path",{d:"M2.182 13.9a10 10 0 0 1 0-3.8",key:"c0bmvh"}],["path",{d:"M20.279 17.609a10 10 0 0 1-2.7 2.69",key:"1ruxm7"}],["path",{d:"M21.818 10.1a10 10 0 0 1 0 3.8",key:"qkgqxc"}],["path",{d:"M3.721 6.391a10 10 0 0 1 2.7-2.69",key:"1mcia2"}],["path",{d:"M6.391 20.279a10 10 0 0 1-2.69-2.7",key:"1fvljs"}]],Ue=pe("circle-dashed",Yt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=[["path",{d:"M11 17a4 4 0 0 1-8 0V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2Z",key:"1ldrpk"}],["path",{d:"M16.7 13H19a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H7",key:"11i5po"}],["path",{d:"M 7 17h.01",key:"1euzgo"}],["path",{d:"m11 8 2.3-2.3a2.4 2.4 0 0 1 3.404.004L18.6 7.6a2.4 2.4 0 0 1 .026 3.434L9.9 19.8",key:"o2gii7"}]],Xt=pe("swatch-book",Jt);function Zt(t,a){return t?t.visible_from===null||t.visible_from===void 0||t.visible_from<=a?"published":"draft":"empty"}const es=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];function Ye(t){return t.slice(0,5)}function Je(t){const[a,r,c]=t.split("-").map(Number),b=new Date(a,r-1,c),u=(b.getDay()+6)%7,f=es[u],x=b.toLocaleDateString("fr-FR",{month:"long"});return`${f} ${c} ${x}`}const Te={empty:{label:"",badgeClass:""},draft:{label:"Brouillon",badgeClass:"bg-amber-500/15 text-amber-600 dark:text-amber-400 border-amber-500/25"},published:{label:"Publié",badgeClass:"bg-emerald-500/15 text-emerald-600 dark:text-emerald-400 border-emerald-500/25"},cancelled:{label:"Annulé",badgeClass:"bg-muted text-muted-foreground border-border/50"}};function ts({instance:t,open:a,onOpenChange:r,onCreateNew:c,onEditSession:b,onPickTemplate:u,onEditSlot:f,onManageOverride:x}){const k=he(),[p,g]=o.useState([]),[N,S]=o.useState(""),[_,w]=o.useState(!1),[l,v]=o.useState(!1);o.useEffect(()=>{t&&(g(t.groups.map(n=>n.group_id)),S(t.assignment?.visible_from??t.date),w(!1),v(!1))},[t]);const j=o.useCallback(()=>{k.invalidateQueries({queryKey:["slot-assignments"]})},[k]),M=U({mutationFn:n=>Tt(n),onSuccess:()=>{j(),w(!1)}}),m=U({mutationFn:n=>$t(n),onSuccess:()=>{j(),v(!1),r(!1)}}),D=n=>{g(d=>d.includes(n)?d.filter(V=>V!==n):[...d,n])},F=()=>{t&&M.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date,visibleFrom:N||null})},T=()=>{t&&m.mutate({trainingSlotId:t.slot.id,scheduledDate:t.date})},E=()=>{!t||!f||(r(!1),f(t))},y=()=>{!t||!x||(r(!1),x(t))};if(!t)return null;const{state:A,slot:q,assignment:R,override:L,groups:K}=t,C=Te[A];return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:a,onOpenChange:r,children:e.jsxs(fe,{side:"bottom",className:"rounded-t-3xl max-h-[85vh] overflow-y-auto px-5 pb-8 pt-4",children:[e.jsx("div",{className:"mx-auto mb-4 h-1 w-10 rounded-full bg-border/60"}),e.jsxs(be,{className:"text-left space-y-1.5 mb-5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"text-base font-bold leading-tight",children:Je(t.date)}),A!=="empty"&&e.jsx(qe,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${C.badgeClass}`,children:C.label})]}),e.jsxs(ve,{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ut,{className:"h-3 w-3 opacity-60"}),Ye(q.start_time)," – ",Ye(q.end_time)]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Pe,{className:"h-3 w-3 opacity-60"}),q.location]})]})]}),A==="cancelled"&&e.jsx(ss,{override:L,onEditSlot:E,onManageOverride:y,canEditSlot:!!f,canManageOverride:!!x}),A==="empty"&&e.jsx(as,{instance:t,groups:K,selectedGroups:p,visibleFrom:N,onToggleGroup:D,onVisibleFromChange:S,onCreateNew:c,onPickTemplate:u,onClose:()=>r(!1),onEditSlot:E,onManageOverride:y,canEditSlot:!!f,canManageOverride:!!x}),(A==="draft"||A==="published")&&e.jsx(rs,{instance:t,assignment:R,showVisibilityPicker:_,visibleFrom:N,visibilityLoading:M.isPending,deleteLoading:m.isPending,onToggleVisibilityPicker:()=>w(n=>!n),onVisibleFromChange:S,onSaveVisibility:F,onEditSession:b,onRequestDelete:()=>v(!0),onEditSlot:E,onManageOverride:y,canEditSlot:!!f,canManageOverride:!!x})]})}),e.jsx(rt,{open:l,onOpenChange:v,children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(lt,{children:"Supprimer la séance ?"}),e.jsxs(ot,{children:["Cette action supprimera définitivement la séance assignée pour ce créneau le ",Je(t.date),". Les nageurs ne verront plus cette séance."]})]}),e.jsxs(dt,{children:[e.jsx(ct,{disabled:m.isPending,children:"Annuler"}),e.jsx(mt,{onClick:T,disabled:m.isPending,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(xt,{className:"mr-2 h-4 w-4 animate-spin"}),"Suppression..."]}):"Supprimer"})]})]})})]})}function ss({override:t,onEditSlot:a,onManageOverride:r,canEditSlot:c,canManageOverride:b}){return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"rounded-xl bg-muted/40 border border-border/50 p-4 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Ce créneau a été annulé"}),t?.reason&&e.jsx("p",{className:"mt-1.5 text-xs text-muted-foreground/70 italic",children:t.reason})]}),e.jsx(Ie,{canEditSlot:c,canManageOverride:b,onEditSlot:a,onManageOverride:r})]})}function as({instance:t,groups:a,selectedGroups:r,visibleFrom:c,onToggleGroup:b,onVisibleFromChange:u,onCreateNew:f,onPickTemplate:x,onClose:k,onEditSlot:p,onManageOverride:g,canEditSlot:N,canManageOverride:S}){const _=()=>{k(),f(t)},w=()=>{k(),x(t)};return e.jsxs("div",{className:"space-y-5",children:[a.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Groupes"}),e.jsx("div",{className:"space-y-2.5",children:a.map(l=>e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx(Lt,{checked:r.includes(l.group_id),onCheckedChange:()=>b(l.group_id),className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:l.group_name})]},l.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs($,{htmlFor:"visible-from-empty",className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:[e.jsx(st,{className:"inline h-3 w-3 mr-1 opacity-60"}),"Visible à partir du"]}),e.jsx("input",{id:"visible-from-empty",type:"date",value:c,onChange:l=>u(l.target.value),className:"w-full rounded-xl border border-border bg-muted/30 px-3 py-2.5 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"})]}),e.jsx(Ne,{className:"my-1"}),e.jsxs("div",{className:"space-y-2.5",children:[e.jsxs("button",{type:"button",onClick:_,className:"flex w-full items-center gap-3 rounded-xl bg-primary/10 px-4 py-3.5 text-left transition-colors active:bg-primary/20 hover:bg-primary/15",children:[e.jsx("div",{className:"flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-primary/15",children:e.jsx(te,{className:"h-4.5 w-4.5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Nouvelle séance"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Créer une séance de zéro"})]})]}),e.jsxs("button",{type:"button",onClick:w,className:"flex w-full items-center gap-3 rounded-xl bg-muted/50 border border-border/50 px-4 py-3.5 text-left transition-colors active:bg-muted/80 hover:bg-muted/70",children:[e.jsx("div",{className:"flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-muted",children:e.jsx(Fe,{className:"h-4.5 w-4.5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Depuis la bibliothèque"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:"Utiliser une séance existante"})]})]})]}),e.jsx(Ie,{canEditSlot:N,canManageOverride:S,onEditSlot:p,onManageOverride:g})]})}function rs({instance:t,assignment:a,showVisibilityPicker:r,visibleFrom:c,visibilityLoading:b,deleteLoading:u,onToggleVisibilityPicker:f,onVisibleFromChange:x,onSaveVisibility:k,onEditSession:p,onRequestDelete:g,onEditSlot:N,onManageOverride:S,canEditSlot:_,canManageOverride:w}){return e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"rounded-xl bg-muted/30 border border-border/50 p-4",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground leading-snug",children:a.session_name??"Séance sans nom"}),a.session_distance!=null&&a.session_distance>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[a.session_distance," m"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(qe,{variant:"outline",className:`text-[10px] px-2 py-0.5 font-medium leading-none ${Te[t.state].badgeClass}`,children:Te[t.state].label}),a.visible_from&&e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Visible le"," ",new Date(a.visible_from).toLocaleDateString("fr-FR",{day:"numeric",month:"short"})]})]})]}),t.groups.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.groups.map(l=>e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-medium border border-border/50 bg-muted/60 text-muted-foreground",children:l.group_name},l.id))}),e.jsx(Ne,{className:"my-1"}),e.jsxs("div",{className:"space-y-2.5",children:[a.swim_catalog_id!=null&&e.jsx(Z,{icon:e.jsx(ht,{className:"h-4 w-4"}),label:"Modifier",description:"Ouvrir dans l'éditeur",onClick:()=>p(a.swim_catalog_id)}),e.jsx(Z,{icon:e.jsx(Vt,{className:"h-4 w-4"}),label:"Dupliquer vers...",description:"Bientôt disponible",disabled:!0,onClick:()=>{}}),e.jsx(Z,{icon:r?e.jsx(zt,{className:"h-4 w-4"}):e.jsx(Rt,{className:"h-4 w-4"}),label:"Visibilité",description:"Date de publication pour les nageurs",onClick:f}),r&&e.jsxs("div",{className:"ml-12 space-y-2.5 rounded-xl border border-border/50 bg-muted/20 p-3",children:[e.jsx($,{htmlFor:"visible-from-edit",className:"text-xs text-muted-foreground",children:"Visible à partir du"}),e.jsx("input",{id:"visible-from-edit",type:"date",value:c,onChange:l=>x(l.target.value),className:"w-full rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{size:"sm",className:"flex-1 rounded-lg",disabled:b,onClick:k,children:[b?e.jsx(xt,{className:"mr-1.5 h-3.5 w-3.5 animate-spin"}):null,"Enregistrer"]}),e.jsx(P,{size:"sm",variant:"ghost",className:"rounded-lg",disabled:b,onClick:f,children:"Annuler"})]})]}),e.jsx(Z,{icon:e.jsx(pt,{className:"h-4 w-4"}),label:"Supprimer",description:"Retirer cette séance du créneau",variant:"destructive",disabled:u,onClick:g})]}),e.jsx(Ie,{canEditSlot:_,canManageOverride:w,onEditSlot:N,onManageOverride:S})]})}function Ie({canEditSlot:t,canManageOverride:a,onEditSlot:r,onManageOverride:c}){return!t&&!a?null:e.jsxs("div",{className:"space-y-2.5",children:[e.jsx(Ne,{className:"my-1"}),e.jsx("p",{className:"text-xs font-semibold uppercase tracking-wider text-muted-foreground",children:"Créneau"}),t&&e.jsx(Z,{icon:e.jsx(ht,{className:"h-4 w-4"}),label:"Modifier le créneau",description:"Horaires, lieu et groupes",onClick:r}),a&&e.jsx(Z,{icon:e.jsx(st,{className:"h-4 w-4"}),label:"Gérer l'exception",description:"Annuler ou ajuster ce jour précis",onClick:c})]})}function Z({icon:t,label:a,description:r,variant:c="default",disabled:b=!1,onClick:u}){const f=c==="destructive";return e.jsxs("button",{type:"button",onClick:u,disabled:b,className:`
        flex w-full items-center gap-3 rounded-xl px-4 py-3.5 text-left transition-colors
        ${b?"opacity-40 cursor-not-allowed":"active:scale-[0.98]"}
        ${f?"bg-destructive/5 hover:bg-destructive/10 active:bg-destructive/15":"bg-muted/40 hover:bg-muted/60 active:bg-muted/80"}
      `,children:[e.jsx("div",{className:`flex h-9 w-9 shrink-0 items-center justify-center rounded-lg ${f?"bg-destructive/10 text-destructive":"bg-muted text-muted-foreground"}`,children:t}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm font-semibold ${f?"text-destructive":"text-foreground"}`,children:a}),r&&e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:r})]})]})}function ns({open:t,onOpenChange:a,onSelect:r}){const[c,b]=o.useState(""),{data:u,isLoading:f}=H({queryKey:["swim_catalog"],queryFn:()=>Ot(),enabled:t}),x=o.useMemo(()=>{if(!u)return[];const p=c.trim().toLowerCase();return u.filter(g=>!g.is_archived).filter(g=>!p||g.name.toLowerCase().includes(p)||(g.folder??"").toLowerCase().includes(p)).sort((g,N)=>g.name.localeCompare(N.name,"fr"))},[u,c]),k=p=>{r(p.id,p.name),a(!1)};return e.jsx(ge,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"bottom",className:"flex h-[80vh] flex-col rounded-t-2xl px-4 pb-4 pt-5",children:[e.jsxs(be,{className:"shrink-0 space-y-1",children:[e.jsx(je,{className:"text-base font-semibold",children:"Choisir une séance"}),e.jsx(ve,{className:"sr-only",children:"Parcourez et recherchez dans la bibliothèque de séances natation"})]}),e.jsxs("div",{className:"relative mt-3 shrink-0",children:[e.jsx(Bt,{className:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),e.jsx(le,{placeholder:"Rechercher une séance...",value:c,onChange:p=>b(p.target.value),className:"pl-9"})]}),e.jsx("div",{className:"mt-3 flex-1 overflow-y-auto overscroll-contain",children:f?e.jsx("div",{className:"space-y-3",children:Array.from({length:6}).map((p,g)=>e.jsx(At,{className:"h-[72px] w-full rounded-xl"},g))}):x.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-16 text-muted-foreground",children:[e.jsx(qt,{className:"h-10 w-10 opacity-40"}),e.jsx("p",{className:"text-sm",children:"Aucune séance dans la bibliothèque"})]}):e.jsx("div",{className:"space-y-2",children:x.map(p=>{const g=Ht(p.items??[]);return e.jsxs("button",{type:"button",onClick:()=>k(p),className:"flex w-full items-center gap-3 rounded-xl border border-border bg-card p-3 text-left shadow-sm transition-transform active:scale-[0.98]",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-blue-500/10 text-blue-400",children:e.jsx(Xt,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"truncate text-sm font-medium text-foreground",children:p.name}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-2 text-xs text-muted-foreground",children:[g>0&&e.jsxs("span",{children:[g.toLocaleString("fr-FR")," m"]}),g>0&&p.folder&&e.jsx("span",{"aria-hidden":"true",children:"·"}),p.folder&&e.jsx("span",{className:"truncate",children:p.folder})]})]})]},p.id)})})})]})})}const Le=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],is=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],oe=6,ls=22,ft=ls-oe,xe=40,Xe=ft*xe,Ze=Array.from({length:ft+1},(t,a)=>oe+a);function B(t){return t.slice(0,5)}function Me(){return new Date().toISOString().slice(0,10)}function G(t){const[a,r]=t.split(":").map(Number);return a*60+r}function $e(t){return(G(t)-oe*60)/60*xe}function os(t,a){return $e(a)-$e(t)}function et(t){const a=new Date(t),r=a.getDay(),c=r===0?-6:1-r;return a.setDate(a.getDate()+c),a.setHours(0,0,0,0),a}function ds(t){const a=new Date(t);a.setHours(0,0,0,0),a.setDate(a.getDate()+3-(a.getDay()+6)%7);const r=new Date(a.getFullYear(),0,4);return 1+Math.round(((a.getTime()-r.getTime())/864e5-3+(r.getDay()+6)%7)/7)}function ie(t){return t.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function Q(t){const a=r=>String(r).padStart(2,"0");return`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}`}function Ee(t){const a=t.toLowerCase();return a.includes("piscine")||a.includes("bassin")||!a.includes("salle")&&!a.includes("muscu")&&!a.includes("ppg")&&!a.includes("gym")}function tt(t,a,r){const c={slot:{trainingSlotId:t.slot.id,scheduledDate:t.date,startTime:t.slot.start_time,endTime:t.slot.end_time,location:t.slot.location}};return a==="edit"&&r!=null?{mode:a,swimCatalogId:r,...c}:{mode:"create",...c}}const cs=({open:t,onOpenChange:a,slot:r,groups:c,coaches:b})=>{const{toast:u}=Ae(),f=he(),x=!!r,[k,p]=o.useState("1"),[g,N]=o.useState(""),[S,_]=o.useState(""),[w,l]=o.useState(""),[v,j]=o.useState([]),[M,m]=o.useState(1),[D,F]=o.useState(!1);o.useEffect(()=>{if(t)if(r){p(String(r.day_of_week)),N(B(r.start_time)),_(B(r.end_time)),l(r.location);const n=r.assignments.map((d,V)=>({key:V,group_id:String(d.group_id),coach_id:String(d.coach_id),lane_count:d.lane_count!=null?String(d.lane_count):""}));j(n),m(n.length)}else p("1"),N(""),_(""),l(""),j([]),m(1)},[t,r]);const T=()=>{j(n=>[...n,{key:M,group_id:"",coach_id:"",lane_count:""}]),m(n=>n+1)},E=n=>{j(d=>d.filter(V=>V.key!==n))},y=(n,d,V)=>{j(de=>de.map(W=>W.key===n?{...W,[d]:V}:W))},A=()=>!g||!S?(u({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):w.trim()?{day_of_week:Number(k),start_time:g,end_time:S,location:w.trim(),assignments:v.filter(n=>n.group_id&&n.coach_id).map(n=>({group_id:Number(n.group_id),coach_id:Number(n.coach_id),lane_count:n.lane_count?Number(n.lane_count):null}))}:(u({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),q=U({mutationFn:n=>I.createTrainingSlot(n),onSuccess:()=>{u({title:"Creneau cree"}),f.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:n=>{u({title:"Erreur",description:n.message,variant:"destructive"})}}),R=U({mutationFn:n=>I.updateTrainingSlot(r.id,n),onSuccess:()=>{u({title:"Creneau mis a jour"}),f.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:n=>{u({title:"Erreur",description:n.message,variant:"destructive"})}}),L=U({mutationFn:()=>I.deleteTrainingSlot(r.id),onSuccess:()=>{u({title:"Creneau supprime"}),f.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:n=>{u({title:"Erreur",description:n.message,variant:"destructive"})}}),K=()=>{const n=A();n&&(x?R.mutate(n):q.mutate(n))},C=q.isPending||R.isPending||L.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(je,{children:x?"Modifier le creneau":"Nouveau creneau"}),e.jsx(ve,{children:x?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Jour de la semaine *"}),e.jsxs(se,{value:k,onValueChange:p,children:[e.jsx(ae,{children:e.jsx(re,{})}),e.jsx(ne,{children:Le.map((n,d)=>e.jsx(z,{value:String(d+1),children:n},d+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:g,onChange:n=>N(n.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:S,onChange:n=>_(n.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(le,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:w,onChange:n=>l(n.target.value)})]}),e.jsx(Ne,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx($,{children:"Groupes & Coachs"}),e.jsxs(P,{type:"button",variant:"outline",size:"sm",onClick:T,children:[e.jsx(te,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),v.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),v.map(n=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(se,{value:n.group_id,onValueChange:d=>y(n.key,"group_id",d),children:[e.jsx(ae,{className:"h-8 text-xs",children:e.jsx(re,{placeholder:"Groupe..."})}),e.jsx(ne,{children:c.map(d=>e.jsx(z,{value:String(d.id),children:d.name},d.id))})]}),e.jsxs(se,{value:n.coach_id,onValueChange:d=>y(n.key,"coach_id",d),children:[e.jsx(ae,{className:"h-8 text-xs",children:e.jsx(re,{placeholder:"Coach..."})}),e.jsx(ne,{children:b.map(d=>e.jsx(z,{value:String(d.id),children:d.display_name},d.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{type:"number",min:0,placeholder:"Lignes d'eau",value:n.lane_count,onChange:d=>y(n.key,"lane_count",d.target.value),className:"h-8 text-xs flex-1"}),e.jsx(P,{type:"button",variant:"ghost",size:"icon",className:"h-10 w-10 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>E(n.key),children:e.jsx(pt,{className:"h-3.5 w-3.5"})})]})]})},n.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(P,{className:"w-full",onClick:K,disabled:C||!g||!S||!w.trim(),children:C?"Enregistrement...":x?"Enregistrer":"Creer"}),x&&e.jsx(P,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>F(!0),disabled:C,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(rt,{open:D,onOpenChange:F,children:e.jsxs(nt,{children:[e.jsxs(it,{children:[e.jsx(lt,{children:"Supprimer le creneau"}),e.jsx(ot,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(dt,{children:[e.jsx(ct,{children:"Annuler"}),e.jsx(mt,{onClick:()=>{L.mutate(),F(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},ms=({open:t,onOpenChange:a,slot:r})=>{const{toast:c}=Ae(),b=he(),[u,f]=o.useState(""),[x,k]=o.useState("cancelled"),[p,g]=o.useState(""),[N,S]=o.useState(""),[_,w]=o.useState(""),[l,v]=o.useState("");o.useEffect(()=>{t&&(f(""),k("cancelled"),g(r?B(r.start_time):""),S(r?B(r.end_time):""),w(r?.location??""),v(""))},[t,r]);const j=U({mutationFn:m=>I.createSlotOverride(m),onSuccess:()=>{c({title:"Exception enregistree"}),b.invalidateQueries({queryKey:["training-slot-overrides"]}),b.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:m=>{c({title:"Erreur",description:m.message,variant:"destructive"})}}),M=()=>{if(!r)return;if(!u){c({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const m={slot_id:r.id,override_date:u,status:x,new_start_time:x==="modified"&&p||null,new_end_time:x==="modified"&&N||null,new_location:x==="modified"&&_.trim()?_.trim():null,reason:l.trim()||null};j.mutate(m)};return e.jsx(ge,{open:t,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(je,{children:"Exception"}),e.jsx(ve,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:u,onChange:m=>f(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{children:"Type"}),e.jsxs(Kt,{value:x,onValueChange:m=>k(m),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Qe,{value:"cancelled",id:"ovr-cancelled"}),e.jsx($,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Qe,{value:"modified",id:"ovr-modified"}),e.jsx($,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),x==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:p,onChange:m=>g(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:N,onChange:m=>S(m.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(le,{id:"ovr-location",value:_,onChange:m=>w(m.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx($,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(le,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:l,onChange:m=>v(m.target.value)})]}),e.jsx(P,{className:"w-full",onClick:M,disabled:j.isPending||!u,children:j.isPending?"Enregistrement...":"Enregistrer"})]})]})})};function bt(t){return t?t.state:"empty"}function jt({state:t,compact:a=!1}){const r={empty:{label:"À renseigner",shortLabel:"À faire",icon:Ue,className:"border-border/60 bg-background/80 text-muted-foreground"},draft:{label:"Brouillon",shortLabel:"Brouillon",icon:Ue,className:"border-amber-500/30 bg-amber-500/10 text-amber-700 dark:text-amber-300"},published:{label:"Renseignée",shortLabel:"OK",icon:Wt,className:"border-emerald-500/30 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300"},cancelled:{label:"Annulé",shortLabel:"Annulé",icon:Qt,className:"border-border/60 bg-muted/60 text-muted-foreground"}},{icon:c,className:b,label:u,shortLabel:f}=r[t];return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-semibold leading-none ${b}`,title:u,"aria-label":u,children:[e.jsx(c,{className:"h-3 w-3 shrink-0"}),!a&&e.jsx("span",{children:f})]})}const us=({slot:t,instance:a,hasOverrides:r,cancelled:c=!1,onSelect:b})=>{const u=$e(t.start_time),f=os(t.start_time,t.end_time),x=f<50,k=Ee(t.location),p=bt(a),g=!!a?.assignment,N=a?.state==="draft",S=a?.state==="published",_=c?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":S?"bg-emerald-500/12 border-emerald-500/30 hover:bg-emerald-500/18":N?"bg-amber-500/12 border-amber-500/30 hover:bg-amber-500/18":k?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",w=S?"text-emerald-600 dark:text-emerald-400":N?"text-amber-600 dark:text-amber-400":k?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${_}`,style:{top:u,height:f,minHeight:24},onClick:()=>b(t),title:`${B(t.start_time)}–${B(t.end_time)} · ${t.location}${a?.assignment?.session_name?` · ${a.assignment.session_name}`:""}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${x?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx(Pe,{className:`h-2.5 w-2.5 shrink-0 ${w}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:t.location}),r&&!c&&e.jsx(at,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),e.jsx("span",{className:"shrink-0",children:e.jsx(jt,{state:p,compact:!0})})]}),!x&&t.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:t.assignments.map(l=>e.jsx(qe,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:l.group_name},l.id))}),!x&&f>=70&&t.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(t.assignments.map(l=>l.coach_name))].join(", ")}),!x&&g&&e.jsx("span",{className:`text-[9px] truncate ${N?"text-amber-700 dark:text-amber-300":"text-emerald-700 dark:text-emerald-300"}`,children:a?.assignment?.session_name??"Séance"})]})})};function xs(t,a){const r=G(a)-G(t),c=Math.floor(r/60),b=r%60;return c===0?`${b}min`:b===0?`${c}h`:`${c}h${String(b).padStart(2,"0")}`}const hs=({slotsByDay:t,slotInstancesById:a,weekDates:r,todayStr:c,overridesBySlot:b,cancelledSlotIds:u,onSelect:f,onPrevWeek:x,onNextWeek:k,weekNumber:p})=>{const[g,N]=o.useState(()=>{const l=r.findIndex(v=>Q(v)===c);return l>=0?l+1:1});o.useEffect(()=>{const l=r.findIndex(v=>Q(v)===c);l>=0?N(l+1):N(1)},[r,c]);const S=t.get(g)??[],_=o.useMemo(()=>{let l=22,v=6;return t.forEach(j=>{for(const M of j){const m=Math.floor(G(M.start_time)/60),D=Math.ceil(G(M.end_time)/60);m<l&&(l=m),D>v&&(v=D)}}),l>=v?{start:6,end:22}:{start:Math.max(0,l),end:Math.min(24,v)}},[t]),w=(_.end-_.start)*60;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:x,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",p]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[ie(r[0])," – ",ie(r[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-10 w-10 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:k,children:e.jsx(gt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border bg-card overflow-hidden",children:r.map((l,v)=>{const j=v+1,M=Q(l)===c,m=j===g,D=t.get(j)??[];return e.jsxs("button",{type:"button",className:`flex flex-col items-center py-2 transition-colors relative ${m?"bg-primary/8":"hover:bg-muted/50 active:bg-muted"}`,onClick:()=>N(j),children:[e.jsx("span",{className:`text-[10px] font-semibold uppercase tracking-wider ${M?"text-primary":"text-muted-foreground"}`,children:is[v]}),e.jsx("span",{className:`text-sm font-bold tabular-nums mt-0.5 h-10 w-10 flex items-center justify-center rounded-full ${M?"bg-primary text-primary-foreground":m?"text-foreground":"text-foreground/80"}`,children:l.getDate()}),e.jsx("div",{className:"w-full px-1 mt-1.5 h-8 relative",children:D.map(F=>{const T=G(F.start_time)-_.start*60,E=G(F.end_time)-_.start*60,y=Math.max(0,T/w*100),A=Math.max(8,(E-T)/w*100),q=Ee(F.location),R=u.has(F.id),L=a.get(F.id),K=L?.state==="published",C=L?.state==="draft";return e.jsx("div",{className:`absolute left-1 right-1 rounded-sm ${R?"bg-muted-foreground/20":K?"bg-emerald-500/50":C?"bg-amber-500/50":q?"bg-blue-500/40":"bg-amber-400/50"}`,style:{top:`${y}%`,height:`${A}%`,minHeight:"3px"}},F.id)})}),m&&e.jsx("div",{className:"absolute bottom-0 left-2 right-2 h-0.5 rounded-full bg-primary"})]},j)})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground px-0.5",children:[Le[g-1]," ",r[g-1]?.getDate()," ",e.jsx("span",{className:"font-normal text-muted-foreground",children:r[g-1]?.toLocaleDateString("fr-FR",{month:"long"})})]}),S.length===0?e.jsx("div",{className:"rounded-xl border border-dashed border-border/60 bg-muted/20 py-8 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun créneau"})}):e.jsx("div",{className:"space-y-2",children:S.map(l=>{const v=Ee(l.location),j=u.has(l.id),M=b.get(l.id)??[],m=M.length>0,D=a.get(l.id),F=bt(D),T=D?.state==="published",E=D?.state==="draft";return e.jsx("button",{type:"button",className:`w-full text-left rounded-xl border bg-card transition-all active:scale-[0.98] ${j?"opacity-50 border-border":"border-border hover:border-border/80"}`,onClick:()=>f(l),children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`w-1 rounded-l-xl flex-shrink-0 ${j?"bg-muted-foreground/30":v?"bg-blue-500":"bg-amber-400"}`}),e.jsxs("div",{className:"flex-1 px-3 py-2.5 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsxs("span",{className:`text-sm font-bold tabular-nums ${j?"line-through text-muted-foreground":"text-foreground"}`,children:[B(l.start_time)," – ",B(l.end_time)]}),e.jsx("span",{className:`text-xs tabular-nums px-1.5 py-0.5 rounded-md font-medium ${v?"bg-blue-500/10 text-blue-600 dark:text-blue-400":"bg-amber-400/10 text-amber-600 dark:text-amber-400"}`,children:xs(l.start_time,l.end_time)})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(jt,{state:F}),m&&!j&&e.jsx(at,{className:"h-3.5 w-3.5 text-orange-500 flex-shrink-0"})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-1",children:[e.jsx(Pe,{className:"h-3 w-3 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-xs text-muted-foreground truncate",children:l.location})]}),D?.assignment?.session_name&&e.jsxs("div",{className:"mt-1.5 flex items-center gap-1.5",children:[e.jsx("span",{className:`inline-flex rounded-md px-1.5 py-0.5 text-[10px] font-semibold ${E?"bg-amber-500/10 text-amber-700 dark:text-amber-300":T?"bg-emerald-500/10 text-emerald-700 dark:text-emerald-300":"bg-muted text-muted-foreground"}`,children:E?"Brouillon":"Publié"}),e.jsx("span",{className:"truncate text-xs font-medium text-foreground",children:D.assignment.session_name})]}),l.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-1.5",children:l.assignments.map(y=>e.jsxs("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded-md bg-muted text-muted-foreground",children:[y.group_name,y.coach_name?` · ${y.coach_name.split(" ")[0]}`:"",y.lane_count?` · ${y.lane_count}L`:""]},y.id))}),m&&!j&&e.jsx("div",{className:"mt-1.5 space-y-0.5",children:M.slice(0,2).map(y=>e.jsxs("div",{className:"flex items-center gap-1 text-[10px]",children:[e.jsxs("span",{className:`font-medium ${y.status==="cancelled"?"text-red-500":"text-orange-500"}`,children:[y.status==="cancelled"?"Annulé":"Modifié"," le"," ",new Date(y.override_date).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})]}),y.reason&&e.jsxs("span",{className:"text-muted-foreground truncate",children:["— ",y.reason]})]},y.id))})]})]})},l.id)})})]})]})},ta=({onBack:t,groups:a,onOpenLibrary:r})=>{const{toast:c}=Ae(),b=he(),{userId:u}=Pt(),[f,x]=o.useState(!1),[k,p]=o.useState(null),[g,N]=o.useState(null),[S,_]=o.useState(!1),[w,l]=o.useState(null),[v,j]=o.useState(!1),[M,m]=o.useState(!1),[D,F]=o.useState(null),[T,E]=o.useState(()=>et(new Date)),y=o.useMemo(()=>ds(T),[T]),A=o.useMemo(()=>{const s=new Date(T);return s.setDate(s.getDate()+6),s},[T]),q=o.useMemo(()=>Array.from({length:7},(s,i)=>{const h=new Date(T);return h.setDate(h.getDate()+i),h}),[T]),R=()=>E(s=>{const i=new Date(s);return i.setDate(i.getDate()-7),i}),L=()=>E(s=>{const i=new Date(s);return i.setDate(i.getDate()+7),i}),K=()=>E(et(new Date)),[C,n]=o.useState("all"),{data:d=[],isLoading:V}=H({queryKey:["training-slots"],queryFn:()=>I.getTrainingSlots()}),{data:de=[]}=H({queryKey:["training-slot-overrides"],queryFn:()=>I.getSlotOverrides()}),{data:W=[]}=H({queryKey:["users","coaches"],queryFn:()=>I.listUsers({role:"coach"})}),{data:Y=[]}=H({queryKey:["athletes"],queryFn:()=>I.getAthletes()}),O=C.startsWith("swimmer:")?Number(C.split(":")[1]):null,{data:ye}=H({queryKey:["swimmer-slots",O],queryFn:()=>I.getSwimmerSlots(O),enabled:O!=null}),{data:we}=H({queryKey:["swimmer-slots-exists",O],queryFn:()=>I.hasCustomSlots(O),enabled:O!=null}),Se=o.useMemo(()=>ye?ye.map(s=>({id:s.id,day_of_week:s.day_of_week,start_time:s.start_time,end_time:s.end_time,location:s.location,is_active:s.is_active,created_by:s.created_by,created_at:s.created_at,assignments:[]})):[],[ye]),ce=o.useMemo(()=>{if(C==="all")return d;if(C.startsWith("group:")){const s=Number(C.split(":")[1]);return d.filter(i=>i.assignments.some(h=>h.group_id===s))}if(C.startsWith("coach:")){const s=Number(C.split(":")[1]);return d.filter(i=>i.assignments.some(h=>h.coach_id===s))}if(C.startsWith("swimmer:")){if(we&&Se.length>0)return Se;const s=Y.find(i=>i.id===O);return s?.group_id?d.filter(i=>i.assignments.some(h=>h.group_id===s.group_id)):d}return d},[d,C,we,Se,Y,O]),Ve=o.useMemo(()=>{const s=new Map;for(let i=1;i<=7;i++)s.set(i,[]);for(const i of ce)s.get(i.day_of_week).push(i);for(const i of s.values())i.sort((h,X)=>h.start_time.localeCompare(X.start_time));return s},[ce]),me=Q(T),ue=Q(A),{data:ze=[]}=H({queryKey:["slot-assignments",me,ue],queryFn:()=>I.getSlotAssignments({from:me,to:ue})}),J=o.useMemo(()=>de.filter(s=>s.override_date>=me&&s.override_date<=ue),[de,me,ue]),Re=o.useMemo(()=>{const s=new Map;for(const i of J){const h=s.get(i.slot_id)??[];h.push(i),s.set(i.slot_id,h)}return s},[J]),Oe=o.useMemo(()=>{const s=new Set;for(const i of J)i.status==="cancelled"&&s.add(i.slot_id);return s},[J]),He=o.useMemo(()=>{const s=new Map;for(const i of ze){if(!i.training_slot_id)continue;const h=`${i.training_slot_id}:${i.scheduled_date}`;s.has(h)||s.set(h,i)}return s},[ze]),_e=o.useMemo(()=>{const s=new Map,i=Me();for(const h of ce){const X=q[h.day_of_week-1];if(!X)continue;const Ce=Q(X),Ke=J.find(Ge=>Ge.slot_id===h.id&&Ge.override_date===Ce),We=He.get(`${h.id}:${Ce}`),Ft=Ke?.status==="cancelled"?"cancelled":Zt(We,i);s.set(h.id,{date:Ce,slot:h,groups:h.assignments,state:Ft,assignment:We,override:Ke})}return s},[He,ce,q,J]),ke=()=>{p(null),x(!0)},vt=s=>{l(s),j(!0)},Be=s=>{const i=_e.get(s.id);i&&vt(i)},Nt=s=>{p(s.slot),x(!0)},yt=s=>{N(s.slot),_(!0)},wt=s=>{r&&(j(!1),r(tt(s,"create")))},St=s=>{if(r){if(j(!1),!w){r();return}r(tt(w,"edit",s))}},_t=s=>{F(s),j(!1),m(!0)},kt=U({mutationFn:async({catalogId:s,instance:i})=>{const h=i.groups.map(X=>X.group_id);!u||h.length===0||await I.bulkCreateSlotAssignments({swimCatalogId:s,trainingSlotId:i.slot.id,scheduledDate:i.date,groupIds:h,scheduledSlot:Et(i.slot.start_time),visibleFrom:i.date,assignedBy:u})},onSuccess:()=>{b.invalidateQueries({queryKey:["slot-assignments"]}),m(!1),F(null)},onError:s=>{c({title:"Erreur",description:s.message,variant:"destructive"})}}),Ct=s=>{D&&kt.mutate({catalogId:s,instance:D})},Mt=W.map(s=>({id:s.id,display_name:s.display_name})),Dt=d.length===0?"Planning hebdomadaire des entrainements.":`${d.length} creneau${d.length>1?"x":""}`;return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{variant:"ghost",size:"icon",className:"h-10 w-10 -ml-2",onClick:t,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),d.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[d.length," créneau",d.length>1?"x":""," actif",d.length>1?"s":""]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full border border-border bg-card text-primary active:scale-90 transition-all",onClick:()=>r(),"aria-label":"Ouvrir la bibliothèque",children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:ke,children:e.jsx(te,{className:"h-4 w-4"})})]})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(It,{title:"Creneaux",description:Dt,onBack:t,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>r(),children:[e.jsx(Fe,{className:"mr-1.5 h-3.5 w-3.5"}),"Bibliothèque"]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:ke,children:[e.jsx(te,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})]})})}),!V&&d.length>0&&e.jsx("div",{className:"sm:hidden",children:e.jsxs(se,{value:C,onValueChange:n,children:[e.jsx(ae,{className:"w-full",children:e.jsx(re,{placeholder:"Filtrer..."})}),e.jsxs(ne,{children:[e.jsx(z,{value:"all",children:"Tous les créneaux"}),e.jsx(ee,{}),a.map(s=>e.jsx(z,{value:`group:${s.id}`,children:s.name},s.id)),Y.length>0&&e.jsx(ee,{}),Y.map(s=>e.jsx(z,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(P,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:R,children:e.jsx(De,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:K,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",y]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[ie(T)," – ",ie(A)]})]}),e.jsx(P,{variant:"ghost",size:"icon",className:"h-10 w-10",onClick:L,children:e.jsx(gt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-row items-center gap-3",children:e.jsxs(se,{value:C,onValueChange:n,children:[e.jsx(ae,{className:"w-56",children:e.jsx(re,{placeholder:"Filtrer..."})}),e.jsxs(ne,{children:[e.jsx(z,{value:"all",children:"Tous les créneaux"}),e.jsx(ee,{}),a.map(s=>e.jsx(z,{value:`group:${s.id}`,children:s.name},s.id)),W.length>0&&e.jsx(ee,{}),W.map(s=>e.jsx(z,{value:`coach:${s.id}`,children:s.display_name},s.id)),Y.length>0&&e.jsx(ee,{}),Y.map(s=>e.jsx(z,{value:`swimmer:${s.id}`,children:s.display_name},`swimmer:${s.id}`))]})]})})]}),V?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-28 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-0 rounded-xl border border-border overflow-hidden",children:Array.from({length:7},(s,i)=>e.jsxs("div",{className:"flex flex-col items-center py-2 gap-1",children:[e.jsx("div",{className:"h-3 w-6 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-5 rounded bg-muted/50 animate-pulse motion-reduce:animate-none mt-1"})]},i))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),Array.from({length:3},(s,i)=>e.jsx("div",{className:"h-20 rounded-xl bg-muted animate-pulse motion-reduce:animate-none"},i))]})]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(s,i)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},i))})]}):d.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(ut,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:ke,children:[e.jsx(te,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[O!=null&&we===!1&&e.jsx("div",{className:"rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/30 px-3 py-2 text-sm text-blue-700 dark:text-blue-300",children:"Ce nageur hérite des créneaux du groupe. Personnalisez depuis sa fiche."}),e.jsx("div",{className:"sm:hidden",children:e.jsx(hs,{slotsByDay:Ve,slotInstancesById:_e,weekDates:q,todayStr:Me(),overridesBySlot:Re,cancelledSlotIds:Oe,onSelect:Be,onPrevWeek:R,onNextWeek:L,weekNumber:y})}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",q.map((s,i)=>{const h=Q(s)===Me();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:Le[i]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${h?"text-primary font-bold":"text-muted-foreground/60"}`,children:ie(s)})]},i)}),e.jsx("div",{className:"relative",style:{height:Xe},children:Ze.map(s=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(s-oe)*xe},children:[s,"h"]},s))}),Array.from({length:7},(s,i)=>i+1).map(s=>{const i=Ve.get(s)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:Xe},children:[Ze.map(h=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(h-oe)*xe}},h)),i.map(h=>e.jsx(us,{slot:h,instance:_e.get(h.id),hasOverrides:(Re.get(h.id)??[]).length>0,cancelled:Oe.has(h.id),onSelect:Be},h.id))]},s)})]})})]}),e.jsx(ts,{instance:w,open:v,onOpenChange:j,onCreateNew:wt,onEditSession:St,onPickTemplate:_t,onEditSlot:Nt,onManageOverride:yt}),e.jsx(cs,{open:f,onOpenChange:x,slot:k,groups:a,coaches:Mt}),e.jsx(ms,{open:S,onOpenChange:_,slot:g}),e.jsx(ns,{open:M,onOpenChange:m,onSelect:(s,i)=>Ct(s)})]})};export{ta as default};
