import{r as l,j as e,c as yt,u as Pe,d as De,a as Ce}from"./vendor-query-BiSH4r2z.js";import{a as se}from"./api-Bd-ZTqvd.js";import{c as Ne,b as Lt,W as Xe,X as Ke,F as Nt,u as It,d as Pt,s as qe,B as Kt,T as Tt}from"./index-BM3A1Jk-.js";import{P as $t,C as Qe,M as Bt,a as Rt,b as qt}from"./CalendarGrid-Bz4tYzjO.js";import{A as Ae,B as Qt}from"./BottomActionBar-CRvLTm4a.js";import{a as zt,s as Jt,l as et}from"./animations-CrcLFysI.js";import{d as tt}from"./design-tokens-CKgCpdH6.js";import{C as jt}from"./chevron-right-C52k_PE1.js";import{m as ie}from"./proxy-Dh0N-Z8G.js";import{C as Ut}from"./chevron-down-DpEJ8bBy.js";import{C as Ge}from"./check-Bqa3PET7.js";import{P as Te}from"./plus-qnL-LkiR.js";import{A as st,H as nt,f as ze,p as Ht}from"./swimConsultationUtils-U-1WyBpl.js";import{T as Je}from"./trash-2-D_kDCLp4.js";import{T as rt}from"./timer-BIHlzHfb.js";import{P as Vt}from"./pencil-Dy-SKXXs.js";import{C as Yt}from"./circle-alert-BHgSTuEc.js";import"./vendor-react-BzrpNAyj.js";import"./swim-BO0twgLF.js";import"./vendor-supabase-6k692oZB.js";import"./chevron-left-CvvOT4S1.js";import"./loader-circle-VxmsB0Sg.js";import"./circle-check-D01musGO.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],it=Ne("info",Wt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xt=[["path",{d:"M5 12h14",key:"1ays0h"}]],vt=Ne("minus",Xt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gt=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],ot=Ne("settings-2",Gt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],es=Ne("sun",Zt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],at=Ne("user-check",ts);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Ee=Ne("user-x",ss),Ue={NL:"",DOS:"",BR:"",PAP:"",QN:""};function lt(t){return String(t).padStart(2,"0")}function ct(t){return`${t.getFullYear()}-${lt(t.getMonth()+1)}-${lt(t.getDate())}`}function dt(t){return new Date(t.getFullYear(),t.getMonth(),1)}function ut(t,s){const i=new Date(t);return i.setDate(i.getDate()+s),i}function He(t){return(t.getDay()+6)%7}function Fe(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function ns(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}function rs(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(i=>i.trim()).filter(Boolean).flatMap(i=>{const o=i.replace(/^[•\\-–—]\\s*/,"").trim();return o?[o]:[]}):[]}function is(t){if(!t)return null;const i=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!i)return null;const o=Number(String(i[1]).replace(",","."));return Number.isFinite(o)?i[2].toLowerCase()==="m"?Fe(o):o:null}function os(t,s){const i=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,o=String(i||"").toLowerCase();if(o.includes("mat")||o.includes("morning")||o==="am")return"AM";if(o.includes("soir")||o.includes("evening")||o==="pm")return"PM";const p=`${t?.title??""} ${t?.description??""}`.toLowerCase();return p.includes("matin")||p.includes(" am ")||p.includes("(am)")?"AM":p.includes("soir")||p.includes(" pm ")||p.includes("(pm)")?"PM":s===0?"AM":"PM"}function as(t){const s=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!s)return null;const i=String(s),o=i.length>=10?i.slice(0,10):i;return/\d{4}-\d{2}-\d{2}/.test(o)?o:null}function ls(t){if(Array.isArray(t?.items)){let p=0;for(const x of t.items){const h=Number(x?.distance);if(!Number.isFinite(h)||h<=0)continue;const m=x?.raw_payload,N=Number(m?.exercise_repetitions),y=Number(m?.block_repetitions),w=Number.isFinite(N)&&N>0?N:1,_=Number.isFinite(y)&&y>0?y:1;p+=h*w*_}if(p>0)return Fe(p)}const s=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(s!=null&&Number.isFinite(Number(s))){const p=Number(s);return p>0&&p<=50?p:Fe(p)}const i=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(i!=null&&Number.isFinite(Number(i)))return Number(i);const o=is(`${t?.title??""} ${t?.description??""}`);return o??null}function cs(t){if(!Array.isArray(t)||t.length===0)return null;const s={crawl:"NL",dos:"DOS",brasse:"BR",pap:"PAP","4n":"QN"},i={NL:0,DOS:0,BR:0,PAP:0,QN:0};for(const p of t){const x=Number(p?.distance);if(!Number.isFinite(x)||x<=0)continue;const h=p?.raw_payload,m=Number(h?.exercise_repetitions),N=Number(h?.block_repetitions),y=Number.isFinite(m)&&m>0?m:1,w=Number.isFinite(N)&&N>0?N:1,_=x*y*w,J=h?.exercise_stroke??h?.stroke??"crawl",Z=s[String(J).toLowerCase()];Z?i[Z]+=_:i.NL+=_}return Object.values(i).some(p=>p>0)?i:null}function mt(t){const s=Number(t);if(!Number.isFinite(s))return"—";const i=Math.round(s*100)/100,o=String(i);return o.endsWith(".0")?o.slice(0,-2):o}function ds(){const t={};for(let s=0;s<7;s++)t[s]={AM:!0,PM:!0};return t}function Ve(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function us({sessions:t,assignments:s,userId:i,user:o}){const p=`swim-dashboard-v2:${i??o??"anon"}`,x=`${p}:presenceDefaults`,h=`${p}:attendanceOverrides`,m=`${p}:stableFields`,[N,y]=l.useState(()=>ds()),[w,_]=l.useState({}),[J,Z]=l.useState(90);l.useEffect(()=>{if(typeof window>"u")return;const r=Ve(window.localStorage.getItem(x));r&&y(r);const c=Ve(window.localStorage.getItem(h));c&&_(c);const u=Ve(window.localStorage.getItem(m));u?.duration&&Number.isFinite(u.duration)&&u.duration>=30&&u.duration<=240&&Z(u.duration)},[x,h,m]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(x,JSON.stringify(N))},[N,x]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(h,JSON.stringify(w))},[w,h]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(m,JSON.stringify({duration:J}))},[J,m]);const me=l.useMemo(()=>new Date,[]),[oe,ce]=l.useState(()=>dt(new Date)),[U,ne]=l.useState(()=>ct(new Date)),[ae,d]=l.useState(!1),[g,S]=l.useState(!1),[k,B]=l.useState(!1),[j,$]=l.useState(null),[P,K]=l.useState(!1),[A,I]=l.useState(null),[H,T]=l.useState(!1),[de,F]=l.useTransition(),Y=l.useMemo(()=>(Array.isArray(s)?s:[]).filter(c=>c?.session_type==="swim"),[s]),V=l.useMemo(()=>{const r=new Map;for(const c of Y){const u=as(c);u&&(r.has(u)||r.set(u,[]),r.get(u).push(c))}for(const[c,u]of r.entries())u.sort((f,v)=>Number(f?.id??0)-Number(v?.id??0)),r.set(c,u);return r},[Y]),R=l.useMemo(()=>{const r=Array.isArray(t)?t:[],c={};for(const u of r){const f=String(u?.date??"").slice(0,10),v=u?.slot==="Soir"?"PM":"AM";c[`${f}__${v}`]=u}return c},[t]),D=l.useRef(new Map);l.useEffect(()=>{D.current.clear()},[V]);const W=l.useCallback(r=>{const c=D.current;if(c.has(r))return c.get(r);const u=[{id:`${r}__AM`,iso:r,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${r}__PM`,iso:r,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],f=V.get(r)??[],v=new Set;return f.forEach((M,X)=>{const O=M,G=os(O,X);if(v.has(G))return;const he=G==="AM"?0:1,te=ls(O),we=Array.isArray(O?.details)?O.details.map(String):rs(M?.description);u[he]={id:`${r}__${G}`,iso:r,slotKey:G,title:String(M?.title??"Séance coach"),km:te,details:we,assignmentId:typeof M?.id=="number"?M.id:Number(M?.id)||void 0,isEmpty:!1},v.add(G)}),c.set(r,u),u},[V]),le=l.useCallback((r,c)=>{const u=He(c),f=!!N?.[u]?.[r.slotKey],v=w[r.id];return v==="present"?{status:"present",expected:!0,expectedByDefault:f}:v==="absent"?{status:"absent",expected:!0,expectedByDefault:f}:f?{status:"present",expected:!0,expectedByDefault:f}:{status:"not_expected",expected:!1,expectedByDefault:f}},[w,N]),xe=l.useMemo(()=>dt(oe),[oe]),re=l.useMemo(()=>{const r=He(xe),c=ut(xe,-r),u=[];for(let f=0;f<42;f++)u.push(ut(c,f));return u},[xe]),je=l.useMemo(()=>{const r={};for(const c of re){const u=ct(c),f=W(u);let v=0,M=0;const X=[];for(const O of f){const G=le(O,c);if(!G.expected){X.push({slotKey:O.slotKey,expected:!1,completed:!1,absent:!1});continue}v+=1;const he=!!R[O.id],te=G.status==="absent";he&&(M+=1),X.push({slotKey:O.slotKey,expected:!0,completed:he,absent:te})}r[u]={completed:M,total:v,slots:X}}return r},[re,W,le,R]),be=l.useMemo(()=>{const[r,c,u]=U.split("-").map(Number);return new Date(r,c-1,u)},[U]),pe=l.useMemo(()=>W(U),[W,U]),Q=je[U]||{completed:0,total:2,slots:[{slotKey:"AM",expected:!0,completed:!1,absent:!1},{slotKey:"PM",expected:!0,completed:!1,absent:!1}]},ue=l.useMemo(()=>{const r=Array.isArray(t)?t:[];let c=0;for(const u of r){const f=String(u?.date??"").slice(0,10),v=u?.slot==="Soir"?"PM":"AM",M=`${f}__${v}`;if(w[M]==="absent")continue;const X=He(new Date(f));(N?.[X]?.[v]||w[M]==="present")&&Number.isFinite(Number(u?.distance))&&(c+=Number(u.distance))}return mt(Fe(c))},[t,w,N]),ge=l.useMemo(()=>{const r=pe;let c=0;for(const u of r){const f=le(u,be);if(!f.expected||f.status==="absent")continue;const v=R[u.id];v&&Number.isFinite(Number(v?.distance))&&(c+=Number(v.distance))}return mt(Fe(c))},[pe,le,be,R]),fe=l.useMemo(()=>j&&R[j]||null,[j,R]),ee=l.useMemo(()=>{const r=fe||{},c=r?.stroke_distances,u=c?{NL:c.NL?String(c.NL):"",DOS:c.DOS?String(c.DOS):"",BR:c.BR?String(c.BR):"",PAP:c.PAP?String(c.PAP):"",QN:c.QN?String(c.QN):""}:Ue;return{difficulty:r?.effort??null,fatigue_end:r?.fatigue??r?.feeling??null,performance:r?.performance??r?.feeling??null,engagement:r?.engagement??r?.feeling??null,comment:String(r?.comments??""),distanceMeters:Number.isFinite(Number(r?.distance))?Number(r.distance):null,showStrokeDetail:!!(c&&Object.values(c).some(f=>f&&f>0)),strokes:u,exerciseLogs:[]}},[fe]),[ve,q]=l.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:Ue,exerciseLogs:[]}));return l.useEffect(()=>{const r=pe.find(c=>c.id===j);if(r){const c=r.km!=null?ns(r.km):5e3;let u=Ue;if(r.assignmentId){const v=(s??[]).find(M=>M.id===r.assignmentId);if(v?.items){const M=cs(v.items);M&&(u={NL:String(M.NL||""),DOS:String(M.DOS||""),BR:String(M.BR||""),PAP:String(M.PAP||""),QN:String(M.QN||"")})}}const f=Object.values(ee.strokes).some(v=>v&&Number(v)>0);q(v=>({...v,...ee,distanceMeters:ee.distanceMeters==null?c:ee.distanceMeters,strokes:f?ee.strokes:u,showStrokeDetail:f||Object.values(u).some(M=>M&&Number(M)>0)}));return}q(c=>({...c,...ee}))},[ee,j,pe,s]),l.useEffect(()=>{ae&&H&&Q.total>0&&Q.completed>=Q.total&&(d(!1),$(null),K(!1),T(!1))},[ae,H,Q.completed,Q.total]),{today:me,monthCursor:oe,selectedISO:U,drawerOpen:ae,settingsOpen:g,infoOpen:k,activeSessionId:j,detailsOpen:P,selectedDayIndex:A,isPending:de,presenceDefaults:N,attendanceOverrideBySessionId:w,stableDurationMin:J,draftState:ve,gridDates:re,completionByISO:je,selectedDate:be,sessionsForSelectedDay:pe,selectedDayStatus:Q,globalKm:ue,dayKm:ge,logsBySessionId:R,setMonthCursor:ce,setSelectedISO:ne,setDrawerOpen:d,setSettingsOpen:S,setInfoOpen:B,setActiveSessionId:$,setDetailsOpen:K,setSelectedDayIndex:I,setPresenceDefaults:y,setAttendanceOverrideBySessionId:_,setStableDurationMin:Z,setDraftState:q,setAutoCloseArmed:T,startTransition:F,getSessionStatus:le,getSessionsForISO:W}}function Ye(...t){return t.filter(Boolean).join(" ")}const xt={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function ms({strokes:t,showStrokeDetail:s,disabled:i=!1,onToggle:o,onChange:p}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:i,onClick:o,className:Ye("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",i?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(jt,{className:Ye("h-4 w-4 transition-transform",s&&"rotate-90")})]}),s&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(xt).map(x=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:xt[x]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:i,value:t[x],onChange:h=>p({...t,[x]:h.target.value}),placeholder:"0",className:Ye("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",i?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},x))})]})}function E(...t){return t.filter(Boolean).join(" ")}function xs(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function $e(t){const s=Number(t);if(!Number.isFinite(s))return"—";const i=Math.round(s*100)/100,o=String(i);return o.endsWith(".0")?o.slice(0,-2):o}function pt(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function ps(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}const We=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],fs=[{key:"AM",label:"Matin",Icon:es},{key:"PM",label:"Soir",Icon:Bt}];function Le({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function _e({onClick:t,label:s,children:i,tone:o="neutral",disabled:p}){const x={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:p,className:E("inline-flex items-center justify-center rounded-2xl border p-2 transition",x[o],p&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":s,title:s,children:[i,e.jsx("span",{className:"sr-only",children:s})]})}function bs(t,s){const i=Number(s);return!Number.isFinite(i)||i<1||i>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[i]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[i]}function gs({plannedMeters:t,valueMeters:s,onChange:i,disabled:o}){const m=Number.isFinite(Number(s))?Number(s):t,N=m-t;return e.jsxs("div",{className:E("mt-4 rounded-3xl border px-4 py-3",o?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:E("text-xs font-semibold",o?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),N!==0&&e.jsx("div",{className:E("text-xs font-semibold px-2 py-0.5 rounded-full",N>0?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"),children:N>0?`+${N}m`:`${N}m`})]}),e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:E("text-xs","text-muted-foreground"),children:["Planifié : ",t,"m (",$e(pt(t))," km)"]})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:o||m-100<0,onClick:()=>i(m-100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",o?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"-100m",children:e.jsx(vt,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-[140px] text-center",children:[e.jsxs("div",{className:E("text-2xl font-bold",o?"text-muted-foreground":"text-foreground"),children:[m,"m"]}),e.jsxs("div",{className:E("text-sm font-medium mt-0.5",o?"text-muted-foreground":"text-primary"),children:[$e(pt(m))," km"]})]}),e.jsx("button",{type:"button",disabled:o||m+100>3e4,onClick:()=>i(m+100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",o?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"+100m",children:e.jsx(Te,{className:"h-5 w-5"})})]})]})}function hs({open:t,selectedDate:s,sessionsForSelectedDay:i,selectedDayStatus:o,dayKm:p,activeSessionId:x,detailsOpen:h,draftState:m,saveState:N,isPending:y,logsBySessionId:w,onClose:_,onDayOffAll:J,onOpenSession:Z,onCloseSession:me,onToggleDetails:oe,onMarkAbsent:ce,onMarkPresent:U,onClearOverride:ne,onSaveFeedback:ae,onDraftStateChange:d,getSessionStatus:g}){const[,S]=Lt(),[k,B]=l.useState(!1),j=l.useMemo(()=>x&&i.find($=>$.id===x)||null,[x,i]);return e.jsx(Ae,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(ie.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:_}),e.jsx(ie.div,{className:E("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:zt,initial:"hidden",animate:"visible",exit:"exit",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden",children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-primary/15 bg-background px-4 sm:px-5 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground shrink-0",children:e.jsx(Xe,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-sm font-display font-bold uppercase italic tracking-tight text-primary",children:xs(s)})})]}),e.jsx(_e,{onClick:_,label:"Fermer",children:e.jsx(Ke,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-lg font-bold text-foreground",children:[p," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",o.total>0&&o.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",o.total>0&&o.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})}),e.jsx(_e,{onClick:J,label:"OFF (absent journée)",tone:"dark",disabled:y,children:e.jsx($t,{className:"h-5 w-5"})})]}),(()=>{const $=[],P=[];for(const A of i)g(A,s).status==="not_expected"?P.push(A):$.push(A);const K=A=>{const I=g(A,s),H=!!w[A.id],T=I.status==="absent",de=I.status==="not_expected",F=T||de,Y=I.expected&&!H&&!T,V=H?"bg-status-success-bg border-status-success/30":F?"bg-sky-50 border-sky-200":Y?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",R=fs.find(D=>D.key===A.slotKey)?.Icon||Qe;return e.jsx("button",{type:"button",onClick:()=>Z(A.id),className:E("w-full rounded-3xl border px-3 py-3 text-left transition",V,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:E("h-10 w-10 rounded-2xl border flex items-center justify-center",H?"border-status-success/30 bg-status-success-bg":F?"border-sky-200 bg-sky-100":Y?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(R,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:A.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[A.isEmpty?e.jsx(Le,{children:"Vide"}):e.jsxs(Le,{children:[$e(A.km)," km"]}),H&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),F&&!H&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),Y&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[de&&e.jsx(_e,{onClick:D=>{D.stopPropagation(),U(A.id)},label:"Je suis venu",disabled:y,children:e.jsx(at,{className:"h-5 w-5"})}),I.expected&&!H&&!T&&e.jsx(_e,{onClick:D=>{D.stopPropagation(),ce(A.id)},label:"Absent",tone:"sky",disabled:y,children:e.jsx(Ee,{className:"h-5 w-5"})})]})]})},A.id)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4 grid gap-2",children:$.map(K)}),P.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",onClick:()=>B(A=>!A),className:"flex w-full items-center gap-2 rounded-2xl px-3 py-2 text-xs font-semibold text-muted-foreground hover:bg-muted transition",children:[e.jsx(Ut,{className:E("h-4 w-4 transition-transform",k&&"rotate-180")}),"Autres séances (",P.length,")"]}),e.jsx(Ae,{children:k&&e.jsx(ie.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"mt-1 grid gap-2",children:P.map(K)})})})]})]})})(),e.jsx(Ae,{children:j&&e.jsx(ie.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:tt.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const $=g(j,s),P=$.status==="absent",K=$.status==="not_expected",A=!!w[j.id],I=$.expected&&!P,H=P?"Annuler":K?"Je suis venu":"Absent",T=P?()=>ne(j.id):K?()=>U(j.id):()=>ce(j.id),de=ps(j.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:j.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[j.isEmpty?e.jsx(Le,{children:"Vide"}):e.jsxs(Le,{children:[$e(j.km)," km"]}),A?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):P||K?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx(_e,{onClick:me,label:"Retour",children:e.jsx(Ke,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:T,className:E("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",K?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[K?e.jsx(at,{className:"h-4 w-4"}):e.jsx(Ee,{className:"h-4 w-4"}),H]}),e.jsxs("button",{type:"button",onClick:oe,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(Nt,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(Ae,{children:h&&e.jsxs(ie.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:tt.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:[j.details?.length?e.jsx("ul",{className:"list-disc pl-5 space-y-1 text-sm text-foreground",children:j.details.map((F,Y)=>e.jsx("li",{children:F},Y))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:j.assignmentId?"Séance coach — détails dans la fiche.":"Aucun détail pour ce créneau."}),e.jsx("div",{className:"mt-3",children:e.jsx("button",{type:"button",onClick:()=>S(j.assignmentId?`/swim-session?assignmentId=${j.assignmentId}`:"/swim-session"),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:j.assignmentId?"Ouvrir la fiche complète":"Saisir mes détails techniques"})})]})}),e.jsxs("div",{className:"px-4 pb-4",children:[!I&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:P?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(ie.div,{className:"space-y-4",variants:Jt,initial:"hidden",animate:"visible",children:[We.map(F=>{const Y=m[F.key];return e.jsxs(ie.div,{className:"space-y-2",variants:et,children:[e.jsx("div",{className:E("text-sm font-semibold",I?"text-foreground":"text-muted-foreground"),children:F.label}),e.jsx("div",{className:"flex items-center gap-2",children:[1,2,3,4,5].map(V=>{const R=Y===V;return e.jsx("button",{type:"button",disabled:!I,onClick:()=>d({...m,[F.key]:V}),className:E("h-11 w-11 rounded-2xl border text-sm font-semibold transition",I?R?bs(F.mode,V):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:V},V)})})]},F.key)}),e.jsxs(ie.div,{className:"space-y-2",variants:et,children:[e.jsx("div",{className:E("text-sm font-semibold",I?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:m.comment,onChange:F=>d({...m,comment:F.target.value}),disabled:!I,rows:3,placeholder:"Sensations, points techniques…",className:E("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",I?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsx(gs,{plannedMeters:de,valueMeters:m.distanceMeters,onChange:F=>d({...m,distanceMeters:F}),disabled:!I}),e.jsx(ms,{strokes:m.strokes,showStrokeDetail:m.showStrokeDetail,disabled:!I,onToggle:()=>d({...m,showStrokeDetail:!m.showStrokeDetail}),onChange:F=>d({...m,strokes:F})})]})]})})()},j.id)})]}),j&&(()=>{const $=g(j,s),P=$.expected&&$.status!=="absent";return e.jsxs(Qt,{saveState:N,position:"static",children:[e.jsx("button",{type:"button",onClick:ae,disabled:y||!P||!We.every(K=>Number.isInteger(m[K.key])),className:E("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",y||!P?"bg-muted text-muted-foreground cursor-not-allowed":We.every(K=>Number.isInteger(m[K.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["→"," km"]})]})})()]})})]})})}function ys(...t){return t.filter(Boolean).join(" ")}function Ns(t){try{return new Date(t).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return t}}function js({userId:t,expanded:s,onToggle:i}){const o=yt(),{data:p,isLoading:x}=Pe({queryKey:["swim-exercise-logs-history",t],queryFn:()=>se.getSwimExerciseLogsHistory(t,100),enabled:!!t&&s}),h=De({mutationFn:({logId:y,patch:w})=>se.updateSwimExerciseLog(y,w),onSuccess:()=>{o.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),m=De({mutationFn:y=>se.deleteSwimExerciseLog(y),onSuccess:()=>{o.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),N=Ce.useMemo(()=>{if(!p?.length)return[];const y=new Map;for(const w of p){const _=(w.created_at??"").slice(0,10);y.has(_)||y.set(_,[]),y.get(_).push(w)}return Array.from(y.entries()).map(([w,_])=>({date:w,entries:_}))},[p]);return e.jsxs("div",{className:"mt-6",children:[e.jsxs("button",{type:"button",onClick:i,className:"flex w-full items-center justify-between rounded-2xl border border-border px-3 py-2.5 text-sm font-semibold text-foreground hover:bg-muted transition",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Nt,{className:"h-4 w-4"}),"Historique notes techniques"]}),e.jsx(jt,{className:ys("h-4 w-4 transition-transform",s&&"rotate-90")})]}),s&&e.jsxs("div",{className:"mt-3 space-y-3",children:[x&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Chargement..."}),!x&&N.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucune note technique enregistree."}),N.map(({date:y,entries:w})=>e.jsxs("div",{className:"rounded-2xl border border-border overflow-hidden",children:[e.jsx("div",{className:"bg-muted/50 px-3 py-2 text-xs font-semibold text-muted-foreground",children:Ns(y)}),e.jsx("div",{className:"divide-y divide-border",children:w.map(_=>e.jsx(vs,{log:_,onSave:J=>h.mutate({logId:_.id,patch:J}),onDelete:()=>m.mutate(_.id),saving:h.isPending},_.id))})]},y))]})]})}function vs({log:t,onSave:s,onDelete:i,saving:o}){const[p,x]=l.useState(!1),[h,m]=l.useState({notes:t.notes??"",tempo:t.tempo,split_times:t.split_times,stroke_count:t.stroke_count}),[N,y]=l.useState([]),w=()=>{m({notes:t.notes??"",tempo:t.tempo,split_times:[...t.split_times],stroke_count:[...t.stroke_count]}),y(t.split_times.map(d=>ze(d.time_seconds))),x(!0)},_=()=>x(!1),J=()=>{s({notes:h.notes.trim()||null,tempo:h.tempo,split_times:h.split_times,stroke_count:h.stroke_count}),x(!1)},Z=()=>{m(d=>({...d,split_times:[...d.split_times,{rep:d.split_times.length+1,time_seconds:0}]})),y(d=>[...d,""])},me=(d,g)=>{y(S=>S.map((k,B)=>B===d?g:k))},oe=d=>{const g=Ht(N[d]),S=ze(g);y(k=>k.map((B,j)=>j===d?S:B)),m(k=>({...k,split_times:k.split_times.map((B,j)=>j===d?{...B,time_seconds:g}:B)}))},ce=d=>{m(g=>({...g,split_times:g.split_times.filter((S,k)=>k!==d).map((S,k)=>({...S,rep:k+1}))})),y(g=>g.filter((S,k)=>k!==d))},U=()=>{m(d=>({...d,stroke_count:[...d.stroke_count,{rep:d.stroke_count.length+1,count:0}]}))},ne=(d,g)=>{m(S=>({...S,stroke_count:S.stroke_count.map((k,B)=>B===d?{...k,count:g}:k)}))},ae=d=>{m(g=>({...g,stroke_count:g.stroke_count.filter((S,k)=>k!==d).map((S,k)=>({...S,rep:k+1}))}))};return p?e.jsxs("div",{className:"px-3 py-2.5 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:J,disabled:o,className:"p-1.5 rounded-lg text-primary hover:bg-primary/10 transition","aria-label":"Enregistrer",children:e.jsx(Ge,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:_,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Annuler",children:e.jsx(Ke,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:i,className:"p-1.5 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition","aria-label":"Supprimer",children:e.jsx(Je,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground min-w-[80px]",children:[e.jsx(st,{className:"h-3.5 w-3.5"}),"Tempo"]}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:h.tempo??"",onChange:d=>m(g=>({...g,tempo:d.target.value?Number(d.target.value):null})),placeholder:"coups/min",className:"w-24 rounded-xl border border-border bg-background px-2 py-1.5 text-sm text-center outline-none focus:ring-2 focus:ring-foreground/10"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(rt,{className:"h-3.5 w-3.5"}),"Temps"]}),e.jsxs("button",{type:"button",onClick:Z,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Te,{className:"h-3 w-3"}),"Rep"]})]}),h.split_times.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:h.split_times.map((d,g)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx("input",{type:"text",inputMode:"numeric",value:N[g]??"",onChange:S=>me(g,S.target.value),onBlur:()=>oe(g),placeholder:"ss:cc",className:"w-16 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>ce(g),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx(Je,{className:"h-3 w-3"})})]},g))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(nt,{className:"h-3.5 w-3.5"}),"Coups de bras"]}),e.jsxs("button",{type:"button",onClick:U,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Te,{className:"h-3 w-3"}),"Rep"]})]}),h.stroke_count.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:h.stroke_count.map((d,g)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:d.rep}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,value:d.count||"",onChange:S=>ne(g,Number(S.target.value)||0),placeholder:"nb",className:"w-14 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>ae(g),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx(Je,{className:"h-3 w-3"})})]},g))})]}),e.jsx("textarea",{value:h.notes,onChange:d=>m(g=>({...g,notes:d.target.value})),placeholder:"Notes libres...",rows:2,className:"w-full resize-none rounded-xl border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"})]}):e.jsxs("div",{className:"px-3 py-2.5 space-y-1.5 group",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsx("button",{type:"button",onClick:w,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Modifier",children:e.jsx(Vt,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground",children:[t.tempo!=null&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(st,{className:"h-3 w-3"}),t.tempo," c/min"]}),t.split_times.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(rt,{className:"h-3 w-3"}),t.split_times.map(d=>ze(d.time_seconds)||"—").join(" / ")]}),t.stroke_count.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(nt,{className:"h-3 w-3"}),t.stroke_count.map(d=>d.count).join(" / ")," cps"]})]}),t.notes&&e.jsx("div",{className:"text-xs text-foreground/70 italic",children:t.notes})]})}const ws=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],ks=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],Ss=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function ft(...t){return t.filter(Boolean).join(" ")}function bt(t){return String(t).padStart(2,"0")}function Ie(t){return`${t.getFullYear()}-${bt(t.getMonth()+1)}-${bt(t.getDate())}`}function Ms(t){return new Date(t.getFullYear(),t.getMonth(),1)}function _s(t){const s=String(t).split("__");return{iso:s[0],slotKey:s[1]||""}}function gt(t,s){return Number.isFinite(t)?Math.round(t/s)*s:0}function ht({open:t,title:s,onClose:i,children:o}){return e.jsx(Ae,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(ie.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:i}),e.jsx(ie.div,{className:"fixed inset-0 z-modal flex items-end sm:items-center justify-center p-3 pb-24 sm:p-4 sm:pb-4",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:e.jsxs("div",{className:"w-full max-w-md rounded-3xl border bg-background shadow-2xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[e.jsx("div",{className:"truncate text-base font-semibold text-foreground",children:s}),e.jsxs("button",{type:"button",onClick:i,className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Fermer",children:[e.jsx(Ke,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"Fermer"})]})]}),e.jsx("div",{className:"p-4",children:o})]})})]})})}function Xs(){const{user:t,userId:s}=It(),{toast:i}=Pt(),o=yt(),[p,x]=Ce.useState("idle"),[h,m]=Ce.useState(!1),[N,y]=Ce.useState(null);Ce.useEffect(()=>{qe.auth.getSession().then(({data:n})=>{y(n.session?.user?.id??null)})},[t]);const{data:w,isLoading:_,error:J,refetch:Z}=Pe({queryKey:["sessions",s??t],queryFn:()=>se.getSessions(t,s),enabled:!!t}),{data:me,isLoading:oe,error:ce,refetch:U}=Pe({queryKey:["assignments",t],queryFn:()=>se.getAssignments(t,s),enabled:!!t}),{data:ne=[]}=Pe({queryKey:["competitions"],queryFn:()=>se.getCompetitions()}),ae=_||oe,d=J||ce,g=()=>{Z(),U()},S=De({mutationFn:n=>se.deleteSession(n),onMutate:()=>{x("saving")},onSuccess:()=>{o.invalidateQueries({queryKey:["sessions"]}),o.invalidateQueries({queryKey:["hall-of-fame"]}),i({title:"Séance supprimée",description:"La saisie a été supprimée."}),x("saved"),setTimeout(()=>x("idle"),2e3)},onError:()=>{i({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),x("error"),setTimeout(()=>x("idle"),3e3)}}),k=De({mutationFn:async n=>{const{_exerciseLogs:a,...b}=n,C=await se.syncSession({...b,athlete_name:t,athlete_id:s??void 0});if(a&&a.length>0&&C.sessionId)try{const{data:L}=await qe.auth.getSession(),z=L.session?.user?.id;z&&await se.saveSwimExerciseLogs(C.sessionId,z,a)}catch(L){console.warn("[EAC] Failed to save exercise logs:",L)}return C},onMutate:()=>{x("saving")},onSuccess:()=>{o.invalidateQueries({queryKey:["sessions"]}),o.invalidateQueries({queryKey:["assignments"]}),o.invalidateQueries({queryKey:["hall-of-fame"]}),i({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),x("saved"),setTimeout(()=>x("idle"),2e3)},onError:()=>{i({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),x("error"),setTimeout(()=>x("idle"),3e3)}}),B=De({mutationFn:async n=>{const{_exerciseLogs:a,...b}=n,C=await se.updateSession(b);if(console.log("[EAC] updateMutation - exerciseLogs:",a),a&&b.id)try{const{data:L}=await qe.auth.getSession(),z=L.session?.user?.id;console.log("[EAC] updateMutation - authUid:",z,"sessionId:",b.id),z?(console.log("[EAC] updateMutation - calling saveSwimExerciseLogs with logs:",a),await se.saveSwimExerciseLogs(b.id,z,a),console.log("[EAC] updateMutation - saveSwimExerciseLogs completed successfully")):console.warn("[EAC] updateMutation - No authUid found, skipping exercise logs save")}catch(L){throw console.error("[EAC] Failed to save exercise logs:",L),L}else console.log("[EAC] updateMutation - skipping exercise logs (empty or no session ID)");return C},onMutate:()=>{x("saving")},onSuccess:()=>{o.invalidateQueries({queryKey:["sessions"]}),o.invalidateQueries({queryKey:["hall-of-fame"]}),i({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),x("saved"),setTimeout(()=>x("idle"),2e3)},onError:()=>{i({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),x("error"),setTimeout(()=>x("idle"),3e3)}}),j=us({sessions:w,assignments:me,userId:s,user:t}),{today:$,monthCursor:P,selectedISO:K,drawerOpen:A,settingsOpen:I,infoOpen:H,activeSessionId:T,detailsOpen:de,selectedDayIndex:F,isPending:Y,presenceDefaults:V,stableDurationMin:R,draftState:D,gridDates:W,completionByISO:le,selectedDate:xe,sessionsForSelectedDay:re,selectedDayStatus:je,globalKm:be,dayKm:pe,logsBySessionId:Q,setMonthCursor:ue,setSelectedISO:ge,setDrawerOpen:fe,setSettingsOpen:ee,setInfoOpen:ve,setActiveSessionId:q,setDetailsOpen:r,setSelectedDayIndex:c,setPresenceDefaults:u,setAttendanceOverrideBySessionId:f,setStableDurationMin:v,setDraftState:M,setAutoCloseArmed:X,startTransition:O,getSessionStatus:G}=j,he=l.useMemo(()=>{const n=new Set;for(const a of ne){if(!a.date)continue;const b=a.date.slice(0,10),C=a.end_date?a.end_date.slice(0,10):b;let L=b;for(;L<=C;){n.add(L);const z=new Date(L+"T00:00:00");z.setDate(z.getDate()+1);const Se=z.getFullYear(),Oe=String(z.getMonth()+1).padStart(2,"0"),ye=String(z.getDate()).padStart(2,"0");L=`${Se}-${Oe}-${ye}`}}return n},[ne]),te=l.useMemo(()=>{const n=Ie(new Date);return ne.filter(b=>b.date&&b.date.slice(0,10)>=n).sort((b,C)=>b.date.localeCompare(C.date))[0]??null},[ne]),we=l.useMemo(()=>{if(!te)return null;const n=new Date;n.setHours(0,0,0,0);const a=new Date(te.date.slice(0,10)+"T00:00:00");return Math.round((a.getTime()-n.getTime())/(1e3*60*60*24))},[te]),ke=l.useCallback(n=>{ge(n),fe(!0),q(null),r(!1);const a=le[n]||{completed:0,total:2};X(a.total>0&&a.completed<a.total)},[le,ge,fe,q,r,X]),Be=l.useCallback(()=>{fe(!1),q(null),r(!1),X(!1),c(null)},[fe,q,r,X,c]),wt=l.useCallback(()=>{ue(n=>new Date(n.getFullYear(),n.getMonth()-1,1))},[ue]),kt=l.useCallback(()=>{ue(n=>new Date(n.getFullYear(),n.getMonth()+1,1))},[ue]),St=l.useCallback(()=>{const n=new Date;ue(Ms(n)),ke(Ie(n))},[ke,ue]),Re=l.useCallback(n=>{q(n),r(!1)},[q,r]),Mt=l.useCallback(n=>{O(()=>{f(b=>({...b,[n]:"absent"}))});const a=Q[n];a?.id&&S.mutate(Number(a.id))},[S,Q,O,f]),_t=l.useCallback(n=>{O(()=>{f(a=>({...a,[n]:"present"}))})},[O,f]),Ct=l.useCallback(n=>{O(()=>{f(a=>{const b={...a};return delete b[n],b})})},[O,f]),At=l.useCallback(()=>{const n=re.map(a=>G(a,xe).expected?a.id:null).filter(Boolean);n.length!==0&&(O(()=>{f(a=>{const b={...a};for(const C of n)b[C]="absent";return b}),q(null),r(!1)}),n.forEach(a=>{const b=Q[a];b?.id&&S.mutate(Number(b.id))}))},[re,G,xe,O,Q,S,f,q,r]),Dt=l.useCallback(()=>{if(!T||!t||!Ss.every(Me=>Number.isInteger(D[Me.key])))return;const{iso:a,slotKey:b}=_s(T),C=b==="PM"?"Soir":"Matin",L=gt(Number(D.distanceMeters??0),100),z=gt(Number(R),15),Se={};for(const[Me,Et]of Object.entries(D.strokes)){const Ze=Number(Et);Ze>0&&(Se[Me]=Ze)}const Oe={date:a,slot:C,distance:L,duration:z,effort:Number(D.difficulty),feeling:Number(D.fatigue_end),performance:Number(D.performance),engagement:Number(D.engagement),comments:String(D.comment||"").slice(0,400),athlete_name:t,athlete_id:s??void 0,stroke_distances:Object.keys(Se).length>0?Se:null},ye=Q[T];console.log("[EAC] saveFeedback - draftState.exerciseLogs:",D.exerciseLogs),O(()=>{f(Me=>({...Me,[T]:"present"}))}),ye?.id?(console.log("[EAC] saveFeedback - updating existing session:",ye.id),B.mutate({...Oe,id:ye.id,created_at:ye.created_at??new Date().toISOString(),_exerciseLogs:D.exerciseLogs.length>0?D.exerciseLogs:[]})):(console.log("[EAC] saveFeedback - creating new session"),k.mutate({...Oe,_exerciseLogs:D.exerciseLogs.length>0?D.exerciseLogs:void 0})),q(null),r(!1)},[T,t,s,D,R,Q,O,B,k,f,q,r]),Ft=l.useCallback((n,a)=>{u(b=>({...b,[n]:{...b[n],[a]:!b[n][a]}}))},[u]);l.useEffect(()=>{if(!A)return;const n=a=>{if(a.key==="Escape"){a.preventDefault(),Be();return}(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),re.length>0&&!T&&Re(re[0].id))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[A,Be,re,T,Re]);const Ot=l.useCallback((n,a)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(n.key))return;if(n.preventDefault(),n.key==="Enter"||n.key===" "){const L=Ie(W[a]);ke(L);return}let C=a;n.key==="ArrowLeft"&&(C=Math.max(0,a-1)),n.key==="ArrowRight"&&(C=Math.min(W.length-1,a+1)),n.key==="ArrowUp"&&(C=Math.max(0,a-7)),n.key==="ArrowDown"&&(C=Math.min(W.length-1,a+7)),c(C),ge(Ie(W[C])),setTimeout(()=>{const L=document.querySelectorAll('[data-calendar-cell="true"]');L[C]&&L[C].focus()},0)},[W,ke,c,ge]);return ae?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"h-7 w-7 rounded-lg bg-primary/20 animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((n,a)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${a}`)),Array.from({length:35}).map((n,a)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${a}`))]})})]})})]}):d?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Yt,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:d.message}),e.jsx(Kt,{onClick:()=>g(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"px-4 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(Xe,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Suivi"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[be," km"]}),e.jsx("button",{type:"button",onClick:()=>ve(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Infos",children:e.jsx(it,{className:"h-5 w-5 text-primary"})}),e.jsx("button",{type:"button",onClick:()=>ee(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Paramètres",children:e.jsx(ot,{className:"h-5 w-5 text-primary"})})]})]})}),e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:[e.jsxs("div",{className:"hidden sm:flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(Xe,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Suivi"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[be," km"]}),e.jsx("button",{type:"button",onClick:()=>ve(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Infos",children:e.jsx(it,{className:"h-5 w-5 text-primary"})}),e.jsx("button",{type:"button",onClick:()=>ee(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Paramètres",children:e.jsx(ot,{className:"h-5 w-5 text-primary"})})]})]}),te&&we!=null&&e.jsx("div",{className:"mt-4 rounded-xl border border-amber-200 bg-amber-50 dark:border-amber-900/30 dark:bg-amber-950/20 p-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Tt,{className:"h-5 w-5 text-amber-500 shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs text-amber-600 dark:text-amber-400",children:"Prochaine compétition"}),e.jsx("div",{className:"font-semibold text-sm text-foreground truncate",children:te.name}),te.location&&e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:te.location})]}),e.jsx("div",{className:"shrink-0 rounded-lg bg-amber-100 dark:bg-amber-900/30 px-2.5 py-1",children:e.jsx("span",{className:"font-bold text-sm text-amber-600 dark:text-amber-400",children:we===0?"Aujourd'hui":`J-${we}`})})]})}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(Rt,{monthCursor:P,selectedDayStatus:je,onPrevMonth:wt,onNextMonth:kt,onJumpToday:St}),e.jsx(qt,{monthCursor:P,gridDates:W,completionByISO:le,competitionDates:he,selectedISO:K,selectedDayIndex:F,today:$,onDayClick:ke,onKeyDown:Ot})]}),N&&e.jsx(js,{userId:N,expanded:h,onToggle:()=>m(n=>!n)}),e.jsx(ht,{open:H,title:"Codes",onClose:()=>ve(!1),children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-orange-200 bg-orange-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Orange"}),e.jsx("span",{className:"text-foreground",children:"À compléter"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Vert"}),e.jsx("span",{className:"text-foreground",children:"Validé → km"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-sky-200 bg-sky-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Bleu"}),e.jsx("span",{className:"text-foreground",children:"Absent / Non prévu"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Les km comptent uniquement après validation."})]})}),e.jsx(ht,{open:I,title:"Présence",onClose:()=>ee(!1),children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Toggle hebdo (séances attendues)."}),e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_110px_110px] bg-muted border-b border-border px-3 py-2 text-xs font-semibold text-muted-foreground",children:[e.jsx("div",{children:"Jour"}),e.jsx("div",{className:"text-center",children:"Matin"}),e.jsx("div",{className:"text-center",children:"Soir"})]}),ws.map((n,a)=>e.jsxs("div",{className:ft("grid grid-cols-[1fr_110px_110px] items-center px-3 py-2",a!==6&&"border-b border-border"),children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:n}),ks.map(b=>{const C=!!V?.[a]?.[b.key];return e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{type:"button",onClick:()=>Ft(a,b.key),className:ft("w-24 rounded-2xl border px-3 py-2 text-sm font-semibold transition",C?"bg-foreground text-background border-foreground":"bg-card text-foreground border-border hover:bg-muted"),"aria-label":`${n} ${b.label}`,children:C?"On":"Off"})},b.key)})]},n))]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>v(n=>Math.max(30,n-15)),"aria-label":"Diminuer la durée",children:e.jsx(vt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[R," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>v(n=>Math.min(240,n+15)),"aria-label":"Augmenter la durée",children:e.jsx(Te,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-1 text-[11px] text-muted-foreground",children:"Durée envoyée au back-end (non affichée dans la maquette)."})]})]})}),e.jsx(hs,{open:A,selectedDate:xe,sessionsForSelectedDay:re,selectedDayStatus:je,dayKm:pe,activeSessionId:T,detailsOpen:de,draftState:D,saveState:p,isPending:Y,logsBySessionId:Q,onClose:Be,onDayOffAll:At,onOpenSession:Re,onCloseSession:()=>{q(null),r(!1)},onToggleDetails:()=>r(n=>!n),onMarkAbsent:Mt,onMarkPresent:_t,onClearOverride:Ct,onSaveFeedback:Dt,onDraftStateChange:M,getSessionStatus:G})]})]})}export{Xs as default};
