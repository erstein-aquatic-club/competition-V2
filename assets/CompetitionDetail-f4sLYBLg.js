import{r as g,u as T,d as C,j as e}from"./vendor-query-DyA9aSKS.js";import{b as Ce,d as F,P as E,L as _,I as xe,B as Se,a0 as w,X as he,$ as Te,a as _e,l as Re}from"./index-BidihRCR.js";import{a as v}from"./api-CxTuAiHg.js";import{T as De,a as Fe,b as A,c as M}from"./tabs-q1fYbBJy.js";import{B as Ee}from"./badge-CphaVh-b.js";import{s as qe,S as $e,e as D,F as Ae}from"./objectiveHelpers-DC7i01Ud.js";import{S as L,a as K,b as P,c as Q,d as I}from"./sheet-z9xa6ECs.js";import{S as Me,a as Le,b as Ke,c as Pe,d as Qe}from"./select-CREX0AwD.js";import{A as Y,a as U,b as X,c as G,d as W,e as Z,f as ee,g as te,h as fe}from"./alert-dialog-Dh9sNofP.js";import{T as Ie}from"./textarea-HFyoWTBU.js";import{T as V}from"./trophy-CLocbsaF.js";import{C as se}from"./clock-Ccp8p0FJ.js";import{C as Oe}from"./copy-BOZOc4rl.js";import{P as Be}from"./pencil-CIWVhoXg.js";import{T as re}from"./trash-2-tG4VpohL.js";import{C as He}from"./checkbox-gaHfPn_w.js";import{R as ne}from"./repeat-Dec0Dcsv.js";import{A as pe}from"./arrow-left-Bi-PVhLe.js";import{M as ze}from"./map-pin-BDsm7RPh.js";import{T as Je}from"./timer-DxqDv_Ts.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-lao-Njgm.js";import"./swim-CP3rtWsY.js";import"./index-aEhUVAuC.js";import"./index-CsdnJMpr.js";import"./index-DZINE_St.js";import"./index-DC_1MUyh.js";import"./index-DCX2sNhR.js";import"./chevron-down-C0YKHBpg.js";import"./chevron-up-B1X8uiTD.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["path",{d:"M13 5h8",key:"a7qcls"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}]],be=Ce("list-checks",Ve),Ye=["A","B","C","D"];function Ue(t,n){const c=[],i=new Date(t+"T00:00:00"),f=n?new Date(n+"T00:00:00"):i;for(;i<=f;){const u=i.getFullYear(),a=String(i.getMonth()+1).padStart(2,"0"),m=String(i.getDate()).padStart(2,"0");c.push(`${u}-${a}-${m}`),i.setDate(i.getDate()+1)}return c}function H(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}function Xe(t){const[n,c]=t.split(":");return`${n}h${c}`}function z(t){return t.race_type==="finale"?t.final_letter?`Finale ${t.final_letter}`:"Finale":null}function Ge({competitionId:t,competitionDate:n,competitionEndDate:c}){const{toast:i}=F(),[f,u]=g.useState(!1),[a,m]=g.useState(null),[b,y]=g.useState(null),[j,k]=g.useState(""),[s,l]=g.useState(n),[d,p]=g.useState(""),[x,N]=g.useState(""),[o,h]=g.useState("series"),[S,R]=g.useState(""),[O,q]=g.useState(""),ge=Ue(n,c),{data:ae=[],isLoading:ve}=T({queryKey:["competition-races",t],queryFn:()=>v.getCompetitionRaces(t)}),B=()=>w.invalidateQueries({queryKey:["competition-races",t]}),ie=C({mutationFn:r=>v.createCompetitionRace(r),onSuccess:()=>{B(),i({title:"Course ajoutée"}),ce()},onError:r=>i({title:"Erreur",description:r.message,variant:"destructive"})}),le=C({mutationFn:({id:r,input:$})=>v.updateCompetitionRace(r,$),onSuccess:()=>{B(),i({title:"Course modifiée"}),ce()},onError:r=>i({title:"Erreur",description:r.message,variant:"destructive"})}),oe=C({mutationFn:r=>v.deleteCompetitionRace(r),onSuccess:()=>{B(),i({title:"Course supprimée"}),y(null)},onError:r=>i({title:"Erreur",description:r.message,variant:"destructive"})});function je(){k(""),l(n),p(""),N(""),h("series"),R(""),q("")}function de(){m(null),je(),u(!0)}function ye(r){m(r),k(r.event_code),l(r.race_day),p(r.start_time??""),N(r.notes??""),h(r.race_type||"series"),R(r.final_letter??""),q(r.lane!=null?String(r.lane):""),u(!0)}function Ne(r){m(null),k(r.event_code),l(r.race_day),p(""),N(""),h("finale"),R("A"),q(""),u(!0)}function ce(){u(!1),m(null)}function ke(){if(!j)return;const r={competition_id:t,event_code:j,race_day:s,start_time:d||null,notes:x.trim()||null,race_type:o,final_letter:o==="finale"&&S?S:null,lane:O?parseInt(O,10):null};a?le.mutate({id:a.id,input:r}):ie.mutate(r)}const ue=ie.isPending||le.isPending;return ve?e.jsx("div",{className:"space-y-3",children:[1,2].map(r=>e.jsx("div",{className:"h-20 rounded-2xl bg-muted/40 animate-pulse"},r))}):e.jsxs(e.Fragment,{children:[ae.length===0?e.jsxs("button",{type:"button",onClick:de,className:"w-full rounded-3xl border-2 border-dashed border-amber-300/50 bg-amber-500/5 p-6 text-center transition hover:border-amber-400/70 hover:bg-amber-500/10",children:[e.jsx(V,{className:"mx-auto h-8 w-8 text-amber-500/60"}),e.jsx("p",{className:"mt-3 text-sm font-semibold text-foreground",children:"Ajoute tes courses"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Configure tes épreuves pour cette compétition"})]}):e.jsxs("div",{className:"space-y-2.5",children:[ae.map(r=>{const $=qe(r.event_code),we=$?$e[$]:"border-l-amber-500",me=z(r);return e.jsx("div",{className:`rounded-2xl border bg-card px-3 py-3 border-l-[3px] ${we}`,children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:D(r.event_code)}),me&&e.jsx("span",{className:"shrink-0 rounded-md bg-orange-500/10 px-1.5 py-0.5 text-[10px] font-semibold text-orange-600 dark:text-orange-400",children:me})]}),e.jsxs("div",{className:"mt-1 flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsx("span",{children:H(r.race_day)}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-3 w-3"}),r.start_time?Xe(r.start_time):"Heure à définir"]}),r.lane!=null&&e.jsxs("span",{children:["Ligne ",r.lane]})]}),r.notes&&e.jsx("p",{className:"mt-1.5 text-xs text-muted-foreground/80 line-clamp-1",children:r.notes})]}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[r.race_type!=="finale"&&e.jsx("button",{type:"button",onClick:()=>Ne(r),className:"h-8 w-8 flex items-center justify-center rounded-lg text-muted-foreground hover:text-orange-500 hover:bg-orange-500/10 transition","aria-label":"Dupliquer en finale",title:"Dupliquer en finale",children:e.jsx(Oe,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>ye(r),className:"h-8 w-8 flex items-center justify-center rounded-lg text-muted-foreground hover:text-foreground hover:bg-muted transition","aria-label":"Modifier",children:e.jsx(Be,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>y(r),className:"h-8 w-8 flex items-center justify-center rounded-lg text-muted-foreground hover:text-red-500 hover:bg-red-500/10 transition","aria-label":"Supprimer",children:e.jsx(re,{className:"h-3.5 w-3.5"})})]})]})},r.id)}),e.jsxs("button",{type:"button",onClick:de,className:"flex w-full items-center justify-center gap-2 rounded-2xl border border-dashed border-amber-300/50 bg-amber-500/5 px-3 py-3 text-xs font-medium text-amber-600 dark:text-amber-400 transition hover:border-amber-400/70 hover:bg-amber-500/10",children:[e.jsx(E,{className:"h-4 w-4"}),"Ajouter une course"]})]}),e.jsx(L,{open:f,onOpenChange:u,children:e.jsxs(K,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(P,{children:[e.jsx(Q,{children:a?"Modifier la course":"Ajouter une course"}),e.jsx(I,{children:a?"Modifie les détails de cette épreuve.":"Choisis ton épreuve et renseigne les détails."})]}),e.jsxs("div",{className:"mt-6 space-y-5",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Épreuve"}),e.jsxs(Me,{value:j,onValueChange:k,children:[e.jsx(Le,{className:"rounded-xl",children:e.jsx(Ke,{placeholder:"Choisis une épreuve"})}),e.jsx(Pe,{children:Ae.map(r=>e.jsx(Qe,{value:r,children:D(r)},r))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Type"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>h("series"),className:`flex-1 rounded-xl border px-3 py-2 text-sm font-medium transition ${o==="series"?"border-amber-500 bg-amber-500/10 text-amber-700 dark:text-amber-300":"border-border bg-card text-muted-foreground hover:bg-muted"}`,children:"Série"}),e.jsx("button",{type:"button",onClick:()=>h("finale"),className:`flex-1 rounded-xl border px-3 py-2 text-sm font-medium transition ${o==="finale"?"border-orange-500 bg-orange-500/10 text-orange-700 dark:text-orange-300":"border-border bg-card text-muted-foreground hover:bg-muted"}`,children:"Finale"})]})]}),o==="finale"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Lettre de finale"}),e.jsx("div",{className:"flex gap-2",children:Ye.map(r=>e.jsx("button",{type:"button",onClick:()=>R(r),className:`h-10 w-10 rounded-xl border text-sm font-semibold transition ${S===r?"border-orange-500 bg-orange-500/10 text-orange-700 dark:text-orange-300":"border-border bg-card text-muted-foreground hover:bg-muted"}`,children:r},r))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Jour"}),e.jsx("select",{value:s,onChange:r=>l(r.target.value),className:"flex h-10 w-full rounded-xl border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",children:ge.map(r=>e.jsx("option",{value:r,children:H(r)},r))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Heure de passage"}),e.jsx(xe,{type:"time",value:d,onChange:r=>p(r.target.value),className:"rounded-xl",placeholder:"Ex : 14:30"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Ligne"}),e.jsx(xe,{type:"number",min:1,max:10,value:O,onChange:r=>q(r.target.value),className:"rounded-xl",placeholder:"Ex : 4"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{className:"text-[11px] font-semibold uppercase tracking-wider text-muted-foreground",children:"Notes"}),e.jsx(Ie,{value:x,onChange:r=>N(r.target.value),className:"rounded-xl resize-none",rows:3,placeholder:"Remarques..."})]}),e.jsx(Se,{onClick:ke,disabled:!j||ue,className:"w-full rounded-xl bg-amber-500 hover:bg-amber-600 text-white",children:ue?"Enregistrement...":a?"Enregistrer":"Ajouter"})]})]})}),e.jsx(Y,{open:!!b,onOpenChange:r=>!r&&y(null),children:e.jsxs(U,{children:[e.jsxs(X,{children:[e.jsx(G,{children:"Supprimer cette course ?"}),e.jsx(W,{children:b&&e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:D(b.event_code)})," ",z(b)&&`(${z(b)}) `,"du ",H(b.race_day)," sera supprimée. Cette action est irréversible."]})})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Annuler"}),e.jsx(te,{onClick:()=>b&&oe.mutate(b.id),className:"bg-red-500 hover:bg-red-600 text-white",children:oe.isPending?"Suppression...":"Supprimer"})]})]})})]})}function We({competitionId:t}){const{toast:n}=F(),[c,i]=g.useState(!1),{data:f,isLoading:u}=T({queryKey:["competition-checklist",t],queryFn:()=>v.getCompetitionChecklist(t)}),{data:a=[],isLoading:m}=T({queryKey:["checklist-templates"],queryFn:()=>v.getChecklistTemplates()}),b=C({mutationFn:s=>v.applyChecklistTemplate(t,s),onSuccess:()=>{w.invalidateQueries({queryKey:["competition-checklist",t]}),n({title:"Checklist appliquee"})},onError:()=>n({title:"Erreur",description:"Impossible d'appliquer la checklist",variant:"destructive"})}),y=C({mutationFn:({checkId:s,checked:l})=>v.toggleChecklistCheck(s,l),onMutate:async({checkId:s,checked:l})=>{await w.cancelQueries({queryKey:["competition-checklist",t]});const d=w.getQueryData(["competition-checklist",t]);return d&&w.setQueryData(["competition-checklist",t],{...d,checks:d.checks.map(p=>p.id===s?{...p,checked:l,checked_at:l?new Date().toISOString():null}:p)}),{prev:d}},onError:(s,l,d)=>{d?.prev&&w.setQueryData(["competition-checklist",t],d.prev),n({title:"Erreur",variant:"destructive"})},onSettled:()=>w.invalidateQueries({queryKey:["competition-checklist",t]})}),j=C({mutationFn:s=>v.removeCompetitionChecklist(s),onSuccess:()=>{w.invalidateQueries({queryKey:["competition-checklist",t]}),n({title:"Checklist retirée"})},onError:()=>n({title:"Erreur",variant:"destructive"})}),k=C({mutationFn:s=>v.deleteChecklistTemplate(s),onSuccess:()=>{w.invalidateQueries({queryKey:["checklist-templates"]}),n({title:"Template supprime"})},onError:()=>n({title:"Erreur",variant:"destructive"})});if(u||m)return e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-5 w-5 animate-spin rounded-full border-2 border-violet-500 border-t-transparent"})});if(f){const l=a.find(h=>h.id===f.checklist.checklist_template_id)?.items??[],d=f.checks,p=d.length,x=d.filter(h=>h.checked).length,N=p>0?Math.round(x/p*100):0,o=new Map;for(const h of d)o.set(h.checklist_item_id,h);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"font-medium text-foreground",children:[x,"/",p]}),e.jsxs("span",{className:"text-muted-foreground",children:[N,"%"]})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted/30 overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full bg-violet-500 transition-all duration-300",style:{width:`${N}%`}})})]}),e.jsx("div",{className:"space-y-2",children:l.map(h=>{const S=o.get(h.id);return S?e.jsxs("label",{className:"flex items-center gap-3 rounded-2xl border bg-card px-3 py-2.5 cursor-pointer active:scale-[0.98] transition-transform",children:[e.jsx(He,{checked:S.checked,onCheckedChange:R=>y.mutate({checkId:S.id,checked:!!R}),className:"data-[state=checked]:bg-violet-500 data-[state=checked]:border-violet-500"}),e.jsx("span",{className:S.checked?"text-sm text-muted-foreground line-through":"text-sm text-foreground",children:h.label})]},S.id):null})}),e.jsx("button",{type:"button",onClick:()=>j.mutate(f.checklist.id),disabled:j.isPending,className:"w-full text-center text-xs text-muted-foreground hover:text-foreground transition py-1",children:"Changer de checklist"})]})}return e.jsxs("div",{className:"space-y-4",children:[a.length===0?e.jsxs("div",{className:"rounded-3xl border border-dashed border-border bg-card/60 p-6 text-center",children:[e.jsx(be,{className:"mx-auto h-8 w-8 text-muted-foreground/40"}),e.jsx("p",{className:"mt-3 text-sm font-medium",children:"Aucun template"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Cree ton premier template de checklist"})]}):e.jsx("div",{className:"space-y-2",children:a.map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border bg-card px-3 py-2.5",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.items?.length??0," items"]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>b.mutate(s.id),disabled:b.isPending,className:"rounded-xl bg-violet-500/10 px-3 py-1.5 text-xs font-medium text-violet-700 dark:text-violet-300 hover:bg-violet-500/20 transition",children:"Appliquer"}),e.jsx(et,{templateId:s.id,onConfirm:()=>k.mutate(s.id)})]})]},s.id))}),e.jsxs("button",{type:"button",onClick:()=>i(!0),className:"flex w-full items-center justify-center gap-2 rounded-2xl border border-dashed border-violet-500/30 bg-violet-500/5 px-3 py-3 text-xs font-medium text-violet-700 dark:text-violet-300 hover:bg-violet-500/10 transition",children:[e.jsx(E,{className:"h-3.5 w-3.5"}),"Creer un template"]}),e.jsx(Ze,{open:c,onOpenChange:i})]})}function Ze({open:t,onOpenChange:n}){const{toast:c}=F(),[i,f]=g.useState(""),[u,a]=g.useState([""]),m=C({mutationFn:({n:s,its:l})=>v.createChecklistTemplate(s,l),onSuccess:()=>{w.invalidateQueries({queryKey:["checklist-templates"]}),c({title:"Template cree"}),f(""),a([""]),n(!1)},onError:()=>c({title:"Erreur",variant:"destructive"})});function b(){a(s=>[...s,""])}function y(s){a(l=>l.filter((d,p)=>p!==s))}function j(s,l){a(d=>d.map((p,x)=>x===s?l:p))}function k(){const s=i.trim();if(!s)return;const l=u.map(d=>d.trim()).filter(Boolean).map((d,p)=>({label:d,sort_order:p}));m.mutate({n:s,its:l})}return e.jsx(L,{open:t,onOpenChange:n,children:e.jsxs(K,{side:"right",className:"flex flex-col overflow-y-auto",children:[e.jsxs(P,{children:[e.jsx(Q,{children:"Nouveau template"}),e.jsx(I,{children:"Cree une checklist réutilisable pour tes compétitions."})]}),e.jsxs("div",{className:"mt-4 flex-1 space-y-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Nom"}),e.jsx("input",{type:"text",value:i,onChange:s=>f(s.target.value),placeholder:"Ex : Sac de compet",className:"w-full rounded-xl border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-violet-500/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Items"}),e.jsx("div",{className:"space-y-2",children:u.map((s,l)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:s,onChange:d=>j(l,d.target.value),placeholder:`Item ${l+1}`,className:"flex-1 rounded-xl border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-violet-500/40"}),u.length>1&&e.jsx("button",{type:"button",onClick:()=>y(l),className:"h-8 w-8 rounded-lg flex items-center justify-center text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition",children:e.jsx(he,{className:"h-3.5 w-3.5"})})]},l))}),e.jsxs("button",{type:"button",onClick:b,className:"flex items-center gap-1.5 text-xs text-violet-600 dark:text-violet-400 hover:underline mt-1",children:[e.jsx(E,{className:"h-3 w-3"}),"Ajouter un item"]})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsx("button",{type:"button",onClick:k,disabled:!i.trim()||m.isPending,className:"w-full rounded-xl bg-violet-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-violet-600 disabled:opacity-50 transition",children:m.isPending?"Sauvegarde...":"Sauvegarder"})})]})})}function et({templateId:t,onConfirm:n}){return e.jsxs(Y,{children:[e.jsx(fe,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 w-8 rounded-lg flex items-center justify-center text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition",children:e.jsx(re,{className:"h-3.5 w-3.5"})})}),e.jsxs(U,{children:[e.jsxs(X,{children:[e.jsx(G,{children:"Supprimer le template ?"}),e.jsx(W,{children:"Cette action est irréversible. Le template et ses items seront définitivement supprimés."})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Annuler"}),e.jsx(te,{onClick:n,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})]})}function tt(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}function st(t){const[n,c]=t.split(":");return`${n}h${c}`}function rt(t){return t===0?"0min":`${t<0?"-":"+"}${Math.abs(t)}min`}function nt({competitionId:t}){const{toast:n}=F(),[c,i]=g.useState(null),[f,u]=g.useState(!1),{data:a=[],isLoading:m}=T({queryKey:["competition-races",t],queryFn:()=>v.getCompetitionRaces(t)}),{data:b=[],isLoading:y}=T({queryKey:["race-routines",t],queryFn:()=>v.getRaceRoutines(t)}),{data:j=[],isLoading:k}=T({queryKey:["routine-templates"],queryFn:()=>v.getRoutineTemplates()}),s=g.useMemo(()=>{const o=new Map;for(const h of b)o.set(h.race_id,h.routine_id);return o},[b]),l=g.useMemo(()=>{const o=new Map;for(const h of j)o.set(h.id,h);return o},[j]),d=()=>{w.invalidateQueries({queryKey:["race-routines",t]}),w.invalidateQueries({queryKey:["routine-templates"]})},p=C({mutationFn:({raceId:o,routineId:h})=>v.setRaceRoutine(o,h),onSuccess:()=>{d(),n({title:"Routine assignee"}),i(null)},onError:o=>n({title:"Erreur",description:o.message,variant:"destructive"})}),x=C({mutationFn:o=>v.removeRaceRoutine(o),onSuccess:()=>{d(),n({title:"Routine retiree"})},onError:o=>n({title:"Erreur",description:o.message,variant:"destructive"})}),N=C({mutationFn:o=>v.deleteRoutineTemplate(o),onSuccess:()=>{w.invalidateQueries({queryKey:["routine-templates"]}),w.invalidateQueries({queryKey:["race-routines",t]}),n({title:"Template supprime"})},onError:()=>n({title:"Erreur",variant:"destructive"})});return m||y||k?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"h-5 w-5 animate-spin rounded-full border-2 border-blue-500 border-t-transparent"})}):a.length===0?e.jsxs("div",{className:"rounded-3xl border border-dashed border-border bg-card/60 p-6 text-center",children:[e.jsx(ne,{className:"mx-auto h-8 w-8 text-muted-foreground/40"}),e.jsx("p",{className:"mt-3 text-sm font-medium",children:"Aucune course"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Ajoute d'abord des courses dans l'onglet Courses"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[a.map(o=>{const h=s.get(o.id),S=h?l.get(h):null;return e.jsx(at,{race:o,template:S??null,onAssign:()=>i(o.id),onChange:()=>i(o.id),onRemove:()=>x.mutate(o.id),removing:x.isPending},o.id)}),e.jsxs("button",{type:"button",onClick:()=>u(!0),className:"flex w-full items-center justify-center gap-2 rounded-2xl border border-dashed border-blue-500/30 bg-blue-500/5 px-3 py-3 text-xs font-medium text-blue-700 dark:text-blue-300 hover:bg-blue-500/10 transition",children:[e.jsx(E,{className:"h-3.5 w-3.5"}),"Creer un template de routine"]})]}),e.jsx(L,{open:!!c,onOpenChange:o=>!o&&i(null),children:e.jsxs(K,{side:"right",className:"flex flex-col overflow-y-auto",children:[e.jsxs(P,{children:[e.jsx(Q,{children:"Choisir une routine"}),e.jsx(I,{children:"Selectionne un template de routine pour cette course."})]}),e.jsx("div",{className:"mt-4 flex-1 space-y-2",children:j.length===0?e.jsxs("div",{className:"rounded-2xl border border-dashed border-border bg-muted/30 p-4 text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun template disponible"}),e.jsx("button",{type:"button",onClick:()=>{i(null),u(!0)},className:"mt-2 text-xs font-medium text-blue-600 dark:text-blue-400 hover:underline",children:"Creer un template"})]}):j.map(o=>e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border bg-card px-3 py-2.5",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:o.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[o.steps?.length??0," etape",(o.steps?.length??0)!==1?"s":""]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>{c&&p.mutate({raceId:c,routineId:o.id})},disabled:p.isPending,className:"rounded-xl bg-blue-500/10 px-3 py-1.5 text-xs font-medium text-blue-700 dark:text-blue-300 hover:bg-blue-500/20 transition",children:"Appliquer"}),e.jsx(lt,{onConfirm:()=>N.mutate(o.id)})]})]},o.id))})]})}),e.jsx(it,{open:f,onOpenChange:u})]})}function at({race:t,template:n,onAssign:c,onChange:i,onRemove:f,removing:u}){const a=n?.steps??[];return e.jsxs("div",{className:"rounded-2xl border bg-card overflow-hidden",children:[e.jsx("div",{className:"border-b border-border/60 px-3 py-2.5",children:e.jsx("div",{className:"flex items-center justify-between gap-2",children:e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:D(t.event_code)}),t.race_type==="finale"&&e.jsx("span",{className:"shrink-0 rounded-md bg-orange-500/10 px-1.5 py-0.5 text-[10px] font-semibold text-orange-600 dark:text-orange-400",children:t.final_letter?`Finale ${t.final_letter}`:"Finale"})]}),e.jsxs("div",{className:"mt-0.5 flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsx("span",{children:tt(t.race_day)}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-3 w-3"}),t.start_time?st(t.start_time):"Heure à définir"]})]})]})})}),e.jsx("div",{className:"px-3 py-2.5",children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(ne,{className:"h-3.5 w-3.5 text-blue-500 shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate",children:n.name})]}),e.jsxs("div",{className:"flex items-center gap-1.5 shrink-0",children:[e.jsx("button",{type:"button",onClick:i,className:"rounded-lg bg-blue-500/10 px-2 py-1 text-[11px] font-medium text-blue-700 dark:text-blue-300 hover:bg-blue-500/20 transition",children:"Changer"}),e.jsx("button",{type:"button",onClick:f,disabled:u,className:"rounded-lg bg-red-500/10 px-2 py-1 text-[11px] font-medium text-red-600 dark:text-red-400 hover:bg-red-500/20 transition",children:"Retirer"})]})]}),a.length>0&&e.jsx("div",{className:"mt-2.5 space-y-1.5",children:a.map(m=>e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("span",{className:"rounded-lg bg-blue-500/10 text-blue-600 dark:text-blue-400 px-2 py-0.5 text-[11px] font-mono shrink-0",children:rt(m.offset_minutes)}),e.jsx("span",{className:"text-xs text-foreground",children:m.label})]},m.id))})]}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Aucune routine"}),e.jsx("button",{type:"button",onClick:c,className:"rounded-xl bg-blue-500/10 px-3 py-1.5 text-xs font-medium text-blue-700 dark:text-blue-300 hover:bg-blue-500/20 transition",children:"Assigner"})]})})]})}function it({open:t,onOpenChange:n}){const{toast:c}=F(),[i,f]=g.useState(""),[u,a]=g.useState([{offset:"-60",label:""}]),m=C({mutationFn:({n:s,s:l})=>v.createRoutineTemplate(s,l),onSuccess:()=>{w.invalidateQueries({queryKey:["routine-templates"]}),c({title:"Template cree"}),f(""),a([{offset:"-60",label:""}]),n(!1)},onError:()=>c({title:"Erreur",variant:"destructive"})});function b(){a(s=>[...s,{offset:"-30",label:""}])}function y(s){a(l=>l.filter((d,p)=>p!==s))}function j(s,l,d){a(p=>p.map((x,N)=>N===s?{...x,[l]:d}:x))}function k(){const s=i.trim();if(!s)return;const l=u.filter(d=>d.label.trim()).map((d,p)=>({offset_minutes:parseInt(d.offset,10)||0,label:d.label.trim(),sort_order:p}));m.mutate({n:s,s:l})}return e.jsx(L,{open:t,onOpenChange:n,children:e.jsxs(K,{side:"right",className:"flex flex-col overflow-y-auto",children:[e.jsxs(P,{children:[e.jsx(Q,{children:"Nouvelle routine"}),e.jsx(I,{children:"Cree un template de routine pre-course reutilisable."})]}),e.jsxs("div",{className:"mt-4 flex-1 space-y-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Nom"}),e.jsx("input",{type:"text",value:i,onChange:s=>f(s.target.value),placeholder:"Ex : Routine sprint",className:"w-full rounded-xl border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/40"})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground",children:"Etapes"}),e.jsx("div",{className:"space-y-2",children:u.map((s,l)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative w-20 shrink-0",children:[e.jsx("input",{type:"number",value:s.offset,onChange:d=>j(l,"offset",d.target.value),className:"w-full rounded-xl border bg-background pl-3 pr-8 py-2 text-sm text-center font-mono outline-none focus:ring-2 focus:ring-blue-500/40 appearance-none [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",placeholder:"-60"}),e.jsx("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-muted-foreground pointer-events-none",children:"min"})]}),e.jsx("input",{type:"text",value:s.label,onChange:d=>j(l,"label",d.target.value),placeholder:"Ex : Echauffement sec",className:"flex-1 rounded-xl border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500/40"}),u.length>1&&e.jsx("button",{type:"button",onClick:()=>y(l),className:"h-8 w-8 rounded-lg flex items-center justify-center text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition shrink-0",children:e.jsx(he,{className:"h-3.5 w-3.5"})})]},l))}),e.jsxs("button",{type:"button",onClick:b,className:"flex items-center gap-1.5 text-xs text-blue-600 dark:text-blue-400 hover:underline mt-1",children:[e.jsx(E,{className:"h-3 w-3"}),"Ajouter une etape"]})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t",children:e.jsx("button",{type:"button",onClick:k,disabled:!i.trim()||m.isPending,className:"w-full rounded-xl bg-blue-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-blue-600 disabled:opacity-50 transition",children:m.isPending?"Sauvegarde...":"Sauvegarder"})})]})})}function lt({onConfirm:t}){return e.jsxs(Y,{children:[e.jsx(fe,{asChild:!0,children:e.jsx("button",{type:"button",className:"h-8 w-8 rounded-lg flex items-center justify-center text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition",children:e.jsx(re,{className:"h-3.5 w-3.5"})})}),e.jsxs(U,{children:[e.jsxs(X,{children:[e.jsx(G,{children:"Supprimer ce template ?"}),e.jsx(W,{children:"Cette action est irreversible. Le template et ses etapes seront definitivement supprimes."})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Annuler"}),e.jsx(te,{onClick:t,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})]})}function ot(t,n){const[c,i]=t.split(":").map(Number),f=c*60+i+n,u=Math.floor((f%1440+1440)%1440/60),a=(f%1440+1440)%1440%60;return`${String(u).padStart(2,"0")}:${String(a).padStart(2,"0")}`}function dt(t,n){const c=[],i=new Date(t+"T00:00:00"),f=n?new Date(n+"T00:00:00"):i,u=new Date(i);for(;u<=f;){const a=u.getFullYear(),m=String(u.getMonth()+1).padStart(2,"0"),b=String(u.getDate()).padStart(2,"0");c.push(`${a}-${m}-${b}`),u.setDate(u.getDate()+1)}return c}function ct(t){const n=new Date(t+"T00:00:00"),c=n.toLocaleDateString("fr-FR",{weekday:"short"});return`${c.charAt(0).toUpperCase()+c.slice(1)} ${n.getDate()}`}function ut({competitionId:t,competitionDate:n,competitionEndDate:c}){const i=g.useMemo(()=>dt(n,c),[n,c]),f=i.length>1,[u,a]=g.useState(i[0]),{data:m=[]}=T({queryKey:["competition-races",t],queryFn:()=>v.getCompetitionRaces(t)}),{data:b=[]}=T({queryKey:["race-routines",t],queryFn:()=>v.getRaceRoutines(t)}),{data:y=[]}=T({queryKey:["routine-templates"],queryFn:()=>v.getRoutineTemplates()}),{timed:j,untimed:k}=g.useMemo(()=>{const s=m.filter(x=>x.race_day===u),l=new Map;for(const x of b){const N=y.find(o=>o.id===x.routine_id);N&&l.set(x.race_id,N)}const d=[],p=[];for(const x of s){if(!x.start_time){p.push(x);continue}const N=x.race_type==="finale"?x.final_letter?` — Finale ${x.final_letter}`:" — Finale":"";d.push({time:x.start_time.slice(0,5),label:D(x.event_code)+N,type:"race",eventCode:x.event_code});const o=l.get(x.id);if(o?.steps)for(const h of o.steps)d.push({time:ot(x.start_time.slice(0,5),h.offset_minutes),label:h.label,type:"step"})}return d.sort((x,N)=>x.time.localeCompare(N.time)),{timed:d,untimed:p}},[m,b,y,u]);return m.length===0?e.jsxs("div",{className:"rounded-3xl border border-dashed border-border bg-card/60 p-6 text-center",children:[e.jsx(se,{className:"mx-auto h-8 w-8 text-muted-foreground/40"}),e.jsx("p",{className:"mt-3 text-sm font-medium text-muted-foreground",children:"Ajoute des courses et des routines pour voir ta timeline"})]}):e.jsxs("div",{className:"space-y-4",children:[f&&e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-1 scrollbar-none",children:i.map(s=>e.jsx("button",{type:"button",onClick:()=>a(s),className:`rounded-full border px-3 py-1.5 text-xs font-medium whitespace-nowrap transition ${s===u?"border-emerald-500 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300":"border-border bg-card text-muted-foreground hover:bg-muted"}`,children:ct(s)},s))}),j.length>0&&e.jsx("div",{className:"relative ml-[44px] border-l-2 border-border",children:j.map((s,l)=>e.jsxs("div",{className:"relative flex items-start pb-4 last:pb-0",children:[e.jsx("span",{className:"absolute -left-[52px] w-[44px] text-right text-xs font-mono tabular-nums text-muted-foreground leading-5",children:s.time}),e.jsx("div",{className:"absolute -left-[5px] top-1.5",children:s.type==="race"?e.jsx("div",{className:"h-2.5 w-2.5 rounded-full bg-amber-500"}):e.jsx("div",{className:"h-2 w-2 rounded-full bg-blue-400"})}),e.jsx("div",{className:"pl-4",children:e.jsx("span",{className:`text-sm leading-5 ${s.type==="race"?"font-semibold text-foreground":"text-muted-foreground"}`,children:s.label})})]},`${s.time}-${s.label}-${l}`))}),k.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Heure à définir"}),k.map(s=>e.jsxs("div",{className:"flex items-center gap-2.5 rounded-2xl border border-border/60 bg-muted/30 px-3 py-2.5",children:[e.jsx("div",{className:"h-2.5 w-2.5 rounded-full bg-amber-500/50 shrink-0"}),e.jsxs("span",{className:"text-sm font-medium",children:[D(s.event_code),s.race_type==="finale"&&(s.final_letter?` — Finale ${s.final_letter}`:" — Finale")]})]},s.id))]}),j.length===0&&k.length===0&&e.jsx("div",{className:"rounded-3xl border border-dashed border-border bg-card/60 p-6 text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucune course ce jour"})})]})}function J(t){return new Date(t+"T00:00:00").toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}function mt(t,n){if(!n||n===t)return J(t);const c=new Date(t+"T00:00:00"),i=new Date(n+"T00:00:00");return c.getMonth()===i.getMonth()&&c.getFullYear()===i.getFullYear()?`${c.getDate()} – ${i.toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}`:`${J(t)} – ${J(n)}`}function xt(t){const n=new Date;n.setHours(0,0,0,0);const c=new Date(t+"T00:00:00");return Math.round((c.getTime()-n.getTime())/(1e3*60*60*24))}function pt(t){return t<0?{label:"Terminée",variant:"outline"}:t===0?{label:"Aujourd'hui",variant:"default"}:{label:`J-${t}`,variant:"secondary"}}function Vt(){const[,t]=Te("/competition/:id"),[,n]=_e(),[c,i]=g.useState("courses"),f=t?.id??null,{data:u=[]}=T({queryKey:["competitions"],queryFn:()=>v.getCompetitions()}),a=g.useMemo(()=>u.find(y=>y.id===f)??null,[u,f]),m=a?xt(a.date):null,b=m!=null?pt(m):null;return a?e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("button",{type:"button",onClick:()=>window.history.back(),className:"mt-0.5 h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition shrink-0","aria-label":"Retour",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsxs("div",{className:"min-w-0 flex-1 space-y-1.5",children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("h1",{className:"text-lg font-bold",children:a.name}),b&&e.jsx(Ee,{variant:b.variant,className:"text-[10px] px-2 py-0.5 shrink-0",children:b.label})]}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Re,{className:"h-3 w-3"}),mt(a.date,a.end_date)]}),a.location&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ze,{className:"h-3 w-3"}),a.location]})]}),a.description&&e.jsx("p",{className:"text-xs text-muted-foreground/80 line-clamp-2",children:a.description})]})]}),e.jsxs(De,{value:c,onValueChange:y=>i(y),children:[e.jsxs(Fe,{className:"grid h-auto w-full grid-cols-4 gap-1.5 bg-transparent p-0",children:[e.jsxs(A,{value:"courses",className:"rounded-xl border bg-card px-2 py-2 text-[11px] data-[state=active]:border-amber-500 data-[state=active]:bg-amber-500/5 data-[state=active]:text-amber-700 dark:data-[state=active]:text-amber-300",children:[e.jsx(V,{className:"mr-1 h-3 w-3"}),"Courses"]}),e.jsxs(A,{value:"routines",className:"rounded-xl border bg-card px-2 py-2 text-[11px] data-[state=active]:border-blue-500 data-[state=active]:bg-blue-500/5 data-[state=active]:text-blue-700 dark:data-[state=active]:text-blue-300",children:[e.jsx(ne,{className:"mr-1 h-3 w-3"}),"Routines"]}),e.jsxs(A,{value:"timeline",className:"rounded-xl border bg-card px-2 py-2 text-[11px] data-[state=active]:border-emerald-500 data-[state=active]:bg-emerald-500/5 data-[state=active]:text-emerald-700 dark:data-[state=active]:text-emerald-300",children:[e.jsx(Je,{className:"mr-1 h-3 w-3"}),"Jour J"]}),e.jsxs(A,{value:"checklist",className:"rounded-xl border bg-card px-2 py-2 text-[11px] data-[state=active]:border-violet-500 data-[state=active]:bg-violet-500/5 data-[state=active]:text-violet-700 dark:data-[state=active]:text-violet-300",children:[e.jsx(be,{className:"mr-1 h-3 w-3"}),"Check"]})]}),e.jsx(M,{value:"courses",className:"mt-4",children:e.jsx(Ge,{competitionId:a.id,competitionDate:a.date,competitionEndDate:a.end_date})}),e.jsx(M,{value:"routines",className:"mt-4",children:e.jsx(nt,{competitionId:a.id})}),e.jsx(M,{value:"timeline",className:"mt-4",children:e.jsx(ut,{competitionId:a.id,competitionDate:a.date,competitionEndDate:a.end_date})}),e.jsx(M,{value:"checklist",className:"mt-4",children:e.jsx(We,{competitionId:a.id})})]})]}):e.jsxs("div",{className:"mx-auto max-w-3xl px-4 py-4",children:[e.jsx("button",{type:"button",onClick:()=>n("/"),className:"h-9 w-9 rounded-xl border border-border bg-card flex items-center justify-center hover:bg-muted transition","aria-label":"Retour",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsxs("div",{className:"mt-8 text-center",children:[e.jsx(V,{className:"mx-auto h-10 w-10 text-muted-foreground/40"}),e.jsx("p",{className:"mt-3 text-sm font-medium",children:"Compétition introuvable"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Elle a peut-être été supprimée."})]})]})}export{Vt as default};
