import{c as he,r as c,u as V,d as U,j as e}from"./vendor-query-DyA9aSKS.js";import{a as F}from"./api-B619rvMu.js";import{d as pe,B as S,E as Ae,L as w,I as ie}from"./index-Ck-9Twqe.js";import{C as Qe}from"./Coach-BKY-nw-4.js";import{B as me}from"./badge-1LDFnrdT.js";import{S as Be}from"./separator-CttPj5AR.js";import{S as ge,a as fe,b as ve,c as je,d as be}from"./sheet-Bf18LYwL.js";import{A as Ge,a as Ue,b as Ye,c as Je,d as Xe,e as Ze,f as et,g as tt}from"./alert-dialog-tE2MobGL.js";import{S as Y,a as J,b as X,c as Z,d as $,f as G}from"./select-B6KoV7Gi.js";import{R as st,a as De}from"./radio-group-CimjyyRa.js";import{C as ue}from"./chevron-left-CTqADEW7.js";import{P as ae}from"./plus-BsWlfMhe.js";import{C as $e}from"./chevron-right-B8fJ8Qp3.js";import{C as nt}from"./clock-DCIqoQrs.js";import{M as Oe}from"./map-pin-BNaqf2nQ.js";import{T as Le}from"./trash-2-DPid6RH5.js";import"./vendor-react-BzrpNAyj.js";import"./swim-Bs0hZpJk.js";import"./vendor-charts-BrQ8X25f.js";import"./vendor-supabase-DFPLkPj_.js";import"./vendor-motion-CMsaQ8FX.js";import"./toggle-group-CXFMdrkg.js";import"./index-BBrk4rUt.js";import"./index-DyT5Ctsr.js";import"./target-7_uefkB5.js";import"./index-BxfkzYWl.js";import"./index-D1s0-Pqv.js";import"./index-DCX2sNhR.js";import"./chevron-down-ib8LqTKe.js";import"./chevron-up-B8EJznx-.js";import"./circle-Elje6Af2.js";const ye=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"],rt=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],K=6,qe=22,Ie=qe-K,le=40,Ee=Ie*le,Me=Array.from({length:Ie+1},(n,a)=>K+a),re=40;function L(n){return n.slice(0,5)}function Fe(){return new Date().toISOString().slice(0,10)}function oe(n){const[a,i]=n.split(":").map(Number);return a*60+i}function xe(n){return(oe(n)-K*60)/60*le}function at(n,a){return xe(a)-xe(n)}function Te(n){const a=new Date(n),i=a.getDay(),b=i===0?-6:1-i;return a.setDate(a.getDate()+b),a.setHours(0,0,0,0),a}function it(n){const a=new Date(n);a.setHours(0,0,0,0),a.setDate(a.getDate()+3-(a.getDay()+6)%7);const i=new Date(a.getFullYear(),0,4);return 1+Math.round(((a.getTime()-i.getTime())/864e5-3+(i.getDay()+6)%7)/7)}function ee(n){return n.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}function te(n){const a=i=>String(i).padStart(2,"0");return`${n.getFullYear()}-${a(n.getMonth()+1)}-${a(n.getDate())}`}function He(n){const a=n.toLowerCase();return a.includes("piscine")||a.includes("bassin")||!a.includes("salle")&&!a.includes("muscu")&&!a.includes("ppg")&&!a.includes("gym")}const lt=({open:n,onOpenChange:a,slot:i,groups:b,coaches:_})=>{const{toast:x}=pe(),p=he(),o=!!i,[M,C]=c.useState("1"),[v,k]=c.useState(""),[f,D]=c.useState(""),[y,N]=c.useState(""),[d,h]=c.useState([]),[E,l]=c.useState(1),[R,T]=c.useState(!1);c.useEffect(()=>{if(n)if(i){C(String(i.day_of_week)),k(L(i.start_time)),D(L(i.end_time)),N(i.location);const s=i.assignments.map((m,O)=>({key:O,group_id:String(m.group_id),coach_id:String(m.coach_id),lane_count:m.lane_count!=null?String(m.lane_count):""}));h(s),l(s.length)}else C("1"),k(""),D(""),N(""),h([]),l(1)},[n,i]);const q=()=>{h(s=>[...s,{key:E,group_id:"",coach_id:"",lane_count:""}]),l(s=>s+1)},I=s=>{h(m=>m.filter(O=>O.key!==s))},j=(s,m,O)=>{h(B=>B.map(P=>P.key===s?{...P,[m]:O}:P))},z=()=>!v||!f?(x({title:"Horaires requis",description:"Veuillez saisir les heures de debut et fin.",variant:"destructive"}),null):y.trim()?{day_of_week:Number(M),start_time:v,end_time:f,location:y.trim(),assignments:d.filter(s=>s.group_id&&s.coach_id).map(s=>({group_id:Number(s.group_id),coach_id:Number(s.coach_id),lane_count:s.lane_count?Number(s.lane_count):null}))}:(x({title:"Lieu requis",description:"Veuillez saisir un lieu.",variant:"destructive"}),null),g=U({mutationFn:s=>F.createTrainingSlot(s),onSuccess:()=>{x({title:"Creneau cree"}),p.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:s=>{x({title:"Erreur",description:s.message,variant:"destructive"})}}),H=U({mutationFn:s=>F.updateTrainingSlot(i.id,s),onSuccess:()=>{x({title:"Creneau mis a jour"}),p.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:s=>{x({title:"Erreur",description:s.message,variant:"destructive"})}}),W=U({mutationFn:()=>F.deleteTrainingSlot(i.id),onSuccess:()=>{x({title:"Creneau supprime"}),p.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:s=>{x({title:"Erreur",description:s.message,variant:"destructive"})}}),Q=()=>{const s=z();s&&(o?H.mutate(s):g.mutate(s))},A=g.isPending||H.isPending||W.isPending;return e.jsxs(e.Fragment,{children:[e.jsx(ge,{open:n,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsx(je,{children:o?"Modifier le creneau":"Nouveau creneau"}),e.jsx(be,{children:o?"Modifiez les details de ce creneau.":"Definissez un nouveau creneau hebdomadaire."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Jour de la semaine *"}),e.jsxs(Y,{value:M,onValueChange:C,children:[e.jsx(J,{children:e.jsx(X,{})}),e.jsx(Z,{children:ye.map((s,m)=>e.jsx($,{value:String(m+1),children:s},m+1))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"slot-start",children:"Debut *"}),e.jsx("input",{id:"slot-start",type:"time",value:v,onChange:s=>k(s.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"slot-end",children:"Fin *"}),e.jsx("input",{id:"slot-end",type:"time",value:f,onChange:s=>D(s.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"slot-location",children:"Lieu *"}),e.jsx(ie,{id:"slot-location",placeholder:"Ex : Piscine Erstein",value:y,onChange:s=>N(s.target.value)})]}),e.jsx(Be,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(w,{children:"Groupes & Coachs"}),e.jsxs(S,{type:"button",variant:"outline",size:"sm",onClick:q,children:[e.jsx(ae,{className:"mr-1 h-3.5 w-3.5"}),"Ajouter"]})]}),d.length===0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center py-2",children:"Aucun groupe assigne."}),d.map(s=>e.jsx("div",{className:"rounded-lg border p-3 space-y-2",children:e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs(Y,{value:s.group_id,onValueChange:m=>j(s.key,"group_id",m),children:[e.jsx(J,{className:"h-8 text-xs",children:e.jsx(X,{placeholder:"Groupe..."})}),e.jsx(Z,{children:b.map(m=>e.jsx($,{value:String(m.id),children:m.name},m.id))})]}),e.jsxs(Y,{value:s.coach_id,onValueChange:m=>j(s.key,"coach_id",m),children:[e.jsx(J,{className:"h-8 text-xs",children:e.jsx(X,{placeholder:"Coach..."})}),e.jsx(Z,{children:_.map(m=>e.jsx($,{value:String(m.id),children:m.display_name},m.id))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{type:"number",min:0,placeholder:"Lignes d'eau",value:s.lane_count,onChange:m=>j(s.key,"lane_count",m.target.value),className:"h-8 text-xs flex-1"}),e.jsx(S,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive shrink-0",onClick:()=>I(s.key),children:e.jsx(Le,{className:"h-3.5 w-3.5"})})]})]})},s.key))]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsx(S,{className:"w-full",onClick:Q,disabled:A||!v||!f||!y.trim(),children:A?"Enregistrement...":o?"Enregistrer":"Creer"}),o&&e.jsx(S,{variant:"outline",className:"w-full text-destructive hover:text-destructive",onClick:()=>T(!0),disabled:A,children:"Supprimer ce creneau"})]})]})]})}),e.jsx(Ge,{open:R,onOpenChange:T,children:e.jsxs(Ue,{children:[e.jsxs(Ye,{children:[e.jsx(Je,{children:"Supprimer le creneau"}),e.jsx(Xe,{children:"Ce creneau sera desactive. Les exceptions associees resteront en base mais ne seront plus visibles."})]}),e.jsxs(Ze,{children:[e.jsx(et,{children:"Annuler"}),e.jsx(tt,{onClick:()=>{W.mutate(),T(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Supprimer"})]})]})})]})},ot=({open:n,onOpenChange:a,slot:i})=>{const{toast:b}=pe(),_=he(),[x,p]=c.useState(""),[o,M]=c.useState("cancelled"),[C,v]=c.useState(""),[k,f]=c.useState(""),[D,y]=c.useState(""),[N,d]=c.useState("");c.useEffect(()=>{n&&(p(""),M("cancelled"),v(i?L(i.start_time):""),f(i?L(i.end_time):""),y(i?.location??""),d(""))},[n,i]);const h=U({mutationFn:l=>F.createSlotOverride(l),onSuccess:()=>{b({title:"Exception enregistree"}),_.invalidateQueries({queryKey:["training-slot-overrides"]}),_.invalidateQueries({queryKey:["training-slots"]}),a(!1)},onError:l=>{b({title:"Erreur",description:l.message,variant:"destructive"})}}),E=()=>{if(!i)return;if(!x){b({title:"Date requise",description:"Veuillez saisir la date de l'exception.",variant:"destructive"});return}const l={slot_id:i.id,override_date:x,status:o,new_start_time:o==="modified"&&C||null,new_end_time:o==="modified"&&k||null,new_location:o==="modified"&&D.trim()?D.trim():null,reason:N.trim()||null};h.mutate(l)};return e.jsx(ge,{open:n,onOpenChange:a,children:e.jsxs(fe,{side:"right",className:"w-full sm:max-w-md overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsx(je,{children:"Exception"}),e.jsx(be,{children:"Annulez ou modifiez ce creneau pour une date precise."})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"override-date",children:"Date *"}),e.jsx("input",{id:"override-date",type:"date",value:x,onChange:l=>p(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{children:"Type"}),e.jsxs(st,{value:o,onValueChange:l=>M(l),className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(De,{value:"cancelled",id:"ovr-cancelled"}),e.jsx(w,{htmlFor:"ovr-cancelled",className:"font-normal",children:"Annule"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(De,{value:"modified",id:"ovr-modified"}),e.jsx(w,{htmlFor:"ovr-modified",className:"font-normal",children:"Modifie"})]})]})]}),o==="modified"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"ovr-start",children:"Nouvel horaire debut"}),e.jsx("input",{id:"ovr-start",type:"time",value:C,onChange:l=>v(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"ovr-end",children:"Nouvel horaire fin"}),e.jsx("input",{id:"ovr-end",type:"time",value:k,onChange:l=>f(l.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"ovr-location",children:"Nouveau lieu"}),e.jsx(ie,{id:"ovr-location",value:D,onChange:l=>y(l.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"ovr-reason",children:"Motif"}),e.jsx(ie,{id:"ovr-reason",placeholder:"Ex : Vacances scolaires",value:N,onChange:l=>d(l.target.value)})]}),e.jsx(S,{className:"w-full",onClick:E,disabled:h.isPending||!x,children:h.isPending?"Enregistrement...":"Enregistrer"})]})]})})},ct=({slot:n,hasOverrides:a,cancelled:i=!1,onSelect:b})=>{const _=xe(n.start_time),x=at(n.start_time,n.end_time),p=x<50,o=He(n.location),M=i?"bg-muted/50 border-muted-foreground/20 opacity-50 line-through":o?"bg-blue-500/15 border-blue-400/40 hover:bg-blue-500/25":"bg-amber-400/15 border-amber-400/40 hover:bg-amber-400/25",C=o?"text-blue-500":"text-amber-500";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border px-1.5 py-0.5 text-left overflow-hidden cursor-pointer transition-colors ${M}`,style:{top:_,height:x,minHeight:24},onClick:()=>b(n),title:`${L(n.start_time)}–${L(n.end_time)} · ${n.location}`,children:e.jsxs("div",{className:`flex flex-col gap-0.5 ${p?"flex-row items-center":""}`,children:[e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx(Oe,{className:`h-2.5 w-2.5 shrink-0 ${C}`}),e.jsx("span",{className:"text-[10px] font-medium text-foreground truncate",children:n.location}),a&&!i&&e.jsx(Ae,{className:"h-2.5 w-2.5 text-orange-500 shrink-0"})]}),!p&&n.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5",children:n.assignments.map(v=>e.jsx(me,{variant:"secondary",className:"text-[9px] px-1 py-0 leading-tight",children:v.group_name},v.id))}),!p&&x>=70&&n.assignments.length>0&&e.jsx("span",{className:"text-[9px] text-muted-foreground truncate",children:[...new Set(n.assignments.map(v=>v.coach_name))].join(", ")})]})})},dt=({slot:n,open:a,onOpenChange:i,overrides:b,onEdit:_,onOverride:x,onDeleteOverride:p})=>n?e.jsx(ge,{open:a,onOpenChange:i,children:e.jsxs(fe,{side:"bottom",className:"max-h-[60vh] overflow-y-auto rounded-t-2xl",children:[e.jsxs(ve,{className:"pb-2",children:[e.jsxs(je,{className:"text-left text-base",children:[ye[n.day_of_week-1]," · ",L(n.start_time),"–",L(n.end_time)]}),e.jsx(be,{className:"sr-only",children:"Details du creneau"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm text-muted-foreground",children:[e.jsx(Oe,{className:"h-3.5 w-3.5 shrink-0"}),n.location]}),n.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:n.assignments.map(o=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(me,{variant:"secondary",className:"text-xs px-2 py-0.5",children:o.group_name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[o.coach_name,o.lane_count!=null&&` · ${o.lane_count} ligne${o.lane_count>1?"s":""}`]})]},o.id))}),b.length>0&&e.jsxs("div",{className:"space-y-1.5 pt-1 border-t border-dashed",children:[e.jsx("span",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"Exceptions"}),b.map(o=>e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(Ae,{className:"h-3 w-3 text-orange-500 shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(o.override_date+"T00:00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}),e.jsx(me,{variant:o.status==="cancelled"?"destructive":"outline",className:"text-[10px] px-1 py-0",children:o.status==="cancelled"?"Annule":"Modifie"}),o.reason&&e.jsx("span",{className:"text-muted-foreground truncate flex-1",children:o.reason}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-6 w-6 ml-auto shrink-0 text-muted-foreground hover:text-destructive",onClick:()=>p(o.id),children:e.jsx(Le,{className:"h-3 w-3"})})]},o.id))]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(S,{variant:"outline",size:"sm",className:"flex-1",onClick:_,children:"Modifier"}),e.jsx(S,{variant:"outline",size:"sm",className:"flex-1",onClick:x,children:"Exception"})]})]})]})}):null,mt=({slotsByDay:n,weekDates:a,todayStr:i,overridesBySlot:b,cancelledSlotIds:_,onSelect:x,mobileTimeRange:p,onPrevWeek:o,onNextWeek:M,weekNumber:C})=>{const v=c.useRef(null),k=p.end-p.start,f=k*re,D=Array.from({length:k+1},(d,h)=>p.start+h);c.useEffect(()=>{v.current?.scrollIntoView({inline:"center",block:"nearest"})},[]);const y=d=>(oe(d)-p.start*60)/60*re,N=(d,h)=>y(h)-y(d);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsx("button",{type:"button",className:"flex items-center justify-center h-8 w-8 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:o,children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsxs("span",{className:"text-xs font-bold text-primary uppercase tracking-wider font-display",children:["S",C]}),e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:[ee(a[0])," – ",ee(a[6])]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-8 w-8 rounded-full text-muted-foreground hover:bg-muted active:scale-90 transition-all",onClick:M,children:e.jsx($e,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"overflow-x-auto overflow-y-auto no-scrollbar -mx-4 px-4",style:{maxHeight:"calc(100vh - 220px)"},children:e.jsxs("div",{className:"grid min-w-max",style:{gridTemplateColumns:"1.5rem repeat(7, 80px)"},children:[e.jsx("div",{})," ",a.map((d,h)=>{const E=te(d)===i;return e.jsxs("div",{ref:E?v:void 0,className:"text-center pb-1.5 sticky top-0 bg-background z-10",children:[e.jsx("span",{className:`text-[9px] font-semibold uppercase tracking-wider ${E?"text-primary":"text-muted-foreground"}`,children:rt[h]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] font-bold tabular-nums ${E?"text-primary":"text-foreground"}`,children:d.getDate()})]},h)}),e.jsx("div",{className:"relative sticky top-0",style:{height:f},children:D.map(d=>e.jsx("span",{className:"absolute right-0.5 text-[8px] text-muted-foreground/60 leading-none -translate-y-1/2 tabular-nums",style:{top:(d-p.start)*re},children:d},d))}),Array.from({length:7},(d,h)=>h+1).map(d=>{const h=n.get(d)??[],E=te(a[d-1])===i;return e.jsxs("div",{className:`relative border-l ${E?"border-primary/20 bg-primary/3":"border-border/30"}`,style:{height:f},children:[D.map(l=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/15",style:{top:(l-p.start)*re}},l)),h.map(l=>{const R=y(l.start_time),T=N(l.start_time,l.end_time),q=He(l.location),I=_.has(l.id),j=(b.get(l.id)??[]).length>0,z=T<40,g=I?"bg-muted/40 border-muted-foreground/15":q?"bg-blue-500/12 border-blue-400/30 active:bg-blue-500/25":"bg-amber-400/12 border-amber-400/30 active:bg-amber-400/25";return e.jsx("button",{type:"button",className:`absolute left-0.5 right-0.5 rounded-md border overflow-hidden text-left transition-colors ${g} ${I?"opacity-50":""}`,style:{top:R,height:Math.max(T,20),minHeight:20},onClick:()=>x(l),children:e.jsxs("div",{className:"px-1 py-0.5 h-full flex flex-col justify-center",children:[e.jsx("span",{className:`text-[8px] font-bold tabular-nums leading-none ${I?"line-through text-muted-foreground":q?"text-blue-700":"text-amber-700"}`,children:L(l.start_time)}),!z&&e.jsx("span",{className:"text-[7px] text-muted-foreground leading-tight mt-0.5 truncate",children:l.location.replace(/Piscine |Salle /i,"")}),!z&&T>=55&&l.assignments.length>0&&e.jsx("div",{className:"flex flex-wrap gap-0.5 mt-0.5",children:l.assignments.slice(0,2).map(H=>e.jsx("span",{className:`text-[6px] font-medium px-1 py-0 rounded leading-tight ${q?"bg-blue-500/10 text-blue-600":"bg-amber-400/10 text-amber-600"}`,children:H.group_name},H.id))}),j&&!I&&e.jsx("div",{className:"absolute top-0.5 right-0.5",children:e.jsx("span",{className:"block h-1.5 w-1.5 rounded-full bg-orange-500"})})]})},l.id)})]},d)})]})})]})},Vt=({onBack:n,groups:a})=>{const{toast:i}=pe(),b=he(),[_,x]=c.useState(!1),[p,o]=c.useState(null),[M,C]=c.useState(null),[v,k]=c.useState(!1),[f,D]=c.useState(null),[y,N]=c.useState(!1),[d,h]=c.useState(()=>Te(new Date)),E=c.useMemo(()=>it(d),[d]),l=c.useMemo(()=>{const t=new Date(d);return t.setDate(t.getDate()+6),t},[d]),R=c.useMemo(()=>Array.from({length:7},(t,r)=>{const u=new Date(d);return u.setDate(u.getDate()+r),u}),[d]),T=()=>h(t=>{const r=new Date(t);return r.setDate(r.getDate()-7),r}),q=()=>h(t=>{const r=new Date(t);return r.setDate(r.getDate()+7),r}),I=()=>h(Te(new Date)),[j,z]=c.useState("all"),{data:g=[],isLoading:H}=V({queryKey:["training-slots"],queryFn:()=>F.getTrainingSlots()}),{data:W=[]}=V({queryKey:["training-slot-overrides"],queryFn:()=>F.getSlotOverrides()}),{data:Q=[]}=V({queryKey:["users","coaches"],queryFn:()=>F.listUsers({role:"coach"})}),{data:A=[]}=V({queryKey:["athletes"],queryFn:()=>F.getAthletes()}),s=j.startsWith("swimmer:")?Number(j.split(":")[1]):null,{data:m}=V({queryKey:["swimmer-slots",s],queryFn:()=>F.getSwimmerSlots(s),enabled:s!=null}),{data:O}=V({queryKey:["swimmer-slots-exists",s],queryFn:()=>F.hasCustomSlots(s),enabled:s!=null}),B=c.useMemo(()=>m?m.map(t=>({id:t.id,day_of_week:t.day_of_week,start_time:t.start_time,end_time:t.end_time,location:t.location,is_active:t.is_active,created_by:t.created_by,created_at:t.created_at,assignments:[]})):[],[m]),P=c.useMemo(()=>{if(j==="all")return g;if(j.startsWith("group:")){const t=Number(j.split(":")[1]);return g.filter(r=>r.assignments.some(u=>u.group_id===t))}if(j.startsWith("coach:")){const t=Number(j.split(":")[1]);return g.filter(r=>r.assignments.some(u=>u.coach_id===t))}if(j.startsWith("swimmer:")){if(O&&B.length>0)return B;const t=A.find(r=>r.id===s);return t?.group_id?g.filter(r=>r.assignments.some(u=>u.group_id===t.group_id)):g}return g},[g,j,O,B,A,s]),Ne=c.useMemo(()=>{const t=new Map;for(let r=1;r<=7;r++)t.set(r,[]);for(const r of P)t.get(r.day_of_week).push(r);for(const r of t.values())r.sort((u,ne)=>u.start_time.localeCompare(ne.start_time));return t},[P]),we=te(d),Se=te(l),se=c.useMemo(()=>W.filter(t=>t.override_date>=we&&t.override_date<=Se),[W,we,Se]),ce=c.useMemo(()=>{const t=new Map;for(const r of se){const u=t.get(r.slot_id)??[];u.push(r),t.set(r.slot_id,u)}return t},[se]),_e=c.useMemo(()=>{const t=new Set;for(const r of se)r.status==="cancelled"&&t.add(r.slot_id);return t},[se]),Pe=U({mutationFn:t=>F.deleteSlotOverride(t),onSuccess:()=>{i({title:"Exception supprimee"}),b.invalidateQueries({queryKey:["training-slot-overrides"]})},onError:t=>{i({title:"Erreur",description:t.message,variant:"destructive"})}}),de=()=>{o(null),x(!0)},Ce=t=>{D(t),N(!0)},ze=()=>{f&&(N(!1),o(f),x(!0))},Re=()=>{f&&(N(!1),C(f),k(!0))},Ve=Q.map(t=>({id:t.id,display_name:t.display_name})),Ke=c.useMemo(()=>{let t=22,r=6;for(const u of P){const ne=Math.floor(oe(u.start_time)/60),ke=Math.ceil(oe(u.end_time)/60);ne<t&&(t=ne),ke>r&&(r=ke)}return t>=r?{start:K,end:qe}:{start:Math.max(0,t-1),end:Math.min(24,r+1)}},[P]),We=g.length===0?"Planning hebdomadaire des entrainements.":`${g.length} creneau${g.length>1?"x":""}`;return e.jsxs("div",{className:"space-y-4 pb-24",children:[e.jsx("div",{className:"sm:hidden",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8 -ml-2",onClick:n,children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-display font-semibold uppercase italic text-primary leading-tight",children:"Créneaux"}),g.length>0&&e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[g.length," créneau",g.length>1?"x":""," actif",g.length>1?"s":""]})]})]}),e.jsx("button",{type:"button",className:"flex items-center justify-center h-9 w-9 rounded-full bg-primary text-primary-foreground shadow-lg shadow-primary/20 active:scale-90 transition-all",onClick:de,children:e.jsx(ae,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(Qe,{title:"Creneaux",description:We,onBack:n,actions:e.jsxs(S,{variant:"outline",size:"sm",onClick:de,children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Nouveau"]})})}),!H&&g.length>0&&e.jsx("div",{className:"sm:hidden",children:e.jsxs(Y,{value:j,onValueChange:z,children:[e.jsx(J,{className:"w-full",children:e.jsx(X,{placeholder:"Filtrer..."})}),e.jsxs(Z,{children:[e.jsx($,{value:"all",children:"Tous les créneaux"}),e.jsx(G,{}),a.map(t=>e.jsx($,{value:`group:${t.id}`,children:t.name},t.id)),A.length>0&&e.jsx(G,{}),A.map(t=>e.jsx($,{value:`swimmer:${t.id}`,children:t.display_name},`swimmer:${t.id}`))]})]})}),e.jsxs("div",{className:"hidden sm:block space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:T,children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",className:"flex items-center gap-2 rounded-lg border bg-card px-3 py-1.5 text-sm font-semibold hover:bg-muted/50 transition-colors",onClick:I,title:"Revenir a cette semaine",children:[e.jsxs("span",{className:"text-primary",children:["S",E]}),e.jsxs("span",{className:"text-muted-foreground text-xs font-normal",children:[ee(d)," – ",ee(l)]})]}),e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:q,children:e.jsx($e,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-row items-center gap-3",children:e.jsxs(Y,{value:j,onValueChange:z,children:[e.jsx(J,{className:"w-56",children:e.jsx(X,{placeholder:"Filtrer..."})}),e.jsxs(Z,{children:[e.jsx($,{value:"all",children:"Tous les créneaux"}),e.jsx(G,{}),a.map(t=>e.jsx($,{value:`group:${t.id}`,children:t.name},t.id)),Q.length>0&&e.jsx(G,{}),Q.map(t=>e.jsx($,{value:`coach:${t.id}`,children:t.display_name},t.id)),A.length>0&&e.jsx(G,{}),A.map(t=>e.jsx($,{value:`swimmer:${t.id}`,children:t.display_name},`swimmer:${t.id}`))]})]})})]}),H?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"sm:hidden space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-28 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-8 w-8 rounded-full bg-muted animate-pulse motion-reduce:animate-none"})]}),e.jsxs("div",{className:"grid gap-0 -mx-4 px-4",style:{gridTemplateColumns:"1.5rem repeat(7, 1fr)"},children:[e.jsx("div",{}),Array.from({length:7},(t,r)=>e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("div",{className:"h-3 w-6 mx-auto rounded bg-muted animate-pulse motion-reduce:animate-none mb-0.5"}),e.jsx("div",{className:"h-3.5 w-4 mx-auto rounded bg-muted animate-pulse motion-reduce:animate-none"})]},r)),e.jsx("div",{}),Array.from({length:7},(t,r)=>e.jsxs("div",{className:"border-l border-border/30 h-64 relative",children:[e.jsx("div",{className:"absolute left-0.5 right-0.5 top-8 h-16 rounded-md bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"absolute left-0.5 right-0.5 top-32 h-12 rounded-md bg-muted animate-pulse motion-reduce:animate-none"})]},r))]})]}),e.jsx("div",{className:"hidden sm:grid grid-cols-7 gap-2",children:Array.from({length:7},(t,r)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-40 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},r))})]}):g.length===0?e.jsxs("div",{className:"text-center py-16 space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 rounded-2xl bg-muted/60 flex items-center justify-center",children:e.jsx(nt,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Aucun créneau défini"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Créez votre premier créneau d'entraînement."})]}),e.jsxs(S,{variant:"outline",size:"sm",onClick:de,children:[e.jsx(ae,{className:"mr-1.5 h-3.5 w-3.5"}),"Créer un créneau"]})]}):e.jsxs(e.Fragment,{children:[s!=null&&O===!1&&e.jsx("div",{className:"rounded-lg border border-blue-200 bg-blue-50 dark:border-blue-800 dark:bg-blue-950/30 px-3 py-2 text-sm text-blue-700 dark:text-blue-300",children:"Ce nageur hérite des créneaux du groupe. Personnalisez depuis sa fiche."}),e.jsx("div",{className:"sm:hidden",children:e.jsx(mt,{slotsByDay:Ne,weekDates:R,todayStr:Fe(),overridesBySlot:ce,cancelledSlotIds:_e,onSelect:Ce,mobileTimeRange:Ke,onPrevWeek:T,onNextWeek:q,weekNumber:E})}),e.jsx("div",{className:"hidden sm:block overflow-x-auto -mx-4 px-4",children:e.jsxs("div",{className:"grid",style:{minWidth:"760px",gridTemplateColumns:"2rem repeat(7, 1fr)"},children:[e.jsx("div",{})," ",R.map((t,r)=>{const u=te(t)===Fe();return e.jsxs("div",{className:"text-center pb-1.5",children:[e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:ye[r]}),e.jsx("br",{}),e.jsx("span",{className:`text-[10px] ${u?"text-primary font-bold":"text-muted-foreground/60"}`,children:ee(t)})]},r)}),e.jsx("div",{className:"relative",style:{height:Ee},children:Me.map(t=>e.jsxs("span",{className:"absolute right-1 text-[9px] text-muted-foreground/70 leading-none -translate-y-1/2",style:{top:(t-K)*le},children:[t,"h"]},t))}),Array.from({length:7},(t,r)=>r+1).map(t=>{const r=Ne.get(t)??[];return e.jsxs("div",{className:"relative border-l border-border/40",style:{height:Ee},children:[Me.map(u=>e.jsx("div",{className:"absolute left-0 right-0 border-t border-border/20",style:{top:(u-K)*le}},u)),r.map(u=>e.jsx(ct,{slot:u,hasOverrides:(ce.get(u.id)??[]).length>0,cancelled:_e.has(u.id),onSelect:Ce},u.id))]},t)})]})})]}),e.jsx(dt,{slot:f,open:y,onOpenChange:N,overrides:f?ce.get(f.id)??[]:[],onEdit:ze,onOverride:Re,onDeleteOverride:t=>Pe.mutate(t)}),e.jsx(lt,{open:_,onOpenChange:x,slot:p,groups:a,coaches:Ve}),e.jsx(ot,{open:v,onOpenChange:k,slot:M})]})};export{Vt as default};
