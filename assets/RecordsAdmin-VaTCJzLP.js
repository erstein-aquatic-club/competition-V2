import{r as d,j as e}from"./vendor-ui-CDk0TPZB.js";import{b as X,u as J,c as x}from"./vendor-query-aL7hzhW6.js";import{u as W,i as Y,g as o,m as Z,B as _,C as N,b as C,c as F,d as I,f as E,I as p}from"./index-Dyzg38p9.js";import{S as ee}from"./switch-5G5VJ7zq.js";import{B}from"./badge-CLFrVPhD.js";import{T as k,a as M,b,c as i,d as P,e as n}from"./table-DF3o8zNp.js";import{S as U,a as V,b as q,c as z,d as D}from"./select-SYrRdv5p.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-bGfQb4ap.js";import"./vendor-supabase-CgI36rMY.js";import"./check-CPIrYvFI.js";const H=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],se=a=>a==="user"?"Compte":"Ancien",re=a=>{if(!a)return"-";const t=new Date(a);return Number.isNaN(t.getTime())?a:t.toLocaleDateString("fr-FR")+" "+t.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},te=a=>{switch(a){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},ae=a=>{switch(a){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return a}};function je(){const a=W(s=>s.role),{toast:t}=Y(),K=X(),[c,m]=d.useState({display_name:"",iuf:"",sex:"",birthdate:""}),[h,A]=d.useState([]),[S,T]=d.useState(!1),[j,w]=d.useState(null),f=a==="coach"||a==="admin",{data:R=[],refetch:g}=J({queryKey:["import-logs"],queryFn:()=>o.getImportLogs({limit:20}),enabled:f}),u=d.useCallback(async()=>{if(f){T(!0),w(null);try{const s=await o.getClubRecordSwimmers();A(s)}catch(s){const r=Z(s,"Impossible de charger la liste.");w(r.message),A([])}finally{T(!1)}}},[f]);d.useEffect(()=>{u()},[u]);const $=x({mutationFn:()=>o.createClubRecordSwimmer({display_name:c.display_name.trim(),iuf:c.iuf.trim()||null,sex:c.sex?c.sex:null,birthdate:c.birthdate||null,is_active:!0}),onSuccess:()=>{t({title:"Nageur ajouté"}),m({display_name:"",iuf:"",sex:"",birthdate:""}),u()},onError:()=>{t({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),O=x({mutationFn:({id:s,payload:r})=>o.updateClubRecordSwimmer(s,r),onSuccess:()=>{u(),t({title:"Sauvegardé"})},onError:()=>{t({title:"Mise à jour impossible",variant:"destructive"})}}),Q=x({mutationFn:({userId:s,payload:r})=>o.updateClubRecordSwimmerForUser(s,r),onSuccess:()=>{u(),t({title:"Sauvegardé"})},onError:()=>{t({title:"Mise à jour impossible",variant:"destructive"})}}),v=(s,r)=>{if(s.source_type==="user"&&s.user_id){Q.mutate({userId:s.user_id,payload:r});return}s.id&&O.mutate({id:s.id,payload:r})},y=x({mutationFn:()=>o.importClubRecords(),onSuccess:s=>{t({title:"Import terminé",description:s?`Performances importées: ${s.imported??0}. Erreurs: ${s.errors??0}.`:""}),u(),g(),K.invalidateQueries({queryKey:["club-records"]})},onError:()=>{t({title:"Import impossible",variant:"destructive"}),g()}}),L=x({mutationFn:({iuf:s,name:r})=>o.importSingleSwimmer(s,r),onSuccess:(s,r)=>{t({title:`Import de ${r.name??r.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),g()},onError:(s,r)=>{t({title:`Erreur import ${r.name??r.iuf}`,variant:"destructive"}),g()}}),G=d.useMemo(()=>[...h].sort((s,r)=>s.source_type!==r.source_type?s.source_type.localeCompare(r.source_type):s.display_name.localeCompare(r.display_name)),[h]);return f?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"G\\u00e9rez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsx(_,{onClick:()=>y.mutate(),disabled:y.isPending,children:y.isPending?"Import en cours...":"Mettre à jour les records"})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsx(F,{children:"Ajouter un ancien nageur"}),e.jsx(I,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(E,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_1fr_auto]",children:[e.jsx(p,{placeholder:"Nom du nageur",value:c.display_name,onChange:s=>m(r=>({...r,display_name:s.target.value}))}),e.jsx(p,{placeholder:"IUF",value:c.iuf,onChange:s=>m(r=>({...r,iuf:s.target.value}))}),e.jsxs(U,{value:c.sex,onValueChange:s=>m(r=>({...r,sex:s})),children:[e.jsx(V,{children:e.jsx(q,{placeholder:"Sexe"})}),e.jsx(z,{children:H.map(s=>e.jsx(D,{value:s.value,children:s.label},s.value))})]}),e.jsx(p,{type:"date",value:c.birthdate,onChange:s=>m(r=>({...r,birthdate:s.target.value}))}),e.jsx(_,{onClick:()=>$.mutate(),disabled:!c.display_name.trim()||$.isPending,children:"Ajouter"})]})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsx(F,{children:"Liste des nageurs suivis"}),e.jsx(I,{children:"Mettre \\u00e0 jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(E,{children:[S&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s))}),j&&e.jsx("p",{className:"text-sm text-destructive",children:j}),!S&&!j&&h.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!S&&!j&&h.length>0&&e.jsxs(k,{children:[e.jsx(M,{children:e.jsxs(b,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Source"}),e.jsx(i,{children:"IUF"}),e.jsx(i,{children:"Sexe"}),e.jsx(i,{children:"Naissance"}),e.jsx(i,{children:"Actif"}),e.jsx(i,{children:"Actions"})]})}),e.jsx(P,{children:G.map(s=>{const r=s.id??`user-${s.user_id??"unknown"}`;return e.jsxs(b,{children:[e.jsx(n,{className:"font-medium",children:s.display_name}),e.jsx(n,{children:e.jsx(B,{variant:s.source_type==="manual"?"secondary":"outline",children:se(s.source_type)})}),e.jsx(n,{children:e.jsx(p,{defaultValue:s.iuf??"",onBlur:l=>v(s,{iuf:l.target.value.trim()||null})},`${r}-${s.iuf??""}`)}),e.jsx(n,{children:e.jsxs(U,{value:s.sex??"",onValueChange:l=>v(s,{sex:l||null}),children:[e.jsx(V,{children:e.jsx(q,{placeholder:"Sexe"})}),e.jsx(z,{children:H.map(l=>e.jsx(D,{value:l.value,children:l.label},l.value))})]})}),e.jsx(n,{children:e.jsx(p,{type:"date",defaultValue:s.birthdate??"",onBlur:l=>v(s,{birthdate:l.target.value||null})},`${r}-${s.birthdate??""}`)}),e.jsx(n,{children:e.jsx(ee,{checked:!!s.is_active,onCheckedChange:l=>v(s,{is_active:l})})}),e.jsx(n,{children:s.iuf?e.jsx(_,{size:"sm",variant:"outline",disabled:L.isPending,onClick:()=>L.mutate({iuf:s.iuf,name:s.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},r)})})]})]})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsx(F,{children:"Historique des imports"}),e.jsx(I,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(E,{children:R.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectu\\u00e9."}):e.jsxs(k,{children:[e.jsx(M,{children:e.jsxs(b,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Statut"}),e.jsx(i,{children:"Trouv\\u00e9es"}),e.jsx(i,{children:"Import\\u00e9es"}),e.jsx(i,{children:"Date"}),e.jsx(i,{children:"Erreur"})]})}),e.jsx(P,{children:R.map(s=>e.jsxs(b,{children:[e.jsx(n,{className:"font-medium",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(n,{children:e.jsx(B,{variant:te(s.status),children:ae(s.status)})}),e.jsx(n,{children:s.performances_found??"-"}),e.jsx(n,{children:s.performances_imported??"-"}),e.jsx(n,{className:"text-xs",children:re(s.started_at)}),e.jsx(n,{className:"max-w-[200px] truncate text-xs text-destructive",children:s.error_message??""})]},s.id))})]})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Acc\\u00e8s r\\u00e9serv\\u00e9 aux coachs."})]})}export{je as default};
