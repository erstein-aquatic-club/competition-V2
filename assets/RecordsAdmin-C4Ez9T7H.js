import{c as se,r as c,u as te,d as f,j as e}from"./vendor-query-BiSH4r2z.js";import{a as o}from"./api-VOHsjvaM.js";import{u as re,d as ae,B as v,E as ie,a as p,I as j,C as ne,i as ce,k as oe,l as le,G as de,g as ue}from"./index-DnFrrkfE.js";import{S as me}from"./switch-CIjCQHbS.js";import{B as Q}from"./badge-D5lLm5r8.js";import{S as U,a as O,b as G,c as H,d as J}from"./select-VM-aRjX4.js";import{I as pe}from"./InlineBanner-lTTeMvVh.js";import{s as xe}from"./swim-Dmpih-KT.js";import{E as he}from"./eye-CLz0lwhP.js";import{P as ge}from"./plus-BAFI2KlH.js";import{C as z}from"./chevron-down-PjaeG6qn.js";import{C as fe}from"./circle-alert-BU6XHYV1.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-DFPLkPj_.js";import"./index-BLrIslmR.js";import"./index-C_cnOACk.js";import"./index-CSspDTTX.js";import"./chevron-up-Czr9GazN.js";const X=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],ve=r=>r==="user"?"Compte":"Ancien",je=r=>{if(!r)return"-";const a=new Date(r);return Number.isNaN(a.getTime())?r:a.toLocaleDateString("fr-FR")+" "+a.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},be=r=>{if(!r)return"Jamais";const a=new Date(r);return Number.isNaN(a.getTime())?r:a.toLocaleDateString("fr-FR")},_e=(r,a=30)=>{if(!r)return!0;const u=new Date(r);return Number.isNaN(u.getTime())?!0:Date.now()-u.getTime()>a*24*60*60*1e3},ye=r=>{switch(r){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},Ne=r=>{switch(r){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return r}},K=({swimmer:r,onUpdate:a,onImport:u,importPending:l})=>{const x=_e(r.last_imported_at),d=r.is_active&&(!r.iuf||!r.sex||!r.birthdate),b=r.id??`user-${r.user_id??"unknown"}`;return e.jsxs("div",{className:p("rounded-xl border bg-card p-3 space-y-2",d&&"border-amber-300 bg-amber-50/30 dark:border-amber-700 dark:bg-amber-950/20",x&&!d&&r.is_active&&"border-amber-200/50",!r.is_active&&"opacity-60"),children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:r.display_name}),e.jsx(Q,{variant:r.source_type==="manual"?"secondary":"outline",className:"shrink-0 text-[10px] px-1.5 py-0",children:ve(r.source_type)})]}),e.jsx(me,{checked:!!r.is_active,onCheckedChange:i=>a({is_active:i})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{defaultValue:r.iuf??"",placeholder:"IUF",onBlur:i=>a({iuf:i.target.value.trim()||null}),className:p("h-8 text-xs flex-1 min-w-0",!r.iuf&&r.is_active&&"ring-2 ring-destructive/50")},`${b}-${r.iuf??""}`),e.jsxs(U,{value:r.sex??"",onValueChange:i=>a({sex:i||null}),children:[e.jsx(O,{className:p("h-8 w-24 text-xs shrink-0",!r.sex&&r.is_active&&"ring-2 ring-destructive/50"),children:e.jsx(G,{placeholder:"Sexe"})}),e.jsx(H,{children:X.map(i=>e.jsx(J,{value:i.value,children:i.label},i.value))})]}),e.jsx(j,{type:"number",placeholder:"Année",defaultValue:r.birthdate?new Date(r.birthdate).getFullYear():"",onBlur:i=>{const h=i.target.value.trim();h&&/^\d{4}$/.test(h)?a({birthdate:`${h}-01-01`}):h||a({birthdate:null})},className:p("h-8 w-[4.5rem] text-xs shrink-0",!r.birthdate&&r.is_active&&"ring-2 ring-amber-400/50")},`${b}-birth-${r.birthdate??""}`)]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:p("text-[11px]",x&&r.is_active?"text-amber-600 dark:text-amber-400":"text-muted-foreground"),children:["Maj : ",be(r.last_imported_at)]}),r.is_active&&r.iuf?e.jsx(v,{size:"sm",variant:"outline",className:"h-7 text-xs",disabled:l,onClick:u,children:"Importer"}):r.is_active&&!r.iuf?e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"IUF requis"}):null]})]})};function ze(){const r=re(s=>s.role),{toast:a}=ae(),u=se(),[l,x]=c.useState({display_name:"",iuf:"",sex:""}),[d,b]=c.useState([]),[i,h]=c.useState(!1),[_,P]=c.useState(null),[D,Y]=c.useState(!1),[w,W]=c.useState(!1),[E,M]=c.useState(!1),[m,N]=c.useState(null),S=r==="coach"||r==="admin",I=r==="admin",{data:T=[],refetch:C}=te({queryKey:["import-logs"],queryFn:()=>o.getImportLogs({limit:20}),enabled:S}),g=c.useCallback(async()=>{if(S){h(!0),P(null);try{await o.syncClubRecordSwimmersFromUsers();const s=await o.getClubRecordSwimmers();b(s)}catch(s){const t=xe(s,"Impossible de charger la liste.");P(t.message),b([])}finally{h(!1)}}},[S]);c.useEffect(()=>{g()},[g]),c.useEffect(()=>{I&&o.getAppSettings("import_rate_limits").then(s=>{s&&N(s)})},[I]);const q=f({mutationFn:()=>o.createClubRecordSwimmer({display_name:l.display_name.trim(),iuf:l.iuf.trim()||null,sex:l.sex?l.sex:null,is_active:!0}),onSuccess:()=>{a({title:"Nageur ajouté"}),x({display_name:"",iuf:"",sex:""}),M(!1),g()},onError:s=>{a({title:s?.message||"Impossible d'ajouter le nageur",variant:"destructive"})}}),Z=f({mutationFn:({id:s,payload:t})=>o.updateClubRecordSwimmer(s,t),onSuccess:()=>{g(),a({title:"Sauvegardé"})},onError:s=>{a({title:s?.message||"Mise à jour impossible",variant:"destructive"})}}),ee=f({mutationFn:({userId:s,payload:t})=>o.updateClubRecordSwimmerForUser(s,t),onSuccess:()=>{g(),a({title:"Sauvegardé"})},onError:()=>{a({title:"Mise à jour impossible",variant:"destructive"})}}),B=(s,t)=>{if(s.source_type==="user"&&s.user_id){ee.mutate({userId:s.user_id,payload:t});return}s.id&&Z.mutate({id:s.id,payload:t})},F=f({mutationFn:()=>o.importClubRecords(),onSuccess:s=>{const t=s?.summary??s,n=s?.recalc_stats;let L=t?`Performances importées: ${t.imported??0}. Erreurs: ${t.errors??0}.`:"";n&&(L+=` Records: ${n.club_records_upserted} (${n.processed} perfs traitées).`,n.skipped_no_age&&(L+=` Ignorées (pas d'âge): ${n.skipped_no_age}.`)),a({title:"Import terminé",description:L}),g(),C(),u.invalidateQueries({queryKey:["club-records"]})},onError:s=>{const t=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:"Import impossible";a({title:t,variant:"destructive"}),C()}}),R=f({mutationFn:({iuf:s,name:t})=>o.importSingleSwimmer(s,t),onSuccess:(s,t)=>{a({title:`Import de ${t.name??t.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),C(),o.recalculateClubRecords().then(()=>{u.invalidateQueries({queryKey:["club-records"]})}),g()},onError:(s,t)=>{const n=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:`Erreur import ${t.name??t.iuf}`;a({title:n,variant:"destructive"}),C()}}),V=f({mutationFn:s=>o.updateAppSettings("import_rate_limits",s),onSuccess:()=>{a({title:"Limites sauvegardées"})},onError:()=>{a({title:"Erreur de sauvegarde",variant:"destructive"})}}),{activeSwimmers:k,inactiveSwimmers:y}=c.useMemo(()=>{const s=[...d].sort((t,n)=>t.source_type!==n.source_type?t.source_type.localeCompare(n.source_type):t.display_name.localeCompare(n.display_name));return{activeSwimmers:s.filter(t=>t.is_active),inactiveSwimmers:s.filter(t=>!t.is_active)}},[d]),$=c.useMemo(()=>d.filter(s=>s.is_active&&(!s.iuf||!s.sex||!s.birthdate)).length,[d]),A=f({mutationFn:()=>o.recalculateClubRecords(),onSuccess:s=>{const t=s?.recalc_stats,n=t?`${t.swimmers_with_sex} nageur(s), ${t.total_performances} perfs, ${t.processed} traitées, ${t.club_records_upserted} records.${t.skipped_no_swimmer?` Ignorées (pas de nageur): ${t.skipped_no_swimmer}.`:""}${t.skipped_no_event_code?` Ignorées (épreuve inconnue): ${t.skipped_no_event_code}.`:""}${t.skipped_no_age?` Ignorées (pas d'âge): ${t.skipped_no_age}.`:""}${t.unmapped_event_codes?.length?` Épreuves inconnues: ${t.unmapped_event_codes.join(", ")}`:""}`:"";a({title:"Records recalculés",description:n}),u.invalidateQueries({queryKey:["club-records"]})},onError:()=>{a({title:"Erreur de recalcul",variant:"destructive"})}});return S?e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-display font-bold uppercase italic text-primary",children:"Records club"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Import des performances FFN et gestion des nageurs."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(v,{onClick:()=>F.mutate(),disabled:F.isPending,children:F.isPending?"Import en cours…":"Mettre à jour"}),e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>A.mutate(),disabled:A.isPending,children:[e.jsx(ie,{className:p("h-4 w-4 mr-1",A.isPending&&"animate-spin")}),"Recalculer"]}),e.jsxs(v,{variant:"ghost",size:"sm",onClick:()=>{window.location.hash="#/records-club"},children:[e.jsx(he,{className:"h-4 w-4 mr-1"}),"Voir les records"]})]})]}),e.jsxs("div",{children:[e.jsxs("button",{type:"button",onClick:()=>M(!E),className:"flex items-center gap-2 text-sm font-semibold text-muted-foreground py-1 active:opacity-70",children:[e.jsx(ge,{className:"h-4 w-4"}),"Ajouter un ancien nageur",e.jsx(z,{className:p("h-3 w-3 transition-transform",E&&"rotate-180")})]}),E&&e.jsxs("div",{className:"mt-2 grid gap-2 sm:grid-cols-[2fr_1fr_1fr_auto] rounded-xl border bg-card p-3",children:[e.jsx(j,{placeholder:"Nom du nageur",value:l.display_name,onChange:s=>x(t=>({...t,display_name:s.target.value}))}),e.jsx(j,{placeholder:"IUF",value:l.iuf,onChange:s=>x(t=>({...t,iuf:s.target.value}))}),e.jsxs(U,{value:l.sex,onValueChange:s=>x(t=>({...t,sex:s})),children:[e.jsx(O,{children:e.jsx(G,{placeholder:"Sexe"})}),e.jsx(H,{children:X.map(s=>e.jsx(J,{value:s.value,children:s.label},s.value))})]}),e.jsx(v,{onClick:()=>q.mutate(),disabled:!l.display_name.trim()||q.isPending,children:"Ajouter"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Nageurs suivis"}),!i&&d.length>0&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:[k.length," actif",k.length!==1?"s":""]})]}),e.jsx(pe,{variant:"amber",icon:e.jsx(fe,{}),label:`${$} nageur${$>1?"s":""} incomplet${$>1?"s":""}`,sublabel:"IUF, sexe et année de naissance requis pour les records",visible:!i&&$>0,animate:!1}),i&&e.jsx("div",{className:"space-y-2",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"rounded-xl border p-3 animate-pulse motion-reduce:animate-none",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted"}),e.jsx("div",{className:"ml-auto h-6 w-10 rounded bg-muted"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("div",{className:"h-8 flex-1 rounded bg-muted"}),e.jsx("div",{className:"h-8 w-24 rounded bg-muted"}),e.jsx("div",{className:"h-8 w-[4.5rem] rounded bg-muted"})]})]},s))}),_&&e.jsx("p",{className:"text-sm text-destructive",children:_}),!i&&!_&&d.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Aucun nageur disponible."}),!i&&!_&&k.length>0&&e.jsx("div",{className:"space-y-2",children:k.map(s=>e.jsx(K,{swimmer:s,onUpdate:t=>B(s,t),onImport:s.iuf?()=>R.mutate({iuf:s.iuf,name:s.display_name}):void 0,importPending:R.isPending},s.id??`user-${s.user_id??"unknown"}`))}),!i&&!_&&y.length>0&&e.jsxs("div",{className:"border-t pt-2",children:[e.jsxs("button",{type:"button",onClick:()=>W(!w),className:"flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm font-medium text-muted-foreground hover:bg-muted/50 transition-colors",children:[e.jsx(z,{className:p("h-4 w-4 transition-transform",w&&"rotate-180")}),"Archive (",y.length," nageur",y.length>1?"s":""," inactif",y.length>1?"s":"",")"]}),w&&e.jsx("div",{className:"mt-2 space-y-2",children:y.map(s=>e.jsx(K,{swimmer:s,onUpdate:t=>B(s,t),importPending:R.isPending},s.id??`user-${s.user_id??"unknown"}`))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground",children:"Historique des imports"}),T.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectué."}):e.jsx("div",{className:"space-y-1.5",children:T.map(s=>e.jsxs("div",{className:"rounded-lg border px-3 py-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium truncate",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(Q,{variant:ye(s.status),className:"text-[10px] px-1.5 py-0 shrink-0",children:Ne(s.status)})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-0.5 text-[11px] text-muted-foreground mt-0.5",children:[e.jsxs("span",{children:[s.performances_found??0," trouvées"]}),e.jsxs("span",{children:[s.performances_imported??0," importées"]}),e.jsx("span",{children:je(s.started_at)})]}),s.error_message&&e.jsx("p",{className:"text-[11px] text-destructive truncate mt-0.5",children:s.error_message})]},s.id))})]}),I&&e.jsxs(ne,{children:[e.jsxs(ce,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(oe,{children:"Paramètres d'import"}),e.jsx(le,{children:"Limites mensuelles d'import par rôle."})]}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>Y(!D),children:e.jsx(de,{className:"h-4 w-4"})})]}),D&&m&&e.jsxs(ue,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Coach (par mois)"}),e.jsx(j,{type:"number",value:m.coach_monthly,onChange:s=>N({...m,coach_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Nageur (par mois)"}),e.jsx(j,{type:"number",value:m.athlete_monthly,onChange:s=>N({...m,athlete_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Admin (par mois, -1=illimité)"}),e.jsx(j,{type:"number",value:m.admin_monthly,onChange:s=>N({...m,admin_monthly:Number(s.target.value)}),min:-1})]})]}),e.jsx(v,{size:"sm",onClick:()=>V.mutate(m),disabled:V.isPending,children:"Enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-2xl font-display font-bold uppercase italic text-primary",children:"Records club"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Accès réservé aux coachs."})]})}export{ze as default};
